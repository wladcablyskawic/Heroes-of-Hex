var bind=function(t,e){return function(){return t.apply(e,arguments)}},extend=function(t,e){function n(){this.constructor=t}for(var i in e)hasProp.call(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;define("modules/clean/account/addon_modal",["jquery","modules/clean/dbmodal","modules/clean/account/modal_with_buttons","modules/clean/uirequest"],function(t,e,n,i){var r,o,s;return r=e.DBModalStack,o=function(e){function n(t){this.addon_id=t,this.on_confirm_button_click=bind(this.on_confirm_button_click,this),n.__super__.constructor.call(this,{element_id:"purchase-addon-"+this.addon_id,endpoint_url:"/purchase_addon_modal",parameters:{addon_id:this.addon_id}})}return extend(n,e),n.prototype.on_confirm_button_click=function(){return this.$modal_window.find(".payment-method-view").trigger("validate",function(t){return function(e,n){return t.purchase_or_reactivate_addon(e,n)}}(this))},n.prototype._post_request=function(){return r.pop()},n.prototype.purchase_or_reactivate_addon=function(e,n){return new i(t("body"),"/add_extra_ajax",{data:{id:this.addon_id,zip_code:e,country_code:n},success:this._post_request})},n}(n),s=function(e){function n(t){this.addon_id=t,this._post_request=bind(this._post_request,this),this.on_confirm_button_click=bind(this.on_confirm_button_click,this),n.__super__.constructor.call(this,{element_id:"remove-addon-"+this.addon_id,endpoint_url:"/remove_addon_modal",parameters:{addon_id:this.addon_id}})}return extend(n,e),n.prototype.on_confirm_button_click=function(){return this._remove_addon()},n.prototype._post_request=function(){return r.pop()},n.prototype._remove_addon=function(){return new i(t("body"),"/remove_extra_ajax",{data:{id:this.addon_id},success:this._post_request})},n}(n),{PurchaseAddonModal:o,RemoveAddonModal:s}});var extend=function(t,e){function n(){this.constructor=t}for(var i in e)hasProp.call(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;define("modules/clean/account/modal_with_buttons",["modules/clean/dbmodal","modules/clean/dbmodal_loading"],function(t,e){var n,i;return i=t.DBModalStack,n=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return extend(e,t),e.prototype.on_hide=function(){return this.$modal_window=null},e.prototype.on_show=function(){return e.__super__.on_show.call(this),this.$modal_window.on("click",".confirm-button",function(t){return function(){return"function"==typeof t.on_confirm_button_click?t.on_confirm_button_click():void 0}}(this)),this.$modal_window.on("click",".cancel-button",function(){return i.pop()})},e}(e)}),define("modules/clean/business/business_login_modal",["jquery","modules/clean/dbmodal","modules/clean/register_form"],function(t,e,n){var i;return i=function(){function i(i){var r;return null==i&&(i="#sign-in"),r=new e.DBModal({element_id:"business-sign-in-modal"}),t(i).on("click",function(t){return t.preventDefault(),r.show()}),t(".register-form").on(n.USER_EXISTS,function(t){var e,n;return r.show(e=t.focus,n=t.prefill)}),this}return i}()});var bind=function(t,e){return function(){return t.apply(e,arguments)}};define("modules/clean/business_create",["jquery","external/jquery_payment","external/underscore","modules/core/exception","modules/core/i18n","modules/clean/analytics","modules/clean/dbmodal","modules/clean/payments/cash","modules/clean/payments/dfb_buy_form","modules/clean/payments/payment_form_events","modules/clean/payments/validation","modules/clean/components/ajax_form","modules/clean/components/register_form_validator"],function(t,e,n,i,r,o,s,a,u,_,c,l,d){var h,p,m,f,y,g,v,b,x;return x=i.assert,b=r._,g=o.TeamsWebActionsLogger,p=s.DBModal,h=a.Cash,f=u.DfbBuyForm,v=function(){function e(){t("#total-price input").change(function(){return t("#total-price > div").removeClass("selected"),t(this).parent().addClass("selected")}),t("#total-price > div").click(function(e){return"INPUT"!==e.target.nodeName?t("input",this).click():void 0})}return e}(),y=function(){function e(t,e,n){this.min_licenses=t,this.max_licenses=e,this.show_error_for_all_low_users=n,this.handle=bind(this.handle,this),this.listen()}return e.prototype.listen=function(){return t("#team_num_users").on("input",n.debounce(this.handle,200)),t("#team_num_users").on("change",this.handle),t("#team_num_users").on("blur",this.handle),t(this.handle)},e.prototype.handle=function(){var e,n;return e=t("#team_num_users"),n=parseInt(e.val(),10)||0,t(".pricing-scheme").toggleClass("hidden_elem",n>this.max_licenses),t(".price-warning").toggleClass("hidden_elem",n<=this.max_licenses),t("#low_user_warning").toggleClass("hidden_elem",!this.show_error_for_all_low_users&&0>=n||n>=this.min_licenses),n>this.max_licenses||n<this.min_licenses?t("#team_num_users").trigger(_.VALIDATE_ERROR,"team_num_users"):t("#team_num_users").trigger(_.VALIDATE_SUCCESS,"team_num_users")},e}(),m={init:function(e,n){var i,r,o,s;return i={team_num_users:b("Please enter a valid number of users."),team_phone:b("Please enter a valid contact telephone."),team_name:b("Please enter a valid team name.")},t("#reseller_license_key")&&(i.reseller_license_key=b("Please enter a license key.")),s=!1,t("#teams_billing_form").submit(function(){return s?!1:(s=!0,!t("#reseller_license_key")&&t("#order-summary").hasClass("hidden")?!1:!0)}),e&&(g.log("show-unsupported-browser"),r=new p({element_id:"team-payment-page-disabled-modal",click_out_to_close:!1}),t(".db-modal-x").hide(),t("#continue-phone-signup").hide(),null!=r&&r.show(),t(".upgrade-browser-link").click(function(){return g.log("upgrade-unsupported-browser"),!0}),t("#unsupported-continue").click(function(e){return g.log("continue-unsupported-browser"),t("#unsupported-text").hide(),t("#continue-phone-signup").show(),t(this).hide(),e.preventDefault(),!1})),o=new d("#account_info_new"),t("#cc_preferred").click(function(e){var r,s,a,u,c,d;e.preventDefault(),u={},d=function(e,i,r){var o;return i.hasClass("optional")?!0:(o=t.trim(i.val()),"team_num_users"===e&&(o=parseInt(o,10)),i.length>0&&(!o||"team_num_users"===e&&(!o||o>n||1>o))?(u[e]={message_text:r},i.trigger(_.VALIDATE_ERROR,e),!1):(i.trigger(_.VALIDATE_SUCCESS,e),!0))},s=!0;for(c in i)a=i[c],s=d(c,t("input[name='"+c+"']"),a)&&s;return s=d("company_size",t("#company_size select"),b("Please enter your company size."))&&s,s=f.validate_tos(u)&&s,r=t("#teams_billing_form"),l.clear_errors(r),l.fill_errors(r,u),t("#account_info_new").is(":visible")&&(s=o.validate()&&s),!s||!t("#reseller_license_key")&&t("#order-summary").hasClass("hidden")||f.validate_payment_form(function(n){return n?t(e.target).closest("form").submit():void 0}),!1})}},{TotalPriceTable:v,HandleNumUsersWarnings:y,DfBCreateFormValidation:m}}),define("modules/clean/components/login_form_async",[],function(){var t;return t=function(){function t(t,e,n){var i,r,o;this.multi_login=e,this.variant=n,o=t.find("input"),i="click focus keydown",r=function(){return o.off(i,r),require(["modules/clean/components/login_form"],function(e){return new e(t,this.multi_login,this.variant)})},o.on(i,r)}return t}()}),define("modules/clean/components/register_form_validator",["jquery","modules/core/i18n","modules/clean/components/ajax_form","modules/clean/keycode","modules/clean/validators/validators","modules/clean/payments/payment_form_events"],function(t,e,n,i,r,o){var s,a,u;return a=e._,u=r.check(r.create(["EmailValidator"])),s=function(){function e(e){this.$container=t(e)}return e.prototype.clear_errors_on_change=function(){return this.$container.find("input").keyup(function(){return function(e){var n;return e.keyCode!==i.TAB?(n=t(e.currentTarget),n.removeClass("input-error"),n.closest(".text-input").find(".error-message").remove(),n.trigger(o.UNVALIDATED,n.attr("name"))):void 0}}(this))},e.prototype.validate=function(){var e,i,r,s,_,c,l;s={fname:a("Please enter a valid first name."),lname:a("Please enter a valid last name."),email:a("Please enter a valid email."),password:a("Please enter a valid password.")},c=!0,r={};for(_ in s)i=s[_],e=this.$container.find("input[name="+_+"]"),l=t.trim(e.val()),!l||"email"===_&&!u(l)?(r[_]={message_text:i},e.trigger(o.VALIDATE_ERROR,_),c=!1):e.trigger(o.VALIDATE_SUCCESS,_);return n.clear_errors(this.$container),n.fill_errors(this.$container,r),c},e}()});var indexOf=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};define("modules/clean/flux/base_store",["modules/core/exception","modules/clean/flux/dispatcher"],function(t,e){var n,i,r;return i=t.assert,r=function(){var t,n;return n=!1,t=[],e.dispatch_begin=function(){return n=!0},e.dispatch_end=function(){var e,i,r,o;n=!1;try{for(o=[],i=0,r=t.length;r>i;i++)e=t[i],o.push(e());return o}finally{t.length=0}},function(e){return n?indexOf.call(t,e)<0?t.push(e):void 0:e()}}(),n=function(){function t(t){null==t&&(t=null),"function"==typeof this._init&&this._init(),this._change_listeners=[],this._dispatcher=t||e,this.dispatchToken=this._dispatcher.register(this._new_payload_wrapper.bind(this))}return t.WIPE_TYPE="WIPE_ALL",t.prototype.destructor=function(){return this._dispatcher.unregister(this.dispatchToken),this.remove_all_change_listeners()},t.prototype.emit_change=function(){var t,e,n,i,o;for(i=this._change_listeners,o=[],e=0,n=i.length;n>e;e++)t=i[e],o.push(r(t));return o},t.prototype.add_change_listener=function(t){return i(!(indexOf.call(this._change_listeners,t)>=0)),this._change_listeners.push(t)},t.prototype.remove_change_listener=function(t){var e;return this._change_listeners=function(){var n,i,r,o;for(r=this._change_listeners,o=[],n=0,i=r.length;i>n;n++)e=r[n],e!==t&&o.push(e);return o}.call(this)},t.prototype.remove_all_change_listeners=function(){return this._change_listeners.length=0},t.prototype._new_payload_wrapper=function(t){var e;return(null!=t&&null!=(e=t.action)?e.type:void 0)===this.constructor.WIPE_TYPE&&"function"==typeof this._init&&this._init(),this._new_payload(t)},t.prototype._new_payload=function(){throw new Error("Abstract method - must be implemented")},t}()});var bind=function(t,e){return function(){return t.apply(e,arguments)}};define("modules/clean/payments/billing_info_base",["jquery","modules/clean/payments/cash","modules/clean/payments/pro_util","modules/clean/payments/payment_form_events","modules/core/dom"],function(t,e,n,i,r){var o,s,a,u,_;return s=e.Cash,a=e.CashUtil,_=n.TransitionInfoFetcher,u=n.TaxHelper,o=function(){function e(t,e,n,i){this.$container=t,this.country_to_currency_map=e,this.transition_view_models=n,this.countryToTaxNameMap=i,this._recompute_costs_from_tvm=bind(this._recompute_costs_from_tvm,this),this._recompute_costs=bind(this._recompute_costs,this),this._display_tax=bind(this._display_tax,this),this.updateForm=bind(this.updateForm,this),this.getCurrentTransitionViewModel=bind(this.getCurrentTransitionViewModel,this),this._getCurrency=bind(this._getCurrency,this),this.listen_tax=bind(this.listen_tax,this),this.transition_info_fetcher=new _(this.transition_view_models),this.payment_form=r.controller(this.$container.find(".payment-form-component")),this.hasTax=null!=this.countryToTaxNameMap,this.transition_view_models&&(this.transition_view_model=this.transition_view_models[0]),this.listen_tax()}return e.prototype.listen_tax=function(){return this.hasTax?this.$container.on(i.LOCATION_CHANGE_EVENT,function(t){return function(e){return e.stopPropagation(),u.require_recompute(t.get_country_code(),t.get_zip_code())?t.updateForm():void 0}}(this)):void 0},e.prototype.get_zip_code=function(){return this.$container.find('input:visible[name="zip"]').val()},e.prototype.get_country_code=function(){return this.$container.find('[name="country_code"]').val()},e.prototype._getCountryTaxName=function(t){return this.countryToTaxNameMap[t]||this.countryToTaxNameMap.Other},e.prototype._getCurrency=function(){var t,e;return t=this.payment_form.get_country_code(),null!=(e=this.country_to_currency_map)?e[t]:void 0},e.prototype.getCurrentTransitionViewModel=function(){return this.transition_view_model},e.prototype.updateForm=function(){return this._recompute_costs()},e.prototype._display_tax=function(){return u.display_tax(this.get_country_code())?(t(".tax-row").removeClass("hidden_elem"),t(".tax-name-wrapper").text(this._getCountryTaxName(this.get_country_code())),!0):(t(".tax-row").addClass("hidden_elem"),!1)},e.prototype._recompute_costs=function(){var t;return t={zip:this.get_zip_code(),country_code:this.get_country_code()},this.transition_info_fetcher.get(this._recompute_costs_from_tvm,t,!0)},e.prototype._recompute_costs_from_tvm=function(e){var n,i,r,o,_,c,l,d,h,p,m,f,y;if(e)return this.transition_view_model=e,i=this._getCurrency(),this.$container.find(".currency-wrapper").text(i),m=u.compute_tax(e.read_only_invoice,i),d=m[0],n=m[1],f=m[2],r=a.formatCurrency(d.amount,d.currency),this.$container.find(".price-amount-wrapper").text(r),e.rebill&&(h=s.fromObject(e.rebill.total),o=a.formatCurrency(h.amount,h.currency),this.$container.find(".rebill-amount-wrapper").text(o)),e.state.total_recurring_price&&(p=s.fromObject(e.state.total_recurring_price),_=a.formatCurrency(p.amount,p.currency),this.$container.find(".rebill-price-wrapper").text(_)),y=this._getTotalAmount(e),l=a.formatCurrency(y.amount,y.currency),this.$container.find(".total-amount-wrapper").text(l),t(".tax-row").toggleClass("hidden_elem",this._display_tax()),c=a.formatCurrency(f.amount,f.currency),t(".tax-amount-wrapper").text(c),[d,n,f,h,i]},e}(),{BillingInfoModalBase:o}});var indexOf=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};define("modules/clean/payments/billing_info_validator",["external/jquery_payment","jquery","modules/core/i18n","modules/clean/components/ajax_form","modules/clean/payments/credit_card_util","modules/clean/payments/validation","modules/clean/payments/payment_form_events"],function(t,e,n,i,r,o,s){var a,u,_;return u=n._,_=o.validate_vat,a=function(){function t(t,e){this.countryCodesWithoutPostalCodes=e,r.setCreditCardInfoMap(t)}return t._get_name=function(t){var e;return e=t.find("input"),e.attr("name")||e.attr("data-encrypted-name")},t.add_error=function(t,e,n){return t[this._get_name(e)]={message_text:n}},t.prototype._add_error=function(t,e){return this.constructor.add_error(this.error_dict,t,e)},t.prototype.countrySupportsZip=function(t){return indexOf.call(this.countryCodesWithoutPostalCodes,t)<0},t.prototype._validate_zip=function(t){var e,n,i,r,o;return n=t.find("#zip"),i=n.closest(".text-input"),e=t.find('[name="country_code"]'),r=e.val(),o=!this.countrySupportsZip(r)||n.val(),"US"===r&&(o=o&&/^[0-9]{5}(-{0,1}[0-9]{4}){0,1}$/g.test(o)),o?i.trigger(s.VALIDATE_SUCCESS,"zip"):(this._add_error(i,u("Please enter a valid postal code.")),i.trigger(s.VALIDATE_ERROR,"zip")),!!o},t.prototype._validate_owner_name=function(t){var e,n;return e=t.find("#owner_name"),n=e.closest(".text-input"),e.val()?!0:(this._add_error(n,u("Please enter the account holder's name.")),!1)},t.prototype._validate_iban=function(t){var e,n,i;return e=t.find("#iban"),n=e.closest(".text-input"),i=e.val().replace(/\s+/g,""),this._valid_iban_for_country(i)?!0:(this._add_error(n,u("Please enter a valid bank account number.")),!1)},t.prototype._valid_iban_for_country=function(t){var e;switch(e=t.substring(0,2)){case"AT":return/^AT[0-9]{18}$/.test(t);case"BE":return/^BE[0-9]{14}$/.test(t);case"CY":return/^CY[0-9]{10}[0-9a-zA-Z]{16}$/.test(t);case"CZ":return/^CZ[0-9]{22}$/.test(t);case"DE":return/^DE[0-9]{20}$/.test(t);case"EE":return/^EE[0-9]{18}$/.test(t);case"ES":return/^ES[0-9]{22}$/.test(t);case"FI":return/^FI[0-9]{16}$/.test(t);case"FR":return/^FR[0-9]{12}[0-9a-zA-Z]{11}[0-9]{2}$/.test(t);case"GR":return/^GR[0-9]{9}[0-9a-zA-Z]{16}$/.test(t);case"HU":return/^HU[0-9]{26}$/.test(t);case"HR":return/^HR[0-9]{19}$/.test(t);case"IE":return/^IE[0-9]{2}[0-9a-zA-Z]{4}[0-9]{14}$/.test(t);case"IT":return/^IT[0-9]{2}[A-Z]{1}[0-9]{10}[0-9a-zA-Z]{12}$/.test(t);case"LU":return/^LU[0-9]{5}[0-9a-zA-Z]{13}$/.test(t);case"NL":return/^NL[0-9]{2}[A-Z]{4}[0-9]{10}$/.test(t);case"PL":return/^PL[0-9]{26}$/.test(t);case"PT":return/^PT[0-9]{23}$/.test(t);case"SE":return/^SE[0-9]{22}$/.test(t);default:return!1}},t.prototype._validate_mandate=function(t){var e;return e=t.find("#mandate_signed"),e.prop("checked")?!0:(this.error_dict.mandate_signed={message_text:u("Please agree to the SEPA mandate terms by clicking on this check box.")},!1)},t.prototype._validate_bank_id=function(t){var e;return e=t.find("#bank_id option:selected").val(),""===e?(this.error_dict.bank_id={message_text:u("Please select your bank.")},!1):!0},t.prototype._validate_vat=function(t){return this.constructor.validate_vat(this.error_dict,t)},t.validate_vat=function(t,e){var n,i,r,o;return n=e.find('[name="vat"]'),i=n.closest(".text-input"),r=e.find('[name="country_code"]').val(),n.length>0?(o=n.val(),""===o||_(r,o)?(n.trigger(s.VALIDATE_SUCCESS,"vat"),!0):(this.add_error(t,i,u("Please enter a valid VAT number.")),n.trigger(s.VALIDATE_ERROR,"vat"),!1)):void 0},t.prototype.validate_paypal=function(t){var e;return this.error_dict={},e=!0,e=this._validate_zip(t)&&e,e=this._validate_vat(t)&&e,i.clear_errors(t),i.fill_errors(t,this.error_dict),e},t.prototype.validate_iframe_credit_card=function(t){var e;return this.error_dict={},e=!0,e=this._validate_zip(t)&&e,e=this._validate_vat(t)&&e,i.clear_errors(t),i.fill_errors(t,this.error_dict),e},t.prototype.validate_credit_card=function(t){var n,o,s,a,_,c,l,d,h,p,m,f,y,g,v;return this.error_dict={},v=!0,s=t.find("#ccn"),a=s.closest(".text-input"),_=t.find("#ccode"),c=_.closest(".text-input"),n=t.find("#ccexp"),o=n.closest(".text-input"),l=e.payment.cardType(s.val()),d=indexOf.call(r.getAllTypes(),l)>=0,f=e.payment.validateCardNumber(s.val()),f&&d||(v=!1,this._add_error(a,u("Please enter a valid credit card number."))),y=e.payment.validateCardCVC(_.val(),l),"amex"===l&&4!==_.val().length&&(y=!1),y||(v=!1,_.addClass("invalid-input"),this._add_error(c,u("Please enter a valid security code."))),h=n.val().split("/"),p=h[0],m=h[1],g=e.payment.validateCardExpiry(p,m),g&&(t.find("#expmo").val(p),t.find("#expyr").val(m)),g||(v=!1,this._add_error(o,u("Please enter a valid expiration date."))),v=this._validate_zip(t)&&v,v=this._validate_vat(t)&&v,i.clear_errors(t),i.fill_errors(t,this.error_dict),v},t.prototype.validate_sepa_direct_debit=function(t){var e;return this.error_dict={},e=!0,e=this._validate_owner_name(t)&&e,e=this._validate_iban(t)&&e,e=this._validate_zip(t)&&e,e=this._validate_vat(t)&&e,e=this._validate_mandate(t)&&e,i.clear_errors(t),i.fill_errors(t,this.error_dict),e},t.prototype.validate_ideal=function(t){var e;return this.error_dict={},e=!0,e=this._validate_zip(t)&&e,e=this._validate_vat(t)&&e,e=this._validate_bank_id(t)&&e,i.clear_errors(t),i.fill_errors(t,this.error_dict),e},t}()});var slice=[].slice,extend=function(t,e){function n(){this.constructor=t}for(var i in e)hasProp.call(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty,bind=function(t,e){return function(){return t.apply(e,arguments)}},indexOf=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};define("modules/clean/payments/checkout",["jquery","modules/core/dom","modules/core/i18n","modules/clean/ajax","modules/clean/components/ajax_form","modules/clean/components/register_form_validator","modules/clean/payments/cash","modules/clean/payments/credit_card_util","modules/clean/payments/payment_form_events","modules/clean/payments/billing_info_validator","modules/clean/uirequest","modules/clean/flux/base_store","modules/clean/flux/dispatcher","modules/clean/captcha"],function(t,e,n,i,r,o,s,a,u,_,c,l,d,h){var p,m,f,y,g,v,b,x,w,C,$,E,T,A,S,k,O,F,D,I,N,P,V,j,L;return L=n._,f=s.Cash,y=s.CashUtil,x=1,j=2,E=3,I=function(t,e){return d.dispatch({type:I,country_code:t,zip:e})},N=function(t){return d.dispatch({type:N,transition:t})},p=function(t){return d.dispatch({type:p,code:t})},P=function(t){return d.dispatch({type:P,show:t})},V=function(){function t(){}var e;return e=null,t.implementation=l,t.create=function(){return new this.implementation},t.get=function(){return null!=e?e:e=this.create()},t.onChange=function(t){return this.get().add_change_listener(t)},t.state=function(){return this.get().state()},t.setup=function(){var t,e;return t=1<=arguments.length?slice.call(arguments,0):[],(e=this.get()).setup.apply(e,t)},t}(),S=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}var n;return extend(e,t),e.implementation=n=function(t){function e(){return this.findTransitionViewModel=bind(this.findTransitionViewModel,this),this.loadTransitions=bind(this.loadTransitions,this),this.setup=bind(this.setup,this),e.__super__.constructor.apply(this,arguments)}return extend(e,t),e.prototype._init=function(){return this.location=null,this.location_key=null,this.currency=null,this.transition=null,this.transitions={},this.existingPayment=!1,this.discountCode=null,this.taxNames={},this.taxName=null},e.prototype.setup=function(t,e,n,i,r,o,s){var a,u;return this.variants=t,this.planId=e,this.discountCode=n,this.taxNames=s,i||(i="US",r="USD"),o&&(a=function(){var t,e,n;for(n=[],t=0,e=o.length;e>t;t++)u=o[t],u.state.currency===r&&n.push(u);return n}(),this.loadTransitions(a,this.locationKey(i))),this._locate(i,null)},e.prototype._new_payload=function(t){var e;switch(e=null!=t?t.action:void 0,e.type){case I:if(this._locate(e.country_code,e.zip))return this.emit_change();break;case N:if(this._select(e.transition))return this.emit_change();break;case P:if(this._useExistingPayment(!e.show))return this.emit_change();break;case p:if(this._applyDiscount(e.code))return this.emit_change()}},e.prototype.locationKey=function(t,e){return e?t+"/"+e:t},e.prototype._locate=function(t,e){var n,r,o,s,a;return o=this.locationKey(t,e),this.location===o?!1:(this.location=o,r=this.loadTransitionsError,this.transitions[this.location]?this.taxName=null!=(s=this.taxNames[t])?s:this.taxNames.Other:(null!=(a=this.loadRequest)&&"function"==typeof a.abort&&a.abort(),n={url:"/pro/ajax_transition_prices",dataType:"json",data:{discount_code:this.discountCode,country_code:null!=t?t:"",zip:null!=e?e:""},success:function(e){return function(n){var i;return e.taxName=null!=(i=e.taxNames[t])?i:e.taxNames.Other,e.loadTransitions(n,e.location)}}(this),error:function(t,e){return"timeout"===e?(n.error=r,void new i.WebRequest(n)):r.apply(null,arguments)}},this.loadRequest=new i.WebRequest(n)),!0)},e.prototype._select=function(t){return this.transition===t?!1:(this.transition=t,!0)},e.prototype._useExistingPayment=function(t){return this.existingPayment===t?!1:(this.existingPayment=t,!0)},e.prototype._applyDiscount=function(t){return this.discountCode===t?!1:(this.discountCode=t,!0)},e.prototype.state=function(){return{transition:this.transition,available_transitions:this.transitions[this.location],has_packrat:this.has_packrat(this.transition),variants:this.variants,existingPayment:this.existingPayment,taxName:this.taxName}},e.prototype.loadTransitions=function(t,e){var n,i,r,o,s,a,u,_;if(e){for(null==t&&(t=[]),n=0,r=t.length;r>n;n++){u=t[n],null==u.prices&&(u.prices={}),o=u.prices;for(i in o)_=o[i],(null!=_?_.amount:void 0)&&(u.prices[i]=new f(null!=(s=_.amount)?s:0,null!=(a=_.currency)?a:u.state.currency))}return this.transitions[e]={month:this.findTransitionViewModel(t,this.planId,x,!1),year:this.findTransitionViewModel(t,this.planId,j,!1),month_evh:this.findTransitionViewModel(t,this.planId,x,!0),year_evh:this.findTransitionViewModel(t,this.planId,j,!0)},this.emit_change()}},e.prototype.loadTransitionsError=function(){return null},e.prototype.findTransitionViewModel=function(t,e,n,i){var r,o,s;for(r=0,o=t.length;o>r;r++)if(s=t[r],e===s.state.plan.id&&n===s.state.schedule.id&&i===this.has_packrat(s))return s;return null},e.prototype.has_packrat=function(t){var e;return(null!=t&&null!=(e=t.prices.evh)?e.amount:void 0)>0},e}(l),e}(V),T=function(){function e(e,n){this.$elm=e,this.options=n,this.bounce=bind(this.bounce,this),this.getFormData=bind(this.getFormData,this),this.redraw=bind(this.redraw,this),this._postStateChange=bind(this._postStateChange,this),this._onStateChange=bind(this._onStateChange,this),this.setState=bind(this.setState,this),this.getState=bind(this.getState,this),this.log=bind(this.log,this),this.$elm=t(this.$elm),this.$elm.addClass("payment-component").data("payment-component",this),this.state={},this.will_redraw=!0,"function"==typeof this.preCreate&&this.preCreate(),this.redraw(),"function"==typeof this.postCreate&&this.postCreate(),S.onChange(this._onStateChange)}return e.prototype.log=function(t){return"undefined"!=typeof console&&null!==console&&"function"==typeof console.log?console.log(this.constructor.name,t):void 0},e.prototype.getState=function(){return t.extend({},S.state(),this.state)},e.prototype.setState=function(e){return t.extend(this.state,e),this._onStateChange()},e.prototype._onStateChange=function(){return this.will_update||(this.will_update=setTimeout(this._postStateChange,0)),this.will_redraw?void 0:this.will_redraw=setTimeout(this.redraw,10)},e.prototype._postStateChange=function(){return"function"==typeof this.postUpdate&&this.postUpdate(this.getState()),delete this.will_update},e.prototype.redraw=function(){var t;return t=this.getState(),"function"==typeof this.render&&this.render(t),"function"==typeof this.postRender&&this.postRender(t),delete this.will_redraw},e.prototype.getFormData=function(){var e,n,i,r,o,s,a;if(s={},a="function"==typeof this.getFormElementNames?this.getFormElementNames():void 0,null!=a)for(r=this.$elm.find("input, select, textarea"),n=0,i=r.length;i>n;n++)e=r[n],o=e.name,indexOf.call(a,o)>=0&&(s[e.name]=t(e).val());return s},e.prototype.ajaxFormSuccess=function(){},e.prototype.ajaxFormError=function(){},e.prototype.formatCash=function(t){return t?y.formatCurrency(t.amount,t.currency):""},e.prototype.bounce=function(t,e){var n,i;return i="animationend webkitAnimationEnd oAnimationEnd MSAnimationEnd",null==e&&(e="currency-bounce-animation"),n=this.$elm.find(t),n.addClass(e),n.on(i,function(){return n.removeClass(e)})},e.prototype.preCreate=function(){return null},e.prototype.postCreate=function(){return null},e}(),k=function(e){function n(){return this.getFormData=bind(this.getFormData,this),this.postRender=bind(this.postRender,this),this.render=bind(this.render,this),this.postUpdate=bind(this.postUpdate,this),this.postCreate=bind(this.postCreate,this),this.preCreate=bind(this.preCreate,this),n.__super__.constructor.apply(this,arguments)}return extend(n,e),n.prototype.preCreate=function(){return this.setState({schedule_id:parseInt(this.$elm.find(".radio-wrapper input[type='radio']:checked").val(),10),has_packrat:this.$elm.find(".add-on-box input[type='checkbox']:checked").length>0})},n.prototype.postCreate=function(){return this.$elm.on("click",".add-on-box.round-box",function(t){return function(e){return e.stopPropagation(),t.setState({has_packrat:!t.state.has_packrat})}}(this)),this.$elm.on("change",".radio-wrapper input",function(e){return function(n){var i;return i=t(n.currentTarget),e.setState({schedule_id:parseInt(i.val(),10)})}}(this)),this.$elm.on("change",".add-on-checkbox input",function(e){return function(n){var i;return i=t(n.currentTarget),e.setState({has_packrat:i.prop("checked")})}}(this)),t(document).trigger(u.LOADED_EVENT)},n.prototype.postUpdate=function(t){var e;return t.available_transitions&&(e=t.available_transitions[this.getSelectionId(t)],e!==t.transition)?N(e):void 0},n.prototype.render=function(t){var e,n,i,r,o,s,a,u,_,c,l,d,h;return n=t.available_transitions,this.$elm.find(".schedule-desc > span, .add-on-price, .saving-hint").toggleClass("hidden",!n),null==n&&(n={}),this.$elm.find('label[for="plan-billing-schedule-monthly"] .plan-price-wrapper').text(this.formatCash(null!=(s=n.month)?s.prices.actual:void 0)),this.$elm.find('label[for="plan-monthly-billing-schedule-monthly"] .plan-price-wrapper').text(this.formatCash(null!=(a=n.month)?a.prices.actual:void 0)),this.$elm.find("input#plan-billing-schedule-monthly").attr("checked",t.schedule_id===x),r={},r.currency=null!=(u=n.year)?u.prices.actual.currency:void 0,r.amount=(null!=(_=n.year)?_.prices.actual.amount:void 0)/12,this.$elm.find('label[for="plan-billing-schedule-yearly"] .plan-price-wrapper').text(this.formatCash(null!=(c=n.year)?c.prices.actual:void 0)),this.$elm.find('label[for="plan-monthly-billing-schedule-yearly"] .yearly-exp .plan-price-wrapper').text(this.formatCash(r)),this.$elm.find('label[for="plan-billing-schedule-yearly"] .annual_as_monthly_price').text(this.formatCash(r)),this.$elm.find('label[for="plan-monthly-billing-schedule-yearly"] .monthly_plan_price_per_year .plan-price-wrapper').text(this.formatCash(null!=(l=n.month)?l.prices.actual:void 0)),this.$elm.find("input#plan-billing-schedule-yearly").attr("checked",t.schedule_id===j),n.month?(o=n.month.prices.actual,i=new f(12*o.amount,o.currency)):i=null,this.$elm.find('label[for="plan-billing-schedule-yearly"] .monthly_plan_price_per_year .plan-price-wrapper').text(this.formatCash(i)),this.$elm.find('label[for="plan-billing-schedule-monthly"] .monthly_as_annual_price .plan-price-wrapper').text(this.formatCash(i)),this.$elm.find(".add-ons .monthly-wrapper").toggleClass("hidden",t.schedule_id!==x).find(".add-on-price-wrapper").text(this.formatCash(null!=(d=n.month_evh)?d.prices.evh:void 0)),this.$elm.find(".add-ons .yearly-wrapper").toggleClass("hidden",t.schedule_id!==j).find(".add-on-price-wrapper").text(this.formatCash(null!=(h=n.year_evh)?h.prices.evh:void 0)),this.$elm.find(".add-on-box").toggleClass("selected",t.has_packrat),this.$elm.find("#add-on-checkbox").attr("checked",t.has_packrat),t.variants.use_yearly_green_box?(e=this.$elm.find("#plan-billing-schedule-yearly").closest(".schedule-switch"),e.toggleClass("yearly-green-box",t.schedule_id===j)):void 0},n.prototype.postRender=function(t){var e,n,i,r;return e=null!=(n=t.transition)&&null!=(i=n.prices)&&null!=(r=i.total)?r.currency:void 0,e!==this.lastCurrency?(this.lastCurrency&&this.bounce(".plan-selection .plan, .plan-selection .add-on-box"),this.lastCurrency=e):void 0},n.prototype.getSelectionId=function(t){var e;return e=t.schedule_id===x?"month":"year",t.has_packrat&&(e+="_evh"),e},n.prototype.getFormElementNames=function(){return["promo_ids","code"]},n.prototype.getFormData=function(){var e,i;return e=this.getState(),i=e.transition,null==i?{errors:!0}:t.extend(n.__super__.getFormData.apply(this,arguments),{schedule_id:i.state.schedule.id,plan_id:i.state.plan.id,packrat:e.has_packrat,expected_price:i.prices.billed.amount,currency:i.prices.billed.currency})},n}(T),b=function(e){function n(){return this.getFormData=bind(this.getFormData,this),n.__super__.constructor.apply(this,arguments)}return extend(n,e),n.prototype.getFormData=function(){var e,i;return e=this.getState(),i=e.transition,null==i?{errors:!0}:t.extend(n.__super__.getFormData.apply(this,arguments),{expected_price:i.prices.billed.amount,currency:i.prices.billed.currency})},n}(k),w=function(t){function e(){return this.getFormData=bind(this.getFormData,this),this.postCreate=bind(this.postCreate,this),e.__super__.constructor.apply(this,arguments)}return extend(e,t),e.prototype.postCreate=function(){return this.$elm.length?(this.validator=new o(this.$elm),this.validator.clear_errors_on_change()):void 0},e.prototype.getFormElementNames=function(){return["fname","lname","email","password"]},e.prototype.getFormData=function(){var t;return(null!=(t=this.validator)?t.validate():void 0)===!1?{errors:!0}:e.__super__.getFormData.apply(this,arguments)},e}(T),A=function(n){function i(){return this.getFormData=bind(this.getFormData,this),this.render=bind(this.render,this),this.postCreate=bind(this.postCreate,this),this.preCreate=bind(this.preCreate,this),i.__super__.constructor.apply(this,arguments);

}return extend(i,n),i.prototype.preCreate=function(){return this.$existing=this.$elm.parent().find(".existing-payment-section"),this.$existing.length?(P(!1),this.$elm.find('select[name="country_code"]').attr("disabled",!0)):void 0},i.prototype.postCreate=function(){return this.controller=e.controller(this.$elm),this.controller.$container.on(u.LOCATION_CHANGE_EVENT,function(t,e){return I(null!=e?e.country_code:void 0,null!=e?e.zip_code:void 0)}),I(this.controller.get_country_code()),this.$existing.on("click",".existing-payment-tag",function(){return P(!0)})},i.prototype.render=function(t){return this.$elm.toggleClass("hidden",!!t.existingPayment),this.$existing.toggleClass("hidden",!t.existingPayment)},i.prototype.getFormData=function(){var e,n,i;return n=this.getState(),n.existingPayment?{existing_payment:!0}:this.controller.validate()?(i={payment_method_id:this.controller.get_selected_payment_method_id()},e=t.Deferred(),this.controller.get_form_inputs(function(n){return e.resolve(t.extend(i,n))}),e):{errors:!0}},i}(T),$=function(e){function n(){return this.render=bind(this.render,this),this.postCreate=bind(this.postCreate,this),n.__super__.constructor.apply(this,arguments)}return extend(n,e),n.prototype.postCreate=function(){return this.is_trial="trial"===this.$elm.find("input[name=plan-type]").val()},n.prototype.render=function(e){var n,i,r,o,s,a,u,_,c,l,d,h,p;return p=e.transition,l=null!=p?p.prices:void 0,this.$elm.toggleClass("hidden",!l),l?(this.$elm.find(".monthly-wrapper").toggleClass("hidden",p.state.schedule.id!==x),this.$elm.find(".yearly-wrapper").toggleClass("hidden",p.state.schedule.id!==j),this.$elm.find(".original-price-wrapper").text(this.formatCash(l.original)),r=this.$elm.find(".strike-through-price-wrapper"),r.text(this.formatCash(l.original)),r.toggleClass("hidden",!(l.original.amount!==l.actual.amount)),this.$elm.find(".actual-price-wrapper").text(this.formatCash(l.actual)),this.$elm.find(".disclaimer .currency-wrapper").text(l.actual.currency),h=t(".show-price-as-annual"),p.state.schedule.id===x&&(u=new f(12*l.actual.amount,l.actual.currency),h.find(".price.actual-price-wrapper").text(this.formatCash(u))),i=this.$elm.find(".discount-total"),i.find(".discount-amount-wrapper").text("-"+this.formatCash(l.discount)),i.toggleClass("hidden",!(l.discount.amount>0)),l.discount.amount>0&&(c=Math.round(l.discount.amount/l.original.amount*100),c>=100&&l.discount.amount<l.original.amount&&(c=99),i.find(".discount-percentage").toggleClass("hidden",!(c>0)).text(c+"%")),n=this.$elm.find(".credit-total"),n.find(".total-credit-wrapper").text("-"+this.formatCash(l.credit)),n.toggleClass("hidden",!(l.credit.amount>0)),o=this.$elm.find(".tax-total"),null!=l.tax&&(o.find(".tax-amount-wrapper").text(this.formatCash(l.tax)),o.find(".tax-wrapper").text(e.taxName),p.state.schedule.id===x&&(_=new f(12*l.tax.amount,l.tax.currency),h.find(".tax-amount-wrapper").text(this.formatCash(_)))),o.toggleClass("hidden",!((null!=(d=l.tax)?d.amount:void 0)>0)),this.$elm.hasClass("show-tax")&&(s=this.$elm.find(".plus-tax-wrapper"),s.text(l.is_tax_inclusive?" "+t("#tax-inclusive").text():" "+t("#tax-exclusive").text())),a=this.is_trial?new f(0,l.billed.currency):l.billed,this.$elm.find(".total-billed-wrapper").text(this.formatCash(a))):void 0},n}(T),m=function(t){function e(t,n,i,r,o){this.$elm=t,this.other_recaptcha_div=n,this.endpoint=i,this.email_name=r,this.variant=o,this.ajaxFormError=bind(this.ajaxFormError,this),this.ajaxFormSuccess=bind(this.ajaxFormSuccess,this),this.postCreate=bind(this.postCreate,this),e.__super__.constructor.call(this,this.$elm)}return extend(e,t),e.prototype.postCreate=function(){return this.$captcha_component=new h(this.$elm.parent(),"#"+this.$elm.attr("id"),this.other_recaptcha_div,this.endpoint,this.email_name,this.variant),this.$captcha_component.captcha_display_handler()},e.prototype.getFormElementNames=function(){return["recaptcha_response","recaptcha_challenge_field"]},e.prototype.ajaxFormSuccess=function(){return this.$captcha_component.captcha_display_handler()},e.prototype.ajaxFormError=function(){return this.$captcha_component.captcha_display_handler()},e}(T),C=function(t){function e(){return this.getFormData=bind(this.getFormData,this),this.isChecked=bind(this.isChecked,this),this.postRender=bind(this.postRender,this),this.render=bind(this.render,this),this.postCreate=bind(this.postCreate,this),e.__super__.constructor.apply(this,arguments)}return extend(e,t),e.prototype.postCreate=function(){return this.$elm.on("click",".confirm-button",function(t){return function(e){return e.stopPropagation(),t.$elm.trigger("submit-form",{button:e.currentTarget})}}(this))},e.prototype.render=function(t){return e.__super__.render.apply(this,arguments),this.$elm.find(".confirm-button").attr("disabled",!t.available_transitions)},e.prototype.postRender=function(t){var e,n,i,r;return e=null!=(n=t.transition)&&null!=(i=n.prices)&&null!=(r=i.total)?r.currency:void 0,e!==this.lastCurrency?(this.lastCurrency&&this.bounce(".total-price-wrapper, .plan-price-wrapper, .add-on-price-wrapper, .total-billed-wrapper"),this.lastCurrency=e):void 0},e.prototype.isChecked=function(){var t;return t=this.$elm.find("#tos_agree"),!t.length||t.prop("checked")},e.prototype.getFormData=function(){return this.isChecked()?{tos_agree:!0}:{errors:{tos_agree:{message_text:L("Please agree to the terms of service.")}}}},e}($),v=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return extend(e,t),e.prototype.getFormElementNames=function(){return["recipient_email","sender_name","message"]},e}(T),g=function(t){function e(){return this.getFormData=bind(this.getFormData,this),e.__super__.constructor.apply(this,arguments)}return extend(e,t),e.prototype.getFormData=function(){return{}},e}(C),O=function(e){function n(t,e,i,r,o,s){this.$elm=t,this.promo=e,this.inSetupFlow=i,this.paymentLinkMap=r,this.androidApp=o,this.cont=s,this.ajax=bind(this.ajax,this),this.submitForm=bind(this.submitForm,this),this.findAllComponents=bind(this.findAllComponents,this),this.getFormData=bind(this.getFormData,this),this.postCreate=bind(this.postCreate,this),n.__super__.constructor.call(this,this.$elm)}return extend(n,e),n.prototype.postCreate=function(){return new w(this.$elm.find(".new-account-component")),new A(this.$elm.find(".payment-form-component")),this.$elm.on("submit-form",function(t){return function(e,n){return t.submitForm(n)}}(this))},n.prototype.getFormData=function(){return{in_setup_flow:this.inSetupFlow,android_app:this.androidApp?1:void 0,cont:this.cont}},n.prototype.findAllComponents=function(){var e,n,i,r;if(this.components)return this.components;for(this.components=[this],r=this.$elm.find(".payment-component"),n=0,i=r.length;i>n;n++)e=r[n],this.components.push(t(e).data("payment-component"));return this.components},n.prototype.submitForm=function(e){var n,i;return r.clear_errors(this.$elm),i=function(){var t,e,i,r;for(i=this.findAllComponents(),r=[],t=0,e=i.length;e>t;t++)n=i[t],r.push(n.getFormData());return r}.call(this),t.when.apply(t,[e].concat(slice.call(i))).done(function(e){return function(){var n,i,o,s,a,u;for(s=1<=arguments.length?slice.call(arguments,0):[],n=!1,i=0,o=s.length;o>i;i++)a=s[i],(null!=a?a.errors:void 0)&&(r.fill_errors(e.$elm,a.errors),n=!0);return n?void 0:(u=t.extend.apply(t,[{}].concat(slice.call(s))),e.ajax(e.paymentLinkMap[u.payment_method_id],u))}}(this))},n.prototype.ajax=function(e,n){var i;return i=t(n.button),delete n.button,i.attr("disabled",!0).addClass("disabled-button"),new c(this.$elm,e,{data:n,success:function(t){return function(e,n,i){var r,o,s,a,u;for(a=t.findAllComponents(),u=[],o=0,s=a.length;s>o;o++)r=a[o],u.push(r.ajaxFormSuccess(e,n,i));return u}}(this),error:function(t){return function(e,n,i){var r,o,s,a,u;for(a=t.findAllComponents(),u=[],o=0,s=a.length;s>o;o++)r=a[o],u.push(r.ajaxFormError(e,n,i));return u}}(this),complete:function(){return i.attr("disabled",!1).removeClass("disabled-button")},errorDuration:30})},n}(T),F=function(t){function e(){return this.ajax=bind(this.ajax,this),e.__super__.constructor.apply(this,arguments)}return extend(e,t),e.prototype.ajax=function(t,n){return n.existing_payment&&(t="/ajax_convert_trial",delete n.existing_payment),e.__super__.ajax.call(this,t,n)},e}(O),D=function(e){function n(){return this.ajax=bind(this.ajax,this),n.__super__.constructor.apply(this,arguments)}return extend(n,e),n.prototype.getGiftTiming=function(){return t('input[name="gifting_now_later"]:radio:checked').val()},n.prototype.ajax=function(t,e){return e.gift_timing=this.getGiftTiming(),e.existing_payment&&(t="/gift/ajax_buy",delete e.existing_payment),n.__super__.ajax.call(this,t,e)},n}(O),{PaymentFormStore:S,NewAccountComponent:w,PlanSelectionComponent:k,PaymentFormComponent:A,OrderConfirmationComponent:C,CaptchaComponent:m,GiftingRecipientComponent:v,GiftingConfirmationComponent:g,GiftingSelectionComponent:b,OrderReceiptComponent:$,ProBuyForm:O,ProConvertForm:F,ProGiftingForm:D}});var bind=function(t,e){return function(){return t.apply(e,arguments)}};define("modules/clean/payments/dfb_buy_form",["jquery","modules/core/dom","modules/core/exception","modules/core/i18n","modules/clean/keycode","modules/clean/payments/payment_form_events","modules/clean/web_timing_logger"],function(t,e,n,i,r,o,s){var a,u,_,c;return c=n.assert,_=i._,a=function(){function n(e,n,i){this.paymentFormActionMap=n,this.paymentFormSubmitTextMap=i,this._updatePaymentFormAction=bind(this._updatePaymentFormAction,this),this._updatePaymentFormSubmitText=bind(this._updatePaymentFormSubmitText,this),this.$container=t(e),this._listen()}return n.validate_payment_form=function(t){var e;return u.is_stored_billinginfo_selected()?t(!0):(e=this.payment_controller(),e?e.validate()?e.prepare_for_non_ajax_submit(t):t(!1):t(!0))},n.validate_tos=function(e){var n;return n=t("#tos_agree"),n.length>0&&!n.is(":checked")?(e.tos_agree={message_text:_("Please agree to the terms of service.")},n.trigger(o.VALIDATE_ERROR,"tos_agree"),!1):(n.trigger(o.VALIDATE_SUCCESS,"tos_agree"),!0)},n.payment_controller=function(){var n;return n=t(".payment-form-component"),e.controller(n)},n.prototype._listen=function(){return this._register_form_action_updater(),this._register_error_cleaners(),t(".account-toggle-new").on("click",function(t){return function(e){return e.preventDefault(),t._toggle_account_view("new")}}(this)),t(".account-toggle-existing").on("click",function(t){return function(e){return e.preventDefault(),t._toggle_account_view("existing")}}(this)),this.$container.on("payment-component-ready",function(t){return function(){var e;return e=t.$container.find("#cc_preferred"),e.prop("disabled",!1),s.mark_time_to_interactive()}}(this)),this.$container.submit(function(t){return function(){var e;return e=t.$container.find("#cc_preferred"),e.prop("disabled",!0),e.addClass("disabled").addClass("ajax-loading"),e.find(".cc_preferred__text").html(_("Processing..."))}}(this))},n.prototype._register_form_action_updater=function(){var t;return t=this.constructor.payment_controller(),t&&(t.$container.on(o.PAYMENT_METHOD_TYPE_CHANGE_EVENT,this._updatePaymentFormAction),t.$container.on(u.STORED_BILLING_INSTRUMENT_CHANGE_EVENT,this._updatePaymentFormAction),this._updatePaymentFormAction(null,t.get_selected_payment_method_id()),this.paymentFormSubmitTextMap)?(t.$container.on(o.PAYMENT_METHOD_TYPE_CHANGE_EVENT,this._updatePaymentFormSubmitText),this._updatePaymentFormSubmitText(null,t.get_selected_payment_method_id())):void 0},n.prototype._register_error_cleaners=function(){return this.$container.find("input").keyup(function(e){var n;return e.keyCode!==r.TAB?(n=t(e.target),n.removeClass("input-error"),n.closest(".text-input").find(".error-message").remove(),n.trigger(o.UNVALIDATED,n.attr("name"))):void 0}),this.$container.find("input[type=checkbox]").click(function(e){var n;return n=t(e.target),n.removeClass("input-error"),n.parent().find(".error-message").remove(),n.trigger(o.UNVALIDATED,n.attr("name"))}),this.$container.find(".select-input").change(function(){var e;return e=t(this),e.find(".error-message").remove(),e.trigger(o.UNVALIDATED,e.find("select").attr("name"))})},n.prototype._toggle_account_view=function(e){switch(e){case"new":t("#account_info_new").removeClass("hidden_elem"),t("#account_info_existing").addClass("hidden_elem");break;case"existing":t("#account_info_new").addClass("hidden_elem"),t("#account_info_existing").removeClass("hidden_elem")}return t('input[name="account_info_type"]').val(e),!1},n.prototype._updatePaymentFormSubmitText=function(e,n){var i,r,o;return o=this.paymentFormSubmitTextMap[n],c(o,"Could not find payment method "+n+" in "+this.paymentFormSubmitTextMap),t("form#teams_billing_form [type=submit] .cc_preferred__text").html(o),i=t("#terms-and-submit .tos-auto-agree-text .changable-button-text"),i.length>0?(r=o,i.html(r)):void 0},n.prototype._updatePaymentFormAction=function(e,n){var i,r,o;return r=u.is_stored_billinginfo_selected(),o=r?"stored":n,i=this.paymentFormActionMap[o],c(i,"Could not find payment method "+o+" in "+this.paymentFormActionMap),t("form#teams_billing_form").attr("action",i)},n.update_payment_methods_for_total_price=function(t){var e;return e=n.payment_controller(),e.update_payment_methods_for_total_price(t)},n}(),u=function(){function e(t){this.$elm=t,this._on_toggle=bind(this._on_toggle,this),this.paymentFormController=a.payment_controller(),this.$elm.find(".stored-billing-instrument-toggle .toggle").click(this._on_toggle)}return e.STORED_BILLING_INSTRUMENT_CHANGE_EVENT="db:billinginstrument:storedbillinginstrumentchange",e.is_stored_billinginfo_selected=function(){return!!t(".stored-billing-instrument-toggle .toggle.stored.selected:visible").length},e.prototype._on_toggle=function(n){var i;return i=t(n.target).closest(".toggle").hasClass("stored"),i!==e.is_stored_billinginfo_selected()?(this.$elm.find(".payment-methods-wrapper").toggleClass("hidden",i),this.$elm.find(".toggle.stored").toggleClass("selected",i),this.$elm.find(".toggle.new").toggleClass("selected",!i),this.paymentFormController.$container.trigger(e.STORED_BILLING_INSTRUMENT_CHANGE_EVENT,this.paymentFormController.get_selected_payment_method_id())):void 0},e}(),{DfbBuyForm:a,StoredBillingInstrumentToggle:u}});var indexOf=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1},bind=function(t,e){return function(){return t.apply(e,arguments)}},extend=function(t,e){function n(){this.constructor=t}for(var i in e)hasProp.call(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;define("modules/clean/payments/field_observer",["jquery","external/underscore","modules/clean/payments/payment_form_events"],function(t,e,n){var i,r,o,s,a,u,_,c;return _=function(t,e){return t[e.name]=e.value,t},u=function(t,e){return t[e]=!1,t},a=function(t){return{name:t,value:indexOf.call(this,t)>=0}},c=function(t,n,i,r){var o,s,a;s=e.extend({},t);for(o in n)a=n[o],i.call(r,o,a)&&(s[o]=a);return s},r=function(){function t(){}return t.value=function(t){return t},t.pureValue=function(t){return t},t.truthyValue=function(t){return!!t},t.isValue=function(t){return function(e){return e===t}},t.isNotValue=function(t){return function(e){return e!==t}},t.mapValue=function(t){return function(e){return t.hasOwnProperty(e)?t[e]:null}},t}(),s=function(){function t(){}return t.VALIDATION_ERROR_VALUE="error",t}(),i=function(i){function o(i,r,o,s){var a;this.form_selector=i,null==s&&(s={}),this.handleValidationSuccess=bind(this.handleValidationSuccess,this),this.handleValidationError=bind(this.handleValidationError,this),this.handleStateChange=bind(this.handleStateChange,this),this.handleFieldChange=bind(this.handleFieldChange,this),this._mergeCondition=bind(this._mergeCondition,this),a={debounce_wait:500,event_types:"input change blur",only_visible_fields:!0,validation_error_value:this.constructor.VALIDATION_ERROR_VALUE},this.options=e.extend({},a,s),this.$form=t(this.form_selector),this.field_map=e.map(r,function(t){var e,n,i;return e=t.key,n=t.name,i=t.transform,{key:e||n,name:n,transform:i}}),this.field_names=e.pluck(this.field_map,"name"),this.field_keys=e.pluck(this.field_map,"key"),this._default_state=e.reduce(this.field_keys,u,{}),this._value_state=this.serialize(),this._error_state={},this.dataHandler=e.debounce(o,this.options.debounce_wait),this.$form.on(n.VALIDATE_ERROR,this.handleValidationError),this.$form.on(n.VALIDATE_SUCCESS,this.handleValidationSuccess),this.$form.on(n.UNVALIDATED,this.handleValidationSuccess),this.$form.on(this.options.event_types,this.handleFieldChange)}return extend(o,i),o.prototype.serialize=function(){var n,i,r,o,s,a,u,c,l,d;for(i=[],u=this.field_map,r=0,s=u.length;s>r;r++)c=u[r],a=c.name,o=c.key,l=c.transform,n=t("[name='"+a+"']"),this.options.only_visible_fields&&(n=n.filter(":visible")),n.length>0&&(d=function(){switch(n.attr("type")){case"radio":return n.filter(":checked").val();case"checkbox":return n.is(":checked");default:return n.val()}}(),d=l.call(this,d),i.push({name:o,value:d}));return i=e.reduce(i,_,{}),i=e.defaults(i,this._default_state)},o.prototype.state=function(){return c(this._value_state,this._error_state,this._mergeCondition)},o.prototype.setValueState=function(t){return e.isEqual(this._value_state,t)?void 0:(this._value_state=t,this.handleStateChange())},o.prototype.setErrorState=function(t){return e.isEqual(this._error_state,t)?void 0:(this._error_state=t,this.handleStateChange())},o.prototype._mergeCondition=function(t){var n;return n=e.findWhere(this.field_map,{key:t}).transform,n!==r.pureValue},o.prototype.handleFieldChange=function(){return this.setValueState(this.serialize())},o.prototype.handleStateChange=function(){return this.dataHandler(this.state())},o.prototype.handleValidationError=function(t,n){var i,r;if(!(indexOf.call(this.field_names,n)<0))return r=e.findWhere(this.field_map,{name:n}).key,this._error_state.hasOwnProperty(r)?void 0:(i={},i[r]=this.options.validation_error_value,this.setErrorState(e.extend({},this._error_state,i)))},o.prototype.handleValidationSuccess=function(t,n){var i;if(!(indexOf.call(this.field_names,n)<0))return i=e.findWhere(this.field_map,{name:n}).key,this._error_state.hasOwnProperty(i)?this.setErrorState(e.omit(this._error_state,i)):void 0},o}(s),o=function(n){function i(n,i,r,o){this.update_message_name=n,this.error_message_name=i,this.dataHandler=o,this.handleMessage=bind(this.handleMessage,this),this.handleStateChange=bind(this.handleStateChange,this),this._mergeCondition=bind(this._mergeCondition,this),this.field_map=e.map(r,function(t){var e,n,i;return e=t.key,n=t.name,i=t.transform,{key:e||n,name:n,transform:i}}),this.field_names=e.pluck(this.field_map,"name"),this.field_keys=e.pluck(this.field_map,"key"),this._value_state=e.reduce(this.field_keys,u,{}),this._error_state={},t(window).on("message",this.handleMessage)}return extend(i,n),i.prototype.state=function(){return c(this._value_state,this._error_state,this._mergeCondition)},i.prototype._mergeCondition=function(t){return this._value_state.hasOwnProperty(t)?this._value_state[t]!==!0:!1},i.prototype.setValueState=function(t){return e.isEqual(t,this._value_state)?void 0:(this._value_state=t,this.handleStateChange())},i.prototype.setErrorState=function(t){return e.isEqual(t,this._error_state)?void 0:(this._error_state=t,this.handleStateChange())},i.prototype.handleStateChange=function(){return this.dataHandler(this.state())},i.prototype.handleMessage=function(t){var n,i,o,s,u,c,l,d;try{if(c=JSON.parse(t.originalEvent.data),c.action===this.update_message_name){for(n=c.DATA,n=e.map(this.field_names,a,n),s=0,u=n.length;u>s;s++)l=n[s],d=e.findWhere(this.field_map,{name:l.name}).transform,l.value=d.call(this,l.value);return n=e.reduce(n,_,{}),this.setValueState(n)}if(c.action===this.error_message_name)return n=c.DATA,n=e.map(this.field_names,a,n),n=e.filter(n,r.truthyValue),n=e.map(n,function(t){return function(e){var n,i;return n=e.name,i=e.value,{name:n,value:t.constructor.VALIDATION_ERROR_VALUE}}}(this)),n=e.reduce(n,_,{}),this.setErrorState(n)}catch(o){i=o}},i}(s),{FieldObserver:i,FrameFieldObserver:o,FieldTransforms:r}});var bind=function(t,e){return function(){return t.apply(e,arguments)}},extend=function(t,e){function n(){this.constructor=t}for(var i in e)hasProp.call(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;define("modules/clean/payments/multistep",["jquery","external/underscore","modules/core/i18n","modules/clean/analytics","modules/clean/components/ajax_form","modules/clean/components/register_form_validator"],function(t,e,n,i,r,o){var s,a,u,_,c,l,d,h,p,m;return m=n._,h=i.TeamsWebActionsLogger,_=["first","second","third"],c=function(){function e(t){this.$form=t,this.isFilledOut=bind(this.isFilledOut,this),this.validate=bind(this.validate,this),this.render=bind(this.render,this),this.handleContinue=bind(this.handleContinue,this),this.handleChange=bind(this.handleChange,this),this.setActive=bind(this.setActive,this),this.hasError=bind(this.hasError,this),this.getRequiredFields=bind(this.getRequiredFields,this),this.initListeners=bind(this.initListeners,this),this.initListeners(),this.render()}return e.prototype.initListeners=function(){return null!=this.$inputs&&this.$inputs.on("input",this.handleChange),null!=this.$selects&&this.$selects.on("change",this.handleChange),null!=this.$radios&&this.$radios.on("change",this.handleChange),null!=this.$checkboxes&&this.$checkboxes.on("change",this.handleChange),this.$button.on("click",this.handleContinue)},e.prototype.getRequiredFields=function(){var e;return e=t(),null!=this.$inputs&&(e=e.add(this.$inputs)),null!=this.$selects&&(e=e.add(this.$selects)),null!=this.$radios&&(e=e.add(this.$radios)),null!=this.$checkboxes&&(e=e.add(this.$checkboxes)),e},e.prototype.getLoggedFields=function(){return{}},e.prototype.focus=function(){},e.prototype.hasError=function(){return!!this.$parts.find(".error-message").length},e.prototype.setActive=function(t){var e;return e=this.$parts.hasClass("multistep--inactive")&&t,this.$parts.toggleClass("multistep--inactive",!t),e?this.focus():void 0},e.prototype.handleChange=function(){return this.render()},e.prototype.handleContinue=function(t){return t.preventDefault(),this.validate()?this.$form.trigger("continue"):void 0},e.prototype.render=function(){return this.$button.prop("disabled",!this.isFilledOut())},e.prototype.validate=function(t){var e,n;return this.isFilledOut()?(e=!0,n={},t||r.clear_errors(this.$form),r.fill_errors(this.$form,n),e):!1},e.prototype.isFilledOut=function(){var e;return e=!0,this.getRequiredFields().each(function(n){return function(i,r){var o,s,a;return o=t(r),a=o.prop("type"),o.hasClass("optional")||o.prop("disabled")||("checkbox"===a?e=o.is(":checked")&&e:"radio"===a?(s=n.$form.find("input[name='"+o.attr("name")+"']"),e=s.is(":checked")&&e):e=o.val().length&&e),e?void 0:!1}}(this)),e},e.prototype._validateField=function(e,n,i,r){var o;return i.hasClass("optional")?!0:(o=t.trim(i.val()),i.length>0&&!o?(e[n]={message_text:r},!1):!0)},e}(),l=function(e){function n(e){this.$form=e,this.getRequiredFields=bind(this.getRequiredFields,this),this.focus=bind(this.focus,this),this.$parts=t("#cc_info,#terms-and-submit,.helper-section-wrapper--payment"),this.$inputs=this.$form.find("input[name='zip']"),this.$selects=this.$form.find("select[name='country_code']"),this.$checkboxes=this.$form.find("#tos_agree"),this.$button=this.$form.find("#cc_preferred"),n.__super__.constructor.call(this,this.$form)}return extend(n,e),n.prototype.focus=function(){return this.$form.find("input[name='payment_method']").first().focus()},n.prototype.handleContinue=function(){return this.$form.trigger("continue")},n.prototype.getRequiredFields=function(){var t,e;return e=this.$form.find(".payment-method-form-wrapper:not(.hidden)"),t=e.find(this.$inputs.add(this.$selects)),t.add(this.$checkboxes)},n}(c),d=function(e){function n(e,i){this.$form=e,this.max_num_users=i,this._validateField=bind(this._validateField,this),this.validate=bind(this.validate,this),this.focus=bind(this.focus,this),this.getRequiredFields=bind(this.getRequiredFields,this),this.$parts=t("#plan_info,.helper-section-wrapper--plan"),this.$inputs=this.$form.find("#team_num_users input"),this.$radios=this.$form.find("#annual-radio,#monthly-radio"),this.$button=this.$form.find("#plan_info .continue"),n.__super__.constructor.call(this,this.$form)}return extend(n,e),n.prototype.getRequiredFields=function(){return this.$inputs.add(this.$radios)},n.prototype.focus=function(){return this.$form.find("#team_num_users input").focus()},n.prototype.validate=function(t){var e,n;return this.isFilledOut()?(e=!0,n={},e=this._validateField(n,"team_num_users",this.$form.find("input[name='team_num_users']"),m("Please enter a valid number of users."))&&e,t||r.clear_errors(this.$form),r.fill_errors(this.$form,n),e):!1},n.prototype._validateField=function(e,n,i,r){var o;return i.hasClass("optional")?!0:(o=t.trim(i.val()),"team_num_users"===n?(o=parseInt(o,10),!o||o>this.max_num_users||1>o?(e[n]={message_text:r},!1):!0):i.length>0&&!o?(e[n]={message_text:r},!1):!0)},n}(c),s=function(e){function n(e,i){this.$form=e,this.email=i,this.validate=bind(this.validate,this),this.focus=bind(this.focus,this),this.getRequiredFields=bind(this.getRequiredFields,this),this.$parts=t("#account_info_new,#account_info_existing,#team_info,.helper-section-wrapper--info"),this.$inputs=this.$form.find("input[name='fname'],input[name='lname'],input[name='email'], input[name='password'],#team_name input,#team_phone input"),this.$selects=this.$form.find("#company_size .select-input"),this.$button=this.$form.find("#team_info .continue"),this.registerFormValidator=new o("#account_info_new"),n.__super__.constructor.call(this,this.$form)}return extend(n,e),n.prototype.getRequiredFields=function(){var t,e;return t=this.$form.find("#account_info_new:not(.hidden_elem)").find(this.$inputs),e=this.$form.find("#team_info").find(this.$inputs),t.add(e).add(this.$selects)},n.prototype.getLoggedFields=function(){return this.email?{email:this.email}:{email:this.$form.find("input[name='email']").val()}},n.prototype.focus=function(){return this.$form.find("#account_info_new:not(.hidden_elem) input[name='fname'],#team_name input").first().focus()},n.prototype.validate=function(e){var n,i;return this.isFilledOut()?(n=!0,i={},n=this._validateField(i,"team_name",this.$form.find("input[name='team_name']"),m("Please enter a valid team name."))&&n,n=this._validateField(i,"team_phone",this.$form.find("input[name='team_phone']"),m("Please enter a valid contact telephone."))&&n,n=this._validateField(i,"company_size",this.$form.find("#company_size select"),m("Please enter your company size."))&&n,e||r.clear_errors(this.$form),t("#account_info_new:not(.hidden_elem)").length&&(n=this.registerFormValidator.validate()&&n),r.fill_errors(this.$form,i),n):!1},n}(c),u=function(){function n(e){this.$form=e,this.tryStateRestore=bind(this.tryStateRestore,this),this.handlePopState=bind(this.handlePopState,this),this.handleHashChange=bind(this.handleHashChange,this),this.state={currentStep:0},this.$form.on("continue",function(t){return function(){var e;return h.log("click_"+t.LOGGING_PREFIX+"_"+_[t.state.currentStep],null,null,null,e=!1),h.log("click_"+t.LOGGING_PREFIX+"_"+_[t.state.currentStep],t.getLoggedFields(),null,null,e=!0),2!==t.state.currentStep?(null!=window.history.pushState&&window.history.pushState(t.state.currentStep+1,"",""),{"else":window.location.hash=t.state.currentStep+1},t.setState(t.state.currentStep+1)):void 0}}(this)),t(window).on("popstate",this.handlePopState),t(window).on("hashchange",this.handleHashChange),this.$form.find("input[name='team_name']").val()&&(this.state.currentStep=this.panels[0].hasError()||!this.panels[0].validate(!0)?0:this.panels[1].hasError()||!this.panels[1].validate(!0)?1:2),t("#teams_billing_form,.helper-sections").removeClass("multistep--inactive"),this.render()}return n.prototype.handleHashChange=function(){var t;return t=parseInt(window.location.hash.substr(1))||0,this.tryStateRestore(t)},n.prototype.handlePopState=function(t){var e;return e=t.originalEvent.state||0,this.tryStateRestore(e)},n.prototype.tryStateRestore=function(t){var e,n,i,r,o;if(t<=this.state.currentStep)return this.setState(t);for(e=!0,o=n=i=this.state.currentStep,r=t-1;r>=i?r>=n:n>=r;o=r>=i?++n:--n)e=e&&this.panels[o].validate();return e?this.setState(t):(null!=window.history.replaceState&&window.history.replaceState(this.state.currentStep,"",""),{"else":window.location.replace("#"+this.state.currentStep)})},n.prototype.setState=function(t){return this.state.currentStep=t,this.render()},n.prototype.render=function(){return this.panels[0].setActive(0===this.state.currentStep),this.panels[1].setActive(1===this.state.currentStep),this.panels[2].setActive(2===this.state.currentStep)},n.prototype.getLoggedFields=function(){return e.extend({},this.panels[0].getLoggedFields(),this.panels[1].getLoggedFields(),this.panels[2].getLoggedFields())},n}(),p=function(e){function n(e,i,r){this.LOGGING_PREFIX="try",this.$form=t(e),this.panels=[new s(this.$form,r),new d(this.$form,i),new l(this.$form)],n.__super__.constructor.call(this,this.$form)}return extend(n,e),n}(u),a=function(e){function n(e,i,r,o,a){null==o&&(o=!1),this.order_summary_visibility=null!=a?a:[!0,!0,!0],this.LOGGING_PREFIX="buy",this.$form=t(e),this.$order_summary=t("#order-summary"),this.panels=o?[new s(this.$form,r),new d(this.$form,i),new l(this.$form)]:[new d(this.$form,i),new s(this.$form,r),new l(this.$form)],n.__super__.constructor.call(this,this.$form)}return extend(n,e),n.prototype.render=function(){return this.$order_summary.toggleClass("multistep--inactive",!this.order_summary_visibility[this.state.currentStep]),n.__super__.render.call(this)},n}(u),{TryMultistepForm:p,BuyMultistepForm:a}});var indexOf=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};define("modules/clean/payments/payment_form/credit_card_label",["modules/clean/payments/payment_form/payment_form_spec","jquery"],function(t,e){var n;return n=function(){function n(e,n){this.$container=e,this.spec=new t(n)}return n.prototype.update_for_country=function(t){var n,i;return i=this.spec.supported_credit_cards_for_country(t),n=this.$container.children(),n.detach().sort(function(t,n){var r,o;return r=e(t).data("credit-card-type"),o=e(n).data("credit-card-type"),indexOf.call(i,r)>=0&&indexOf.call(i,o)>=0?i.indexOf(r)-i.indexOf(o):indexOf.call(i,r)>=0?-1:indexOf.call(i,o)>=0?1:o>r?-1:1}),this.$container.append(n),n.each(function(t,n){var r;return r=e(n).data("credit-card-type"),e(n).toggleClass("hidden",indexOf.call(i,r)<0)})},n}()});var bind=function(t,e){return function(){return t.apply(e,arguments)}},extend=function(t,e){function n(){this.constructor=t}for(var i in e)hasProp.call(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;define("modules/clean/payments/payment_form/ideal",["jquery","modules/clean/payments/billing_info_validator","modules/clean/payments/payment_form/payment_method_base"],function(t,e,n){var i,r;return r=n.PaymentMethodFormWithZip,i=function(n){function i(t,n,r,o,s){this.$container=t,this.country_to_currency=r,this.country_codes_without_postal_code=o,this.get_form_inputs=bind(this.get_form_inputs,this),this.validate=bind(this.validate,this),i.__super__.constructor.apply(this,arguments),this._validator=new e(s,this.country_codes_without_postal_code),this._listen()}return extend(i,n),i.prototype.validate=function(){return this._validator.validate_ideal(this.$container)},i.prototype.get_form_inputs=function(e){return i.__super__.get_form_inputs.call(this,function(n){return function(i){return t.extend(i,n._get_form_inputs_with_whitelist(["bank_id"])),i.bank_name=n.$container.find("#bank_id option:selected").text(),
e(i)}}(this))},i}(r)});var bind=function(t,e){return function(){return t.apply(e,arguments)}},extend=function(t,e){function n(){this.constructor=t}for(var i in e)hasProp.call(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;define("modules/clean/payments/payment_form/iframe_credit_card",["jquery","modules/clean/ajax","modules/clean/dbmodal","modules/clean/payments/billing_info_validator","modules/clean/payments/payment_form/payment_method_base","modules/clean/payments/payment_form/iframe_rpc","modules/core/exception","modules/core/i18n","modules/core/notify"],function(t,e,n,i,r,o,s,a,u){var _,c,l,d,h,p,m,f;return _=n.DBModal,c=n.DBModalStack,m=r.PaymentMethodFormWithZip,d=o.IFrameRpc,h=o.IFrameRpcListener,p=o.IFrameRpcTransport,f=a._,l=function(n){function r(e,n,o,s,a,u,_){this.$container=e,this.country_to_currency=o,this.country_codes_without_postal_code=s,this.iframe_location=_,this.handleDataStatusUpdate=bind(this.handleDataStatusUpdate,this),this.focusOutsideIframe=bind(this.focusOutsideIframe,this),this.showCvvModal=bind(this.showCvvModal,this),this.submitTokenized=bind(this.submitTokenized,this),this._ping_iframe=bind(this._ping_iframe,this),this.originReady=bind(this.originReady,this),this.get_form_inputs=bind(this.get_form_inputs,this),this.fetch_bt_token_if_absent=bind(this.fetch_bt_token_if_absent,this),this.validate=bind(this.validate,this),this._adjust_iframe_holder_height=bind(this._adjust_iframe_holder_height,this),r.__super__.constructor.apply(this,arguments),this.failedFields=[],this.fieldsProgress=[],this.bt_token=t.Deferred(),this.iframe_initialized=t.Deferred(),this._validator=new i(a,this.country_codes_without_postal_code),this.iframe_message_handler=new h("https://cf.dropboxpayments.com",this),u&&this.bt_token.resolve(u),this.fetch_bt_token_if_absent(),this._listen(),this._init_iframe(),this._toggle_zip_based_on_country(),this._adjust_iframe_holder_height()}return extend(r,n),r.iframe_message_transport=null,r.prototype._adjust_iframe_holder_height=function(){return this.$container.find("#iframe-holder").height(this.$container.find("#iframe-holder").width()<550?200:105)},r.prototype._listen=function(){return r.__super__._listen.apply(this,arguments),this.cvv_modal=new _({element_id:"cvv-modal"}),this.cvv_modal.__x_click_handler=function(t){return t.preventDefault(),c.pop()},this.cvv_modal.__overlay_click_handler=function(){return c.pop()},t(window).resize(this._adjust_iframe_holder_height)},r.prototype.validate=function(){return this._validator.validate_iframe_credit_card(this.$container)},r.prototype.fetch_bt_token_if_absent=function(t){return null==t&&(t=!1),this.is_test()&&this.bt_token.resolve("test-success-token"),"resolved"!==this.bt_token.state()?e.BackgroundRequest({url:"/payments/braintree_token",success:function(t){return function(e){var n;return n=JSON.parse(e),t.bt_token.resolve(n.token)}}(this),error:function(e){return t&&u.error(f("There was an error; please refresh the page.")),s.reportException({msg:"ajax /braintree_token failed: "+JSON.stringify(e.status)+" "+e.statusText,severity:s.SEVERITY.CRITICAL})}}):void 0},r.prototype.is_test=function(){return""===this.iframe_location},r.prototype.is_test_bt_token=function(t){return"test-success-token"===t},r.prototype.get_form_inputs=function(e){return r.__super__.get_form_inputs.call(this,function(n){return function(i){return n.base_inputs=i,n.get_form_inputs_cb=e,n.fetch_bt_token_if_absent(!0),t.when(n.bt_token).done(function(e){return n.is_test_bt_token(e)?n.submitTokenized("fake-valid-nonce"):t.when(n.iframe_initialized).done(function(){return r.iframe_message_transport.sendMessage(d.TOKENIZE)})})}}(this))},r.prototype.originReady=function(){return this.iframe_ready=!0,t.when(this.bt_token).done(function(t){return function(e){return t.is_test_bt_token(e)||r.iframe_message_transport.sendMessage(d.INIT_BRAINTREE,{token:e}),t.iframe_initialized.resolve()}}(this))},r.prototype._init_iframe=function(){var t;return this.iframe_ready=!1,this.is_test()?void 0:(t=frames.cc_iframe.window,r.iframe_message_transport=new p(this.iframe_location,t),this._ping_iframe())},r.prototype._ping_iframe=function(){return this.iframe_ready?void 0:(r.iframe_message_transport.sendMessage(d.READY),setTimeout(this._ping_iframe,250))},r.prototype.submitTokenized=function(e){return t.extend(this.base_inputs,this._get_form_inputs_with_whitelist(["card_type","device_data","expmo","expyr","nonce"])),t.extend(this.base_inputs,{nonce:e}),this.$container.find("input[name=nonce]").val(e),this.get_form_inputs_cb(this.base_inputs)},r.prototype.showCvvModal=function(){return c.push(this.cvv_modal)},r.prototype.focusOutsideIframe=function(){return this.$container.find("[name=zip]").focus()},r.prototype.handleDataStatusUpdate=function(t){return this.fieldsProgress=t},r.prototype.handleValidationFailure=function(t){return this.failedFields=t,this.get_form_inputs_cb({errors:!0})},r}(m)}),define("modules/clean/payments/payment_form/iframe_rpc",[],function(){var t,e,n;return t=function(){function t(){}return t.READY="READY",t.TOKENIZE="TOKENIZE",t.TOKENIZED="TOKENIZED",t.INIT_BRAINTREE="INIT_BRAINTREE",t.DATA="DATA",t.SHOW_CVV_MODAL="SHOW_CVV_MODAL",t.FOCUS_OUTSIDE_IFRAME="FOCUS_OUTSIDE_IFRAME",t.VALIDATION_FAILED="VALIDATION_FAILED",t.STATUS_UPDATE="DATA_STATUS_UPDATE",t}(),e=function(){function e(e,n){this.origin=e,this.handler=n,window.onmessage=function(e){return function(n){var i,r,o;if(e.origin===n.origin){if(i=JSON.parse(n.data),i.action===t.READY)return e.handler.originReady(n.source);if(i.action===t.TOKENIZE)return e.handler.tokenize();if(i.action===t.INIT_BRAINTREE)return e.handler.init_bt(null!=(r=i[t.DATA])?r.token:void 0);if(i.action===t.TOKENIZED)return e.handler.submitTokenized(null!=(o=i[t.DATA])?o.nonce:void 0);if(i.action===t.SHOW_CVV_MODAL)return e.handler.showCvvModal();if(i.action===t.FOCUS_OUTSIDE_IFRAME)return e.handler.focusOutsideIframe();if(i.action===t.STATUS_UPDATE)return e.handler.handleDataStatusUpdate(i[t.DATA]);if(i.action===t.VALIDATION_FAILED)return e.handler.handleValidationFailure(i[t.DATA]);if(null!=i.action)throw new Error("Unknown action: "+i.action)}}}(this)}return e}(),n=function(){function e(t,e){this.origin=t,this.target=e}return e.prototype.sendMessage=function(e,n){var i,r;return r={action:e},null!=n&&(r[t.DATA]=n),i=JSON.stringify(r),this.target.postMessage(i,this.origin)},e}(),{IFrameRpc:t,IFrameRpcTransport:n,IFrameRpcListener:e}});var bind=function(t,e){return function(){return t.apply(e,arguments)}},indexOf=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};define("modules/clean/payments/payment_form/payment_form",["jquery","modules/core/dom","modules/clean/payments/payment_form_events","modules/clean/payments/payment_form/payment_form_spec"],function(t,e,n,i){var r;return r=function(){function r(n,r){this.$container=n,this.prepare_for_non_ajax_submit=bind(this.prepare_for_non_ajax_submit,this),this.get_form_inputs=bind(this.get_form_inputs,this),this.validate=bind(this.validate,this),this.set_zip_code=bind(this.set_zip_code,this),this.get_zip_code=bind(this.get_zip_code,this),this.set_vat=bind(this.set_vat,this),this.get_vat=bind(this.get_vat,this),this._get_currency_for_country=bind(this._get_currency_for_country,this),this.get_country_currency=bind(this.get_country_currency,this),this.get_country_code=bind(this.get_country_code,this),this.set_selected_payment_method_id=bind(this.set_selected_payment_method_id,this),this.update_payment_methods_for_total_price=bind(this.update_payment_methods_for_total_price,this),this._on_child_vat_updated=bind(this._on_child_vat_updated,this),this._on_child_country_code_updated=bind(this._on_child_country_code_updated,this),this._show_payment_method_toggles=bind(this._show_payment_method_toggles,this),this._on_payment_method_updated=bind(this._on_payment_method_updated,this),this._update_payment_method_option_status=bind(this._update_payment_method_option_status,this),this._update_tabindexes=bind(this._update_tabindexes,this),this._show_payment_method_form=bind(this._show_payment_method_form,this),this.spec=new i(r),this._child_controllers={},this.$container.find(".payment-method-form-wrapper").each(function(n){return function(i,r){var o;return o=t(r).data("payment-method-id"),n._child_controllers[o]=e.controller(t(r).find(".payment-method"))}}(this)),this._listen(),this._on_payment_method_updated(),this._update_tabindexes(this.get_selected_payment_method_id())}return r.prototype._listen=function(){var t,e,i,r;this.$container.find('input[name="payment_method"]').change(this._on_payment_method_updated),i=this._child_controllers,r=[];for(e in i)t=i[e],t.$container.on(n.LOCATION_CHANGE_EVENT,this._on_child_country_code_updated),r.push(t.$container.on(n.VAT_CHANGE_EVENT,this._on_child_vat_updated));return r},r.prototype._show_payment_method_form=function(t){return this.$container.find(".payment-method-form-wrapper").addClass("hidden"),this.$container.find(".payment-method-form-wrapper[data-payment-method-id="+t+"]").removeClass("hidden")},r.prototype._update_tabindexes=function(e){var n;return n=null,this.$container.find(".payment-method-form-wrapper [tabindex]").each(function(){var e,i;return e=t(this),i=parseInt(e.attr("tabindex")||e.data("original-tabindex"),10),null!=i&&i>-1&&(e.attr("tabindex",-1),e.data("original-tabindex",i),!n||n>i)?n=i:void 0}),this.$container.find(".payment-method-form-wrapper[data-payment-method-id="+e+"]").find("input, textarea, select, button").each(function(){return t(this).attr("tabindex",n)})},r.prototype._update_payment_method_option_status=function(t){return this.$container.find(".payment-method-option.active").removeClass("active"),this.$container.find(".payment-method-option[data-payment-method-id="+t+"]").addClass("active")},r.prototype._on_payment_method_updated=function(){var t;return t=this.get_selected_payment_method_id(),this._show_payment_method_form(t),this._update_payment_method_option_status(t),this._update_tabindexes(t),this.$container.trigger(n.PAYMENT_METHOD_TYPE_CHANGE_EVENT,t)},r.prototype._show_payment_method_toggles=function(e){var n,i;return i=this.$container.find(".payment-method-selector"),n=i.children(".payment-method-option"),n.detach().sort(function(n,i){var r,o;return r=t(n).data("payment-method-id"),o=t(i).data("payment-method-id"),indexOf.call(e,r)>=0&&indexOf.call(e,o)>=0?e.indexOf(r)-e.indexOf(o):indexOf.call(e,r)>=0?-1:indexOf.call(e,o)>=0?1:r-o}),i.append(n),n.each(function(n,i){var r;return r=t(i).data("payment-method-id"),t(i).toggleClass("hidden",indexOf.call(e,r)<0)})},r.prototype._on_child_country_code_updated=function(i,r){var o,s,a,u,_,c,l;s=r.country_code,l=this.spec.supported_payment_methods_for_country(s),a=this._get_currency_for_country(s),l=this.spec.filter_payment_methods_by_currency(l,a),this._show_payment_method_toggles(l),this.$container.find(".payment-method-selector .payment-method-desc [data-js-component-id]").each(function(n,i){return e.controller(t(i)).update_for_country(s)}),c=parseInt(this.get_selected_payment_method_id(),10),indexOf.call(l,c)<0&&this.set_selected_payment_method_id(l[0]),_=this._child_controllers;for(u in _)o=_[u],o.set_country_code(s);return this.$container.trigger(n.LOCATION_CHANGE_EVENT,r)},r.prototype._on_child_vat_updated=function(t,e){var i,r,o;o=this._child_controllers;for(r in o)i=o[r],i.set_vat(e);return this.$container.trigger(n.VAT_CHANGE_EVENT,e)},r.prototype.update_payment_methods_for_total_price=function(t){var e,n,i;return e=this.spec.supported_payment_methods_for_country(this.get_country_code()),i=this.spec.filter_payment_methods_by_price_limit(e,t),this._show_payment_method_toggles(i),n=parseInt(this.get_selected_payment_method_id(),10),indexOf.call(i,n)<0?this.set_selected_payment_method_id(i[0]):void 0},r.prototype.get_selected_payment_method_id=function(){return this.$container.find('input[name="payment_method"]:checked').val()},r.prototype.set_selected_payment_method_id=function(t){return this.$container.find("input[name='payment_method'][value="+t+"]").prop("checked","checked"),this._on_payment_method_updated()},r.prototype.get_country_code=function(){var t;return t=this.get_selected_payment_method_id(),this._child_controllers[t].get_country_code()},r.prototype.get_country_currency=function(){var t;return t=this.get_country_code(),this._get_currency_for_country(t)},r.prototype._get_currency_for_country=function(t){var e;return e=this.get_selected_payment_method_id(),this._child_controllers[e].get_country_currency(t)},r.prototype.get_vat=function(){var t;return t=this.get_selected_payment_method_id(),this._child_controllers[t].get_vat()},r.prototype.set_vat=function(t){var e,n,i,r;i=this._child_controllers,r=[];for(n in i)e=i[n],r.push(e.set_vat(t));return r},r.prototype.get_zip_code=function(){var t;return t=this.get_selected_payment_method_id(),this._child_controllers[t].get_zip_code()},r.prototype.set_zip_code=function(t){var e,n,i,r;i=this._child_controllers,r=[];for(n in i)e=i[n],r.push(e.set_zip_code(t));return r},r.prototype.validate=function(){var t;return t=this.get_selected_payment_method_id(),this._child_controllers[t].validate()},r.prototype.get_form_inputs=function(t){var e;return e=this.get_selected_payment_method_id(),this._child_controllers[e].get_form_inputs(t)},r.prototype.prepare_for_non_ajax_submit=function(e){return this.get_form_inputs(function(n){return function(){var i;return i=parseInt(n.get_selected_payment_method_id(),10),n.$container.find(".payment-method-form-wrapper").each(function(e,n){var r;return r=t(n).data("payment-method-id"),r!==i?t(n).detach():void 0}),e(!0)}}(this))},r}()});var bind=function(t,e){return function(){return t.apply(e,arguments)}},indexOf=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};define("modules/clean/payments/payment_form/payment_form_spec",[],function(){var t;return t=function(){function t(t){this.spec=t,this.filter_payment_methods_by_currency=bind(this.filter_payment_methods_by_currency,this),this.filter_payment_methods_by_price_limit=bind(this.filter_payment_methods_by_price_limit,this),this.should_show_vat_for_country=bind(this.should_show_vat_for_country,this),this.supported_credit_cards_for_country=bind(this.supported_credit_cards_for_country,this),this.default_payment_method_for_country=bind(this.default_payment_method_for_country,this),this.supported_payment_methods_for_country=bind(this.supported_payment_methods_for_country,this)}return t.prototype.supported_payment_methods_for_country=function(t){return t in this.spec.supported_payment_methods_overrides_by_country?this.spec.supported_payment_methods_overrides_by_country[t]:this.spec.default_supported_payment_methods},t.prototype.default_payment_method_for_country=function(t){var e;return e=this.supported_payment_methods_for_country(t),e[0]},t.prototype.supported_credit_cards_for_country=function(t){return t in this.spec.supported_credit_cards_overrides_by_country?this.spec.supported_credit_cards_overrides_by_country[t]:this.spec.default_supported_credit_cards},t.prototype.should_show_vat_for_country=function(t){return indexOf.call(this.spec.countries_with_vat,t)>=0},t.prototype.filter_payment_methods_by_price_limit=function(t,e){var n,i,r,o,s,a;for(a=[],s=this.spec.price_limit_for_payment_methods,n=0,i=t.length;i>n;n++)o=t[n],r=s[o],e.currency in r?e.amount<=r[e.currency]&&a.push(o):a.push(o);return a},t.prototype.filter_payment_methods_by_currency=function(t,e){var n,i,r,o,s;for(s=[],o=this.spec.supported_currencies_for_payment_methods,n=0,i=t.length;i>n;n++)r=t[n],null==o[r]?s.push(r):indexOf.call(o[r],e)>=0&&s.push(r);return s},t}()});var bind=function(t,e){return function(){return t.apply(e,arguments)}},indexOf=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1},extend=function(t,e){function n(){this.constructor=t}for(var i in e)hasProp.call(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;define("modules/clean/payments/payment_form/payment_method_base",["jquery","modules/core/exception","modules/core/i18n","modules/core/notify","modules/clean/payments/payment_form_events","modules/clean/payments/payment_form/payment_form_spec"],function(t,e,n,i,r,o){var s,a,u,_;return _=e.assert,u=n._,s=function(){function e(t,e,n){this.$container=t,this.country_to_currency=n,this._toggle_vat_based_on_country=bind(this._toggle_vat_based_on_country,this),this._handle_zip_code_change=bind(this._handle_zip_code_change,this),this._handle_vat_change=bind(this._handle_vat_change,this),this._handle_country_code_change=bind(this._handle_country_code_change,this),this.get_form_inputs=bind(this.get_form_inputs,this),this.validate=bind(this.validate,this),this.spec=new o(e),this.current_country_code=this.get_country_code()}return e.prototype._listen=function(){return this.$container.find('[name="country_code"]').on("input change propertychange paste",this._handle_country_code_change),this.$container.find('[name="vat"]').on("input change propertychange",this._handle_vat_change),this.$container.find('[name="zip"]').on("input change propertychange",this._handle_zip_code_change)},e.prototype.set_country_code=function(t){return this.$container.find('[name="country_code"]').val(t),this._toggle_vat_based_on_country()},e.prototype.set_vat=function(t){return this.$container.find('[name="vat"]').val(t)},e.prototype.set_zip_code=function(t){return this.$container.find('[name="zip"]').val(t)},e.prototype.get_country_code=function(){return this.$container.find('[name="country_code"]').val()},e.prototype.get_country_currency=function(t){return this.country_to_currency[t]},e.prototype.get_vat=function(){return this.$container.find('[name="vat"]').val()},e.prototype.get_zip_code=function(){return this.$container.find('[name="zip"]').val()},e.prototype.validate=function(){return _(!1,"Need to implement validate function")},e.prototype._get_form_inputs_with_whitelist=function(e){var n;return n={},this.$container.find("input, select").each(function(i,r){var o,s;return o=t(r),s=o.attr("name"),indexOf.call(e,s)>=0?n[o.attr("name")]=o.val():void 0}),n},e.prototype.get_form_inputs=function(t){return t(this._get_form_inputs_with_whitelist(["vat"]))},e.prototype._handle_country_code_change=function(){var t;return t=this.get_country_code(),!this.get_country_currency(t)&&this.get_country_currency(this.current_country_code)?(i.error(u("This billing country change isn’t supported."),3),void this.set_country_code(this.current_country_code)):(this.current_country_code=t,this._toggle_vat_based_on_country(),this.$container.trigger(r.LOCATION_CHANGE_EVENT,{country_code:this.get_country_code(),zip_code:this.get_zip_code()}))},e.prototype._handle_vat_change=function(){return this.$container.trigger(r.VAT_CHANGE_EVENT,this.get_vat())},e.prototype._handle_zip_code_change=function(){return"US"===this.get_country_code()&&5===this.get_zip_code().length?this.$container.trigger(r.LOCATION_CHANGE_EVENT,{country_code:this.get_country_code(),zip_code:this.get_zip_code()}):void 0},e.prototype._toggle_vat_based_on_country=function(){var t,e;return e=this.get_country_code(),t=this.$container.find(".vat-input"),this.spec.should_show_vat_for_country(e)?t.removeClass("hidden"):(t.find("input").val(""),t.addClass("hidden"),t.removeClass("input-error"))},e}(),a=function(e){function n(t,e,i,r){this.$container=t,this.country_to_currency=i,this.country_codes_without_postal_code=r,this._toggle_zip_based_on_country=bind(this._toggle_zip_based_on_country,this),this._handle_country_code_change=bind(this._handle_country_code_change,this),this.get_form_inputs=bind(this.get_form_inputs,this),n.__super__.constructor.apply(this,arguments)}return extend(n,e),n.prototype.set_country_code=function(){return n.__super__.set_country_code.apply(this,arguments),this._toggle_zip_based_on_country()},n.prototype.get_form_inputs=function(e){return n.__super__.get_form_inputs.call(this,function(n){return function(i){return t.extend(i,n._get_form_inputs_with_whitelist(["country_code","zip"])),e(i)}}(this))},n.prototype._handle_country_code_change=function(){return n.__super__._handle_country_code_change.apply(this,arguments),this._toggle_zip_based_on_country()},n.prototype._toggle_zip_based_on_country=function(){var t,e,n,i,r,o;return r=this.get_country_code(),o=indexOf.call(this.country_codes_without_postal_code,r)>=0,e=this.$container.find('input[name="zip"]'),e.prop("disabled",o),o&&(e.val(""),e.removeClass("input-error")),i=this.$container.find('label[for="'+e.attr("id")+'"]'),n=i.find(".zip_label"),t=i.find(".postal_label"),"US"===r?(n.removeClass("hidden"),t.addClass("hidden")):(n.addClass("hidden"),t.removeClass("hidden"))},n}(s),{PaymentMethodFormBase:s,PaymentMethodFormWithZip:a}});var bind=function(t,e){return function(){return t.apply(e,arguments)}},extend=function(t,e){function n(){this.constructor=t}for(var i in e)hasProp.call(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;define("modules/clean/payments/payment_form/paypal",["modules/clean/payments/billing_info_validator","modules/clean/payments/payment_form/payment_method_base"],function(t,e){var n,i;return n=e.PaymentMethodFormWithZip,i=function(e){function n(e,i,r,o,s){this.$container=e,this.country_to_currency=r,this.country_codes_without_postal_code=o,this.validate=bind(this.validate,this),n.__super__.constructor.apply(this,arguments),this._validator=new t(s,this.country_codes_without_postal_code),this._listen()}return extend(n,e),n.prototype.validate=function(){return this._validator.validate_paypal(this.$container)},n}(n)});var bind=function(t,e){return function(){return t.apply(e,arguments)}},extend=function(t,e){function n(){this.constructor=t}for(var i in e)hasProp.call(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;define("modules/clean/payments/payment_form/sepa_direct_debit",["jquery","modules/clean/payments/billing_info_validator","modules/clean/payments/payment_form/payment_method_base"],function(t,e,n){var i,r;return i=n.PaymentMethodFormWithZip,r=function(n){function i(t,n,r,o,s){this.$container=t,this.country_to_currency=r,this.country_codes_without_postal_code=o,this.get_form_inputs=bind(this.get_form_inputs,this),this.validate=bind(this.validate,this),i.__super__.constructor.apply(this,arguments),this._validator=new e(s,this.country_codes_without_postal_code),this._listen()}return extend(i,n),i.prototype.validate=function(){return this._validator.validate_sepa_direct_debit(this.$container)},i.prototype.get_form_inputs=function(e){return i.__super__.get_form_inputs.call(this,function(n){return function(i){return t.extend(i,n._get_form_inputs_with_whitelist(["owner_name","iban","bic","address","region","mandate_signed"])),i.iban=i.iban.replace(/\s+/g,""),e(i)}}(this))},i}(i)});var bind=function(t,e){return function(){return t.apply(e,arguments)}};define("modules/clean/payments/payment_form_analytics",["jquery","external/underscore","modules/clean/payments/field_observer","modules/clean/analytics"],function(t,e,n,i){var r,o,s,a,u;return o=n.FieldObserver,a=n.FrameFieldObserver,s=n.FieldTransforms,u=i.TeamsWebActionsLogger,r=function(){function n(t,e,n){this.form_selector=t,this.is_trial=e,this.log_init_state=null!=n?n:!0,this.onChangedFields=bind(this.onChangedFields,this),this.field_state={},this.event_name=this.is_trial?"try":"buy",this.listen()}return n.prototype.listen=function(){var n,i,r,_;return _=[{name:"company_size",transform:s.truthyValue},{name:"country_code",transform:s.isNotValue("US")},{name:"email",transform:s.truthyValue},{name:"fname",transform:s.truthyValue},{name:"lname",transform:s.truthyValue},{name:"password",transform:s.truthyValue},{name:"payment_method",transform:s.mapValue({1:"cc",2:"paypal"})},{name:"schedule_id",key:"plan",transform:s.mapValue({1:"monthly",2:"annual"})},{name:"team_name",transform:s.truthyValue},{name:"team_num_users",transform:s.pureValue},{name:"team_phone",transform:s.truthyValue},{name:"tos_agree",key:"tos",transform:s.truthyValue},{name:"vat",transform:s.truthyValue},{name:"zip",transform:s.truthyValue}],n=[{name:"ccn",transform:s.truthyValue},{name:"ccexp",transform:s.truthyValue},{name:"ccode",transform:s.truthyValue}],i=new o(this.form_selector,_,this.onChangedFields),r=new a("DATA_STATUS_UPDATE","VALIDATION_FAILED",n,this.onChangedFields),this.field_state=e.extend({},i.state(),r.state()),this.log_init_state&&u.log("fill_"+this.event_name+"_form",this.field_state),t('[type="submit"]',this.form_selector).on("click",function(t){return function(){return u.log("click_"+t.event_name+"_submit",t.field_state)}}(this)),t(".account_create_form .login-link",this.form_selector).on("click",function(t){return function(){return u.log("click_"+t.event_name+"_use_existing_account")}}(this))},n.prototype.onChangedFields=function(t){return this.field_state=e.extend({},this.field_state,t),u.log("fill_"+this.event_name+"_form",this.field_state)},n}(),{BusinessFormFieldObserver:r}}),define("modules/clean/payments/payment_form_events",[],function(){var t;return t=function(){function t(){}return t.LOCATION_CHANGE_EVENT="db:paymentform:countrycodechanged",t.PAYMENT_METHOD_TYPE_CHANGE_EVENT="db:paymentform:paymentmethodtypechanged",t.VAT_CHANGE_EVENT="db:paymentform:vatchanged",t.UNVALIDATED="db:paymentform:unvalidated",t.VALIDATE_ERROR="db:paymentform:validateerror",t.VALIDATE_SUCCESS="db:paymentform:validatesuccess",t.LOADED_EVENT="db:paymentform:loaded",t}()});var bind=function(t,e){return function(){return t.apply(e,arguments)}};define("modules/clean/payments/pricing_table",["jquery","external/underscore","modules/clean/analytics","modules/core/exception","modules/clean/payments/cash","modules/clean/payments/dfb_buy_form","modules/clean/payments/dfb_util","modules/clean/payments/payment_form_events","modules/clean/payments/validation","modules/core/i18n"],function(t,e,n,i,r,o,s,a,u,_){var c,l,d,h,p,m,f;return m=i.assert,c=r.Cash,d=o.DfbBuyForm,l=s.DfBTransitionInfoFetcher,p=_._,f=_.format_percent,h=function(){function i(i,r,o,s,a,u,_){this.max_additional_licenses=i,this.discount_ratio=r,this.transition_view_models=o,this.fallback_to_annual=s,this.country_to_vat_rate_map=a,this.country_to_tax_name_map=u,this.options=null!=_?_:{allow_unqualified_price:!1,log_num_licenses_entered:!1},this.update_order_summary=bind(this.update_order_summary,this),this.update_pricing=bind(this.update_pricing,this),this.update_billing_options=bind(this.update_billing_options,this),this.on_num_licenses_changed=bind(this.on_num_licenses_changed,this),this.handle=bind(this.handle,this),this.get_matching_transition_view_model=bind(this.get_matching_transition_view_model,this),this.get_vat_number=bind(this.get_vat_number,this),this.get_zip_code=bind(this.get_zip_code,this),this.get_num_users=bind(this.get_num_users,this),this.update_currency=bind(this.update_currency,this),this.update_zip=bind(this.update_zip,this),this.update_country=bind(this.update_country,this),this.update_schedule=bind(this.update_schedule,this),this.payment_form_controller=d.payment_controller(),this.transition_info_fetcher=new l(this.transition_view_models),this.base_users=this.transition_view_models[0].state.plan.included_license_counts[0].license_count,this.logger=n.TeamsWebActionsLogger,this.debounced_handle=e.debounce(this.handle,200),this._num_users_log_pwraps=[],this._num_users_pipeline_promise=t.Deferred().resolve(),this.first_update_complete=!1,this.listen()}return i.prototype.MONTHLY_SCHEDULE_ID=1,i.prototype.ANNUAL_SCHEDULE_ID=2,i.prototype.get_country_tax_name=function(t){return this.country_to_tax_name_map[t]||this.country_to_tax_name_map.Other},i.prototype.update_schedule=function(){return this.schedule_id=t("#annual-radio").is(":checked")?this.ANNUAL_SCHEDULE_ID:t("#monthly-radio").is(":checked")?this.MONTHLY_SCHEDULE_ID:this.fallback_to_annual?this.ANNUAL_SCHEDULE_ID:null},i.prototype.update_country=function(){var e;return e=this.payment_form_controller.get_country_code(),e!==this.country&&(this.country&&(t(".tax .price span").addClass("highlight-payment-amounts"),setTimeout(function(){return t(".tax .price span").removeClass("highlight-payment-amounts")},4e3)),this.country=e),e},i.prototype.update_zip=function(){var e;return e=this.payment_form_controller.get_zip_code(),e!==this.zip_code&&(t(".tax .price span").addClass("highlight-payment-amounts"),setTimeout(function(){return t(".tax .price span").removeClass("highlight-payment-amounts")},4e3),this.zip_code=e),e},i.prototype.update_currency=function(){var e,n;return n=this.payment_form_controller.get_country_currency(),n||(n="USD"),n!==this.currency&&(this.currency&&(t(".currency-banner").removeClass("hidden_elem"),e=".base .price i , .total .price i , .discount .amount i, .extra .price i, .tax .price span",t(e).addClass("highlight-payment-amounts"),setTimeout(function(){return t(e).removeClass("highlight-payment-amounts")},4e3)),this.currency=n),t("#currency").val(this.currency),this.currency},i.prototype._num_users_is_acceptable=function(t){return/^[1-9]\d*$/.test(t)},i.prototype._get_raw_num_users=function(){return t("#team_num_users").val()},i.prototype.get_num_users=function(){return Math.min(parseInt(this._get_raw_num_users(),10)||0,this.max_additional_licenses)},i.prototype.get_zip_code=function(){return this.payment_form_controller.get_zip_code()},i.prototype.get_vat_number=function(){var t;return t=this.payment_form_controller.get_vat(),""!==t&&u.validate_vat(this.country,t)?t:""},i.prototype._unqualified_total_price=function(t,e){var n,i,r,o,s;return null==e&&(e=!0),r=this.get_num_users(),e?(o=c.fromObject(t.read_only_invoice.total),n=this.get_min_num_users_from_model(t),m(n>r,"Cannot calculate the unqualified taxed price if the number of users entered is >= to the minimum number of users required by model"),s=o.amount/n*r):(i=c.fromObject(t.state.next_license_prices[0].price),s=i.amount*r),new c(s,t.state.currency)},i.prototype._qualified_total_price=function(t,e){var n,i,r,o,s;if(null==e&&(e=!0),e)return c.fromObject(t.read_only_invoice.total);for(o=new c(0,t.state.currency),s=t.read_only_invoice.line_items,n=0,i=s.length;i>n;n++)r=s[n],o=o.add(c.fromObject(r.discounted_line_item_price));return o},i.prototype.total_price=function(t){var e;return e=this.get_num_users(),this.options.allow_unqualified_price&&!this._num_users_is_acceptable(e)?new c(0,t.state.currency):this.should_use_unqualified_price(t)?this._unqualified_total_price(t):this._qualified_total_price(t)},i.prototype.user_price=function(t){var e;return e=c.fromObject(t.state.next_license_prices[0].price),this.discount_ratio&&(e=e.multiply(1-this.discount_ratio)),e},i.prototype.get_matching_transition_view_model=function(t,e){var n,i,r;for(n=0,i=t.length;i>n;n++)if(r=t[n],r.state.schedule.id===e)return r;return null},i.prototype.listen=function(){return t(this.handle),t("#monthly-radio").change(this.handle),t("#annual-radio").change(this.handle),this.payment_form_controller.$container.on(a.LOCATION_CHANGE_EVENT,this.handle),this.payment_form_controller.$container.on(a.VAT_CHANGE_EVENT,this.handle),t("#team_num_users").on("input",this.on_num_licenses_changed)},i.prototype.handle=function(){var e,n,i;return this.update_schedule(),this.update_country(),this.update_currency(),this.log_num_licenses(),e=Math.max(this.get_num_users(),this.base_users),n={total_users:e,vat_id:this.get_vat_number(),country_code:this.country,currency:this.currency,zip_code:this.get_zip_code(),discount_ratio:this.discount_ratio},i=function(e){return function(n){var i,r,o;return o=function(){var t,e,r;for(r=[],t=0,e=n.length;e>t;t++)i=n[t],r.push(i.transition_view_model);return r}(),r=e.get_matching_transition_view_model(o,e.schedule_id),
e.update_pricing(r),e.update_order_summary(r),e.update_billing_options(o),e.update_zip(),e.first_update_complete?void 0:(t("#total-price").trigger("payment-component-ready"),e.first_update_complete=!0)}}(this),this.transition_info_fetcher.get(i,n)},i.prototype._walk_promise_pipeline_sync=function(t){var e;return e=t.shift(),e().then(function(e){return function(){return t[0]?e._walk_promise_pipeline_sync(t):void 0}}(this))},i.prototype.log_num_licenses=function(){var t;if(this.options.log_num_licenses_entered&&(t=this._get_raw_num_users(),this._num_users_is_acceptable(t)&&(this._num_users_log_pwraps.push(function(e){return function(){return e.logger.log("minimum_license_limit",{num_users:t})}}(this)),"pending"!==this._num_users_pipeline_promise.state())))return this._num_users_pipeline_promise=this._walk_promise_pipeline_sync(this._num_users_log_pwraps)},i.prototype.on_num_licenses_changed=function(){return this.debounced_handle()},i.prototype.update_billing_options=function(e){var n,i,r,o,s,a,u,_,c,l,d,h,m;return r=t("#total-price"),c=!this._num_users_is_acceptable(this._get_raw_num_users()),r.toggleClass("disabled",c),r.find("input").filter('[data-force-disabled != "true"]').prop("disabled",c),d=this.get_matching_transition_view_model(e,this.MONTHLY_SCHEDULE_ID),_=this.get_matching_transition_view_model(e,this.ANNUAL_SCHEDULE_ID),o=t("#total-price .monthly .price"),n=t("#total-price .annual .price"),l=this.total_price(d,!1),a=this.total_price(_,!1),u=0,a&&l&&(h=12*l.amount,u=Math.round((h-a.amount)/h*100)),o.text(p("%(num_dollars)s").format({num_dollars:l?l.toString():""})),n.text(p("%(num_dollars)s").format({num_dollars:a?a.toString():""})),t(".pricing-scheme-monthly__price").text(this.user_price(d).toString()),a=this.user_price(_),a.amount/=12,t(".pricing-scheme-annual__price").text(a.toString()),i=t(".pricing-scheme-annual-discount"),m=f(u),i.text(p("%(percentage)s savings").format({percentage:m})),s=t("#total-price .savings .amount"),s.length>0?s.text(f(Math.round(u))):void 0},i.prototype.update_pricing=function(e){var n,i,r,o,s,a,u,_;for(n=new c(0,e.state.currency),a=e.read_only_invoice.line_items,r=0,o=a.length;o>r;r++)s=a[r],1===s.line_item_type&&(n=c.fromObject(s.line_item_price));if(_=c.fromObject(e.state.next_license_prices[0].price),this.discount_ratio&&(n=n.multiply(1-this.discount_ratio),_=_.multiply(1-this.discount_ratio)),u=e.state.schedule.id,t(".flat-pricing").length)if(u===this.MONTHLY_SCHEDULE_ID)i=p("%(user_price)s / user / month for additional users.");else{if(u!==this.ANNUAL_SCHEDULE_ID)return;i=p("%(user_price)s / user / year for additional users.")}else if(u===this.MONTHLY_SCHEDULE_ID)i=p("%(base_price)s base package for up to %(base_users)s users. %(user_price)s / user / month for additional users.");else{if(u!==this.ANNUAL_SCHEDULE_ID)return;i=p("%(base_price)s base package for up to %(base_users)s users. %(user_price)s / user / year for additional users.")}return t(".pricing-scheme").text(i.format({base_price:n.toString(),base_users:this.base_users.toString(),user_price:_.toString()}))},i.prototype.update_order_summary=function(e){var n,i,r,o;return o=this._get_raw_num_users(),r=parseInt(o,10)||0,n=t("#order-summary"),i=!this._num_users_is_acceptable(o)||!(t("#monthly-radio").is(":checked")||t("#annual-radio").is(":checked")),n.toggleClass("hidden",i),r=Math.min(r,this.max_additional_licenses),i?void 0:this.update_order_summary_details(n,r,e)},i.prototype.get_min_num_users_from_model=function(t){var e,n;return(null!=(e=t.state.plan.included_license_counts)&&null!=(n=e[0])?n.license_count:void 0)||0},i.prototype.should_use_unqualified_price=function(t){var e,n;return this.options.allow_unqualified_price?(n=this.get_num_users(),e=this.get_min_num_users_from_model(t),m(this._num_users_is_acceptable(n),"Cannot determine if an unqualified price should be used because the number of users passed is not acceptable"),e>n):!1},i.prototype.update_order_summary_details=function(n,i,r){var o,s,a,u,_,l,h,m,f,y,g,v,b,x,w,C,$,E,T;for(s=r.state.plan.included_license_counts[0].license_count,o=new c(0,r.state.currency),l=0,_=new c(0,r.state.currency),b=0,x=new c(0,r.state.currency),w=new c(0,r.state.currency),$=Math.max(i,this.base_users),g=p(r.state.schedule.id===this.ANNUAL_SCHEDULE_ID?"%(price)s per year":"%(price)s per month"),v=r.read_only_invoice.line_items,h=0,m=v.length;m>h;h++)f=v[h],1===f.line_item_type?o=c.fromObject(f.line_item_price):7===f.line_item_type&&(l=f.quantity,_=c.fromObject(f.line_item_price)),f.country_tax_amount&&(x=x.add(c.fromObject(f.country_tax_amount)),f.country_tax_percentage&&(b=f.country_tax_percentage)),f.state_tax_amount&&(x=x.add(c.fromObject(f.state_tax_amount)),f.state_tax_percentage&&(b=f.state_tax_percentage)),f.line_item_price&&(y=c.fromObject(f.line_item_price),u=c.fromObject(f.discounted_line_item_price),a=y.subtract(u),w=w.add(a));return C=this.total_price(r),this.should_use_unqualified_price(r)&&(o=e.clone(C),$=s=this.get_num_users()),n.find(".base .item span").text(s),n.find(".base .price span").text(g.format({price:o.toString()})),n.find(".extra .item span").text(l),n.find(".extra .price span").text(g.format({price:_.toString()})),n.find(".extra").toggleClass("hidden",0>=l),t(".discount .discount_percent").text(Math.round(100*this.discount_ratio)),n.find(".discount .amount span").text("-"+w.toString()),t(".discount").toggleClass("hidden",w.amount<=0),n.find(".total .item span").text($),n.find(".total .price span").text(g.format({price:C.toString()})),t("#expected_price").val(C.amount),n.find(".tax").toggleClass("hidden",null===x||0===x.amount),null!==x&&this.country_to_vat_rate_map[this.country]&&0===b?(E=this.get_vat_number(),E?n.find(".tax .item span").text(""):(T=this.country_to_vat_rate_map[this.country],n.find(".tax .item span.tax-rate").text(" ("+T+"%)"),n.find(".tax .item span.tax-name").text(this.get_country_tax_name(this.country))),n.find(".tax .price span").text(x.toString())):b>0&&null!==x&&(T=b,n.find(".tax .item span.tax-rate").text(" ("+T+"%)"),n.find(".tax .item span.tax-name").text(this.get_country_tax_name(this.country)),n.find(".tax .price span").text(x.toString())),d.update_payment_methods_for_total_price(C)},i}(),{DfbPricingTable:h}});var bind=function(t,e){return function(){return t.apply(e,arguments)}};define("modules/clean/payments/pro_util",["jquery","external/underscore","modules/clean/payments/cash","modules/clean/payments/validation","modules/core/exception"],function(t,e,n,i,r){var o,s,a,u;return o=n.Cash,u=r.assert,s=function(){function t(){}return t.compute_tax=function(t,e){var n,i,r,s,a,u,_,c,l;for(u=null,i=null,l=new o(0,e),c=t.line_items,r=0,s=c.length;s>r;r++)a=c[r],1===a.line_item_type?u=a:2===a.line_item_type&&(i=a),a.country_tax_amount&&(l=l.add(o.fromObject(a.country_tax_amount))),a.state_tax_amount&&(l=l.add(o.fromObject(a.state_tax_amount)));return _=null!=u?o.fromObject(u.line_item_price):new o(0,e),n=null!=i?o.fromObject(i.line_item_price):new o(0,e),[_,n,l]},t.require_recompute=function(t,e){return"US"===t&&5===e.length},t.display_tax=function(t){return"US"===t},t}(),a=function(){function n(t){var e,n,i,r;if(this.default_transition_view_models=t,this._get_transition_info_for=bind(this._get_transition_info_for,this),this._add_to_cache=bind(this._add_to_cache,this),this._has_inflight_request=bind(this._has_inflight_request,this),this.get=bind(this.get,this),this._get_state_json=bind(this._get_state_json,this),this._cache_key_from_transition=bind(this._cache_key_from_transition,this),this._requests={},this.transition_info_cache={},this.default_transition_view_models)for(i=this.default_transition_view_models,e=0,n=i.length;n>e;e++)r=i[e],this._add_to_cache(r)}return n.prototype._cache_key=function(t){return e.values(t).join(":")},n.prototype._cache_key_from_transition=function(t){var e,n,i;return e={country_code:null!=(n=t.read_only_invoice)?n.tax_country_code:void 0,zip_code:null!=(i=t.read_only_invoice)?i.tax_zip_code:void 0},this._cache_key(e)},n.prototype._get_state_json=function(){var t,e,n;return n=null!=(t=this.default_transition_view_models)&&null!=(e=t[0])?e.state:void 0,JSON.stringify(n)},n.prototype.get=function(n,i,r){var o,s,a;if(o=this._cache_key(i),s=this._get_transition_info_for(o))return void n(s);if(!this._requests[o]){if(this._has_inflight_request()&&r)for(a in this._requests)delete this._requests[a];else if(this._has_inflight_request())return;return this._requests[o]=!0,t.ajax({url:"/pro/ajax_transition_view_model",type:"POST",dataType:"json",data:e.extend({json_state:this._get_state_json()},i),success:function(t){return function(e){return t._add_to_cache(e),null!=t._requests[o]?(delete t._requests[o],n(e)):void 0}}(this),error:function(t){return function(){return null!=t._requests[o]?delete t._requests[o]:void 0}}(this)})}},n.prototype._has_inflight_request=function(){return Object.keys(this._requests).length},n.prototype._add_to_cache=function(t){var e;return e=this._cache_key_from_transition(t),this.transition_info_cache[e]=t},n.prototype._get_transition_info_for=function(t){return null!=this.transition_info_cache[t]},n}(),{TransitionInfoFetcher:a,TaxHelper:s}});var bind=function(t,e){return function(){return t.apply(e,arguments)}};define("modules/dirty/account/plan_management",["dropbox","modules/clean/dbmodal","modules/clean/dbmodal_loading","modules/clean/account/addon_modal","modules/clean/account/modal_with_buttons","modules/clean/uirequest","modules/dirty/payments/billing_info_modal"],function(t,e,n,i,r,o,s){var a,u,_,c,l,d,h,p;return c=e.DBModalStack,d=i.PurchaseAddonModal,p=i.RemoveAddonModal,a=["expiring","active","inactive"],u="add_billing_info",_="billing_info",h="resubscribe_billing_info",l=function(){function t(t,e){this.$elm=t,this.sub_state=e,this._post_request=bind(this._post_request,this),this._build_modals(),this._bind_global_events(),this.$elm.on("click",".cancel-pending-change",function(t){return function(e){return e.preventDefault(),new o($j("body"),"/clear_pending_change_ajax",{success:t._post_request})}}(this)),$j(window).trigger("hashchange")}return t.prototype.sub_state=null,t.prototype._post_request=function(){return c.pop()},t.prototype._switch_schedule=function(t,e,n){return new o($j("body"),"/change_schedule_ajax",{data:{id:t,zip_code:e,country_code:n},success:this._post_request})},t.prototype._change_to_1tb_plan=function(t,e){return new o($j("body"),"/change_to_1tb_ajax",{data:{zip_code:t,country_code:e},success:this._post_request})},t.prototype._bind_global_events=function(){return this._bind_global_event($j(document),"click",".change-payment-method-modal-link",function(){return function(t){var e;return t.preventDefault(),e=location.hash.split("#"),e.length=2,e.push(_),location.hash=e.join("#")}}(this)),this._bind_global_event($j(document),"click",".add-payment-method-modal-link",function(){return function(t){var e;return t.preventDefault(),e=location.hash.split("#"),e.length=2,e.push(u),location.hash=e.join("#")}}(this)),this._bind_global_event($j(document),s.BILLING_INFO_UPDATED,null,function(){return function(){return new o($j("body"),"/plan_management_ajax")}}(this)),this._bind_global_event($j(window),"hashchange",null,function(t){return function(){var e,n,i;return((n=location.hash.split("#")[2])===_||n===h)&&(i=location.hash.split("#")[2]===h?!0:!1,e=t._build_payment_method_modal(i),c.push(e)),location.hash.split("#")[2]===u?(e=t._build_add_payment_method_modal(),c.push(e)):void 0}}(this))},t.prototype._bind_global_event=function(t,e,n,i){var r;return r=function(o){return function(s){return o.$elm.closest("html").length?i(s):n?t.off(e,n,r):t.off(e,r)}}(this),n?t.on(e,n,r):t.on(e,r)},t.prototype._build_add_payment_method_modal=function(){var t;return t=new n({element_id:"add_billing_info",endpoint_url:"/add_billing_info_modal",parameters:{}}),t.on_hide=function(){return this.$modal_window=null,location.hash=location.hash.split("#")[1]},t},t.prototype._build_payment_method_modal=function(t){var e;return e=new n({element_id:"update_billing_info",endpoint_url:"/billing_info_modal",parameters:{resubscribe:t}}),e.on_hide=function(){return this.$modal_window=null,location.hash=location.hash.split("#")[1]},e},t.prototype._build_modals=function(){return this.modals={},this.$elm.on("click",".change-to-1tb-link",function(t){return function(e){var n;return e.preventDefault(),n=new r({element_id:"change_to_1tb",endpoint_url:"/change_to_1tb_modal"}),n.on_confirm_button_click=function(){return n.$modal_window.find(".payment-method-view").trigger("validate",function(e,n){return t._change_to_1tb_plan(e,n)})},c.push(n)}}(this)),this.$elm.on("click",".change-third-party-billing-info",function(){return function(t){var e;return t.preventDefault(),e=new n({element_id:"update_third_party_billing_info",endpoint_url:"/update_third_party_billing_info_modal"}),c.push(e)}}(this)),$j.each(this.$elm.find("li[data-addon-id]"),function(t){return function(e,n){var i,r,o,s;return i=$j(n),r=i.data("addon-id"),s=new p(r),o=new d(r),t.modals[r]={remove:s,purchase:o},t.sub_state.deactivate_time?void 0:i.on("click",function(){switch(t.sub_state.addon_state[r]){case"active":return c.push(t.modals[r].remove);case"inactive":return c.push(t.modals[r].purchase);case"expiring":return t.modals[r].purchase.purchase_or_reactivate_addon(r);default:throw new Error("Invalid addon state "+t.sub_state.addon_state[r])}})}}(this)),$j.each($j(".schedule-switch input[type='radio']"),function(t){return function(e,n){return $j(n).on("click",function(e){var i,o;return e.preventDefault(),i=t.sub_state.is_on_trial?t.sub_state.pending_sub_state.schedule.id:t.sub_state.schedule.id,parseInt(n.value,10)!==i?(o=new r({element_id:"change_schedule",endpoint_url:"/change_schedule_modal",parameters:{new_schedule_id:n.value}}),o.on_confirm_button_click=function(){return o.$modal_window.find(".payment-method-view").trigger("validate",function(e,i){return t._switch_schedule(n.value,e,i)})},c.push(o)):void 0})}}(this))},t}()});var bind=function(t,e){return function(){return t.apply(e,arguments)}},extend=function(t,e){function n(){this.constructor=t}for(var i in e)hasProp.call(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty,indexOf=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};define("modules/dirty/payments/billing_info_modal",["jquery","dropbox","modules/core/uri","modules/clean/dbmodal","modules/clean/payments/payment_form_events","modules/clean/uirequest","modules/clean/payments/cash","modules/clean/payments/pro_util","modules/clean/payments/billing_info_base"],function(t,e,n,i,r,o,s,a,u){var _,c,l,d,h,p,m,f;return p=e.Forms,h=i.DBModalStack,l=s.Cash,d=s.CashUtil,f=a.TransitionInfoFetcher,m=a.TaxHelper,c=u.BillingInfoModalBase,_=function(e){function i(e,s,a,u,_){this.$container=e,this.payment_link_map=s,this.transition_view_models=a,this.country_to_currency_map=u,this.countryToTaxNameMap=_,this._update_disclaimer=bind(this._update_disclaimer,this),i.__super__.constructor.call(this,this.$container,this.country_to_currency_map,this.transition_view_models,this.countryToTaxNameMap),this.$container.on("click",".cancel-button",function(){return h.pop()}),this.$container.on("click",".confirm-button",function(e){return function(){return e.payment_form.validate()?e.payment_form.get_form_inputs(function(r){var s,a,u,_;return _=["resubscribe"],e.$container.find("input, select").each(function(e,n){var i,o;return i=t(n),o=i.attr("name"),indexOf.call(_,o)>=0?r[o]=i.val():void 0}),u=e.payment_form.get_selected_payment_method_id(),a=e.payment_link_map[u],"extra_params"in a&&(s=a.extra_params,t.extend(r,s)),a.use_form_post?p.postRequest(n({path:a.endpoint}),r):new o(e.$container,a.endpoint,{data:r,success:function(t){return t.data.success?(h.trigger(i.BILLING_INFO_UPDATED),h.pop()):void 0}})}):void 0}}(this)),this.payment_form.$container.on(r.PAYMENT_METHOD_TYPE_CHANGE_EVENT,this._update_disclaimer),null!=this.transition_view_models&&this.updateForm()}return extend(i,e),i.BILLING_INFO_UPDATED="billing_info_modal:updated",i.prototype._update_disclaimer=function(e,n){return n=parseInt(n,10),this.$container.find(".payment-method-disclaimer").each(function(e,i){var r;return r=t(i).data("payment-method-id"),t(i).toggleClass("hidden",r!==n)})},i.prototype._getTotalAmount=function(t){return l.fromObject(t.read_only_invoice.total)},i}(c)});