define("dropbox",["modules/core/controller_registry","modules/clean/browse_interface","modules/clean/react/previews/preview_linkfile","modules/clean/base64","modules/clean/previews/file_view_rams_common","modules/core/uri","modules/clean/file_events","modules/clean/previews/preview_actions_helper","modules/clean/em_string","modules/core/exception","libs","modules/clean/uirequest","modules/clean/react/file_viewer/file_preview_update_watcher","modules/clean/history","modules/clean/sharing/shared_link_modal","external/underscore","modules/clean/ajax","modules/clean/sso_login_checks","modules/core/notify","external/swfobject","modules/clean/sharing/api","modules/clean/search/search_helpers","modules/clean/job_progress","modules/clean/pagination_manager","modules/constants/static","modules/clean/previews/pdf_loader","modules/constants/viewer","modules/clean/sharing/sharing_constants","modules/clean/sharing/get_editable_link_prompt","modules/clean/people/experiments/link_profile_service_modal","modules/clean/account/email","modules/clean/dbmodal","modules/clean/events/rollback","modules/clean/react/browse/constants","modules/clean/react/previews/preview_image_zoom","modules/clean/display_format","modules/clean/event_load","modules/clean/contacts/facebook_modal","modules/clean/contacts/facebook_oauth","modules/clean/components/role_picker","external/plupload_dev","modules/clean/react/previews/preview_video","external/keymaster","modules/clean/image_size","modules/clean/viewer","modules/constants/python","modules/clean/sprite","modules/clean/dbmodal_loading","modules/clean/undo","modules/clean/notserver","modules/clean/gandalf_util","modules/clean/multiaccount_login","modules/clean/datetime","modules/clean/video_util","modules/clean/sharing/members_list/members_list_modal","modules/clean/react/previews/preview_flippable","modules/clean/contacts/types","external/react","modules/clean/profile_services/profile_services_constants","modules/clean/loggers/file_preview_logger","modules/clean/react/activity/comment_count_bubble","modules/clean/db_bubble","modules/clean/react/previews/audio/preview_audio","external/flash_detect","external/purify","modules/clean/sharing/share_inband","modules/core/visibility","modules/dirty/react/file_viewer/controller","modules/constants/env","modules/clean/sharing/shared_folder_settings_modal","jquery","modules/core/ordered_dictionary","modules/clean/components/bubble_picker","modules/clean/groups/api","external/modernizr","modules/clean/teams/team_folder_modal","modules/clean/components/ajax_form","modules/clean/react/invite/invite_form_react","modules/clean/browse_events","modules/clean/react/modal","modules/clean/contacts/list","modules/clean/profile_services/profile_services_link","modules/core/i18n","modules/constants/request","modules/clean/top_notif","modules/core/dom","modules/clean/web_timing_logger","modules/clean/payments/credit_card_util","modules/clean/react/previews/preview_image","modules/clean/form","modules/core/cookies","modules/clean/clipboard","modules/clean/payments/cash","modules/clean/browse/browse_drag_utils","modules/clean/account/email_verify_reasons","modules/clean/previews/util","modules/clean/react/hierarchical_nav_bar","modules/clean/payments/dfb_util","modules/clean/search/search_type","external/jquery_ui","modules/clean/contacts/cache","modules/clean/frame_messenger","modules/clean/analytics","modules/clean/photos/legacy_thumb_loader","modules/core/browser","modules/clean/react/previews/preview_blank","modules/clean/filepath","modules/core/html","modules/clean/static_urls"],function(bX,fo,bI,ak,bV,H,aH,m,bU,ei,cm,by,y,eJ,aI,bx,cG,b8,ah,c8,fc,ap,A,fq,cD,ax,a9,d6,C,b,c1,dd,at,cc,dn,aF,an,ek,ew,du,q,a7,e9,ai,cQ,aX,cy,cF,Y,cV,az,bO,b6,bt,cK,N,X,dJ,c7,dt,a6,aC,k,e3,c4,dD,bc,e6,fp,ae,bF,a0,bA,aD,d,d2,ci,ab,dU,cr,o,df,bl,aK,cw,D,en,fb,cA,bb,bw,t,dY,cR,ex,eh,aY,c9,eI,eM,eu,ez,ba,bs,b1,I,aA,fm,aN){var F={};var U=bI.PreviewLinkfile;var cT=m.LegacyFilePreviewActions;var e1=m.LegacyFileViewerActions;var ca=ei.alertd;var cP=ei.assert;var eS=ei.reportException;var eT=ei.stackTrace;var bm=fc.SharingApi;var cs=fc.UserlessSharingApi;var dr=A.Job;var eH=A.ModalProgress;var cz=b.LinkProfileServiceModal;var av=c1.ChangeEmail;var ea=c1.EmailVerification;var ed=dd.DBModal;var d7=dd.DBModalStack;var ds=dd.DBUserModal;var b9=cc.FileTypes;var aW=dn.PreviewImageZoom;var d8=du.RolePickerState;var eq=a7.PreviewVideo;var aG=ai.image_best_fit_size;var bP=cV.NotServer;var ee=cV.NotClients;var cL=cK.MemberList;var eb=N.PreviewFlippable;var dc=a6.CommentCountBubbleFactory;var dV=dD.ShareInband;var dT=cr.SimpleModal;var bk=df.LinkedProfileServices;var eg=df.ProfileServicesLinkingHandler;var bd=bl.ungettext;var eG=bl._;var dP=bl.N_;var G=bl.E_;var ff=bl.render_sentences;var fd=cw.TopNotificationBar;var eV=cw.EUCookieNotificationBar;var r=cw.ExpiredIOSNotificationBar;var em=cw.PackratUnlimitedOptInNotificationBar;var cj=cw.DfBAdminEarlyAccessSharingControlsBar;var cf=cw.DfBAdminEarlyAccessFtsBar;var aR=cw.LocaleSwitchBar;var e4=cw.SuperInactiveRecoverBar;var x=cA.PreviewImage;var bj=dY.Cash;var fk=dY.CashUtil;var c5=eh.PermissionHelper;var dQ=aY.HierarchicalNavBar;var fl=c9.DfBTransitionInfoFetcher;var cO=eu.ContactsCache;var b0=eu.DefaultContactsCache;var eo,fa,dj;INLINE_JS.$=$;INLINE_JS.$u=bx;Function.prototype.defer=Function.prototype.defer.wrap(function(j){var i;i=$A(arguments).slice(1);this.__tb__=eT();return j.apply(this,i)});String.prototype.evalScripts=String.prototype.evalScripts.wrap(function(T){var j,fr,i;j=$A(arguments).slice(1);try{return T.apply(this,j)}catch(i){fr=i;return cP(0,fr.toString())}});eo=F.Jcached={cache:{},set:function(j,T,i){var fr;fr=eo.cache[j];if(fr==null){fr=eo.cache[j]={}}fr.value=T;return fr.expires=i?new Date().getTime()+i:0},get:function(i){var j;j=eo.cache[i];if((j==null)||new Date().getTime()>j.expires){delete eo.cache[i];return false}return j.value}};Function.prototype.cached=function(i){var T,j;j=Math.random();T=this;return function(){var fr;fr=eo.get(j);if(fr!==false){return fr}fr=T();eo.set(j,fr,i);return fr}};Array.prototype.sort_by_key=function(j,T){var i;if(T==null){T=false}i=T?-1:1;return this.sort(function(fr,fs){fr=j(fr);fs=j(fs);if(fr<fs){return i*-1}else{if(fr>fs){return i*1}else{return 0}}})};Array.prototype.contains=function(i){return this.indexOf(i)!==-1};Array.prototype.remove=function(j,i){i=i||j+1;return this.splice(j,i-j)};Array.prototype.removeItem=function(j){var i;i=this.indexOf(j);if(i>=0){return this.remove(i)}else{return false}};Array.prototype.dict_by=function(fr){var fu,fv,ft,T,fs;fs={};for(fu=ft=0,T=this.length;ft<T;fu=++ft){fv=this[fu];fs[this[fu][fr]]=this[fu]}return fs};Array.prototype.unique=function(){var ft,fs,T,i,fr;ft={};for(T=0,i=this.length;T<i;T++){fs=this[T];if(typeof fs!=="string"){return this}ft[fs]=0}fr=[];for(fs in ft){fr.push(fs)}return fr};String.prototype.widthSplit=function(fr){var i,T,j,fs;if(fr==null){fr=15}i=[];T=this;fs=0;j=T.substring(fs,fs+fr);while(j!==""){i.push(j);fs+=fr;j=T.substring(fs,fs+fr)}return i};Object.extend(Effect.Transitions,{EaseIn:function(i){return Math.pow(i,2)},EaseOut:function(i){return Math.pow(i,0.5)}});(function(T){var i,j;j=function(fw){var fr,fz,ft,fs,fv,fu,fy,fx,fA;if(fw){if(Object.isArray(fw)){fr=[];for(ft=0,fv=fw.length;ft<fv;ft++){fz=fw[ft];fr.push(fm.escape(fz).toHTML())}fw=new fm(fr.join(""))}else{if(fw.top||fw.bottom||fw.before||fw.after){fx=["top","bottom","before","after"];for(fs=0,fu=fx.length;fs<fu;fs++){fy=fx[fs];fA=fw[fy];if(fA){fw[fy]=arguments.callee(fA)}}}else{if(ec.isElm(fw)||fw.toElement||fw.toHTML){}else{fw=fm.escape(fw)}}}}return fw};return Element.addMethods({db_observe:function(fs,fr,ft){return fs.observe(fr,function(fu){return ft(fu,fs)})},smoothScrollIntoView:function(fu,ft){var fy,fs,fr,fx,fw,fv;if(ft==null){ft={}}fy={duration:0.3,offset:0,padding:0,transition:Effect.Transitions.EaseOut};ft=Object.extend(fy,ft);fr=fu.viewportOffset(fu);fs=fu.getDimensions();fv=document.viewport.getDimensions();fw=ft.padding||0;if(fr.top>fw&&(fr.top+fs.height)<(fv.height-fw)){return}fx=fr.top<fw?-1*Math.floor(fv.height/4):-1*Math.floor(3*fv.height/4);ft.offset=ft.offset||fx;return new Effect.ScrollTo(fu,ft)},__sert:function(fr,fs){return Element.insert(fr,j(fs))},__date:function(fr,fs){return Element.update(fr,j(fs))},replace:i=function(fr,fs){return T(fr,j(fs))}})})(Element.replace);fa=function(i){if(i!=null?i.target:void 0){try{return document.activeElement=i.target===document?null:i.target}catch(j){}}};dj=function(i){try{return document.activeElement=null}catch(j){}};if(document.addEventListener){document.addEventListener("focus",fa,true);document.addEventListener("blur",dj,true)}if(!String.prototype.trim){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}}String.prototype.lpad=function(j,i){var T;if(i==null){i="0"}T=this;while(T.length<j){T=i+T}return T.toString()};String.prototype.reverse=function(){var T,j,i;i=this.split("");j=i.reverse();T=j.join("");return T};String.prototype.count=function(i){return(this.length-this.gsub(i,"").length)/i.length};String.prototype.repeat=function(i){return(new Array(i+1)).join(this)};String.prototype.title=function(){return this.charAt(0).toUpperCase()+this.substr(1)};Ajax.DBRequest=Class.create(Ajax.Request,{initialize:function($super,ft,fr){var fA,fy,fD,fC,fF,fE,fv,T,i,fB,fw,fs,fu,fz,fx;if(fr==null){fr={}}this.orig_req={url:ft,options:fr};this.start_time=b6.time();fr.method=fr.method||"post";fr.evalJS=false;fr.suppress_nonstandard_headers=true;fr.parameters=fr.parameters||{};fr.parameters.t=bw.read(aK.JS_CSRF_COOKIE);fr.parameters.is_xhr=true;if(fr.method.toLowerCase()==="post"||Constants.CPROFILE_ENABLED){fr.parameters.parent_request_id=Constants.REQUEST_ID}if(Constants.CPROFILE_ENABLED){fr.parameters.cProfile=Constants.CPROFILE_PARAMETER}if(Constants.PUBLIC_MODE_OVERRIDE){fr.parameters.public_mode_override="1"}if(Constants.COUNTRY_OVERRIDE){fr.parameters.public_mode_override=Constants.COUNTRY_OVERRIDE}if(Constants.GANDALF_PANEL&&ft.indexOf("/")===0){fr.parameters.gandalf_panel=1}if(Ajax.DBRequest.restrict){fr.parameters.restrict=Ajax.DBRequest.restrict}fy=fr.cleanUp||(function(){});this.subject_user=fr.subject_user||fr.job_user;if(fr.job){this.job_id=ec.nonce();fr.parameters.job_id=this.job_id;ej.watch(this,fr.dont_hide_progress_on_complete)}if(!fr.no_watch){ar.watch(this,!!fr.job)}fB=fr.onFailure;fw=fr.onSuccess;i=fr.onComplete;T=(function(j){return function(fH){var fG,fI;if(fr.parameters.xhr_retry||!fr.allow_retries){return false}if((fG=fH.status)===0||fG===500||fG===502||fG===503){j.orig_req.options.parameters.xhr_retry=true;j.orig_req.options.onFailure=fB;j.orig_req.options.onSuccess=fw;fI=new Ajax.DBRequest(j.orig_req.url,j.orig_req.options);return true}return false}})(this);fr.onFailure=function(fH){var fI,fG,j;if(dr.handled(fH.request.job_id)){return}if(T(fH)){return}if(!fr.noAutonotify){if(!Constants.IS_PROD&&fH.status===500&&fH.getHeader("X-Debug-Url")){ft=fH.getHeader("X-Debug-Url");fI=eG("There was a problem completing this request.")+(' <a href="'+ft+'" target="_blank">View debug</a>');ah.error(new fm(fI))}else{ah.error()}}fy(false);if(fB){fB(fH)}if(fH.status===403){j=ec.session_storage_get("reload-timestamp");if(!j||b6.time()-j>30*1000){ec.session_storage_set("reload-timestamp",b6.time());location.reload(true)}}return cP(fr.noAutonotify||((fG=fH.status)===403||fG===404||fG===502),"Ajax "+fH.status+" on "+fH.request.url)};fr.onComplete=(function(j){return function(fG){if(fG.responseText.length&&i){if(fG.responseText.indexOf("async_task_started:")!==0){return i(fG)}}}})(this);fr.onSuccess=(function(j){return function(fG){var fH,fQ,fW,fY,fP,fU,fV,fJ,fS,fI,fK,fO,fR,fM,fT,fX,fN,fL;fL=b6.time()-fG.request.start_time;if(dr.handled(fG.request.job_id)){return}if(!fG.responseText.length){if(!fr.job){if(T(fG)){return}if(!fr.noAutonotify){if(!fG||fG.status!==0){ah.error()}}if(fB){fB(fG)}}}else{if(fG.responseText.indexOf("err:")===0){if(!fr.noAutonotify){fJ=fG.responseText.substr(4);if(fr.html_in_error_msg){fJ=new fm(fJ)}ah.error(fJ)}if(fB){fB(fG)}}else{if(fG.responseText.indexOf("async_task_started:")===0){j.async_task_id=fG.responseText.split(":")[1];ej.watch(j)}else{if(fw){if(fG.responseText.indexOf("ok:")===0){ah.success(fG.responseText.substr(3))}fw(fG)}}fN=fG.getHeader("X-Server-Response-Time")||"-1";if(fr.log_timing){en.log_ajax_transition.defer(fL,void 0,void 0,void 0,fN,ft=be.absolutize(j.url))}fQ=bF("#cprofile");if(!fr.no_watch&&fQ.length){fM=Constants.REQUEST_ID+"-"+(fG.getHeader("X-Dropbox-Request-Id"));ft=fG.request.url.replace(/[^\/]*\/\/[^\/]+/,"").replace(/\?.*$/,"");fI={request_id:fM};fR=fG.request.url;if(fR.indexOf(Constants.BLOCK_CLUSTER)!==-1){fI.block=1}else{fK=Constants.BATCH_THUMB_ENDPOINTS;for(fU=0,fV=fK.length;fU<fV;fU++){fP=fK[fU];if(fR.indexOf(fP)!==-1){fI.block=1;break}}}fH=function(f4,f2,f1,f3){var f0,fZ;if(f3){f0=bF('<a target="_blank" />')}else{f0=bF("<a />")}fZ=f0.attr("href",String(H({authority:Constants.WEBSERVER,path:f2,query:f1}))).text(f4+" ");return fZ};fS=[["svg","/profile/cprofile/svg",true],["pstats","/profile/cprofile/pstats",false],["callgrind","/profile/cprofile/callgrind",false],["IO","/profile/ioprofile",true],["DB","/profile/dbprofile",true]];fX=(function(){var fZ,f0,f1;f1=[];for(fZ=0,f0=fS.length;fZ<f0;fZ++){fW=fS[fZ];f1.push(fH(fW[0],fW[1],fI,fW[2]))}return f1})();fT=bF('<div class="ajax">').text("Ajax: "+ft+" ("+fN+"ms)").prepend(fX);fY=fQ.find(".ajax");if(fY.length>=10){fY.last().remove()}fQ.prepend(fT)}if(bF("#gandalf_panel").length&&fG.request.url.substring(0,14)!=="/gandalf_panel"){if((fO=window.gandalf_panel)!=null){fO.add(fG.request.url,fG.getHeader("X-Dropbox-Request-Id"))}}}}return fy(true)}})(this);fr.onException=function(fG,fH){var fI,j;if(window.console){throw fH}fI=("Error with AJAX callback for: "+ft+" :::: ")+fH.toString();j=eT();j.pop();return eS(fI,b1.get_href(),"",j.join("\n"))};if(fr.job){ft+=(ft.indexOf("?")===-1?"?":"&")+"long_running=1"}if(fr.subject_user&&!((fu=fr.parameters)!=null?fu[a9.UID_PARAM_NAME]:void 0)){ft=H.parse(ft).updateQuery(a9.UID_PARAM_NAME,fr.subject_user).toString()}fA=$H({url:ft});if(fr.parameters){fA.update(fr.parameters);fz=fA.keys();for(fD=0,fE=fz.length;fD<fE;fD++){fF=fz[fD];fx=["passwd","password","oauth","ccn","host_id"];for(fC=0,fv=fx.length;fC<fv;fC++){fs=fx[fC];if(fF.indexOf(fs)!==-1){fA.unset(fF)}}}fA.unset("t")}fr.onSuccess.__tb_ajax_info__=fr.onFailure.__tb_ajax_info__=Object.toJSON(fA);return $super(ft,fr)}});if(typeof key!=="undefined"&&key!==null){Object.extend(key,{main_modifier:function(){if(ec.is_mac()){return decodeURIComponent("%E2%8C%98")}else{return"ctrl"}}})}Object.extend(Prototype.BrowserFeatures,{DB_CORS:window.XMLHttpRequest&&("withCredentials" in new XMLHttpRequest())});var cH=[].slice;if(!window.$j){window.$j=window.jQuery}INLINE_JS.$j=bF;if(!Function.prototype.bind){Function.prototype.bind=function(i){var fs,fr,j,T;if(typeof monkey_check==="function"){monkey_check()}if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")}fs=Array.prototype.slice.call(arguments,1);T=this;j=function(){};fr=function(){return T.apply((this instanceof j&&i?this:i),fs.concat(Array.prototype.slice.call(arguments)))};j.prototype=this.prototype;fr.prototype=new j();return fr}}jQuery.fn.curry=function(){var i,T,j;T=arguments[0],j=arguments[1],i=3<=arguments.length?cH.call(arguments,2):[];if(j==null){j=window}if(typeof monkey_check==="function"){monkey_check()}return function(){var fr;fr=1<=arguments.length?cH.call(arguments,0):[];return T.apply(j,cH.call(i).concat(cH.call(fr)))}};jQuery.fn.stripTags=function(i){if(typeof monkey_check==="function"){monkey_check()}return i.replace(/<\w+(\s+("[^"]*"|'[^']*'|[^>])+)?>|<\/\w+>/gi,"")};jQuery.fn.hasScrollBar=function(){if(typeof monkey_check==="function"){monkey_check()}return this.get(0).scrollHeight>this.height()};jQuery.fn.viewportOffset=function(){if(typeof monkey_check==="function"){monkey_check()}return D.viewport_offset(this)};jQuery.fn.visible=function(){if(typeof monkey_check==="function"){monkey_check()}return jQuery(this).is(":visible")};jQuery.fn.clonePosition=function(j,i){if(typeof monkey_check==="function"){monkey_check()}D.clone_position(this,j,i);return this};jQuery.format=function(j,i){if(typeof monkey_check==="function"){monkey_check()}return j.replace(/\{([^}]+)\}/g,function(fr,T){if(T in i){return i[T]}else{return fr}})};jQuery.cachedScript=function(j,i){if(typeof monkey_check==="function"){monkey_check()}i=bF.extend(i||{},{dataType:"script",cache:true,url:j});return jQuery.ajax(i)};jQuery.browser=b1;jQuery.addSubjectParam=function(T,i){var j;if(typeof monkey_check==="function"){monkey_check()}if(T.subject_user&&!((j=T.data)!=null?j[a9.UID_PARAM_NAME]:void 0)){return i[a9.UID_PARAM_NAME]=String(T.subject_user)}};jQuery.ajaxPrefilter(function(i,fr,T){var j;if(!fr.noDropboxDefaults){j={t:bw.read(aK.JS_CSRF_COOKIE),is_xhr:true};jQuery.addSubjectParam(fr,j);if(jQuery.ajaxSettings.restrict!=null){j.restrict=jQuery.ajaxSettings.restrict}i.data=bF.param(bF.extend(fr.data,j),true);return false}});jQuery.ajax.retryOnce=function(fr,i,j){var T;if(typeof monkey_check==="function"){monkey_check()}if(i!=="abort"&&((T=fr.status)===0||T===500||T===502||T===503)&&!this.xhr_retry){this.xhr_retry=true;return jQuery.ajax(this)}};var eO,dp,be,ec,dH;ec=INLINE_JS.Util=F.Util={scroll_to_thumb:function(i){var fs,fr,T,j;fr=i.cumulativeOffset().top;fs=i.getHeight();j=D.scroll_offsets().top;T=D.viewport_dimensions().height;if(fr<j||fr+fs>j+T){return D.scroll_to(0,fr-T/2)}},decode_sort_key:function(T){var ft,fr,i,fs;fs=[];for(fr=0,i=T.length;fr<i;fr++){ft=T[fr];if(typeof ft==="string"){fs.push(ak.decode(ft))}else{fs.push(ft)}}return fs},sort_by_rank_or_key:function(i,j){if((i.sort_rank!=null)&&(j.sort_rank!=null)){return i.sort_rank-j.sort_rank}cP((i.sort_key!=null)&&(j.sort_key!=null),"expected sort keys on both elms");return this._sort_by_key(i,j)},sort_by_key:function(i,j){return this._sort_by_key(i,j)},_sort_by_key:function(fr,fw){var fu,ft,fv,T,fs;T=fr.sort_key;fs=fw.sort_key;for(fu=ft=0,fv=T.length;0<=fv?ft<fv:ft>fv;fu=0<=fv?++ft:--ft){if(fs[fu]==null){return 1}if(typeof T[fu]!==typeof fs[fu]){if(typeof T[fu]==="string"){return 1}else{return -1}}else{if(T[fu]!==fs[fu]){if(T[fu]>fs[fu]){return 1}else{return -1}}}}if(fs.length>T.length){return -1}else{return 0}},add_sort_arrow_mouseover:function(i,ft,fs,T){var fu,fw,fx,fr,fv;fr=$$(fs);fv=[];for(fu=0,fw=fr.length;fu<fw;fu++){fx=fr[fu];fv.push((function(j){var fy;if(i!==j){cy.src(j.down("img"),"web","downtick-spacer");return j.removeClassName("bolded")}else{j.addClassName("bolded");if(j.hasClassName("noarrow")){return}fy=ft?"arrow-up-gray":"arrow-down-gray";return cy.src(j.down("img"),"web",fy)}})(fx))}return fv},add_sort_arrow_mouseover_j:function(i,ft,fs,T){var fu,fw,fx,fr,fv;fr=bF(fs);fv=[];for(fu=0,fw=fr.length;fu<fw;fu++){fx=fr[fu];fv.push((function(j){var fy;if(i.attr("data-sort")!==bF(j).attr("data-sort")){cy.src(bF(j).find("img")[0],"web","downtick-spacer");return bF(j).removeClass("bolded")}else{bF(j).addClass("bolded");if(bF(j).hasClass("noarrow")){return}fy=ft?"arrow-up-gray":"arrow-down-gray";return cy.src(bF(j).find("img")[0],"web",fy)}})(fx))}return fv},one_line_fit:function(i){var T,j;T=$$(i);if(T.length<2){return}j=(function(fr){return function(){var fA,fy,fw,ft,fu,fz,fv,fx,fs;fw=T[0];fz=T[T.length-1];ft=fw.cumulativeOffset().top;fv=fz.cumulativeOffset().top;if(ft!==fv){fA=parseInt(fw.getStyle("font-size"),10);fs=fA-1;if(fs<8){return}for(fu=0,fx=T.length;fu<fx;fu++){fy=T[fu];fy.style.fontSize=fs+"px"}return j()}}})(this);return j()},nice_list:function(j){var ft,fs,fr,i,T;if(!j){return""}else{if(j.length===1){return j[0]}else{if(j.length===2){return eG("%(x)s and %(y)s").format({x:j[0],y:j[1]})}}}T=eG("%(x)s, %(y)s, and %(z)s").split(/%\(x\)s|%\(y\)s|%\(z\)s/);cP(T.length===4,"bad item list format %(x)s, %(y)s, and %(z)s");fs=T[0];fr=T[1];i=T[2];ft=T[3];return[fs,j.slice(0,-1).join(fr),i,j[j.length-1],ft].join("")},list_em_snippet:function(fr,T){var fx,fu,ft,fs,fw,fv;fs="";T-=new bU("...").length;for(fu=ft=0,fw=fr.length;0<=fw?ft<fw:ft>fw;fu=0<=fw?++ft:--ft){fv=fr[fu];if(fu!==0){fv=", "+fv}fx=new bU(fv).length;if(fx>T){break}T-=fx;fs+=fv}return{str:fs,snipped:fr.length-fu}},start_of_day:function(i){var j;j=new Date();j.setTime(i.getTime());j.setHours(0);j.setMinutes(0);j.setSeconds(0);j.setMilliseconds(0);return j},to_iso8601_date:function(fr,j,T){var i;if(j==null){j=false}if(T==null){T=false}if(j){i=fr.getUTCFullYear().toString()+"-"+(fr.getUTCMonth()+1).toString().lpad(2)+"-"+fr.getUTCDate().toString().lpad(2);if(T){i+=" "+fr.getUTCHours().toString().lpad(2)+":"+fr.getUTCMinutes().toString().lpad(2)+":"+fr.getUTCSeconds().toString().lpad(2)}}else{i=fr.getFullYear().toString()+"-"+(fr.getMonth()+1).toString().lpad(2)+"-"+fr.getDate().toString().lpad(2);if(T){i+=" "+fr.getHours().toString().lpad(2)+":"+fr.getMinutes().toString().lpad(2)+":"+fr.getSeconds().toString().lpad(2)}}return i},to_mysql_date:function(fs,i,T){var j,ft,fr;j=fs.getFullYear().toString()+"-"+(fs.getMonth()+1).toString().lpad(2)+"-"+fs.getDate().toString().lpad(2);fr=fs.getHours().toString().lpad(2)+":"+fs.getMinutes().toString().lpad(2)+":"+fs.getSeconds().toString().lpad(2);ft="."+fs.getMilliseconds().toString().lpad(3);if(!i){return j}if(!T){return j+" "+fr}return j+" "+fr+ft},from_mysql_date:function(j){var fr,ft,T,fv,i,fu,fs;fv=j.split(" ");fr=fv[0];fu=fv.length>1?fv[1]:false;ft=fr.split("-");cP(ft.length===3,"weird date format on "+this+", expected yyyy-mm-dd");T=new Date(ft[0],parseInt(ft[1],10)-1,ft[2]);if(fu){fs=fu.split(":");cP(fs.length===3,"weird time format on "+this+", expected hh:mm:ss.ms");T.setHours(fs[0]);T.setMinutes(fs[1]);i=fs[2].split(".");T.setSeconds(i[0]);if(i.length>1){T.setMilliseconds(i[1])}}return T},make_table:function(i,fv){var T,fu,fw,j,fs,fr,ft;fw=new Element("table",fv);j=new Element("tbody");fw.__sert(j);for(fu in i){ft=i[fu];fr=new Element("tr");fs=new Element("td").insert(fu);T=new Element("td").insert(ft);fr.__sert(fs);fr.__sert(T);j.__sert(fr)}return fw},validate_email:function(i){var j;j=new RegExp("^['&A-Z0-9._%+-]+@[A-Z0-9-][A-Z0-9.-]*\\.[A-Z]{2,15}$","i");return j.test(i)},scrollTop:function(){return window.scrollY||document.documentElement.scrollTop||0},scrollLeft:function(){return window.scrollX||document.documentElement.scrollLeft||0},scried:{},scry:function(T){var j,i;i=this.scried;j=i[T];if(!j){j=$(T);i[T]=j}return j},urlquote:function(i){return i.split("/").map(encodeURIComponent).join("/")},ie8:Prototype.Browser.IE&&document.documentMode&&true,ie:Prototype.Browser.IE,log:function(){var j,i;if(!Constants.IS_PROD){if(Prototype.Browser.IE){return(j=$("ieconsole"))!=null?j.innerHTML+=$A(arguments).join(" ")+"<br>":void 0}else{return typeof console!=="undefined"&&console!==null?(i=console.log)!=null?i.apply(console,$A(arguments)):void 0:void 0}}},childElement:function(T,j){var i;i=this.childElementWithIndex(T,j);return i[0]},childElementWithIndex:function(fx,ft){var fv,fw,fu,fs,T,fr;fv=0;fr=fx.childNodes;for(fu=fs=0,T=fr.length;fs<T;fu=++fs){fw=fr[fu];if(fw.nodeType===1&&fv++===ft){return[fw,fu]}}return[false,false]},disableSelection:function(i){i.onselectstart=function(){return false};i.unselectable="on";i.style.MozUserSelect="none";return i.style.cursor="default"},enableSelection:function(i){i.onselectstart=function(){return true};i.unselectable="off";i.style.MozUserSelect="";return i.style.cursor=""},disable_ie_image_dragging:function(){if(Prototype.Browser.IE&&Prototype.Browser.IEV<9){return document.ondragstart=function(){return false}}},bsearch:function(i,fv,ft,fs){var T,fr,j,fu;if(!ft){ft=function(fw,fx){return fw-fx}}T=i.length;fr=0;while(T>fr){j=Math.floor(T/2+fr/2);fu=ft(i[j],fv);if(fu>0){T=j}else{if(fu<0){fr=j+1}else{return j}}}if(fs){return fr}else{return -1}},nonce:function(){var T,i,j;T=new Date();j=T.getTime().toString();i=Math.floor(Math.random()*1000000).toString().lpad(6);return j+i},focus:function(j){if(j){j=$(j);try{return j.focus()}catch(i){}}},sumStyles:function(ft,fu){var T,fr,fs,i;fr=0;if(ft){for(fs=0,i=fu.length;fs<i;fs++){T=fu[fs];fr+=parseInt(ft.getStyle(T),10)||0}}return fr},async_load_script:function(j){var i;i=function(){var fr,T;T=document.createElement("script");T.src=j;T.type="text/javascript";T.async=true;fr=document.getElementsByTagName("script")[0];return fr.parentNode.insertBefore(T,fr)};if(document.readyState==="complete"){return i()}else{if(window.attachEvent!=null){return window.attachEvent("onload",i)}else{return window.addEventListener("load",i,false)}}},smart_window_load:function(i){if(document.readyState==="complete"){return i.defer()}else{return Event.observe(window,"load",i)}},isNumber:function(i){return !isNaN(Number(i,10))},shorten_url:function(i,j){return new Ajax.DBRequest("/shorten_url",{parameters:{url:i},onSuccess:function(T){return j(T.responseText)}})},falsy_to_empty:function(i){return i||""},preloaded_images:{},preload_image:function(fr,T,j){var i;if(this.preloaded_images[fr]){return}i=new Image();if(T!=null){Element.extend(i).observe("error",T)}if(j!=null){Element.extend(i).observe("load",j)}i.src=fr;return this.preloaded_images[fr]=i},get_preloaded_image:function(i){if(this.preloaded_images[i]){return this.preloaded_images[i].clone()}else{return new Element("img",{src:i})}},clear_selected:function(){var i;if(window.getSelection){i=window.getSelection();if(i.removeAllRanges){return i.removeAllRanges()}}else{if(document.selection){return document.selection.empty()}}},is_mac:function(){return navigator.appVersion.indexOf("Mac")!==-1},is_windows:function(){return navigator.appVersion.indexOf("Windows")!==-1},in_scrollbar:function(i){var T,j;T=20;j=D.viewport_dimensions();return i>j.width-T},freshbutton_overlay:function(j,i){var fr,T;T=j instanceof jQuery&&j||bF(j);fr=i instanceof jQuery&&i||bF(i);T.on("mouseover",(function(fs){return function(){return fr.addClass("hovered")}})(this));T.on("mouseout",(function(fs){return function(){fr.removeClass("hovered");return fr.removeClass("pressed")}})(this));T.on("mousedown",(function(fs){return function(){fr.removeClass("hovered");return fr.addClass("pressed")}})(this));return T.on("mouseup",(function(fs){return function(){return fr.removeClass("pressed")}})(this))},isElm:function(i){if(typeof HTMLElement==="object"){return i instanceof HTMLElement}else{return i&&typeof i==="object"&&i.nodeType===1&&typeof i.nodeName==="string"}},_track_twitter_chars_left:function(j,T){var i;clearInterval(this.chars_left_interval);i=(function(fr){return function(){var fs,ft;fs=$("twitter-chars");ft=T-$F(j).strip().length;if(ft<0){fs.addClassName("too-long")}else{fs.removeClassName("too-long")}return fs.__date(ft)}})(this);return this.chars_left_interval=setInterval(i,250)},session_storage_set:function(i,j){if(!window.sessionStorage||!window.JSON){return}return window.sessionStorage.setItem(i,JSON.stringify(j))},session_storage_get:function(i){if(window.sessionStorage&&window.JSON){return JSON.parse(window.sessionStorage.getItem(i))}},pdf_plugins:function(){var T,j,i;i=/Chrome PDF|Adobe Reader|Adobe PDF|Acrobat/gi;return T=(function(){var fs,fr,fu,ft;fu=window.navigator.plugins;ft=[];for(fs=0,fr=fu.length;fs<fr;fs++){j=fu[fs];if(i.test(j.name)){ft.push(j)}}return ft})()},get_window_location:function(){return window.location}};ec.scrollLeft=ec.scrollLeft.cached(50);ec.scrollTop=ec.scrollTop.cached(50);if(window.console==null){window.console={log:function(){},profile:function(){},profileEnd:function(){}}}document.observe("script:loaded",function(){var T,i,ft,fs,fr;if(ec.ie8){fs=$$("#page-header a, #page-footer a");fr=[];for(T=0,i=fs.length;T<i;T++){ft=fs[T];if(ft.target==="_blank"){fr.push(ft.target="")}else{fr.push(void 0)}}return fr}});dp=__CONDITIONAL_JS__.Trace=F.Trace=(function(){var i;i=[];return{log:function(){var j;j=b6.time()+": "+$A(arguments).join(" ");return i.push(j)},get:function(){return i.join("\n")}}})();eO=F.T=function(){return dp.log.apply(this,$A(arguments))};document.observe("script:loaded",function(){return eO("dom:loaded")});Event.observe(window,"load",function(){return eO("window:load")});be=F.URLUtil={absolutize:function(i){if(i.startsWith("https://")||i.startsWith("http://")){return i}else{if(i.charAt(0)==="/"){return window.location.protocol+"//"+window.location.host+i}else{return cP(0,"absolutize is confused by "+i)}}}};dH=F.Velocity={scroll_container:null,velocity:0,last_nonzero_velocity:0,old_y:0,max_delta_y:0,calculate_velocity:function(){this.velocity=this.max_delta_y;if(this.velocity!==0){this.last_nonzero_velocity=this.velocity}return this.max_delta_y=0},capture_new_y_pos:function(){var i,j;if(this.old_y==null){this.old_y=this.scroll_container!=null?this.scroll_container.scrollTop:D.scroll_offsets().top;return}if(this.max_delta_y==null){this.max_delta_y=0;return}j=this.scroll_container!=null?this.scroll_container.scrollTop:D.scroll_offsets().top;i=Math.abs(this.max_delta_y)<Math.abs(j-this.old_y);if(i){this.max_delta_y=j-this.old_y;return this.old_y=j}},start_capture:function(i){this.scroll_container=i;this.velocity_calculator_interval=setInterval(this.calculate_velocity.bind(this,500));if(this.scroll_container!=null){return this.scroll_container.observe("scroll",this.capture_new_y_pos.bind(this))}else{return Event.observe(window,"scroll",this.capture_new_y_pos.bind(this))}},get:function(i){if(i==null){i=false}cP(this.velocity_calculator_interval!=null,"Haven't started capturing velocity");if(i){return this.last_nonzero_velocity}return this.velocity}};var dB;dB=F.DomUtil={fromElm:function(i){return $(i).innerHTML},updateFromElm:function(j,i){j=$(j);i=$(i);return j.update(this.fromElm(i))},fillVal:function(fw,fu){var ft,T,fv,fr,fs,j;fv=$$("."+fu);fs=[];for(ft=0,T=fv.length;ft<T;ft++){j=fv[ft];j=$(j);if(j.tagName==="INPUT"){j.value=fw;fs.push(j.defaultValue=fw)}else{if(j.innerHTML===""&&((fr=j.tagName)==="A"||fr==="B"||fr==="INPUT"||fr==="I"||fr==="LABEL"||fr==="SELECT"||fr==="SPAN"||fr==="TEXTAREA")){ec.log("Filling an empty value; this may look broken in IE7",j)}fs.push(j.innerHTML=fw)}}return fs}};var ar;ar=F.RequestWatcher={reqs:[],working_msg:eG("Still working...",{comment:"Comment about waiting for a process to complete"}),last_notification:null,TIMEOUT:10,watch:function(j,T){var i;i=this.reqs;if(!i.length){this.int_id=setInterval(this.check_up.bind(this),500)}if(T){j.skip_message=true}return i.push([j,b6.time()])},check_up:function(){return this.scan(false)},remove:function(i){return this.scan(i)},scan:function(fu){var fy,ft,fv,T,fs,j,fr,fx,fw;T=b6.time();fs=[];fr=this.reqs;for(ft=0,fv=fr.length;ft<fv;ft++){j=fr[ft];fx=j[0];fw=j[1];fy=T-fw;if(fx.transport.readyState===4){this.clearWorkingMessage();continue}if(fy>4000&&!fx.skip_message){fx.skip_message=true;if(ah.isShown()&&ah.current()===!Y.undo_notification){this.last_notification=ah.success(this.working_msg)}}if(fy>this.TIMEOUT*1000&&fx.job){fx.transport.abort()}if(fx!==fu){fs.push([fx,fw])}else{fx.transport.abort()}}this.reqs=fs;if(!fs.length){return clearInterval(this.int_id)}},clearWorkingMessage:function(){if(ah.isShown()&&ah.current()===this.last_notification){return ah.clear()}}};bF(function(){var j,i,fr,T;fr=Prototype.Browser;T=[];for(j in fr){i=fr[j];if(i===true){T.push(bF(document.body).addClass(j.toLowerCase()))}}return T});var dS,a3,cH=[].slice;dS=F.HTML5_HISTORY=Modernizr.history;bF((function(i){return function(){return eJ.init()}})(this));a3=F.HashRouter={watch_timer:null,callback_map:{},last_hash:"",last_prefix:"",_get_location:function(){return window.location.href},_set_location:function(i){return window.location.href=i},_replace_location:function(i){return window.location.replace(i)},init:function(){return this.watch_timer=setInterval(this.check_hash.bind(this),300)},watch:function(i,j){this.callback_map[i]=j;if(!this.watch_timer){return this.init()}},check_hash:function(){var j,T,fr,ft,fs,i;ft=this._get_location().split("#")[1];if(ft!=null){ft=ft.replace(/%27/g,"'")}if(this.last_hash===ft){return}this.last_hash=ft;if(this.last_prefix&&ft===""){ft=this.last_prefix+":"}else{if(!ft){return}}i=ft.split(":");fs=i.first();this.last_prefix=fs;fr=this.callback_map[fs];if(fr!=null){T=(function(){var fw,fu,fx,fv;fx=i.slice(1);fv=[];for(fw=0,fu=fx.length;fw<fu;fw++){j=fx[fw];fv.push(decodeURIComponent(j))}return fv})();fr.apply(null,T)}return $(document).fire("db:hash_change",{hash:ft})},_prepare_hash:function(T){var j,i;i=$A(T).map(ec.falsy_to_empty);j=i.map(encodeURIComponent);return j.join(":")},set_hash:function(){var i,j;i=1<=arguments.length?cH.call(arguments,0):[];j=this._prepare_hash(i);return this._set_hash(j)},replace_hash:function(){var i,j;i=1<=arguments.length?cH.call(arguments,0):[];j=this._prepare_hash(i);return this._set_hash(j,true)},_set_hash:function(j,i){if(j===""){j="/"}this.last_hash=j;if(!i){return this._set_location("#"+j)}else{return this._replace_location("#"+j)}}};var aZ;aZ=F.SharingUtil=(function(){function i(){}i.success_string_for_recipients=function(j){var T;if(j.length===1){if(j[0].indexOf("@")===-1){T=eG("Sent to %(recipient)s.",{comment:"Recipient is a user's name"}).format({recipient:j[0]})}else{T=eG("Sent to %(recipient)s.",{comment:"Recipient is an email address"}).format({recipient:j[0]})}}else{if(j.length===2){if(j[0].indexOf("@")===-1){if(j[1].indexOf("@")===-1){T=eG("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"Recipients are users' names."}).format({recipient_first:j[0],recipient_second:j[1]})}else{T=eG("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"First recipient is a user's name, second is an email address"}).format({recipient_first:j[0],recipient_second:j[1]})}}else{if(j[1].indexOf("@")===-1){T=eG("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"First recipient is an email address, second is a user's name"}).format({recipient_first:j[0],recipient_second:j[1]})}else{T=eG("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"Recipients are email addresses"}).format({recipient_first:j[0],recipient_second:j[1]})}}}else{if(j[0].indexOf("@")===-1){T=eG("Sent to %(recipient)s and %(num_others)s others.",{comment:"num_others is 2 or more"}).format({recipient:j[0],num_others:j.length-1})}else{T=eG("Sent to %(recipient)s and %(num_others)s others.",{comment:"num_others is 2 or more"}).format({recipient:j[0],num_others:j.length-1})}}}return T};return i})();var s;s=INLINE_JS.SharingModals=F.SharingModals=(function(){function i(){}i.show_shared_folder_options_modal=function(fs,j,T,fr){if(T==null){T=true}if(fr==null){fr=true}return d7.push(new dl(j,fs,T,fr))};i.show_share_inband_modal=function(fr,T,j,fs){return eL.createAndShowInbandModal(T,fr,true,j,true,false,fs)};i.show_shared_folder_wizard=function(j){return new ev(j,{element_id:"share-a-folder-wizard-modal"}).show()};i.get_select_role_modal=function(){return new cM({element_id:"select-role-modal"})};i.start_wizard_without_user=function(){if(cQ.get_viewer().is_paired){if(this.select_role_modal==null){this.select_role_modal=i.get_select_role_modal()}return this.select_role_modal.show()}else{return this.start_wizard_for_user(cQ.get_viewer().get_users()[0])}};i.start_wizard_for_user=function(j){if(ea.get_for_user(j).verified_or_show(ex.SHARE_FOLDER)){return i.show_shared_folder_wizard(j)}};i.show_share_existing_modal=function(fr,j){var T;if(ea.get_for_user(j).verified_or_show()){T=new cq(j,{folder_name:fr,element_id:"invite-to-new-sf-wizard-modal-"+j.id});return T.show()}};i.show_shmodel_or_invite_modal=function(T,fs,j,fr){if(ea.get_for_user(j).verified_or_show()){return new d4(j,{path:T,existing_sf:fs,element_id:"create-link-or-invite-wizard-modal",target_item:fr}).show()}};i.show_unshare_team_sf_modal=function(T,j,fs){var fr;fr=new b5(T,{element_id:"unshare-confirm-modal",team_shared_folder:true,nested_shared_folder:false,ns_id:j,folder_path:fs});return fr.show()};i.show_ignore_modal=function(fr,T,j){var ft,fs,fu;cP(j,"Share ignore did not get an ns_id");fu=eG("Permanently remove '%(folder_name)s'").format({folder_name:bU.em_snippet(T,15)});ft={ns_id:j};fs=new ds(fr,{element_id:"ignore-confirm",title:fu});fs.on_confirm_button_click=function(fx){var fw,fv,fy;fx.preventDefault();fw=bF(fx.target);fv=fw.closest("form");fy=function(fz){ah.success(eG("Removed shared folder successfully."));document.fire(aH.SF_IGNORE,{target_ns_id:j,user_id:fr.id});return fs.hide()};return bT.ajax_submit(fv[0],false,fy,void 0,fw[0],ft)};return fs.show()};i.show_rejoin_modal=function(fr,T,j){var ft,fs,fu;cP(j,"Rejoin didn't get an ns_id");fu=eG("Rejoin the shared folder '%(folder_name)s'?").format({folder_name:bU.em_snippet(T,13)});ft={ns_id:j};fs=new ds(fr,{element_id:"rejoin-confirm",title:fu});fs.on_confirm_button_click=function(fx){var fw,fv,fy;fx.preventDefault();fw=bF(fx.target);fv=fw.closest("form");fy=function(fA){var fz;fz=fA.responseText;T=aA.filename(fz);ah.success(eG("Rejoined shared folder successfully."));document.fire(aH.SF_REJOIN,{target_ns_id:j,user_id:fr.id,filename:T,mount_point:fz});return fs.hide()};return bT.ajax_submit(fv[0],false,fy,void 0,fw[0],ft)};return fs.show()};i.show_invites=function(){return d7.push(new cF({element_id:"invitation-page-modal",endpoint_url:"/share_ajax/get_invitation_page"}))};i.show_shared_subfolder_modal=function(T,fs){var fv,ft,fu,j,fr;fu=bU.em_snippet(aA.filename(T),14);ft=eG("Can't share folder");j="'%(parent_shared_folder)s' ".format({parent_shared_folder:fu});dB.fillVal(j.escapeHTML(),"parent_shared_folder_name");fv=eG("Share '%(parent_shared_folder)s' folder");fr=fv.format({parent_shared_folder:fu});($("share_parent_folder_button")).value=fr;fh.show(eG("Loading shared folder options..."),"<p style='margin: 3em 0; text-align: center;'> <img src='/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif' alt=''/></p>");bF("#share_parent_folder_button").on("click",(function(fw){return function(fx){fh.hide();return fw.show_shared_folder_options_modal(T,fs)}})(this));return fh.show(ft,$("share_subfolder"))};return i})();var dk;dk=F.InviteFormController=(function(){function i(fs,fr,T,j,fw,fv){var fu,ft;this.user=fs;this.$form=fr;this.members=T;this.invitees=j;this.new_style_groups=fw;this.team_only=this.$form.data("team-only");ft={tokens:[",",";"],include_fb:true,members:this.members,invitees:this.invitees,new_style_groups:this.new_style_groups,contacts_only:true};if(this.user.role==="work"){fu=Autocompleter.TeamTokenizer;ft.team_only=this.team_only}else{fu=Autocompleter.ContactsTokenizer;ft.include_team=true}if(this.user.role==="work"&&(typeof aD!=="undefined"&&aD!==null)){ft.include_new_style_groups=true}this.sharing_options_auto_completer=new fu(this.user,fv+"-new-collab-input",fv+"-new-whobulk",fv+"-hidden-input",ft);ck._create(this.$form.find(".custom-message-container")[0]);if(this.user.role==="work"){this.team_shared_folder_controller=new h(this.$form)}}i.prototype.listen=function(){return this.sharing_options_auto_completer.listen()};i.prototype.reset_autocompleter=function(){return this.sharing_options_auto_completer.clearTokens()};i.prototype.tokenize=function(){return this.sharing_options_auto_completer.tokenize_emails_input(true)};i.prototype.reset_options=function(){return bF(this.sharing_options_auto_completer.get_entry_container()).hide()};i.prototype.set_team_only=function(j){this.team_only=j;return this.sharing_options_auto_completer.setTeamOnly(j)};i.prototype.get_token_count=function(){return this.sharing_options_auto_completer.getTokenCount()};i.prototype.extract_invitees=function(){var fu,fr,fs,T,fv,j,ft;fv={};ft=["emails","fb_ids","group_ids","new_style_group_ids"];for(fs=0,j=ft.length;fs<j;fs++){fr=ft[fs];T=this.$form.find("input[name="+fr+"]");fv[fr]=[(function(){var fx,fw,fy;fy=[];for(fx=0,fw=T.length;fx<fw;fx++){fu=T[fx];fy.push(bF(fu).val())}return fy})()]}return fv};i.prototype.get_custom_message=function(){return this.$form.find("textarea[name='custom_message']").val()};i.prototype.get_access_type=function(){return this.$form.find(".can-edit-dropdown").data("selected-value")};return i})();var aP,dl,S,eC,bv,fj,db,dI,aV,eX,dC,cx,dX,bM,aJ,b5,fi=function(fr,j){for(var i in j){if(dq.call(j,i)){fr[i]=j[i]}}function T(){this.constructor=fr}T.prototype=j.prototype;fr.prototype=new T();fr.__super__=j.prototype;return fr},dq={}.hasOwnProperty,b3=function(i,j){return function(){return i.apply(j,arguments)}};dX=F.SharedFolderBaseModal=(function(i){fi(j,i);function j(fr,T){this.user=fr;this.options=T;j.__super__.constructor.call(this,this.options);this.team_shared_folder=this.options.team_shared_folder;this.nested_shared_folder=this.options.nested_shared_folder;this.path=this.options.folder_path;this.ns_id=this.options.ns_id;this.sharing_api=new bm(this.user)}j.prototype.on_show=function(){return this.sharing_api.loading_elem=this.$modal_window};return j})(ed);dl=F.ExistingSharedFolderOptionsModal=(function(j){fi(i,j);function i(fw,fs,fr,ft,T){var fv,fu;this.user=fw;if(fr==null){fr=true}if(ft==null){ft=true}this.restore_modal=T;this.__show_modal=b3(this.__show_modal,this);this.__x_click_handler=b3(this.__x_click_handler,this);cP(fs!=null,"Missing folder path");this.path=aA.normalize(fs);fu=eG("Shared folder options for '%(folder)s'");fu=fu.format({folder:bU.em_snippet(aA.filename(fs),13)});fv={};fv[a9.UID_PARAM_NAME]=this.user.id;fv.max_results=20;fv.show_invite_form=fr;fv.show_folder_settings=ft;d7.register(aP.MODAL_DONE_VIEWING_EVENT,(function(fx){return function(){return typeof fx.restore_modal==="function"?fx.restore_modal():void 0}})(this));i.__super__.constructor.call(this,{element_id:"folder-share-show-modal",title:fu,endpoint_url:H({path:"/share_options"+this.path}).toString(),parameters:fv})}i.prototype.__x_click_handler=function(fr){var T;i.__super__.__x_click_handler.apply(this,arguments);T={path:this.path};ba.SharedFolderActivityLogger.log("web","invite_modal_x_button",this.user,T);return typeof this.restore_modal==="function"?this.restore_modal():void 0};i.prototype.__show_modal=function(fv){var fr,fu,ft,fs,T;i.__super__.__show_modal.apply(this,arguments);fr=cu.containing_fq_path();T=fr!==this.path&&fr.indexOf(this.path)===0;if(T&&this.$modal_window.find("#banner-msg-sf-setting").length===0){ft=eG("You\u2019re viewing settings for the shared folder \u2018<strong>%(sf_name)s</strong>\u2019.").format({sf_name:aA.filename(this.path).escapeHTML()});fs=bF("<div id='banner-msg-sf-setting'> <t> "+ft+" </t> </div>");fs.addClass("db-modal__banner db-modal__banner--warning");this.$modal_window.find(".db-modal-box").append(fs)}fu={path:this.path};return ba.SharedFolderActivityLogger.log("web","invite_modal_displayed",this.user,fu)};return i})(cF);aP=F.ExistingSharedFolderOptionsContent=(function(){i.CONTENT_LOADED_EVENT="db:sharing_options:content_loaded";i.MODAL_DONE_VIEWING_EVENT="db:sharing_options:modal_done_viewing_event";function i(ft,fr,fs,fu,j,T){this.$root=ft;this.options=fu;this.show_invite_form=j;this.allows_editor_manage_membership=T;this.show_email_verification=b3(this.show_email_verification,this);this.show_golden_gate_warning=b3(this.show_golden_gate_warning,this);this.show_folder_settings=b3(this.show_folder_settings,this);this.show_m2_folder_settings=b3(this.show_m2_folder_settings,this);this.toggle_from_invite_mode=b3(this.toggle_from_invite_mode,this);this.toggle_to_invite_mode=b3(this.toggle_to_invite_mode,this);this.toggle_get_link_button_visibility=b3(this.toggle_get_link_button_visibility,this);this.show_leave_folder_modal=b3(this.show_leave_folder_modal,this);this.show_owner_leave_folder_warning=b3(this.show_owner_leave_folder_warning,this);this.show_access_request_link_modal=b3(this.show_access_request_link_modal,this);this.show_unshare_folder_modal=b3(this.show_unshare_folder_modal,this);this.show_uninvite_modal=b3(this.show_uninvite_modal,this);this.show_transfer_user_modal=b3(this.show_transfer_user_modal,this);this.show_kick_group_modal=b3(this.show_kick_group_modal,this);this.show_kick_user_modal=b3(this.show_kick_user_modal,this);this.update_tf_access=b3(this.update_tf_access,this);this.update_sf_perms=b3(this.update_sf_perms,this);this.reinvite_user=b3(this.reinvite_user,this);this.submit_invitations=b3(this.submit_invitations,this);this.maybe_load_more=b3(this.maybe_load_more,this);this.extract_user_data_and_call=b3(this.extract_user_data_and_call,this);this.extract_invitee_data_and_call=b3(this.extract_invitee_data_and_call,this);this.create_m2_inband_modal=b3(this.create_m2_inband_modal,this);this._disable_token_for_sf=b3(this._disable_token_for_sf,this);this.user=cQ.get_viewer().get_user_by_id(fr);this.path=aA.normalize(fs);if(this.options){this.members=this.options.folder_members;this.invitees=this.options.folder_invitees;this.new_style_groups=this.options.new_style_groups;this.num_total=this.options.num_total}this.$root.find(".bubble-dropdown").click(function(fv){D.controller(bF(fv.target).closest(".sf-action-dropdown")).closeDropdown();return true});this.start=20;this.max_results=20;this.$root.find(".member-container").on("scroll",(function(fv){return function(fy){var fx,fw;fx=bF(fy.currentTarget);fw=fx.find("#sf-members");if(fx.scrollTop()+fx.innerHeight()>=fw.innerHeight()){return fv.maybe_load_more()}}})(this));this.sharing_api=new bm(this.user);this.sharing_api.loading_elem=this.$root;bf.register_all();da.register_all();this.ns_id=this.$root.data("ns-id");this.$invite_form=this.$root.find(".invite-more-form");this.sf_access_type=this.$invite_form.find(".sf-invite-can-edit");this.team_shared_folder=this.$root.data("team-shared-folder");this.nested_shared_folder=this.$root.data("nested-shared-folder");this.$allow_members_table=this.$root.find(".allow-members-table");this.$folder_management_buttons=this.$root.find(".folder-management-buttons");if(this.$root.find(".get-editable-link").length>0){C.showInstance(dJ.createElement(C,{onDismiss:eL.dismissM2Prompt,shouldShow:cu.simple_sharing_show_m2_prompt,targetedButton:this.$root.find(".get-editable-link").get(0)}));ba.SimpleSharingLogger.log(this.user.id,29)}this.has_show_invite_form=false;this.log_extras={path:this.path,ns_id:this.ns_id};this.sf_access_type.hide();this.listen();d7.trigger(i.CONTENT_LOADED_EVENT)}i.prototype.listen=function(){var fr,T,fs,j,ft;this.$root.find(".confirm-button").click((function(fu){return function(fv){fv.preventDefault();return fu.submit_invitations()}})(this));this.$root.find(".cancel-button").click((function(fu){return function(fv){fv.preventDefault();return fu.toggle_from_invite_mode()}})(this));if(this.show_invite_form){this.get_link_button=this.$root.find(".get-editable-link-invite");this.$invite_input=this.$root.find("#sharing-options-new-collab-input");ft=["focus","keypress","contextmenu"];for(fs=0,j=ft.length;fs<j;fs++){T=ft[fs];this.$invite_input.off(T);this.$invite_input.on(T,this.toggle_to_invite_mode)}this.$invite_input.keyup(this.toggle_get_link_button_visibility);if(this.$invite_input[0]){this.$invite_input[0].on("token:remove",this.toggle_get_link_button_visibility);this.$invite_input[0].on("token:add",this.toggle_get_link_button_visibility)}fr=this.$root.find("#custom-message-wizard");fr.on("focus",this.toggle_to_invite_mode);this.$root.find(".change-m2-settings-link").on("click",this.show_m2_folder_settings);this.$root.find(".invite-verify-email").on("click",this.show_email_verification);this.$root.find(".golden-gate-upgrade-link").on("click",this.show_golden_gate_warning);if(this.$invite_form.length&&!this.team_shared_folder){this.invite_form_controller=new dk(this.user,this.$invite_form,this.members,this.invitees,this.new_style_groups,"sharing-options")}}this.$root.find(".change-settings-link").on("click",this.show_folder_settings);this.$root.on("click","a.leave-folder",(function(fu){return function(fv){fv.preventDefault();ba.SharedFolderActivityLogger.log("web","invite_modal_leave_button",fu.user,fu.log_extras);return fu.show_leave_folder_modal()}})(this));this.$root.on("click",".get-editable-link",(function(fu){return function(fw){var fv;bF(document).trigger("collab:m2:prompt:dismiss");return fu.create_m2_inband_modal(fw,fv=false)}})(this));this.$root.on("click",".get-editable-link-invite",(function(fu){return function(fw){var fv;bF(document).trigger("collab:m2:prompt:dismiss");return fu.create_m2_inband_modal(fw,fv=true)}})(this));this.$root.on("click","a.owner-leave-folder",(function(fu){return function(fv){fv.preventDefault();ba.SharedFolderActivityLogger.log("web","invite_modal_owner_leave_button",fu.user,fu.log_extras);return fu.show_owner_leave_folder_warning()}})(this));this.$root.on("click","a.kick-user",(function(fu){return function(fv){return fu.extract_user_data_and_call(fv,fu.show_kick_user_modal)}})(this));this.$root.on("click","a.kick-group",(function(fu){return function(fx){var fv,fw,fy;fx.preventDefault();fv=bF(fx.currentTarget);fy=fv.data("group-name");fw=fv.data("group-gid");return fu.show_kick_group_modal(fy,fw)}})(this));this.$root.on("click","a.make-owner",(function(fu){return function(fv){return fu.extract_user_data_and_call(fv,fu.show_transfer_user_modal)}})(this));this.$root.on("click","a.send-email",(function(fu){return function(fw){var fv,fx;fw.preventDefault();fv=bF(fw.currentTarget);fx=fv.data("email");return window.location=H({scheme:"mailto",path:fx}).toString()}})(this));this.$root.on("click","a.reinvite-user",(function(fu){return function(fv){return fu.extract_invitee_data_and_call(fv,fu.reinvite_user)}})(this));this.$root.on("click","a.uninvite-user",(function(fu){return function(fv){return fu.extract_invitee_data_and_call(fv,fu.show_uninvite_modal)}})(this));this.$root.on("click","input.sf-action-leave",(function(fu){return function(fv){fv.preventDefault();ba.SharedFolderActivityLogger.log("web","invite_modal_leave_button",fu.user,fu.log_extras);return fu.show_leave_folder_modal()}})(this));this.$root.on("click","input.sf-action-unshare",(function(fu){return function(fv){fv.preventDefault();ba.SharedFolderActivityLogger.log("web","invite_modal_unshare_button",fu.user,fu.log_extras);return fu.show_unshare_folder_modal()}})(this));this.$root.on("click","a.unshare_folder_link",(function(fu){return function(fv){fv.preventDefault();ba.SharedFolderActivityLogger.log("web","invite_modal_unshare_button",fu.user,fu.log_extras);return fu.show_unshare_folder_modal()}})(this));this.$root.on("click","input.simple-sharing-remove-link",(function(fu){return function(fv){fv.preventDefault();return fu._disable_token_for_sf(function(){return d7.pop()})}})(this));this.$root.on("click","a.remove-link",(function(fu){return function(fv){var fw;fv.preventDefault();fw=function(){var fx;fx=ed.get_containing_modal(fu.$root);if(fx&&fx instanceof cF){return fx.fetch()}};return fu._disable_token_for_sf(fw)}})(this));this.$root.on("click","input.sf-action-get-link",(function(fu){return function(fv){fv.preventDefault();return fu.show_access_request_link_modal()}})(this));this.$root.on("click","input.sf-action-done",(function(fu){return function(fv){fv.preventDefault();ba.SharedFolderActivityLogger.log("web","invite_modal_done_button",fu.user,fu.log_extras);d7.trigger(i.MODAL_DONE_VIEWING_EVENT);return d7.pop()}})(this));this.$root.on("click","input#change-sf-perm-checkbox",(function(fu){return function(fw){var fv;fv=bF(fw.currentTarget);return fu.update_sf_perms(fv.prop("checked"))}})(this));return this.$root.on("click","input#change-tf-access-checkbox",(function(fu){return function(fw){var fv;fv=bF(fw.currentTarget);return fu.update_tf_access(!fv.prop("checked"))}})(this))};i.prototype._disable_token_for_sf=function(j){return cG.WebRequest({url:H({path:"/sm/disable_token_at_path"+aA.normalize(this.path)}),subject_user:this.user.id,type:"POST",success:(function(T){return function(){bF(document).trigger(dU.UPDATE);ah.success(eG("Link removed"));ba.SimpleSharingLogger.log(T.user.id,25);return typeof j==="function"?j():void 0}})(this),error:(function(T){return function(){return ah.error(eG("An error occurred when removing link"))}})(this)})};i.prototype.create_m2_inband_modal=function(T,j){T.preventDefault();d7.pop();if(j){ba.SimpleSharingLogger.log(this.user.id,32)}else{ba.SimpleSharingLogger.log(this.user.id,30)}return eL.createAndShowM2InbandModal(this.user,this.path)};i.prototype.extract_invitee_data_and_call=function(fs,fr){var j,ft,T;fs.preventDefault();j=bF(fs.currentTarget);T=j.data("email-or-fbname");ft=j.data("invite-id");return fr(T,this.ns_id,ft)};i.prototype.extract_user_data_and_call=function(fu,ft){var T,fs,fr,j;fu.preventDefault();T=bF(fu.currentTarget);fr=T.data("display-name");fs=T.data("email");j=T.data("user-id");return ft(fr,fs,j)};i.prototype.maybe_load_more=function(){var T,j,fr;j=this.$root.closest("body").length;if(!j){return}if((this.num_total==null)||(this.start>=this.num_total)){bF("#more-members-spinner").hide();return}bF("#more-members-spinner").show();fr={};fr[a9.UID_PARAM_NAME]=this.user.id;fr.start=this.start;fr.max_results=this.max_results;T=H({path:"/share_options"+this.path}).toString();this.$root.removeClass("ajax-loading");new by(this.$root,T,{data:fr,success:(function(fs){return function(fw,ft,fx){var fv,fu;if(((fu=fw.data)!=null?fu.options:void 0)!=null){fv=fw.data.options;if((fs.members!=null)&&(fv.folder_members!=null)){Array.prototype.push.apply(fs.members,fv.folder_members)}if((fs.invitees!=null)&&(fv.folder_invitees!=null)){Array.prototype.push.apply(fs.invitees,fv.folder_invitees)}if((fs.new_style_groups!=null)&&(fv.new_style_groups!=null)){return Array.prototype.push.apply(fs.new_style_groups,fv.new_style_groups)}}}})(this),error:(function(fs){return function(fv,ft,fu){return ah.error("Unable to load all members of this folder.")}})(this)});return this.start=this.start+this.max_results};i.prototype.submit_invitations=function(){var fs,fr,fu,T,ft,j;this.invite_form_controller.tokenize();fu=this.invite_form_controller.extract_invitees();ft=this.invite_form_controller.get_custom_message();fs=this.invite_form_controller.get_access_type();T=bx.clone(this.log_extras);T.access_type=fs;ba.SharedFolderActivityLogger.log("web","invite_modal_send_invites_button",this.user,T);j=(function(fv){return function(fx){var fw;fw=ed.get_containing_modal(fv.$root);if(fw&&fw instanceof cF){fw.fetch()}else{d7.pop()}ah.success(fx.responseText);return document.fire(aH.SF_INVITE,{target_ns_id:fv.ns_id,user_id:fv.user.id})}})(this);fr=(function(fv){return function(fw){return eQ.show_validation_error(fw,fv.$root.find(".tokenized_autocompleter_container"))}})(this);return this.sharing_api.invite_more_to_folder(this.ns_id,fu,ft,fs,j,fr)};i.prototype.reinvite_user=function(fr,j,T){return this.sharing_api.reinvite_user(j,T,(function(fs){return function(fz){var fw,fx,fy,fv,ft,fu;fv=JSON.parse(fz.responseText);ft=fv.status;if(ft==="OK"){fu=eG("%(email_or_fbname)s was reinvited successfully");fu=fu.format({email_or_fbname:fr});return ah.success(fu)}else{fy=fv.reason;if(fy==="ACCEPTED"){fw=eG("That invitation has already been accepted.")}else{if(fy==="DECLINED"){fw=eG("That invitation has already been declined.")}else{fw=eG("You no longer have permission to perform this action.")}}ah.error(fw);if(fv.reload){fx=ed.get_containing_modal(fs.$root);if(fx&&fx instanceof cF){return fx.fetch()}}}}})(this))};i.prototype.update_sf_perms=function(T){var fr,fs,j;this.$root.find("#change-sf-perm-saving").show();fr=(T?1:0);j=(function(ft){return function(fu){if(T){ah.success(eG("Editors can now manage membership of this folder."))}else{ah.success(eG("Editors can no longer manage membership of this folder."))}return ft.$root.find("#change-sf-perm-saving").hide()}})(this);fs=(function(ft){return function(fu){if(fu.responseText.indexOf("err:")===0){ah.error(fu.responseText.substr(4))}else{ah.error(eG("Error updating your preference! Please try again."))}return ft.$root.find("#change-sf-perm-saving").hide()}})(this);return this.sharing_api.update_sf_permissions(this.ns_id,fr,j,fs)};i.prototype.update_tf_access=function(T){var fr,j;j=(function(fs){return function(ft){if(T){return ah.success(eG("Team members can now change folder contents."))}else{return ah.success(eG("Team members can no longer change folder contents."))}}})(this);fr=(function(fs){return function(ft){return ah.error(eG("Error updating your preference! Please try again."))}})(this);return this.sharing_api.update_team_folder_access_type(this.ns_id,T,j,fr)};i.prototype.show_kick_user_modal=function(fr,T,j){return d7.push(new eX(this.user,{element_id:"kick-confirm-modal",ns_id:this.ns_id,user_name:fr,folder_path:this.path,user_id:j}))};i.prototype.show_kick_group_modal=function(j,T){return d7.push(new aV(this.user,{element_id:"kick-group-confirm-modal",ns_id:this.ns_id,group_name:j,folder_path:this.path,group_id:T}))};i.prototype.show_transfer_user_modal=function(fr,T,j){return d7.push(new bM(this.user,{element_id:"transfer-confirm-modal",user_id:j,user_name:fr,ns_id:this.ns_id,folder_path:this.path}))};i.prototype.show_uninvite_modal=function(fr,j,T){return d7.push(new aJ(this.user,{element_id:"uninvite-confirm-modal",email_or_fbname:fr,ns_id:j,invite_id:T,folder_path:this.path}))};i.prototype.show_unshare_folder_modal=function(){return d7.push(new b5(this.user,{element_id:"unshare-confirm-modal",team_shared_folder:this.team_shared_folder,nested_shared_folder:this.nested_shared_folder,ns_id:this.ns_id,folder_path:this.path}))};i.prototype.show_access_request_link_modal=function(){return d7.push(new dm(this.user.id,this.path,void 0,true))};i.prototype.show_owner_leave_folder_warning=function(){return ah.error(eG("You can't leave this folder because you're the owner. You must transfer ownership to another member before you can leave."))};i.prototype.show_leave_folder_modal=function(){return d7.push(new dC(this.user,{element_id:"leave-confirm-modal",team_shared_folder:this.team_shared_folder,ns_id:this.ns_id,folder_path:this.path}))};i.prototype.toggle_get_link_button_visibility=function(){var fu,ft,fs,fr,T,j;ft=((fs=this.invite_form_controller)!=null?fs.get_token_count():void 0)===0;fu=((fr=this.$invite_input)!=null?fr.val():void 0)==="";if(ft&&fu){return(T=this.get_link_button)!=null?T.show():void 0}else{return(j=this.get_link_button)!=null?j.hide():void 0}};i.prototype.toggle_to_invite_mode=function(){var j;this.$allow_members_table.show();this.$folder_management_buttons.hide();this.$invite_form.removeClass("collapsed");if((j=this.sf_access_type)!=null){j.show()}this.toggle_get_link_button_visibility();if(!this.has_show_invite_form&&this.get_link_button.length>0){ba.SimpleSharingLogger.log(this.user.id,31)}this.has_show_invite_form=true;return bF(document).trigger("collab:m2:prompt:hide")};i.prototype.toggle_from_invite_mode=function(){var T,j;this.$allow_members_table.hide();this.$folder_management_buttons.show();this.$invite_form.addClass("collapsed");if((T=this.sf_access_type)!=null){T.hide()}if((j=this.invite_form_controller)!=null){j.reset_autocompleter()}return this.toggle_get_link_button_visibility()};i.prototype.show_m2_folder_settings=function(T){var fr,j;j=this.path;fr=function(){var fs;fs=new dl(cu.active_user,j);return fs.show()};d7.pop();return ae.showInstance(dJ.createElement(ae,{user:this.user,fq_path:this.path,is_shared_folder:true,ns_id:this.ns_id,initial_allows_editor_manage_membership:this.allows_editor_manage_membership,done_callback:fr}))};i.prototype.show_folder_settings=function(j){ba.SharedFolderActivityLogger.log("web","invite_modal_change_settings",this.user,this.log_extras);j.preventDefault();d7.register(eC.SAVED_PERMISSIONS,(function(T){return function(fs,fr){if(fr!=null){return T.set_team_only(fr)}}})(this));return d7.push(new eC(this.user,this.path,this.ns_id))};i.prototype.show_golden_gate_warning=function(j){j.preventDefault();return d7.push(new db(this.user,this.ns_id,{element_id:"golden-gate-warning-modal",ns_id:this.ns_id}))};i.prototype.show_email_verification=function(j){d7.pop();return ea.get_for_user(this.user).show()};i.prototype.set_team_only=function(j){var T;if(this.invite_form_controller==null){return}this.invite_form_controller.set_team_only(j);T=this.$invite_form.add(this.$root.find(".external-invite-message,.member-info .folder-settings"));if(j){return T.addClass("team-only")}else{return T.removeClass("team-only")}};return i})();dC=F.LeaveFolderModal=(function(i){fi(j,i);function j(){this.before_show=b3(this.before_show,this);this.on_show=b3(this.on_show,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);return j.__super__.constructor.apply(this,arguments)}j.prototype.on_confirm_button_click=function(fr){var T;fr.preventDefault();T=this.$modal_window.find("#keep_files").prop("checked");return this.sharing_api.leave_folder(this.ns_id,T,(function(fs){return function(){var ft;ft=eG("You removed yourself from '%(msg)s'.").format({msg:bU.em_snippet(aA.filename(fs.path),25)});ah.success(ft);document.fire(aH.SF_LEAVE,{target_ns_id:fs.ns_id,folder_deleted:!T,user_id:fs.user.id});return d7.clear()}})(this))};j.prototype.on_show=function(){j.__super__.on_show.apply(this,arguments);if(this.team_shared_folder){this.$modal_window.find(".keep_files_option").hide();return this.$modal_window.find(".keep_files_option").find("input").prop("checked",false)}else{this.$modal_window.find(".keep_files_option").show();return this.$modal_window.find(".keep_files_option").find("input").prop("checked",true)}};j.prototype.before_show=function(){var T;T=eG("Leave the shared folder '%(folder_name)s'");T=T.format({folder_name:bU.em_snippet(aA.filename(this.path),14)});return this.format({".db-modal-title-text":T})};return j})(dX);b5=F.UnshareFolderModal=(function(j){fi(i,j);function i(){this.before_show=b3(this.before_show,this);this.on_show=b3(this.on_show,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);return i.__super__.constructor.apply(this,arguments)}i.prototype.on_confirm_button_click=function(fr){var T;fr.preventDefault();T=this.$modal_window.find("#keep_files").prop("checked");return this.sharing_api.unshare_folder(this.ns_id,T,(function(fs){return function(){var ft;ft=eG("Unshared folder '%(folder_name)s'");ft=ft.format({folder_name:bU.em_snippet(aA.filename(fs.path),25)});ah.success(ft);document.fire(aH.SF_UNSHARE,{target_ns_id:fs.ns_id,user_id:fs.user.id});return d7.clear()}})(this))};i.prototype.on_show=function(){i.__super__.on_show.apply(this,arguments);this.$modal_window.find(".tsf_unshare_desc").hide();this.$modal_window.find(".nestedsf_unshare_desc").hide();this.$modal_window.find(".regular_unshare_desc").hide();if(this.team_shared_folder){return this.$modal_window.find(".tsf_unshare_desc").show()}else{if(this.nested_shared_folder){return this.$modal_window.find(".nestedsf_unshare_desc").show()}else{return this.$modal_window.find(".regular_unshare_desc").show()}}};i.prototype.before_show=function(){var T;if(this.nested_shared_folder){T=eG("Reset membership for '%(folder_name)s'")}else{T=eG("Unshare '%(folder_name)s'")}T=T.format({folder_name:bU.em_snippet(aA.filename(this.path),21)});return this.format({".db-modal-title-text":T})};return i})(dX);aJ=F.UninviteModal=(function(j){fi(i,j);function i(T,fr){this.before_show=b3(this.before_show,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);this.email_or_fbname=fr.email_or_fbname;this.ns_id=fr.ns_id;this.invite_id=fr.invite_id;i.__super__.constructor.call(this,T,fr)}i.prototype.on_confirm_button_click=function(T){T.preventDefault();return this.sharing_api.cancel_invite(this.ns_id,this.invite_id,(function(fr){return function(fx){var fv,fw,fu,fs,ft;fu=JSON.parse(fx.responseText);fs=fu.status;if(fs==="OK"){ft=eG("%(email_or_fbname)s has been uninvited.").format({email_or_fbname:fr.email_or_fbname});ah.success(ft)}else{fw=fu.reason;if(fw==="ACCEPTED"){fv=eG("That invitation has already been accepted.")}else{if(fw==="DECLINED"){fv=eG("That invitation has already been declined.")}}ah.error(fv)}return d7.pop()}})(this))};i.prototype.before_show=function(T){var fr;fr=eG("Uninvite %(email_or_fbname)s?").format({email_or_fbname:bU.em_snippet(this.email_or_fbname,20)});return this.format({".uninvite-confirm-nickname":this.email_or_fbname,".uninvite-confirm-folder-name":aA.filename(this.path),".db-modal-title-text":fr})};return i})(dX);eX=F.KickUserModal=(function(i){fi(j,i);function j(fr,T){this.user=fr;this.options=T;this.before_show=b3(this.before_show,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);this.user_id=this.options.user_id;this.user_name=this.options.user_name;j.__super__.constructor.call(this,this.user,this.options)}j.prototype.on_confirm_button_click=function(fs){var T,fr;fs.preventDefault();T=this.$modal_window.find("#keep-files-check").prop("checked");this.sharing_api.kick(this.ns_id,this.user_id,T,(function(ft){return function(){ah.success(eG("User removed successfully."));bZ.reload_folder_info_if_two_account();return d7.pop()}})(this));fr={ns_id:this.ns_id,kick_user_id:this.user_id,keep_files:T};return ba.SharedFolderActivityLogger.log("web","invite_modal_kick_collaborator",this.user,fr)};j.prototype.before_show=function(T){var fr;fr=eG("Remove %(person_name)s from this folder?");fr=fr.format({person_name:this.user_name});return this.format({".kick-confirm-nickname":this.user_name,".db-modal-title-text":fr})};return j})(dX);aV=F.KickGroupModal=(function(i){fi(j,i);function j(fr,T){this.user=fr;this.options=T;this.before_show=b3(this.before_show,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);this.group_id=this.options.group_id;this.group_name=this.options.group_name;j.__super__.constructor.call(this,this.user,this.options)}j.prototype.on_confirm_button_click=function(T){T.preventDefault();return aD.remove_namespace_from_group({group_id:this.group_id,ns_id:this.ns_id},function(){ah.success(eG("Group removed successfully."));bZ.reload_folder_info_if_two_account();return d7.pop()})};j.prototype.before_show=function(){var T;T=eG("Remove %(group_name)s from this folder?");T=T.format({group_name:this.group_name});return this.format({".kick-confirm-nickname":this.group_name,".db-modal-title-text":T})};return j})(dX);cx=F.MakeOwnerModal=(function(j){fi(i,j);function i(fr,T){this.user=fr;this.options=T;this.before_show=b3(this.before_show,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);this.member_uid=this.options.member_uid;this.member_name=this.options.member_name;this.ns_id=this.options.ns_id;this.access_type=this.options.access_type;i.__super__.constructor.call(this,this.user,this.options)}i.prototype.on_confirm_button_click=function(T){T.preventDefault();return this.sharing_api.update_member_access_type(this.ns_id,this.member_uid,this.access_type,(function(fr){return function(){ah.success(eG("%(name)s now is the owner.").format({name:fr.member_name}));return d7.pop()}})(this))};i.prototype.before_show=function(){var T;T=eG("Make %(name)s the owner of this folder?");T=T.format({name:bU.em_snippet(this.member_name,14)});return this.format({".make-owner-confirm-nickname":this.member_name,".db-modal-title-text":T})};return i})(dX);bM=F.TransferOwnershipModal=(function(j){fi(i,j);function i(fr,T){this.user=fr;this.options=T;this.before_show=b3(this.before_show,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);this.user_id=this.options.user_id;this.user_name=this.options.user_name;i.__super__.constructor.call(this,this.user,this.options)}i.prototype.on_confirm_button_click=function(T){T.preventDefault();return this.sharing_api.transfer_ownership(this.ns_id,this.user_id,(function(fr){return function(fs){ah.success(eG("Ownership changed successfully"));return d7.pop()}})(this))};i.prototype.before_show=function(){var T;T=eG("Make %(person_name)s the owner of this folder?");T=T.format({person_name:bU.em_snippet(this.user_name,14)});return this.format({".change_sf_owner-confirm-nickname":this.user_name,".db-modal-title-text":T})};return i})(dX);eC=F.ExistingSharedFolderPermissionsModal=(function(i){fi(j,i);j.SAVED_PERMISSIONS="existing_sf_permissions:saved";function j(fv,ft,T,fu){var fs,fr;this.user=fv;this.path=ft;this.ns_id=T;this.on_hide=fu;fs={ns_id:this.ns_id,folder_name:this.path};fs[a9.UID_PARAM_NAME]=this.user.id;fr=eG("'%(folder_name)s' settings");fr=fr.format({folder_name:bU.em_snippet(aA.filename(this.path),13)});j.__super__.constructor.call(this,{element_id:"folder-permissions-modal",title:fr,endpoint_url:"/share_ajax/folder_settings",parameters:fs})}return j})(cF);db=db=(function(i){fi(j,i);function j(ft,T){var fs,fr;this.user=ft;this.ns_id=T;fs={ns_id:this.ns_id};fs[a9.UID_PARAM_NAME]=this.user.id;fr=eG("Confirm converting to Golden Gate folder");j.__super__.constructor.call(this,{element_id:"golden-gate-warning-modal",title:fr,endpoint_url:"/share_ajax/golden_gate_warning",parameters:fs})}return j})(cF);dI=F.GoldenGateWarningModalContents=(function(){function i(j,T,fr){this.$form=j;this.ns_id=fr;this._submit=b3(this._submit,this);this.user=cQ.get_viewer().get_user_by_id(T);this._listen()}i.prototype._listen=function(){this.$form.find(".confirm-button").click(this._submit);return this.$form.find(".cancel-button").click(this._cancel)};i.prototype._submit=function(j){return d7.push(new bv(this.user,this.ns_id,{element_id:"golden-gate-warning-modal",ns_id:this.ns_id}))};i.prototype._cancel=function(j){return d7.pop()};return i})();bv=bv=(function(j){fi(i,j);function i(ft,T){var fs,fr;this.user=ft;this.ns_id=T;fs={ns_id:this.ns_id};fs[a9.UID_PARAM_NAME]=this.user.id;fr=eG("Confirm converting to Golden Gate folder");i.__super__.constructor.call(this,{element_id:"golden-gate-warning-modal",title:fr,endpoint_url:"/share_ajax/golden_gate_confirm",parameters:fs})}return i})(cF);fj=F.GoldenGateConfirmModalContents=(function(j){fi(i,j);function i(T,fr,fs){this.$form=T;this.ns_id=fs;this.user=cQ.get_viewer().get_user_by_id(fr);new ci(this.$form,null,{should_submit_once:true});this.$form.on(ci.SUCCESS_EVENT,(function(ft){return function(){return cG.WebRequest({url:"/share_ajax/enable_golden_gate_step_two",subject_user:ft.user,data:{ns_id:ft.ns_id},success:function(){ah.success("Golden Gate enabled for this folder");return location.reload()}})}})(this));this._listen()}i.prototype._listen=function(){return this.$form.find(".cancel-button").click(this._cancel)};i.prototype._cancel=function(T){return d7.pop()};return i})(cF);S=F.ExistingSharedFolderPermissionsContent=(function(){function i(j,T,fr){this.$form=j;this.ns_id=fr;this._submit=b3(this._submit,this);this.user=cQ.get_viewer().get_user_by_id(T);this.sharing_api=new bm(this.user);this.sharing_api.loading_elem=this.$form;this._listen()}i.prototype._listen=function(){this.$form.find(".confirm-button").click(this._submit);return this.$form.find(".cancel-button").click(this._cancel)};i.prototype._cancel=function(){return d7.pop()};i.prototype._submit=function(fu){var fv,j,ft,fr,fs,T;fu.preventDefault();j=this.$form.find("input[name=audience]:checked").val();ft=this.$form.find("input[name=inviter]:checked").val();T=this.$form.find("input[name=shared_link_policy]:checked").val();fv=(fs=this.$form.find("input[name=activity_feed_enabled]:checked"))!=null?fs.val():void 0;this.sharing_api.update_sf_team_permissions(this.ns_id,j,ft,T,fv,(function(fw){return function(fy){var fx,fz;fx=JSON.parse(fy.responseText);fz=fx.team_only_invite;ah.success(fx.message);d7.trigger(eC.SAVED_PERMISSIONS,fz);return d7.pop()}})(this));false;fr={ns_id:this.ns_id,audience:j,inviter:ft};return ba.SharedFolderActivityLogger.log("web","settings_modal_save",this.user,fr)};return i})();var a1,d4,a2,eQ,cq,cC,al,ev,dg,cg,bS,c3,c2,c0,cY,fi=function(fr,j){for(var i in j){if(dq.call(j,i)){fr[i]=j[i]}}function T(){this.constructor=fr}T.prototype=j.prototype;fr.prototype=new T();fr.__super__=j.prototype;return fr},dq={}.hasOwnProperty,b3=function(i,j){return function(){return i.apply(j,arguments)}};a1=F.BaseShareAFolderWizardModal=(function(i){fi(j,i);j.prototype.base_title=null;j.prototype.personal_title=null;j.prototype.work_title=null;function j(T,fr){this.user=T;this.options=fr;j.__super__.constructor.call(this,this.options);this.sharing_api=new bm(this.user)}j.prototype.before_show=function(){var T;this.sharing_api.loading_elem=this.$modal_window;T=this.base_title;if(cQ.get_viewer().is_paired){if(this.user.role==="personal"){T=this.personal_title}else{T=this.work_title.format({team_name:cQ.get_viewer().team_name})}}return this.format({".db-modal-title-text":T})};return j})(ed);ev=F.ShareAFolderWizardModal=(function(i){fi(j,i);function j(T,fr){this.user=T;this.options=fr;j.__super__.constructor.call(this,this.user,this.options);this.base_title=eG("Share a folder");this.personal_title=eG("Share a folder from your personal Dropbox");this.work_title=eG("Share a folder from your %(team_name)s Dropbox")}j.prototype.on_show=function(){this.$modal_window.find("input#create-new-sf").prop("checked",true);this.$modal_window.find("a.back").on("click",(function(T){return function(fr){fr.preventDefault();s.start_wizard_without_user();return T.hide()}})(this));return this.$modal_window.find("#new-or-existing-sf li").on("click",(function(T){return function(fr){bF(fr.currentTarget).find('input[name="sf_type"]').prop("checked",true);if(T.$modal_window.find("input#create-new-sf").is(":checked")){return ba.SharedFolderActivityLogger.log("web","new_or_existing_modal_new_folder",T.user)}else{return ba.SharedFolderActivityLogger.log("web","new_or_existing_modal_existing_folder",T.user)}}})(this))};j.prototype.on_confirm_button_click=function(fw){var ft,fv,T,fs,fu,fr;fw.preventDefault();fv=this.$modal_window.find("input#create-new-sf").is(":checked");if(fv){fs=null;if(this.user.role==="work"){fu="shared-folder-type-wizard-modal";fr=ed.get_template(fu);if(fr.length){fs=new bS(this.user,{element_id:fu})}}if(fs===null){fs=new cg(this.user,{element_id:"share-new-folder-wizard-modal"})}this.hide();T={selection:"new_folder"};ba.SharedFolderActivityLogger.log("web","new_or_existing_modal_next_button",this.user,T);return fs.show()}ft=this.$modal_window.find(".ajax-loading-indicator").show();return bF.ajax({url:"/share_ajax/account_has_existing_folders",type:"post",subject_user:this.user,success:(function(fx){return function(fy){var fz;fy=JSON.parse(fy);if(fy===true){fs=new dg(fx.user,{element_id:"share-existing-folder-wizard-modal"});T.has_existing_folder=true}else{fz=eG("You don't have any existing folders. Please create and share a new folder.");fs=new cg(fx.user,{element_id:"share-new-folder-wizard-modal",error_msg:fz});T.has_existing_folder=false}fx.hide();return fs.show()}})(this),error:(function(fx){return function(){return ah.error()}})(this),complete:(function(fx){return function(){return ft.hide()}})(this)},T={selection:"existing_folder"},ba.SharedFolderActivityLogger.log("web","new_or_existing_modal_next_button",this.user,T))};return j})(a1);bS=F.SharedFolderTypeWizardModal=(function(j){fi(i,j);function i(T,fr){this.user=T;this.options=fr;i.__super__.constructor.call(this,this.user,this.options);this.work_title=eG("Share a folder from your %(team_name)s Dropbox")}i.prototype.on_show=function(){this.$modal_window.find("input#team-folder-option").prop("checked",true);this.$modal_window.find("a.back").on("click",(function(T){return function(fr){fr.preventDefault();s.start_wizard_for_user(T.user);return T.hide()}})(this));return this.$modal_window.find("#shared-folder-type li").on("click",(function(T){return function(fr){bF(fr.currentTarget).find('input[name="shared_folder_type"]').prop("checked",true);if(T.$modal_window.find("input#team-folder-option").is(":checked")){return ba.SharedFolderActivityLogger.log("web","shared_folder_type_team_folder",T.user)}else{return ba.SharedFolderActivityLogger.log("web","shared_folder_type_shared_folder",T.user)}}})(this))};i.prototype.on_confirm_button_click=function(fu){var T,fs,ft,fr;fu.preventDefault();T=(function(fv){return function(fy,fw){var fx;fy.preventDefault();fw.hide();fx=new fv.constructor(fv.user,fv.options);return fx.show()}})(this);fs=this.$modal_window.find("input#team-folder-option").is(":checked");if(fs){ft=new d2({element_id:"new-team-folder-modal",open_created_folder:true,back_fn:T});fr="team_folder"}else{ft=new cg(this.user,{element_id:"share-new-folder-wizard-modal",back_fn:T});fr="shared_folder"}ba.SharedFolderActivityLogger.log("web","shared_folder_type_next_button",this.user,{selection:fr});this.hide();return ft.show()};return i})(a1);eQ=F.InlineModalValidationError=(function(){function i(){}i.show_validation_error=function(fw,fs){var ft,fu,fr,T,fv,j;if(fw.responseText.indexOf("err:{")===0){j=fw.responseText.substr(4);fv=JSON.parse(j);for(fu in fv){ft=fv[fu];if("message_text" in ft){T=fs.find("span.error-message");if(T.length===0){T=bF("<span/>").addClass("error-message");fs.prepend(T)}T.text(ft.message_text);return}}fs.find("span.error-message").remove();return ah.error()}else{fs.find("span.error-message").remove();if(fw.responseText.indexOf("err:")===0){fr=fw.responseText.substr(4);return ah.error(fr)}else{return ah.error()}}};return i})();c3=F.TeamSharedFolderWizardModalPage1=(function(i){fi(j,i);function j(T,fr){this.user=T;this.options=fr;this.__fix_position=b3(this.__fix_position,this);j.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-wizard-page1 input[type=text]";this.base_title=eG("Now, let's set up your team");this.options.vertical_offset=5}j.prototype.on_show=function(){var fs,fr,T,ft;ft=this.$modal_window.find(".suggestion-input");for(fr=0,T=ft.length;fr<T;fr++){fs=ft[fr];da.register($(fs))}this.$modal_window.find("#validate-team-name").submit((function(fu){return function(fv){fv.preventDefault();return fu.on_confirm_button_click(fv)}})(this));if(this.options.error_msg){ah.error(this.options.error_msg)}return ba.SharedFolderActivityLogger.log("web","team_shared_group_name_land",this.user)};j.prototype.on_confirm_button_click=function(ft){var fr,T,fs;ft.preventDefault();fs=this.$modal_window.find("#new-team-shared-folder-name-input").val();T=(function(fu){return function(){var fv;fv=new c2(fu.user,{team_name:fs,element_id:"team-shared-folder-wizard-modal-page2"});fu.hide();return fv.show()}})(this);fr=(function(fu){return function(fv){ba.SharedFolderActivityLogger.log("web","team_shared_group_name_folder_exists",fu.user);return eQ.show_validation_error(fv,fu.$modal_window.find("#validate-team-name"))}})(this);return this.sharing_api.validate_new_sf_path(fs,T,fr)};j.prototype.__fix_position=function(fr){var T;T=this.$modal_window.find(".db-modal");return T.css({margin:"0",position:"fixed"})};return j})(a1);c2=F.TeamSharedFolderWizardModalPage2=(function(i){fi(j,i);function j(T,fr){this.user=T;this.options=fr;this.__fix_position=b3(this.__fix_position,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);j.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-email1 input[type=text]";this.base_title=eG("Invite teammates");this.folder_name=this.options.team_name}j.prototype.before_show=function(){var T;T=eG("Add people to %(folder_name)s").format({folder_name:this.folder_name});return this.format({"#figcaption_headline":T})};j.prototype.on_show=function(){ba.SharedFolderActivityLogger.log("web","team_shared_group_emails_land",this.user);return this.$modal_window.find("#enter-email-invites").submit((function(T){return function(fr){fr.preventDefault();return T.on_confirm_button_click(fr)}})(this))};j.prototype.on_confirm_button_click=function(fu){var fs,fr,ft,fw,T,fv;fu.preventDefault();fw={emails:[]};ba.SharedFolderActivityLogger.log("web","team_shared_group_emails_submit",this.user);for(T=ft=1;ft<=10;T=++ft){fs=this.$modal_window.find("#new-team-shared-folder-email"+T).val();if(fs){fw.emails.push(fs)}}fr=ea.getForRole(cu.active_user.role);if(!fr.verified_or_show()){ba.SharedFolderActivityLogger.log("web","team_shared_group_not_email_verified",this.user);return fr.send_email("share_folder",(function(fx){return function(){var fy;fy=new c0(fx.user,{element_id:"team-shared-folder-wizard-modal-page3",folder_name:fx.folder_name,invitees:fw,from_email_verification:true});fx.hide();return fy.show()}})(this))}else{ba.SharedFolderActivityLogger.log("web","team_shared_group_email_verified",this.user);fv=new c0(this.user,{element_id:"team-shared-folder-wizard-modal-page3",folder_name:this.folder_name,invitees:fw,from_email_verification:true});this.hide();return fv.show()}};j.prototype.__fix_position=function(fr){var T;T=this.$modal_window.find(".db-modal");T.css;return{margin:"0",position:"fixed"}};return j})(a1);c0=F.TeamSharedFolderWizardModalPage3=(function(i){fi(j,i);function j(T,fr){this.user=T;this.options=fr;this.__fix_position=b3(this.__fix_position,this);j.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-wizard-page3 input[type=text]";this.base_title=eG("Creating %(folder_name)s team and sending invites!").format({folder_name:this.options.folder_name})}j.prototype.on_show=function(){var fv,ft,fs,fr,fx,fw,fu,T;ba.SharedFolderActivityLogger.log("web","team_shared_group_interstitial",this.user);this.$modal_window.find("#db-modal-close-x").click((function(fy){return function(fz){fz.preventDefault();return fy.on_close_button_click(fz)}})(this));fx="";fw=true;ft=false;fr="all";fu=false;fv=null;T=(function(fy){return function(fB){var fz,fA;fz=JSON.parse(fB.responseText);ah.success(fz.success_msg);fA=new cY(fy.user,{element_id:"team-shared-folder-wizard-modal-page4",folder_name:fy.options.folder_name,invitees:fy.options.invitees,from_email_verification:true});fy.hide();return fA.show()}})(this);fs=(function(fy){return function(fz){return fy.hide()}})(this);return this.sharing_api.share_folder(fw,this.options.folder_name,this.options.invitees,fx,ft,fr,fu,fv,false,T,fs)};j.prototype.on_confirm_button_click=function(T){T.preventDefault();return this.hide()};j.prototype.__fix_position=function(fr){var T;T=this.$modal_window.find(".db-modal");return T.css({margin:"0",position:"fixed"})};return j})(a1);cY=F.TeamSharedFolderWizardModalPage4=(function(j){fi(i,j);function i(T,fr){this.user=T;this.options=fr;this.__fix_position=b3(this.__fix_position,this);i.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-wizard-page4 input[type=text]";this.base_title=eG("%(folder_name)s created and invites sent!").format({folder_name:this.options.folder_name})}i.prototype.before_show=function(){var T;T=this.$modal_window.find("#back_to_home");T.attr("href","/home/"+this.options.folder_name);return this.format({"#figcaption_headline":this.base_title})};i.prototype.on_show=function(){return ba.SharedFolderActivityLogger.log("web","team_shared_group_final",this.user)};i.prototype.__fix_position=function(fr){var T;T=this.$modal_window.find(".db-modal");return T.css({margin:"0",position:"fixed"})};return i})(a1);cg=F.ShareNewFolderWizardModal=(function(j){fi(i,j);function i(T,fr){this.user=T;this.options=fr;this.options.focus="#new-shared-folder-wizard input[type=text]";i.__super__.constructor.call(this,this.user,this.options);this.base_title=eG("Create a new shared folder");this.personal_title=eG("Create a shared folder in your personal Dropbox");this.work_title=eG("Create a shared folder in your %(team_name)s Dropbox")}i.prototype.on_show=function(){var fs,fr,T,ft;ft=this.$modal_window.find(".suggestion-input");for(fr=0,T=ft.length;fr<T;fr++){fs=ft[fr];da.register($(fs))}this.$modal_window.find("#validate-folder-name").submit((function(fu){return function(fv){fv.preventDefault();return fu.on_confirm_button_click(fv)}})(this));if(this.options.error_msg){ah.error(this.options.error_msg)}return this.$modal_window.find("a.back").on("click",(function(fu){return function(fv){if(fu.options.back_fn){return fu.options.back_fn(fv,fu)}else{fv.preventDefault();fu.hide();return s.start_wizard_for_user(fu.user)}}})(this))};i.prototype.on_confirm_button_click=function(ft){var fs,fu,fr,T;ft.preventDefault();fu=this.$modal_window.find("#new-shared-folder-name-input").val();fr={folder_name:fu};ba.SharedFolderActivityLogger.log("web","name_new_folder_modal_next_button",this.user,fr);T=(function(fv){return function(){var fw;fw=new cq(fv.user,{folder_name:fu,element_id:"invite-to-new-sf-wizard-modal-"+fv.user.id});fv.hide();fw.new_folder=true;fw.show();return ba.SharedFolderActivityLogger.log("web","name_new_folder_modal_success",fv.user,fr)}})(this);fs=(function(fv){return function(fw){var fx;fx=ci.extract_errors(fw.responseText);ba.SharedFolderActivityLogger.log("web","name_new_folder_modal_fail",fv.user,fr);if(fx===false){}else{if(typeof fx==="string"){return ah.error(fx)}else{bF("#new-shared-folder-name-input .error-message").remove();return ci.fill_errors(bF("#validate-folder-name"),fx)}}}})(this);return this.sharing_api.validate_new_sf_path(fu,T,fs)};return i})(a1);dg=F.ShareExistingFolderWizardModal=(function(j){fi(i,j);function i(T,fr){this.user=T;this.options=fr;this._hide=b3(this._hide,this);this.on_show=b3(this.on_show,this);i.__super__.constructor.call(this,this.user,this.options);this.base_title=eG("Choose folder to share");this.personal_title=eG("Choose a folder from your personal Dropbox");this.work_title=eG("Choose a folder from your %(team_name)s Dropbox")}i.prototype.on_show=function(){this.treeview_id="copy-move-treeview";this.treeview_parent_id=bF("#"+this.treeview_id).parent().attr("id");b2.schedule_reset();b2.move(this.treeview_id,"share-existing-treeview",{onSuccess:((function(T){return function(){var fr;bF(document).on("db:treeview_selected",function(ft,fs){return T.folder_name=fs});fr=bF(".first-treeview-link");if(!ec.ie){return fr.click()}}})(this)),user:this.user});return this.$modal_window.find("a.back").on("click",(function(T){return function(fr){fr.preventDefault();T.hide();return s.start_wizard_for_user(T.user)}})(this))};i.prototype._hide=function(){b2.move(this.treeview_id,this.treeview_parent_id,{user:this.user});return i.__super__._hide.apply(this,arguments)};i.prototype.on_hide=function(){return bF(document).off("db:treeview_selected")};i.prototype.on_confirm_button_click=function(ft){var fs,fr,T;fr={folder_name:this.folder_name};ft.preventDefault();if(this.folder_name&&this.$modal_window.find("#copy-move-treeview .highlight .s_web_folder_user").length){this.hide();ba.SharedFolderActivityLogger.log("web","choose_folder_modal_shared_next",this.user,fr);return s.show_shared_folder_options_modal(this.folder_name,this.user)}else{T=(function(fu){return function(){var fv;fv=new cq(fu.user,{folder_name:fu.folder_name,element_id:"invite-to-new-sf-wizard-modal-"+fu.user.id});fu.hide();ba.SharedFolderActivityLogger.log("web","choose_folder_modal_not_shared_next",fu.user,fr);fv.new_folder=false;return fv.show()}})(this);fs=(function(fu){return function(fv){return eQ.show_validation_error(fv,fu.$modal_window.find("#choose-existing-folder"))}})(this);return this.sharing_api.validate_existing_sf_path(this.folder_name,T,fs)}};return i})(a1);a2=F.CreateOrShareNewFolderWizardModal=(function(i){fi(j,i);function j(T,fr){this.user=T;this.options=fr;this.on_confirm_button_click=b3(this.on_confirm_button_click,this);this._extract_invitees=b3(this._extract_invitees,this);this._toggle_send_button_state=b3(this._toggle_send_button_state,this);j.__super__.constructor.call(this,this.options);this.destination_dir=this.options.destination_dir;this.sharing_api=new bm(this.user);this.state="Create"}j.prototype.on_show=function(){var fr,fs,fu,ft,T;this.$send_button=this.$modal_window.find(".confirm-button");this.$cancel_button=this.$modal_window.find(".cancel-button");fu="create-and-share-new-folder-invite-wizard-"+this.user.id;this.file_name_input=this.$modal_window.find("#create-and-share-new-folder-name-input");this.file_name_input.focus();fs=fu+"-new-collab-input";this.collab_input=this.$modal_window.find("#"+fs);fr={tokens:[",",";"],include_fb:true,include_team:true,team_only:false,user_id:this.user.id,max_textbox_height:30};this.autocompleter=new Autocompleter.ContactsTokenizer(this.user,fs,fu+"-new-whobulk",fu+"-hidden-input",fr);if((ft=this.file_name_input)!=null){ft.keyup(this._toggle_send_button_state)}if((T=this.collab_input)!=null){T.keyup(this._toggle_send_button_state)}if(this.collab_input[0]){this.collab_input[0].on("token:remove",this._toggle_send_button_state);this.collab_input[0].on("token:add",this._toggle_send_button_state)}return this._toggle_send_button_state()};j.prototype._toggle_send_button_state=function(){var ft,fs,fr,T;T=((fs=this.autocompleter)!=null?fs.token_manager.tokens.length:void 0)===0;T=T&&this.collab_input.val()==="";ft=this.file_name_input.val();fr=ft==="";this.$send_button.prop("disabled",fr);if(T){this.$send_button.text(eG("Create folder"));return this.state="Create"}else{this.$send_button.text(eG("Share folder"));return this.state="Share"}};j.prototype._extract_invitees=function(){var fw,fs,fv,ft,fr,fx,T,fu;fv=this.$modal_window.find(".tokenized_autocompleter_container");fx={};fu=["emails","fb_ids","group_ids","new_style_group_ids"];for(ft=0,T=fu.length;ft<T;ft++){fs=fu[ft];fr=fv.find("input[name="+fs+"]");fx[fs]=(function(){var fz,fy,fA;fA=[];for(fz=0,fy=fr.length;fz<fy;fz++){fw=fr[fz];fA.push(bF(fw).val())}return fA})()}return fx};j.prototype.on_confirm_button_click=function(fB){var fs,fy,fv,fD,fw,fz,ft,fu,T,fx,fA,fC,fr;fB.preventDefault();T=this.file_name_input.val();fD=eG("We can\u2019t create folder '%(folder_name)s'");fD=fD.format({folder_name:T});fv=function(){return ah.error(fD)};if(this.state==="Create"){fr="/cmd/new"+ec.urlquote(this.destination_dir);fx={to_path:T};fx[a9.UID_PARAM_NAME]=this.user.id;fC=function(){var fE;fE=eG("Created new folder '%(folder_name)s'");fE=fE.format({folder_name:T});return ah.success(fE)};new cG.WebRequest({url:fr,data:fx,success:fC,error:fv})}else{this.autocompleter.tokenize_emails_input(true);fz=this._extract_invitees();fC=function(){var fE;fE=eG("Shared new folder '%(folder_name)s'");fE=fE.format({folder_name:T});return ah.success(fE)};fu="";fy=false;ft="all";fA=false;fs=null;fw=this.destination_dir+"/"+T;this.sharing_api.share_path(fw,fz,fu,fy,ft,fA,fs,false,fC,fv)}return this.hide()};return j})(ed);d4=F.CreateLinkOrInviteToFolderWizardModal=(function(j){fi(i,j);function i(T,fr){this.user=T;this.options=fr;i.__super__.constructor.call(this,this.options);this.sharing_api=new bm(this.user)}i.prototype.before_show=function(){var T;this.sharing_api.loading_elem=this.$modal_window;T=eG("Share '%(folder_name)s' with others");T=T.format({folder_name:bU.em_snippet(aA.filename(this.options.path),16)});return this.format({".db-modal-title-text":T})};i.prototype.on_show=function(){var T,fr,fs;T="edu_modal";fs=(fr=this.options.target_item)!=null?fr:null;ba.ShmodelUILogger.log("view",T,fs);this.$modal_window.find(".option-to-share-folder").on("click",(function(ft){return function(fv){var fu;if(ft.options.existing_sf){ba.ShmodelUILogger.log("sf_options",T,fs);fu=new dl(cu.active_user,ft.options.path)}else{ba.ShmodelUILogger.log("sf_invite",T,fs);fu=new cq(ft.user,{folder_name:ft.options.path,element_id:"invite-to-new-sf-wizard-modal-"+ft.user.id})}ft.hide();return fu.show()}})(this));this.$modal_window.find(".option-to-share-link").on("click",(function(ft){return function(fu){ba.ShmodelUILogger.log("token_share",T,fs);dE.shmodel(ft.options.path,"create_link_or_invite_to_folder_modal");return ft.hide()}})(this));return this.$modal_window.find(".learn-more").on("click",(function(ft){return function(fu){fu.preventDefault();ba.ShmodelUILogger.log("clicked_learn_more",T,fs);return window.open("/help/274","_blank")}})(this))};return i})(ed);cq=F.InviteToNewSharedFolderWizardModal=(function(j){fi(i,j);function i(T,fr){this.user=T;this.options=fr;this.insert_folder_settings=b3(this.insert_folder_settings,this);this.share_folder=b3(this.share_folder,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);this.show_settings_modal=b3(this.show_settings_modal,this);this.show_m2_settings_modal=b3(this.show_m2_settings_modal,this);this._toggle_get_link_button_visibility=b3(this._toggle_get_link_button_visibility,this);this.options.focus=".new-collab-input";i.__super__.constructor.call(this,this.options);this.sharing_api=new bm(this.user);this.folder_name=this.options.folder_name;this.must_check_verified=(this.options.must_check_verified!=null)||false;this.progress_ever_blocked_by_verify=false;this.has_inviter_restriction=this.options.has_inviter_restriction}i.prototype.before_show=function(){var T;this.sharing_api.loading_elem=this.$modal_window;T=eG("Share '%(folder_name)s' with others");T=T.format({folder_name:bU.em_snippet(aA.filename(this.folder_name),16)});return this.format({".db-modal-title-text":T})};i.prototype.on_show=function(){var fr,ft,fs,T,fv,fu;fu=this.$modal_window.find(".suggestion-input");for(fs=0,T=fu.length;fs<T;fs++){ft=fu[fs];da.register($(ft))}fr=this.$modal_window.find(".invite-more-form");if(!this.invite_form_controller){fv="invite-wizard-"+this.user.id;this.invite_form_controller=new dk(this.user,fr,[],[],[],fv);this.insert_folder_settings(this.invite_form_controller.team_only?"team":"")}else{this.invite_form_controller.listen()}this.get_link_button=this.$modal_window.find(".get-editable-link-invite");if(this.get_link_button.length>0){C.showInstance(dJ.createElement(C,{onDismiss:eL.dismissM2Prompt,shouldShow:cu.simple_sharing_show_m2_prompt,targetedButton:this.get_link_button.get(0)}));ba.SimpleSharingLogger.log(this.user.id,27)}this.collab_input=this.$modal_window.find(".new-collab-input");this.collab_input.focus();this.collab_input.keyup(this._toggle_get_link_button_visibility);if(this.collab_input[0]){this.collab_input[0].on("token:remove",this._toggle_get_link_button_visibility);this.collab_input[0].on("token:add",this._toggle_get_link_button_visibility)}this.$modal_window.find(".change-new-folder-settings").on("click",(function(fw){return function(fx){fx.preventDefault();return fw.show_settings_modal()}})(this));this.$modal_window.find(".m2-settings-link").on("click",(function(fw){return function(fx){fx.preventDefault();return fw.show_m2_settings_modal()}})(this));this.$modal_window.find(".get-editable-link-invite").on("click",(function(fw){return function(fB){var fC,fA,fy,fx,fz;fB.preventDefault();bF(document).trigger("collab:m2:prompt:dismiss");fx=fw.$modal_window.find(".m2-settings-link");if(fx.length>0){fw.inviter_restriction=fw.has_inviter_restriction?"me":"all"}ba.SimpleSharingLogger.log(fw.user.id,28);fC=fw.$modal_window.find(".get-link-invite-loading");if(fC!=null){fC.show()}fz=function(fF){var fH,fG,fJ,fE,fD,fI;if(fC!=null){fC.hide()}fE=bb.parse_response(fF),fI=fE[0],fJ=fE[1];if(fI){return eL.createAndShowM2InbandModal(fw.user,fw.folder_name)}else{fD=bb.parse_error(fJ),fG=fD[0],fH=fD[1];if(fG){return ah.error(fH)}else{return ah.error(eG("Failed to create link."))}}};fy=function(){if(fC!=null){fC.hide()}return ah.error(eG("Failed to create link."))};fA={path:fw.folder_name,emails:[],fb_ids:[],new_style_group_ids:[],custom_message:"",access_type:2,is_simple_sharing:true,folder_settings:1,shared_link_policy:fw.shared_link_policy_restriction,audience:fw.audience_restriction,inviter:fw.inviter_restriction};if(fw.audience_restriction||fw.inviter_restriction){fA.custom_folder_settings=1}return cG.FormWebRequest({subject_user:fw.user.id,url:"/share_ajax/existing_no_recipient",data:fA,success:fz.bind(fw),error:fy.bind(fw),skipErrorHandling:true})}})(this));this.log_extras={path:this.folder_name};return ba.SharedFolderActivityLogger.log("web","share_folder_modal_displayed",this.user,this.log_extras)};i.prototype._toggle_get_link_button_visibility=function(){var fu,ft,fs,fr,T;if(this.shared_link_policy_restriction==="1"){if((fs=this.get_link_button)!=null){fs.hide()}return}ft=this.invite_form_controller.get_token_count()===0;fu=this.collab_input&&this.collab_input.val()==="";if(ft&&fu){return(fr=this.get_link_button)!=null?fr.show():void 0}else{return(T=this.get_link_button)!=null?T.hide():void 0}};i.prototype.show_m2_settings_modal=function(){var fr,T;fr=this.folder_name;T=function(fs){var ft;ft=new i(cu.active_user,{folder_name:fr,element_id:"invite-to-new-share-file-wizard-modal-"+cu.active_user.id,has_inviter_restriction:!fs});return ft.show()};d7.pop();return ae.showInstance(dJ.createElement(ae,{user:this.user,fq_path:this.folder_name,is_shared_folder:false,initial_allows_editor_manage_membership:!this.has_inviter_restriction,done_callback:T}))};i.prototype.show_settings_modal=function(){var fr,T;T=eG("'%(folder_name)s' settings");T=T.format({folder_name:bU.em_snippet(aA.filename(this.folder_name),13)});fr={folder_name:this.folder_name};if(this.audience_restriction){fr.audience=this.audience_restriction}if(this.inviter_restriction){fr.inviter=this.inviter_restriction}if(this.shared_link_policy_restriction){fr.shared_link_policy=this.shared_link_policy_restriction}fr[a9.UID_PARAM_NAME]=this.user.id;d7.register(cC.SAVED_PERMISSIONS,(function(fs){return function(fu,ft){fs.insert_folder_settings(ft.audience,ft.inviter,ft.shared_link_policy);return fs.invite_form_controller.reset_options()}})(this));return d7.push(new cF({element_id:"folder-permissions-modal",title:T,endpoint_url:"/share_ajax/default_folder_settings",parameters:fr}))};i.prototype.on_confirm_button_click=function(ft){var fs,fv,fr,T,fu;ft.preventDefault();this.invite_form_controller.tokenize();fv=this.invite_form_controller.extract_invitees();fu=this.invite_form_controller.get_custom_message();fs=this.invite_form_controller.get_access_type();fr=this.$modal_window.find("input#allow_other_members_to_share");if(fr.length>0){this.inviter_restriction=fr.is(":checked")?"all":"me"}T=this.$modal_window.find(".m2-settings-link");if(T.length>0){this.inviter_restriction=this.has_inviter_restriction?"me":"all"}return this.share_folder(fv,fu,fs,true,false)};i.prototype.share_folder=function(fv,fs,T,fw,fu,fr){var fA,ft,fx,fz,fy;if(fw==null){fw=true}if(fu==null){fu=false}if(fr==null){fr=false}ft=(function(fB){return function(fC){fB.$modal_window.find(".confirm-button").prop("disabled",false);return eQ.show_validation_error(fC,fB.$modal_window.find(".tokenized_autocompleter_container"))}})(this);fz=(function(fB){return function(fE){var fD,fC;fB.$modal_window.find(".confirm-button").prop("disabled",false);fC=JSON.parse(fE.responseText);ah.success(fC.success_msg);if(fB.progress_ever_blocked_by_verify){ba.SharedFolderActivityLogger.log("web","email_verify_sharing_modal_share_succeess",fB.user,fx)}document.fire(aH.SF_NEW,{sf_info:bZ.decode_sort_key(fC.sf_info)});if(fw){fB.hide()}if(fr){fD=new dl(fB.user,aA.normalize(fB.folder_name));return fD.show()}}})(this);if(this.must_check_verified&&!this.user.is_email_verified){this.progress_ever_blocked_by_verify=true;ba.SharedFolderActivityLogger.log("web","email_verify_sharing_modal_blocked_on_verify",this.user,fx);this.$modal_window.find(".confirm-button").prop("disabled",true);fy=eG("Verification email sent to %(email)s").format({email:this.user.email});fA=ea.get_for_user(this.user);fA.send_email("share_folder",function(){return ah.success(fy)});bF("#resend-email-verification-link").click(function(){return fA.send_email("share_folder",function(){return ah.success(fy)})});this.$modal_window.find(".email-verify-message").show();return fA.ensure_polling((function(fB){return function(){ba.SharedFolderActivityLogger.log("web","email_verify_sharing_modal_unblocked",fB.user,fx);ah.success(eG("Email verified. Try sharing your folder again."));fB.$modal_window.find(".confirm-button").prop("disabled",false);return fB.$modal_window.find(".email-verify-message").hide()}})(this))}else{this.$modal_window.find(".confirm-button").prop("disabled",true);this.sharing_api.share_folder(this.new_folder,this.folder_name,fv,fs,this.audience_restriction,this.inviter_restriction,this.shared_link_policy_restriction,T,fu,fz,ft);fx={path:this.folder_name,access_type:T};return ba.SharedFolderActivityLogger.log("web","invite_modal_share_folder_button",this.user,fx)}};i.prototype.insert_folder_settings=function(T,fr,ft){var fs;this.audience_restriction=T;this.inviter_restriction=fr;this.shared_link_policy_restriction=ft;fs=this.$modal_window.find(".invite-more-form, .external-invite-message,.folder-settings");if(cu.inside_team_folder){fs.addClass("in-team-folder");fs.removeClass("team-only")}else{fs.removeClass("in-team-folder");if(this.audience_restriction==="team"){fs.addClass("team-only")}else{fs.removeClass("team-only")}if(this.user.role==="work"){this.invite_form_controller.set_team_only(this.audience_restriction==="team")}}return this._toggle_get_link_button_visibility()};return i})(ed);al=F.NewSharedFolderPermissionsModal=(function(i){fi(j,i);function j(fr,fv,T,fs){var fu,ft;this.user=fr;this.path=fv;this.saved_state=T;this.done_callback=fs;fu={folder_name:this.path,audience:this.saved_state.audience?this.saved_state.audience:void 0,inviter:this.saved_state.inviter?this.saved_state.inviter:void 0,shared_link_policy:this.saved_state.shared_link_policy?this.saved_state.shared_link_policy:void 0,is_file:false};fu[a9.UID_PARAM_NAME]=this.user.id;ft=eG("\u2018%(folder_name)s\u2019 settings");ft=ft.format({folder_name:bU.em_snippet(aA.filename(this.path),13)});d7.register(cC.SAVED_PERMISSIONS,(function(fw){return function(fy,fx){return fw.done_callback.bind(null,fx.audience,fx.inviter,fx.shared_link_policy)()}})(this));j.__super__.constructor.call(this,{element_id:"folder-permissions-modal",title:ft,endpoint_url:"/share_ajax/default_folder_settings",parameters:fu})}return j})(cF);cC=F.NewSharedFolderPermissionsContent=(function(){i.SAVED_PERMISSIONS="new_sf_permissions:saved";function i(j){this.$form=j;this._submit=b3(this._submit,this);this._listen()}i.prototype._listen=function(){this.$form.find(".confirm-button").click(this._submit);return this.$form.find(".cancel-button").click(this._cancel)};i.prototype._cancel=function(){return d7.pop()};i.prototype._submit=function(fs){var T,fr,j;fs.preventDefault();T=this.$form.find("input[name=audience]:checked").val();fr=this.$form.find("input[name=inviter]:checked").val();j=this.$form.find("input[name=shared_link_policy]:checked").val();d7.trigger(i.SAVED_PERMISSIONS,{audience:T,inviter:fr,shared_link_policy:j});return d7.pop()};return i})();var dE;dE=F.SharingShmodel=(function(){function i(){}i.shmodel=function(T,j){return new dm(cu.active_user.id,T,j).show()};return i})();var bZ;bZ=INLINE_JS.Sharing=F.Sharing={init:function(fs,fr,T,j,i){this.show_inbox=j;this.simple_sharing_enabled=i;this._decode_sort_keys(fr);this._state={sf_info:{current:fr.current,past:fr.past},cmp:{"#sf-current":this._modified_cmp,"#sf-past":this._modified_cmp},is_ascending:{"#sf-current":false,"#sf-past":false},inbox_counts:{},sf_loading:fr.more,delay_reload_folder:false,has_initial_data:fs};if(cQ.get_viewer().is_paired){this.role_picker=D.controller(bF("#role-selector"));this.role_picker.on_state_change=this._render.bind(this);bO.set_during_login_callback((function(ft){return function(fv,fu){return ft._reload_folder_info(function(){return fu()},function(fw){fu(eG("Error displaying shared folders"));return window.location.reload()})}})(this))}this._listen();this._tmpl=fm.tmpl("sf_list_item_tmpl");if(!fs){this._hide_view();this._display_spinner()}else{this._render();if(fr.more){this._display_spinner()}}if(fr.more||!fs){cG.WebRequest({url:"/share_ajax/list_folders",dataType:"json",data:{start:fr.next},success:(function(ft){return function(fu){ft._load_and_render_sf_list(fu);if(!ft._state.has_initial_data){return en.mark_time_to_interactive()}}})(this),error:(function(ft){return function(fu){return ft._sf_list_error()}})(this)})}this._update_inbox_counts(T,true);this._display_view();if(this._state.has_initial_data){en.mark_time_to_interactive()}return bF(document).on(bm.REQUEST_SUCCEEDED_EVENT,(function(ft){return function(fu,fv){if(fv.request_url==="/share_ajax/cancel_invite"||fv.request_url==="/share_ajax/invite_more"||fv.request_url==="/share_ajax/kick_user"){return ft._reload_folder_info()}}})(this))},_load_and_render_sf_list:function(i){this._decode_sort_keys(i);if(this._state.sf_loading){this._state.sf_info.current.push.apply(this._state.sf_info.current,i.current);this._state.sf_info.past.push.apply(this._state.sf_info.past,i.past);this._state.sf_loading=false}this._hide_spinner();this._render();if(this._state.delay_reload_folder){this._state.delay_reload_folder=false;return this._reload_folder_info()}},_sf_list_error:function(){this._hide_spinner();return ah.error(eG("We weren\u2019t able to load the list of shared folders. Please refresh the page to try again."))},is_share_page:function(){return this._state!=null},_decode_sort_keys:function(i){return[i.current,i.past].each((function(j){return function(T){return T.each(function(fr){return j.decode_sort_key(fr)})}})(this))},decode_sort_key:function(i){cP((i.encoded_sort_key!=null)&&(i.sort_key==null),"expected encoded sort keys on each elm");i.sort_key=ec.decode_sort_key(i.encoded_sort_key);delete i.encoded_sort_key;return i},reload_folder_info_if_two_account:function(){if(this._showing_two_accounts()){return this._reload_folder_info()}},_reload_folder_info:function(T,i){var j;if(!this.is_share_page()){return}j=(function(fr){return function(fs){var ft;ft=JSON.parse(fs.responseText);fr._decode_sort_keys(ft);fr._state.sf_info=ft;fr._render();return typeof T==="function"?T():void 0}})(this);if(this._state.sf_loading){return this._state.delay_reload_folder=true}else{return new cs().get_folder_info(j,i)}},refresh_inbox_counts:function(i){return new cs().get_inbox_counts((function(j){return function(T){return j._update_inbox_counts(T,i)}})(this))},_update_inbox_counts:function(j,fs){var fv,T,i,fu,ft,fr;fr=0;for(fu in j){fv=j[fu];fr+=fv}bF("#inbox-count").text(fr);bF("#inbox-count").toggleClass("show",fr>0);if(!this.is_share_page()){return}T=function(fx,fw){var fy;for(fu in fx){fy=fx[fu];if(fw[fu]!==fx[fu]){return false}}return true};if((!fs)&&this._state&&T(this._state.inbox_counts,j)){return}this._state.inbox_counts=j;if(fr){i=new Element("a",{id:"new-invites-link",href:"#"});i.__sert(cy.make("web","email_32",{"class":"link-img"}));ft=bd("%(total_count)d new shared folder invitation","%(total_count)d new shared folder invitations",fr);ft+=" \n";ft=ft.format({total_count:fr});i.__sert(ft);i.observe("click",(function(fw){return function(fx){Event.stop(fx);return fw.show_invites()}})(this));$("invites-box").show();$("invites-box").__date(i)}else{$("invites-box").hide()}if(fr>0&&this.show_inbox){this.show_inbox=false;return this.show_invites()}},register_accept:function(i){bF(i).closest(".sf-invite-action").addClass("loading");new by(bF(i),i.action,{data:bT.collect_form_vars(i),complete:(function(j){return function(fr,T){bF(i).closest(".sf-invite-action").removeClass("loading");j.refresh_inbox_counts();return j._reload_folder_info()}})(this),success:(function(j){return function(fu,T,fw){var fs,ft,fv,fr;fu=(fr=JSON.parse(fw.responseText))!=null?fr.data:void 0;fs=bF(i).closest(".sf-invite-action");fs.addClass("sf-accepted");if(fu!=null?fu.redirect:void 0){if(j._state&&j._state.current_total_count>1){ft=fs.find(".view-folder-button");return ft.click(function(){return window.location.href=fu!=null?fu.redirect:void 0})}else{return window.location.href=fu!=null?fu.redirect:void 0}}else{fv=bF(i).closest(".invitation-row").attr("data-invite-id");return j._remove_invite_row(fv)}}})(this)});return false},upgrade_to_accept:function(i){new by(bF(i),i.action,{data:bT.collect_form_vars(i)});return false},register_decline:function(j,fr,fs){var i,T;i=bF(j).closest("form");if((T=i.closest(".sf-invite-action"))!=null){T.addClass("loading")}if(i.length){new by(i,i[0].action,{data:bT.collect_form_vars(i[0]),complete:(function(ft){return function(fw,fu){var fv;if((fv=i.closest(".sf-invite-action"))!=null){fv.removeClass("loading")}ft._remove_invite_row(fr);ft.refresh_inbox_counts();ft._reload_folder_info();if(fs){return fs()}}})(this)})}return false},_remove_invite_row:function(fs){var i,fr,T,j;i=bF("#invites-container");fr=i.find('[data-invite-id="'+fs+'"]');if(fr){j=fr.parent("tbody");fr.remove();if(j.children().length===0){i.find(".invitation-table-container").hide();i.find(".message-bottom").removeClass("message-bottom");i.find(".message-top").removeClass("message-top");if(i.find(".invites-message").length===0){T=ed.get_containing_modal(i);return T!=null?T.hide():void 0}}}},_listen:function(){var T,j,i;this.listen_modals();T=(function(fr){return function(fu,fC,fw){var fx,ft,fB,fv,fy,fA,fs,fz,fD;fs=fr._get_current_sf_list_info(fw),fA=fs[0],fB=fs[1];cP(fC,"SF _transfer w/o target_ns_id");for(fx=fv=0,fy=fA.length;fv<fy;fx=++fv){ft=fA[fx];if(ft.target_ns_id===fC&&ft.user_id===fu){fz=ft;fD=fx;break}}cP(fD!=null,"SF _transfer w/o js obj");return[fz,fD]}})(this);i=(function(fr){return function(fw,fC,fz){var fB,fs,fy,fv,fx,fD,fA,fu,ft;fs=fr._get_current_sf_list_info(fC),fB=fs[0],ft=fs[1];fy=fr._get_current_sf_list_info(fz),fA=fy[0],fu=fy[1];fv=T(fw.memo.user_id,fw.memo.target_ns_id,fC),fx=fv[0],fD=fv[1];fB.splice(fD,1);fr._empty_check(fC);if(fw.memo.filename!=null){fx.filename=fw.memo.filename}if(fw.memo.mount_point!=null){fx.mount_point=fw.memo.mount_point}fA.push(fx);return fr._render()}})(this);j=(function(fr){return function(fx,fu){var fz,fv,ft,fw,fy,fs;fv=fr._get_current_sf_list_info(fu),fz=fv[0],fs=fv[1];ft=T(fx.memo.user_id,fx.memo.target_ns_id,fu),fw=ft[0],fy=ft[1];fz.splice(fy,1);return fr._render()}})(this);document.observe(aH.SF_UNSHARE,(function(fr){return function(fs){return j(fs,"#sf-current")}})(this));document.observe(aH.SF_LEAVE,(function(fr){return function(fs){return i(fs,"#sf-current","#sf-past")}})(this));document.observe(aH.SF_REJOIN,(function(fr){return function(fs){i(fs,"#sf-past","#sf-current");return fr._reload_folder_info()}})(this));document.observe(aH.SF_IGNORE,(function(fr){return function(fs){return j(fs,"#sf-past")}})(this));document.observe(aH.SF_NEW,(function(fr){return function(ft){var fs;fs=ft.memo.sf_info;cP(fs,"SF_NEW without info");if(fr._state.sf_loading){return fr._reload_folder_info()}else{fr._state.sf_info.current.push(fs);return fr._render()}}})(this));$("create-share").observe("click",(function(fr){return function(fs){ba.SharedFolderActivityLogger.log("web","sharing_view_share_new",null,{},true);if(!$("create-share").hasClassName("disabled")){Event.stop(fs);return s.start_wizard_without_user()}}})(this));bF("#learn-more-link").click((function(fr){return function(fs){return ba.SharedFolderActivityLogger.log("web","sharing_view_learn_more",null,{},true)}})(this));if($("new-invites-link")){$("new-invites-link").observe("click",(function(fr){return function(fs){Event.stop(fs);return fr.show_invites()}})(this))}bF("#sf-current, #sf-past").each((function(fr){return function(fs,ft){var fu;fu=["#sf-current","#sf-past"][fs];bF(".sf-list",ft).on("click","a.options-link",function(fx){var fv,fB,fz,fD,fy,fE,fC,fA,fw;fx.preventDefault();fB=bF(fx.target).closest("a.options-link");fy=fB.attr("data-type");fv=fB.attr("data-filename");fD=fB.attr("data-mount");fA=parseInt(fB.attr("data-nsid"),10);fw=cQ.get_viewer().get_user_by_id(fB.attr("data-user_id"));fC=bF(fx.target).closest("li.sf-folder").data("role");fE=fB.attr("data-sf-perm-role");if(fy==="normal"){if(fr.simple_sharing_acl_enabled){if(ea.get_for_user(fw).verified_or_show()){eL.createAndShowInbandModal(fw,fD,true,fA,true,false,fE)}}else{s.show_shared_folder_options_modal(fD,fw)}}else{if(fy==="remove"){s.show_ignore_modal(fw,fv,fA)}else{if(fy==="rejoin"){s.show_rejoin_modal(fw,fv,fA)}}}fz={option_type:fy};if(fA){fz.ns_id=fA}if(fD){fz.path=fD}return ba.SharedFolderActivityLogger.log("web","sharing_view_share_existing",fw.id,fz,true)});bF(".sf-sort",ft).on("click","a.sort-option",function(fx){var fw,fv,fy;fx.preventDefault();fw=bF(fx.target).closest("a.sort-option");fy={SF_BY_NAME:fr._name_cmp,SF_BY_MODIFIED:fr._modified_cmp};fv=fy[fw.attr("data-sort")];if(fr._state.cmp[fu]===fv){fr._state.is_ascending[fu]=!fr._state.is_ascending[fu]}else{fr._state.cmp[fu]=fv;fr._state.is_ascending[fu]=true}ec.add_sort_arrow_mouseover_j(fw,fr._state.is_ascending[fu],fu+" .sf-sort a.sort-option",true);return fr._render_list_id(fu)});return ec.add_sort_arrow_mouseover_j(bF(".modified-sorter",ft),fr._state.is_ascending[fu],fu+" .sf-sort a.sort-option",false)}})(this));return bF(".empty-share-button").click((function(fr){return function(fs){fs.preventDefault();ba.SharedFolderActivityLogger.log("web","sharing_view_share_new",null,{},true);return s.start_wizard_without_user()}})(this))},listen_modals:function(){return bF("#new-or-existing-sf li").click((function(i){return function(T){var j;bF("#new-or-existing-sf li").removeClass("active");j=bF(T.target).closest("li");j.find("input").prop("checked",true);return j.addClass("active")}})(this))},_showing_two_accounts:function(){var i;return cQ.get_viewer().is_paired&&((i=this.role_picker)!=null?i.get_state():void 0)===d8.ALL},_render:function(){this._render_list_id("#sf-current");this._render_list_id("#sf-past");if(bF("#sf-current").hasClass("empty-list")&&bF("#sf-past").hasClass("empty-list")){bF("#page-content").addClass("no-shares");return bF("#empty-content").show()}else{bF("#page-content").removeClass("no-shares");return bF("#empty-content").hide()}},_render_list_id:function(fr){var fz,fw,fy,T,ft,fu,fv,i,fs,fx;i=this._get_current_sf_list_info(fr),fu=i[0],fy=i[1];fx=this._showing_two_accounts();fz=(function(j){return function(fA,fC){var fB;fB=j._state.is_ascending[fr]?1:-1;return fB*j._state.cmp[fr](fA,fC,fx)}})(this);fu.sort(fz);fv=bF(".sf-list",fr);fv.empty();for(T=0,ft=fu.length;T<ft;T++){fs=fu[T];if(this._should_render(fs)){fw=this._tmpl({options_str:eG("Options"),remove_str:eG("Remove"),rejoin_str:eG("Rejoin"),is_past:fy,sf:fs,Sprite:cy,Emstring:bU,Util:ec,_:eG});fv.append(fw.toHTML())}}return this._empty_check(fr)},_should_render:function(i){if(this.role_picker!=null){return this.role_picker.is_role_visible(i.role)}else{return true}},_empty_check:function(fr){var T,j,i;j=this._get_current_sf_list_info(fr),T=j[0],i=j[1];if(bF(".sf-list",fr).children().length){return bF(fr).removeClass("empty-list")}else{return bF(fr).addClass("empty-list")}},_get_current_sf_list_info:function(i){switch(i){case"#sf-current":return[this._state.sf_info.current,false];case"#sf-past":return[this._state.sf_info.past,true];default:return cP(false,"invalid sf list id")}},_name_cmp:function(j,T,i){if(i){return ec.sort_by_key(j,T)}else{return ec.sort_by_rank_or_key(j,T)}},_modified_cmp:function(j,T,i){return j.modified_ts-T.modified_ts},include_fb:false,use_fb_profile_pics:true,show_invites:function(){var T,j,i;this._state.current_total_count=0;j=this._state.inbox_counts;for(i in j){T=j[i];this._state.current_total_count+=T}if(this._state.current_total_count>0){return s.show_invites()}},_display_view:(function(i){return function(){return bF("#sf-view").show()}})(this),_hide_view:(function(i){return function(){return bF("#sf-view").hide()}})(this),_display_spinner:function(){return bF(".sf-spinner").show()},_hide_spinner:function(){return bF(".sf-spinner").hide()}};var br;Autocompleter.Contacts=Class.create(Autocompleter.Base,{initialize:function(fr,fs,T,fw){var fv,j,fu,i,ft;this.user=fr;this.baseInitialize(fs,T,fw);this.options.array=false;this.options.larray=false;this.options.frequency=0.1;this._num_contacts_shown=0;this._num_query_results=0;j=this.options.include_fb===true;if(this.options.include_team==null){this.options.include_team=true}ft=this.options.include_team===true;i=this.options.include_new_style_groups===true;fu=this.options.include_me===true;this.profile_services=bk.get_linked_profile_services_for_user(this.user.id,this.update_import_contacts_link);this.link_handler=new eg();this._autocompleter_profile_services_item_tmpl=fm.tmpl("autocompleter_item_tmpl");this.listen();this.possible_email_pattern=/[.@_-]/;fv=(function(fx){return function(fy){if(fx.options.include_from_linked_accounts&&fx.options.viewer){fy=fy.includeForViewer(fx.options.viewer)}else{fy=fy.includeForUser(fx.user.id)}if(fx.options.contact_filter){fy=fx.options.contact_filter(fy)}else{if(!j){fy=fy.excludeFacebook()}if(!i){fy=fy.excludeNewStyleGroups()}if(!ft){fy=fy.excludeTeamMembers()}if(!fu){fy=fy.excludeMe()}}return fx.setContacts(fy)}})(this);(function(){var fx;return b0.load_contacts(fx=false,(function(fy){fv(fy);return b0.register_for_updates("autocompleter_contacts",fv)}))}).defer();return this.options.onShow=function(fx,fy){if(!fy.style.position||fy.style.position==="absolute"){fy.style.position="absolute";bF(fy).clonePosition(bF(fx),{setHeight:false,setTop:false,setLeft:false})}return bF(fy).fadeTo(150,1)}},link_callback:function(i){return eg.show_import_notifications(i)},getToken:function(){var i;i=this.getTokenBounds();return this.element.value.substring(i[0],i[1])},listen:function(){var i;this.install_profile_services_link_listener();i=(function(j){return function(T){if(j.profile_services.has_connected_services()){return}if(bF(j.element).val()){return}j.activate();setTimeout(function(){var fr;return(fr=j.get_entry_container())!=null?fr.show():void 0},300);return true}})(this);return bF(this.element).click(i)},install_profile_services_link_listener:function(){var i;Event.stopObserving(this.element,"blur");i=(function(j){return function(fr){var T;T=j.get_entry_container();if(bF(fr.target).hasClass("new-collab-input")&&bF(T).hasClass("people-default-show-import-shmodal-experiment")){return}if(!bF(fr.target).closest("li").hasClass("profile-services-link-handler")){if(bF(T).hasClass("people-default-show-import-shmodal-experiment")){bF(T).removeClass("people-default-show-import-shmodal-experiment");ba.PeopleExperimentsLogger.log(ba.PeopleExperimentsLogger.DEFAULT_SHOW_IMPORT_LINK_DISMISS,j.user.id)}return T!=null?T.hide():void 0}}})(this);bF(this.element).closest(".db-modal-box").click(i);return bF(this.element).closest("#modal-box").click(i)},get_entry_container:function(){var i;return(i=this.element.up(".tokenized_autocompleter_container"))!=null?i.down(".autocomplete"):void 0},profile_services_show:function(){var fr,T,j,i;fr=this.get_entry_container();if(((T=fr.firstChild)!=null?(j=T.firstChild)!=null?j.value:void 0:void 0)>0){this.old_display=fr.style.display}else{this.old_contents="<ul></ul>";this.old_display="none"}this.profile_services_render_buttons();if((i=$("flash_copy_container"))!=null){i.hide()}return this.element.focus()},profile_services_render_buttons:function(){var i;i=this.get_profile_services_button_list();this.hasFocus=true;return this.updateChoices("<ul>"+(i.join(""))+"</ul>")},get_profile_services_button_list:function(){var T,fs,j,fu,ft,fr;fr=[];ft=c7.contact_services();for(fs=0,j=ft.length;fs<j;fs++){fu=ft[fs];cP(this.profile_services.is_updated,"profile_services has not been updated");T="";if(this.profile_services.service_is_connected(fu)){T=eG("Connected")}else{if(this.profile_services.service_was_connected(fu)){T=eG("Reconnect")}}fr.push(this._autocompleter_profile_services_item_tmpl({email_provider_num:fu,email_provider_img:c7.to_img(fu),email_provider_name:c7.to_name(fu),bottom_text:T}).toHTML())}return fr},update_import_contacts_link:(function(i){return function(j){i.profile_services=j;if(i.profile_services.has_unconnected_services(true)){return bF(i.element).closest("form").find(".import-contacts-link").show()}else{return bF(i.element).closest("form").find(".import-contacts-link").hide()}}})(this),hide_containing_modal:function(){this.$hidden_modals=bF(".db-modal-wrapper:visible").first();if(this.$hidden_modals.length){return this.$hidden_modals.css("display","none")}else{this.$hidden_modals=bF("#modal:visible, #modal-overlay:visible");return this.$hidden_modals.hide()}},show_containing_modal:function(){this.$hidden_modals.show();return this.$hidden_modals=null},setContacts:function(i){this.options.array=i.contacts;this.options.larray=i.lcontacts;if(this.active||this.getToken()){return this.getUpdatedChoices()}},getUpdatedChoices:function(){return this.updateChoices(this.options.selector())},selectEntry:function(){var T,j,i;j=this.getCurrentEntry();T=this.options.array[j.value];if(T.type===X.FB||T.type===X.NEW_STYLE_GROUP){j.innerHTML=T.name}else{j.innerHTML=T.email}if(this.options.tokens.length>1){i=this.options.tokens[0]+" "}else{i=""}j.innerHTML+=i;this.active=false;this.updateElement(j);return bF(this.element).trigger("db:autocompleted")}},br=function(i,j){var T;T=bF("<div>");T.addClass(i);if(typeof j==="string"||j instanceof String){T.text(j)}else{T.append(j)}return T},{getNumContactsShown:function(){return this._num_contacts_shown},getNumQueryResults:function(){return this._num_query_results},setOptions:function(j){var i;if(j==null){j={}}i={choices:5,selector:(function(T){return function(){var fu,fJ,fI,fC,fE,fV,fw,f9,ga,fx,fT,f5,fN,f4,fG,fD,fU,fS,f3,fB,f2,f1,fv,fR,fF,fz,fy,f8,fO,fX,fP,fW,fr,f0,f6,fA,fH,fQ,fs,fY,fK,fM,fZ,ft,f7,fL;fK=[];fT=T.getToken().toLowerCase();f1=T.options.array.length;fE=T.options.array;fX=T.options.larray;fY=[];if(fT.indexOf(" ")===-1){fY.push("\\s+")}if(fT.indexOf("+")===-1){fY.push("\\+")}if(fT.indexOf("@")===-1){fY.push("@")}if(fT.indexOf(".")===-1){fY.push("\\.")}if(fT.indexOf("&lt;")===-1){fY.push("&lt;")}fs=RegExp("("+fY.join("|")+")");fU=0;while(fT.length>0&&fU<f1){fC=fE[fU];fO=fX[fU];f5=-1;fx=[];fW=[];fD="";switch(fC.type){case X.EMAIL:fx.push(fC.name,fC.email_snippet);fW.push(fO.name,fO.email);fD="/static/images/icons/mail28-vflHfHPJ0.png";break;case X.FB:fx.push(fC.name);fW.push(fO.name);if(bZ.use_fb_profile_pics){fD="https://graph.facebook.com/"+fO.fb_id+"/picture"}else{fD="/static/images/icons/fb24-vflGnjfAv.png"}break;case X.NEW_STYLE_GROUP:fx.push(fC.name,fC.members);fW.push(fO.name,"");fD="";if(__CIRCULAR_DEPENDENCY__.GroupsListController!=null){fJ=__CIRCULAR_DEPENDENCY__.GroupsListController.string_to_hsl(fC.name);fI=__CIRCULAR_DEPENDENCY__.GroupsListController.get_initials(fC.name);fN=bF("<span class='group-icon'>").css("border-color",fJ).css("color",fJ).text(fI)}break;default:cP(false,"should never get here due to type: "+(fC.type+", "+fC.name+", "+fC.email+", "+fC))}for(fB=f4=0,fF=fW.length;f4<fF;fB=++f4){fP=fW[fB];f6=fY.length?fP.split(fs):[fP];fw=0;for(f3=0,fz=f6.length;f3<fz;f3++){f0=f6[f3];if(!f0){continue}if(f0.indexOf(fT)===0){f5=fw;break}fw+=f0.length}if(f5!==-1){fQ=((fT.length/f0.length)*9.4).toFixed(0);if(fC.sort_key!=null){fQ+=fC.sort_key}fv=document.createTextNode(fx[fB].substr(0,f5));fr=bF("<strong>").text(fx[fB].substr(f5,fT.length));fZ=document.createTextNode(fx[fB].substr(f5+fT.length));fx[fB]=[fv,fr,fZ];break}}if(fC.type===X.FB){fx.push(eG("Facebook message"))}if(f5!==-1){if(fD){fG=bF('<img width="28px" height="28px">').attr("src",fD)}else{if(fN){fG=fN}}fA=br("autocomplete-line",fx[0]);fL=br("autocomplete-line autocomplete-secondary",fx[1]);fR=br("autocomplete-left",fG);ft=br(null,[fA,fL]);f8=bF("<li>").attr("value",fU).append(fR,ft);fK.push([fQ,f8])}fU++}fK.sort(function(gc,gb){if(gc[0]<gb[0]){return 1}else{if(gc[0]>gb[0]){return -1}else{return 0}}});T._num_query_results=fK.length;fK=fK.slice(0,T.options.choices);fM=bF("<ul>");for(f2=0,fy=fK.length;f2<fy;f2++){f7=fK[f2];fM.append(f7[1])}T._num_contacts_shown=fK.length;if(!bF(T.element).hasClass("no-profile-services-link-handler")){if(T.profile_services.has_unconnected_services(true)){fV=bF(T.element).closest(".tokenized_autocompleter_container");fH=fV.attr("data-provider");fS=fH===c7.GOOGLE?eG("Select from your Gmail contacts"):fH===c7.YAHOO?eG("Select from your Yahoo contacts"):eG("Select from your contacts");f9=false;if((fH===c7.GOOGLE||fH===c7.YAHOO)&&!T.profile_services.service_is_connected(fH)){f9=true}else{if(T.profile_services.has_connected_services()){f9=false;fS=eG("Import Contacts")}}if(f9){ga=T._autocompleter_profile_services_item_tmpl({email_provider_num:fH,email_provider_img:c7.to_img(fH),email_provider_name:fS,bottom_text:""}).toHTML();fM.append(ga)}else{fG=cy.make("web","user_add");fA=br("autocomplete-line autocomplete-line-center",fS);fR=br("autocomplete-left",fG);ft=br(null,[fA]);f8=bF("<li>").addClass("profile-services-link-handler").append(fR,ft);fM.append(f8)}}}fu=fM.wrap("<span>").parent().html();T.old_contents=fu;return fu}})(this)};return this.options=Object.extend(i,j)}});var cS;cS=F.Token=Class.create({initialize:function(j,i,T,fr){this.element=$(j);this.token_manager=T;this.hidden_input=i;this.element.token=this;this.selected=false;this.info=fr;return bF(this.element).closest(".tokenized_autocompleter_container").click(this.onclick.bindAsEventListener(this))},select:function(){var i;this.token_manager.token=this;if((i=this.hidden_input)!=null){i.element.activate()}this.selected=true;return this.element.addClassName("token_selected")},deselect:function(){if(this.token_manager.token===this){this.token_manager.token=null}this.selected=false;return this.element.removeClassName("token_selected")},onclick:function(i){if(i&&i.preventDefault){i.preventDefault()}if(this.detect(i)&&!this.selected){return this.select()}else{return this.deselect()}},remove:function(i){return this.token_manager.remove(this)},detect:function(fr){var j,T,i;T=fr.target?fr.target:fr.srcElement;i=T.token;j=T;while((i==null)&&j.parentNode){j=j.parentNode;i=j.token}return(i!=null)&&i.element===this.element}});var R;R=F.TokenManager=Class.create({initialize:function(T,fr,j,i){this.contact_search_logger=i;this.shift_boundary_right_func=fr;this.shift_boundary_left_func=j;this.element=T;this.tokens=[];return this.token=null},add:function(i){this.tokens.push(i);return this.element.fire("token:add",i.info)},populate:function(){var fv,fs,j,fr,T,fu,ft;ft=this.element.select(".token");fr=[];for(fs=0,j=ft.length;fs<j;fs++){fu=ft[fs];fv=fu.hasClassName("token-warn");T=new cS(fu,null,this,{external:fv});fr.push(this.add(T))}return fr},remove:function(j){var i;if(j==null){j=this.token}if(j!=null){this.contact_search_logger.flag_record_as_removed(j.info.value);i=this.tokens.indexOf(j);this.tokens.splice(i,1);j.element.remove();if(this.token===j&&i<this.tokens.length){this.tokens[i].select()}else{this.token=null;if(this.shift_boundary_right_func!=null){this.shift_boundary_right_func()}}return this.element.fire("token:remove",j.info)}},removeAll:function(){var fs,j,fr,T,ft;ft=this.tokens.slice(0);this.tokens.clear();fr=[];for(fs=0,j=ft.length;fs<j;fs++){T=ft[fs];T.element.remove();fr.push(this.element.fire("token:remove",T.info))}return fr},shift_left:function(){var i;i=this.token?this.tokens.indexOf(this.token):this.tokens.length;if(i>0){if(this.token){this.token.deselect()}return this.tokens[i-1].select()}else{if(this.shift_boundary_left_func!=null){return this.shift_boundary_left_func()}}},shift_right:function(){var i;i=this.tokens.indexOf(this.token);if(this.token){this.token.deselect()}if(i+1<this.tokens.length){return this.tokens[i+1].select()}else{if(this.shift_boundary_right_func!=null){return this.shift_boundary_right_func()}}}});var ef;ef=F.HiddenInput=Class.create({initialize:function(i,T,j){this.element=$(i);this.auto_complete_element=T;this.token_manager=j;return Event.observe(this.element,"keydown",this.onKeyPress.bindAsEventListener(this))},onKeyPress:function(i){switch(i.keyCode){case Event.KEY_LEFT:i.preventDefault();this.token_manager.shift_left();break;case Event.KEY_TAB:i.preventDefault();this.token_manager.shift_right();break;case Event.KEY_RIGHT:i.preventDefault();this.token_manager.shift_right();break;case Event.KEY_BACKSPACE:case Event.KEY_DELETE:this.token_manager.remove()}return false}});var cX=[].indexOf||function(fr){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fr){return T}}return -1};Autocompleter.ContactsTokenizer=Class.create(Autocompleter.Contacts,{initialize:function($super,i,fr,ft,T,j){var fs;this.user=i;$super(this.user,fr,ft,j);this.contact_search_logger=new ba.ContactSearchLogger;this.token_manager=new R(this.element,this.generate_shift_boundary_right_func(),null,this.contact_search_logger);this.hidden_input=new ef(T,this.element,this.token_manager);this.textbox_height=0;if(!this.element.hacks){this.element.should_use_borderless_hack=Prototype.Browser.WebKit;this.element.should_use_shadow_hack=Prototype.Browser.IE||Prototype.Browser.Opera;this.element.hacks=true}if(this.element.should_use_borderless_hack||this.element.should_use_shadow_hack){bF(this.element).parent().addClass("tokenizer_input_borderless")}this.options.onShow=function(fu,fv){bF(fv).clonePosition(bF(fu.parentNode.parentNode),{setHeight:false,setTop:false,setLeft:false});return fv.show()};this.options.onHide=function(fu,fv){fv.hide();if(bF(fv).hasClass("people-default-show-import-shmodal-experiment")){return bF(fv).removeClass("people-default-show-import-shmodal-experiment")}};this.max_textbox_height=270;if(j.max_textbox_height!=null){this.max_textbox_height=j.max_textbox_height}this.members=[];if(j.members!=null){this.members=j.members}this.invitees=[];if(j.invitees!=null){this.invitees=j.invitees}this.new_style_groups=[];if(j.new_style_groups!=null){this.new_style_groups=j.new_style_groups}this.contacts_only=false;if(j.contacts_only!=null){this.contacts_only=j.contacts_only}if(eJ.get_url().indexOf("/referrals")!==-1){fs=bF("#retrieve-contacts-button")}else{fs=bF(this.element).closest("form").find(".tokenizer-submit-button")[0]}bF(fs).on("mousedown",this.beforeSubmit.bindAsEventListener(this));bF(this.element).on("focus",this.onFocus.bindAsEventListener(this));this.import_links=[];if(!j.hide_import_contacts){this.import_links=bF(".import-contacts-link")}this.calculate_input_size();this.dynamically_resize_input();this.check_populated();return setInterval(this.check_populated.bind(this),100)},onClick:function(j){var i,T;i=j.findElement("li");this.index=i.autocompleteIndex;T=this.selectEntry();if(!T){return this.hide()}},onBlur:function($super,i){$(this.element.parentNode).removeClassName("focused");this.element.up(".tokenizer").removeClassName("focused");return $super(i)},onFocus:function(i){$(this.element.parentNode).addClassName("focused");return this.element.up(".tokenizer").addClassName("focused")},beforeSubmit:function(i){return this.tokenize_emails_input(true)},clearTokens:function(i){this.token_manager.removeAll();this.calculate_input_size();return this.dynamically_resize_input()},getTokenCount:function(){return this.token_manager.tokens.length},getEmails:function(){var j,i;j=bF(this.element).closest(".tokenized_autocompleter_container").find(".token-valid").find('[name="emails"]');return((function(){var fs,T,fr;fr=[];for(fs=0,T=j.length;fs<T;fs++){i=j[fs];fr.push(bF(i).val())}return fr})()).join(", ")},check_populated:function(){var j,i;j=$(this.element.parentNode);i=(this.element.value==="")&&(this.token_manager.tokens.length===0);if(j.hasClassName("populated")&&i){return j.removeClassName("populated")}else{if(!j.hasClassName("populated")&&!i){return j.addClassName("populated")}}},clean_email_addr:function(ft,fs){var T,fr,j;for(fr=0,j=ft.length;fr<j;fr++){T=ft[fr];fs=fs.sub(T,"")}return fs.strip()},get_regexp_from_delimiters:function(ft){var T,fs,fr,j;fs="";for(fr=0,j=ft.length;fr<j;fr++){T=ft[fr];fs+=T+"|"}return new RegExp("["+fs+"\\r\\n|\\r|\\n|\\t]+")},createTokenInfo:function(fr,T,i){var fs,j;j=true;fs=T;if(i===X.FB){fs=fr}if(i===X.EMAIL&&!ec.validate_email(T)){j=false}else{if(cX.call(this.members,T)>=0){j=false;fs=eG("Already member")}else{if(cX.call(this.invitees,T)>=0){j=false;fs=eG("Already invited")}else{if(i===X.NEW_STYLE_GROUP){if(cX.call(this.new_style_groups,T)>=0){j=false;fs=eG("Already member group")}else{j=true;fs=eG("Group")}}}}}if(T===this.user.email||T===this.user.id){fs=eG("You");j=!this.contacts_only}if(!fr&&T){fr=T.toString()}return{display:fr,value:T,type:i,valid:j,bubble_title:fs}},COMPOUND_EMAIL_REGEX:/([^<>]+)<([^@>]+@[^@>]+)>/,parse_compound_email:function(j){var i,T;i=j.match(this.COMPOUND_EMAIL_REGEX);if(i){T=this.createTokenInfo(i[0],i[2],X.EMAIL);return T}return null},tokenize_emails_input:function(fy,fr){var fE,fw,fs,fC,T,fG,fF,fD,fH,fz,fx,fJ,fI,fv,fB,fA,ft,fK,fu;fw=this.options.tokens;fA=this.get_regexp_from_delimiters(fw);if(this.options.single_token){fC=[this.element.value]}else{fC=this.element.value.split(fA)}fK="";if(!fy){fK=fC[fC.length-1];fB=this.clean_email_addr(fw,fK);fC=fC.slice(0,fC.length-1);if((fv=fK[fK.length-1])===" "||fv===">"){if(fB.match(this.COMPOUND_EMAIL_REGEX)||ec.validate_email(fB)){fC.push(fB);fK=""}}}fE=false;fu=[];if(fC.length>0){for(fG=0,fH=fC.length;fG<fH;fG++){fs=fC[fG];ft=this.parse_compound_email(fs);if(ft!=null?ft.valid:void 0){fE=true;this.set_input_size(1);if(this.addContact(ft)){fJ={sort_variant:b0.sort_variant,context:"legacy_tokenizer",contact_type:X.EMAIL,contact_id:ft.value,contact_name:ft.display,did_select_suggestion:false};this.contact_search_logger.add_record(fJ)}}else{fu.push(fs)}}}fC=fu;if(!this.options.single_token){fI=[];for(fF=0,fz=fC.length;fF<fz;fF++){fs=fC[fF];fI.push.apply(fI,fs.split(" "))}fC=fI}if(fC.length>0){for(fD=0,fx=fC.length;fD<fx;fD++){fs=fC[fD];fs=this.clean_email_addr(fw,fs);if(fs){ft=this.createTokenInfo(fs,fs,X.EMAIL);if(ft.valid){fE=true}else{if(fr){continue}}this.set_input_size(1);if(this.addContact(ft)){fJ={sort_variant:b0.sort_variant,context:"legacy_tokenizer",contact_type:X.EMAIL,contact_id:fs,did_select_suggestion:false};this.contact_search_logger.add_record(fJ)}}}}if(this.element.value!==fK){this.element.value=fK}T=this.element.up("form");if(fE){bT.clear_errors(T)}return this.dynamically_resize_input()},generate_shift_boundary_right_func:function(){var j,i;j=this.element;i=function(){return j.focus()};return i},set_input_size:function(i){if((i==null)||i<0){i=20}return this.element.setStyle({width:i+"px"})},calculate_input_size:function(){if(this.import_links.length){this.import_links_width=this.import_links.width();return this.import_links_visible=this.import_links.is(":visible")}},dynamically_resize_input:function(){var fB,fI,fv,fs,fE,fC,fJ,fG,fu,fw,fF,fH,fr,fA,fz,T,fx,ft,fy,fD;fz=$(this.element.parentNode.parentNode);fx=parseInt(fz.getStyle("width"),10)-15;T=parseInt(fz.getStyle("height"),10);if(T!==this.textbox_height){this.textbox_height=T;if(T>=this.max_textbox_height){fz.setStyle({"overflow-y":"auto"})}else{fz.setStyle({"overflow-y":"hidden"})}}fJ=fx;fB=bF(".tokenizer-link",fz.parentNode);if(fB.length>0){fJ-=fB.width()}fy=this.token_manager.tokens;fw=false;fD=0;for(fE=0,fG=fy.length;fE<fG;fE++){ft=fy[fE];fs=ft.element;fv=parseInt(fs.getStyle("width"),10)+parseInt(fs.getStyle("margin-right"),10);fH=fD+fv;if(fH>fx){fD=fv;fw=true}else{if(fv>fx){fD=0;fw=true}else{fD=fH}}}fF=fJ-fD;fI=this.element.value.length*7;if(fI>fF){fF=fx}this.set_input_size(fF);if(this.import_links.length&&this.import_links_visible){if(fw||fx-fD-fI<1.25*this.import_links_width){this.import_links_visible=false;fr=this.import_links;fA=[];for(fC=0,fu=fr.length;fC<fu;fC++){fs=fr[fC];fA.push(bF(fs).fadeOut(100))}return fA}}},onKeyPress:function(T){var j,i;this.dynamically_resize_input();if(this.active){switch(T.keyCode){case 44:case 188:case 59:case 186:if(!T.shiftKey){if(this.has_selected_contact_importer_entry()||this.has_selected_contact_importer()){this.tokenize_emails_input(true)}}this.reset_observer();return;case Event.KEY_TAB:case Event.KEY_RETURN:if(this.has_selected_profile_services_entry()||this.has_selected_profile_services()){this.tokenize_emails_input(true);this.hide();Event.stop(T);return}this.selectEntry();this.hide();this.active=false;Event.stop(T);return;case Event.KEY_ESC:this.hide();this.active=false;Event.stop(T);return;case Event.KEY_LEFT:case Event.KEY_RIGHT:return;case Event.KEY_UP:this.markPrevious();this.render();Event.stop(T);return;case Event.KEY_DOWN:this.markNext();this.render();Event.stop(T);return}}else{this.tokenize_emails_input(false);if(T.keyCode===Event.KEY_TAB||T.keyCode===Event.KEY_RETURN){if(this.element.value&&T.preventDefault){T.preventDefault()}this.tokenize_emails_input(true);return}else{if(this.element.value===""){if((j=T.keyCode)===Event.KEY_LEFT||j===Event.KEY_BACKSPACE){this.token_manager.shift_left()}}else{if((i=T.keyCode)===Event.KEY_LEFT||i===Event.KEY_RIGHT||i===Event.KEY_UP||i===Event.KEY_DOWN){return}}}}this.update_typeahead();return this.reset_observer()},update_typeahead:function(){this.changed=true;return this.hasFocus=true},reset_observer:function(){if(this.observer){clearTimeout(this.observer)}return this.observer=setTimeout(this.onObserverEvent.bind(this),this.options.frequency*1000)},onObserverEvent:function($super){var T,fs,fr,j,ft,fu;if(this.active){fu=this.element.value;ft=this.options.tokens;for(fr=0,j=ft.length;fr<j;fr++){T=ft[fr];fs=fu.indexOf(T);if(fs!==-1){if(this.has_selected_profile_services_entry()){this.tokenize_emails_input(true);this.hide();return}this.element.value=fu.substr(0,fs);this.selectEntry();this.hide();this.active=false;this.element.value=fu.substr(fs+1);break}}this.update_typeahead()}this.tokenize_emails_input(false);return $super()},has_selected_profile_services:function(i){if(i==null){i=this.getCurrentEntry()}return bF(i).hasClass("profile-services-link-handler")},has_selected_profile_services_entry:function(j){var i;if(j==null){j=this.getCurrentEntry()}return j.value===0&&((i=j.id)!=null?i.length:void 0)!==0},selectEntry:function(){var T,fu,i,fs,fr,ft,fw,fv,j;fu=this.getCurrentEntry();if(this.has_selected_profile_services(fu)){ba.SharedFolderActivityLogger.log("web","import_contacts_button_clicked",this.user);this.profile_services_show();return true}else{if(this.has_selected_profile_services_entry(fu)){ft="suggestion";if(bF(this.get_entry_container()).hasClass("people-default-show-import-shmodal-experiment")){ft=ft+" people-default-show-import-shmodal-experiment";ba.PeopleExperimentsLogger.log(ba.PeopleExperimentsLogger.DEFAULT_SHOW_IMPORT_CLICK,this.user.id,{provider:i})}i=fu.id.split("_")[0];cP((cX.call(c7.contact_services(),i)>=0),"The 'id-value' of an autocompleter-entry is not a valid Third Party contact import service");fv=c7.to_name(i);if(this.profile_services.service_is_connected(i)){ah.success(eG("You're already connected to %(service_name)s").format({service_name:fv}));return}if(cX.call(c7.contact_services(),i)>=0){return this.link_handler.auth_service_with_user(i,this.user.id,((function(fx){return function(fy){return fx.link_callback(fy)}})(this)),ft)}else{return cP(false,"Should never get here. entry_value: "+i)}}else{T=this.options.array[fu.value];fs=T.type===X.FB?T.fb_id:T.type===X.NEW_STYLE_GROUP?T.group_id:T.email;this.set_input_size(1);fw=this.element.value;j=this.createTokenInfo(T.name.strip(),fs,T.type);if(this.addContact(j)){fr={sort_variant:b0.sort_variant,context:"legacy_tokenizer",search_expr:fw,selected_pos:this.index,num_query_results:this.getNumQueryResults(),contact_type:T.type,contact_id:fs,contact_name:T.name.strip(),did_select_suggestion:true};this.contact_search_logger.add_record(fr)}bT.clear_errors(this.element.up("form"));this.dynamically_resize_input();this.index=0;return this.element.focus()}}},addContact:function(ft){var fz,fv,fF,fI,fr,fD,fE,fG,fx,fu,fA,fw,fB,fH,fJ,T,fs,fy,fC;fC=this.token_manager.tokens;for(fF=0,fG=fC.length;fF<fG;fF++){fw=fC[fF];if(ft.value===fw.info.value){return false}}this.element.value="";switch(ft.type){case X.FB:fD="fb_ids";fI=new Element("img",{src:"/static/images/icons/fb_16-vflbiYTkC.png"});break;case X.EMAIL:fD="emails";fI=new Element("img",{src:"/static/images/icons/email_16-vflcFyDTl.png"});break;case X.NEW_STYLE_GROUP:fD="new_style_group_ids";fI=new Element("img",{src:"/static/images/icons/icon_spacer-vflN3BYt2.gif","class":"sprite sprite_groups s_groups_group"});break;case X.INVALID:fD="invalids";fI=new Element("span",{"class":"hidden"});break;default:cP(false,"should never get here due to type: "+ft.type)}fB=this.getTokenClass(ft);fy=bF("<span class='x'>").addClass(fB);fy.on("click",function(i){this.parentNode.parentNode.parentNode.parentNode.parentNode.token.remove(i);return false});fJ=new Element("input",{type:"hidden",name:fD,value:ft.value.toString()});fw=new Element("a",{"class":"title_bubble token "+fB,href:"#",tabindex:"-1",title:ft.bubble_title});fr=new Element("span");if(this.options.wrap_name){T=new Element("div",{"class":"token-display-text"});T.__sert(ft.display);fH=T;fz=1}else{fH=ft.display;fz=0}fu=[fJ,fI,fH];for(fE=0,fx=fu.length;fE<fx;fE++){fv=fu[fE];fr.__sert(fv)}bF(fr).append(fy);fw.__date(new Element("span").__date(new Element("span").__date(new Element("span").__date(fr))));if((fA=$(fw).down(5).next(fz))!=null){fA.innerHTML="&nbsp;"}fs=new cS(fw,this.hidden_input,this.token_manager,ft);this.token_manager.add(fs);this.element.up().__sert({before:fw});return true},getTokenClass:function(i){if(!i.valid){return"token-error"}return"token-valid"},isTeamOnly:function(){return false}});var cX=[].indexOf||function(fr){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fr){return T}}return -1};Autocompleter.TeamTokenizer=Class.create(Autocompleter.ContactsTokenizer,{initialize:function($super,i,fr,fs,T,j){$super(i,fr,fs,T,j);this.warn_only=!j.team_only;this.element.observe("token:remove",this.notifyExternal.bind(this));this.element.observe("token:add",this.notifyExternal.bind(this));this.team_contacts={};this.suspended_contacts={};this.pending_contacts={};return this.reloadContacts(true)},isTeamOnly:function(){return !this.warn_only},setTeamOnly:function(i){this.warn_only=!i;return this.reloadContacts()},reloadContacts:function(i){if(i==null){i=false}return b0.load_contacts(i=i,(function(j){return function(T){return j.setContacts(T)}})(this))},setContacts:function($super,ft){var T,fr,j,fs;this.team_contacts={};this.team_contacts[cQ.get_viewer().work_email]=1;if(!bF(this.element).hasClass("team-admin")){ft=ft.excludeSuspended()}ft=ft.sortByTeamFirst();fs=ft.contacts;for(fr=0,j=fs.length;fr<j;fr++){T=fs[fr];if(T.team&&T.join_state==="active"){this.team_contacts[T.email]=1}if(T.team&&T.join_state==="suspended"){this.suspended_contacts[T.email]=1}if(T.team&&T.join_state==="pending"){this.pending_contacts[T.email]=1}}if(this.options.autocomplete_filter){return $super(this.options.autocomplete_filter(ft))}else{return $super(ft)}},createTokenInfo:function(ft,fr,j){var fv,fu,fs,i,T;T=true;fu=false;fv=fr;i=false;if(j===X.FB){fv=ft}if(j===X.EMAIL&&!ec.validate_email(fr)){T=false}else{if(cX.call(this.members,fr)>=0){T=false;fv=eG("Already member")}else{if(cX.call(this.invitees,fr)>=0){T=false;fv=eG("Already invited")}else{if((this.options.exclude_emails!=null)&&cX.call(this.options.exclude_emails,fr)>=0){T=false;fv=eG("You cannot choose this member")}else{if(j===X.EMAIL&&!this.team_contacts[fr]&&!this.pending_contacts[fr]){T=this.warn_only;fu=true}else{if(j===X.FB){T=this.warn_only;fu=true}else{if(j===X.NEW_STYLE_GROUP){if(cX.call(this.new_style_groups,fr)>=0){T=false;fv=eG("Already member group")}else{T=true;fv=eG("Group")}}}}}}}}if(fr===this.user.email||fr===this.user.id){fv=eG("You");T=!this.contacts_only}if(this.suspended_contacts[fr]){fv=eG("Suspended user");i=true}if(!ft&&fr){ft=fr.toString()}return fs={display:ft,value:fr,type:j,valid:T,external:fu,bubble_title:fv,suspended:i}},getTokenClass:function(i){if(!i.valid){return"token-error"}if(i.suspended){return"token-warn token-suspended"}if(i.external){return"token-warn"}return"token-valid"},notifyExternal:function(j){var i,T,fr;fr=j.memo;if(fr.external){T=this.token_manager.tokens.filter(function(fs){return fs.info.external});i=T?T.length:0;return this.element.fire("sf:token:external",{count:i})}}});var h;h=F.TeamSharedFolderInviteController=(function(){function i(j){var T;this.element=$(j[0]);T=this.element.down(".new-collab-input");T.observe("sf:token:external",this.handle_external.bind(this))}i.prototype.handle_external=function(T){var j,fr;j=T.memo.count;fr=this.element.down(".external-invite-message");if(j>1){dB.fillVal(j,"external-invite-num");if(fr!=null){fr.removeClassName("single")}return fr!=null?fr.show():void 0}else{if(j===1){if(fr!=null){fr.addClassName("single")}return fr!=null?fr.show():void 0}else{return fr!=null?fr.hide():void 0}}};return i})();var am;am=INLINE_JS.SharingModel=F.SharingModel={ALBUM_THUMB_SIZE:260,ALBUM_PADDING:40,THUMBS_BATCH_SIZE:12,filename:null,c2d_vars:{},is_folder:false,is_album:false,gallery_enabled:false,gallery_showing:false,file_viewer_files:[],send_link_autocompleter:null,team_only_shmodel:false,owner_name:null,can_show_upgrade_modal:null,init:function(j,i,T){this.filename=j;this.c2d_vars=i;this.c2d_url=T!=null?T:"/sm/c2d";this.init_logger();bF(".nav-close").on("click",this.close_embedded_fileviewer.bind(this));return on_script_loaded((function(fr){return function(){var fu,ft,fs;ft=$("login-create-an-account");if(ft){ft.writeAttribute("href","/register?signup_tag=shmodel")}scrollTo(1,0);scrollTo(0,0);bF("#download_button_link[data-dl-link]").on("click",fr.download_zip);fr.set_viewport_size();fu=function(fw,fv){return fr.do_c2d(fv.id)};bF("#c2d-modal .login-form").on("db:login:success",fu);bF("#c2d-modal .register-form").on("db:register:success",fu);fs=H.parse(window.location.href);if(fs.getQuery()["force_dl"]){fs.updateQuery({force_dl:0,dl:1});return window.location=fs.toString()}}})(this))},init_folder:function(j,fr,T,i){this.is_folder=true;this.gallery_enabled=j;this.gallery_showing=fr;this.file_viewer_files=T;this.file_view_mode=i;return on_script_loaded((function(fs){return function(){fs.load_thumbs();bF("#gallery-toggle").click(function(){return fs.switch_mode("gallery")});bF("#list-toggle").click(function(){return fs.switch_mode("list")});bF(".file-link").click(function(ft){return fs.open_file_viewer(bF(ft.currentTarget).data("mediaIndex"))});return bF(document).on(aH.FILE_ACTIVITY_UPDATE,function(fu,ft,fv){return bF("[data-file-activity-key='"+fv.activity_key+"']").find(".comment-count-bubble-wrapper").each(function(){var fw;return(fw=this.reactComponent)!=null?fw.setProps({unresolvedCommentCount:fv.unresolvedCommentCount(),unseenCommentCount:fv.unseenCommentCount()}):void 0})})}})(this))},open_file_viewer:function(i){if(!bx.isNumber(i)||i<0){return}n.show(this.file_viewer_files[i],cQ.get_viewer(),{files:this.file_viewer_files,file_view_mode:this.file_view_mode});n.set_preview_url();return false},init_album:function(){this.is_album=true;this._resize_album_view();Event.observe(window,"resize",this._resize_album_view.bind(this));return on_script_loaded((function(i){return function(){return bF("#add_to_my_dropbox_link").on("click",function(){return i.show_c2d_modal()})}})(this))},init_file:function(){this.is_folder=false;if(!this.c2d_vars.subpath&&(this.c2d_vars.item_id==null)&&!this.c2d_vars.is_package){return this.c2d_vars.subpath="/"+this.filename}},get_thumbnail_for_file:function(j){var T,i;i=j.icon.split("_");i.pop();T=i.join("_");return"/static/images/icons128/"+T+".png"},init_logger:function(){on_script_loaded((function(i){return function(){var j;j=$("login-hover-link");if(j){j.observe("click",function(){return aQ.log(aQ.CLICK_SIGN_IN)});j.observe("click",function(){return dR.log("click_sign_in")})}if($("download_button_link")){aQ.attachLogListener(aQ.CLICK_DOWNLOAD,$("download_button_link"))}j=$("add_to_my_dropbox_link");if(j){aQ.attachLogListener(aQ.CLICK_ADD_TO_MY_DROPBOX,j);dR.attachLogListener("click_add_to_my_dropbox",j)}if($$(".remove-link").length){aQ.attachLogListener(aQ.REMOVE_LINK,$$(".remove-link")[0])}if($$(".shmodel-filename").length){aQ.attachLogListener(aQ.CLICK_FILENAME,$$(".shmodel-filename")[0])}j=$("default_content_download_button");if(j){aQ.attachLogListener(aQ.CLICK_DOWNLOAD,j)}j=$("default_content_a2md");if(j){aQ.attachLogListener(aQ.CLICK_ADD_TO_MY_DROPBOX,j)}j=bF("#login-create-an-account")[0];aQ.attachLogListener(aQ.CLICK_SIGNUP_THRU_DEFAULT_DROPDOWN,j);j=bF("#login-hover-cont .login-form")[0];aQ.attachLogListener(aQ.LOGIN_THRU_DEFAULT_DROPDOWN,j);return bF("#share-button").click(function(T){return aQ.log(aQ.CLICK_SHARE)})}})(this));return document.observe(aM.ACTIONS_ADDED,(function(i){return function(){var fs,fr,j,T;T=$("view_original");if(T){aQ.attachLogListener("shmodel_lightbox_click_vieworiginal",T)}fr=$("lightbox_share_link");if(fr){aQ.attachLogListener("shmodel_lightbox_click_getlink",fr)}j=bF("lightbox-share-link");if(j[0]){aQ.attachLogListener("shmodel_lightbox_click_getlink",j[0])}fs=$("lightbox_download_link");if(fs){return aQ.attachLogListener("shmodel_lightbox_click_download",fs)}}})(this))},set_team_only_shmodel:function(j,i){this.team_only_shmodel=j;return this.owner_name=i},_resize_album_view:function(){var i;i=Math.floor((D.viewport_dimensions().width-2*this.ALBUM_PADDING)/this.ALBUM_THUMB_SIZE)*this.ALBUM_THUMB_SIZE;return $("content-wrapper").setStyle({display:"block",width:i+"px"})},load_thumbs:function(){var T,j,fr,i;i=this.gallery_showing?$$(".gallery-icon-view img"):$$(".browse-files .icon");j=false;fr=function(fs){if(!fs.src.endsWith(cy.SPACER)){fs.addClassName("thumbnail")}if(!j){j=true;return en.mark_time_to_interactive()}};T=bs.batch_load_thumbs(i,this.THUMBS_BATCH_SIZE,fr);if(T===0){j=true;return en.mark_time_to_interactive()}},switch_mode:function(fv){var fs,fw,fr,T,fu,j,ft;ft=$A(["gallery","list"]);for(fr=0,T=ft.length;fr<T;fr++){j=ft[fr];fw=$(j+"-view-container");fs=$(j+"-toggle");if(fv===j){fw.show();fs.addClassName("selected")}else{fw.hide();fs.removeClassName("selected")}}if(history.replaceState){fu=window.location.pathname;if(fv==="list"){fu+="?lst"}history.replaceState({},"",fu)}this.gallery_showing=!this.gallery_showing;return this.load_thumbs()},set_viewport_size:function(){var i;if($(document.body).hasClassName("mobile")){i=new Element("meta",{name:"viewport",content:"width = 480"});return document.head.appendChild(i)}},toggle_dropdown:function(fr,fs,T){var i,j;if(fr){Event.extend(fr).preventDefault()}if(!fs.visible()){if(this.is_album){return eZ.show(fs,T,null,true)}else{j=$$(".nav-header").first().getHeight();i=$$(".nav-header .buttons").first().cumulativeOffset().top-4;if(i<0&&ec.ie8){i=4}return eZ.show(fs,T,j-i,true)}}},prepare_confirm_remove_modal:function(j,fr,i,ft,fy,fu,fx,fv){var T,fs,fw;if(i){fw=ft?eG("Unshare?"):eG("Unshare album?");T=bF("#album-disable-token-modal")[0];dB.fillVal(j.escapeHTML(),"album_unshare_name")}else{if(fu){fw=eG("Remove link created by %(name)s").format({name:fx});if(fr){fs=eG('You are removing the link to "%(fname)s" created by <b>%(owner)s</b>.  Once the link is removed, no one else will be able to view this folder.<br/><br/>We\'ll notify <b>%(owner_email)s</b>.  Do you want to continue?')}else{fs=eG('You are removing the link to "%(fname)s" created by <b>%(owner)s</b>.  Once the link is removed, no one else will be able to view this file.<br/><br/>We\'ll notify <b>%(owner_email)s</b>.  Do you want to continue?')}fs=fs.format({fname:bU.em_snippet(j,17),owner:fx,owner_email:fv})}else{fw=eG("Remove link to '%(name)s'").format({name:bU.em_snippet(j,17)});if(fr){fs=eG("Are you sure you want to remove this link? Once the link is removed, nobody else will be able to view this folder.")}else{fs=eG("Are you sure you want to remove this link? Once the link is removed, nobody else will be able to view this file.")}}T=bF("#disable-token-modal")[0];dB.fillVal(fs,"disable-token-desc")}return{title:fw,contents:T}},confirm_remove:function(T,fv,fr,i,fs,fz,fw,fy,fx,fu){var j,ft;if(fr==null){fr=false}if(i==null){i=false}if(fs==null){fs=false}if(fz==null){fz=null}if(fw==null){fw=false}if(fy==null){fy=null}if(fx==null){fx=null}if(fu==null){fu=null}cP(fv,"confirm_remove missing tkey");cP(T,"confirm_remove missing name");cP(fz,"confirm_remove missing user_id");cP(!fw||!i,"admin removal of collections not supported");cP(!fw||fy,"missing link owner name for admin removal");cP(!fw||fx,"missing link owner email for admin removal");if(!cQ.get_viewer().is_uid_signed_in(fz)){bO.show_modal({user_id:fz,on_success:(function(fA){return function(){return fA.confirm_remove(T,fv,fr,i,fs,fz,fw,fy,fx)}})(this)});return}ft=am.prepare_confirm_remove_modal(T,fr,i,fs,fz,fw,fy,fx);am.prepare_upgrade_modal();j=function(){if(typeof fu==="function"){fu()}return am.show_upgrade_modal(T)};return fh.show(ft.title,ft.contents,{token:fv,name:T,is_album:i,user_id:fz,success_callback:j})},show_upgrade_modal:function(j){var i,T;if(am.can_show_upgrade_modal){T=eG("You\u2019ve removed the link to \u2018%(fname)s\u2019");T=T.format({fname:bU.em_snippet(j,17)});i=bF("#share-link-remove-upgrade-modal");if(!(i.length>0)){return}i.on("click",'[data-role="hide"]',function(fr){fr.preventDefault();return fh.hide()});am.can_show_upgrade_modal=false;return fh.show(T,i[0])}},prepare_upgrade_modal:function(){if(am.can_show_upgrade_modal===null){new by(bF("#share-link-remove-upgrade-modal"),"/show_remove_link_upgrade_modal",{success:function(i){var j;j=i.data;return am.can_show_upgrade_modal=j.can_show_upgrade_modal}})}},confirm_remove_from_event_gid:function(i,fw,T,fv,fs,fu,ft,j){var fr;if(fs==null){fs=false}if(fu==null){fu=null}if(ft==null){ft=null}if(j==null){j=null}cP(fw,"confirm_remove missing event gid");cP(i,"confirm_remove missing name");cP(fv,"confirm_remove missing user_id");cP(cQ.get_viewer().is_uid_signed_in(fv),"user not logged in");cP(!fs||fu,"missing link owner name for admin removal");cP(!fs||ft,"missing link owner email for admin removal");fr=am.prepare_confirm_remove_modal(i,T,false,false,fv,fs,fu,ft);return fh.show(fr.title,fr.contents,{name:i,user_id:fv,activity_log_event_gid_dbase64:fw,redirect_to_member_id:j})},do_remove:function(fr){var i,T,j;cP(fr.token||fr.activity_log_event_gid_dbase64,"missing token or event gid_dbase64");i=bF("#modal-content input").first();i.attr("disabled",true);bF("#modal-content").addClass("ajax-loading");j=window.location.pathname;if((j==="/links"||j==="/links/your_links"||j==="/recents")||j.match("^/home|^/work|^/personal")){return new Ajax.DBRequest("/sm/disable/"+fr.token,{subject_user:fr.user_id,onSuccess:(function(fs){return function(){var ft;fh.hide();if(typeof fr.success_callback==="function"){fr.success_callback()}if(fr.is_album){ft=eG("Unshared '%(name)s'")}else{ft=eG("Removed link for '%(name)s'")}ft=ft.format({name:fr.name});ah.success(ft);return document.fire(aH.LINKS_REMOVE,{token:fr.token})}})(this),onComplete:(function(fs){return function(){i.attr("disabled",false);return bF("#modal-content").removeClass("ajax-loading")}})(this)})}else{if(fr.token){T=H({path:"/sm/disable/"+fr.token})}else{T=H({path:"/sm/disable_by_event_gid/"+fr.activity_log_event_gid_dbase64});T.updateQuery("redirect_to_member_id",fr.redirect_to_member_id).toString()}return bT.postRequest(T.updateQuery(a9.UID_PARAM_NAME,fr.user_id).toString())}},show_shmodal_onload:function(T,fr,j,i){if(i==null){i=null}return bF((function(fs){return function(){eJ.remove_query_param("m");if(!cQ.get_viewer().is_uid_signed_in(i)){bO.show_modal({user_id:i,on_success:function(){return fs.show_shmodal_onload(T,fr,j,i)}});return}if((i!=null)&&ea.get_for_user(cQ.get_viewer().get_user_by_id(i)).verified_or_show()){return fs.show_shmodal(T,fr,j,i)}else{if(i==null){cP(cQ.get_viewer().is_paired,"Expected viewer to be paired.");return fs.show_share_shmodel_role_chooser(T,fr,j)}}}})(this))},show_shmodal:function(fw,fC,j,fB){var fA,fy,fz,fx,ft,fs,fv,fu,T,fr;this.url=fw;this.short_url=fC;if(!cQ.get_viewer().is_uid_signed_in(fB)){bO.show_modal({user_id:fB,on_success:(function(i){return function(){return i.show_shmodal(i.url,i.short_url,j,fB)}})(this)});return}fr=cQ.get_viewer().get_user_by_id(fB);if(ea.get_for_user(fr).verified_or_show()){fu="shmodal-user-"+fB;fh.show(this._get_shmodal_title(fr.is_team),dB.fromElm($(fu)));ft={};ft[a9.UID_PARAM_NAME]=fB;bT.add_vars("shmodal-send-form",ft);if(this._get_thumbnail_type()){T=$$(".shmodal-image");for(fs=0,fv=T.length;fs<fv;fs++){fx=T[fs];fx.addClassName("thumbnail")}}if(j==="contacts"){fz=Autocompleter.ContactsTokenizer}else{fz=Autocompleter.TeamTokenizer}this.send_link_autocompleter=new fz(fr,fu+"-new-collab-input",fu+"-new-whobulk",fu+"-hidden-input",{tokens:[",",";"],include_fb:true,include_team:true,team_only:j==="team_only",user_id:fB});this.configure_dropdown();if(!this.disabled){if(FlashDetect.installed){fA=t.clipboard_overlay(this.url,bF("#"+fu+"-copy-link"),am.copied_to_clipboard);fA.css({position:"fixed",zIndex:1001});fA.children().height(fA.height());clearInterval(this.follow_freshbutton);fy=(function(i){return function(){return fA.clonePosition(bF("#"+fu+"-copy-link"),{offsetHeight:6,offsetWidth:6})}})(this);this.follow_freshbutton=setInterval(fy,500)}else{$(fu+"-copy-link").hide()}}ck._create($("modal").down(".custom-message-container"));ck._create($("modal").down(".fb-post-sickinput"));ck._create($("modal").down(".twitter-post-sickinput"));this._populate_twitter_info(this.short_url,fB);$(fu+"-new-collab-input").focus();return aQ.log("shmodal_show")}},configure_dropdown:function(){var ft,fr,j,fs,T;fs=$$(".dropdown-menu-container");for(fr=0,j=fs.length;fr<j;fr++){ft=fs[fr];T=ft.down(".dropdown-menu-trigger");if(T!=null){T.observe("click",(function(i){return function(fv){var fu;fu=fv.target.up(".dropdown-menu-container");return fu.toggleClassName("dropdown-shown")}})(this))}}return document.on("click",(function(i){return function(fz){var fy,fw,fv,fu,fx;if(fz.target.hasClassName("dropdown-menu-trigger")||fz.target.up(".dropdown-menu-trigger")){return}fu=$$(".dropdown-shown");fx=[];for(fw=0,fv=fu.length;fw<fv;fw++){fy=fu[fw];fx.push(fy.removeClassName("dropdown-shown"))}return fx}})(this))},copied_to_clipboard:function(){ah.success(eG("Link copied to clipboard"));fh.hide();aQ.log("shmodal_copy_link");return ba.ViralLogger.log(cQ.get_viewer().get_user_ids(),"shmodel","send",{src:"shmodel_copy_link",file_type:am.is_album?"collection":am.is_folder?"folder":am.filename.indexOf(".")===-1?"file":cW.EXTENSION_TO_CATEGORY[aA.file_extension(am.filename).toLowerCase()]||"file"})},get_shmodel_send_recipients:function(fr){var fs,fB,fz,fx,fC,fD,fw,fy,fv,fu,fA,T,ft;cP(fr,"Must pass the shmodal send form into get_shmodel_send_recipients");fs=fr.select('input[name="emails"]');fB=fr.select('input[name="fb_ids"]');fz=fr.select('input[name="group_ids"]');fu=fr.select('input[name="new_style_group_ids"]');T=[];ft=[fs,fB,fz,fu];for(fx=0,fy=ft.length;fx<fy;fx++){fD=ft[fx];for(fw=0,fv=fD.length;fw<fv;fw++){fC=fD[fw];fA=fC.up().innerHTML.stripTags().escapeHTML();T.push(fA.substring(0,fA.indexOf("&")))}}return T},close_embedded_fileviewer:function(j){var i;j.preventDefault();i=new ez();i.configureParentMessaging(function(){},["parent-ready"]);i.startListening();return i.postMessageToParent("close-fileviewer")},send_shmodel_link:function(fr){var T,j,fs,i;T=$("shmodal-send-form");cP(T,"Couldn't find the shmodal send form.");i=this.get_shmodel_send_recipients(T);fs=(function(ft){return function(fu){var fv;fv=aZ.success_string_for_recipients(i);ah.success(fv);fh.hide();return aQ.log("shmodal_send")}})(this);j=(function(ft){return function(fu){return bT.remove_loading()}})(this);return bT.ajax_submit(T,"/sm/share",fs,j,T.down(".tokenizer-submit-button"))},show_content:function(T){var fr,j,fs,ft;$("shmodal-title-text").__date(dx.to_title_str(T));fs=dx.list;for(fr=0,j=fs.length;fr<j;fr++){ft=fs[fr];if(ft!==T){$(dx.to_toggle_str(ft)).removeClassName("toggled");$(dx.to_content_str(ft)).hide()}}$(dx.to_content_str(T)).show();$(dx.to_toggle_str(T)).addClassName("toggled");return bF("#modal .focusarea").focus()},show_send_content:function(){return this.show_content(dx.SEND)},show_fb_content:function(){return this.show_content(dx.FB)},show_twitter_content:function(){return this.show_content(dx.TWITTER)},start_fb_post:function(fs,j){var ft,T,i,fr;T=(function(fu){return function(){return ew.do_auth(fu.do_fb_post.curry(fs,j),j)}})(this);ft=bF("#modal:visible, #modal-overlay:visible");i=function(){return ft.show()};if(ew.authed_user_id===j){return this.do_fb_post(fs,j)}else{if(cQ.get_viewer().is_uid_associated(ew.authed_user_id)){ft.hide();fr=new ek(cQ.get_viewer().get_user_by_id(j),i,T.bind(this));return fr.show()}else{return T()}}},start_twitter_post:function(i){if(cI.is_authed(i)){return this.do_twitter_post(i)}else{return cI.do_auth(this.do_twitter_post,i)}},do_fb_post:function(j,i){ew.custom_show_posting=function(){return bT.add_loading($("shmodal-fb-post-submit"))};ew.custom_show_complete=function(){fh.hide();ah.success(eG("Successfully posted to Facebook"));aQ.log("shmodal_fb_post");return ba.ViralLogger.log(cQ.get_viewer().get_user_ids(),"shmodel","send",{src:"shmodel_fb_post",file_type:am.is_album?"collection":am.is_folder?"folder":am.filename.indexOf(".")===-1?"file":cW.EXTENSION_TO_CATEGORY[aA.file_extension(am.filename).toLowerCase()]||"file"})};return ew.post($F("shmodal-fb-post-input"),j,null,null,null,function(){return fh.hide()},i)},do_twitter_post:function(i){var j;j=$F("shmodal-twitter-post-input");if(!j){ah.error(eG("Please enter a Twitter post"));return}else{if(j.length>140){ah.error(eG("Your post must be 140 characters or less"));return}}cI.custom_show_posting=function(){$("twitter-chars").hide();return bT.add_loading($("shmodal-twitter-post-submit"))};return cI.custom_post(j,(function(T){return function(){fh.hide();ah.success(eG("Successfully posted to Twitter"));aQ.log("shmodal_tweet");return ba.ViralLogger.log(cQ.get_viewer().get_user_ids(),"shmodel","send",{src:"shmodel_twitter",file_type:am.is_album?"collection":am.is_folder?"folder":am.filename.indexOf(".")===-1?"file":cW.EXTENSION_TO_CATEGORY[aA.file_extension(am.filename).toLowerCase()]||"file"})}})(this),i)},_get_shmodal_title:function(i){if(i==null){i=false}return this.generate_title_content(this._get_shmodal_title_text(),((function(j){return function(){return j.show_send_content()}})(this)),((function(j){return function(){return j.show_fb_content()}})(this)),((function(j){return function(){return j.show_twitter_content()}})(this)),i)},generate_title_content:function(j,fw,ft,fy,fr){var fs,fu,i,fx,T,fv;if(fr==null){fr=false}fx=bF("<div/>",{id:"shmodal-title"});T=bF("<div/>",{id:"shmodal-title-text",text:j});fx.append(T);if(!fr){i=bF("<a/>",{id:"shmodal-send-toggle","class":"freshtoggle ft-left toggled"});i.html(cy.make("web","email_20"));i.on("click",fw);fu=bF("<a/>",{id:"shmodal-fb-toggle","class":"freshtoggle ft-middle"});fu.html(cy.make("web","fb_20"));fu.on("click",ft);fv=bF("<a/>",{id:"shmodal-twitter-toggle","class":"freshtoggle ft-right"});fv.html(cy.make("web","twitter_20"));fv.on("click",fy);fx.append([i,fu,fv])}fs=bF("<div/>",{"class":"clear"});fx.append(fs);return fx[0]},_get_shmodal_title_text:function(){var j,i;if(this.is_folder){j=eG("Share link to \u2018%(folder_name)s\u2019");return j=j.format({folder_name:bU.em_snippet(this.filename,15)})}else{i=this._get_thumbnail_type();if(i===cW.CATEGORY_TO_TRANSLATION.IMAGE){return eG("Share this image")}else{if(i===cW.CATEGORY_TO_TRANSLATION.VIDEO){return eG("Share this video")}else{return eG("Share '%(filename)s'").format({filename:bU.em_snippet(this.filename,18)})}}}},_get_thumbnail_type:function(){var j,i;if(this.filename.indexOf(".")===-1){return false}i=aA.file_extension(this.filename).toLowerCase();j=cW.EXTENSION_TO_CATEGORY[i];if(j&&(j==="IMAGE"||j==="VIDEO")){return cW.CATEGORY_TO_TRANSLATION[j]}return false},_populate_twitter_info:function(T,i){var fr,j;fr=this.is_folder?eG("Just shared some files using @Dropbox"):(j=this._get_thumbnail_type(),j&&j===cW.CATEGORY_TO_TRANSLATION.IMAGE?eG("Just shared an image using @Dropbox"):eG("Just shared a file using @Dropbox"));$("shmodal-twitter-post-input").setValue(fr+" "+T);ec._track_twitter_chars_left("shmodal-twitter-post-input",140);if(cI.is_authed(i)){return cI.get_user_info(function(fs){$("shmodal-twitter-profile").down(".profile-pic").__date(new Element("img",{src:fs.profile_image_url_https}));$("shmodal-twitter-profile").down(".name").__date(fs.name);$("shmodal-twitter-profile").down(".username").__date("@"+fs.screen_name);$("modal").down(".twitter-post-sickinput").addClassName("shrank");return $("shmodal-twitter-profile").show()},i)}},download_zip:function(fr){var j,T,fs,i,ft;j=bF("#download_button_link").attr("data-dl-link");ft=bF("#download_button_link").attr("data-test-link");i=bF("#download_button_link").attr("data-owner")==="true";fs=(function(fu){return function(fv){var fw;if(fv==="OK"){window.location=j}else{if(fv.indexOf("err:")===0){if(i){fw=eG("The zip file is too large.")}else{fw=eG("The zip file is too large. Please add it to your Dropbox.")}ah.error(fw)}else{ah.error(eG("Failed to download zip file."))}}return false}})(this);T=(function(fu){return function(fv){ah.error(eG("Failed to download zip file."));return false}})(this);if(ft&&bF.support.cors===true){bF.ajax({url:ft,type:"POST",success:fs,error:T})}else{window.location=j}return false},show_share_shmodel_role_chooser:function(j,T,i){if(this.shmodel_select_role_modal==null){this.shmodel_select_role_modal=new dG({element_id:"share-shmodel-select-role-modal",link_url:j,short_url:T,tokenizer_type:i})}return this.shmodel_select_role_modal.show().set_title(this._get_shmodal_title_text())},prompt_login_then_share:function(j,T,i,fs){var fr;fr=(function(ft){return function(){var fu;fh.hide();bF("#role-selector option").removeClass("disabled");fu=cQ.get_viewer().get_uid_by_role(fs);cQ.get_viewer().sign_in_user_by_id(fu);ba.ShmodelUILogger.log("via-shmodel-viewer");return am.show_shmodal(j,T,i,fu)}})(this);if(!cQ.get_viewer().is_role_signed_in(fs)){return bO.show_modal({role:fs,on_success:fr})}else{return fr()}},show_c2d_modal:function(fu,j){var ft,i,fs,T,fr;if(fu==null){fu=""}if(j==null){j=false}if(fu){if(fu===Constants.ROLE_PERSONAL){cP(this.team_only_shmodel!=="forbid","Can't copy to personal Dropbox if restricted")}if(!cQ.get_viewer().is_role_signed_in(fu)){bO.show_modal({role:fu,on_success:(function(fv){return function(){return fv.show_c2d_modal(fu)}})(this)});return}}else{if(cQ.get_viewer().is_paired){new aT({element_id:"select-role-modal"}).show();return}}ba.WebMiscActivityLogger.log("show-c2d-modal",{filename:this.filename,auth_google:bF.find(".auth-google")!=null});if(fu){T="#c2d-modal-"+fu}else{T="#c2d-modal"}fr=this._c2d_modal_msg(fu,cQ.get_viewer().team_name);ft=this._c2d_modal_button_msg(fu,cQ.get_viewer().team_name);i=this._c2d_modal_desc(fu,cQ.get_viewer().team_name);if(j){i=this._c2d_modal_team_only_desc(cQ.get_viewer().team_name)+"<br/><br/>"+i}fs=this._c2d_modal_login_desc(fu,cQ.get_viewer().team_name);dB.fillVal(i,"c2d-desc");dB.fillVal(fs,"c2d-login-desc");bF(".c2d-submit-button").val(ft);bF(".c2d-login-register-desc").hide();if(this.is_album){bF(".c2d-login-register-album-desc").show()}else{if(this.is_folder){bF(".c2d-login-register-folder-desc").show()}else{bF(".c2d-login-register-file-desc").show()}}return fh.show(fr,bF(T)[0],false,false,false,false)},_c2d_modal_msg:function(fr,j){var i,T;if(fr==null){fr=""}if(j==null){j=""}if(this.c2d_vars.title){return T=this.c2d_vars.title}else{if(fr===Constants.ROLE_PERSONAL){T=eG("Save '%(filename)s' to my personal Dropbox");return T.format({filename:bU.em_snippet(this.filename,10)})}else{if(fr===Constants.ROLE_WORK){T=eG("Save '%(filename)s' to my %(team_name)s Dropbox");i=Math.max(10,15-new bU(j).length);return T.format({filename:bU.em_snippet(this.filename,i),team_name:j})}else{T=eG("Save '%(filename)s' to my Dropbox");return T.format({filename:bU.em_snippet(this.filename,15)})}}}},_c2d_modal_button_msg:function(T,i){var j;if(T==null){T=""}if(i==null){i=""}if(T===Constants.ROLE_PERSONAL){return j=eG("Save to my personal Dropbox")}else{if(T===Constants.ROLE_WORK){j=eG("Save to my %(team_name)s Dropbox");return j.format({team_name:i})}else{return eG("Save to my Dropbox")}}},_c2d_modal_team_only_desc:function(i){var j;if(this.is_album){j=eG("You can only add this album to your <b>%(team_name)s Dropbox</b> because <b>%(owner_name)s</b> has restricted the album to members of <b>%(team_name)s</b>.")}else{if(this.is_folder){j=eG("You can only add this folder to your <b>%(team_name)s Dropbox</b> because <b>%(owner_name)s</b> has restricted the folder to members of <b>%(team_name)s</b>.")}else{j=eG("You can only add this file to your <b>%(team_name)s Dropbox</b> because <b>%(owner_name)s</b> has restricted the file to members of <b>%(team_name)s</b>.")}}return j.format({owner_name:this.owner_name,team_name:i})},_c2d_modal_desc:function(T,i){var j;if(T==null){T=""}if(i==null){i=""}if(T===Constants.ROLE_PERSONAL){if(this.is_album){if(this.team_only_shmodel==="warn"){j=eG("The photos and videos in this album were sent from <b>%(owner_name)s</b> on your <b>%(team_name)s</b> team.  Are you sure you want to copy them to your personal Dropbox?");return j.format({owner_name:this.owner_name,team_name:i})}else{return j=eG("The photos and videos in this album will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}else{if(this.is_folder){if(this.team_only_shmodel==="warn"){j=eG("This folder was sent from <b>%(owner_name)s</b> on your <b>%(team_name)s</b> team.  Are you sure you want to copy it to your personal Dropbox?");return j.format({owner_name:this.owner_name,team_name:i})}else{return j=eG("This folder will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}else{if(this.team_only_shmodel==="warn"){j=eG("This file was sent from <b>%(owner_name)s</b> on your <b>%(team_name)s</b> team.  Are you sure you want to copy it to your personal Dropbox?");return j.format({owner_name:this.owner_name,team_name:i})}else{return j=eG("This file will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}}}else{if(T===Constants.ROLE_WORK){if(this.is_album){j=eG("The photos and videos in this album will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{if(this.is_folder){j=eG("This folder will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{j=eG("This file will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}}return j.format({team_name:i})}else{if(this.is_album){return eG("The photos and videos in this album will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}else{if(this.is_folder){return eG("This folder will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}else{return eG("This file will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}}}}},_c2d_modal_login_desc:function(T,i){var j;if(T==null){T=""}if(i==null){i=""}if(T===Constants.ROLE_PERSONAL){if(this.is_album){return j=eG("Once you sign in to your personal Dropbox, the photos and videos in this album will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}else{if(this.is_folder){return j=eG("Once you sign in to your personal Dropbox, this folder will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}else{return j=eG("Once you sign in to your personal Dropbox, this file will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}}else{if(T===Constants.ROLE_WORK){if(this.is_album){j=eG("Once you sign in to your %(team_name)s Dropbox, the photos and videos in this album will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{if(this.is_folder){j=eG("Once you sign in to your %(team_name)s Dropbox, this folder will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{j=eG("Once you sign in to your %(team_name)s Dropbox, this file will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}}return j.format({team_name:i})}}},do_c2d:function(i){var j;cP(i,"Must specify a user_id for saving to Dropbox.");j=eG("Saving to your Dropbox...");if(cQ.get_viewer().is_paired){if(cQ.get_viewer().get_user_by_id(i).is_team){j=eG("Saving to your %(team_name)s Dropbox...");j=j.format({team_name:cQ.get_viewer().team_name})}else{j=eG("Saving to your personal Dropbox...")}}ah.success(j);fh.hide();return new Ajax.DBRequest(this.c2d_url,{parameters:this.c2d_vars,job:this.is_folder,progress_text:j,subject_user:i,onSuccess:(function(T){return function(fr){if(fr.responseText){return b1.redirect(fr.responseText)}}})(this)})},c2d_show_twofactor_error:function(j){var i;i=$("c2d-twofactor-error");i.__date(j);return i.show()},c2d_hide_twofactor_error:function(i){return $("c2d-twofactor-error").__date()},c2d_show_twofactor_error500:function(){return this.c2d_show_twofactor_error(eG("Sorry, an error occured. Please try again later."))},c2d_show_twofactor_error_bad_carrier:function(){return this.c2d_show_twofactor_error(eG("Unfortunately, your carrier isn\u2019t supported at this time."))},c2d_show_twofactor_error_invalid_number:function(){return this.c2d_show_twofactor_error(eG("That isn\u2019t a valid phone number."))},c2d_show_twofactor_error_not_a_mobile:function(){return this.c2d_show_twofactor_error(eG("That phone number doesn\u2019t appear to be a valid mobile number."))},c2d_show_twofactor_error_unreachable:function(){return this.c2d_show_twofactor_error(eG("We couldn't reach your phone number. Are you sure it's correct?"))},c2d_show_twofactor_error_invalid:function(){return this.c2d_show_twofactor_error(eG("Invalid code."))},c2d_is_resending:function(){return $("c2d-resend-link").hasClassName("resending")},c2d_show_resending:function(){return $("c2d-resend-link").addClassName("resending")},c2d_hide_resending:function(){return $("c2d-resend-link").removeClassName("resending")},c2d_hide_resending_with_delay:function(){return setTimeout(this.c2d_hide_resending.bind(this),3000)}};var dx;dx=F.ShmodalPanes={SEND:0,FB:1,TWITTER:2,list:[0,1,2],_content_str:["shmodal-send-content","shmodal-fb-content","shmodal-twitter-content"],_toggle_str:["shmodal-send-toggle","shmodal-fb-toggle","shmodal-twitter-toggle"],_title_str:["Share by Email",eG("Share on Facebook"),eG("Share on Twitter")],to_content_str:function(i){return this._content_str[i]},to_toggle_str:function(i){return this._toggle_str[i]},to_title_str:function(i){if(i===0){return am._get_shmodal_title_text()}return this._title_str[i]},to_focus_str:function(i){return this._focus_str[i]}};var aa,dm,bL,b3=function(i,j){return function(){return i.apply(j,arguments)}},fi=function(fr,j){for(var i in j){if(dq.call(j,i)){fr[i]=j[i]}}function T(){this.constructor=fr}T.prototype=j.prototype;fr.prototype=new T();fr.__super__=j.prototype;return fr},dq={}.hasOwnProperty;dm=INLINE_JS.ShareLinkModal=F.ShareLinkModal=(function(i){fi(j,i);function j(T,ft,fr,fv,fu){var fs,fw;this.user_id=T;if(fv==null){fv=false}if(fu==null){fu=void 0}this.before_show=b3(this.before_show,this);this.show=b3(this.show,this);this.prompt_login_then_show=b3(this.prompt_login_then_show,this);fw={origin:fr};fw[a9.UID_PARAM_NAME]=this.user_id;if(fu){fs=H({path:"/sm/get_link_modal_content/"+fu}).toString()}else{fs=H({path:"/sm/share_link"+ft}).toString()}j.__super__.constructor.call(this,{element_id:"share-link-modal",endpoint_url:fs,parameters:fw})}j.prototype.prompt_login_then_show=function(){var T;T=(function(fr){return function(){fh.hide();bF("#role-selector option").removeClass("disabled");cQ.get_viewer().sign_in_user_by_id(fr.user_id);ba.ShmodelUILogger.log("via-shmodel-viewer");return fr.show()}})(this);if(!cQ.get_viewer().is_uid_signed_in(this.user_id)){return bO.show_modal({user_id:this.user_id,on_success:T})}else{return T()}};j.prototype.show=function(){var T;T=cQ.get_viewer().get_user_by_id(this.user_id);if(ea.get_for_user(T).verified_or_show(ex.SHMODAL)){return j.__super__.show.call(this)}};j.prototype.before_show=function(){var ft,fs,T,fr;fr=this.$modal_window.find(".share-link-modal-content").length;if(fr){ft={"class":"ajax-loading-indicator",src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"};T=bF("<img />",ft);fs=bF("<div />",{"class":"loading-spinner"}).append(T);return this.$modal_window.find(".dynamic-content").html(fs)}};return j})(cF);bL=F.ShareLinkModalContent=(function(){function i(ft,fw,fB,fx,j,fv,T,fA,fs,fy){var fr,fu,fz,fC;this.owner_id=ft;this.tkey=fw;this.fq_path=fB;this.link=fx;this.filename=j;this.is_dir=fv;this.tokenizer_type=T;this.tokenizer_ctx_str=fA;this.fq_path_of_restricting_sf=fy;this._send_link=b3(this._send_link,this);this._show_shared_link_remove_confirm_modal=b3(this._show_shared_link_remove_confirm_modal,this);this._show_shared_link_settings_modal=b3(this._show_shared_link_settings_modal,this);this._show_shared_folder_settings_modal=b3(this._show_shared_folder_settings_modal,this);this._select_all_text=b3(this._select_all_text,this);this._toggle_send_link_button=b3(this._toggle_send_link_button,this);this._toggle_recipients_outside_team_warning=b3(this._toggle_recipients_outside_team_warning,this);this._toggle_close_button_text=b3(this._toggle_close_button_text,this);this._add_message_checkbox_changed=b3(this._add_message_checkbox_changed,this);this._toggle_comment_option=b3(this._toggle_comment_option,this);this._listen=b3(this._listen,this);this._init_autocompleter=b3(this._init_autocompleter,this);this.$content=bF(".share-link-modal-content");this.modal=ed.get_containing_modal(this.$content);if(!this.modal){return}if(this.tokenizer_type==="shared_folder"){this.shared_folder_members=o.create_contacts_list(fs)}fz={filename:this.filename,fq_path:this.fq_path,tkey:this.tkey,user_id:this.owner_id};document.fire(aH.LINKS_ADD,fz);this.modal.set_title(eG("Share link to \u2018%(filename)s\u2019").format({filename:bU.em_snippet(this.filename,15)}));this.collab_input_id=this.tokenizer_ctx_str+"-new-collab-input";this.$collab_input=this.$content.find("#"+this.collab_input_id);this.$send_link_button=this.$content.find(".confirm-button");this.$share_link_url_input=this.$content.find(".copy-link-input-container input[type='text']");this.$cancel_button=this.$content.find(".cancel-button");this.$custom_message_textarea=this.$content.find("#share-link-modal-custom-message");this.$comment_option_container=this.$content.find(".add-message-as-comment-container");this._init_autocompleter();this._listen();if((fr=this.$share_link_url_input[0])!=null){fr.select()}if(((fu=az.getGandalfRule("people-link-profile-on-share-experiment"))===null||fu==="CONTROL")&&az.isGandalfInVariant("people-default-show-import-shmodal-experiment","EXPERIMENT")&&this.tokenizer_type!=="shared_folder"){fC=(function(fD){return function(fG){var fF,fH,fE;fF=bF(fD.autocompleter.element).closest(".tokenized_autocompleter_container");fH=fF.attr("data-provider");fD.autocompleter.activate();bF(fD.autocompleter.get_entry_container()).addClass("people-default-show-import-shmodal-experiment");if(((fE=fF.find("[id*='_autocompleter_entry']"))!=null?fE.length:void 0)>0){return ba.PeopleExperimentsLogger.log(ba.PeopleExperimentsLogger.DEFAULT_SHOW_IMPORT_SHOW,fD.owner_id,{provider:fH})}}})(this);bk.get_linked_profile_services_for_user(this.owner_id,fC)}}i.prototype._init_autocompleter=function(){var j,T;j={tokens:[",",";"],include_fb:true,include_team:true,team_only:this.tokenizer_type==="team_only",user_id:this.owner_id};if(this.tokenizer_type==="shared_folder"){this.autocompleter=new Autocompleter.SharedFolderTokenizer(cQ.get_viewer().get_user_by_id(this.owner_id),this.collab_input_id,this.tokenizer_ctx_str+"-new-whobulk",this.tokenizer_ctx_str+"-hidden-input",j,this.shared_folder_members)}else{if(this.tokenizer_type==="contacts"){this.autocompleter=new Autocompleter.ContactsTokenizer(cQ.get_viewer().get_user_by_id(this.owner_id),this.collab_input_id,this.tokenizer_ctx_str+"-new-whobulk",this.tokenizer_ctx_str+"-hidden-input",j)}else{this.autocompleter=new Autocompleter.TeamTokenizer(cQ.get_viewer().get_user_by_id(this.owner_id),this.collab_input_id,this.tokenizer_ctx_str+"-new-whobulk",this.tokenizer_ctx_str+"-hidden-input",j)}}T=(function(fr){return function(fs){return function(){return fr.autocompleter.contact_search_logger.log_records(fr.owner_id,fs)}}})(this);this.modal.logger_keydown_close_handler=T(true);this.modal.$overlay.on("click",T(true));this.modal.$db_modal_x.on("click",T(true));this.$send_link_button.on("click",T(false));this.$cancel_button.on("click",T(true));ck.init();return this.$collab_input.focus()};i.prototype._listen=function(){var fs,fr,T,j,fu,ft;this.$send_link_button.on("click",this._send_link);this.$share_link_url_input.on("click",this._select_all_text);this.$cancel_button.on("click",(function(fv){return function(fw){return d7.pop()}})(this));this.$content.find("#shared-link-permissions-link").on("click",this._show_shared_link_settings_modal);this.$content.find("#shared-folder-options-link").on("click",this._show_shared_folder_settings_modal);this.$content.find("#shared-link-delete-link").on("click",this._show_shared_link_remove_confirm_modal);if(this.$comment_option_container.length>0){this.$custom_message_textarea.on("input",this._toggle_comment_option);this.$comment_option_container.find("#add-message-as-comment").on("change",this._add_message_checkbox_changed)}if((fs=this.$collab_input)!=null){fs.keyup(this._toggle_send_link_button)}if((fr=this.$collab_input)!=null){fr.on("input",this._toggle_send_link_button)}if((T=this.$collab_input[0])!=null){T.observe("token:remove",this._toggle_send_link_button)}if((j=this.$collab_input[0])!=null){j.observe("token:add",this._toggle_close_button_text)}if((fu=this.$collab_input[0])!=null){fu.observe("token:remove",this._toggle_close_button_text)}return(ft=this.$collab_input[0])!=null?ft.observe("sf:token:external",this._toggle_recipients_outside_team_warning):void 0};i.prototype._toggle_comment_option=function(T){var j;j=this.$custom_message_textarea.val().length;if(j>0){return this.$comment_option_container.css("visibility","visible")}else{return this.$comment_option_container.css("visibility","hidden")}};i.prototype._add_message_checkbox_changed=function(j){return cG.WebRequest({url:"/file_activity/set_share_modal_checkbox_preference",data:{fq_path:this.fq_path,checked:j.currentTarget.checked},subject_user:this.owner_id})};i.prototype._toggle_close_button_text=function(fr){var T,j;j=((T=this.autocompleter)!=null?T.token_manager.tokens.length:void 0)===0;if(j){return this.$cancel_button.text(eG("Close"))}else{return this.$cancel_button.text(eG("Cancel"))}};i.prototype._toggle_recipients_outside_team_warning=function(fr){var j,T;j=bF(".external-recipient-warning-message");if(j.length){T=fr.memo.count;if(fr.memo.shared_folder_warning){if(T>0){return j.show()}else{return j.hide()}}else{if(T>1){j.find(".external-recpient-num").text(T);return j.removeClass("single").show()}else{if(T===1){return j.addClass("single").show()}else{return j.hide()}}}}};i.prototype._toggle_send_link_button=function(fr){var T,j;j=((T=this.autocompleter)!=null?T.token_manager.tokens.length:void 0)===0;j=j&&bF.trim(this.$collab_input.val())==="";return this.$send_link_button.prop("disabled",j)};i.prototype._select_all_text=function(j){return bF(j.currentTarget)[0].select()};i.prototype._show_shared_folder_settings_modal=function(T){var j;T.preventDefault();j=cQ.get_viewer().get_user_by_id(this.owner_id);return s.show_shared_folder_options_modal(this.fq_path_of_restricting_sf,j)};i.prototype._show_shared_link_settings_modal=function(T){var j;T.preventDefault();j=new d3(this.owner_id,this.tkey);return d7.push(j)};i.prototype._show_shared_link_remove_confirm_modal=function(T){var j;T.preventDefault();j=function(){d7.pop();return bF(document).trigger(aH.LINKS_REMOVE)};return am.confirm_remove(this.filename,this.tkey,this.is_dir,false,false,this.owner_id,false,null,null,j)};i.prototype._send_link=function(ft){var fr,T,fs,j,fu;fs=this.$content.find(".share-link-modal-send-form")[0];j=this.get_shmodel_send_recipients(fs);fu=(function(fv){return function(fw){var fx;fx=aZ.success_string_for_recipients(j);ah.success(fx);d7.pop();return aQ.log("shmodal_send")}})(this);T=(function(fv){return function(fw){return bT.remove_loading()}})(this);fr=this.$content.find(".tokenizer-submit-button")[0];return bT.ajax_submit(fs,"/sm/share",fu,T,fr)};i.prototype.get_shmodel_send_recipients=function(fr){var fs,fB,fz,fx,fC,fD,fw,fy,fv,fu,fA,T,ft;cP(fr,"Must pass the shmodal send form into get_shmodel_send_recipients");fs=fr.select('input[name="emails"]');fB=fr.select('input[name="fb_ids"]');fz=fr.select('input[name="group_ids"]');fu=fr.select('input[name="new_style_group_ids"]');T=[];ft=[fs,fB,fz,fu];for(fx=0,fy=ft.length;fx<fy;fx++){fD=ft[fx];for(fw=0,fv=fD.length;fw<fv;fw++){fC=fD[fw];fA=fC.up().innerHTML.stripTags().escapeHTML();T.push(fA.substring(0,fA.indexOf("&")))}}return T};return i})();aa=INLINE_JS.QuickSend=F.QuickSend={_files:{},_uploading_fileids:{},init:function(i,T,fr){var j;this.owner_id=i;this.tokenizer_ctx_str=T;this.keep_visible=fr;this.$content=bF("#browse-root-quick-send");this.$content[0].writeAttribute("dropzone","copy move");this.$content[0].writeAttribute("quicksend","true");this.collab_input_id=this.tokenizer_ctx_str+"-new-collab-input";this.$collab_input=this.$content.find("#"+this.collab_input_id);if((j=this.$collab_input)!=null){j.keyup(this._toggle_send_button_state)}if(this.$collab_input[0]){this.$collab_input[0].on("token:remove",this._toggle_send_button_state);this.$collab_input[0].on("token:add",this._toggle_send_button_state)}this.$send_button=this.$content.find("#quick-send-submit");this.$send_button.on("click",this._send_link);this.$cancel_button=this.$content.find("#quick-send-cancel");this.$cancel_button.on("click",this._cancel_button_clicked);this.$import_services=this.$content.find(".autocomplete");bF("#browse-files").addClass("quicksend-collapsed");aa._update_location();this.has_autocompleter_inited=false;ba.SharedFolderActivityLogger.log("web","quick_send_displayed",cu.active_user,{});this.$collab_input.on("blur",function(){return setTimeout(function(){var fs;return(fs=aa.$import_services)!=null?fs.hide():void 0},100)});bF("#quick-send-top-choose-button-send").click(function(){return bF("#quick-send-file-box").click()});bF("#quick-send-choose-button").click(function(){return bF("#quick-send-file-box").click()});bF(".quick-send-choose-file-link").click(function(){return bF("#quick-send-file-box").click()});bF("#quick-send-file-box").on("change",function(){var ft,fs;fs=bF("#quick-send-file-box")[0].files;ft=function(){if(!cu.active_user){cu.active_user=cQ.get_viewer().get_user_by_id(aa.owner_id)}return bp.upload(aa.DEST_FOLDER+"/",fs)};return aa.get_folder_name(ft)});document.on(cE.COMPLETE_EVT,aa._file_upload_completed);document.on(cE.ERROR_EVT,aa._file_upload_errored);return document.on(dU.UPDATE,aa._update_location)},_cancel_button_clicked:function(i){ba.SharedFolderActivityLogger.log("web","quick_send_cancel_button_clicked",cu.active_user,{});return aa._reset()},_init_autocompleter:function(){var i;if(aa.has_autocompleter_inited){return}aa.has_autocompleter_inited=true;i={tokens:[",",";"],include_fb:true,include_team:true,team_only:false,user_id:aa.owner_id,max_textbox_height:30,viewer:cQ.get_viewer(),include_from_linked_accounts:true};return aa.autocompleter=new Autocompleter.ContactsTokenizer(cQ.get_viewer().get_user_by_id(aa.owner_id),aa.collab_input_id,aa.tokenizer_ctx_str+"-new-whobulk",aa.tokenizer_ctx_str+"-hidden-input",i)},_send_link:function(fv){var fs,fr,ft,T,j,fw,fx,i,fu;ba.SharedFolderActivityLogger.log("web","quick_send_send_button_clicked",cu.active_user,{});aa.autocompleter.tokenize_emails_input(true);i=aa.autocompleter.getTokenCount();T=bF(".quick-send-left-form")[0];j=[];fx=0;for(ft in aa._files){fx+=1;fr=aa._files[ft];j.push(fr.fq_path)}fw={num_recipients:i,num_files:fx};ba.SharedFolderActivityLogger.log("web","quick_send_send_attempted",cu.active_user,fw);fu=(function(fy){return function(fz){aa._reset();aa._toggle_top_area_view();return ba.SharedFolderActivityLogger.log("web","quick_send_send_succeeded",cu.active_user,{})}})(this);fs=(function(fy){return function(fz){return ba.SharedFolderActivityLogger.log("web","quick_send_send_failed",cu.active_user,{})}})(this);return bT.ajax_submit(T,"/sm/quick_send",fu,fs,null,{fq_paths:j.join(",")})},_update_file_area_view:function(){if(Object.keys(aa._files).length){bF("#quick-send-drop-area").hide();bF("#quick-send-files-area").show()}else{bF("#quick-send-drop-area").show();bF("#quick-send-files-area").hide()}return aa._toggle_send_button_state()},_toggle_top_area_view:function(){bF("#quick-send-top-part-send").hide();bF("#quick-send-top-part-confirm").show();return setTimeout(function(){bF("#quick-send-top-part-send").show();return bF("#quick-send-top-part-confirm").hide()},3000)},_update_location:function(){var i;i=aa.keep_visible||!!cu.inside_root_folder;return aa._toggle_quick_send_module(i)},_toggle_quick_send_module:function(T){var i,j;if(aa._visible===T){return}j=aa.$content;if(T){aa._visible=true;j.show();return aa._update_collapsed_state()}else{aa._visible=false;j.hide();j.removeClass("collapsed expanded");i=bF("#browse-files");return i.removeClass("quicksend-collapsed quicksend-expanded")}},_update_collapsed_view:function(fs){var j,fr,i,T;fr=aa.$content;T=fs?"collapsed":"expanded";if(fr.hasClass(T)){return}i=fs?"expanded":"collapsed";fr.removeClass(i);fr.addClass(T);j=bF("#browse-files");T=fs?"quicksend-collapsed":"quicksend-expanded";i=fs?"quicksend-expanded":"quicksend-collpased";j.removeClass(i);j.addClass(T);if(!fs){return aa._init_autocompleter()}},_update_collapsed_state:function(){var i;i=Object.keys(aa._files).length;return aa._update_collapsed_view(i===0)},_remove_file:function(j,i){var T;T=false;if(j in aa._uploading_fileids){T=true;document.fire(cE.CANCEL_EVT,{file:i});bF(document).trigger(cE.CANCEL_EVT,{file:i});delete aa._uploading_fileids[j]}if(j in aa._files){$(j).remove();delete aa._files[j];aa._update_upload_list_scroll();aa._update_file_area_view();return aa._update_collapsed_state()}},_reset:function(){var j,fr,T,i;aa.autocompleter.clearTokens();T=bF(".quick-send-left-form")[0];T.reset();i=[];for(fr in aa._files){j=aa._files[fr];i.push(aa._remove_file(fr,j.file_obj))}return i},_has_added_fq_path:function(T){var i,j;for(j in aa._files){i=aa._files[j];if(i.fq_path===T){return true}}return false},_update_upload_list_scroll:function(){var j,i;j=Object.keys(aa._files).length;i=bF("#quick-send-upload-files-list");if(j<3){return i.removeClass("scroll")}else{i.addClass("scroll");return i.scrollTop=i.scrollHeight}},_add_file:function(fs,i){var ft,fy,fr,fx,fv,fw,T,j,fz,fu;fw={size:fs.bytes,source:i};ba.SharedFolderActivityLogger.log("web","quick_send_file_added",cu.active_user,fw);fy=fs.dest||aa.DEST_FOLDER;fz=aF.format_bytes(fs.bytes||0);ft=fm.tmpl("upload_list_item_tmpl");fr=ft({file:fs,icon:aA.file_icon(fs.name),filename_snippet:bU.em_snippet(fs.name,d9.FILENAME_SNIPPET_LENGTH),size:fz,dest:fy,dest_snippet:bU.em_snippet(eG("Dropbox")+fy,d9.DEST_SNIPPET_LENGTH,0),Sprite:cy});j=c4.sanitize(fr.toHTML());bF("#quick-send-upload-files-list").append(j);fx=bF("#"+fs.id);aa._update_upload_list_scroll();fx.find(".dest-col").hide();fx.find(".time-col").hide();fu=fx.find(".status-col").find("a.small-x-button");fv=fs.id;fu.on("click",function(fA){return aa._remove_file(fv,fs)});T=fx.find(".remove-link");T.on("click",function(fA){return aa._remove_file(fv,fs)});fx.on("mouseenter",(function(fA){return function(fB){fx.find(".status-col").hide();return T.show()}})(this));fx.on("mouseleave",(function(fA){return function(fB){fx.find(".status-col").show();return T.hide()}})(this));aa._files[fs.id]={file_div:fr,fq_path:fs.fq_path,bytes:fs.size,file_obj:fs};aa._update_file_area_view();return aa._update_collapsed_state()},_toggle_send_button_state:function(){var j,T,i;i=((j=aa.autocompleter)!=null?j.token_manager.tokens.length:void 0)===0;i=i&&aa.$collab_input.val()==="";T=Object.keys(aa._files).length===0||Object.keys(aa._uploading_fileids).length>0;return aa.$send_button.prop("disabled",i||T)},_file_upload_errored:function(T){var j,i;j=T.memo.file;if(j.id in aa._uploading_fileids){i={message:T.memo.message};ba.SharedFolderActivityLogger.log("web","quick_send_file_errored",cu.active_user,i);return delete aa._uploading_fileids[j.id]}},_file_upload_completed:function(j){var i;i=j.memo.file;if(i.id in aa._uploading_fileids){ba.SharedFolderActivityLogger.log("web","quick_send_file_uploaded",cu.active_user,{});delete aa._uploading_fileids[i.id];return aa._toggle_send_button_state()}},get_folder_name:function(T){var j,i;if(aa.DEST_FOLDER){T();return}i=function(fs){var fr;fr=JSON.parse(fs);aa.DEST_FOLDER=fr.folder_name;return T()};j=function(){return ah.error(eG("We couldn\u2019t upload your file. Please try again."))};return cG.WebRequest({url:"/share/quick_send_folder_name",data:{},subject_user:aa.owner_id,success:i,error:j})},is_quicksend_dest:function(i){var j;j=aA.normalize(i);return j===aa.DEST_FOLDER},add_external_file:function(i){var T,j;j=i.dest+i.name;if(aa._has_added_fq_path(j)){ah.success(eG("You\u2019ve already added this file."));document.fire(cE.CANCEL_EVT,{file:i});bF(document).trigger(cE.CANCEL_EVT,{file:i});return}i.fq_path=j;i.bytes=i.size;aa._uploading_fileids[i.id]=true;aa._add_file(i,"external");T=bF("#"+i.id);return T.find(".upload-progress-bar").css({width:"0"})},add_dropbox_file:function(i){var j;if(i.dir){ah.error(eG("Please select files instead of folders."));return}if(aa._has_added_fq_path(i.fq_path)){ah.success(eG("You\u2019ve already added this file."));return}i.name=i.filename;aa._add_file(i,"dropbox");j=bF("#"+i.id);j.find(".upload-progress-bar").css({width:"100%"});j.addClass("complete");return setTimeout(function(){var T;T=j.find(".status-col");T.empty();return T.append(cy.make("web","s_check"))},0)}};var d3,cv,fi=function(fr,j){for(var i in j){if(dq.call(j,i)){fr[i]=j[i]}}function T(){this.constructor=fr}T.prototype=j.prototype;fr.prototype=new T();fr.__super__=j.prototype;return fr},dq={}.hasOwnProperty,b3=function(i,j){return function(){return i.apply(j,arguments)}};d3=F.SharedLinkSettingsModal=(function(j){fi(i,j);function i(T,fs,fr){var ft;this.owner_id=T;this.tkey=fs;this.dismiss_callback=fr;ft={tkey:this.tkey};ft[a9.UID_PARAM_NAME]=this.owner_id;i.__super__.constructor.call(this,{element_id:"shared-link-settings-modal",endpoint_url:"/sm/shared_link_settings",parameters:ft});if(this.dismiss_callback){this.on_hide=this.dismiss_callback}}return i})(cF);cv=F.SharedLinkSettingsModalContent=(function(){function i(T,fs,j,fu){var fv,fr,ft;this.owner_id=T;this.tkey=fs;this.filename=j;this.saved_password_placeholder_value=fu;this._save_settings=b3(this._save_settings,this);this._toggle_password_input=b3(this._toggle_password_input,this);this._enable_password_input_for_editing=b3(this._enable_password_input_for_editing,this);this._date_change_callback=b3(this._date_change_callback,this);this._show_calendar=b3(this._show_calendar,this);this._hide_calendar=b3(this._hide_calendar,this);this._future_date=b3(this._future_date,this);this._enable_save_button=b3(this._enable_save_button,this);this._custom_expiry_click_handler=b3(this._custom_expiry_click_handler,this);this._hide_custom_expiry_label=b3(this._hide_custom_expiry_label,this);this._show_custom_expiry_label=b3(this._show_custom_expiry_label,this);this._toggle_expiration=b3(this._toggle_expiration,this);this._expiry_picker_callback=b3(this._expiry_picker_callback,this);this._listen=b3(this._listen,this);this._detect_and_handle_blur_when_password_empty=b3(this._detect_and_handle_blur_when_password_empty,this);this._is_clicked=b3(this._is_clicked,this);this._change_password_click=b3(this._change_password_click,this);this._init_expiration_section=b3(this._init_expiration_section,this);this.MS_PER_DAY=1000*60*60*24;this.$content=bF(".sharing-settings-modal-content");this.modal=ed.get_containing_modal(this.$content);if(!this.modal){return}fr=bU.em_snippet(this.filename,18);ft=eG("Link permissions for '%(filename)s'").format({filename:fr});this.modal.set_title(ft);this.$form=this.$content.find(".shared-link-settings-modal-form");this.$save_button=this.$form.find(".confirm-button");this.$password_field_container=this.$form.find(".password-field-container");this.$password=this.$form.find(".link-password-container");this.$password_input=this.$password.find("input[name='password']");this.$password_label=this.$password.find("label");this.$change_password=this.$form.find(".change-link-password-container");this.$selected_expiry=this.$form.find(".selected-expiration");this.$unselected_expiry=this.$form.find(".unselected-expiration");this.$custom_expiry=this.$form.find(".custom-expiration");this.$selected_date_box=this.$form.find(".selected-date");this.$selected_date=this.$form.find(".selected-date-text");this.$calendar=this.$form.find("#expiration-calendar-container");this.$expiry_posix=this.$form.find("#expiration-posix");this.$static_expiry=this.$form.find(".static-expiration");this.loaded_with_saved_password=this.$password_input.data("is-saved-password")==="yes";if(this.loaded_with_saved_password){this._show_password_input(fv=true)}this._init_expiration_section();this._listen()}i.prototype._init_expiration_section=function(){var j;this.$form.find(".expiration-selection").show();if(this.$expiry_posix.val()){bF("#expiration-yes").prop("checked",true);j=this._posix_time_to_date(parseInt(this.$expiry_posix.val()));this._set_selected_date_text(j);return this._show_custom_expiry_label()}else{this.$selected_expiry.hide();this._hide_custom_expiry_label();return this.$unselected_expiry.show()}};i.prototype._change_password_click=function(j){j.preventDefault();return this._enable_password_input_for_editing()};i.prototype._is_clicked=function(j,T){return j.is(T.target)||j.has(T.target).length};i.prototype._detect_and_handle_blur_when_password_empty=function(j){if(!this.$password.is(":visible")||this.$password_input.val()||this._is_clicked(this.$password_field_container,j)){return}return this._show_password_input(true)};i.prototype._listen=function(){if(this.loaded_with_saved_password){bF(window).on("click",this._detect_and_handle_blur_when_password_empty);this.$change_password.find(".change-link-password").on("click",this._change_password_click)}this.$form.on("change",this._enable_save_button);this.$form.on("submit",this._save_settings);this.$save_button.on("click",this._save_settings);this.$content.find(".cancel-button").on("click",(function(j){return function(T){return d7.pop()}})(this));this.$content.find(".audience-selection input[type=radio]").on("change",this._toggle_password_input);this.$content.find(".expiration-selection input[type=radio]").on("change",this._toggle_expiration);return bF(window).on(bA.CHANGED,this._expiry_picker_callback)};i.prototype._expiry_picker_callback=function(fs,fr){var j,T;if(fr.clicked_val===fr.old_val){return}j=fr.clicked_val;if(j!=="custom"){T=this._future_date(parseInt(j));return this._set_expiration(T)}else{this.$selected_expiry.hide();this._show_custom_expiry_label();this._set_selected_date_text(this._future_date(30));return this._show_calendar()}};i.prototype._toggle_expiration=function(fr){var T,j;if(bF(fr.currentTarget).attr("id")==="expiration-yes"){this.$selected_expiry.show();this._hide_custom_expiry_label();this.$unselected_expiry.hide();D.controller(bF(".expiration-picker")).set_value(30);j=30;T=this._future_date(j);this._set_expiration(T);return this._set_selected_date_text(T)}else{this.$expiry_posix.val("");this.$unselected_expiry.show();this.$selected_expiry.hide();this.$static_expiry.hide();this._hide_custom_expiry_label();return this._hide_calendar()}};i.prototype._show_custom_expiry_label=function(){this.$custom_expiry.show();this.$selected_expiry.hide();this.$unselected_expiry.hide();return bF(window).on("click",this._custom_expiry_click_handler)};i.prototype._hide_custom_expiry_label=function(){this.$custom_expiry.hide();return bF(window).off("click",this._custom_expiry_click_handler)};i.prototype._custom_expiry_click_handler=function(j){if(this._is_clicked(this.$calendar,j)){return}if(this.$selected_date_box.is(j.target)||this.$selected_date_box.has(j.target).length){if(this.$calendar.is(":visible")){return this.$calendar.hide()}else{return this._show_calendar()}}else{if(this.$calendar.is(":visible")){return this.$calendar.hide()}}};i.prototype._enable_save_button=function(j){return this.$save_button.removeAttr("disabled")};i.prototype._future_date=function(j){var T;T=ec.start_of_day(new Date());T.setDate(T.getDate()+j);return T};i.prototype._hide_calendar=function(){return this.$calendar.hide()};i.prototype._show_calendar=function(){var fr,T,j;bF(".selected-date").off("click");if(!this.calendar){if(this.$expiry_posix.val()){j=this._posix_time_to_date(parseInt(this.$expiry_posix.val()))}else{j=this._future_date(30)}T={disable_past:true,first_day:this._future_date(1),last_day:this._future_date(365),selected_date:j,onDateChange:bF.proxy(this._date_change_callback,this)};this.calendar=new J("expiration-calendar-container",T)}else{this.$calendar.show()}fr=this.$selected_date_box.offset().left;return this.$calendar.show().offset({left:fr})};i.prototype._posix_time_to_date=function(j){return new Date(j*1000)};i.prototype._set_selected_date_text=function(j){return this.$selected_date.text(O.localize(j))};i.prototype._set_expiration=function(T){var j,fr;cP(T.getMilliseconds()===0);cP(T.getSeconds()===0);cP(T.getMinutes()===0);cP(T.getHours()===0);fr=(T.getTime()+this.MS_PER_DAY)/1000;j=fr-1;return this.$expiry_posix.val(j)};i.prototype._date_change_callback=function(j){this._set_selected_date_text(j);this._set_expiration(j);this._enable_save_button();return this._hide_calendar()};i.prototype._show_password_input=function(fu){var ft,fr,T,fs,j;if(fu==null){fu=false}ft=this.$content.find("label[for=audience-password]").position().left;fs=this.$content.find("#audience-password").position().left;fr=ft-fs+10;this.$password.show().css({left:fr});this.$password_input.val("");if(fu){this.$password_input.addClass("disabled").attr("readonly","true");this.$password_input.data("is-saved-password","yes");j="\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf";this.$password_label.text(j).show();T=this.$password.position();return this.$change_password.css({left:T.left,top:T.top}).show()}else{return this._enable_password_input_for_editing()}};i.prototype._enable_password_input_for_editing=function(){this.$change_password.hide();this.$password_input.removeAttr("readonly").removeClass("disabled");this.$password_input.data("is-saved-password","no");this.$password_label.text(eG("Set password")).show();this.$password_input.focus();return this._enable_save_button()};i.prototype._toggle_password_input=function(j){var T;if(bF(j.currentTarget).attr("id")==="audience-password"){return this._show_password_input(T=this.loaded_with_saved_password)}else{this.$password.hide();this.$change_password.hide();return this.$password_input.data("is-saved-password","no")}};i.prototype._save_settings=function(fs){var T,j,fr,ft;if(this.$password_input.data("is-saved-password")==="yes"){fr={type:"hidden",name:"password",value:this.saved_password_placeholder_value};T=bF("<input />",fr);this.$form.append(T);this.$password_input.attr("name","inoperative_password")}ft=(function(fu){return function(fv){d7.pop();return ah.success(eG("Settings saved."))}})(this);j=(function(fu){return function(fv){if(fu.$password.length&&fu.$password.is(":visible")){fu.$password_input.focus()}return bT.remove_loading()}})(this);return bT.ajax_submit(this.$form[0],"/sm/change_shared_link_settings",ft,j,this.$save_button[0])};return i})();var eL;eL=F.SimpleSharing=(function(){var fw,fu,T,fv,j,ft,fr,i;function fs(){}fs.createAndShowMemberListModalFromBrowseFile=function(fx,fy){return fs.createAndShowMemberListModal(fx,fy.fq_path,fy.dir,fy.target_ns,fy.is_shared_folder(),fy.could_be_shared_folder(),parseInt(fy.sf_perm_role))};fs.createAndShowInbandModalFromBrowseFile=function(fx,fy){return fs.createAndShowInbandModal(fx,fy.fq_path,fy.dir,fy.target_ns,fy.is_shared_folder(),fy.could_be_shared_folder(),parseInt(fy.sf_perm_role))};fs.createAndShowInbandModalFromFile=function(fx,fy){return fs.createAndShowInbandModal(fx,fy.fq_path,false,fy.ns_id,false,false,d6.ACCESS_READER)};fs.createAndShowM2InbandModal=function(fy,fz){var fA,fx;fx=function(fB,fD,fC){return d7.push(new d3(fB,fD,fC))};fA=function(fC){var fB;fB=new dl(cu.active_user,fC);return fB.show()};return aI.showInstance(aI({needsFetchingTokenInfo:true,user:fy,fqPath:fz,isDir:true,canReaderSync:false,isSharedFolder:true,couldBeSharedFolder:false,canEdit:true,editableLinksM2Enabled:true,showSharedLinkSettingsModal:fx,onGoBackButtonClicked:fA}))};fw=function(fy,fA,fx,fz){return window.INLINE_JS.DBModalStack.push(new eC(fy,fA,fx,fz))};fu=function(fz,fB,fA,fy,fx){return window.INLINE_JS.DBModalStack.push(new al(fz,fB,fA,fy,fx))};T=function(fy,fz,fx){return window.INLINE_JS.DBModalStack.push(new dl(fy,fz,false,false,fx))};i=function(fy,fz,fx){return window.INLINE_JS.DBModalStack.push(new b5(fy,{element_id:"unshare-confirm-modal",team_shared_folder:false,ns_id:fx,folder_path:fz}))};j=function(fy,fz,fx,fB,fA){return window.INLINE_JS.DBModalStack.push(new eX(fy,{element_id:"kick-confirm-modal",ns_id:fx,user_name:fA,folder_path:fz,user_id:fB}))};fv=function(fy,fA,fx,fz,fB){return window.INLINE_JS.DBModalStack.push(new aV(fy,{element_id:"kick-group-confirm-modal",ns_id:fx,group_name:fB,folder_path:fA,group_id:fz}))};fr=function(fy,fz,fx,fB,fA){return window.INLINE_JS.DBModalStack.push(new aJ(fy,{element_id:"uninvite-confirm-modal",email_or_fbname:fA,ns_id:fx,invite_id:fB,folder_path:fz}))};ft=function(fy,fz,fx){return d7.push(new dC(fy,{element_id:"leave-confirm-modal",ns_id:fx,folder_path:fz}))};fs.createAndShowMemberListModal=function(fx,fA,fB,fz,fy,fC,fD){return cL.createAndShowModal(fx,fA,{show_dfb_existing_folder_settings_modal:fw,show_dfb_new_folder_settings_modal:fu,show_folder_members_modal:T,show_unshare_folder_modal:i,show_kick_user_modal:j,show_kick_group_modal:fv,show_uninvite_modal:fr,show_leave_folder_modal:ft},Boolean(fB),fz,fy,fC,parseInt(fD),cu.simple_sharing_react_member_list_enabled,cu.simple_sharing_individual_files_enabled)};fs.createAndShowInbandModal=function(fx,fA,fB,fz,fy,fC,fD){return dV.createAndShowModal(fx,fA,{show_dfb_existing_folder_settings_modal:fw,show_dfb_new_folder_settings_modal:fu,show_folder_members_modal:T,show_unshare_folder_modal:i,show_kick_user_modal:j,show_kick_group_modal:fv,show_uninvite_modal:fr,show_leave_folder_modal:ft},Boolean(fB),fz,fy,fC,parseInt(fD),cu.simple_sharing_react_member_list_enabled,cu.simple_sharing_individual_files_enabled)};fs.dismissM2Prompt=function(){cu.simple_sharing_show_m2_prompt=false;return cG.WebRequest({url:"/simple_sharing_ajax/dismiss_m2_prompt"})};return fs})();var eF,eA;eA=F.FoshmodalPanes=Object.clone(dx);eA.to_title_str=function(){var i,j,ft,T,fr,fs;if(eF.sharing_collection){fr=bU.em_snippet(eF.collection_to_share.name,18,1);return eG("Share '%(snippeted_name)s'").format({snippeted_name:fr})}else{i=eF._selection;T=de.categorize_files(i),j=T[0],ft=T[1];if(j&&ft){fs=bd("Share %(file_count)s item","Share %(file_count)s items",i.length)}else{if(j){fs=bd("Share %(file_count)s photo","Share %(file_count)s photos",i.length)}else{fs=bd("Share %(file_count)s video","Share %(file_count)s videos",i.length)}}fs=fs.format({file_count:i.length});return fs}};eF=INLINE_JS.Foshmodal=F.Foshmodal={current_shmodel_url:null,current_short_url:null,callback_for_when_we_have_shmodel_url:null,current_foshmodal_pane:eA.SEND,send_link_autocompleter:null,sharing_collection:false,num_photos_to_share:null,working:false,collection_to_share:null,have_real_tkey:false,current_tkey:null,current_album_name:null,previous_album_name:null,_selection:null,lock:function(){if(this.working){return false}this.working=true;return this.working},unlock:function(){return this.working=false},clear_message_inputs:function(){$("shmodal-send-content").down(".custom-message-container").down(".textinput").setValue("");$("shmodal-fb-post-input").setValue("");return $("shmodal-twitter-post-input").setValue("")},refresh:function(){this.current_shmodel_url=null;this.current_short_url;this.callback_for_when_we_have_shmodel_url=null;this.current_foshmodal_pane=eA.SEND;this.sharing_collection=false;this.have_real_tkey=false;this.current_tkey=null;this.current_album_name=null;this.previous_album_name=null;e0.clear();this.clear_message_inputs();this.send_link_autocompleter.clearTokens();this.unlock();bF(".link-image").attr("src","static/images/empty_album_big.png");bT.remove_loading(bF("#modal").find(".tokenizer-submit-button")[0]);bT.remove_loading(bF("#modal").find(".foshmodal-copy-link")[0]);bT.remove_loading(bF("#shmodal-twitter-post-submit")[0]);return bT.remove_loading(bF("#shmodal-fb-post-submit")[0])},create_album_from_selected_photos:function(i){var j;cP(this._selection.length,"This should never be called with an empty selection");cP(this.current_tkey!=null,"Missing tkey");cP(this.current_shmodel_url!=null,"Missing shmodel url");cP(this.current_short_url!=null,"Missing short url");cP(i!=null,"Missing collection info");i.is_anonymous=this.creating_anonymous_collection();i.share_tkey=this.current_tkey;i.shmodel_url=this.current_shmodel_url;i.short_url=this.current_short_url;return j=new ad(i)},set_shmodel_url:function(j,i){if(this.have_real_tkey){this.current_shmodel_url=this.collection_to_share.shmodel_url;this.current_short_url=this.collection_to_share.short_url;this.current_tkey=this.collection_to_share.share_tkey;return typeof j==="function"?j():void 0}else{return new Ajax.DBRequest("/collection_create_dummy_token",{onSuccess:(function(T){return function(fs){var fr;fr=JSON.parse(fs.responseText);T.current_shmodel_url=fr.token_link;T.current_short_url=fr.short_link;T.current_tkey=fr.tkey;if(typeof j==="function"){j()}return typeof T.callback_for_when_we_have_shmodel_url==="function"?T.callback_for_when_we_have_shmodel_url():void 0}})(this),onFailure:function(){return typeof i==="function"?i():void 0}})}},attach_collection_to_token:function(j,i){cP(this.collection_to_share!=null,"Should get called only when there is an existing collection");cP(this.current_shmodel_url!=null,"Should have a shmodel url before you call attach_collection_to_token");if(this.have_real_tkey){if(typeof j==="function"){j(this.collection_to_share.gid)}return}cP(this.current_tkey!=null,"should have tkey");return this.collection_to_share.attach_to_token(this.current_tkey,this.current_shmodel_url,this.current_short_url,j,i)},create_collection_and_attach_to_token:function(ft,i){var T,fs,fr,j;cP(this.sharing_collection===false,"Should not get called when we already have a collection");cP(this.current_shmodel_url!=null,"Should have a shmodel url before you call create_collection_and_attach_to_token");fs=(function(fu){return function(fv){var fw;fw=JSON.parse(fv.responseText);fu.create_album_from_selected_photos(fw);return typeof ft==="function"?ft(fw.gid):void 0}})(this);T=function(fu){return typeof i==="function"?i(fu):void 0};fr={tkey:this.current_tkey,collection_name:this.creating_anonymous_collection()?"":this.current_album_name,is_anonymous:this.creating_anonymous_collection(),item_counters:JSON.stringify((function(){var fw,fu,fx,fv;fx=this._selection;fv=[];for(fw=0,fu=fx.length;fw<fu;fw++){j=fx[fw];fv.push(j.item_counter)}return fv}).call(this)),source_collection_gid:bQ.get_current_collection_gid()};return new Ajax.DBRequest("/collection_create_and_attach_to_dummy_token",{onSuccess:fs,onFailure:T,parameters:fr})},alert_if_album_name_invalid:function(){if(this.creating_anonymous_collection()){return false}if(this.current_album_name.strip().length===0){ah.error(eG("Please enter a name for this album"));this.unlock();return true}if(cN.collection_name_in_use(this.current_album_name)){ah.error(eG("You already have an album named '%(current_album_name)s'").format({current_album_name:this.current_album_name}));this.unlock();return true}return false},send_button_onclick:function(T){var j,i;if(!this.lock()){return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}j=$("shmodal-send-form");cP(j,"Couldn't find the shmodal send form.");if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.send_button_onclick.bind(this);return}i=(function(fr){return function(fs){fr.unlock();if(!fs.responseText.startsWith("err:")){ah.error(eG("We couldn't send this album. Please try again."));fh.hide();return fr.refresh()}}})(this);if(this.sharing_collection){this.send_collection(j,i)}else{this.send_selection(j,i)}return g.log_interaction(er.SEND,dh.FOSHMODAL,{num_photos:this.num_photos_to_share})},get_send_success_text:function(){var fr,j,T,i,fs;fr=this.get_current_display_name();i=am.get_shmodel_send_recipients($("shmodal-send-form"));j=i[0].split(" ")[0];if(i.length===1){fs=eG("Shared %(album_name)s with %(first_name_of_recipient)s").format({album_name:fr,first_name_of_recipient:j})}else{if(i.length===2){T=i[1].split(" ")[0];fs=eG("Shared %(album_name)s with %(first_name_of_recipient)s and %(first_name_of_second_recipient)s").format({album_name:fr,first_name_of_recipient:j,first_name_of_second_recipient:T})}else{fs=eG("Shared %(album_name)s with %(first_name_of_recipient)s and %(num_other_recipients)s others").format({album_name:fr,first_name_of_recipient:j,num_other_recipients:i.length-1})}}return fs},send_selection:function(T,j){var fs,fr,i;fs=(function(ft){return function(fu){var fv;fv=JSON.parse(fu.responseText);ft.create_album_from_selected_photos(fv);ah.success(ft.get_send_success_text());ft.refresh();return fh.hide()}})(this);fr={shmodel_url:this.current_shmodel_url,tkey:this.current_tkey,num_items:this.num_photos_to_share,is_anonymous:this.creating_anonymous_collection(),item_counters:JSON.stringify((function(){var fv,ft,fw,fu;fw=this._selection;fu=[];for(fv=0,ft=fw.length;fv<ft;fv++){i=fw[fv];fu.push(i.item_counter)}return fu}).call(this)),source_collection_gid:bQ.get_current_collection_gid()};if(this.creating_anonymous_collection()){fr.collection_name=""}else{if(this.current_album_name.trim().length===0){fr.collection_name=cN.get_default_album_name()}}return bT.ajax_submit(T,"/collection_create_and_send_link",fs,j,T.down(".tokenizer-submit-button"),fr)},send_collection:function(j,i){var T;cP(this.current_tkey!=null,"tkey should be set");cP(this.current_shmodel_url!=null,"shmodel url should be set");T=(function(fr){return function(){ah.success(fr.get_send_success_text());fh.hide();return fr.refresh()}})(this);return this.collection_to_share.send_link(j,this.current_tkey,this.current_shmodel_url,this.current_short_url,T,i)},get_link_button_onclick:function(){var i,T,j;if(!this.lock()){return}if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.get_link_button_onclick.bind(this);return}j=$("modal").down(".tokenizer-submit-button");T=(function(fr){return function(ft){var fs;fs=fr.get_current_display_name();if(FlashDetect.installed){ah.success(eG("The link to %(album_name)s was copied to your clipboard",{comment:"name of a photo/video album"}).format({album_name:fs}))}fr.show_get_link_modal(fr.current_shmodel_url,fs,ft);ba.ViralLogger.log(cQ.get_viewer().get_user_ids(),"shmodel","send",{src:"photo_copy_link",file_type:"collection"});if(fr.collection_to_share!=null){cB.log_share("share_link",ft,fr.num_photos_to_share,fr.creating_anonymous_collection(),!fr.sharing_collection)}return fr.refresh()}})(this);i=(function(fr){return function(fs){fr.unlock();bT.remove_loading(j);if(!fs.responseText.startsWith("err")){ah.error(eG("We couldn't create a link to this album. Please try again."));fh.hide();return fr.refresh()}}})(this);if(this.sharing_collection){bT.add_loading(j);this.attach_collection_to_token(T,i)}else{if(this.alert_if_album_name_invalid()){return}bT.add_loading(j);this.create_collection_and_attach_to_token(T,i)}return g.log_interaction(er.GET_LINK,dh.FOSHMODAL,{num_photos:this.num_photos_to_share})},initialize_get_link_button:function(){var i,j;if(FlashDetect.installed){i=t.clipboard_overlay(this.current_shmodel_url,bF("#foshmodal-copy-link"),eF.get_link_button_onclick.bind(this));i.css({position:"fixed",zIndex:1001});clearInterval(this.follow_freshbutton);j=(function(T){return function(){return i.clonePosition(bF("#foshmodal-copy-link"),{offsetHeight:6,offsetWidth:6})}})(this);return this.follow_freshbutton=setInterval(j,500)}else{$("foshmodal-copy-link").stopObserving();return $("foshmodal-copy-link").observe("click",this.get_link_button_onclick.bind(this))}},facebook_button_onclick:function(ft,j){var fs,T,i,fr;if(!this.lock()){return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.facebook_button_onclick.bind(this).curry(ft,j);return}fs=bF("#modal:visible, #modal-overlay:visible");i=function(){return fs.show()};T=(function(fu){return function(){fu.lock();setTimeout(fu.unlock.bind(fu),750);return ew.do_auth((function(){return fu.do_fb_post(j)}),j)}})(this);if(ew.authed_user_id===j){this.do_fb_post(j)}else{if(cQ.get_viewer().is_uid_associated(ew.authed_user_id)){this.unlock();fs.hide();fr=new ek(cQ.get_viewer().get_user_by_id(j),i,T.bind(this));fr.show()}else{T()}}return g.log_interaction(er.FB_SHARE,dh.FOSHMODAL,{num_photos:this.num_photos_to_share})},twitter_button_onclick:function(j,i){if(!this.lock()){return}if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.twitter_button_onclick.bind(this).curry(j,i);return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}if(cI.is_authed(i)){this.do_twitter_post(i)}else{setTimeout(this.unlock.bind(this),750);cI.do_auth(((function(T){return function(){return T.do_twitter_post(i)}})(this)),i)}return g.log_interaction(er.TWITTER_SHARE,dh.FOSHMODAL,{num_photos:this.num_photos_to_share})},do_fb_post:function(i){var j,T;j=(function(fr){return function(){ah.error(eG("We couldn't share this album on Facebook. Please try again."));fh.hide();return fr.refresh()}})(this);T=(function(fr){return function(ft){var fs;ew.custom_show_posting=function(){return bT.add_loading($("shmodal-fb-post-submit"))};ew.progress_container=$("modal").down(".modal-buttons");fs=fr.get_current_display_name();ew.custom_show_complete=function(){fh.hide();ah.success(eG("Shared %(album_name)s on Facebook!",{comment:"name of a photo/video album"}).format({album_name:fs}));return fr.refresh()};ew.post($F("shmodal-fb-post-input"),fr.current_shmodel_url,null,null,null,j,i);ba.ViralLogger.log(cQ.get_viewer().get_user_ids(),"shmodel","send",{src:"photo_fb_post",file_type:"collection"});return cB.log_share("share_facebook",ft,fr.num_photos_to_share,fr.creating_anonymous_collection(),!fr.sharing_collection)}})(this);if(this.sharing_collection){return this.attach_collection_to_token(T,j)}else{return this.create_collection_and_attach_to_token(T,j)}},do_twitter_post:function(i){var fr,j,T;fr=$F("shmodal-twitter-post-input");if(!fr){ah.error(eG("Please enter a tweet"));this.unlock();return}if(fr.length>140){ah.error(eG("Your tweet must be 140 characters or less"));this.unlock();return}T=(function(fs){return function(ft){cI.custom_show_posting=function(){$("twitter-chars").hide();return bT.add_loading($("shmodal-twitter-post-submit"))};cI.custom_post(fr,function(){fh.hide();ah.success(eG("Your tweet has been posted!"));return fs.refresh()},i);ba.ViralLogger.log(cQ.get_viewer().get_user_ids(),"shmodel","send",{src:"photo_twitter",file_type:"collection"});return cB.log_share("share_twitter",ft,fs.num_photos_to_share,fs.creating_anonymous_collection(),!fs.sharing_collection)}})(this);j=(function(fs){return function(){ah.error(eG("We couldn't share this album on Twitter. Please try again."));fh.hide();return fs.refresh()}})(this);if(this.sharing_collection){return this.attach_collection_to_token(T,j)}else{return this.create_collection_and_attach_to_token(T,j)}},show_get_link_modal:function(j,i,T){var fr;fh.show(eG("Link to %(album_name)s").format({album_name:i.escapeHTML()}),$("get-link-modal"));fr=$("get-link-modal").down(".link-input");fr.setValue(j);fr.select();$("get-link-modal").down(".view-button").onclick=function(){window.open(j,"_blank");return fh.hide()};return $("get-link-modal").down(".done-button").onclick=function(){if(T!=null){cN.flash_sidebar_album(T)}return fh.hide()}},update_current_album_name_text:function(i){this.current_album_name=$(eA.to_content_str(this.current_foshmodal_pane)).down(".album-name-input").value;if(this.current_foshmodal_pane===eA.FB){return this.set_fb_post_title(this.current_album_name)}},set_fb_post_title:function(fs){var j,fr,T,i;i=this.sharing_collection?bQ.get_timeline().get_photos():this._selection;if(fs){if(this.num_photos_to_share===1){j=fs}else{j=eG("%(album_name_text)s (%(album_desc)s)",{comment:'e.g. album_desc is "5 photos and 1 video" and album_name_text is "my_album"'}).format({album_name_text:fs,album_desc:de.file_desc(i)})}}else{if(i.length===1){T=i[0];if(T.preview_type==="photo"){fr=eG("Photo from %(date_taken)s")}else{fr=eG("Video from %(date_taken)s")}j=fr.format({date_taken:b6.nice_date_with_month_name(new Date(T.time_taken),true,true,true)})}else{j=de.file_desc(i)}}return $(eA.to_content_str(eA.FB)).down(".link-name").__date(j)},set_current_album_name_text:function(j,i){$(eA.to_content_str(j)).down(".album-name-input").value=i;if(j===eA.FB){return this.set_fb_post_title(i)}},show_content:function(ft){var fr,T,j,fs;if(this.working){return}$("shmodal-title-text").__date(eA.to_title_str());fs=eA.list;for(T=0,j=fs.length;T<j;T++){fr=fs[T];if(fr!==ft){$(eA.to_toggle_str(fr)).removeClassName("toggled");$(eA.to_content_str(fr)).hide()}}$(eA.to_content_str(ft)).show();$(eA.to_toggle_str(ft)).addClassName("toggled");if(!this.sharing_collection){this.set_current_album_name_text(ft,this.current_album_name)}switch(ft){case eA.FB:$("shmodal-fb-post-input").focus();break;case eA.TWITTER:$("shmodal-twitter-post-input").focus();break;case eA.SEND:$("foshmodal-new-collab-input").focus()}return this.current_foshmodal_pane=ft},_get_foshmodal_title:function(){return am.generate_title_content(eA.to_title_str(),((function(i){return function(){return i.show_content(eA.SEND)}})(this)),((function(i){return function(){return i.show_content(eA.FB)}})(this)),((function(i){return function(){return i.show_content(eA.TWITTER)}})(this)))},creating_anonymous_collection:function(){return !$("shmodal").hasClassName("saving-as-album")},get_current_display_name:function(){if(this.sharing_collection){return"'"+this.collection_to_share.name+"'"}else{if(this.creating_anonymous_collection()){return de.file_desc(this._selection,true)}else{return"'"+this.current_album_name+"'"}}},set_twitter_message:function(){var i,fr,j,fs,T;i=this.sharing_collection?bQ.get_timeline().get_photos():this._selection;if(i.length===1){T=de.categorize_files(i),j=T[0],fs=T[1];if(j){fr=eG("Just shared a photo using @Dropbox")}else{if(fs){fr=eG("Just shared a video using @Dropbox")}else{cP(false,"We shouldn't have non-photo, non-video files in timeline")}}}else{fr=eG("Just shared an album using @Dropbox")}return $("shmodal-twitter-post-input").setValue(fr+" "+this.current_short_url)},update_shmodal_image_text:function(){var fv,fw,fs,fx,ft,fA,T,fy,fu,fr,fz;if(this.sharing_collection){fA=this.collection_to_share.num_items;fz=de.album_desc(this.collection_to_share,false,true)}else{fA=this._selection.length;fz=de.file_desc(this._selection,false,true)}if(fA>1){T=$$(".shmodal-image");fu=[];for(fw=0,fx=T.length;fw<fx;fw++){fv=T[fw];fv.down("span").__date(fz);fu.push(fv.down(".share-file-count").show())}return fu}else{fy=$$(".shmodal-image");fr=[];for(fs=0,ft=fy.length;fs<ft;fs++){fv=fy[fs];fr.push(fv.down(".share-file-count").hide())}return fr}},show:function(fw,fF){var fy,fv,fC,fD,fu,fs,fA,ft,fr,fx,T,fB,fz,fE;this.unlock();fh.onHide=(function(i){return function(){var fG,j;if((fG=$("flash_copy_container"))!=null){fG.remove()}if((j=i.send_link_autocompleter)!=null){j.hide()}bF("#modal").find(".new-collab-input").val("");clearInterval(i.follow_freshbutton);bQ.disable_selection();delete fh.onHide;return fh.hide()}})(this);this.sharing_collection=fF;fE=this.sharing_collection?fw.thumbnail_url_256:fw[0].thumbnail_url;T=$$(".link_image");for(fv=0,fA=T.length;fv<fA;fv++){fC=T[fv];if(fE!=null){fC.src=fE}else{fC.src="static/images/empty_album_big.png"}}this.current_foshmodal_pane=eA.SEND;this.have_real_tkey=this.sharing_collection&&(fw.share_tkey!=null);if(this.sharing_collection){this.collection_to_share=fw;this.num_photos_to_share=this.collection_to_share.num_items;$("shmodal").addClassName("sharing-collection");this.set_fb_post_title(this.collection_to_share.name)}else{this._selection=fw.sort(function(j,i){return j.time_taken-i.time_taken});this.num_photos_to_share=this._selection.length;this.current_album_name="";this.set_current_album_name_text(this.current_foshmodal_pane,this.current_album_name);$("shmodal").removeClassName("sharing-collection");$("shmodal").removeClassName("saving-as-album");fB=$$(".save-as-album-checkbox");for(fu=0,ft=fB.length;fu<ft;fu++){fy=fB[fu];fy.checked=false;fx=(function(i){return function(fN){var fO,fI,fG,fJ,fH,fM,fL,fK,j;if(fN.target.checked){$("shmodal").addClassName("saving-as-album");i.current_album_name=i.previous_album_name||cN.get_default_album_name();i.set_current_album_name_text(i.current_foshmodal_pane,i.current_album_name);fO=$(eA.to_content_str(i.current_foshmodal_pane)).down(".album-name-input");fO.focus();fO.select();fM=$$(".save-as-album-checkbox");fK=[];for(fI=0,fJ=fM.length;fI<fJ;fI++){fy=fM[fI];fK.push(fy.checked=true)}return fK}else{$("shmodal").removeClassName("saving-as-album");i.previous_album_name=i.current_album_name;i.current_album_name="";i.set_current_album_name_text(i.current_foshmodal_pane,i.current_album_name);fL=$$(".save-as-album-checkbox");j=[];for(fG=0,fH=fL.length;fG<fH;fG++){fy=fL[fG];j.push(fy.checked=false)}return j}}})(this);fy.observe("change",fx);if(b1.msie_version_at_most(8)){fy.observe("click",fx)}}fz=$$(".album-name-input");for(fs=0,fr=fz.length;fs<fr;fs++){fD=fz[fs];fD.observe("keyup",this.update_current_album_name_text.bind(this))}}bQ.enable_selection();fh.show(this._get_foshmodal_title(),$("shmodal"));this.clear_message_inputs();this.show_content(this.current_foshmodal_pane);this.set_shmodel_url(((function(i){return function(){i.initialize_get_link_button();return i.set_twitter_message()}})(this)),(function(){ah.error(eG("This request could not be completed.  Please try again."));return fh.hide()}));this.update_shmodal_image_text();if(!this.send_link_autocompleter){this.send_link_autocompleter=new Autocompleter.ContactsTokenizer(cQ.get_viewer().get_user_by_role(Constants.ROLE_PHOTOS),"foshmodal-new-collab-input","foshmodal-new-whobulk","foshmodal-hidden-input",{tokens:[",",";"],include_fb:true,include_team:true})}this.send_link_autocompleter.clearTokens();W.register(false,$("modal"));if(this.num_photos_to_share<=1){$("shmodal-send-content").down(".collection-thumb-stack").hide();$("shmodal-twitter-content").down(".collection-thumb-stack").hide()}else{$("shmodal-send-content").down(".collection-thumb-stack").show();$("shmodal-twitter-content").down(".collection-thumb-stack").show()}return ec._track_twitter_chars_left("shmodal-twitter-post-input",140)}};var eK,aq,c6,dZ,cE,d9,bp,cX=[].indexOf||function(fr){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fr){return T}}return -1};cE=INLINE_JS.Upload=F.Upload={QUEUE_EVT:"db:upload:queue",QUEUE_ERROR_EVT:"db:upload:queue_error",UPDATE_EVT:"db:upload:update",COMPLETE_EVT:"db:upload:complete",ERROR_EVT:"db:upload:error",CANCEL_EVT:"db:upload:cancel",CHOOSE_FILE_BASIC:"db:upload:choose_file_basic",APPLE_PACKAGE_EXTENSIONS:["pages","key","app","numbers","band","photolibrary","rcproject","rtfd","graffle","logic","logicx","lpdf","sketch","screenflow","scriv","dvdproj","mindnode","cmproj","xcodeproj","imovielibrary","mpkg","imovieproject","1password","agilekeychain","fcpbundle","abbu","mindnode","theater","gameproj","aplibrary","itlp","lrdata","ydevice","bundle","framework","plugin","kext","pkg"],APPLE_PACKAGE_ERROR:-54321,current_dest:"",runtimes:(function(){var T,j,fr,i;fr={"MSIE 8.0":"flash","MSIE 9.0":"flash"};j="html5";for(T in fr){i=fr[T];if(navigator.userAgent.indexOf(T)!==-1){j=i}}return j})(),set_dest:function(i){dB.fillVal(i,"dest-folder");return this.current_dest=i},init:function(T,fr,fs,j){var i;this.set_dest(T);i=this.initPLU(fs,j);if(!fr){an.window_load(i)}else{i()}bF("#flash-upload-container > .moxie-shim").each(function(ft){if(ft.observe){ec.freshbutton_overlay(ft,$("choose-button"));return ec.freshbutton_overlay(ft,$("add-button"))}});return aq.clear()},init_basic:function(){ec.freshbutton_overlay($("file-box"),$("basic-choose-button"));$("file-box").observe("click",function(i){return document.fire(cE.CHOOSE_FILE_BASIC)});$("basic-choose-button").observe("mousemove",function(T){var j,i,fr;j=$("modal").cumulativeOffset();fr=T.clientY-j.top-3;i=T.clientX-j.left-$("file-box").getWidth()+3;return $("file-box").setStyle({top:fr+"px",left:i+"px"})});return $("file-box").observe("change",function(){var fs,T,ft,fr,i,j;fh.hide=function(){};$("modal-x").hide();$("basic-upload-desc").hide();$("basic-upload-buttons").hide();$("file-box").hide();T=$("file-box").getValue().split("\\").pop();fr=cy.make("web",aA.file_icon(T));$("basic-upload-status").down(".icon").__date(fr);fs=eG("Uploading %(filename)s").format({filename:bU.em_snippet(T,25)});$("basic-upload-status").down(".file-desc").__date(fs);$("basic-upload-status").show();$("basic-uploading-message").show();ft=$("file-box").files;j=0;if(ft){i=ft[0].lastModifiedDate;if(i){j=Math.round(Date.parse(i)/1000)||0}}if(!j){j=Math.round(Date.parse(new Date)/1000)}$("mtime-utc").value=j;return $("basic-upload-form").submit()})},initPLU:function(j,i){return(function(T){return function(){var fs,fr;fs={url:"https://"+Constants.BLOCK_CLUSTER+"/chunked_upload",file_data_name:"file",runtimes:T.runtimes,multipart_params:{},multipart:false,max_file_size:"10000mb",chunk_size:"8mb",max_retries:2,browse_button:"choose-button",container:"flash-upload-container",preinit:{PostInit:function(){if(j){j()}return T.uploaderLoaded()},Error:T.uploadError.bind(T)},init:{FilesAdded:T.fileQueued.bind(T),UploadProgress:T.uploadProgress.bind(T),FileUploaded:T.uploadSuccess.bind(T),BeforeUpload:T.prepareFileForUploading.bind(T),ChunkUploaded:T.chunkUploaded.bind(T),UploadComplete:aq.finished.bind(aq),Refresh:function(){if(T.PLU.runtime==="flash"&&$("upload-running-buttons").visible()){bF("#flash-upload-container").clonePosition(bF("#add-button"));bF("#flash-upload-container > .moxie-shim")[0].style.width="100%";return bF("#flash-upload-container > .moxie-shim")[0].style.height="100%"}}},flash_swf_url:aN.UrlConstants.MOXIE_SWF_URL};if(i!=null){bF.extend(fs,i)}fr=new q.Uploader(fs);T.PLU=fr;return T.PLU.init()}})(this)},reset:function(){if(aq.uploading&&aq.current_file){this.PLU.removeFile(aq.current_file)}return c6.hide()},show_upload:function(){$("upload-desc").hide();$("dnd-upload-desc").hide();$("upload-files-list").show();$("upload-start-buttons").hide();$("upload-running-buttons").show();$("hide-button").show();$("done-button").hide();if(!$("modal-overlay").visible()){return c6.show()}},updatePostParams:function(T){var j,i;i=this.PLU.settings.multipart_params;for(j in T){if(T.hasOwnProperty(j)){i[j]=T[j]}}return this.PLU.settings.multipart_params=i},fileQueued:function(fs,fu){var ft,T,i,fr;for(T=0,i=fu.length;T<i;T++){ft=fu[T];if((typeof ft.getNative==="function"?(fr=ft.getNative())!=null?fr.dest:void 0:void 0)===void 0){ft.dest=cE.current_dest}else{ft.dest=ft.getNative().dest}}document.fire(this.QUEUE_EVT,{files:fu});bF(document).trigger(this.QUEUE_EVT,{files:fu});if(aa.is_quicksend_dest(ft.dest)){return}return this.show_upload()},uploadNext:function(){var fs,T,i,j,ft,fr;j=aq.next();i=(bx.contains(cE.APPLE_PACKAGE_EXTENSIONS,aA.file_extension_for_logging(j.name))&&j.size%34===0)||(aA.file_extension_for_logging(j.name)===""&&j.size%34===0&&j.size<=3400);if(i){j.status=q.FAILED;T={file:j,code:cE.APPLE_PACKAGE_ERROR,message:eG("Can\u2019t Upload"),tooltip_text:eG('To upload a package file via the web, try zipping it first, or <a href="https://www.dropbox.com/help/6691" target="_blank">learn more</a>.'),response:"",responseHeaders:"",status:400};this.uploadError(this.PLU,T);return false}ft={dest:aq.next().dest,t:bw.read(aK.JS_CSRF_COOKIE)};ft[a9.UID_PARAM_NAME]=cu.active_user;if((fr=aA.file_extension(j.name,fs=true))==="url"||fr==="webloc"||fr==="website"){ft.overwrite=0}cE.updatePostParams(ft);this.PLU.start();aq.last_update_time=0;aq.last_update_size=0;return true},pause:function(){return cE.PLU.stop()},uploadProgress:function(j,i){if(!aq.cancelled_files[i.id]){document.fire(this.UPDATE_EVT,{file:i,percent_complete:i.loaded/i.size});return bF(document).trigger(this.UPDATE_EVT,{file:i,percent_complete:i.loaded/i.size})}},generateUploadId:function(){var T,fs,fr,ft;T="";for(fs=fr=0;fr<=15;fs=++fr){T+=String.fromCharCode(Math.floor(Math.random()*256))}ft=ak.encode(T);ft=ft.replace(/\+/g,"-");ft=ft.replace(/\//g,"_");ft=ft.replace(/\=*$/,"");return ft},chunkUploaded:function(j,T,fr){var i;i=JSON.parse(fr.response||"");return this.updatePostParams({offset:i.offset})},prepareFileForUploading:function(){var i;i=aq.next();return this.updatePostParams({reported_total_size:i.size,dest:i.dest,t:bw.read(aK.JS_CSRF_COOKIE),upload_id:this.generateUploadId(),offset:0})},uploadSuccess:function(fs,fr,T){var j,ft,i;try{i=JSON.parse(T.response)}catch(ft){j=ft;i=null}if(T.response==="{'error': 'quota'}"){document.fire(this.ERROR_EVT,{file:fr,message:eG("Quota exceeded"),tooltip_text:eG("Your upload failed because you are over quota.")});return bF(document).trigger(this.ERROR_EVT,{file:fr,message:eG("Quota exceeded"),tooltip_text:eG("Your upload failed because you are over quota.")})}else{if(T.response==="{'error': 'empty'}"){document.fire(this.CANCEL_EVT,{file:fr,message:eG("Empty File")});return bF(document).trigger(this.CANCEL_EVT,{file:fr,message:eG("Empty File")})}else{if(T.response==="{'error': 'ignored'}"){document.fire(this.CANCEL_EVT,{file:fr,message:eG("File Ignored")});return bF(document).trigger(this.CANCEL_EVT,{file:fr,message:eG("File Ignored")})}else{if((i!=null?i.status:void 0)==="complete"){document.fire(this.COMPLETE_EVT,{file:fr});return bF(document).trigger(this.COMPLETE_EVT,{file:fr})}else{document.fire(this.ERROR_EVT,{file:fr});return bF(document).trigger(this.ERROR_EVT,{file:fr})}}}}},uploadComplete:function(j,i){document.fire(this.COMPLETE_EVT,{file:i});return bF(document).trigger(this.COMPLETE_EVT,{file:i})},uploadError:function(fs,i){var fr,T,j;if((j=i.file.id,cX.call(aq.file_ids(),j)<0)&&i.code!==cE.APPLE_PACKAGE_ERROR){document.fire(this.QUEUE_EVT,{files:[i.file]});bF(document).trigger(this.QUEUE_EVT,{files:[i.file]})}T=(function(){switch(i.code){case q.FILE_SIZE_ERROR:return eG("File too large");default:return eG("Upload Error")}})();this.show_upload();fr={file:i.file,error_code:i.code,message:T};if(i!=null?i.tooltip_text:void 0){fr.tooltip_text=i.tooltip_text}document.fire(this.ERROR_EVT,fr);return bF(document).trigger(this.ERROR_EVT,fr)},grabURL:function(){var i;i=$F("file-box");if(/(^http|^https|^ftp):\/\//.match(i)){$("url").value=i}return true},treeview_handler:function(j,i){var T;dB.fillVal(j,"dest-folder");T=$("basic-uploader-url");if(T){T.href=T.href.replace(/(\/upload)(.*)(\?basic=1)/,function(ft,fs,fu,fr){return fs+ec.urlquote(j)+fr})}return aq.clear()},new_folder:function(){b2.hide();fh.show(eG("Create new folder..."),dB.fromElm("create-folder"),{action:this.do_new_folder.bind(this,cu.active_user),wit_group:"new-folder-confirm"});if(!ec.ie){return bF("#first-treeview-link").trigger("click")}},do_new_folder:function(i){var T,j;if(!fh.vars.selected_path){ah.error(eG("Please select a parent folder."));return}j=$F("entered-name");T=fh.vars.selected_path;return new Ajax.DBRequest("/cmd/new"+ec.urlquote(T)+"?to_path="+ec.urlquote(j),{subject_user:i,onSuccess:(function(fr){return function(fs){fr.treeview_handler(aA.normalize(T)+"/"+j);return b2.schedule_reset()}})(this),cleanUp:function(){}})},uploaderLoaded:function(){$("upload-loading").hide();$("choose-button").show();if(cE.PLU.runtime==="flash"){bF("#flash-upload-container").clonePosition(bF("#choose-button"));bF("#flash-upload-container > .moxie-shim")[0].style.top="0px";bF("#flash-upload-container > .moxie-shim")[0].style.left="0px";bF("#flash-upload-container > .moxie-shim")[0].style.width="100%";return bF("#flash-upload-container > .moxie-shim")[0].style.height="100%"}else{bF("#choose-button").click((function(i){return function(j){return bF("#"+i.PLU.id+"_html5").click()}})(this));return bF("#add-button").click((function(i){return function(j){return bF("#choose-button").click()}})(this))}}};aq=F.FileQueue={init:function(){return aq._listen()},_listen:function(){document.observe(cE.QUEUE_EVT,aq._file_queued.bind(this));document.observe(cE.QUEUE_ERROR_EVT,aq._file_queue_errored.bind(this));document.observe(cE.UPDATE_EVT,aq._file_updated.bind(this));document.observe(cE.COMPLETE_EVT,aq._file_completed.bind(this));document.observe(cE.ERROR_EVT,aq._file_errored.bind(this));return document.observe(cE.CANCEL_EVT,aq._file_cancelled.bind(this))},_file_queued:function(fu){var fs,T,i,ft,fr;ft=fu.memo.files;fr=[];for(T=0,i=ft.length;T<i;T++){fs=ft[T];this.files[fs.id]=fs;if(!aq.uploading){this._start_uploading()}this.current_file=fs;fr.push(eO("File queued:",fs.name))}return fr},_file_queue_errored:function(i){this._file_queued(i);return setTimeout(((function(j){return function(){return j._file_errored(i)}})(this)),250)},_file_updated:function(fw){var fr,i,j,T,fu,ft,fs,fv,fx;T=fw.memo.file;ft=fw.memo.percent_complete;fu=ft*T.size;fx=fu+this.completed_size();j=new Date().getTime();if(this.last_update_time){fs=(j-this.last_update_time)/1000;if(cE.PLU.total.bytesPerSec){this.average_bps=cE.PLU.total.bytesPerSec}else{i=fu-this.last_update_size;fr=i/fs;this.average_bps=((fx-i)*this.average_bps+i*fr)/fx}fv=(this.queue_size()-fx)/this.average_bps;this.formatted_time=b6.format_time(fv+this.num_left())}this.current_file=T;this.last_update_time=new Date().getTime();return this.last_update_size=fu},_file_completed:function(j){var i;i=j.memo.file;this.completed_files[i.id]=true;eO("File completed:",i.name);return this._check_if_finished(i)},_file_errored:function(j){var i;i=j.memo.file;this.errored_files[i.id]=true;eK.update_errors();c6.update_errors();eO("File errored:",i.name);return this._check_if_finished(i)},_file_cancelled:function(j){var i;i=j.memo.file;this.cancelled_files[i.id]=true;if(i.status===q.UPLOADING){cE.PLU.stop();cE.PLU.removeFile(i);cE.PLU.start()}else{cE.PLU.removeFile(i)}eO("File cancelled:",i.name);return this._check_if_finished(i)},_start_uploading:function(){var i;this.uploading=cE.uploadNext();if(this.uploading){this.all_cancelled=false;return window.onbeforeunload=i=(function(j){return function(){return eG("Leaving this page will cancel your uploads.")}})(this)}},finished:function(){return this._finished_uploading()},_check_if_finished:function(i){if(this.empty()){if(this.uploading){return this._finished_uploading()}}else{return cE.uploadNext()}},_finished_uploading:function(){var j,T,fr,i;this.uploading=false;if(!this.num_files()){eK.cancelled()}else{if(this.errors()){eK.errored();c6.errored()}else{eK.completed();c6.completed()}}i=$("inline-upload-status").visible();cu.select_fq_paths=[];if(cu.inside_dir){for(fr in this.completed_files){T=this.files[fr];j=aA.normalize(T.dest);cu.select_fq_paths.push(j+"/"+T.name)}cu.force_reload()}else{if(cu.in_search_mode()){cb.force_reload()}}if(i){c6.show()}fh.onHide=null;return window.onbeforeunload=null},empty:function(){return !this.num_left()},num_files:function(){return this.file_ids().length},num_non_cancelled_files:function(){return this.file_ids().length-this.cancels()},next:function(){return bx(this.files).filter((function(i){return function(j){return !(i.cancelled_files[j.id]||i.errored_files[j.id]||i.completed_files[j.id])}})(this))[0]},cancels:function(){return bx(this.cancelled_files).keys().length},errors:function(){return bx(this.errored_files).keys().length},queue_size:function(){var fr,fu,T,i,ft,fs;fs=0;ft=this.file_ids();for(T=0,i=ft.length;T<i;T++){fu=ft[T];fr=this.files[fu];if(!this.errored_files[fu]&&!this.cancelled_files[fu]&&typeof fr.size!=="undefined"){fs+=fr.size}}return fs},completed_size:function(){var ft,T,i,fs,fr;fr=0;fs=bx(this.completed_files).keys();for(T=0,i=fs.length;T<i;T++){ft=fs[T];if(typeof this.files[ft].size!=="undefined"){fr+=this.files[ft].size}}return fr},file_ids:function(){return bx(this.files).map((function(i){return function(j,T){return T}})(this))},totalPercentage:function(){return this.completed_size()/this.queue_size()},num_left:function(){return bx(this.file_ids()).filter((function(i){return function(j){return !(i.cancelled_files[j]||i.errored_files[j]||i.completed_files[j])}})(this)).length},clear:function(){this.files={};this.cancelled_files={};this.all_cancelled=false;this.errored_files={};this.completed_files={};this.last_update_time=0;this.last_update_size=0;this.average_bps=0;this.formatted_time="";this.uploading=false;window.onbeforeunload=null;if(typeof fh!=="undefined"&&fh!==null){return fh.onHide=null}}};aq.clear();d9=F.UploadFile={FILENAME_SNIPPET_LENGTH:15,DEST_SNIPPET_LENGTH:13,_tmpl:null,init:function(){d9._tmpl=fm.tmpl("upload_list_item_tmpl");return d9._listen()},_listen:function(){document.observe(cE.QUEUE_EVT,d9._file_queued);document.observe(cE.QUEUE_ERROR_EVT,d9._file_queue_errored);document.observe(cE.UPDATE_EVT,d9._file_updated);document.observe(cE.COMPLETE_EVT,d9._file_completed);document.observe(cE.ERROR_EVT,d9._file_errored);return document.observe(cE.CANCEL_EVT,d9._file_cancelled)},_file_queued:function(fu){var fs,T,i,ft,fr;ft=fu.memo.files;fr=[];for(T=0,i=ft.length;T<i;T++){fs=ft[T];fr.push((function(fv){var fB,j,fy,fA,fz,fC,fw,fx;fB=fv.dest;if(aa.is_quicksend_dest(fB)){aa.add_external_file(fv);return}fC=aF.format_bytes(fv.size||0);j=d9._tmpl({file:fv,icon:aA.file_icon(fv.name),filename_snippet:bU.em_snippet(fv.name,d9.FILENAME_SNIPPET_LENGTH),size:fC,dest:fB,dest_snippet:bU.em_snippet(eG("Dropbox")+fB,d9.DEST_SNIPPET_LENGTH,0),Sprite:cy});$("upload-files-list").__sert(j);fA=$(fv.id);fz=aq.num_files();if(dE.show_share_button_in_file_uploader){fy=bF("#"+fv.id);fy.find(".dest-col").hide()}fw=$("upload-files-list");if(fz<=6){fw.removeClassName("scroll")}else{fw.addClassName("scroll")}fw.scrollTop=fw.scrollHeight;fA.down(".dest").observe("click",function(){cu.reload_fqpath(fA.readAttribute("data-dest"),true);return fh.hide()});fx=fA.down(".status-col").down("a.small-x-button");fx.stopObserving("click");fx.observe("click",function(fD){document.fire(cE.CANCEL_EVT,{file:fv});return bF(document).trigger(cE.CANCEL_EVT,{file:fv})});return fA.down(".upload-progress-bar").setStyle({width:"0"})})(fs))}return fr},_file_queue_errored:function(i){d9._file_queued(i);return d9._file_errored(i)},_file_updated:function(fr){var T,fs,j,i;T=fr.memo.file;fs=$(T.id);if(aq.num_files()===1){i=eG("%(time_left)s left").format({time_left:aq.formatted_time});fs.down(".time-col").__date(i)}j=parseInt(T.percent,10)+"%";if(j==="100%"){fs.down(".time-col").__date();fs.down(".status-col").__date(new Element("img",{src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"}))}return fs.down(".upload-progress-bar").setStyle({width:j})},_file_completed:function(j){var i,T,fr;i=j.memo.file;i.completed=true;fr=$(i.id);fr.addClassName("complete");if(dE.show_share_button_in_file_uploader&&!aa.is_quicksend_dest(i.dest)){T=bF("#"+i.id);T.find(".share-link").show();ba.SharedFolderActivityLogger.log("web","share_button_in_uploader_impression",cu.active_user,{});T.on("click",function(fu){var ft,fs;fh.hide();ba.SharedFolderActivityLogger.log("web","share_button_in_uploader_click",cu.active_user,{});ft=i.dest+"/"+i.name;fs="file_uploader";return dE.shmodel(ft,fs)})}setTimeout(function(){return fr.down(".status-col").__date(cy.make("web","s_check"))},0);return fr.down(".upload-progress-bar").setStyle({width:"100%"})},_file_errored:function(j){var i,T;i=j.memo.file;T=$(i.id);if(T){return d9._actual_file_errored(j)}else{return setTimeout((function(fr){return function(){return d9._actual_file_errored(j)}})(this),0)}},_actual_file_errored:function(fs){var i,T,j,ft,fr;j=fs.memo.file;ft=$(j.id);ft.addClassName("error");ft.down(".dest-col").hide();ft.down(".time-col").__date();ft.down(".status-col").__date(Element("img",{src:"/static/images/nosync-vfl18cuTS.png",srcset:"/static/images/nosync@2x.png 2x"}));ft.down(".upload-progress-bar").setStyle({width:"100%"});if(aa.is_quicksend_dest(j.dest)){return}T=fs.memo.message||eG("Upload Error");i=void 0;if(fs.memo.tooltip_text){i=fs.memo.tooltip_text}else{i=eG('Something went wrong with the advanced uploader. If the problem persists, please use the <a id="basic_link">basic uploader</a> to upload via the website.');bF(document).on("click","a#basic_link",function(){dK.show_basic_upload();return false})}ft.down(".error-msg").__date(T);fr=ft.down(".error-details");fr.observe("mouseover",function(){return ep.show(fr,i)});return ft.down(".error-col").show()},_file_cancelled:function(j){var i,T;i=j.memo.file;T=$(i.id);T.addClassName("cancelled");T.down(".dest-col").__date(eG(j.memo.message||"Canceled"));T.down(".time-col").__date();T.down(".status-col").__date(Element("img",{src:"/static/images/cancelsync-vflGFIEUK.png",srcset:"/static/images/cancelsync@2x.png 2x"}));return T.down(".upload-progress-bar").setStyle({width:"100%"})}};eK=F.BulkUpload={init:function(){this.elem=$("bulk-upload-status");return eK._listen()},_listen:function(){document.observe(cE.QUEUE_EVT,eK._file_queued.bind(this));return document.observe(cE.UPDATE_EVT,eK._file_updated.bind(this))},_file_queued:function(j){var i;i=new Element("a",{"class":"small-x-button"});i.observe("click",function(){var ft,fu,fr,T,fs;aq.all_cancelled=true;ft=aq.file_ids().slice(0);fs=[];for(fr=0,T=ft.length;fr<T;fr++){fu=ft[fr];if(!aq.completed_files[fu]&&!aq.errored_files[fu]){document.fire(cE.CANCEL_EVT,{file:aq.files[fu]});fs.push(bF(document).trigger(cE.CANCEL_EVT,{file:aq.files[fu]}))}else{fs.push(void 0)}}return fs});return this.elem.down(".status").__date(i)},_file_updated:function(fr){var T,j,i;if(aq.num_files()>1){this.elem.removeClassName("error");this.elem.removeClassName("complete");this.elem.removeClassName("cancelled");T=bd("%d file","%d files",aq.num_non_cancelled_files()).format(aq.num_non_cancelled_files());this.elem.down(".num-files").__date(T);j=eG("- %(size)s").format({size:aF.format_bytes(cE.PLU.total.size)});this.elem.down(".size").__date(j);if(aq.formatted_time){i=eG("%(time_left)s left").format({time_left:aq.formatted_time});this.elem.down(".time-left").__date(i)}this.elem.down(".upload-progress-bar").style.width=Math.min(100,(aq.totalPercentage()*100||0).toFixed(2))+"%";this.elem.show();if(cE.PLU.runtime==="flash"){return bF("#flash-upload-container").clonePosition(bF("#add-button"))}}},update_errors:function(){var i;i=bd("- %d error","- %d errors",aq.errors()).format(aq.errors());return $("bulk-upload-status").down(".num-errors").__date(i)},completed:function(){var j,i;$("hide-button").hide();$("done-button").show();if(aq.num_files()>1){this.elem.addClassName("complete");j=bd("Uploaded %d file","Uploaded %d files",aq.num_non_cancelled_files()).format(aq.num_non_cancelled_files());this.elem.down(".num-files").__date(j);i=eG("- %(size)s").format({size:aF.format_bytes(aq.completed_size())});this.elem.down(".size").__date(i);this.elem.down(".num-errors").__date();this.elem.down(".time-left").__date();this.elem.down(".status").__date(cy.make("web","s_check"));return this.elem.down(".upload-progress-bar").style.width="100%"}},errored:function(){var i;$("hide-button").hide();$("done-button").show();this.completed();i=bd("- %d error","- %d errors",aq.errors()).format(aq.errors());return this.elem.down(".num-errors").__date(i)},cancelled:function(){$("hide-button").hide();$("done-button").show();if(aq.num_files()>1){this.elem.addClassName("cancelled");this.elem.down(".num-files").__date(eG("All uploads canceled"));this.elem.down(".size").__date();this.elem.down(".num-errors").__date();this.elem.down(".time-left").__date();this.elem.down(".status").__date(Element("img",{src:"/static/images/cancelsync-vflGFIEUK.png",srcset:"/static/images/cancelsync@2x.png 2x"}));return this.elem.down(".upload-progress-bar").style.width="100%"}}};c6=F.InlineUploadStatus={FILENAME_SNIPPET_LENGTH:30,init:function(){return this._listen()},_listen:function(){document.observe(cE.QUEUE_EVT,c6._file_queued.bind(this));return document.observe(cE.UPDATE_EVT,c6._file_updated.bind(this))},_file_queued:function(T){var j,i;j=$("inline-upload-status");j.removeClassName("error");j.removeClassName("complete");j.down(".icon").__date(cy.make("web","s_sync"));j.down(".file-desc").__date(eG("Starting upload..."));j.down(".num-errors").__date();i=bd("%d file","%d files",aq.num_left()).format(aq.num_left());j.down(".view-details").__date(i);j.down(".status").__date();return j.down(".inline-upload-progress").style.width="0%"},_file_updated:function(fu){var ft,T,fr,fs,j,i;ft=$("inline-upload-status");T=fu.memo.file;ft.down(".icon").__date(cy.make("web","s_sync"));fr=eG("Uploading %(filename)s").format({filename:bU.em_snippet(T.name,this.FILENAME_SNIPPET_LENGTH)});ft.down(".file-desc").__date(fr);if(aq.num_left()>1){i=bd("%d file left","%d files left",aq.num_left()-1).format(aq.num_left()-1);ft.down(".view-details").__date(i)}else{ft.down(".view-details").__date(eG("View details"))}if(aq.formatted_time){j=eG("%(time_left)s left").format({time_left:aq.formatted_time});ft.down(".status").__date(j)}fs=T.percent+"%";return ft.down(".inline-upload-progress").style.width=fs},update_errors:function(){var i,j;i=$("inline-upload-status");j=bd("- %d error","- %d errors",aq.errors()).format(aq.errors());return i.down(".num-errors").__date(j)},add_x_button:function(){var i,j;j=new Element("a",{"class":"small-x-button"});j.observe("click",function(){c6.hide();return cE.reset()});i=$("inline-upload-status");return i.down(".status").__date(j)},completed:function(){var j,i;j=$("inline-upload-status");j.addClassName("complete");j.removeClassName("error");j.down(".icon").__date(cy.make("web","s_check"));if(aq.num_files()>1){i=eG("Uploaded %(num_files)d files").format({num_files:aq.num_non_cancelled_files()})}else{i=eG("Uploaded %(filename)s").format({filename:bU.em_snippet(aq.current_file.name,this.FILENAME_SNIPPET_LENGTH)})}j.down(".file-desc").__date(i);j.down(".num-errors").__date();j.down(".view-details").__date(eG("View details"));this.add_x_button();return j.down(".inline-upload-progress").style.width="100%"},errored:function(){var T,j,i,fr;T=$("inline-upload-status");T.addClassName("error");T.removeClassName("complete");T.down(".icon").__date(Element("img",{src:"/static/images/nosync-vfl18cuTS.png",srcset:"/static/images/nosync@2x.png 2x"}));j=void 0;if(aq.num_files()>1){j=eG("Uploaded %(num_completed)d of %(num_files)d files").format({num_completed:aq.num_non_cancelled_files()-aq.errors(),num_files:aq.num_non_cancelled_files()});T.down(".file-desc").__date(j);fr=bd("- %d error","- %d errors",aq.errors()).format(aq.errors());T.down(".num-errors").__date(fr)}else{if(aq.current_file!=null){i=bU.em_snippet(aq.current_file.name,this.FILENAME_SNIPPET_LENGTH)}j=i?eG("Unable to upload %(filename)s").format({filename:i}):eG("Unable to upload file");T.down(".file-desc").__date(j);T.down(".num-errors").__date()}T.down(".view-details").__date(eG("View details"));this.add_x_button();return T.down(".inline-upload-progress").style.width="100%"},show:function(i){return $("inline-upload-status").show()},hide:function(){return $("inline-upload-status").hide()}};bp=F.UploadPrep={_drop_indicators:false,_drop_dest_folder:null,file_counter:0,current_req:null,_notifications_cleared:false,supported:function(){return Prototype.BrowserFeatures.DB_CORS},enabled:function(){return bp.supported()&&cu.inside_dir&&!(cu.in_search_mode()&&cb.fulltext_search_enabled)},browse_indicators_enabled:function(){var fs,T,i,fr;if(!bp.enabled()){return false}fr=["modal-overlay"];for(T=0,i=fr.length;T<i;T++){fs=fr[T];if($(fs).visible()){return false}}return true},modal_indicators_enabled:function(){var i;return bp.enabled()&&bF("#modal #upload-modal-dropzone").length&&bF("#modal").visible()&&((i=bF("#modal").offset())!=null?i.left:void 0)>0},_show_border_drop_indicators:function(){return $$(".external-drop-indicator").each(function(i){return bF(i).css("opacity",0).fadeTo(500,0.6)})},_hide_border_drop_indicators:function(){return $$(".external-drop-indicator").invoke("hide")},show_drop_indicators:function(j){var i;if(!bp._drop_indicators){if(bp.modal_indicators_enabled()){i=$("upload-modal-dropzone");bF(i).clonePosition(bF("#modal"),{setLeft:false,setTop:false});bF(i).fadeIn(500);bp._show_border_drop_indicators()}else{if(bp.browse_indicators_enabled()){bR._add_drop_indicators(j)}else{return}}$("drag-status").removeClassName("active");return bp._drop_indicators=true}},hide_drop_indicators:function(){if(bp._drop_indicators){bp._hide_border_drop_indicators();bR._remove_drop_indicators();if(!bp._notifications_cleared){ah.clear()}$("upload-modal-dropzone").hide();$("drag-status").addClassName("active");setTimeout((function(){bp._drop_indicators=false;bp._drop_dest_folder=null;return bp._notifications_cleared=false}),500)}return bp._notifications_cleared=true},folder_dragover:function(i){var j;if(bp.browse_indicators_enabled()&&bp._drop_indicators){if(dZ.disabled){if(bp._drop_dest_folder==null){j=eG("You can't upload files because you're out of space.");ah.error(j,60);bp._notifications_cleared=false;bp._show_border_drop_indicators()}}else{if(i!==bp._drop_dest_folder){if(i===cu.containing_fq_path()){if(cu.inside_read_only_shared_folder){j=eG("You don't have permission to add to this folder.");ah.error(j,60)}else{j=eG("Drop your file to %(upload_action)s",{comment:"upload_action is a phrase like 'upload to folder 'XYZ'"}).format({upload_action:dK.upload_plain_snippet()});ah.success(new fm(j),60);bp._show_border_drop_indicators()}bp._notifications_cleared=false}else{ah.clear();bp._hide_border_drop_indicators()}}}return bp._drop_dest_folder=i}},supports_recursive_upload:function(i){var j;return window.File&&window.FileReader&&window.FileList&&window.Blob&&(i!=null?(j=i[0])!=null?j.webkitGetAsEntry:void 0:void 0)},upload:function(fs,fu,T){var ft,fr,i,fv;if(T==null){T=null}if(cu.inside_read_only_shared_folder){return}if(dZ.disabled){fv=eG("You can't upload files because you're out of space.");return ah.error(fv)}else{if(bp.supports_recursive_upload(T)){return bp._recursive_upload(fs,T)}else{for(fr=0,i=fu.length;fr<i;fr++){ft=fu[fr];ft.dest=fs}return bp._upload(fu,T)}}},_recursive_upload:function(fA,fy){var fC,fx,i,fr,fs,fz,fw,fD,T,fB,ft,fv,fu;T=[];fu=[];fx=function(j,fE){j.dest=fA+aA.parent_dir(fE.fullPath);return T.push(j)};for(ft=0,fv=fy.length;ft<fv;ft++){fB=fy[ft];fz=fB.webkitGetAsEntry();if(fz!==null){if(fz.isDirectory){if(aa.is_quicksend_dest(fA)){ah.error(eG("Please select files instead of folders."))}else{fu.push(fz)}}else{fx(fB.getAsFile(),fz)}}}fs=0;fD=0;i=function(j,fF){var fE;fE=eG('The drag and drop uploader can\'t upload %(name)s because it contains Unicode characters. Use the <a id="use-advanced-uploader"> advanced uploader</a> instead.').format({name:fF.name});ah.error(new fm(fE));return bF("#use-advanced-uploader").on("click",function(fG){fG.preventDefault();return dK.show_upload()})};fC=3000;fw=0;fr=function(){var j;while(fu.length){fz=fu.pop();if(fz!==null){if(fz.isDirectory){(function(fF){var fE;fE=fF.createReader();fs+=1;return fE.readEntries(function(fG){var fJ,fH,fI;if(fG.length!==0){for(fH=0,fI=fG.length;fH<fI;fH++){fJ=fG[fH];fu.push(fJ)}return fE.readEntries(arguments.callee)}else{return fs-=1}},function(fG){fs-=1;return i(fG,fF)})})(fz)}else{fD+=1;j=function(fE){return function(fF){fx(fF,fE);return fD-=1}};fz.file(j(fz),function(fE){fD-=1;return i(fE,fz)})}}}if(T.length>fC&&!fw){fw=1;ah.error(eG("The Dropbox website can't upload more than %(max_files)s files.").format({max_files:fC}));return}if(fs||fD){return fr.defer()}else{if(T.length){return bp._upload(T)}}};return fr()},_upload:function(fr,j){var i,T;if(j==null){j=null}if(j){i=this._parse_upload_items(j)}T=function(){var fv,ft,fs,fw,fu;fu=[];for(ft=0,fs=fr.length;ft<fs;ft++){fv=fr[ft];if(navigator.userAgent.toLowerCase().indexOf("chrome")>-1&&(i!=null?(fw=i[fv.name])!=null?fw.isDirectory:void 0:void 0)){fv.is_directory=true}fv.id=q.guid();fu.push(cE.PLU.addFile(fv))}return fu};if($("modal").visible()){return T()}else{dK.show_upload(T);return fh.hide(null,true)}},_parse_upload_items:function(T){var fs,ft,fr,i;fs={};for(fr=0,i=T.length;fr<i;fr++){ft=T[fr];if(ft.getAsEntry){ft=ft.getAsEntry()}else{if(ft.webkitGetAsEntry){ft=ft.webkitGetAsEntry()}}fs[ft.name]=ft}return fs}};dZ=F.OverQuotaUploads={disabled:false,init:function(i){this.disabled=i;if(this.disabled){return bF("body").addClass("uploads-disabled")}}};var dK;dK=INLINE_JS.FileOps=F.FileOps={NOTIFICATION_SNIPPET_LEN:40,_find_app_by_id:function(fr){var ft,T,i,fs;fs=fh.vars.apps;for(T=0,i=fs.length;T<i;T++){ft=fs[T];if(ft.app_id!==fr){continue}return ft}return null},create_album_from_folder:function(j,i){return cG.WebProgressRequest({url:"/collection_from_folder",data:{path:j,album_name:i},subject_user:cQ.get_viewer().photos_user,progress_text:eG("Creating album..."),success:function(T){T=JSON.parse(T);return b1.redirect(T.url)}})},dir_handler:function(fr,T){var j,i;if(typeof T==="string"){T=$(T)}j=$$(".treeview .highlight")[0];if(j){j.removeClassName("highlight")}i=T.up("div");i.addClassName("highlight");fh.selected_div=i;if(fh.shown()){T.blur()}document.fire("db:dir_click",{path:fr});return fh.vars.selected_path=fr},show_folder_pick:function(ft,fr,T,fs,i){var j;dB.fillVal(aA.filename(fr).escapeHTML(),"folder-pick-file");b2.move("copy-move-treeview","folder-pick-treeview",{user:cu.active_user});j=(i?eG("Move"):eG("Copy"));dB.fillVal(j,"folder-pick-action-text");fh.show(ft,$("folder-pick"),{fq_path:fr,action:T,folder:fs});return bF("#first-treeview-link").trigger("click")},show_bulk_folder_pick:function(fu,ft,fr,fs){var j,i,T;T=a5.profile_files(fr);i=a5.profile_summary(T);dB.fillVal(i,"bulk-folder-pick-file");b2.move("copy-move-treeview","bulk-folder-pick-treeview",{user:cu.active_user});if(ft==="move"){j=eG("Move")}else{if(ft==="copy"){j=eG("Copy")}else{j=eG("Restore")}}dB.fillVal(j,"bulk-folder-pick-action-text");fh.show(fu,$("bulk-folder-pick"),{files:fr,action:fs});return bF("#first-treeview-link").trigger("click")},show_copy:function(i,j){var T;T=(j?eG("Copy folder to..."):eG("Copy file to..."));b2.set_params({disable_read_only:true});return dK.show_folder_pick(T,i,dK.do_copy,j,false)},show_copy_bulk:function(i){var j;j=bd("Copy %(item_count)s item to...","Copy %(item_count)s items to...",i.length).format({item_count:i.length});b2.set_params({disable_read_only:true});return dK.show_bulk_folder_pick(j,"copy",i,dK.do_bulk_copy)},show_compress_bulk:function(i,j){b2.set_params({disable_read_only:true});return dT.show({title_text:bd("Compress file?","Compress files?",j.length),body_html:bd("Do you want to compress <strong>%(filename)s</strong>?<br/>This might take a while.","Do you want to compress %(file_count)s files?<br/>This might take a while.",j.length).format({file_count:j.length,filename:bx.escape(j.first().filename)}),confirm_text:eG("Compress"),cancel_text:eG("Cancel"),confirm_callback:function(){return dK.do_bulk_compress(i,j)}})},do_bulk_compress:function(i,T){var j;ah.clear();j=T.pluck("fq_path");return cG.WebProgressRequest({url:"/cmd/compress",data:{files:j},subject_user:i,progress_text:eG("Compressing..."),success:function(fu){var ft,fs,fr;fr=JSON.parse(fu);ft=fr.compressed_files;cP(ft.length>0,"Must have at least 1 compressed file");fs=bx.escape(aA.filename(ft.first().fq_path));ah.success(bd("Compressed successfully to %(filename)s","Compressed %(file_count)s files successfully.",ft.length).format({file_count:ft.length,filename:fs}));return bF(document).trigger(aH.COMPRESS,{original_files:T,compressed_files:ft})}})},show_move_bulk:function(i){var j;j=bd("Move %(item_count)s item to...","Move %(item_count)s items to...",i.length).format({item_count:i.length});b2.set_params({disable_read_only:true});return dK.show_bulk_folder_pick(j,"move",i,dK.do_bulk_move)},show_move:function(i,j){var T;T=(j?eG("Move folder to..."):eG("Move file to..."));b2.set_params({disable_read_only:true});return dK.show_folder_pick(T,i,dK.do_move,j,true)},show_delete:function(i,T,fr,j,fu,ft){var fs;if(fu==null){fu=null}if(ft==null){ft=false}if(ft){fs=eG("Are you sure you want to delete the shared folder \u2018<strong>%(items)s</strong>\u2019? This shared folder will stay shared with other members and you can rejoin it later.").format({items:aA.filename(T).escapeHTML()})}else{if(fu){fs=eG("Are you sure you want to delete <strong>%(items)s</strong> from the shared folder \u2018%(sf_name)s\u2019?").format({items:aA.filename(T).escapeHTML(),sf_name:fu.escapeHTML()})}else{fs=eG("Are you sure you want to delete <strong>%(items)s</strong> from your Dropbox?").format({items:aA.filename(T).escapeHTML()})}}return dT.show({title_text:fr?eG("Delete folder?"):eG("Delete file?"),body_html:'<div class="simple-modal-word-wrap-content">'+fs+"</div>",confirm_text:eG("Delete"),cancel_text:eG("Cancel"),confirm_callback:function(){if(j){return dK.do_nonbrowse_delete(i,[T])}else{return dK.do_delete(i,T)}}})},show_bulk_delete:function(i,j,fr){var T;if(fr==null){fr=null}if(fr){T=bd("Are you sure you want to delete %(item_count)s item from the shared folder \u2018%(sf_name)s\u2019?","Are you sure you want to delete %(item_count)s items from the shared folder \u2018%(sf_name)s\u2019?",j.length).format({item_count:j.length,sf_name:fr.escapeHTML()})}else{T=bd("Are you sure you want to delete %(item_count)s item from your Dropbox?","Are you sure you want to delete %(item_count)s items from your Dropbox?",j.length).format({item_count:j.length})}return dT.show({title_text:bd("Delete %(item_count)s item?","Delete %(item_count)s items?",j.length).format({item_count:j.length}),body_html:T,confirm_text:eG("Delete"),cancel_text:eG("Cancel"),confirm_callback:function(){return dK.do_bulk_delete(i,j)}})},show_purge:function(i,j){return dT.show({title_text:j?eG("Permanently delete folder?"):eG("Permanently delete file?"),body_html:eG("Are you sure you want to permanently delete <strong>%(items)s</strong> from your Dropbox?").format({items:aA.filename(i).escapeHTML()}),confirm_text:eG("Permanently delete"),cancel_text:eG("Cancel"),confirm_callback:function(){return dK.do_purge(cu.find_file(i))}})},show_bulk_purge:function(i){return dT.show({title_text:bd("Permanently delete %d item?","Permanently delete %d items?",i.length).format(i.length),body_html:bd("Are you sure you want to permanently delete %(item_count)s item from your Dropbox?","Are you sure you want to permanently delete %(item_count)s items from your Dropbox?",i.length).format({item_count:i.length}),confirm_text:eG("Permanently delete"),cancel_text:eG("Cancel"),confirm_callback:function(){return dK.do_bulk_purge(i)}})},show_bulk_restore:function(j,i){return dT.show({title_text:bd("Restore %d item...","Restore %d items...",j.length).format(j.length),body_html:bd("Are you sure you want to restore %(item_count)s item?","Are you sure you want to restore %(item_count)s items?",j.length).format({item_count:j.length}),confirm_text:eG("Restore"),cancel_text:eG("Cancel"),confirm_callback:function(){return dK.do_bulk_restore(j)}})},wrap_strong:function(i){if(cu.containing_fq_path()===""){return i.escapeHTML()}else{return"<strong>"+i.escapeHTML()+"</strong>"}},upload_snippet:function(T){var i,j;if(T==null){T=1000}if(cQ.get_viewer().is_paired&&cu.active_user.is_team){j=bU.em_snippet(cQ.get_viewer().team_name,T).escapeHTML()}if(cu.containing_fq_path()===""){if(cQ.get_viewer().is_paired){if(cu.active_user.is_team){return eG(" upload to your %(team_name)s Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({team_name:j})}else{return eG(" upload to your personal Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"})}}else{return eG(" upload to your Dropbox")}}else{i=bU.em_snippet(aA.filename(cu.containing_fq_path()),T).escapeHTML();if(cQ.get_viewer().is_paired){if(cu.active_user.is_team){return eG(" upload to the folder <strong>%(folder)s</strong> in your %(team_name)s Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({folder:i,team_name:j})}else{return eG(" upload to the folder <strong>%(folder)s</strong> in your personal Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({folder:i})}}else{return eG(" upload to the folder <strong>%(folder)s</strong>",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({folder:i})}}},upload_short_snippet:function(T){var j,i;if(T==null){T=1000}i=cu.containing_fq_path();if(!i){return eG("Upload to Dropbox",{comment:"Upload a file to the root Dropbox folder"})}j=bU.em_snippet(aA.filename(i),T);return eG("Upload to '%(folder_name)s'",{comment:"Upload a file to some folder on the website"}).format({folder_name:j})},upload_plain_snippet:function(i){if(i==null){i=1000}return this.upload_snippet(i).replace("<strong>","'").replace("</strong>","'")},show_upload:function(fx,i,fv){var fs,ft,fu,fw,fr,T;fs=cu.containing_fq_path();if(dZ.disabled){dB.fillVal(this.wrap_strong(aA.filename(fs)),"disabled-upload-foldername");fr=this.upload_short_snippet(20);fh.show(fr,$("disabled-upload-modal"),{},false);return}if((!FlashDetect.versionAtLeast(9))&&cE.runtimes==="flash"){dK.show_basic_upload();$("enhanced-upload-toggle").hide();return}dB.fillVal(this.upload_snippet(20),"upload-foldername");dB.fillVal(this.upload_plain_snippet(10),"dnd-upload-foldername");if($("upload-desc").visible()&&bp.supported()){$("upload-desc").hide();$("dnd-upload-desc").show()}fr=this.upload_short_snippet(20);fh.show(fr,dB.fromElm("advanced-upload-modal"),{wit_group:"advanced-uploader"},false,false,aq.num_files());T=[$("modal").down(".basic-link-start"),$("modal").down(".basic-link-running")];for(ft=0,fu=T.length;ft<fu;ft++){fw=T[ft];if(fw!=null){fw.observe("click",function(){dK.show_basic_upload();return false})}}if(!aq.num_files()){cE.init(aA.normalize(fs),true,fx,fv)}else{cE.set_dest(aA.normalize(fs))}return c6.hide()},show_basic_upload:function(){dB.fillVal(this.upload_snippet(20),"basic-upload-foldername");fh.show(this.upload_short_snippet(20),$("basic-upload-modal"),{},false);$("modal").down(".enhanced-link").observe("click",function(){dK.show_upload();return false});cE.set_dest(aA.normalize(cu.containing_fq_path()));return cE.init_basic()},show_undelete:function(i){var j,T,fr;dB.fillVal(i.filename.escapeHTML(),"undelete_filename");j=cy.make("web",i.icon,{});j.addClassName("link-img");j.style.backgroundColor="transparent";T=dK.build_revisions_uri(i.fq_path,cu.active_user,{undelete:1});$$(".undelete-icon").invoke("update",j);$$(".undelete-other-versions")[0].href=T;$$(".undelete-link")[0].href=T;fr=eG("Restore file?");return fh.show(fr,$("undelete-modal"),{file:i})},do_undelete:function(j){var i,T;i=fh.vars.file;T=eG("Restored '%(file_name)s'").format({file_name:i.filename});new Ajax.DBRequest("/cmd/restore",{parameters:{files:[i.fq_path]},subject_user:cu.active_user,job:true,html_in_error_msg:true,progress_text:eG("Restoring..."),onSuccess:function(fr){fh.hide();ah.success(T);return document.fire(aH.RESTORE,{files:[i]})}});return false},do_copy:function(T,j){var i;T=T||fh.vars.fq_path;j=j||fh.vars.selected_path;i=cu.find_file(T);cP(i,"Trying to copy a file we couldn't find.");return dK.do_bulk_copy([i],j)},do_bulk_copy:function(fw,fr){var fu,fv,ft,fs,T;cu.pre_action_selection=e2.get_selected_fq_paths();fw=fw||fh.vars.files;cP(fw.length>0,"Tried to copy 0 files");if(typeof fr==="undefined"){if(typeof fh.vars.selected_path==="undefined"){ah.error(eG("You need to select a destination for the file."));return}else{fr=fh.vars.selected_path}}fr=aA.normalize(fr);ft=0;for(fs=0,T=fw.length;fs<T;fs++){fu=fw[fs];if(fu.dir){if((fr+"/").indexOf(fu.fq_path+"/")===0){ah.error(eG("You cannot copy a folder into itself."));return}}}fv=fw.pluck("fq_path");ah.clear();return new Ajax.DBRequest("/cmd/copy",{parameters:{files:fv,to_path:fr},subject_user:cu.active_user,job:true,html_in_error_msg:true,progress_text:eG("Copying..."),onSuccess:function(fC){var fy,fB,i,fz,fA,fD,fx,j;fy=fC.responseText.evalJSON().changesets;fB=fv.length;fD=bU.em_snippet(aA.filename(fr),dK.NOTIFICATION_SNIPPET_LEN).escapeHTML();fx=bd("Copied %(count)d item to '<a id=\"reload-link\">%(location)s</a>'.","Copied %(count)d items to '<a id=\"reload-link\">%(location)s</a>'.",fB);fx=fx.format({count:fB,location:fD});Y.notifyWithUndo(new fm(fx),fy,dK.do_rollback);i=[];j=fC.responseText.evalJSON().new_browse_files;for(fz=0,fA=j.length;fz<fA;fz++){fu=j[fz];i.push(fu.fq_path)}cu.select_fq_paths=i;$("reload-link").observe("click",function(){return a4.set_path_url(null,fr)});b2.schedule_reset();return document.fire(aH.COPY,{files:fw,to_fq_path:fr})}})},bulk_move_error:function(i,fw){var fu,fr,fx,fs,fy,ft,j,T,fv;fx=cu.find_file(fw);fs=a5.profile_files(i);T=void 0;ft=void 0;fv=void 0;if(fx){ft=fx.dir;T=fx.fq_path;fv=fx.target_ns||fx.ns_id}else{if(cu.inside_dir&&cu.can_get_details_from_fq_path(fw)){fr=cu.details_from_fq_path(fw);ft=true;T=fr.fq_path;fv=fr.ns_id}else{ft=true;T=fw;fv=void 0}}fy=i.pluck("fq_path").collect(aA.normalize);if(-1!==fy.indexOf(aA.normalize(T))){return eG("You cannot copy a folder into itself.")}fu=j=function(fz){var fA;fA=aA.parent_dir(fz.fq_path);return fA===(T||"/")};if(i.all(fu)){return bd("That file already exists in that folder.","Those files already exist in that folder.",i.length)}if(!ft){return eG("You cannot put files inside one another.")}if(fs.target_namespaces>0&&fv&&fv!==Constants.root_ns&&fx){if(fs.sandboxes>0){if(fx.is_sandbox()){return eG("You're not allowed to put an application folder inside another application folder.")}else{if(fx.is_shared_folder()){return eG("You're not allowed to put an application folder inside a shared folder.")}}}else{if(fs.shared_folders>0){if(fx.is_sandbox()){return eG("You're not allowed to put a shared folder inside an application folder.")}else{if(fx.can_hold_shared_folders&&fs.team_shared_folders===0){return}else{if(fx.is_shared_folder()){return eG("You're not allowed to put a shared folder inside another shared folder.")}}}}}return eG("You're not allowed to nest special folders.")}if(cu.public_folder_enabled){if(T==="/Public"&&fs.target_namespaces>0){return eG("You're not allowed to move shared folders to your Public folder.")}}if(fs.public_folder>0){return eG("You're not allowed to move your Public folder.")}if(fs.deleted>0){return eG("Moving deleted folders or files isn\u2019t allowed.")}},do_move:function(T,j){var i;T=T||fh.vars.fq_path;j=j||fh.vars.selected_path;i=cu.find_file(T);cP(i,"Trying to move a file we couldn't find.");return dK.do_bulk_move([i],j)},do_nonbrowse_move:function(fr,fs,j){var i,T;i=bF.Deferred();T="/cmd/move";new Ajax.DBRequest(T,{parameters:{files:fs,to_path:j},subject_user:fr,job:true,html_in_error_msg:true,progress_text:eG("Moving\u2026"),onSuccess:i.resolve,onFailure:i.reject});return i.promise()},do_bulk_move:function(fr,ft){var j,T,fs,i;cu.pre_action_selection=e2.get_selected_fq_paths();fr=fr||fh.vars.files;if(!fr){return}cP(fr.length>0,"Tried to move 0 files");i=ft||fh.vars.selected_path||"";i=aA.normalize(i);j=dK.bulk_move_error(fr,i);if(j){ah.error(j);return}T=fr.pluck("fq_path");ah.clear();fs=function(fx){var fw,fv,fu,fy;fw=fx.responseText.evalJSON().changesets;fv=T.length;fu=bU.em_snippet(aA.filename(i),dK.NOTIFICATION_SNIPPET_LEN).escapeHTML();fy=bd('Moved %(count)d item to \u2018<a id="reload-link">%(location)s</a>\u2019.','Moved %(count)d items to \u2018<a id="reload-link">%(location)s</a>\u2019.',fv);fy=fy.format({count:fv,location:fu});Y.notifyWithUndo(new fm(fy),fw,dK.do_rollback);$("reload-link").observe("click",function(){return a4.set_path_url(null,i)});b2.schedule_reset();return document.fire(aH.MOVE,{files:fr,to_fq_path:i})};return dK.do_nonbrowse_move(cu.active_user.id,T,i).then(fs)},do_rollback:function(i){return new Ajax.DBRequest("/cmd/rollback",{parameters:{ns_to_cs:JSON.stringify(i)},subject_user:cu.active_user,job:true,html_in_error_msg:true,progress_text:eG("Undoing..."),onSuccess:function(j){var T;T=eG("Undo complete.");ah.success(T);cP(cu.pre_action_selection instanceof Array,"Expected a selection from before the action to be undone");if(cu.in_search_mode()){cb.select_fq_paths=cu.pre_action_selection;cb.force_reload()}else{cu.select_fq_paths=cu.pre_action_selection;cu.force_reload()}return cu.pre_action_selection=false}})},do_bulk_delete:function(i,fr){var j,T;cu.pre_action_selection=e2.get_selected_fq_paths();fr=fr||fh.vars.files;cP(fr.length>0,"Tried to delete 0 files");T=(function(){var ft,fs,fu;fu=[];for(ft=0,fs=fr.length;ft<fs;ft++){j=fr[ft];fu.push(j.fq_path)}return fu})();ah.clear();return new Ajax.DBRequest("/cmd/delete",{parameters:{files:T},subject_user:i,job:true,html_in_error_msg:true,progress_text:eG("Deleting..."),onSuccess:function(fs){var fu,ft;ft=fs.responseText.evalJSON();fu=bd("Deleted %d item.","Deleted %d items.",T.length).format(T.length);Y.notifyWithUndo(fu,ft.changesets,dK.do_rollback);b2.schedule_reset();return document.fire(aH.DELETE,{files:fr})}})},do_delete:function(i,T){var j;j=cu.find_file(T||fh.vars.fq_path);cP(j,"Trying to delete a file we couldn't find.");return dK.do_bulk_delete(i,[j])},do_nonbrowse_delete:function(j,fr){var i,T;i=bF.Deferred();T=bd("Deleted %(file_count)s item","Deleted %(file_count)s items",fr.length);T=T.format({file_count:fr.length});ah.success(T);new Ajax.DBRequest("/cmd/delete",{parameters:{files:fr},subject_user:j,html_in_error_msg:true,onSuccess:function(fs){document.fire(aH.DELETE,{fq_paths:fr});return i.resolve(fs)},onFailure:function(fs){ah.error(eG("Failed to perform the delete. Please try again later."));return i.reject(fs)}});return i.promise()},do_nonbrowse_rename:function(T,fr,j){var i;i=bF.Deferred();new Ajax.DBRequest("/cmd/rename"+encodeURIComponent(fr),{parameters:{to_path:j},subject_user:T,html_in_error_msg:true,onSuccess:function(fs){return i.resolve(fs)},onFailure:function(fs){return i.reject(fs)}});return i.promise()},do_purge:function(i){cP(i,"Trying to purge a file we couldn't find.");return dK.do_bulk_purge([i])},do_bulk_purge:function(j){var i,T;cP(j.length>0,"Tried to purge 0 files");i=j.collect(function(fr){return fr.fq_path});T=bd("Permanently deleted %d item","Permanently deleted %d items",i.length).format(i.length);return new Ajax.DBRequest("/cmd/purge",{parameters:{files:i},subject_user:cu.active_user,job:true,html_in_error_msg:true,progress_text:eG("Deleting..."),onSuccess:function(fr){ah.success(T);b2.schedule_reset();return document.fire(aH.PURGE,{files:j})}})},do_bulk_restore:function(T){var j,fr,i;T=T||fh.vars.files;i=fh.vars.user;cP(T.length>0,"Tried to restore 0 files");j=T.collect(function(fs){return fs.fq_path});fr=bd("Restored %d item","Restored %d items",j.length,{comment:"meaning, successfully restored x files and folders"}).format(j.length);return new Ajax.DBRequest("/cmd/restore",{parameters:{files:j},subject_user:cu.active_user,job:true,html_in_error_msg:true,progress_text:eG("Restoring..."),onSuccess:function(fs){ah.success(fr);b2.schedule_reset();return document.fire(aH.RESTORE,{files:T})}})},do_folder_restore:function(j,i){var T;T=function(fr){var ft,fs;ft=eG("Restoring '%(folder_name)s'").format({folder_name:aA.filename(j)});fs=fr.responseText;if(fs.startsWith("err:")){fs=fs.substring(4);bF("#async-result").html(fs);ah.error(new fm(fs),60)}else{ft=eG("Restored '%(folder_name)s'").format({folder_name:aA.filename(j)});bF("#status-of-files").text(eG("Restored files"));ah.success(ft,60)}bF("#restore-done-heading").text(ft);bF(".pre-restore").hide();return bF(".post-restore").show()};return new Ajax.DBRequest("/cmd/restore",{parameters:{files:[j]},job:true,html_in_error_msg:true,progress_text:eG("Restoring..."),onSuccess:T,onFailure:T,subject_user:i})},do_bulk_download:function(fs){var ft,fr,T,i;ft=new Element("form",{action:H({scheme:"https",authority:Constants.BLOCK_CLUSTER,path:"/zip_batch"}).updateQuery(a9.UID_PARAM_NAME,cu.active_user.id).toString(),method:"post"});for(T=0,i=fs.length;T<i;T++){fr=fs[T];bT.add_vars(ft,{files:fr.fq_path})}bT.add_vars(ft,{parent_path:cu.block_hash_param||"/",w:cu.block_hash});$(document.body).__sert(ft);return ft.submit()},do_bulk_photo_view:function(T,i){var ft,fs,j,fr;if(i==="carousel"||i==="carousel_as_dropbox_photos"){fr={};fr[a9.UID_PARAM_NAME]=cQ.get_viewer().personal_user.id;ft=String(H({scheme:"https",authority:fp.WEBSERVER,path:"/app/view_in_timeline",query:fr}))}else{ft=String(H({scheme:"https",authority:fp.WEBSERVER,path:"/photos"}))}fs=new Element("form",{action:ft,method:"post"});bT.add_vars(fs,{t:bw.read(aK.JS_CSRF_COOKIE),ns_ids:JSON.stringify((function(){var fv,fu,fw;fw=[];for(fv=0,fu=T.length;fv<fu;fv++){j=T[fv];fw.push(j.ns_id)}return fw})()),ns_paths:JSON.stringify((function(){var fv,fu,fw;fw=[];for(fv=0,fu=T.length;fv<fu;fv++){j=T[fv];fw.push(j.ns_path)}return fw})())});$(document.body).__sert(fs);return fs.submit()},build_revisions_uri:function(T,i,j){if(j==null){j={}}j[a9.UID_PARAM_NAME]=String(i);if(az.getGandalfRule("revision-history-web")){return H({path:"/history"+T}).updateQuery(j)}else{return H({path:"/revisions"+T}).updateQuery(j)}}};var bT,dq={}.hasOwnProperty;bT=__CONDITIONAL_JS__.Forms=INLINE_JS.Forms=F.Forms={submitOnlyOnce:function(){var i;i=bT.submitted!==true;bT.submitted=true;return i},disable:function(i){if(i){return setTimeout((function(){return i.disabled=true}),0)}},enable:function(i){if(i){return setTimeout((function(){return i.disabled=false}),0)}},show_button_on_change:function(i,fr){var T,fs,ft,j;T=bF(i);T.hide();if(fr==null){fr=T.closest("form")}fs=fr[0];if(this.next_id==null){this.next_id=0}ft=this.next_id++;if(this.initial_vars==null){this.initial_vars={}}this.initial_vars[ft]=this.collect_form_vars(fs);T.attr("data-id",ft);fr.data("button-id",ft);j=(function(fu){return function(){var fx,fv,fw;T.hide();fv=fu.collect_form_vars(fs);if(Object.keys(fv).length!==Object.keys(fu.initial_vars[ft]).length){T.show()}fw=[];for(fx in fv){if(fv[fx]!==fu.initial_vars[ft][fx]){fw.push(T.show())}else{fw.push(void 0)}}return fw}})(this);fr.change(j);fr.find("input").filter(":text").on("input",j);return fr.find("textarea").on("input",j)},add_vars:function(T,fr){var fs,i,j;T=$(T);j=[];for(i in fr){if(!dq.call(fr,i)){continue}fs=new Element("input",{type:"hidden",name:i});fs.setValue(fr[i]);j.push(T.__sert(fs))}return j},collect_form_vars:function(fu,ft){var fw,fs,fr,j,T,fv;if(ft==null){ft=false}fu=fu||$(document.body);fs=fu.select("input").concat(fu.select("textarea")).concat(fu.select("select"));T={};for(fr=0,j=fs.length;fr<j;fr++){fw=fs[fr];if(fw.name&&fw.name!=="t"){fv=fw.getValue();if(fv||ft){if(typeof fv!=="string"){fv=fv.join(",")}if(T[fw.name]!=null){if(typeof T[fw.name]==="string"){T[fw.name]=[T[fw.name],fv]}else{T[fw.name].push(fv)}}else{T[fw.name]=fv}}}}return T},add_loading:function(T,i){var j;if(T){T=$(T);j=new Element("img",{src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"});j.addClassName("text-img ajax_submit_loading");if(i==="after"){return bF(T).after(j)}else{return bF(T).before(j)}}},remove_loading:function(i){return bF(".ajax_submit_loading").remove()},ui_form_submit:function(j,i){i=i||j.action;if(j.ajax_submitted){return false}j.ajax_submitted=true;return new by(bF(j),i,{data:bT.collect_form_vars(j),success:(function(T){return function(fu,fr,fv){var ft,fs;fs=bF(j).data("button-id");if(fs!=null){ft=bF(j).find("*[type='submit'][data-id='"+fs+"']");T.initial_vars[fs]=T.collect_form_vars(j);return ft.hide()}}})(this),complete:(function(T){return function(fs,fr){return j.ajax_submitted=false}})(this)})},ajax_submit_obj:function(fz){var fw,fy,T,fr,j,fs,fu,fv,ft,fx,i;fr=fz.form,i=fz.url,fx=fz.success_callback,T=fz.fail_callback,fw=fz.button,fu=fz.more_vars,fv=fz.position,fs=fz.job,j=fz.html_response,fy=fz.complete_callback,ft=fz.progress_text;return bT.ajax_submit(fr,i,fx,T,fw,fu,fv,fs,j,fy,ft)},ajax_submit:function(fs,T,fC,fr,fz,fx,fA,ft,j,fE,fv){var fD,fy,fB,fw,fu;if(j==null){j=false}if(fs.ajax_submitted){return false}fs.ajax_submitted=true;fu=bF(fs).find(".suggestion-input");for(fy=0,fB=fu.length;fy<fB;fy++){fD=fu[fy];da.blank(fD.identify())()}if(fz){bT.add_loading(fz,fA)}fw=bT.collect_form_vars(fs);if(fx){Object.extend(fw,fx)}new Ajax.DBRequest(T||fs.action,{noAutonotify:true,parameters:fw,job:ft,progress_text:fv,evalJSON:false,onSuccess:function(i){bT.remove_loading();if(fC&&typeof fC==="function"){return fC(i)}},onFailure:function(fG){var i,fF;if(fG){if(fG.responseText.indexOf("err:")===0){i=fG.responseText.substr(4);if(i.indexOf("{")===0){fF=i.evalJSON(true);bT.fill_errors(fs,fF)}else{if(j){i=new fm(i)}ah.error(i)}}else{ah.error()}bT.remove_loading();if(fr&&typeof fr==="function"){return fr(fG)}}},onComplete:function(fH){var fG,fF,i;i=fs.select(".suggestion-input");for(fG=0,fF=i.length;fG<fF;fG++){fD=i[fG];da.blur_elm(fD)}fs.ajax_submitted=false;if(fE&&typeof fE==="function"){return fE(fH)}}});return false},clear_errors:function(i){i=i||$(document.body);this.hide_errors(i);return i.select(".error-removable").invoke("remove")},fill_errors:function(ft,fs){var T,fv,j,fr,fu,i;fs=fs||{};ft=ft||$(document.body);bT.clear_errors(ft);for(fu in fs){if(!dq.call(fs,fu)){continue}fv=ft.down("[data-error-field-name='"+fu+"']")||ft.down("[name='"+fu+"']");if(fv){T=new Element("br",{"class":"error-removable"});j=new Element("span",{"class":"error-message error-removable"});fr=fs[fu];cP(fr.message_html||fr.message_text,"Error message must have a message_html or message_text property");if(fr.message_html){j.update(fr.message_html)}else{j.__date(fr.message_text)}bF(fv).before(j);bF(fv).before(T);i=bF(ft).find("input[name='"+fu+"'], textarea[name='"+fu+"']");if(i){i.addClass("input-error")}}}return this.show_errors(ft)},value:function(fs){var ft,fr,T,j,fu;T=$$('input[name="'+fs+'"]');fu=null;for(ft=0,j=T.length;ft<j;ft++){fr=T[ft];fu=$(fr).getValue()||fu}return fu},postRequest:function(T,fr,i){var j;if(fr==null){fr={}}if(i==null){i={}}cP(T!=null,"postRequest missing action");fr.t=bw.read(aK.JS_CSRF_COOKIE);j=new Element("form",{action:T,method:"POST"});if(i.target){j.target=i.target}document.body.appendChild(j);bT.add_vars(j,fr);return j.submit()},hide_errors:function(fs){var fu,fr,j,T,ft;fu=this.get_errors(fs);T=[];for(fr=0,j=fu.length;fr<j;fr++){ft=fu[fr];if(ft.down("span.error-message")){T.push(ft.hide())}else{T.push(void 0)}}return T},show_errors:function(fr){var ft,T,j,fs;ft=this.get_errors(fr);for(T=0,j=ft.length;T<j;T++){fs=ft[T];if(fs.down("span.error-message")){fs.show()}}return bF(".sick-input").find("label").css("top","")},get_errors:function(j){var T,i;i=".error-bubble, .error-plain-text";T=j?j.select(i):$$(i);return T}};bF(function(){return bT.show_errors()});var W;W=F.ActAsBlock={elm_list:["margin-left","margin-right","padding-left","padding-right","border-left-width","border-right-width"],parent_list:["padding-left","padding-right","border-left-width","border-right-width"],register:function(ft,fu){var fr,j,fs,T;if(fu==null){fu=document.body}fs=$(fu).getElementsByClassName("act_as_block");T=[];for(fr=0,j=fs.length;fr<j;fr++){ft=fs[fr];T.push(this.resize(ft))}return T},resize:function(fs){var i,T,fr,j;fs=$(fs);T=fs.up();i=ec.sumStyles(fs,this.elm_list);fr=ec.sumStyles(T,this.parent_list);fs.style.width="1px";j=T.getWidth()-i-fr;if(j>0){return fs.style.width=j+"px"}}};var bf;bf=F.BrowseStyleRows={register_all:function(){var T,j,fr,fs;fr=$$(".bs-row");for(T=0,j=fr.length;T<j;T++){fs=fr[T];this.register(fs)}Event.observe(document,"click",this.kill_current.bind(this));return bF(document).on("dropdown-opened",this.kill_current.bind(this))},register:function(j){var i;j=$(j);j.db_observe("mouseover",this.mouseover.bind(this));j.db_observe("mouseout",this.mouseout.bind(this));i=j.down(".action-button");if(i){return i.db_observe("click",this.click.bind(this))}},mouseover:function(j,i){if(!i.hasClassName("no-hover")){return i.addClassName("hover")}},mouseout:function(j,i){return i.removeClassName("hover")},click:function(fr,j){var i,fs,T;if(fr.target.tagName==="A"){return}fs=j.up(".bs-row");Event.stop(fr);if(fs.hasClassName("selected")){this.kill_current(false);return}bF(document).trigger("dropdown-opened");this.kill_current(false);T=$(fr.target);if(!T.match(".bs-actions-list *")){fs.addClassName("selected")}i=(T.hasClassName("bs-row")?T:T.up(".bs-row"));return i.style.zIndex=9},kill_current:function(ft){var fu,fr,j,fs,T;fs=$$(".bs-row.selected");T=[];for(fr=0,j=fs.length;fr<j;fr++){fu=fs[fr];fu.removeClassName("selected");T.push(fu.style.zIndex="")}return T}};var es;es=F.Bubble={make:function(fB,fM,fE,fz,fv){var fs,fC,fJ,fr,T,fL,fG,fA,fy,ft,fx,fD,fI,fw,i,fu,j,fK,fH,fF;if(fM==null){fM="left"}fv=fv!=null?fv:{};if(["left","right"].contains(fM)){fE=fE||"middle";cP(["top","middle","bottom"].contains(fE),"expected tail position ['top', 'middle', 'bottom'], got "+fE)}else{if(["bottom","top"].contains(fM)){fE=fE||"center";cP(["left","center","right"].contains(fE),"expected tail position ['left', 'center', 'right'], got "+fE)}else{if(!["none"].contains(fM)){cP(false,"unexpected tail side, got "+fM)}}}fD=new Element("table");if(fv.style==="titled"){fD.addClassName("bluebubble");fI="bluebubble"}else{fD.addClassName("bubble");fI="bubble"}if(fz){fD.style.width=fz+"px"}i=new Element("tbody");fK=new Element("tr");fu=new Element("td");fu.addClassName("tl");fx=new Element("td");fx.addClassName("t");if(fv.style==="titled"){if(fz){fx.style.width=(fz-42)+"px"}}j=new Element("td");j.addClassName("tr");if(fM==="top"){fw=new Element("img",{src:"/static/images/"+fI+"_arrow_top.png"});fw.addClassName("tarrow");if(fv.style==="titled"){fw.addClassName("arrow-"+fE);fC=new Element("div");fC.addClassName("arrow-container");if(fz){fC.style.width=(fz-42)+"px"}fC.__sert(fw);fx.__sert(fC)}else{fx.style.textAlign=fE;fx.__sert(fw)}}fK.__sert(fu);fK.__sert(fx);fK.__sert(j);i.__sert(fK);fH=new Element("tr");fA=new Element("td");fA.addClassName("l");if(fM==="left"){if(fv.style==="titled"){fs=new Element("img",{src:"/static/images/bluebubble_arrow_left-vfl8zzy_-.png"})}else{fs=new Element("img",{src:"/static/images/bubble_arrow-vfl8m7tk-.png"})}fs.addClassName("arrow");fA.__sert(fs);fA.vAlign=fE}fG=new Element("td");fG.addClassName("c");fG.update(fB);fy=new Element("td");fy.addClassName("r");if(fM==="right"){ft=new Element("img",{src:"/static/images/bubble_arrow_right-vflmW3_2s.png"});ft.addClassName("rarrow");fy.__sert(ft);fy.vAlign=fE}fH.__sert(fA);fH.__sert(fG);fH.__sert(fy);i.__sert(fH);fF=new Element("tr");T=new Element("td");T.addClassName("bl");fJ=new Element("td");fJ.addClassName("b");if(fM==="bottom"){fr=new Element("img",{src:"/static/images/"+fI+"_arrow_bottom.png"});fr.addClassName("barrow");if(fv.style==="titled"){fr.addClassName("arrow-"+fE);fC=new Element("div");fC.addClassName("arrow-container");if(fz){fC.style.width=(fz-42)+"px"}fC.__sert(fr);fJ.__sert(fC)}else{fJ.style.textAlign=fE;fJ.__sert(fr)}}fL=new Element("td");fL.addClassName("br");fF.__sert(T);fF.__sert(fJ);fF.__sert(fL);i.__sert(fF);fD.__sert(i);return fD}};var eZ;eZ=INLINE_JS.FreshDropdown=F.FreshDropdown={show:function(fu,fr,T,j){var ft,fs,fv,i;if(j==null){j=false}bF(document).trigger("dropdownOpened",[1]);ft=bF(fr);if(!T){T=ft[0].offsetHeight+10}this.hide_all();fs=bF(fu).show();i=fs[0].offsetWidth;fv=ft[0].offsetWidth;fs.clonePosition(ft,{setHeight:false,setWidth:false,offsetLeft:-1*(i-fv)+22,offsetTop:T});if(j){fs.width(i)}ft.addClass("pressed");return((function(fw){return function(){return document.observe("click",eZ.hide_all)}})(this)).defer()},hide_all:function(T){var j,i;i=bF(".freshdropdown-menu");j=0;i.each(function(){if(bF(this).is(":visible")){return j+=1}});i.hide();bF(document).trigger("dropdownClosed",[j]);$$(".freshdropdown-button").invoke("removeClassName","pressed");return document.stopObserving("click",eZ.hide_all)}};var ac;ac=F.JumpWatcher={inverval:null,last_hash:null,last_page_offset:0,check:function(){if(window.location.href.endsWith("#")&&window.pageYOffset===0&&ac.last_page_offset!==0){return this.report()}else{this.last_page_offset=window.pageYOffset;return this.last_hash=H.parse(window.location.href).fragment}},report:function(){clearInterval(ac.interval);return cP(0.1+0.2===0.3,"Hash jump detected, last hash = "+this.last_hash+". You may have an onclick handler that isn't firing, or you are not preventing the default action (eg. by returning false in your handler)")}};var fh;fh=__CONDITIONAL_JS__.Modal=INLINE_JS.Modal=F.Modal={KEY_SCOPE:"modal",width:640,vertical_offset:90,show:function(fA,fw,fx,fC,T,fy,fu,fv,fB){var j,fs,fz,i,fr,ft;if(fx==null){fx=false}if(fC==null){fC=false}if(T==null){T=false}if(fy==null){fy=false}if(fu==null){fu=""}if(fv==null){fv=true}if(fB==null){fB=false}if(fh.shown()){fh._cleanup()}T=T||this.width;fs="#modal-content .error-message, #modal-content .error-removable, #modal-content .error-bubble";$$(fs).invoke("hide");if(aq.uploading&&!fy){ca(eG("You can't do this while uploading."));return false}cP(fw,"Missing modal content!");fr=this.vars._prev_scope;this.vars=fx||{};this.vars._prev_scope=fr;$("modal").setStyle({width:T+"px",margin:"0 0 0 "+(Math.floor(-T/2).toString())+"px"});this.vars.extra_class="";if(fu){$("modal").addClassName(fu);this.vars.extra_class=fu}if(!fy){if(aq.num_files()){cE.reset();aq.clear()}i=ec.childElement($("modal-content"),0);if(i&&i!==fw){$("grave-yard").__sert(i)}j=new Element("div");j.update(fw);$("modal-content").__sert(j);if(fw.show){fw.show()}Element.show("modal")}bF("#modal-overlay").off("click");if(fv){bF("#modal-overlay").on("click",function(fD){fh.hide(null,false,true);fD.preventDefault();return fD.stopPropagation()})}else{bF("#modal-overlay").on("click",function(fD){fD.preventDefault();return fD.stopPropagation()})}this.fix_position();$("modal-overlay").show();$("modal-behind").setStyle({width:(T+20)+"px",margin:"0 0 0 "+(Math.floor(-T/2-10).toString())+"px"});bF("#modal-behind").css("opacity",0.2);$("modal-behind").show();if(fC){$("modal-content").select("#"+fC.id).first().focus()}else{if(!ec.ie){fz=$("modal").down("input[type=submit]")||$("modal").down("input[type=button]");if(fz){fz.focus()}}}if(!this.track_id){this.track_resizes()}if(fA){if(ec.isElm(fA)){bF("#modal-title").html(fA)}else{bF("#modal-title").text(fA)}bF("#modal-title").show();ft=bF("#modal-title").text();eO("Modal.show:",ft)}else{bF("#modal-title").hide();eO("Modal.show")}W.register(false,"modal");this.keydownHandler=this.keydown.bind(this);document.observe("keydown",this.keydownHandler);$("modal-content").style.height="auto";if(key.getScope()!==this.KEY_SCOPE){this.vars._prev_scope=key.getScope()}key.setScope(this.KEY_SCOPE);this.prevent_hide_if_loading=fB;bF("#modal").find("input").filter(":visible:first").focus();if(this.in_viewport()){this.scroll_locked=true;D.scroll_lock_document()}bF(document).trigger("modalOpened",[1]);return false},in_viewport:function(){var T,i,j,fs,fr;T=bF("#modal");i=T.height();fr=T.width();j=D.viewport_dimensions();fs=D.viewport_offset(T);return fs.left>0&&fs.top>0&&fs.left+fr<j.width&&fs.top+i<j.height},fix_position:function(T){var j,i;i=document.viewport.getScrollOffsets().top+this.vertical_offset;j=parseInt($("modal").getStyle("height"),10);if(j+this.vertical_offset<document.viewport.getHeight()){$("modal").setStyle({position:"fixed",top:this.vertical_offset+"px"});return $("modal-behind").setStyle({position:"fixed",height:(j+20)+"px",top:(this.vertical_offset-10)+"px"})}else{$("modal").setStyle({position:"absolute",top:i+"px"});return $("modal-behind").setStyle({position:"absolute",height:(j+20)+"px",top:(i-10)+"px"})}},keydown:function(fr){var fs,i,T,j;T=fr.keyCode||fr.which||fr.charCode;if(T===27||(T===8&&!D.focus_in_input())){fr.preventDefault();this.hide(null,false,true)}if(T===9&&!D.focus_in_input()){i=$("modal").down("input[type=text], input[type=email]");j=$("modal").down(".modal-tabs");fs=j;while(fs&&fs.next()){fs=fs.next();if(fs.visible()){i=fs.down("input[type=text], input[type=email]");break}}if(i){fr.preventDefault();return i.focus()}}},shown:function(){return $("modal").visible()},hide:function(T,i,j){if(T){Event.stop(T)}if(this.should_prevent_hide()){return false}this.prevent_hide_if_loading=false;if(this.onHide){this.onHide(j);return}this.onHide=null;Element.hide("modal-behind");Element.hide("modal-overlay");$("modal").removeClassName(this.vars.extra_class);if(!i&&!aq.num_files()){Element.hide("modal")}else{$("modal").style.marginLeft="-10000000px";if(aq.uploading){c6.show()}}fh._cleanup();if(this.track_id){clearInterval(this.track_id);this.track_id=false}document.stopObserving("keydown",this.keydownHandler);if(document.activeElement&&[document,window,document.body].indexOf(document.activeElement)===-1){$(document.activeElement).blur()}key.setScope(this.vars._prev_scope);return eO("Modal.hide")},_cleanup:function(){bF(document).trigger("modalClosed",[1]);if(this.scroll_locked){return D.scroll_unlock_document()}},should_prevent_hide:function(){return this.prevent_hide_if_loading&&bx.some(bF("#modal form"),function(i){return i.ajax_submitted})},track_resizes:function(){return this.track_id=setInterval(this.on_resize.bind(this),150)},on_resize:function(){var i;i=$("modal").getHeight();if(this.old_height!==i||$("modal-behind").getHeight()<i){this.old_height=i;return this.fix_position()}},vars:{}};var ck;ck=F.SickInput={init:function(){var ft,fr,j,fs,T;fs=$$(".sick-input");T=[];for(fr=0,j=fs.length;fr<j;fr++){ft=fs[fr];if(!ft.hasClassName("sickified")){T.push(this._create(ft))}}return T},_create:function(fr){var j,T,i;if(fr==null){return}T=fr.identify();i=fr.down("input")||fr.down("textarea")||fr.down("select");i.observe("focus",function(){return fr.addClassName("focused")});i.observe("blur",function(){return fr.removeClassName("focused")});j=function(){if(fr.hasClassName("populated")&&i.getValue()===""){fr.removeClassName("populated")}else{if(!fr.hasClassName("populated")&&i.getValue()!==""){fr.addClassName("populated")}}if(T in ck._handler_map){return ck._handler_map[T]()}};bT.show_errors();j();return setInterval(j,100)},_handler_map:{},add_interval_handler:function(j,i){var T;T=j.identify();return this._handler_map[T]=i},remove_interval_handler:function(j,i){var T;T=j.identify();if(this._handler_map[T]===i){return delete this._handler_map[T]}}};var da;da=F.SuggestionInput={register:function(j){var i;j=$(j);i=j.up("form");if(da.defaulted(j)||j.getValue()===""){j.setValue(j.title)}else{j.addClassName("suggestion-input-unfaded")}j.observe("blur",this.blur.bind(this));j.observe("focus",this.focus.bind(this));j.observe("db:value_change",this.focus.bind(this));if(i){if(!j.id){j.id="r_elm_id_"+(Math.random().toString())}return i.observe("submit",da.blank(j.id).bind(this))}},register_all:function(){var fs,T,j,ft,fr;ft=$$(".suggestion-input");fr=[];for(fs=0,j=ft.length;fs<j;fs++){T=ft[fs];fr.push(this.register(T))}return fr},blank:function(i){return(function(j){return function(){var T;T=$(i);if(!T){return}if(j.defaulted(T)){return T.setValue("")}}})(this)},defaulted:function(i){i=$(i);return i.getValue()===i.title},do_blank:function(i){return this.blank(i)()},clear:function(i){var j;j={target:i};return this.focus(j)},focus:function(i){var j;j=$(i.target);if(!j){return}if(this.defaulted(j)){j.addClassName("suggestion-input-unfaded");return j.setValue("")}},blur_elm:function(i){if(i.getValue()===""){i.removeClassName("suggestion-input-unfaded");i.setValue(i.title)}return i.blur()},blur:function(i){var j;j=$(i.target);if(!j){return}return this.blur_elm(j)},reset:function(j){var i;i=$(j);if(!i){return}i.removeClassName("suggestion-input-unfaded");i.setValue(i.title);i.defaulted=true;return i.blur()},setValue:function(i,j){var T;T=$(i);if(!T){return}T.addClassName("suggestion-input-unfaded");T.setValue(j);return T.defaulted=false}};var bo;bo=F.TitleBubble=(function(){var T,j,fu,fr,fs,i,ft;ft=0;T=0;i=function(fv){return ft=fv};fs=function(fB){var fG,fE,fy,fC,fx,fv,fD,fA,fw,fz,fF;fC=bF(fB.currentTarget);fF=fC.attr("title");if(fF!=null?fF.length:void 0){fC.attr("data-title",fF);fC.removeAttr("title")}fy=parseInt(fC.data("title-delay"));fE="title-bubble-"+(T++);fC.data("bubble-id",fE);fG=bF("<div/>",{id:fE,"class":"title_bubble_container"});if(!fy){fG.css({opacity:0});fG.addClass("has-transition")}if(fC.hasClass("white")){fG.addClass("white")}if(fC.hasClass("black")){fG.addClass("black")}fG.text(fC.attr("data-title"));fD=fC.attr("data-title-html");fG.html(fD);fw=fC.attr("data-title-hide-tail")!=="yes";if(fw){fz=bF("<div/>",{"class":"tail"});fG.append(fz)}bF(document.body).append(fG);fv=fu(fC[0],fG[0]);fx=j(fv,fG[0],fC[0]);fG.clonePosition(fC,{setWidth:false,setHeight:false,offsetTop:fx.top-ft,offsetLeft:fx.left});fG.addClass("position-"+fv);if(fw){fz.clonePosition(fC,{setWidth:false,setHeight:false,setTop:false,offsetLeft:fx.left+fx.tail_offset_left+(bF(fG).outerWidth()/2)})}fA=function(){var fH;if(!((fG.data("pending-delay"))&&(fC.data("bubble-id")===fE))){return}fH=(parseInt(fC.data("title-fade-time")))||400;return fG.fadeIn(fH)};if(fy){fG.hide();fG.data("pending-delay",true);return setTimeout(fA,fy)}else{return fG.css({opacity:""})}};fu=function(fz,fv){var fy,fx,fw;fz=$(fz);fw=fz.getAttribute("data-title-position");fy=document.viewport.getDimensions();fx=fz.viewportOffset();if(!(fw==="above"||fw==="below"||fw==="right"||fw==="left")){fw="above"}if(fw==="left"){if(fx.left<fv.width){return"right"}}else{if(fw==="right"){if(fy.width-(fx.left+fz.getWidth())<fv.width){return"left"}}else{if(fw==="below"){if(fy.height-(fx.top+fz.getHeight())<fv.height){return"above"}}else{if(fw==="above"){if(fx.top<fv.height){return"below"}}}}}return fw};j=function(fx,fE,fA){var fC,fy,fF,fB,fD,fz,fv,fH,fG,fw;fE=$(fE);fA=$(fA);fF=document.viewport.getDimensions();fC=fE.getDimensions();fB=fA.viewportOffset();fy=6;fD=0;fz=0;fG=0;fw=0;if(fx==="below"||fx==="above"){if(fx==="below"){fz=fA.getHeight()+fy}else{fz=(-1*fC.height)-fy}fv=fA.getWidth()/2-fC.width/2;if(fB.left+fv+fC.width>fF.width){fD=fF.width-fB.left-fC.width;fG=fv-fD-5}else{fD=fv;fG=-5}}if(fx==="left"||fx==="right"){if(fx==="right"){fD=fA.getWidth()+fy}else{fD=(-1*fC.width)-fy}fH=fA.getHeight()/2-fC.height/2;if(fB.top+fH+fC.height>fF.height){fz=fF.height-fB.top-fC.height;fw=fH-fz-5}else{fz=fH;fw=-5}}return{left:fD,top:fz,tail_offset_left:fG,tail_offset_top:fw}};fr=function(fw){var fv,fx,fy;fy=bF(fw!=null?fw.currentTarget:void 0);fv=bF("#"+fy.data("bubble-id"));if(fv.data("pending-delay")){fv.removeData("pending-delay");fx=(parseInt(fy.data("title-fade-time")))||400;return fv.fadeOut(fx,function(){return fv.remove()})}else{return fv.remove()}};return{init:function(){bF(document).on("mouseenter",".title_bubble",fs);bF(document).on("mouseleave",".title_bubble",fr).on("mouseup",".title_bubble",fr);bF(document).on("mouseenter",".title_bubble_sticky",fs);return bF(document).on("mouseleave",".title_bubble_sticky",fr)},set_vertical_space:i,hide_all:function(){return bF(".title_bubble_container").remove()}}})();var ep;ep=INLINE_JS.Tooltip=F.Tooltip={attach:function(ft,T,i,j){var fs,fr;if(j==null){j={}}ft=$(ft);i=(i?$(i):null);fs=es.make(T,ft.tail_position,j.tail_position,j.width,j);fs.setStyle({display:"none",position:"absolute"});$("floaters").__sert(fs);if(ft.match("#modal-content *")||ft.match(".db-modal-content *")){fs.style.zIndex="13001"}else{fs.style.zIndex=""}if(ft.tail_position==="right"){fr=(ec.ie?32:12);fs.style.marginLeft=-(fs.getWidth()+ft.getWidth()+fr)+"px"}ft.tooltip=fs;ft.out_target=(i?true:false);ft.observe("mouseout",this.mouseout("target",ft));ft.observe("mouseover",this.mouseover("target",ft));ft.out_trigger=(i?false:true);if(i){i.observe("mouseout",this.mouseout("trigger",ft));i.observe("mouseover",this.mouseover("trigger",ft))}ft.out_tooltip=true;fs.observe("mouseout",this.mouseout("tooltip",ft));return fs.observe("mouseover",this.mouseover("tooltip",ft))},update:function(j,i){if(j.tooltip){return $(j.tooltip).update(i)}},mouseover:function(i,j){return function(){return j["out_"+i]=false}},mouseout:function(i,j){return function(){j["out_"+i]=true;return ep.hide_if_out.defer(j)}},show_by:function(j){var T,i;T=bF(j.tooltip);j=bF(j);T.show();i=Math.floor(T[0].offsetHeight/2);return T.clonePosition(j,{setWidth:false,setHeight:false,offsetTop:Math.floor(j[0].offsetHeight/2)-i,offsetLeft:j[0].offsetWidth+1})},hide_if_out:function(i){var j;if(!i.out_target||!i.out_trigger||!i.out_tooltip){return}j=$(i.tooltip);return j.hide()},show:function(fs,fr,j,i,T){if(i==null){i="left"}fs=$(fs);if(!fs.tail_position){fs.tail_position=i}j=(j?$(j):null);if(!fs.tooltip){this.attach(fs,fr,j,T)}return this.show_by(fs)}};var b2;b2=INLINE_JS.TreeView=F.TreeView={tv:{},loaded:false,user:null,role_icon:"",set_params:function(i){return this.ajax_params=i},init:function(T,i,fr){var j;if(fr==null){fr="treeview"}this.tv[fr]={};j=this.tv[fr];j.autohide=(i===null?true:i);j.handler=T;j.viewdiv=$(fr);j.hidefunc=this.hide.bindAsEventListener(this);this.ajax_params={};document.observe(bE.ADD,(function(fs){return function(ft){return fs.schedule_reset()}})(this));document.observe(bE.REMOVE,(function(fs){return function(ft){return fs.schedule_reset()}})(this));return document.observe(bE.MOVE,(function(fs){return function(ft){return fs.schedule_reset()}})(this))},schedule_reset:function(){return this.loaded=false},reset:function(ft){var T,fu,fr,j,fv,i,fs;T={url:"/ajax_subtreeview",type:"post",data:bF.extend({},this.ajax_params),success:(function(fw){return function(fx){var fy,fz;fy=[];for(fz in fw.tv){if(fw.tv.hasOwnProperty(fz)){fw.tv[fz].viewdiv.down(".treeview-folders").update(fx);if(ft&&ft.onSuccess){fy.push(ft.onSuccess(fx))}else{fy.push(void 0)}}else{fy.push(void 0)}}return fy}})(this)};if(ft!=null?ft.user:void 0){if(ft.user.id!==((fu=this.user)!=null?fu.id:void 0)){fv=bF("<p />",{id:"treeview-loading"});i=bF("<img />",{src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"});fv.append(i);fs=" "+eG("Loading your folders");fv.append(fs);bF("#dest-treeview .treeview-folders").html(fv);this.user=ft.user}T.subject_user=ft.user;j=cQ.get_role_title(ft.user);if(cQ.get_viewer().is_paired){if(ft.user.is_team){fr="s_briefcase"}else{fr="s_house"}}else{fr="dropbox"}if(!j){j=eG("Dropbox")}bF("#first-treeview-link span").text(j);cy.replace(bF("#root-img")[0],"web",this.role_icon,fr);this.role_icon=fr}else{bF("#first-treeview-link span").text(eG("Dropbox"))}return bF.ajax(T)},toggle:function(T,j){var i;Event.stop(T);i=this.tv[j||"treeview"];if(i.shown){i.shown=false;this.hide(T,j)}else{i.shown=true;this.show(T.target,j)}return false},hide:function(T,j){var i;i=this.tv[j||"treeview"];if(!T||!$(T.target).descendantOf(i.viewdiv)){i.viewdiv.hide();Event.stopObserving(window,"click",i.hidefunc);return i.shown=false}},show:function(T,j){var fr,i;i=this.tv[j||"treeview"];T=$(T);T.blur();fr=T.cumulativeOffset();i.viewdiv.setStyle({top:(fr.top+T.getHeight())+"px",left:(fr.left-4)+"px"});i.viewdiv.show();return Event.observe(window,"click",i.hidefunc)},toggleNode:function(j){var i;j=$(j);i=j.down("img");if(i.className.match("bullet_plus")){cy.replace(i,"web","bullet_plus","bullet_minus")}else{cy.replace(i,"web","bullet_minus","bullet_plus")}j.up().next("div").toggle();j.blur();return false},toggleNodeAjax:function(fr,i,j){var T,fs;if(fr.fetched_children){return this.toggleNode(fr)}fr=$(fr);T=fr.down("img");fs=cy._get(T);T.src="/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif";bF.ajax({url:"/ajax_subtreeview"+i,type:"post",data:bF.extend({},this.ajax_params),subject_user:j,success:(function(ft){return function(fu){var fv;fv=new Element("div",{style:"display: none;"}).update(fu);fr.up().__sert({after:fv});fr.fetched_children=true;cy._set(T,fs);return ft.toggleNode(fr)}})(this),complete:function(){if(/loading/.match(T.src)){return cy._set(T,fs)}}});return false},handle:function(T,j){var fr,i;fr=$H(this.tv).keys();i=$(j).ancestors().find(function(fs){return fr.include(fs.id)});if(!i){return}i=this.tv[i.id];bF(document).trigger("db:treeview_selected",[T]);if(i.handler){i.handler(T,j)}if(i.autohide){this.hide(i.id)}return false},move:function(T,fr,j){var i;i=$(T);if(!this.loaded){this.reset({onSuccess:(function(fs){return function(){fs.loaded=1;return fs.move(T,fr,j)}})(this),user:j!=null?j.user:void 0})}else{if(j&&j.onSuccess){j.onSuccess()}}cP(i,"Couldn't find tree_id");cP($(fr),"Couldn't find location_id");$(fr).appendChild(i);return i.show()}};var aS;aS=F.ULSelectMenu=(function(){var fr,fv,T,fw,fx,fs,fu,i,ft,j,fy;fr=function(fz){return fz.removeClassName("shown")};fy=function(fz){return fz.toggleClassName("shown")};fu=function(){return this.removeClassName("hover")};fs=function(){return this.addClassName("hover")};i=function(fE,fD){var fC,fA,fB,fz;fB=[];for(fC=0,fA=fD.length;fC<fA;fC++){fz=fD[fC];fB.push(fE.insert(fz))}return fB};fw=function(fB,fz,fA){i(fB,fA);if(fB.firstChild!==fz){return fB.__sert({top:fz})}};ft=function(fA,fB){var fz;fz="selected";bF(fA).find("."+fz).removeClass(fz);return bF(fB).addClass(fz)};j=function(fC,fE){var fF,fB,fz,fD,fA;fD=fC.select("li");fA=[];for(fB=0,fz=fD.length;fB<fz;fB++){fF=fD[fB];if(fF.getAttribute("data-value")===fE){fA.push(ft(fC,fF))}else{fA.push(void 0)}}return fA};fx=function(fz,fB,fA){return function(fC){if(!fz.hasClassName("selected")){ft(fB,fz);fB.fire("db:change",fz.getAttribute("data-value"));return fr(fB)}else{fw(fB,fz,fA);return fy(fB)}}};fv=function(fB){var fF,fD,fE,fH,fC,fA,fG,fz;fH=fB.select("li");cP(fH.length,"Empty list of options "+fB.identify());fC=void 0;if(fH.length===1){fB.addClassName("one")}else{for(fD=0,fE=fH.length;fD<fE;fD++){fF=fH[fD];fG=fF.getAttribute("data-value");cP(fG,fF.identify()+" missing data value");fF.observe("click",fx(fF,fB,fH));fF.observe("mouseenter",fs);fF.observe("mouseleave",fu);if(fF.hasClassName("selected")){fC=fF}}$(document.body).observe("click",function(fI){if($(fI.target).up(".ul_select_menu")===fB){return}return fr(fB)})}if(!fC){fC=fH[0]}fC.addClassName("selected");fz=new Element("span");fA=fC.getDimensions();fz.setStyle({width:fA.width+"px",height:fA.height+"px",position:"relative",display:"inline-block"});return fB.wrap(fz)};T=function(){var fD,fB,fz,fC,fA;fC=$$(".ul_select_menu");fA=[];for(fB=0,fz=fC.length;fB<fz;fB++){fD=fC[fB];fA.push(fv(fD))}return fA};bF(T);return{init:function(fz){return fv(fz)},set_selected_by_value:j}})();var J;J=F.DBCalendar=Class.create({initialize:function(j,i){this.options=i||{};this.container=$(j);cP(this.container,"Couldn't find the element");this.today=new Date();if(this.options.disable_future){this.options.last_day=ec.start_of_day(this.options.last_day||this.today)}if(this.options.disable_past){this.options.first_day=ec.start_of_day(this.options.first_day||this.today)}this.view_date=ec.start_of_day(this.options.selected_date||this.today);this.selected_date=ec.start_of_day(this.options.selected_date||this.today);return this.render()},_change_month:function(j,i){Event.stop(j);this.view_date.setMonth(i);return this.render()},is_valid_date:function(fr,ft,fs,T,i){var j;fr=parseInt(fr,10);ft=parseInt(ft,10);fs=parseInt(fs,10);T=parseInt(T,10);i=parseInt(i,10);T=T||1970;i=i||(new Date()).getFullYear()+1;ft+=1;if(fs<T){return false}if(fs>i){return false}if(ft<1||ft>12){return false}if(fr<=0){return false}if(ft===2){j=((fs%4)===0)&&(((fs%100)!==0)||((fs%400)===0));if(j){return fr<=29}else{return fr<=28}}else{if(ft===4||ft===6||ft===9||ft===11){return fr<=30}else{return fr<=31}}},change_date:function(i,fr,j){var T;if(!this.is_valid_date(i,fr,j)){return}T=j!==this.view_date.getFullYear()||fr!==this.view_date.getMonth();this.selected_date=new Date(j,fr,i);if(T){this.view_date.setMonth(fr);this.view_date.setFullYear(j);this.render()}else{bF(this.container).find(".selected").removeClass("selected");bF(this.container).find("a#day"+i+"-"+fr).addClass("selected")}if(this.options.onDateChange){return this.options.onDateChange(this.selected_date)}},render:function(){var fr,fx,fv,ft,fs,j,fu,T,fw,i;fx=this.render_days();ft=bF(".current-month",fx);fu=ft.first().data("date");j=ft.last().data("date");i=fu<=this.options.first_day;fw=j>=this.options.last_day;fr=new Element("div");fr.addClassName("calendar clearfix");if(!fw){this._next_month=(function(fy){return this._change_month(fy,this.view_date.getMonth()+1)}).bind(this);fs=new Element("a");fs.addClassName("changemonth next");fs.update(cy.make("web","arrowright",{}));Event.observe(fs,"click",this._next_month);fr.__sert(fs)}if(!i){this._prev_month=(function(fy){return this._change_month(fy,this.view_date.getMonth()-1)}).bind(this);T=new Element("a");T.addClassName("changemonth prev");T.update(cy.make("web","arrowleft",{}));Event.observe(T,"click",this._prev_month);fr.__sert(T)}fv=new Element("h5");fv.update(eG("%(month)s %(year)s",{comment:"For example 'January 2010'. This is used as part of a calendar."}).format({month:b6.month_name(this.view_date.getMonth()),year:this.view_date.getFullYear()}));fr.__sert(fv);fr.__sert(fx);return this.container.__date(fr)},render_days:function(){var fx,ft,fw,fr,fu,fv,fy,T,fs;ft=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),1);T=ft.getDay();fx=new Element("div");fx.addClassName("days");for(fw=fu=fs=T;fs<=0?fu<0:fu>0;fw=fs<=0?++fu:--fu){fy=new Date(ft.getFullYear(),ft.getMonth(),ft.getDate());fy.setDate(fy.getDate()-fw);fx.__sert(this.render_day(fy,true))}fr=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),1);while(fr.getMonth()===this.view_date.getMonth()){fx.__sert(this.render_day(fr));fr=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),fr.getDate()+1)}fv=new Date(this.view_date.getFullYear(),this.view_date.getMonth()+1,0);while(fv.getDay()!==6){fv=new Date(fv.getFullYear(),fv.getMonth(),fv.getDate()+1);fx.__sert(this.render_day(fv,true))}return fx},render_day:function(j,fr){var i,T;T=!fr;if(this.options.last_day){fr=fr||j>this.options.last_day}if(this.options.first_day){fr=fr||j<this.options.first_day}i=new Element(fr?"span":"a");bF(i).data("date",j);if(T){i.addClassName("current-month")}i.update(j.getDate());i.addClassName("date");i.writeAttribute("id","day"+j.getDate()+"-"+j.getMonth());if(this.selected_date.getDate()===j.getDate()&&this.selected_date.getMonth()===j.getMonth()&&this.selected_date.getFullYear()===j.getFullYear()){i.addClassName("selected")}if(fr){i.addClassName("inactive")}else{this._handler=(function(ft){var fs;fs=ft.target.identify().substr(3).split("-");return this.change_date(fs[0],this.view_date.getMonth(),this.view_date.getFullYear())}).bind(this);Event.observe(i,"click",this._handler)}return i}});var aU;aU=F.DatePickerInput=Class.create({initialize:function(i,T){var ft,fr,fs,j;this.container=i;this.options={};Object.extend(this.options,T||{});this.input=this.container.down(".input-date");this.display=this.container.down(".visible-date");j=(this.input.value?ec.from_mysql_date(this.input.value):new Date());if(this.container.hasAttribute("data-first")){fs=ec.from_mysql_date(this.container.getAttribute("data-first"))}ft=this.options.disable_future!=null?this.options.disable_future:true;fr=this.options.disable_past!=null?this.options.disable_past:true;this.cal_container=this.container.down(".cal-container");this.calendar=new J(this.cal_container,{onDateChange:this.onDateChange.bind(this),first_day:fs,disable_future:ft,disable_past:fr,selected_date:j});this.container.observe("click",this.show_cal.bindAsEventListener(this));$(document.body).observe("click",this.hide_cal.bind(this));return this.onDateChange(j)},show_cal:function(j){var i;if(j){Event.stop(j)}i=$(j.target);if(i.match(".cal-container")||i.up(".cal-container")){return}bF(".cal-container").hide();return this.cal_container.show()},hide_cal:function(){return this.cal_container.hide()},onDateChange:function(i){this.input.value=ec.to_mysql_date(i,false);this.display.update(O.localize(i));return this.hide_cal()}});var fn;fn=F.TextInputDatePicker=Class.create({initialize:function(fr,T){var ft,fs,j,i;this.options={include_seconds:true,include_microseconds:true,choose_eod:false};Object.extend(this.options,T||{});this.input=$(fr);cP(this.input,"Couldn't find the element "+fr.toString());j=new Date();i=(this.input.value?ec.from_mysql_date(this.input.value):false);fs=new Date(j.getUTCFullYear(),j.getUTCMonth(),j.getUTCDate());this.cal_icon=cy.make("web","calendar_view_month",{align:"absmiddle"});this.cal_container=new Element("div",{id:"cal_container_"+fr,style:"display: none; position: absolute; z-index: 1"});this.calendar=new J(this.cal_container,{onDateChange:this.onDateChange.bind(this),last_day:fs,selected_date:i});this.input.__sert({after:this.cal_icon});this.cal_icon.observe("click",this.toggle_cal.bindAsEventListener(this));ft=bF(this.input);bF(this.cal_container).clonePosition(ft,{setWidth:false,setHeight:false,offsetTop:ft[0].offsetHeight});return this.cal_icon.__sert({after:this.cal_container})},toggle_cal:function(i){if(i){Event.stop(i)}return this.cal_container.toggle()},hide_cal:function(i){if(i){Event.stop(i)}return this.cal_container.hide()},onDateChange:function(i){if(this.options.choose_eod){i.setTime(ec.start_of_day(i).getTime()+86399999)}this.input.value=ec.to_mysql_date(i,this.options.include_seconds,this.options.include_microseconds);return this.hide_cal()}});an.window_load(W.register.bind(W));bF(ck.init.bind(ck));bF(da.register_all.bind(da));Event.observe(window,"scroll",function(){return bo.hide_all()});bF(function(){ac.interval=setInterval(ac.check.bind(ac),500);return bo.init()});var bg,fi=function(fr,j){for(var i in j){if(dq.call(j,i)){fr[i]=j[i]}}function T(){this.constructor=fr}T.prototype=j.prototype;fr.prototype=new T();fr.__super__=j.prototype;return fr},dq={}.hasOwnProperty;bg=INLINE_JS.ChangeNameModal=F.ChangeNameModal=(function(i){fi(j,i);function j(){j.__super__.constructor.call(this,{element_id:"change-name-modal"});this.on_confirm_button_click=(function(T){return function(fu){var ft,fr,fs;fu.preventDefault();ft=bF(fu.target);fr=ft.closest("form");fs=function(){T.hide();return location.reload()};return bT.ajax_submit(fr[0],false,fs,null,ft[0])}})(this)}return j})(ed);var bW,ey,b3=function(i,j){return function(){return i.apply(j,arguments)}},fi=function(fr,j){for(var i in j){if(dq.call(j,i)){fr[i]=j[i]}}function T(){this.constructor=fr}T.prototype=j.prototype;fr.prototype=new T();fr.__super__=j.prototype;return fr},dq={}.hasOwnProperty;ey=F.ManageAliasModal=(function(j){fi(i,j);function i(T){this.options=T;this._poll_until_verified=b3(this._poll_until_verified,this);this._get_params_from_target=b3(this._get_params_from_target,this);this._on_load=b3(this._on_load,this);this._show_action_panel=b3(this._show_action_panel,this);this._input_enter_handler=b3(this._input_enter_handler,this);this.resend_verify=b3(this.resend_verify,this);this.remove_alias=b3(this.remove_alias,this);this.add_alias=b3(this.add_alias,this);this.refresh_alias=b3(this.refresh_alias,this);this.on_show=b3(this.on_show,this);i.__super__.constructor.call(this,this.options)}i.prototype.before_show=function(T){i.__super__.before_show.call(this,T);this.polling=0;T.find(".alias-action").on("click",this._show_action_panel);T.find(".alias-action-submit").on("click",this.add_alias);T.find("form").submit(function(){return false});return T.find(".alias-action-inputs input").on("keyup",this._input_enter_handler)};i.prototype.on_show=function(){return this.refresh_alias(true,this._poll_until_verified)};i.prototype.refresh_alias=function(fr,T){if(fr==null){fr=true}if(fr){bT.clear_errors()}return new Ajax.DBRequest("/account/alias/get",{subject_user:this.options.subject_user,onSuccess:(function(fs){return function(ft){fs.$modal_window.find(".dynamic-content").html(ft.responseText);fs._on_load(ft);if(typeof T==="function"){return T()}}})(this),onFailure:(function(fs){return function(ft){return fs.hide()}})(this)})};i.prototype.add_alias=function(ft){var fs,T,fr,fu;ft.preventDefault();T=bF(ft.currentTarget).closest("form");fs=T.find(".alias-action-submit");fu={};fu[a9.UID_PARAM_NAME]=this.options.subject_user.id;fr=(function(fv){return function(){var fw;fv.$modal_window.find(".alias-action-inputs input").val("");fv.polling=0;fw=fv.polling?null:fv._poll_until_verified;return fv.refresh_alias(true,fw)}})(this);return bT.ajax_submit(T[0],false,fr,false,fs[0],fu,"before")};i.prototype.remove_alias=function(T){var fr;T.preventDefault();fr=this._get_params_from_target(T.currentTarget);return new Ajax.DBRequest("/account/alias/remove",{subject_user:this.options.subject_user,parameters:fr,onSuccess:(function(fs){return function(ft){return fs.refresh_alias()}})(this)})};i.prototype.resend_verify=function(T){var fr;T.preventDefault();fr=this._get_params_from_target(T.currentTarget);return new Ajax.DBRequest("/account/alias/send_verify",{subject_user:this.options.subject_user,parameters:fr,onSuccess:(function(fs){return function(ft){return fs.refresh_alias()}})(this)})};i.prototype._input_enter_handler=function(T){T.preventDefault();T.stopPropagation();if(T.which===13){return this.add_alias(T)}};i.prototype._show_action_panel=function(fs){var fr,T;fs.preventDefault();T=bF(fs.currentTarget).data("target");this.$modal_window.find(".alias-action-panel").hide();fr=this.$modal_window.find("#"+T).show();return fr.find("input:visible:enabled:first").focus()};i.prototype._on_load=function(T){bf.register_all();this.$dynamic=this.$modal_window.find("#alias-list-container");this.$dynamic.on("click",".alias-remove",(function(fr){return function(fs){return fr.remove_alias(fs)}})(this));return this.$dynamic.on("click",".alias-verify",(function(fr){return function(fs){return fr.resend_verify(fs)}})(this))};i.prototype._get_params_from_target=function(fs){var T,fr,ft;T=bF(fs);ft=T.data("alias-type");fr=T.closest(".alias-row").find(".alias-text").text();return{alias:fr,alias_type:ft}};i.prototype._poll_until_verified=function(){var fs,ft,fr,T;ft=5;fs=60;fr=(function(fu){return function(){return fu.refresh_alias(false,fu._poll_until_verified)}})(this);T=this.$dynamic.find(".alias-verify").length;if(T&&this.polling<fs){this.polling++;return setTimeout(fr,ft*1000)}else{return this.polling=0}};return i})(ed);bW=INLINE_JS.AliasManager=F.AliasManager={show:function(fs){var T,fr,j,i;i=cQ.get_viewer().get_user_by_role(fs);if(i==null){return}if(!i.is_email_verified){if(fs===Constants.ROLE_PERSONAL){personal_email_verification.verified_or_show()}else{work_email_verification.verified_or_show()}return}j=cQ.get_viewer().is_paired?fs:"";fr=eG("Manage your %(role_show)s contact methods").format({role_show:j});T=new ey({element_id:"manage-alias",title:fr,subject_user:i,role:i.role});T.show()}};var dF;dF=INLINE_JS.BonusTable=F.BonusTable={_tmpl:null,_inited:null,_next_page:0,_fetching_page:false,init:function(i){this.user_id=i;if(dF._inited){return}dF._inited=true;$("bonus-loading").show();dF._tmpl=fm.tmpl("bonus_row_tmpl");dF.listen();return dF.get_next_page()},_render:function(fs){var fr,T,j,ft;fr=[];for(T=0,j=fs.length;T<j;T++){ft=fs[T];fr.push(dF._tmpl({row:ft,Sprite:cy}))}return $("bonus-table").__sert(fr)},get_next_page:function(){if(dF._fetching_page){return}dF._fetching_page=true;return new Ajax.DBRequest("/account/bonus_page/"+dF._next_page,{onSuccess:function(j){var fr,i,T;fr=j.responseText.evalJSON();T=fr.rows;i=fr.has_more;dF._render(T);$("bonus-loading").hide();if(i){dF._next_page+=1;$("load-more-bonus").show()}else{$("load-more-bonus").hide()}return dF._fetching_page=false},subject_user:this.user_id})},_max_referral_over:function(j){var i,fr,T;fr=bF(j.currentTarget);T=eG("You've earned the maximum amount of referral space. Thanks for inviting people to Dropbox!");i=bF(es.make(T,"right","middle"));Element.absolutize(i[0]);fr.append(i);i.clonePosition(fr,{setWidth:false,setHeight:false});return i.css({width:"200px",left:(parseInt(i.css("left"),10)-210)+"px",top:(parseInt(i.css("top"),10)-55)+"px"})},_max_referral_out:function(fu){var T,fs,j,ft,fr;ft=bF(".reached-max-referral-bonus .bubble");fr=[];for(fs=0,j=ft.length;fs<j;fs++){T=ft[fs];fr.push(T.remove())}return fr},listen:function(){bF("#load-more-bonus").on("click",dF.get_next_page.bind(dF));bF(document).on("mouseenter",".reached-max-referral-bonus",dF._max_referral_over);return bF(document).on("mouseleave",".reached-max-referral-bonus",dF._max_referral_out)},toggle:function(){if(bF("#bonus-list").is(":visible")){this.hide();return bF("#space-earned-link").text(eG("View all space earned"))}else{this.show();return bF("#space-earned-link").text(eG("Hide space earned"))}},show:function(){return bF("#bonus-list").slideDown(150)},hide:function(){return bF("#bonus-list").slideUp(150)}};var E,v,c;E=INLINE_JS.DowngradeReasons=F.DowngradeReasons={reasons:{},addReason:function(i){return this.reasons[i]=true},addReasons:function(T){var ft,fr,j,fs;fs=[];for(ft=0,j=T.length;ft<j;ft++){fr=T[ft];fs.push(this.addReason(fr))}return fs},change:function(ft,T,j){var fu,fw,fv,fr,fs,i;ft=parseInt(ft,10);fw=$(T);cP(fw,"Couldn't find container for DowngradeReason");fu=false;fs=this.reasons;for(fr in fs){fv=fs[fr];i=$(j+fr);cP(i,"Couldn't find container for ",j+fr);if(fv&&parseInt(fr,10)===ft){i.show();fu=true}else{i.hide()}}if(fu){return fw.show()}else{return fw.hide()}}};v=F.DowngradeReasons2={init:function(){var fr,j,T,fs;fs=["input[name=downgrade_reason_id]","input[name=other_reason_id]"];for(fr=0,j=fs.length;fr<j;fr++){T=fs[fr];bF(T).change(function(ft){var i;i=ft.target.id.indexOf("other")>=0;return v.change(i,ft.target.getValue())})}return bF(".shared-additional-info").attr("name","shared_additional_info")},change:function(T,i){var j;bF(".downgrade-other-reason .error-message").hide();if(T){return}j="#downgrade-info-"+i;bF(".downgrade-info").hide();bF(j).show();bF(".downgrade-info textarea").removeAttr("name");bF(j+" textarea").attr("name","additional_info");return bF("input[name=other_reason_id]").removeAttr("checked")}};c=F.DowngradeSurvey={init:function(){var i;i="#downgrade-survey-form";return bF(""+i).on("submit",(function(j){return function(fs){var fr,T;T=bF(i+" input[name=other_reason_id]:checked").length;fr=bF(i+" input[id=downgrade-radio-8]");if(fr.is(":checked")&&T===0){bF(".downgrade-other-reason .error-message").show();return fs.preventDefault()}}})(this))}};var cd;cd=INLINE_JS.GetSpace=F.GetSpace={_current_space:null,_why_msg:null,_twitter_url:null,offer_highlight_color:"#ffa",init:function(T,j,fr){var i;cd._current_space=T;cd._why_msg=j;cd._twitter_url=fr;$("space-actions").on("click",".space-action",cd.perform_action);i=H.parse(window.location.href).fragment;if(i){return cd.highlight_offer(i)}},highlight_offer:function(j){var i,T;i=bF("#"+j);T=i.css("background-color");return i.css("background-color",cd.offer_highlight_color).delay(2000).animate({"background-color":T}).queue(function(){return i.css("background-color","")})},perform_action:function(j){var T,i;i={contact_sales:cd._contact_sales,contact_support:cd._contact_support,teams:cd._teams,upgrade:cd._upgrade,plans:cd._plans,refer:cd._refer,get_started:cd._get_started,fb_link:cd._fb_link,twitter_link:cd._twitter_link,twitter_follow:cd._twitter_follow,why_like:cd._why_like,mailbox_link:cd._mailbox_link};T=$(j.target);if(!T.hasClassName("space-action")){T=T.up(".space-action")}return i[T.id]()},_teams:function(){return window.location.href="/business?tk=dropbox&ag=getspace&ad=v1"},_contact_sales:function(){return window.location.href="mailto:sales@dropbox.com"},_contact_support:function(){return window.location.href="/support"},_plans:function(){return window.location.href="/plans"},_upgrade:function(){return window.location.href="/upgrade"},_refer:function(){return window.location.href="/referrals"},_get_started:function(){return window.location.href="/gs"},_fb_link:function(){return ew.do_auth(function(){cd._refresh_link_bonuses();return cd._completed($("fb_link"))},cQ.get_viewer().personal_user.id)},_twitter_link:function(){return cI.do_auth(function(){cd._refresh_link_bonuses();cI.set_is_authed(cQ.get_viewer().personal_user.id,true);return cd._completed($("twitter_link"))},cQ.get_viewer().personal_user.id)},_twitter_follow:function(){if(cI.is_authed(cQ.get_viewer().personal_user.id)){return cd.follow_dropbox()}else{return cI.do_auth(cd.follow_dropbox,cQ.get_viewer().personal_user.id)}},_why_like:function(){fh.show(eG("Tell us why you love Dropbox"),$("why-i-like-modal"));$("why-i-like-input").focus();return ec._track_twitter_chars_left("why-i-like-input",90)},_mailbox_link:function(){return window.location.href="http://www.mailboxapp.com/"},follow_dropbox:function(){if(!cI.is_authed(cQ.get_viewer().personal_user.id)){cd._refresh_link_bonuses();cI.set_is_authed(cQ.get_viewer().personal_user.id,true)}return cI.follow_dropbox({showWorking:function(){return $("twitter_follow").down(".title").__date(eG("Following Dropbox on Twitter..."))},onFailure:function(){return $("twitter_follow").down(".title").__date(eG("Follow Dropbox on Twitter"))},onSuccess:function(){if($("twitter_link")&&$("twitter_link").visible()){cd._completed($("twitter_link"))}return cd._completed($("twitter_follow"))}},cQ.get_viewer().personal_user.id)},submit_why:function(){cd._why_msg=$F("why-i-like-input");return bT.ajax_submit($("why-i-like-form"),false,(function(){fh.hide();return cd._completed($("why_like"))}),false,$("why-i-like-submit"))},_completed:function(j){var i;j.addClassName("completed");j.down(".icon-col").__date(Element("img",{src:"/static/images/check_36-vflimxFPn.png"}));bF(j).css("opacity",0.5).fadeTo(500,1);setTimeout((function(){return bF(j).css("opacity",1).slideUp().animate({opacity:0},{queue:false,duration:"normal"})}),1500);i=parseInt(j.down(".space").readAttribute("data-space"),10);cd._current_space+=i;$("current-space").__date(aF.format_bytes(cd._current_space));$("current-space").addClassName("updated");return setTimeout((function(){return $("current-space").removeClassName("updated")}),5000)},_refresh_link_bonuses:function(){return new Ajax.DBRequest("/social_recheck")}};var bz;bz=F.Help={toggle_more_help:false,show_os:function(j,T,i){T=$(T);$$(".os-filter").invoke("removeClassName","selected");T.addClassName("selected");$$(".help-os-section").invoke("hide");$$(".help-os-"+i).invoke("show");return Event.stop(j)},vote:function(i,j){new Ajax.DBRequest("/help/"+i+"/vote/"+j);bF("#help-vote-cont").fadeOut();return ah.success(eG("Thanks for your feedback!"))}};var eB,d1,ag,u,b3=function(i,j){return function(){return i.apply(j,arguments)}},fi=function(fr,j){for(var i in j){if(dq.call(j,i)){fr[i]=j[i]}}function T(){this.constructor=fr}T.prototype=j.prototype;fr.prototype=new T();fr.__super__=j.prototype;return fr},dq={}.hasOwnProperty;d1=INLINE_JS.Hosts=F.Hosts={attach_host_listener:function(fs,T){var j,fr,ft,i;j=bF("#"+fs);ft=j.data("host-ids");fr=j.data("display-name");i=function(){return new ag(ft,fr,T,null,null).show()};bF(".unlink-host-link",j).on("click",i);return j.on("dblclick",(function(){return d1.edit(ft,fs)}))},edit:function(fu,fr){var T,fv,fw,ft,fs,j;fw=bF("#"+fr+" .host-item .sprite-text");if(fw.data("editing")==="true"){return false}fw.data("editing","true");fv=fw.text();fw.data("previous",fv);fu=bx.values(fu);ft=bF('<input type="text" class="name-input skinny-input" size="20" maxlength="256" style="word-wrap: break-word;" />').val(fv);j=bF('<input type="button" class="button">').val(eG("Save"));j.on("click",function(){return d1.doneEditing(fu,fr)});T=bF('<input type="button" class="button grayed">').val(eG("Cancel"));T.on("click",function(){return d1.cancelEditing(fr)});fw.empty();fw.append(ft,"&nbsp;",j,"&nbsp;",T);fs=bF("input",fw);fs.on("keydown",function(){return d1.checkKey(fu,fr)});fs.focus();return false},doneEditing:function(T,j){var fr,i;fr=bF("#"+j+" .host-item .sprite-text");i=bF("input",fr).val();return bF.ajax({url:"/account/change_host_name",data:{host_ids:JSON.stringify(T),name:i},type:"POST"}).success(function(fs){return d1.unedit(fr,JSON.parse(fs).display_name)})},cancelEditing:function(i){var j;j=bF("#"+i+" .host-item .sprite-text");return d1.unedit(j,j.data("previous"))},unedit:function(j,i){j.data("editing","false");return j.text(i)},dismiss:function(T,j,fr,i,fs){new bF.ajax("/account/dismiss_unlink",{type:"POST",data:{host_id:T,user_id:j,team_id:fr},subject_user:fs,success:function(ft){return i.remove()}});return false},checkKey:function(j,i){return function(T){T=T||window.event;if(T.keyCode===Event.KEY_RETURN){d1.doneEditing(j,i)}if(T.keyCode===Event.KEY_ESC){return d1.cancelEditing(i)}}},show_device_unlink_modal:function(j,T,i,fv,fs,fr){var fu,ft;fu=bF("#unlink-device-modal-"+fs);ft={both:bx.values(fv),personal:[fv[Constants.ROLE_PERSONAL]],work:[fv[Constants.ROLE_WORK]]};fh.show(i,fu[0]);if(bx.values(fv).length>1){fu.addClass("show-selector")}return bF("form input[type=submit]",fu).on("click",function(fw){fw.preventDefault();fv=ft[bF(".unlink-select select",fu).val()];bT.add_vars(bF("form",fu)[0],{user_ids:JSON.stringify(fv),app_id:T,device_id:JSON.stringify(j),device_name:fr});return bF("form",fu).submit()})}};eB=F.DeleteFailuresModal=(function(i){fi(j,i);function j(){this.on_show=b3(this.on_show,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);return j.__super__.constructor.apply(this,arguments)}j.prototype.on_confirm_button_click=function(T){T.preventDefault();window.location.href="/delete_failures?host_id="+this.host_id;return this.hide()};j.prototype.on_show=function(fr){var T;T=bd("Dropbox couldn't delete %(num_failures)d file from the computer <strong>%(host_name)s</strong>. You can download the name of this file and the reason why it couldn't be deleted.","Dropbox couldn't delete %(num_failures)d files from the computer <strong>%(host_name)s</strong>. You can download the names of these files and the reasons why they couldn't be deleted.",this.num_failures).format({host_name:this.name.escapeHTML(),num_failures:this.num_failures});return this.$modal_window.find(".failures_message").html(T)};return j})(ed);u=INLINE_JS.show_delete_failures_modal=F.show_delete_failures_modal=function(T,j,i){var fr;fr=new eB({element_id:"delete-failures-modal"});fr.host_id=T;fr.name=j;fr.num_failures=i;fr.show();return false};ag=INLINE_JS.UnlinkHostModal=F.UnlinkHostModal=(function(j){fi(i,j);function i(T,fu,fs,fr,ft){this.host_ids=T;this.name=fu;this.delete_support_type=fs;this.owner_id=fr;this.team_id=ft;this.on_show=b3(this.on_show,this);this._set_delete_text=b3(this._set_delete_text,this);this.fail_callback=b3(this.fail_callback,this);this.success_callback=b3(this.success_callback,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);i.__super__.constructor.call(this,{element_id:"unlink-host-modal"});this.show_host_selector=bx(this.host_ids).values().length>1}i.prototype.on_confirm_button_click=function(ft){var fr,fs,T;ft.preventDefault();fs=this.$modal_window.find(".unlink_host_form")[0];fr=$(this.$modal_window.find(".confirm-button")[0]);this.$modal_window.find("[type=button]").attr("disabled","");T={host_ids:JSON.stringify(this.get_selected_hosts())};return bT.ajax_submit(fs,false,this.success_callback,this.fail_callback,fr,T)};i.prototype.success_callback=function(){return window.location.reload()};i.prototype.fail_callback=function(){return this.$modal_window.find("[type=button]").removeAttr("disabled")};i.prototype._set_delete_text=function(T){return this.$modal_window.find(".delete_data_label").text(T)};i.prototype._get_unlink_select=function(){return this.$modal_window.find(".unlink-select select").val()};i.prototype._clear_delete_checkbox=function(){return this.$modal_window.find(".delete_data").prop("checked",false)};i.prototype.on_show=function(fr){var T;this._clear_delete_checkbox();if(this.delete_support_type===Constants.DELETE_ON_UNLINK_OLD_CLIENT){this.$modal_window.find(".unlink_host_modal_content").addClass("show_old_client_modal")}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_UNSUPPORTED){this.$modal_window.find(".unlink_host_modal_content .unlink_host_form").addClass("hidden")}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_SUPPORTED_TEAM_ONLY){this.$modal_window.find(".unlink-choice").change((function(fs){return function(ft){if(fs._get_unlink_select()===Constants.ROLE_PERSONAL){return fs.$modal_window.find(".new_client").hide()}else{return fs.$modal_window.find(".new_client").show()}}})(this));this._set_delete_text(eG("Delete files from %(team_name)s Dropbox the next time this computer comes online.").format({team_name:cQ.get_viewer().team_name}))}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_SUPPORTED_PERSONAL_ONLY){this.$modal_window.find(".unlink-choice").change((function(fs){return function(ft){if(fs._get_unlink_select()===Constants.ROLE_WORK){return fs.$modal_window.find(".new_client").hide()}else{return fs.$modal_window.find(".new_client").show()}}})(this));this._set_delete_text(eG("Delete files from my personal Dropbox the next time this computer comes online."))}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_SUPPORTED){this._set_delete_text(eG("Delete files from these Dropboxes the next time this computer comes online."));this.$modal_window.find(".unlink-choice").change((function(fs){return function(ft){if(fs._get_unlink_select()===Constants.ROLE_PERSONAL){return fs._set_delete_text(eG("Delete files from my personal Dropbox the next time this computer comes online."))}else{if(fs._get_unlink_select()===Constants.ROLE_WORK){return fs._set_delete_text(eG("Delete files from %(team_name)s Dropbox the next time this computer comes online.").format({team_name:cQ.get_viewer().team_name}))}else{return fs._set_delete_text(eG("Delete files from these Dropboxes the next time this computer comes online."))}}}})(this))}}}}}if(this.show_host_selector){T="<span class='host_name'></span>";this.$modal_window.find(".unlink-select").removeClass("hidden");this.$modal_window.find(".unlink-modal-text").html(eG("Which Dropboxes do you want to unlink from %(host_name)s? Any Dropbox you unlink will immediately stop syncing.").format({host_name:T}))}this.$modal_window.find("[name=host_id]").attr("value",this.host_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);this.$modal_window.find("[name=user_id]").attr("value",this.owner_id);return this.$modal_window.find(".host_name").text(this.name)};i.prototype.get_selected_hosts=function(){var T;if(bx.values(this.host_ids).length===1){return bx.values(this.host_ids)}T=bF(".unlink-choice").val();if(T==="both"){return bx.values(this.host_ids)}else{return[this.host_ids[T]]}};return i})(ed);var eR;eR=F.News={DEFAULT_TAB:"recent-news",init:function(){$("news-home").on("click","#nav a",function(j,T){var i;if(T.hasAttribute("data-div")){j.preventDefault();i=T.readAttribute("data-div");return eJ.push_state("/news/"+i)}});return eJ.add_callback("/news",eR.history_change)},change_tab:function(i){var j;j=$$("#nav a[data-div="+i+"]").first();if($(j)){$$(".section").invoke("removeClassName","selected");$$("#nav a").invoke("removeClassName","selected");$(j).addClassName("selected");return $(i).addClassName("selected")}},history_change:function(i){i=i||eR.DEFAULT_TAB;return eR.change_tab(i)}};var dO;dO=F.Recover={init:function(){var i;i=$("recover-form");return i.observe("submit",this.form_submit.bind(this))},form_submit:function(i){this.clear_error();i.preventDefault();return bT.ajax_submit($("recover-form"),null,this.submit_response.bind(this))},submit_response:function(j){var i;i=JSON.parse(j.responseText);if(i.status==="error"){this.show_error(i.msg)}if(i.status==="ok"){this.show_hosts(i)}if(i.status==="redirect"){return window.location.href=i.url}},show_hosts:function(fw){var fv,fs,fr,ft,T,j,fu;bT.add_vars($("recover-form"),{check_file:"true"});$("filename-to-create").update(fw.filename);fs=$("trusted-hosts");fs.update();fu=fw.hosts;for(fr=0,T=fu.length;fr<T;fr++){fv=fu[fr];j=new Element("li");ft="lnx";if(fv.platform==="mac"){ft="osx"}if(fv.platform==="win"){ft="win"}j.__sert(cy.make("web",ft));j.__sert(new fm(fv.display_name.escapeHTML()));fs.appendChild(j)}$("login-step").hide();return $("hosts-step").show()},show_error:function(i){$("error-messages").update(i);return $("error-messages").show()},clear_error:function(){return $("error-messages").update()}};var dw;dw=F.Restore={next:function(i,fr){var T,j;j=bF("ul.selected");T=j.next("ul");T.addClass("selected");j.removeClass("selected");if(T.next("ul").length){bF("#next-page").show()}else{bF("#next-page").hide()}bF("#prev-page").show();return dw.inc_page(1)},prev:function(i,fr){var T,j;j=bF("ul.selected");T=j.prev("ul");T.addClass("selected");j.removeClass("selected");if(T.prev("ul").length){bF("#prev-page").show()}else{bF("#prev-page").hide()}bF("#next-page").show();return dw.inc_page(-1)},inc_page:function(T){var j,i;j=parseInt(bF("#page_num").text(),10);i=j+T;return bF("#page_num").text(i)},init:function(fr,i,j){var T;T=cQ.get_viewer().get_user_by_id(j);bF("#next-page").on("click",function(fs){dw.next(fs);return false});bF("#prev-page").on("click",function(fs){dw.prev(fs);return false});bF("#restore-submit-button").on("click",function(fs){dK.do_folder_restore(fr,T);return false});bF("#restore-cancel-button").on("click",function(fs){return b1.redirect(i)});return bF("#restore-back-button").on("click",function(fs){return b1.redirect(i)})}};var ch,dG,cM,aT,b3=function(i,j){return function(){return i.apply(j,arguments)}},fi=function(fr,j){for(var i in j){if(dq.call(j,i)){fr[i]=j[i]}}function T(){this.constructor=fr}T.prototype=j.prototype;fr.prototype=new T();fr.__super__=j.prototype;return fr},dq={}.hasOwnProperty;ch=F.SelectRoleModal=(function(i){fi(j,i);function j(){this.on_show=b3(this.on_show,this);return j.__super__.constructor.apply(this,arguments)}j.prototype.on_select_role=null;j.prototype.on_show=function(){return bF(".role-options li").click((function(T){return function(fs){var fr,ft;fr=bF(fs.target).closest("li");ft=fr.data("role");cP(T.on_select_role,"missing on_select_role implementation");T.on_select_role(ft);return T.hide()}})(this))};return j})(ed);cM=F.SharedFolderSelectRoleModal=(function(i){fi(j,i);function j(){return j.__super__.constructor.apply(this,arguments)}j.prototype.on_select_role=function(fr){var T;T=function(){bZ.role_picker.ensure_role_is_visible(fr);return s.start_wizard_for_user(cQ.get_viewer().get_user_by_role(fr))};if(fr===bO.logged_out_role){return bO.show_modal({role:fr,on_success:T})}else{return T()}};return j})(ch);aT=F.ShmodelC2DSelectRoleModal=(function(i){fi(j,i);function j(){return j.__super__.constructor.apply(this,arguments)}j.prototype.on_select_role=function(fr){var T;T=function(){return am.show_c2d_modal(fr)};if(!cQ.get_viewer().is_role_signed_in(fr)){return bO.show_modal({role:fr,on_success:T})}else{return T()}};return j})(ch);dG=F.ShareShmodelSelectRoleModal=(function(i){fi(j,i);function j(){this.on_select_role=b3(this.on_select_role,this);return j.__super__.constructor.apply(this,arguments)}j.prototype.on_select_role=function(T){return am.prompt_login_then_share(this.options.link_url,this.options.short_url,this.options.tokenizer_type,T)};return j})(ch);var cU;cU=F.TabController=Class.create({initialize:function(T,j){var i;i=$(T);cP(i,T+" is missing.");this.container=i;this.options={killEvent:true};Object.extend(this.options,j);return this.listen()},listen:function(){var fu,fr,j,ft,T,fs;fs=this;ft=this.container.select("a");T=[];for(fr=0,j=ft.length;fr<j;fr++){fu=ft[fr];cP(fu.id&&fu.id.length>0,"Element is missing an id");T.push(fu.observe("click",(function(i){return this.click(i)}).bindAsEventListener(fs)))}return T},click:function(i){if(this.options.killEvent){Event.stop(i)}return this.toggle($(i.target))},toggle:function(j){var fs,i,fr,ft,T;T=this.container.down("a.selected");if(T){ft=$(T.id+"-content");if(ft){ft.hide()}}this.container.select(".selected").invoke("removeClassName","selected");i=false;if(!j){j=this.container.down("a");i=true}j.addClassName("selected");fs=$(j.id+"-content");if(fs){fs.show()}if(this.options.onTabChange){this.options.onTabChange(j,T)}if(this.options.url_prefix){fr=this.options.url_prefix;if(!i){fr+="/"+j.id}return eJ.push_state(fr)}}});var dW;dW=F.InviteForm={initialized:false,init:function(){if(this.initialized){return}return bF((function(i){return function(){i.add_auto_completer=new Autocompleter.ContactsTokenizer(cQ.get_viewer().get_user_by_role(Constants.ROLE_WORK),"team-invite-new-collab-input","team-invite-new-whobulk","team-invite-hidden-input",{tokens:[",",";"],hide_import_contacts:true,suggestions_disabled:true,contact_filter:function(j){return j.excludeTeamMembers().excludeFacebook().excludeNewStyleGroups().excludeMe()}});i.add_auto_completer.clearTokens();i.tokenAdd=bF.proxy(i._tokenAdd,i);i.tokenRemove=bF.proxy(i._tokenRemove,i);bF("#team-invite-new-collab-input")[0].on("token:add",i.tokenAdd);bF("#team-invite-new-collab-input")[0].on("token:remove",i.tokenRemove);i.reset_licenses();i.update_free_licenses_message();i.initialized=true;i.setup_tab_support(bF);return ck.init()}})(this))},set_emails:function(i){if(i==null){return}return bF((function(j){return function(){var fr,fu,ft,T,fs;j.init();fs=[];for(ft=0,T=i.length;ft<T;ft++){fr=i[ft];fu=j.add_auto_completer.createTokenInfo(null,fr,X.EMAIL);fs.push(j.add_auto_completer.addContact(fu))}return fs}})(this))},rebind_modal_submit_autocompleter:function(){var i,j;i=this.invite_modal.$modal_window;j=i.find(".tokenizer-submit-button");j.on("mousedown",(function(T){return function(){return T.add_auto_completer.beforeSubmit()}})(this));return this.setup_tab_support(i)},setup_tab_support:function(i){return i.find("#team-invite-new-collab-input").first().on("keyup change",function(){var j;j=i.find(".new-collab-input").first();if(j.val()!==""){return j.attr("tabindex",-1)}else{return j.removeAttr("tabindex")}})},reset_modal_licenses:function(){var T,j,i;i=__CIRCULAR_DEPENDENCY__.Dashboard!=null?__CIRCULAR_DEPENDENCY__.Dashboard.get_licensed_members():__CIRCULAR_DEPENDENCY__.MembersReact!=null?__CIRCULAR_DEPENDENCY__.MembersReact.get_licensed_members():window.active_team_member_table.get_licensed_members();this.total_licenses=(T=(j=__CIRCULAR_DEPENDENCY__.MembersReact)!=null?typeof j.get_total_licenses==="function"?j.get_total_licenses():void 0:void 0)!=null?T:this.total_licenses;this.update_used_licenses(i);this.available_licenses=this.total_licenses-this.used_licenses;this.update_license_count();return this.new_users=0},reset_licenses:function(){this.available_licenses=this.total_licenses-this.used_licenses;this.update_license_count();return this.new_users=0},get_new_users:function(){return this.new_users},_tokenAdd:function(i){this.available_licenses--;bF(window).trigger("token:changed",{remaining_licenses:this.available_licenses});return this.new_users++},_tokenRemove:function(i){this.available_licenses++;bF(window).trigger("token:changed",{remaining_licenses:this.available_licenses});return this.new_users--},already_invited_user:function(j){var fr,T,i;if(window.active_team_member_table){fr=window.active_team_member_table.data.users;for(i in fr){T=fr[i];if(T.email===j){return true}}}},update_license_count:function(){var i,j;i=bF("#license-count-message");if(this.available_licenses<0){j=eG("You need more licenses for this invitation.");i.addClass("over")}else{if(this.available_licenses===0){j=eG("You have no remaining licenses.");i.removeClass("over")}else{if(this.available_licenses>0){j=bd("You have %(invites)d remaining license.","You have %(invites)d remaining licenses.",this.available_licenses).format({invites:this.available_licenses});i.removeClass("over")}else{j="You have \u00a0 remaining licenses."}}}return i.text(j)},init_modal_licenses:function(T,j,i){if(!this.invite_modal){this.invite_modal=new w(i)}this.total_licenses=T;this.is_trial=j;return bF("body").trigger("invite-modal-initialized")},update_used_licenses:function(i){this.used_licenses=i;return this.reset_licenses()},init_form_licenses:function(T,i,j){this.total_licenses=T;this.used_licenses=i;this.is_trial=j;return dW.reset_licenses()},add_total_licenses:function(i){i=i||0;if(i>0){this.total_licenses+=i;this.available_licenses+=i;this.update_license_count();if(__CIRCULAR_DEPENDENCY__.Dashboard!=null){return __CIRCULAR_DEPENDENCY__.Dashboard.add_licenses(i)}}},on_add_licenses_exit:function(T,i){var j;if((j=this.invite_modal)!=null?j.$modal_window:void 0){this.rebind_modal_submit_autocompleter()}return this.add_total_licenses(i)},reset_modal:function(){var i;i=this.invite_modal.$modal_window;da.reset(i.find("#team-invite-message")[0]);if(this.add_auto_completer){this.add_auto_completer.clearTokens();this.add_auto_completer.update.hide()}this.reset_modal_licenses();return i.find(".new-collab-input").val("")},on_add_licenses_click:function(j){var i;j.preventDefault();if(this.is_trial){if((i=this.invite_modal)!=null){i.hide()}return __CIRCULAR_DEPENDENCY__.add_more_licenses_to_trial()}else{if(this.add_licenses_cb!=null){d7.unregister(__CIRCULAR_DEPENDENCY__.AddLicensesModal.LICENSES_ADDED,this.add_licenses_cb)}this.add_licenses_cb=bF.proxy(this.on_add_licenses_exit,this);d7.register(__CIRCULAR_DEPENDENCY__.AddLicensesModal.LICENSES_ADDED,this.add_licenses_cb);return d7.push(new __CIRCULAR_DEPENDENCY__.AddLicensesModal())}},update_free_licenses_message:function(){var i;i=this.invite_as_limited();bF(".team-invite-add-licenses").toggle(!i);bF("#license-count-message").toggle(!i);return bF("#license-free-message").toggle(i)},invite_as_limited:function(){var i;i=bF('input[name="membership_type"]');return i&&i.is(":checked")}};var w,b3=function(i,j){return function(){return i.apply(j,arguments)}},fi=function(fr,j){for(var i in j){if(dq.call(j,i)){fr[i]=j[i]}}function T(){this.constructor=fr}T.prototype=j.prototype;fr.prototype=new T();fr.__super__=j.prototype;return fr},dq={}.hasOwnProperty;w=F.InviteModal=(function(j){fi(i,j);function i(T){this.transition_view_model=T;this._reset=b3(this._reset,this);this._update_form_pricing_information=b3(this._update_form_pricing_information,this);this._update_remaining_licenses_message=b3(this._update_remaining_licenses_message,this);this._make_transition_info_request=b3(this._make_transition_info_request,this);this._handle_token_change=b3(this._handle_token_change,this);this._licenses_total=b3(this._licenses_total,this);this.is_making_transition_info_request=b3(this.is_making_transition_info_request,this);this.on_hide=b3(this.on_hide,this);this.on_show=b3(this.on_show,this);i.__super__.constructor.call(this,{element_id:"team-invite-wizard",focus:".new-collab-input",title:eG("Invite team members")});this.inline_add_license=this.transition_view_model!=null;if(this.inline_add_license){this.transition_info_fetcher=new fl([this.transition_view_model]);this.probability=Math.random()}this.skip_reset=false;this.making_transition_info_request=false;this.transition_info_callback=null}i.prototype.on_confirm_button_click=function(fr){var T;if(dW.invite_as_limited()){T=0}else{T=this.add_qty}return d0.add_users(fr,T)};i.prototype.on_show=function(){var fr,T;this._reset();T=bF('input[name="membership_type"]');if(T!=null){T.attr("checked",false)}if(T!=null){T.click((function(fs){return function(){dW.update_free_licenses_message();return fs._updated_charges_messages(dW.invite_as_limited())}})(this))}fr=bF("#team-invite-wizard .team-invite-add-licenses");fr.on("click",bF.proxy(dW.on_add_licenses_click,dW));bF(window).on("token:changed",this._handle_token_change);if(dW.initialized){dW.update_license_count();dW.update_free_licenses_message()}return d7.register(d7.CLEAR,function(){return dW.reset_modal()})};i.prototype.on_hide=function(){return bF(window).off("token:changed",this._handle_token_change)};i.prototype.is_making_transition_info_request=function(){return this.making_transition_info_request};i.prototype._licenses_to_add=function(){return -1*dW.available_licenses};i.prototype._licenses_total=function(){return dW.total_licenses+this._licenses_to_add()};i.prototype._getInvitesCount=function(){return dW.total_licenses-dW.used_licenses-dW.available_licenses};i.prototype._handle_token_change=function(fr,T){this._updateConfirmButton();this._update_remaining_licenses_message(T.remaining_licenses);if(this.inline_add_license){clearTimeout(this.fetch_transition_timeout_id);return this.fetch_transition_timeout_id=setTimeout((function(fs){return function(){fs._make_transition_info_request();return fs.fetch_transition_timeout_id=null}})(this),100)}};i.prototype._make_transition_info_request=function(){var fs,fr,T,ft;this.making_transition_info_request=true;fr=Math.floor(Math.random()*1000000);this.current_callback_token=fr;fs=this._licenses_to_add();T=this._licenses_total();ft=(function(fu){return function(fv){return fu._update_form_pricing_information(fr,fs,T,fv!=null?fv[0]:void 0)}})(this);if(fs>0){return this.transition_info_fetcher.get(ft,{total_users:this._licenses_total()})}else{return ft(null)}};i.prototype._update_remaining_licenses_message=function(T){var fr;this.remaining_licenses=T;fr=this._get_remaining_licenses_message(this.remaining_licenses);return this.$modal_window.find("#license-count-message").text(fr)};i.prototype._get_remaining_licenses_message=function(T){var fr;if(T<0){fr=eG("You need more licenses for this invitation.")}else{if(T===0){fr=eG("After this invitation, you'll have no remaining licenses.")}else{fr=bd("After this invitation, you'll have %(count)d remaining license.","After this invitation, you'll have %(count)d remaining licenses.",T).format({count:T})}}return fr};i.prototype._update_form_pricing_information=function(ft,fu,T,fx){var fr,fw,fv,fs;if(ft!==this.current_callback_token){return}if(fx&&fu>0){this.add_qty=fu;fr=this.transition_view_model.state.currency;fv=fx.current_total.amount;fw=fk.formatCurrency(fv,fr);fs=fk.formatCurrency(fx.recurring_total.amount,fr);bF(".new-amount").text(fw);bF(".add-qty").text(fu);bF(".recurring-amount").text(fs);bF(".total-qty").text(T);bF("#expected_price").val(fv);this._updated_charges_messages(dW.invite_as_limited())}else{this._reset()}return this.making_transition_info_request=false};i.prototype._updateConfirmButton=function(){var T;T=bd("Send invite","Send invites",this._getInvitesCount());return bF(".team-invite-buttons .confirm-button").val(T)};i.prototype._reset=function(){this.add_qty=0;bF(".charges-section").hide();bF("#expected_price").val(0);return this._updateConfirmButton()};i.prototype._updated_charges_messages=function(T){if(this.inline_add_license&&this.add_qty>0&&!T){bF(".charges-section").show();return bF(".team-invite-buttons .confirm-button").val(eG("Invite and buy"))}else{bF(".charges-section").hide();return this._updateConfirmButton()}};return i})(ed);var bJ,aw,aB,V,el,e5,bu,eP,d0,fg,bh,ct,p,b3=function(i,j){return function(){return i.apply(j,arguments)}},fi=function(fr,j){for(var i in j){if(dq.call(j,i)){fr[i]=j[i]}}function T(){this.constructor=fr}T.prototype=j.prototype;fr.prototype=new T();fr.__super__=j.prototype;return fr},dq={}.hasOwnProperty;d0=INLINE_JS.Team=F.Team={_use_async_reset:false,team_id:cQ.get_viewer().team_id,set_team_id:function(i){this.team_id=i},setup_beta_modal_listeners:function(){var fv,fy,fw,T,fu,fr,fx,fs,ft;fy=bF(".feature-list .enroll-button");T=bF(".feature-list .feedback-button");for(fu=0,fx=fy.length;fu<fx;fu++){fv=fy[fu];fw=bF(fv).data("feature");bF(fv).click((function(i){return function(){return new aw(i).show()}})(fw));fv.disabled=false}ft=[];for(fr=0,fs=T.length;fr<fs;fr++){fv=T[fr];fw=bF(fv).data("feature");ft.push(bF(fv).click((function(i){return function(){return new aB(i).show()}})(fw)))}return ft},invite_modal_show:function(i){if(!dW.invite_modal){return bF("body").one("invite-modal-initialized",(function(j){return function(){return j.invite_modal_show(i)}})(this))}if(!this.invite_modal_already_initialized){dW.invite_modal.show();dW.init();this.invite_modal_already_initialized=true}else{dW.invite_modal.show();dW.rebind_modal_submit_autocompleter()}if(window.active_team_member_table!=null){dW.update_used_licenses(window.active_team_member_table.get_licensed_members())}return dW.set_emails(i)},init_admin:function(){bo.set_vertical_space(2);return bF("form.activity-report-generator").submit(this.submit_report_form.bind(this))},init_team_name_change_notice:function(){return bF(".team_name_change_notice .hide_link").click((function(i){return function(j){return i.hide_team_name_change_banner()}})(this))},add_users:function(fr,j){var fs,T,i;Event.stop(fr);T=$("team-invite-form");cP(T,"Couldn't find the team invite form.");fs=bF(T).find("input[name='emails']");if(fs.length===0){ah.error(eG("You haven't included anyone to invite! Please invite at least one person."));return}i=(function(ft){return function(){var fu;fu=bT.collect_form_vars(T);bF.extend(fu,{team_id:ft.team_id});bT.add_loading(fr.target);return new Ajax.DBRequest("/account/team/add_users",{parameters:fu,subject_user:cQ.get_viewer().work_user,progress_text:eG("Inviting members..."),noAutonotify:true,onSuccess:function(fA){var fy,fx,fw,fz,fv;bT.remove_loading();dW.reset_modal();dW.add_total_licenses(j);dW.invite_modal.hide();fz=bF(".team_admin_members_table");fw=JSON.parse(fA.responseText);if(fw){if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){window.active_team_member_table.add_users(fw!=null?fw.users:void 0)}else{if(__CIRCULAR_DEPENDENCY__.Dashboard!=null){__CIRCULAR_DEPENDENCY__.Dashboard.set_num_invited(fw!=null?fw.num_invited:void 0)}}}fy=(function(){var fC,fB;fC=fw!=null?fw.users:void 0;fB=[];for(fx in fC){fv=fC[fx];fB.push(fv)}return fB})();if(fy.length===1){return ah.success(eG("Invited %(user_email)s.").format({user_email:fy[0].email}))}else{if(fy.length>1){return ah.success(eG("Invited %(user_count)d people.").format({user_count:fy.length}))}else{return ah.error(bd("Skipped %(num_skipped)d person who is already a member of the team.","Skipped %(num_skipped)d people who are already members of the team.",fs.length).format({num_skipped:fs.length}))}}}else{return ah.error()}},onFailure:function(fx){var fv,fw;if(fx){if(fx.responseText.indexOf("err:")===0){fv=fx.responseText.substr(4);if(fv.indexOf("{")===0){fw=fv.evalJSON(true);bT.fill_errors(T,fw)}else{fv=new fm(fv);ah.error(fv)}}else{ah.error()}}bT.remove_loading();return bF("input[type='submit']").prop("disabled",false)},cleanUp:function(){bT.remove_loading();dW.reset_modal();return dW.invite_modal.hide()}})}})(this);return setTimeout(function(){if(!dW.invite_modal.is_making_transition_info_request()){return i()}},100)},show_demo_signup_modal:function(T,fr,fs,j,ft){var i,fw,fv,fu;this.webinar_key=T;this.webinar_iso_datetime=fr;this.webinar_date=fs;this.webinar_title=j;this.tab_url=ft;fu=eG("Register for a webinar on %(start_time)s").format({start_time:this.webinar_date});fw=new V({element_id:"demo-signup-modal",title:fu});fw.show();fw.$modal_window.find("input[name=webinar_key]").attr("value",this.webinar_key);fw.$modal_window.find("input[name=webinar_title]").attr("value",this.webinar_title);fw.$modal_window.find("input[name=Sales_Webinar_Topic__c]").attr("value",this.webinar_title);fw.$modal_window.find("input[name=Sales_webinar_date__c]").attr("value",this.webinar_iso_datetime);fv=fw.$modal_window.find("input[name=retURL]");fv.attr("value",fv.val()+"#"+this.tab_url);i=fw.$modal_window.find("#demo-signup-form")[0];return i.on("submit",fw.on_confirm_button_click)},show_unsuspend_modal:function(fr,i,j,T){var fs;fs=new bu({element_id:"dfe-unsuspend-modal",focus:"confirm"});fs.user_name=fr||j;fs.email=j;fs.user_id=i;fs.team_id=this.team_id;fs.refresh_cb=T;fs.show();return false},show_remove_or_deactivate_modal:function(j,T,fw,fr,fs,fu,i,ft){var fv;fv=new el({element_id:"dfe-remove-or-deactivate-user-modal",focus:".new-collab-input"});fv.user_name=T||fr;fv.email=fr;fv.user_id=fw;fv.team_id=this.team_id;fv.invited=fs;fv.limited=fu;fv.hide_transfer_wipe=i;fv.refresh_cb=ft;fv.show();return false},show_remove_modal:function(fs,ft,fy,fu,fv,i,T,fr,j,fw){var fx;fx=new e5({element_id:"dfe-remove-user-modal",focus:".new-collab-input"});fx.user_name=ft||fu;fx.email=fu;fx.user_id=fy;fx.team_id=this.team_id;fx.invited=fv;fx.num_api_apps=i;fx.hide_transfer_setting=T;fx.hide_remote_wipe_setting=fr;fx.refresh_cb=fw;fx.user_is_managed=j;fx.show();return false},remove_user:function(fr,fs){var T,j,i;alert("in remove_user");Event.stop(fr);j=bF("input[type=submit]","#remove-user-modal");j.attr("disabled",1);i=fh.vars.user_id;if(fs){T=true}else{T=bF("input[name=should_disable]:checked","#remove-user-modal").val()}return new Ajax.DBRequest("/account/team/remove_user",{parameters:{team_id:this.team_id,user_id:i,should_disable:T},onSuccess:(function(ft){return function(fx){var fw,fv,fu;fu=JSON.parse(fx.responseText);if((fw=window.active_team_member_table)!=null){fw.remove_user(fh.vars.user_id)}if((fv=window.removed_team_member_table)!=null){fv.add_users(fu)}ft.decrement_used_licenses();return ah.success(eG("User removed."))}})(this),cleanUp:function(){fh.hide();return j.removeAttr("disabled")}})},show_reinvite_modal:function(T,fr,i,j){var fs;dB.fillVal(j,"reinvite-user-email");dB.fillVal(fr,"reinvite-user-team");fs=eG("Resend invite to '%(email_address)s'").format({email_address:bU.em_snippet(j,18)});return fh.show(fs,$("reinvite-user-modal"),{user_id:i,button:T})},email_verification:this.email_verification=new ea("work"),show_email_verification_modal:function(){return this.email_verification.show_verify_modal(null,ex.NEW_DFB_TEAM)},reinvite_user:function(j){var i;Event.stop(j);i=fh.vars.user_id;return new Ajax.DBRequest("/account/team/reinvite_user",{parameters:{team_id:this.team_id,user_id:i},onSuccess:function(fu){var fr,ft,fs,T;ah.success(eG("Invite sent."));if((ft=$("team-member-info"))!=null){ft.update(fu.responseText)}fr=window.active_team_member_table;if(fr){T=fr.data.users[i];T.invite_expired=false;fs={};fs[i]=T;return fr.update_user_data(fs)}},cleanUp:function(){return fh.hide()}})},show_request_license_modal:function(j,i){var T;T=eG("Send upgrade request?");return fh.show(T,$("request-license-modal"),{user_id:i,button:j})},request_license:function(j){var i;Event.stop(j);i=fh.vars.user_id;return new Ajax.DBRequest("/team/request_license",{parameters:{team_id:this.team_id,user_id:i},onSuccess:function(T){bF("#request_license_text").hide();bF("#request-license-section").hide();return ah.success(eG("Request sent."))},cleanUp:function(){return fh.hide()}})},show_user_activity_log_modal:function(i,T,fr){var j;j=bF("#activity-log-modal");j.find(".activity-log-email").text(T);j.find(".activity-log-name").text(fr);j.find("#activity-log-user-message").show();return fh.show(eG("Create activity report"),j[0],{user_id:i})},show_team_activity_log_modal:function(j,T){var i;i=bF("#activity-log-modal");i.find(".activity-log-email").text(j);i.find(".activity-log-name").text(T);i.find("#activity-log-team-message").show();return fh.show(eG("Create full activity report"),i[0])},generate_activity_log:function(fv){var ft,fr,fu,fs,i,T,j;Event.stop(fv);fr=bF("#activity-log-modal");fu=fr.find("input[name='from_date']").val();i=fr.find("input[name='to_date']").val();if(fu>i){ah.error(eG("Your start date is after your end date."));return}fs=this.team_id;j=fh.vars.user_id;T=new Date().getTimezoneOffset().toString();ft=bF(".activity-report-generator .freshbutton-blue");ft.prop("disabled",true);return new Ajax.DBRequest("/team/events_report/csv",{parameters:{from_date:fu,to_date:i,team_id:fs,user_id:j,tzoffset:T},onSuccess:function(fw){return ah.success(eG("Report started. We'll email you when it's ready."))},cleanUp:function(){fh.hide();return ft.prop("disabled",false)}})},show_reset_password_modal:function(j,T,i){var fr;bF("#reset-password-modal .member-name").text(T);fr=eG("Reset password for '%(user_name)s'").format({user_name:T});return fh.show(fr,$("reset-password-modal"),{user_id:i,button:j})},reset_password:function(j){var i;Event.stop(j);i=fh.vars.user_id;return new Ajax.DBRequest("/account/team/reset_password",{parameters:{team_id:this.team_id,user_id:i},onSuccess:function(T){return ah.success(eG("User's password reset."))},cleanUp:function(){return fh.hide()}})},show_reset_all_passwords_modal:function(){return fh.show(eG("Reset all passwords"),$("reset-all-passwords-modal"))},set_async_password_reset:function(i){return this._use_async_reset=i},reset_all_passwords:function(){return new Ajax.DBRequest("/account/team/reset_all_passwords",{parameters:{team_id:this.team_id},job:this._use_async_reset,subject_user:cQ.get_viewer().work_user,progress_text:eG("Resetting all passwords..."),onSuccess:function(i){return ah.success(eG("All passwords reset."))},cleanUp:function(){return fh.hide()}})},show_admin_status_modal:function(T,fv,fx,fs,fw,ft){var j,i,fr,fu;i=fw.strip()||fs;fr=void 0;j=void 0;fu=void 0;if(ft){fu=eG("Add admin permissions for '%(person_name)s'").format({person_name:i.escapeHTML()});fr=eG("Are you sure you want to add admin permissions for <strong>%(person_name)s</strong>?").format({person_name:i.escapeHTML()});j=eG("Add admin permissions",{comment:"make this user an admin; give them the permissions an admin has"})}else{fu=eG("Remove admin privileges from '%(person_name)s'").format({person_name:i.escapeHTML()});fr=eG("Are you sure you want to remove admin permissions from <strong>%(person_name)s</strong>?").format({person_name:i.escapeHTML()});j=eG("Remove admin permissions",{comment:"clicking this button completes the action: it removes a person's admin status"})}dB.fillVal(fs,"admin-status-email");dB.fillVal(fr,"admin-status-action");dB.fillVal(j,"admin-status-button-action");fh.show(fu,$("admin-status-modal"),{user_id:fx,button:T,admin_on:ft});return false},set_admin_status:function(j){var i;Event.stop(j);i=fh.vars.user_id;return new Ajax.DBRequest("/account/team/set_admin_status",{parameters:{team_id:this.team_id,user_id:i,on:(fh.vars.admin_on?"yes":"no")},onSuccess:function(fr){var fs,T;fs=(fh.vars.admin_on?eG("User's admin status granted."):eG("User's admin status removed."));if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){return __CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){T=JSON.parse(fr.responseText);window.active_team_member_table.update_user_data(T);return ah.success(fs)}else{if(fh.vars.admin_on){return window.location="/team/admin/member?id=%d&msg=granted".format(fh.vars.user_id)}else{return window.location="/team/admin/member?id=%d&msg=removed".format(fh.vars.user_id)}}}},cleanUp:function(){return fh.hide()}})},show_disable_2fa_modal:function(T,i,j){bF("#disable-2fa-modal .member-name").text(j);return fh.show(eG("Disable two-step verification"),$("disable-2fa-modal"),{user_id:i,elm:T})},show_reset_2fa_modal:function(T,i,j){bF("#reset-2fa-modal .member-name").text(j);return fh.show(eG("Reset two-step verification"),$("reset-2fa-modal"),{user_id:i,user_name:j,elm:T})},reset_2fa:function(){return new Ajax.DBRequest("/account/team/reset_2fa",{parameters:{team_id:this.team_id,user_id:fh.vars.user_id},onSuccess:function(j){var i;bF(".tfa_enabled").replaceWith(eG("Disabled"));i=JSON.parse(j.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){window.active_team_member_table.update_user_data(i)}else{if(__CIRCULAR_DEPENDENCY__.MemberActionsMenu){__CIRCULAR_DEPENDENCY__.MemberActionsMenu.update_container_users(".buttons",i)}}}ah.success(eG("Two-step verification reset for %(user_name)s").format({user_name:fh.vars.user_name}));return fh.hide()}})},disable_2fa:function(){return new Ajax.DBRequest("/account/team/disable_2fa",{parameters:{team_id:this.team_id,user_id:fh.vars.user_id},onSuccess:function(j){var i;bF(".tfa_enabled").replaceWith(eG("Disabled"));i=JSON.parse(j.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){window.active_team_member_table.update_user_data(i)}else{if(__CIRCULAR_DEPENDENCY__.MemberActionsMenu){__CIRCULAR_DEPENDENCY__.MemberActionsMenu.update_container_users(".buttons",i)}}}ah.success(eG("Two-step verification disabled."));return fh.hide()}})},show_sso_preview_email:function(i){return fh.show(eG("Email preview"),$(i))},show_sso_sample_email:function(i){return fh.show(eG("Sample email"),$(i))},show_user_message_modal:function(T,j,i){var fr;dB.fillVal(i,"user-message-email");fr=eG("Send email to '%(user_name)s'").format({user_name:T});$("user-message").value="";fh.show(fr,$("user-message-modal"),{user_name:T,user_id:j});return ec.focus.defer("user-message")},send_user_message:function(){var j,i;i=fh.vars.user_id;j=$F("user-message").strip();return new Ajax.DBRequest("/account/team/send_user_message",{parameters:{user_id:i,team_id:this.team_id,message:j},onSuccess:function(){var T;T=fh.vars.user_name;ah.success(eG("Message successfully sent to %(user_name)s.").format({user_name:T}));return fh.hide()}})},hide_team_name_change_banner:function(){new Ajax.DBRequest("/account/team/name_change_notice_received",{parameters:{team_id:this.team_id}});bF(".team_name_change_notice").hide();return false},hide_pin_banner:function(){new Ajax.DBRequest("/team/invalidate_pin");return bF(".pin_notice").hide()},hide_pin_banner_with_user_id:function(i,j){var T;T=function(fr){return bF(j).closest("span").removeClass("on").addClass("off")};if(i===null){return new Ajax.DBRequest("/team/invalidate_pin",{onSuccess:T})}else{return new Ajax.DBRequest("/team/invalidate_pin",{parameters:{user_id:i},onSuccess:T})}},get_pin_with_user_id:function(i,T,j){var fr;if(j==null){j=null}if(j===null){j=function(ft,fs){bF(fs).closest("span").find(".pin-value").text(ft.pin+" -");return bF(fs).closest("span").removeClass("off").addClass("on")}}fr=function(ft){var fs;fs=JSON.parse(ft.responseText);return j(fs,T)};if(i===null){return new Ajax.DBRequest("/team/generate_pin",{onSuccess:fr})}else{return new Ajax.DBRequest("/team/generate_pin",{parameters:{user_id:i},onSuccess:fr})}},send_team_message:function(j){var i;Event.stop(j);i=$F("team-message").strip();if(i){return new Ajax.DBRequest("/account/team/send_team_message",{parameters:{team_id:this.team_id,message:i},onSuccess:function(T){ah.success(eG("Message successfully sent to team."));return fh.hide()}})}},show_security_message_modal:function(){return new fg().show()},send_team_security_message:function(T){var j,i;Event.stop(T);i=$F("team-security-message").strip();j=$("team-security-message-form");return new Ajax.DBRequest("/account/team/send_team_message",{parameters:j.serialize(true),onSuccess:function(fr){ah.success(eG("Message successfully sent."));return fh.hide()}})},used_licenses:0,total_licenses:0,set_used_licenses:function(i,j){this.used_licenses=i;return this.total_licenses=j},decrement_used_licenses:function(){return this.set_used_licenses(this.used_licenses-1,this.total_licenses)},show_migration_link:function(i,j){$("migration-url").value=j;fh.show(eG("Migration link for '%(email)s'").format({email:bU.em_snippet(i,18)}),$("migrate-url-modal"));return $("migration-url").select()},show_end_session_modal:function(j,i,T){bo.hide_all();bF("#end-session-modal .member-name").text(bF("#member-name").text());return fh.show(eG("Close web session",{comment:"Log out of your current Dropbox web session"}),$("end-session-modal"),{login_id:j,user_id:i,elm:T})},end_session:function(){return new Ajax.DBRequest("/logout_remote_session",{parameters:{remote_login_id:fh.vars.login_id,team_id:this.team_id,user_id:fh.vars.user_id},onSuccess:function(){fh.hide();d0.remove_closest_row(fh.vars.elm);return ah.success(eG("Web session closed."))}})},unlink_device:function(i,fr,fv,j,fw,T,fs){var fu,ft;bo.hide_all();fu=$("unlink-device-modal-"+T);ft=eG("Unlink %(device_name)s").format({device_name:fv});return fh.show(ft,fu,{app_id:fr,user_id:fw,elm:fs,device_id:i,display_name:fv})},unlink_device_submit:function(){return new Ajax.DBRequest("/account/unlink_team_device",{parameters:{app_id:fh.vars.app_id,team_id:this.team_id,user_id:fh.vars.user_id,device_id:JSON.stringify(fh.vars.device_id)},subject_user:cQ.get_viewer().work_user,onSuccess:function(){fh.hide();d0.remove_closest_row(fh.vars.elm);return ah.success(eG("%(device_name)s unlinked.").format({device_name:fh.vars.display_name}))}})},disable_app:function(j,T,i,fr){bo.hide_all();bF("#disable-app-modal .app-name").text(T);bF("#disable-app-modal .member-name").text(bF("#member-name").text());return fh.show(eG("Disable '%(app_name)s'?").format({app_name:T}),$("disable-app-modal"),{app_id:j,user_id:i,elm:fr})},disable_app_submit:function(){return new Ajax.DBRequest("/api/uninstall_app",{parameters:{app_id:fh.vars.app_id,keep_sandbox_files:true,team_id:this.team_id,user_id:fh.vars.user_id},subject_user:cQ.get_viewer().work_user,onSuccess:function(i){fh.hide();d0.remove_closest_row(fh.vars.elm);return ah.success(i.responseText)}})},remove_closest_row:function(fr){var T,j,i;T=bF(fr).closest(".team_admin_table_row");j=bF(T).closest(".team_admin_table");if(j.find(".team_admin_table_row").length===1){i=j.prev(".team_admin_table_title");if(!i.length){i=bF(".team_apps_table_panel")}i.remove();return j.remove()}else{return T.remove()}},submit_report_form:function(i){bF(i.target.elements.tzoffset).val(""+new Date().getTimezoneOffset());return true}};aw=F.BetaEnrollConfirmationModal=(function(j){fi(i,j);function i(T){this.feature_name=T;this.on_confirm_button_click=b3(this.on_confirm_button_click,this);i.__super__.constructor.call(this,{element_id:"beta-enroll-confirmation-modal"})}i.prototype.on_confirm_button_click=function(T){bF("<input>").attr({type:"hidden",name:"feature_name",value:this.feature_name}).appendTo("#beta-enroll-confirmation-modal form");return this.$modal_window.addClass("ajax-loading")};return i})(ed);aB=F.BetaFeedbackModal=(function(j){fi(i,j);function i(T){this.feature_name=T;this.success=b3(this.success,this);i.__super__.constructor.call(this,{element_id:"beta-feedback-modal"});this.on_confirm_button_click=(function(fr){return function(fv){var fu,ft,fs;fv.preventDefault();fu=bF(fv.target);ft=fu.closest("form");fs={feature_name:fr.feature_name};return bT.ajax_submit(ft[0],false,fr.success,fr.error,fu[0],fs)}})(this)}i.prototype.success=function(T){ah.success(eG("Thank you for your feedback."));return this.$modal_window.hide()};i.prototype.error=function(T){if(T.status!==200){return ah.error(eG("Failed to submit feedback. Please try again."))}};return i})(ed);V=F.DemoSignupModal=(function(i){fi(j,i);function j(){this.on_show=b3(this.on_show,this);this.on_confirm_button_click=b3(this.on_confirm_button_click,this);return j.__super__.constructor.apply(this,arguments)}j.prototype.on_confirm_button_click=function(fu){var fC,fz,fv,T,fx,fs,fB,fA,fr,fy,fw,ft;fu.preventDefault();fw=$("demo-signup-form");fA=$("1210");fs=bF(fw).find("input[name='first_name']").val();bF(fA).find("input[name='FirstName']").attr("value",fs);fB=bF(fw).find("input[name='last_name']").val();bF(fA).find("input[name='LastName']").attr("value",fB);fx=bF(fw).find("input[name='email']").val();bF(fA).find("input[name='Email']").attr("value",fx);fy=bF(fw).find("input[name='phone_number']").val();bF(fA).find("input[name='Phone']").attr("value",fy);fC=bF(fw).find("input[name='company_name']").val();bF(fA).find("input[name='Company']").attr("value",fC);fv=bF(fw).find("select[name='company_size']");fz=fv.find("option:selected").val();bF(fA).find("input[name='Company_size__c']").attr("value",fz);T=$(this.$modal_window.find(".confirm-button")[0]);ft=(function(fD){return function(fE){fD.$modal_window.hide();return fA.submit()}})(this);fr=bT.collect_form_vars(fw,true);return bT.ajax_submit(fw,false,ft,false,T,fr,true)};j.prototype.on_show=function(T){this.$modal_window.find(".db-modal-content").css({"overflow-y":""});return ck.init()};return j})(ed);bJ=F.AccountTransferBaseModal=(function(j){fi(i,j);function i(T,fs,fr){this.file_action_selector=fs;this.transfer_choice_selector=fr;this._clearInput=b3(this._clearInput,this);this._markInputInvalid=b3(this._markInputInvalid,this);this._markInputValid=b3(this._markInputValid,this);this._tokenRemove=b3(this._tokenRemove,this);this._tokenAdd=b3(this._tokenAdd,this);this._selectChange=b3(this._selectChange,this);this._isTransferSelected=b3(this._isTransferSelected,this);this.checkAndApproveMemberRemoval=b3(this.checkAndApproveMemberRemoval,this);this.on_cancel_button_click=b3(this.on_cancel_button_click,this);this.execute_form=b3(this.execute_form,this);this.get_cancel_button=b3(this.get_cancel_button,this);this.get_confirm_button=b3(this.get_confirm_button,this);this.get_button_class=b3(this.get_button_class,this);this.set_modal_class=b3(this.set_modal_class,this);this.handleAjaxFailure=b3(this.handleAjaxFailure,this);this.on_show=b3(this.on_show,this);i.__super__.constructor.call(this,T,this.file_action_selector,this.transfer_choice_selector)}i.prototype.on_show=function(){if(this.$modal_window.find("#manage-files-new-collab-input").length===0){return}this.auto_completer=new Autocompleter.TeamTokenizer(cQ.get_viewer().get_user_by_role(Constants.ROLE_WORK),"manage-files-new-collab-input","manage-files-new-whobulk","manage-files-hidden-input",{hide_import_contacts:true,suggestions_disabled:true,wrap_name:true,single_token:true,contact_filter:(function(T){return function(fr){return fr.excludeNonTeam().excludeNewStyleGroups().excludeByEmail(T.email?[T.email.toLowerCase()]:[])}})(this),exclude_emails:[this.email]});this.tokenAdd=bF.proxy(this._tokenAdd,this);this.tokenRemove=bF.proxy(this._tokenRemove,this);this.$collab_input=this.$modal_window.find("#manage-files-new-collab-input")[0];this.$collab_input.on("token:add",this.tokenAdd);this.$collab_input.on("token:remove",this.tokenRemove);this.$textinput=this.$modal_window.find(".tokenized_autocompleter_container .textinput");this.selectChange=bF.proxy(this._selectChange,this);return this.$modal_window.find(this.file_action_selector).on("change",this.selectChange)};i.prototype.handleAjaxFailure=function(T){if(T.status===200&&this._isTransferSelected()){return this._markInputInvalid()}};i.prototype.set_modal_class=function(ft){var fr,T,fs;fr="suspending deleting approve_transfer_to_suspended";T=this.get_form();T.removeClass(fr);if(ft!=null){T.addClass(ft)}if((fs=bF(".suspend_option_content"))!=null){fs.removeClass("title_bubble limited")}if((this.limited!=null)&&this.limited){bF(".suspend_option_content").addClass("title_bubble limited");return bF(".suspend_option_content").attr("data-title","Limited members can not be suspended")}};i.prototype.get_button_class=function(){var T;T=this.get_form();if(T.hasClass("suspending")){return".confirm_deactivate_button"}else{if(T.hasClass("deleting")){return".confirm_delete_button"}else{if(T.hasClass("approve_transfer_to_suspended")){return".confirm_transfer_to_suspended_button"}}}};i.prototype.get_confirm_button=function(){var T;T=this.get_button_class();if(T!=null){return $(this.$modal_window.find(T+" .confirm-button"))}else{return $(this.$modal_window.find(".confirm-button"))}};i.prototype.get_cancel_button=function(){var T;T=this.get_button_class();if(T!=null){return $(this.$modal_window.find(T+" .cancel-button"))}else{return $(this.$modal_window.find(".cancel-button"))}};i.prototype.execute_form=function(){var T,fr;fr=this.get_form()[0];T=this.get_confirm_button();return bT.ajax_submit(fr,false,this.success_callback,this.handleAjaxFailure,T)};i.prototype.on_cancel_button_click=function(fr){var T;fr.preventDefault();T=this.get_form();if(T.hasClass("approve_transfer_to_suspended")){this.reset_button_click(this.$confirm_button,this.on_confirm_button_click);return this.reset_button_click(this.$cancel_button,this.on_cancel_button_click)}else{return i.__super__.on_cancel_button_click.apply(this,arguments)}};i.prototype.reset_button_click=function(T,fr){T.off("click");if(fr!=null){return T.on("click",fr)}};i.prototype.checkAndApproveMemberRemoval=function(fs){var T,fr;if(!bF("#deactivate_option").is(":checked")&&bF("#transfer_files_on").is(":checked")&&!this.invited){T=bF(".tokenized_autocompleter_container .token-display-text");fr=bF(".tokenized_autocompleter_container .token-suspended");if(T.length&&fr.length){this.set_modal_class("approve_transfer_to_suspended");this.$modal_window.find(".target_user_name").text(T.text());this.$confirm_button=this.get_confirm_button();this.reset_button_click(this.$confirm_button,(function(ft){return function(fu){return ft.execute_form()}})(this));this.$cancel_button=this.get_cancel_button();this.$cancel_button.on("click",fs);return}}return this.execute_form()};i.prototype._isTransferSelected=function(){return bF(this.transfer_choice_selector).prop("checked")};i.prototype._selectChange=function(T){if(this._isTransferSelected()){return this.$textinput.removeClass("unselected")}else{return this.$textinput.addClass("unselected")}};i.prototype._tokenAdd=function(T){this.$collab_input.hide();if(T.memo.valid){return this._markInputValid()}else{return this._markInputInvalid()}};i.prototype._tokenRemove=function(T){this.$collab_input.show();return this._clearInput()};i.prototype._markInputValid=function(){this._clearInput();return this.$textinput.addClass("valid")};i.prototype._markInputInvalid=function(){this._clearInput();return this.$textinput.addClass("invalid")};i.prototype._clearInput=function(){this.$textinput.removeClass("valid");return this.$textinput.removeClass("invalid")};return i})(ed);fg=F.TwoFactorMessageModal=(function(j){fi(i,j);function i(){i.__super__.constructor.call(this,{element_id:"team-security-message-modal",focus:"#team-security-message"})}i.prototype.on_confirm_button_click=function(T){d0.send_team_security_message(T);return this.hide()};return i})(ed);bu=F.DfeUnsuspendUserModal=(function(i){fi(j,i);function j(T){this.on_confirm_button_click=b3(this.on_confirm_button_click,this);this.success_callback=b3(this.success_callback,this);j.__super__.constructor.call(this,T)}j.prototype.before_show=function(){var T;j.__super__.before_show.call(this);T=eG("Unsuspend %(user_name)s").format({user_name:this.user_name});this.$modal_window.find(".db-modal-title-text").text(T);this.$modal_window.find("[name=user_id]").attr("value",this.user_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);this.$modal_window.find("[name=email]").attr("value",this.email);this.$modal_window.find(".unsuspended_name").text(this.user_name);return this.$modal_window.find(".unsuspended_email").text(this.email)};j.prototype.success_callback=function(fr){var T;if((T=__CIRCULAR_DEPENDENCY__.MembersReact)!=null){T.refresh_member_stats()}this.hide();return typeof this.refresh_cb==="function"?this.refresh_cb("unsuspended"):void 0};j.prototype.on_confirm_button_click=function(fs){var T,fr;fs.preventDefault();fr=this.$modal_window.find(".dfe-unsuspend-modal")[0];T=$(this.$modal_window.find(".confirm-button")[0]);return bT.ajax_submit(fr,false,this.success_callback,false,T)};return j})(ed);el=F.DfeRemoveOrDeactivateUserModal=(function(j){fi(i,j);function i(T){this.on_confirm_button_click=b3(this.on_confirm_button_click,this);this.success_callback=b3(this.success_callback,this);this.on_show=b3(this.on_show,this);this.handle_change_action=b3(this.handle_change_action,this);this.switch_to_uninvite_mode=b3(this.switch_to_uninvite_mode,this);this.switch_to_removal_mode=b3(this.switch_to_removal_mode,this);this.switch_to_deactivation_mode=b3(this.switch_to_deactivation_mode,this);this.show_removal_content=b3(this.show_removal_content,this);this.show_deactivation_content=b3(this.show_deactivation_content,this);i.__super__.constructor.call(this,T,"input[name=transfer_files]","#transfer_files_on")}i.prototype.get_form=function(){return this.$modal_window.find(".dfe-remove-or-deactivate-user-modal")};i.prototype.set_form_action_to_deactivate=function(){return bF(".dfe-remove-or-deactivate-user-modal").attr("action","/account/team/suspend_user")};i.prototype.set_form_action_to_remove=function(){return bF(".dfe-remove-or-deactivate-user-modal").attr("action","/account/team/remove_user")};i.prototype.show_deactivation_content=function(){return this.set_modal_class("suspending")};i.prototype.show_removal_content=function(){return this.set_modal_class("deleting")};i.prototype.switch_to_deactivation_mode=function(){this.show_deactivation_content();return this.set_form_action_to_deactivate()};i.prototype.switch_to_removal_mode=function(){this.show_removal_content();return this.set_form_action_to_remove()};i.prototype.switch_to_uninvite_mode=function(){this.set_form_action_to_remove();this.set_modal_class("invited");this.$modal_window.find(".transfer_data_on_remove_setting").remove();return this.$modal_window.find(".remote_wipe_setting").remove()};i.prototype.handle_change_action=function(T){T.preventDefault();if(bF("#deactivate_option").is(":checked")){return this.switch_to_deactivation_mode()}else{return this.switch_to_removal_mode()}};i.prototype.on_show=function(T){var fr;i.__super__.on_show.call(this);bF("input[name=deactivate_or_remove]").on("change",this.handle_change_action);this.$modal_window.find(".deleted_user_name").text(this.user_name);if(this.invited){fr=eG("Uninvite %(user_name)s").format({user_name:this.user_name});this.switch_to_uninvite_mode()}else{fr=eG("Suspend or delete %(user_name)s").format({user_name:this.user_name});if(this.limited){bF("#deactivate_option").prop("disabled",true);bF("#delete_option").attr("checked","checked");this.switch_to_removal_mode()}else{bF("#deactivate_option").attr("checked","checked");this.switch_to_deactivation_mode()}}this.$modal_window.find(".db-modal-title-text").text(fr);this.$modal_window.find("[name=user_id]").attr("value",this.user_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);if(this.hide_transfer_wipe){this.$modal_window.find(".transfer_data_on_remove_setting").remove();return this.$modal_window.find(".remote_wipe_setting").remove()}};i.prototype.success_callback=function(T){var fr;if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}fr="";if(this.invited){fr="uninvited"}else{if(bF("#deactivate_option").is(":checked")){fr="suspended"}else{fr="deleted"}}this.hide();return typeof this.refresh_cb==="function"?this.refresh_cb(fr):void 0};i.prototype.on_confirm_button_click=function(T){T.preventDefault();return this.checkAndApproveMemberRemoval(this.switch_to_removal_mode)};return i})(bJ);e5=F.DfeRemoveUserModal=(function(i){fi(j,i);function j(T){this.on_confirm_button_click=b3(this.on_confirm_button_click,this);this.switch_to_removal_mode=b3(this.switch_to_removal_mode,this);this.success_callback=b3(this.success_callback,this);this.on_show=b3(this.on_show,this);j.__super__.constructor.call(this,T,"input[name=transfer_files]","#transfer_files_on")}j.prototype.get_form=function(){return this.$modal_window.find(".dfe-remove-user-modal")};j.prototype.on_show=function(fr){var T,fs;j.__super__.on_show.call(this);this.$modal_window.find(".remove_user_name").text(this.user_name);if(this.invited){fs=eG("Uninvite %(user_name)s").format({user_name:this.user_name})}else{fs=eG("Delete %(user_name)s").format({user_name:this.user_name})}this.$modal_window.find(".db-modal-title-text").text(fs);if(this.num_api_apps){T=bd("%(num)s API app","%(num)s API apps",this.num_api_apps).format({num:this.num_api_apps});this.$modal_window.find(".num_api_app").text(T)}else{this.$modal_window.find(".api_app_warning").hide()}this.$modal_window.find("[name=user_id]").attr("value",this.user_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);if(this.user_is_managed){this.$modal_window.find(".remove-content-limited-member").remove()}else{this.$modal_window.find(".remove_content").remove();this.$modal_window.find(".remote_wipe_setting").remove()}if(this.invited){this.$modal_window.find(".transfer_files_option").remove();this.$modal_window.find(".remote_wipe_setting").remove();this.get_form().addClass("invited")}if(this.hide_transfer_setting){this.$modal_window.find(".transfer_files_option").remove()}if(this.hide_remote_wipe_setting){return this.$modal_window.find(".remote_wipe_setting").remove()}};j.prototype.success_callback=function(ft){var fu,fs,fr,T;T=JSON.parse(ft.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if((fs=window.active_team_member_table)!=null){fs.remove_user(this.user_id)}if((fr=window.removed_team_member_table)!=null){fr.add_users(T)}}fu="";if(this.invited){fu="uninvited"}else{fu="deleted"}d0.decrement_used_licenses();this.hide();return typeof this.refresh_cb==="function"?this.refresh_cb(fu):void 0};j.prototype.switch_to_removal_mode=function(){return this.set_modal_class()};j.prototype.on_confirm_button_click=function(T){T.preventDefault();return this.checkAndApproveMemberRemoval(this.switch_to_removal_mode)};return j})(bJ);eP=F.ManageFilesModal=(function(j){fi(i,j);function i(fr,T,fs){this.source_user_id=fr;this.source_user_name=T;this.options=fs;this.on_confirm_button_click=b3(this.on_confirm_button_click,this);this.switch_to_manage_files=b3(this.switch_to_manage_files,this);this.success_callback=b3(this.success_callback,this);i.__super__.constructor.call(this,this.options,"input[name=file_action]","#transfer_files_on")}i.prototype.get_form=function(){return this.$modal_window.find(".manage-files-modal")};i.prototype.on_show=function(){var T;i.__super__.on_show.call(this);this.$modal_window.find("[name='source_user_id']").attr("value",this.source_user_id);this.$modal_window.find(".source-user-name").text(this.source_user_name);T=eG("Manage %(team_member)s's files").format({team_member:this.source_user_name});return this.$modal_window.find(".db-modal-title-text").text(T)};i.prototype.success_callback=function(fr){var T;T=JSON.parse(fr.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.removed_team_member_table){window.removed_team_member_table.update_user_data(T)}else{if(__CIRCULAR_DEPENDENCY__.MemberActionsMenu!=null){__CIRCULAR_DEPENDENCY__.MemberActionsMenu.update_container_users(".buttons",T)}}}if(bF("#transfer_files_on").prop("checked")){ah.success(eG("Transfer started",{comment:"This refers to the start of a file transfer from one Dropbox to another"}))}else{ah.success(eG("Permanently deleted files"))}return this.hide()};i.prototype.switch_to_manage_files=function(){return this.set_modal_class("manage-files-modal")};i.prototype.on_confirm_button_click=function(T){T.preventDefault();return this.checkAndApproveMemberRemoval(this.switch_to_manage_files)};return i})(bJ);ct=F.show_manage_files_modal=function(i,j){var T;T=new eP(i,j,{element_id:"manage-files-modal",focus:".new-collab-input"});return T.show()};p=function(){var i;i=function(fr,T){var j,fs;bF(T).css("display","none");j=bF(T).closest("#user_generate_liveops_pin");fs=j.find(".user_generate_liveops_pin_value");fs.text(fr.pin);bF(T).addClass("liveops_pin_elem_invisible");return j.find(".user_generate_liveops_pin_text").removeClass("liveops_pin_elem_invisible")};d0.get_pin_with_user_id(null,this,i);return false};bF("#user_generate_liveops_pin_button").click(p);bh=function(){bF("#help_callus_title").hide();bF("#help_callus_details").show();return false};bF("#help_callus_trigger").click(bh);var bE;bE=F.UpdateEvents={ADD:"db:add_file_objects",REMOVE:"db:remove_file_objects",MOVE:"db:move_file_objects"};var a5;a5=F.BrowseUtil={THUMBS_BATCH_SIZE:16,make_browsefile:function(j,T){var i;if(T==null){T=null}i=Object.clone(j);if(i.is_dir){i.ago="";i.ts=0}else{i.target_ns=false}i.sort_key=ec.decode_sort_key(i.sort_key);i.request_id=T!=null?T:null;return new cW(i)},filepreview_from_selected:function(fu,ft,fs,fr){var i,T,fv,j;if(ft==null){ft=false}if(fs==null){fs=false}if(fr==null){fr=Constants.BROWSE_UNKNOWN}if(fu.bytes<0||fu.preview_type==="download"){window.open(fu.href,"_blank");return}if(az.getGandalfRule("file-viewer-react")){T=this.getIndexOfFileInArray(cu.files,fu);e6.open(cu.files,T,cu.active_user,"react-file-viewer",{fileViewMode:aX.FileViewModeType.BROWSE,fileViewTarget:aX.FileViewTargetType.PRIVATE,shouldFocusCommentInput:fs})}else{j=eJ.get_url();fv=eJ.deconstruct_url(j);i=j.indexOf("/s/")===0;n.show(fu,cu.active_user,{files:cu.files,file_view_mode:aX.FileViewModeType.BROWSE,should_focus_comment_input:fs},fr);if(!(ft||i||fv.qargs.preview===fu.filename)){n.set_preview_url()}}},profile_files:function(T){var fr,j,i,fs,ft;fs={files:0,folders:0,shared_folders:0,team_shared_folders:0,deleted:0,public_folder:0,rejoinables:0,sandboxes:0,target_namespaces:0,in_root_coll:0,compressible_count:0,can_permanently_delete:0};for(j=0,i=T.length;j<i;j++){fr=T[j];if(fr.dir){fs.folders+=1}else{fs.files+=1}if(fr.is_sandbox()){fs.sandboxes+=1}if(fr.is_shared_folder()){fs.shared_folders+=1}if(fr.is_team_shared_folder()){fs.team_shared_folders+=1}if(fr.bytes===-1){fs.deleted+=1}if(fr.target_ns){fs.target_namespaces+=1}if(fr.fq_path.toLowerCase()==="/public"&&cu.public_folder_enabled){fs.public_folder=1}if(fr.in_root_coll){fs.in_root_coll+=1}if(fr.compressible){fs.compressible_count+=1}if(!((ft=cu.permanent_delete_is_disabled_by_ns_id)!=null?ft[fr.ns_id]:void 0)){fs.can_permanently_delete+=1}}return fs},profile_summary:function(j){var T,i;T=bd("%d file","%d files",j.files,{comment:"used in a phrase such as 'x files and y folders'"}).format(j.files);i=bd("%d folder","%d folders",j.folders,{comment:"used in a phrase such as 'x files and y folders'"}).format(j.folders);if(j.files&&j.folders){return eG("%(x_files)s and %(y_folders)s",{comment:"x_files will either be '1 file' or 'd files', similar for x_folders"}).format({x_files:T,y_folders:i})}else{if(j.files){return T}else{if(j.folders){return i}else{return""}}}},BROWSE_MODE:"browse",SEARCH_MODE:"search",SPECIAL_MODES:["search"],set_browse_mode:function(){var fv,ft,fr,T,j,i,fu,fs;fv=bF("#browse");fr=fv.find("#browse-root-actions");T=fv.find("#browse-sort");ft=fv.find("#browse-header-status");fs=this.SPECIAL_MODES;for(j=0,i=fs.length;j<i;j++){fu=fs[j];fv.removeClass(fu);fr.removeClass(fu);T.removeClass(fu);ft.removeClass(fu)}cb.reset_fulltext_search(true);fv.removeClass("fulltext_search");fr.removeClass("fulltext_search");T.removeClass("fulltext_search");ft.removeClass("fulltext_search");bF("#fulltext-search-loading").hide();return bF("#fulltext-search-all-link").hide()},set_special_mode:function(fv){var T,fs,fw,i,fr,fu,ft,j;T=bF("#browse");fw=T.find("#browse-root-actions");i=T.find("#browse-sort");fs=T.find("#browse-header-status");cP(this.SPECIAL_MODES.indexOf(fv)!==-1,"unknown mode");j=this.SPECIAL_MODES;for(fr=0,fu=j.length;fr<fu;fr++){ft=j[fr];if(ft!==fv){T.removeClass(ft);fw.removeClass(ft);i.removeClass(ft);fs.removeClass(ft)}}T.addClass(fv);fw.addClass(fv);i.addClass(fv);fs.addClass(fv);if(fv===this.SEARCH_MODE){T.addClass("fulltext_search");fw.addClass("fulltext_search");i.addClass("fulltext_search");return fs.addClass("fulltext_search")}},get_mode:function(){var T,j,fs,fr,i;i=this.BROWSE_MODE;fr=this.SPECIAL_MODES;for(T=0,j=fr.length;T<j;T++){fs=fr[T];if(bF("#browse").hasClass(fs)){i=fs}}return i},load_visible_thumbs:function(){var fB,fD,ft,fy,fE,fF,fC,fs,fx,fv,fu,fz,fw,T,fr,fA;fs=this.get_files_in_view();fD=fs[1]-fs[0];fC=[Math.max(fs[0]-fD,0),fs[0]];fF=[Math.min(fs[1],cu.files.length),Math.min(fs[1]+fD,cu.files.length)];fB=[];fr=[fs,fF,fC];for(fv=0,fz=fr.length;fv<fz;fv++){fE=fr[fv];fy=fE[0],fx=fE[1];fA=cu.files.slice(fy,+fx+1||9000000000);for(fu=0,fw=fA.length;fu<fw;fu++){ft=fA[fu];if(ft.get_div()){fB.push(ft.get_div().down("img"))}}}T=function(i){if(!i.src.endsWith(cy.SPACER)){i.addClassName("thumbnail");return i.__sert({before:new Element("div",{"class":"thumbnail-border"})})}};return bs.batch_load_thumbs(fB,this.THUMBS_BATCH_SIZE,T)},get_files_in_view:function(){var fw,ft,fy,fu,fv,fs,T,fz,fx,fr,fA;T=[0,cu.files.length-1];fr=D.viewport_dimensions().height;fA=D.scroll_offsets().top;fs=this._get_elm_height();if(!fs){return T}fw=bF("#browse-files");fu=parseInt(fw.css("padding-top"),10);if(!fw.length||isNaN(fu)){return T}if(bF("#browse-header").css("position")==="absolute"){ft=fw.offset().top+fu;fy=ft-fA;if(fy>0){fz=0;fv=fr-fy;fx=fv/fs}else{fz=Math.abs(fy/fs);fx=Math.abs(fr-fy)/fs}}else{fz=fA/fs;fv=fr-fu;fx=(fv+fA)/fs}fz=Math.max(Math.floor(fz),0);fx=Math.min(Math.floor(fx),cu.files.length-1);return[fz,fx]},_get_elm_height:function(){var j,i;if(cu.files.length>=3&&cu.files[1].get_div()){j=bF(cu.files[1].get_div());i=j.outerHeight()+parseInt(j.css("margin-bottom"))+parseInt(j.css("margin-top"));return i}else{return null}},append_ellipsis:function(i){return eG("%(action_text)s\u2026","web","action which requires further user interaction").format({action_text:i})},getIndexOfFileInArray:function(fu,ft){var fs,fr,T,j,i;i=-1;for(fr=T=0,j=fu.length;T<j;fr=++T){fs=fu[fr];if(fs.sjid===ft.sjid){i=fr}}return i}};var bq;bq=F.Sort=(function(){var fu,i,fr,ft,fs,T,j;fr=function(fw){var fv;fv=fw?1:-1;return function(fx,fy){return fv*ec.sort_by_rank_or_key(fx,fy)}};ft=function(fw){var fv;fv=fw?1:-1;return function(fx,fy){if(fx.bytes>fy.bytes){return fv}else{if(fx.bytes<fy.bytes){return -fv}else{return fv*bq.FILES_BY_NAME(fx,fy)}}}};fu=function(fw){var fv;fv=fw?1:-1;return function(fx,fy){return fv*(fx.fq_path.toLowerCase()>fy.fq_path.toLowerCase()?1:-1)}};i=function(fw){var fv;fv=fw?1:-1;return function(fy,fz){var fx;fx=fy.ts===fz.ts?0:fy.ts>fz.ts?1:-1;return fv*fx}};T=function(fv){return function(fy){var fx,fw;fw=fv(fy);fx=fr(true);return function(fz,fA){if(fz.dir^fA.dir){return(fz.dir?1:0)-(fA.dir?1:0)}else{return fw(fz,fA)||fx(fz,fA)}}}};fs=function(fv){return function(fy){var fw,fx;if(!bq.FOLDERS_FIRST){return fv(fy)}fx=fv(fy);fw=fy?1:-1;return function(fA,fB){var fz;if(fA.dir^fB.dir){fz=(fA.dir?0:1)-(fB.dir?0:1);return fw*fz}else{return fx(fA,fB)}}}};j=function(fv){return function(fy){var fw,fx;fx=bq.FILES_BY_NAME(fy);fw=fy?1:-1;return function(fA,fB){var fz;if(fA.is_deleted^fB.is_deleted){return(fA.is_deleted?1:0)-(fB.is_deleted?1:0)}fz=0;if(fv){if(fA.get_category()!==fB.get_category()){fz=fA.get_category()<fB.get_category()?-1:1}else{if(fA.get_extension()!==fB.get_extension()){fz=fA.get_extension()<fB.get_extension()?-1:1}}}else{if(fA.get_extension()!==fB.get_extension()){fz=fA.get_extension()<fB.get_extension()?-1:1}else{if(fA.get_category()!==fB.get_category()){fz=fA.get_category()<fB.get_category()?-1:1}}}return(fw*fz)||fx(fA,fB)}}};return{FILES_BY_NAME:fs(fr),SHARED_WITH:fs(fr),FILES_BY_SIZE:T(ft),FILES_BY_LOCATION:T(fu),FILES_BY_KIND:T(j(true)),FILES_BY_EXTENSION:T(j(false)),FILES_BY_MODIFIED:T(i),FOLDERS_FIRST:!ec.is_mac(),ALL_BY_MODIFIED:i}})();var dy,cX=[].indexOf||function(fr){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fr){return T}}return -1};dy=F.FlexColumn=(function(){var fw,fu,T,fv,ft,fr,fs,j;fw=[{label:"SHARED_WITH",func:bq.FILES_BY_NAME,display:eG("Shared With"),is_asc:true},{label:"FILES_BY_KIND",func:bq.FILES_BY_KIND,display:eG("Kind"),is_asc:true},{label:"FILES_BY_EXTENSION",func:bq.FILES_BY_EXTENSION,display:eG("Extension"),is_asc:true},{label:"FILES_BY_SIZE",func:bq.FILES_BY_SIZE,display:eG("Size"),is_asc:false}];fu={};T={};ft=[];fv=[];for(fs=0,j=fw.length;fs<j;fs++){fr=fw[fs];ft.push(fr.func);fu[fr.label]=fr.display;T[fr.label]=fr.is_asc;fv.push(fr.label)}return{SORT_FUNCTIONS:ft,DISPLAY:fu,IS_ASC:T,LABELS:fv,has_label:function(i){return cX.call(this.LABELS,i)>=0},has_sort:function(i){return cX.call(this.SORT_FUNCTIONS,i)>=0},next:function(fx){var i;i=dy.LABELS.indexOf(fx)+1;if(i===dy.LABELS.length){i=0}return fw[i]}}})();var cb;cb=F.FileSearch={MAX_RESULTS:100,last_state:false,last_fq_path:null,scoped_search:true,last_new_search_ts:{},is_loaded:false,init:function(i,j){this.firefly_enabled=i;this.fulltext_search_enabled=j;bF(document).on("db:searchbar:submit",(function(T){return function(fr){if(cu.is_initialized){fr.preventDefault();bF(fr.target).blur();return T.search(true)}}})(this));return bF(document).on("db:searchbar:preview",function(T,fr){if(cu.is_initialized){T.preventDefault();return cu.open_file(fr.file,fr.force_new_window,true,Constants.OREF_CONSTANTS.BROWSE_SEARCHBOX)}})},get_state:function(){return ap.queryParams(this.get_basic_query(),this.last_fq_path)},set_state:function(i){this.last_fq_path=i.last_fq_path!=null?i.last_fq_path:"";this.scoped_search=this.last_fq_path!=="";cu.inside_dir=this.scoped_search;this.set_basic_query(i.query_unnormalized);return this.do_search(false,true)},state_changed:function(){var j,i;j=this.get_state();i=this.last_state;if(i===false){return !!j.query}return(j.query!==i.query)||(j.last_fq_path!==i.last_fq_path)},get_basic_query:function(){return this._get_browse_search_input().val()},set_basic_query:function(i){if(i===this.get_basic_query()){return}return this._get_browse_search_input().val(i)},set_title:function(){var i,j;i=this.get_state();j=eG("Search - Dropbox");if(i.query_unnormalized){j=i.query_unnormalized+" - "+j}return document.title=j},_set_scope_path_to_browse_location:function(){if(cu.inside_dir){return this.last_fq_path=cu.containing_fq_path()}else{return this.last_fq_path=""}},do_search:function(T,i){var fs,ft,fr,j;if(i==null){i=false}if(typeof cu.entered_search==="function"){cu.entered_search()}j=!i&&!cu.in_search_mode();if(j){this._set_scope_path_to_browse_location()}fr=this.get_state();ft=""===this.get_basic_query();if(ft){if(cu.in_search_mode()){this._clear_on_reload=false;this.exit_search()}return}this.last_state=fr;this._clear_on_reload=true;e2.deselect_all();cu.clear();a5.set_special_mode("search");this.scoped_search=this.last_fq_path!=="";if(!i){fs=null;eJ.push_state("/search/"+cu.active_user.role,fr)}this.set_title();this.reset_fulltext_search(this.scoped_search);this.last_new_search_ts=new Date();bF("#fulltext-search-loading").show();this.ask_server("/ajax_fulltext_search",T,0,this.MAX_RESULTS,false);return eO("search")},search:function(i){if(i==null){i=false}if(i!==this.scoped_search){this.last_state=false}this.scoped_search=this.scoped_search&&i;if(!this.scoped_search){this.last_fq_path=""}return this.do_search(false)},load_more_results:function(){var i;if(!this.end_of_results){i=this.search_pos;if(this.end_of_active_results){i=this.deleted_search_pos}return this.ask_server("/ajax_fulltext_search",false,i,this.MAX_RESULTS,this.end_of_active_results)}},firefly_filename_search:function(){return this.do_search(true)},update_empty:function(){var i;i=eG("No results found");if(this.scoped_search){i=eG("No results found in '%(path)s'").format({path:aA.filename(this.last_fq_path)})}bF("#noresults-header").text(i);bF("#fulltext-search-all-link").hide();bF("#noresults-directions").toggle(!this.scoped_search);return bF("#noresults-search-all-link").toggle(this.scoped_search)},show_empty:function(){this.update_empty();return $("search-empty").show()},hide_empty:function(){return $("search-empty").hide()},reset_fulltext_search:function(i){e2.deselect_all();cu.clear();cu.reset_state();cu.update_header_status("");this.search_pos=0;this.deleted_search_pos=0;this.end_of_active_results=false;this.end_of_results=false;this.scoped_search=i;return bF("#fulltext-search-all-link").hide()},exit_search:function(){var i;if(cu.in_search_mode()){i=[cu.inside_deleted_dir,cu.inside_deleted_sandbox,cu.inside_deleted_shared_folder];if(!bx.any(i)){cu.deleted_shown=false}}$("browse").removeClassName("pending-search");this.hide_empty();return a4.set_path_url(null,this.last_fq_path,cu.deleted_shown)},force_reload:function(){return this.search()},ask_server:function(j,fu,T,fv,fs){var ft,fy,fw,fr,fx,i;i=this.get_state();fx=null;fr=new Date();if(fs){fx=eI.DELETED}else{if(fu){fx=eI.COMPLETION}else{fx=eI.FULLTEXT}}ft={firefly:this.firefly_enabled,infinite_scroll:T>0?true:false,path_scoped:false,search_type:fx,query_string:i.query};ba.SearchClientActivityLogger.log("query_started",cu.active_user.id,ft);if(!T){bF("#web-search-results").html(eG("Searching..."))}bF("#browse").addClass("pending-search");fy={query:i.query};if(T){fy.start=T}if(fv){fy.max_results=fv}if(fs){fy.deleted=fs}if(this.scoped_search){fy.fq_path=this.last_fq_path}if(!fu){this.last_fulltext_query=i.query}if(fu){fy.filename_only=true}fw=false;return new Ajax.DBRequest(j,{no_watch:true,evalJSON:false,parameters:fy,log_timing:true,onSuccess:(function(fz){return function(fC){var fD,fA,fB,fF,fE;if(!cu.in_search_mode()){return}fF=fC.request.parameters.parent_request_id;fD=JSON.parse(fC.responseText);fE=fD.file_info.length;if(i.query===fz.last_fulltext_query&&fr>=fz.last_new_search_ts){fz.search_pos=fz.search_pos+fE;if(fz.end_of_active_results){fz.deleted_search_pos=fz.deleted_search_pos+fE}if(fE<fz.MAX_RESULTS){fz.end_of_results=true&&fz.end_of_active_results;fz.end_of_active_results=true;if(!fz.end_of_results){fw=true}else{bF("#fulltext-search-loading").hide()}}fz.update_results(fD,fw,fF)}if(fD.file_info.length>0){fA=fD.file_info[0]}else{fA=null}ft=ba.SearchClientActivityLogger.create_completion_log_dict(ft,fF,fC.request.start_time,i.query,i.query===((fB=fz.last_state)!=null?fB.query:void 0),fE,null,fA);return ba.SearchClientActivityLogger.log("query_completed",cu.active_user.id,ft)}})(this),onFailure:(function(fz){return function(fB){var fA;ft=ba.SearchClientActivityLogger.create_completion_log_dict(ft,fB.request.parameters.parent_request_id,fB.request.start_time,i.query,i.query===((fA=fz.last_state)!=null?fA.query:void 0),null,fB.status);return ba.SearchClientActivityLogger.log("query_failed",cu.active_user.id,ft)}})(this),cleanUp:(function(fz){return function(){if(fw){return fz.load_more_results()}else{return bF("#browse").removeClass("pending-search")}}})(this),subject_user:cu.active_user})},update_results:function(j,i,fr){var T;if(i==null){i=false}if(fr==null){fr=null}T=this.get_state();cu.update(j,fr);cu.set_selection_from_fq_paths_or_index(cb);if(!i){this._update_number_results(this.search_pos);if(cu.files.length){return this.hide_empty()}else{return this.show_empty()}}},_update_number_results:function(j){var i,T;if(j===0){i=""}else{if(this.end_of_results){i=this.fulltext_search_enabled?bd("%(num_results)s result in files, folders, and content.","%(num_results)s results in files, folders, and content.",j).format({num_results:j}):bd("%(num_results)s result in files and folders.","%(num_results)s results in files and folders.",j).format({num_results:j})}else{i=this.fulltext_search_enabled?bd("Over %(num_results)s result in files, folders, and content.","Over %(num_results)s results in files, folders, and content.",j).format({num_results:j}):bd("Over %(num_results)s result in files and folders.","Over %(num_results)s results in files and folders.",j).format({num_results:j})}}T=eG("Search")+" - "+i;cu.update_header_status(i);T=eG("Results for '%(query)s'").format({query:this.get_state().query});if(this.scoped_search){T=eG("Results for '%(query)s' in '%(path)s'").format({query:this.get_state().query,path:aA.filename(this.last_fq_path+"'")})}bF("#web-search-results").text(T);if(this.scoped_search){return bF("#fulltext-search-all-link").show()}},history_change_handler:function(i,fr){var fs,j,T;j=typeof this._get_browse_search_input().find("input").attr("value")==="string";T=j&&!this.is_loaded;if(fr){this.last_state=fr}if(!this.last_state){a4.set_path_url(Constants.root_ns,"");return}if(this.state_changed()||T){this.set_state(this.last_state)}if(!n.shown()){key.setScope(cu.KEY_SCOPE)}if(e2.get_selected_files().length){fs=e2.get_selected_files()[0].get_div();cu.scrollToWithPadding(fs,fs.getHeight()*2)}return this.is_loaded=true},clear_searchbox:function(){return this._get_browse_search_input().val("")},_get_browse_search_input:function(){return bF("#browse-search-input")}};var et;et=F.BrowseKeys={_handlers:{},init:function(){},init_advanced:function(){var T,i,j;j=this.advanced_dict;for(i in j){T=j[i];key(T.key,cu.KEY_SCOPE,T.onPress)}this.customize_chart();if(ec.is_mac()&&Prototype.Browser.Gecko){return document.observe("keypress",(function(fr){return function(fs){if(fs.charCode===63&&!D.focus_in_input()){return fr.advanced_dict.help.onPress()}}})(this))}},customize_chart:function(){var fs,j,fr,T;fs=(ec.is_mac()?".key-windows":".key-macos");fr=0;j=void 0;T=[];while(true){j=$("keys-chart").down(fs,fr++);if(!j){break}T.push(j.hide())}return T},toggle_chart:function(){if($("keys-chart").style.display==="none"){return this.show_chart()}else{return this.hide_chart()}},show_chart:function(){var i,j;i=$("keys-chart");i.style.position="fixed";j=$("browse-sort");if(cu.in_search_mode()){j=$("browse-header-wrapper")}else{if(j.getStyle("display")==="none"){j=$("browse-root-actions")}}bF(i).clonePosition(bF(j),{setHeight:false});i.style.top=j.cumulativeOffset()[1]+j.getHeight()+"px";i.setOpacity(0.9);return i.show()},hide_chart:function(){return $("keys-chart").hide()},advanced_dict:{rename:{title:eG("Rename selected files",{comment:"'selected' means files that have been highlighted by the user to be acted upon"}),key:"f2",onPress:function(j,T){var i;i=e2.get_selected_files();if(i.length){return i.first().edit()}}},"delete":{title:eG("Delete selected files",{comment:"'selected' means files that have been highlighted by the user to be acted upon"}),key:"delete, command+backspace, backspace",onPress:function(fr,fs){var i,T,j;Event.stop(fr);if(cu.inside_read_only_shared_folder){ah.warning(eG("You don't have permission to delete files in this folder."))}j=e2.get_selected_files();if(j.length===1){i=j.first();if(i.is_deleted){return dK.show_purge(i.fq_path,i.dir)}else{return dK.show_delete(cu.active_user,i.fq_path,i.dir)}}else{if(j.length>1){T=a5.profile_files(j);if(T.deleted===j.length){return dK.show_bulk_purge(j)}else{if(T.deleted===0){return dK.show_bulk_delete(cu.active_user,j)}}}}}},help:{title:eG("Show/hide keyboard shorcuts"),key:"shift+/, "+(key.main_modifier())+"+/",onPress:function(){return et.toggle_chart()}},close_help:{title:eG("Hide keyboard shorcuts"),key:"escape",onPress:function(){return et.hide_chart()}},up_dir:{title:eG("Up a folder",{comment:"meaning, go from the current folder to its containing (parent) folder. this is one step up only -- the parent, not the root."}),key:"left",onPress:function(){var i,j;cu.keyboard_nav=true;if(!cu.reloading){if(cu.inside_dir){if(!cu.containing_ns_path()&&cu.containing_ns_id()!==Constants.root_ns){j=Constants.root_ns;i=aA.normalize(aA.parent_dir(cu.containing_fq_path()))}else{j=cu.containing_ns_id();i=aA.normalize(aA.parent_dir(cu.containing_ns_path()))}if(cu.containing_ns_path()!==i||cu.containing_ns_id()!==j){cu.select_fq_paths=[cu.containing_fq_path()];return a4.set_path_url(j,i)}else{return e2.flicker_selected()}}else{return e2.flicker_selected()}}}},open_file:{title:eG("Open highlighted file"),key:"enter",onPress:function(){var i,j;j=e2.get_selected_files();if(j.length===1){i=j[0];cu.open_file(i,false,false,Constants.OREF_CONSTANTS.BROWSE_FILE_OPEN)}return false}},open_dir:{title:eG("Open highlighted folder"),key:"right",onPress:function(){var i,j;cu.keyboard_nav=true;j=e2.get_selected_files();if(j.length===1){i=j[0];if(i.dir){cu.select_index=0;cu.open_folder(i)}else{e2.flicker_selected()}}return false}},undo:{title:eG("Undo recent move/copy/rename/delete"),key:(key.main_modifier())+"+z",onPress:function(){Y.perform_undo();return false}},search:{title:eG("Search"),key:"/",onPress:function(){bF(document).trigger("db:searchbar:focus");return false}}}};var af;af=F.BrowseSharedLink={store_shared_link_info:function(T,i,j){if(T.charAt(0)==="/"){T=T.substring(1)}this._shared_link_fq_dir=T;this._shared_link_file=j;return this._shared_link_url=i},shared_link_handler:function(i,j){if(af._shared_link_url==="/s/"+i||(af._shared_link_url==="/scl/"+i&&i.indexOf("fi")===0)){a4.load_browse_view(void 0,encodeURIComponent(af._shared_link_fq_dir));cu.open_preview(af._shared_link_file)}else{if(af._shared_link_url==="/sh/"+i||(af._shared_link_url==="/scl/"+i&&i.indexOf("fo")===0)){a4.load_browse_view(void 0,encodeURIComponent(af._shared_link_fq_dir));if(af._shared_link_file){cu.open_preview(af._shared_link_file)}}else{location.reload()}}return af.highlight_user()},close_shared_link_view:function(){if(window.location.pathname===this._shared_link_url){return a4.set_path_url(null,"/"+this._shared_link_fq_dir)}},highlight_user:function(){if(cu.active_user.role===Constants.ROLE_WORK){bF("#work-nav-item").addClass("selected");return bF("#personal-nav-item").removeClass("selected")}else{bF("#personal-nav-item").addClass("selected");return bF("#work-nav-item").removeClass("selected")}}};var a4;a4=F.BrowseURL={_DEFAULTS:{d:false,select:false,open_preview:false},_get_helper:function(i){var j;j=eJ.deconstruct_url().qargs;if(i in j){return !!j[i]}else{cP(i in this._DEFAULTS,"bad query param in BrowseURL");return this._DEFAULTS[i]}},get_del:function(){return this._get_helper("d")},ns_to_fq_path:function(i,T){var j;if(i!==cu.active_user.root_ns&&(!(i in cu.ns_id_to_mount_point))){i=cu.active_user.root_ns}if(i===cu.active_user.root_ns){return T}else{j=cu.ns_id_to_mount_point[i];return j+T}},_make_url:function(i,ft,fu){var fv,fs,j,fr,T;if(fu==null){fu={}}if(!i){i=cu.active_user.root_ns}cP(typeof i==="number","expected ns_id as a number");cP(typeof ft==="string","expected explicit ns_path string");fv=this.ns_to_fq_path(i,ft);fr=H({path:fo.get_browse_root(cu.active_user)+fv});j=eJ.deconstruct_url().qargs;for(fs in fu){T=fu[fs];if(fs in this._DEFAULTS&&!!T!==this._DEFAULTS[fs]){j[fs]=T}}for(fs in j){if(!(fs in this._DEFAULTS)){delete j[fs]}}return eJ.construct_url(String(fr),j)},set_path_url:function(i,ft,fr){var fs,T,j;if(!i){i=cu.active_user.root_ns}else{T=parseInt(i,10);i=!isNaN(T)?T:Constants.root_ns}ft=aA.normalize(ft);j=fr!=null?this._make_url(i,ft,{d:fr?1:0}):this._make_url(i,ft);fs=eJ.deconstruct_url(j);return eJ.push_state(fs.path,fs.qargs)},set_del_url:function(i){var T,fr,j;j=eJ.deconstruct_url();T=j.path;fr=j.qargs;if(i){fr.d="1"}else{delete fr.d}return eJ.push_state(T,fr)},_first_load:true,_last_ns_dir:null,_last_ns_id:null,load_browse_view:function(i,fr,j){var fs,ft,T;if(j==null){j=false}key.setScope(cu.KEY_SCOPE);fr=aA.normalize(fr);T=false;if(!this._first_load){T=(!cu.inside_dir)||(fr!==this._last_ns_dir)||(i!==this._last_ns_id)||cu.in_search_mode()}fs=j!==cu.deleted_shown;cu.deleted_shown=j;if(this._first_load||T||fs){cu.reload(i,fr,true)}this._first_load=false;this._last_ns_dir=fr;this._last_ns_id=i;if(e2.get_selected_files().length){ft=e2.get_selected_files()[0].get_div();if(ft){return cu.scrollToWithPadding(ft,ft.getHeight()*2)}}},history_change_handler:function(ft,fu){var fr,fs,T,i,j;i=fu.ns;j=fu.d==="1";this.load_browse_view(i,ft,j);if(fu.preview!=null){fs="/"+H.encode(fu.preview);if(!!ft){fs="/"+ft+fs}fr=cu.find_file(H.decode(fs));if(fr!=null){if(az.getGandalfRule("file-viewer-react")){T=a5.getIndexOfFileInArray(cu.files,fr);return e6.open(cu.files,T,cu.active_user,"react-file-viewer",{fileViewMode:aX.FileViewModeType.BROWSE,fileViewTarget:aX.FileViewTargetType.PRIVATE})}else{if(!(n.shown()&&n.file===fr)){return cu.open_preview(fr,Constants.OREF_CONSTANTS.BROWSE_UNKNOWN,true)}}}else{ba.UserActivityLogger.log("web","browse_preview_does_not_exist");return eJ.replace_state(fo.get_browse_root(cu.active_user))}}else{if(!az.getGandalfRule("file-viewer-react")&&n.shown()){return n.hide()}else{if(az.getGandalfRule("file-viewer-react")&&e6.isShown()){return e6.close()}}}},parse_b2_hash:function(fs){var T,j,fr,i,ft;i=fs.split(":");if(i.length!==4){return false}fr=i[0];T=i[2]==="1";j=i[3];ft=!j||ec.isNumber(j);if(!ft){return false}j=parseInt(j,10)||Constants.root_ns;return{ns_id:j,ns_path:fr,deleted:T}}};var cW;cW=F.BrowseFile=Class.create({initialize:function(fr){var T,fs,j,i;T=aA.filename(fr.fq_path);this.can_hold_shared_folders=fr.can_hold_shared_folders;this.icon=fr.icon;this.filename=T;this.filename_highlights=(fs=fr.filename_highlights)!=null?fs:[];this.unresolved_comment_count=fr.unresolved_comment_count;this.unseen_comment_count=fr.unseen_comment_count;this.update_caption();this.ns_id=fr.ns_id;this.ns_path=fr.ns_path;this.fq_path=fr.fq_path;this.mount_point=fr.mount_point;this.hash=fr.hash;this.href=fr.href;this.size=fr.size!=="None"?fr.size:"";this.bytes=fr.bytes;this.is_deleted=this.bytes===-1;this.ago=fr.ago;this.ts=fr.ts;this.dir=fr.is_dir?1:0;this.target_ns=fr.target_ns;this.sort_rank=fr.sort_rank;this.sort_key=fr.sort_key||[""];this.sjid=fr.sjid;this.tkey=void 0;this.thumbnail_url_tmpl=fr.thumbnail_url_tmpl;this.large_thumbnail_url_tmpl=fr.large_thumbnail_url_tmpl;this.type=fr.type;this.preview_type=fr.preview_type;if(fr.last_modified_fname){this.last_modified_fname=bU.em_snippet(fr.last_modified_fname,cZ);this.last_modified_name=fr.last_modified_name}this.htmlified_link=fr.htmlified_link;this.linkfile_link=fr.linkfile_link;this.direct_blockserver_link=fr.direct_blockserver_link;this.doc_preview_status=fr.doc_preview_status;this.in_root_coll=fr.in_root_coll;this.compressible=fr.compressible;this.user_id=fr.user_id;this.sf_perm_role=fr.sf_perm_role;this.fulltext_search=fr.fulltext_search;this.read_only=fr.read_only?true:false;this.is_read_only_mount=fr.is_read_only_mount?true:false;this.request_id=(j=fr.request_id)!=null?j:null;this.match_type=(i=fr.match_type)!=null?i:"UNKNOWN_MATCH";return this.video_transcode_url=fr.video_transcode_url},track_in_browse:function(){if(!(this.to_key() in cW._file_index)){cu.add_file(this);return cW._file_index[this.to_key()]=this}},is_shared_folder:function(){return this.type===b9.SHARED_FOLDER||this.type===b9.TEAM_SHARED_FOLDER},is_team_shared_folder:function(){return this.type===b9.TEAM_SHARED_FOLDER},could_be_shared_folder:function(){var T,fr,i,j;fr=cu.public_folder_enabled&&this.fq_path.toLowerCase().startsWith("/public/");j=cu.public_folder_enabled&&this.fq_path.toLowerCase()==="/public";i=this.target_ns;T=this.ns_id!==Constants.root_ns;return this.type===b9.FOLDER&&!i&&!fr&&!j&&!this.is_sandbox()&&(!T||(this.can_hold_shared_folders&&!cu.inside_read_only_shared_folder))},is_sandbox:function(){return this.type===b9.SANDBOX},get_div:function(){return $("f_"+(this.to_key()))},rename:function(fs,fu,T,fr,ft,fv){var fw,i,j;i=this.fq_path;cu.pre_action_selection=[i];fw=cu.find_file(fs);if(fw){cu.remove_file(fw)}this.filename=aA.filename(fs);this.update_caption();this.fq_path=fs;this.ns_path=fu;this.htmlified_link=fv;this.hash=T;this.sort_key=fr;this.sort_rank=null;this.last_modified_fname=null;if(!this.dir){j=this.href.split("/");j[j.length-1]=ec.urlquote(this.filename)+("?w="+T);this.href=j.join("/");this.icon=ft}else{this.href="/home"+ec.urlquote(fs);if(this.target_ns){cu.ns_id_to_mount_point[this.target_ns]=fs}}if(cu.in_search_mode()){this.filename_highlights=[]}cW._file_index[this.to_key()]=this;cu.update_file_pos(this);return bF(document).trigger(aH.RENAME,{old_fq_path:i,file:this})},edit:function(){var T,i,fr,j,fs;this.editing=true;cu.selectable();fs=(function(ft){return function(fB){var fv,fu,fy,fD,fA,fx,fE,fC,fz,fw;fw=fB.responseText.evalJSON(true);cP(fw.new_browse_files.length===1,"No new file data returned.");fy=fw.new_browse_files.first();fD=fy.fq_path;fA=fy.hash;fz=ec.decode_sort_key(fy.sort_key);fE=fy.icon;fC=fy.ns_path;fx=fy.htmlified_link;fv=fw.changesets;fu=eG("Rename complete.");Y.notifyWithUndo(fu,fv,dK.do_rollback);ft.rename(fD,fC,fA,fz,fE,fx);e2.set_selected_files([ft]);ft.get_div().smoothScrollIntoView();a5.load_visible_thumbs();return cu.fire_visible_change_callbacks()}})(this);i=H({path:"/cmd/rename"+this.fq_path}).updateQuery(a9.UID_PARAM_NAME,cu.active_user).toString();fr=cu.in_search_mode()?".filename-col":".filename-col a";T=new Ajax.InPlaceEditor(this.get_div().down(fr),i,{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:25,ajaxClass:Ajax.DBRequest,submitOnBlur:true,initialText:this.filename,cancelIfSame:true,clickToEdit:false,onComplete:(function(ft){return function(){return ft.editing=false}})(this),onFailure:function(){},savingText:eG("Saving..."),ajaxOptions:{job:true,subject_user:cu.active_user,html_in_error_msg:true,progress_text:eG("Renaming..."),method:"POST",onCreate:ah.clear,onSuccess:fs,onUninitialized:cu.unselectable},callback:(function(ft){return function(fu,fv){return{to_path:fv||"",folder:(ft.dir?"yes":"")}}})(this)});T.enterEditMode();j=this.get_div().down(".editor_field");if("selectionEnd" in j&&this.filename.lastIndexOf(".")>-1){return j.selectionEnd=this.filename.lastIndexOf(".")}},to_key:function(){return this.ns_id+"_"+this.sjid},get_category:function(){var j,i;if(this.dir){if(cu.inside_dir&&cu.containing_fq_path()===""){if(this.filename.toLowerCase()==="public"&&cu.public_folder_enabled){j="PUBLIC_FOLDER"}}if(j==null){if(this.type===b9.FOLDER){j="FOLDER"}else{if(this.type===b9.PACKAGE){j="FOLDER"}else{if(this.type===b9.TEAM_SHARED_FOLDER){j="TEAM_SHARED_FOLDER"}else{if(this.type===b9.SHARED_FOLDER){j="SHARED_FOLDER"}else{if(this.type===b9.SANDBOX){j="SANDBOX"}else{if(this.target_ns){j="SHARED_FOLDER"}else{j="FOLDER"}}}}}}}}if(j==null){j=cW.EXTENSION_TO_CATEGORY[this.get_extension()]||"FILE"}i=this.is_deleted?cW.CATEGORY_TO_DELETED_TRANSLATION[j]:cW.CATEGORY_TO_TRANSLATION[j];cP(i,"CATEGORY MISSING FOR "+j);return i},get_icon_alt:function(){if(this.dir){if(this.is_shared_folder()){if(this.is_team_shared_folder()){if(this.is_read_only_mount){return eG("Read-only team folder")}else{return eG("Team folder")}}else{if(this.is_read_only_mount){return eG("Read-only shared folder")}else{return eG("Shared folder")}}}else{if(this.is_read_only_mount){return eG("Read-only folder")}else{return eG("Folder")}}}else{return""}},get_extension:function(){if(this.dir||this.filename.indexOf(".")===-1){return}return aA.file_extension(this.filename).toLowerCase()},is_shmodelable:function(){return !this.is_deleted&&cu.is_shmodelable_path(this.fq_path)},update_caption:function(){var i;i=cu.inside_dir?dv:cn;if(this.unresolved_comment_count>0){i-=aL}return this.caption=bU.em_snippet(this.filename,i)}});cW._CATEGORIES={IMAGE:"bmp cr2 gif ico jpeg jpg nef png psd tif tiff svg svgz",VIDEO:"3gp 3gpp 3gpp2 avi dv flv m2t m4v mkv mov mp4 mpeg mpg mts ts vob wmv",AUDIO:"aif flac m4a m4p mp3 ogg wav wma",DOCUMENT:"ai cdr csv doc docx docm eps fla indd keynote numbers otf pages pdf ppt pptx pptm pps ppsx ppsm ps rtf swf txt wpd xls xlsx xlsm",COMPRESSED_FILE:"7z bz2 gz gzip rar tar zip",CODE:"as as3 c coffee cpp cs css cxx h html java js less php py rb sass scss sh sql vb xhtml xml",DISK_IMAGE:"dmg iso",EXECUTABLE:"exe",SHORTCUT:"lnk",LINK:"url webloc",FONT:"ttf"};cW.EXTENSION_TO_CATEGORY={};cW.CATEGORY_TO_TRANSLATION={FILE:eG("file"),FOLDER:eG("folder"),SHARED_FOLDER:eG("shared folder"),TEAM_SHARED_FOLDER:eG("team folder"),PUBLIC_FOLDER:eG("folder"),IMAGE:eG("image"),VIDEO:eG("video"),AUDIO:eG("audio"),DOCUMENT:eG("document"),COMPRESSED_FILE:eG("archive"),CODE:eG("code"),DISK_IMAGE:eG("disk image"),EXECUTABLE:eG("executable"),SHORTCUT:eG("shortcut"),LINK:eG("link"),FONT:eG("font"),SANDBOX:eG("app folder")};cW.CATEGORY_TO_DELETED_TRANSLATION={FILE:eG("deleted file"),FOLDER:eG("deleted folder"),SHARED_FOLDER:eG("deleted shared folder"),TEAM_SHARED_FOLDER:eG("deleted team folder"),PUBLIC_FOLDER:eG("deleted folder"),IMAGE:eG("deleted image"),VIDEO:eG("deleted video"),AUDIO:eG("deleted audio"),DOCUMENT:eG("deleted document"),COMPRESSED_FILE:eG("deleted archive"),CODE:eG("deleted code"),DISK_IMAGE:eG("deleted disk image"),EXECUTABLE:eG("deleted executable"),SHORTCUT:eG("deleted shortcut"),LINK:eG("deleted link"),FONT:eG("deleted font"),SANDBOX:eG("deleted app folder")};(function(){var fr,fs,j,T,i;T=cW._CATEGORIES;i=[];for(fr in T){j=T[fr];i.push((function(){var fw,fv,ft,fu;ft=j.trim().split(" ");fu=[];for(fw=0,fv=ft.length;fw<fv;fw++){fs=ft[fw];fu.push(cW.EXTENSION_TO_CATEGORY[fs]=fr)}return fu})())}return i})();cW._file_index={};cW.from_key=function(i){return cW._file_index[i]};cW.from_elem=function(j){var i;if(!j){return}i=j.readAttribute("data-identity");if(i){return cW.from_key(i)}else{return cW.from_elem(j.up("[data-identity]"))}};var a,eN,aj,fe,bN,dN,cX=[].indexOf||function(fr){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fr){return T}}return -1};a=INLINE_JS.BrowseActions=F.BrowseActions=Class.create({initialize:function(i){return this._set_files(i)},firefly_logging_helper:function(i){if(cu.in_search_mode()&&i){this._firefly_log_values.action_type=i;return ba.SearchClientActivityLogger.log("result_action",cu.active_user.id,this._firefly_log_values)}},unlisten:function(){},get_action_names:function(){var i;i=this.get_files();if(i.length<2){return this._get_actions_single(i.first())}else{return this._get_actions_multi(i)}},get_files:function(){return this._files},get_action_by_name:function(i){return this.evaluate_action(a.option_dict[i],i)},evaluate_action:function(T,j){var fr,fs,i;fr=(function(ft){return function(fv,fu){if((fu!=null)&&(fv==null)){return fu}if(bF.isFunction(fv)){return fv.call(ft)}else{if(fv!=null){return fv}else{return fu}}}})(this);i={icon_href:T.icon_href,target:T.target,click_handler:T.click_handler,type:T.type,name:j||T.name,is_dropdown:!!T.is_dropdown,icon:fr(T.icon),text:fr(T.text),detail_text:fr(T.detail_text),href:fr(T.href,""),kind:fr(T.kind,"icon"),button_label:fr(T.button_label,T.text)};if(bF.isFunction(T.subactions)){i.subactions=T.subactions.call(this)}else{if(bF.isArray(T.subactions)){i.subactions=(function(){var fu,ft,fw,fv;fw=T.subactions;fv=[];for(fu=0,ft=fw.length;fu<ft;fu++){fs=fw[fu];fv.push(this.get_action_by_name(fs))}return fv}).call(this)}else{if(T.subactions){cP(0,"subactions must be a function or an array of actions")}}}return i},_set_files:function(j){var i;this._files=$A(j);this._log_extras={};if(this.get_files().length>0){i=j.first();this._log_extras={path:i.fq_path,ns_id:i.ns_id};return this._firefly_log_values={file_nsid:i.ns_id,file_sjid:i.sjid,firefly:cb.firefly_enabled,match_type:i.match_type,position:i.sort_rank,request_id:i.request_id,viewport:"full-view"}}},_get_actions_single:function(fI){var fu,fx,fy,fD,T,fw,fr,fJ,fv,fC,fs,ft,fE,fF,fG,i,fB,fz,fH,fA;fx=[];if(!fI){return[]}fD=cu.public_folder_enabled&&fI.fq_path.toLowerCase().startsWith("/public/");fC=cu.public_folder_enabled&&fI.fq_path.toLowerCase()==="/public";fJ=fI.target_ns;fy=fI.ns_id!==Constants.root_ns;ft=fI.type===b9.SHARED_FOLDER;fs=fI.type===b9.SANDBOX;fv=fI.type===b9.PACKAGE;fr=fI.in_root_coll;fw=fI.compressible;if(fI.is_deleted){fx=fx.concat(["restore"]);if(!((i=cu.permanent_delete_is_disabled_by_ns_id)!=null?i[fI.ns_id]:void 0)){fx.push("purge")}}else{fA=(__CONDITIONAL_JS__.UnityFeatures!=null)&&((fB=__CONDITIONAL_JS__.UnityCheckFileCache)!=null?fB.is_cached_and_locally_available(fI.ns_id,fI.ns_path):void 0);fG=fA?"open":"download";if(fI.dir){if(fs){fx.push("app_info")}else{if(cu.simple_sharing_enabled){fx.push("share_folder_and_token")}else{if(ft){fx.push("sharing_options")}else{if(!(fy||fJ||fD||fC)){fx.push("share")}}}}if(fI.is_shmodelable()&&!cu.simple_sharing_enabled){fx.push("token_share")}fx.push(fG);if(!fC){fx=fx.concat(["delete","rename","move"]);if(!(fv||fJ)){fx.push("copy")}}if(cu.can_use_photos_features){if(cu.can_use_photos_features){fx.push("album_from_folder")}}}else{if(fD||cu.public_app_token){fx.push("copy_url")}else{if(cu.simple_sharing_react_member_list_enabled){fx.push("share_folder_and_token")}else{if(fI.is_shmodelable()){fx.push("token_share")}}}fx.push(fG);if(cu.can_show_preview(fI)&&cu.browser_supports_comments){fx.push("comment")}fx=fx.concat(["delete","rename","move","copy","revisions"]);if(fr&&cu.can_use_photos_features){if(cu.photos_experience==="carousel"){fx.push("view_in_carousel")}else{fx.push("view_in_photos")}}if(fw){fx.push("compress")}}if(!cu.simple_sharing_enabled){fH=false;fz=["sharing_options","share","token_share"];for(fE=0,fF=fz.length;fE<fF;fE++){fu=fz[fE];T=fx.indexOf(fu);if(T>-1){fx.splice(T,1);fH=true}}if(fI.is_shared_folder()||fI.could_be_shared_folder()){fx.unshift("single_entry_share_dropdown_variant_menu")}else{fx.unshift("single_entry_share_dropdown_variant_token_share_only")}}}return fx},_get_actions_multi:function(fr){var i,j,T;if(Constants.send_a_copy_enabled){i=["send_copy","download"]}else{i=["download"]}i=i.concat(["delete","move","copy","restore","purge"]);if(cu.photos_experience==="carousel"){i.push("view_in_carousel")}else{i.push("view_in_photos")}j=a5.profile_files(fr);if(j.deleted>0||j.public_folder>0){i.removeItem("move");i.removeItem("copy");i.removeItem("delete")}if(j.shared_folders>0){i.removeItem("copy")}if(j.deleted>0){i.removeItem("send_copy");i.removeItem("delete");i.removeItem("download")}if(!cu.inside_dir){i.removeItem("download")}if(!(j.deleted===fr.length&&(j.shared_folders===0||((j.shared_folders===(T=fr.length)&&T===1))))){i.removeItem("restore")}if(!(j.deleted===fr.length&&j.can_permanently_delete===fr.length)){i.removeItem("purge")}if(j.in_root_coll!==fr.length||!cu.can_use_photos_features){i.removeItem("view_in_photos");i.removeItem("view_in_carousel")}return i},_show_appropriate_sharing_modals:function(j,i){var T;if((cu.simple_sharing_enabled&&j.dir)||cu.simple_sharing_react_member_list_enabled){if(ea.get_for_user(cu.active_user).verified_or_show()){eL.createAndShowInbandModalFromBrowseFile(cu.active_user,j)}return}if(j.is_shared_folder()){ba.ShmodelUILogger.log_with_target_file("sf_options",i,j);return s.show_shared_folder_options_modal(j.fq_path,cu.active_user)}else{if(j.could_be_shared_folder()){ba.ShmodelUILogger.log_with_target_file("sf_invite",i,j);return s.show_share_existing_modal(j.fq_path,cu.active_user)}else{ba.ShmodelUILogger.log_with_target_file("token_share",i,j);T=j.fq_path;cP(T,"token_share: expected non-root fq_path");return dE.shmodel(T,i+"_token_share")}}},get_disabled_action_names:function(){var T,fs,fr,i,ft;T=false;ft=this.get_files();for(fr=0,i=ft.length;fr<i;fr++){fs=ft[fr];T=true;if(!fs.read_only){T=false;break}}if(cu.inside_read_only_shared_folder||T){return["move","rename","delete","restore","purge","upload","new_folder","compress"]}else{return[]}},show_disabled_action_warning:function(i){if(cu.inside_read_only_shared_folder){if(i==="move"){return ah.warning(eG("You don't have permission to move files in this folder."))}else{if(i==="rename"){return ah.warning(eG("You don't have permission to rename files in this folder."))}else{if(i==="delete"){return ah.warning(eG("You don't have permission to delete files in this folder."))}else{if(i==="restore"){return ah.warning(eG("You don't have permission to restore files in this folder."))}else{if(i==="purge"){return ah.warning(eG("You don't have permission to permanently delete files in this folder."))}else{if(i==="upload"){return ah.warning(eG("You don't have permission to upload files into this folder."))}else{if(i==="new_folder"){return ah.warning(eG("You don't have permission to create a new folder in this folder."))}else{if(i==="compress"){return ah.warning(eG("You don't have permision to create a compressed file in this folder."))}else{return ah.warning(eG("You only have permission to view this folder."))}}}}}}}}}else{return ah.warning(eG("You do not have permission to perform the requested action."))}}});Object.extend(a,{PUBLIC_FOLDER_PATH_LENGTH:7,showCopyPublicUrlModal:function(j){var i,T;fh.show(a5.append_ellipsis(eG("Copy public link")),dB.fromElm("copy-public-url"),{wit_group:"copy_public_link"});fh.onHide=function(){$("flash_copy_container").remove();delete fh.onHide;return fh.hide()};i=t.clipboard_overlay(j,bF("#real_copy"),function(){ah.success(eG("Link copied to clipboard!"));return fh.hide()});i.css({zIndex:1001});T=$("modal-content").down("#public_url");cP(T,"Text element not found for copy pulic link");T.setValue(j);return T.select()},shortenPublicLink:function(){var i;ec.shorten_url($F("public_url"),a.updatePublicLink);i=new Element("img",{id:"publink_loading",src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif",className:"right"});return $("modal-content").down("a").__date(i)},updatePublicLink:function(j){var i;$("public_url").setValue(j);$("public_url").select();$("publink_loading").remove();$("flash_copy_container").remove();i=t.clipboard_overlay(j,bF("#real_copy"),function(){ah.success(eG("Link copied to clipboard!"));return fh.hide()});return i.css({zIndex:1001})},option_dict:{new_folder:{icon:"folder_add",text:eG("New folder"),click_handler:function(i){return cu.new_folder()}},global_restore:{icon:"restore",text:function(){cP(cu.inside_deleted_dir,"Global restore from not a deleted dir");if(cu.inside_deleted_shared_folder){return a5.append_ellipsis(eG("Rejoin shared folder"))}else{if(cu.inside_deleted_sandbox){return eG("Restore app folder")}else{return eG("Restore folder")}}},click_handler:function(){var fr,fs,j,i,T;fr=cu.containing_fq_path();j=fr.toLowerCase();if(cu.inside_deleted_sandbox){cP(cu.old_path_to_ns_id[j],"Deleted sandbox missing nsid");return bi.restore_sandbox(cu.active_user,fr,cu.old_path_to_ns_id[j])}else{if(cu.inside_deleted_shared_folder){cP(cu.old_path_to_ns_id[j],"Deleted shared folder missing nsid");return s.show_rejoin_modal(cu.active_user,fr,cu.old_path_to_ns_id[j])}else{fs=H.parse(location.href).setFragment("").toString();i={prev:fs};i[a9.UID_PARAM_NAME]=cu.active_user;T=H({path:"/restore"+fr}).updateQuery(i);return window.location.href=String(T)}}}},restore:{icon:"restore",text:function(){var j,i;j=this.get_files();i=a5.profile_files(j);if(i.shared_folders===j.length){return a5.append_ellipsis(bd("Rejoin shared folder","Rejoin shared folders",j.length,{comment:"BUTTON"}))}else{return a5.append_ellipsis(eG("Restore",{comment:"Restore a previously-deleted file"}))}},click_handler:function(){var T,fu,j,fv,ft,i,fs,fr;fu=this.get_files();if(fu.length===0){}else{if(fu.length===1){T=fu.first();if(!T.is_deleted){return}fv=T.fq_path;j=fv.toLowerCase();if(T.type===b9.SANDBOX){cP(cu.old_path_to_ns_id[j],"Restore missing ns");bi.restore_sandbox(cu.active_user,fv,cu.old_path_to_ns_id[j])}else{if((fs=T.type)===b9.SHARED_FOLDER||fs===b9.TEAM_SHARED_FOLDER){cP(cu.old_path_to_ns_id[j],"Rejoin missing ns");s.show_rejoin_modal(cu.active_user,fv,cu.old_path_to_ns_id[j])}else{if(T.dir){ft=H.parse(location.href).updateQuery({select:T.filename});i={prev:String(ft)};i[a9.UID_PARAM_NAME]=cu.active_user;fr=H({path:"/restore"+T.fq_path}).updateQuery(i);window.location=String(fr)}else{dK.show_undelete(T)}}}}else{return dK.show_bulk_restore(fu,cu.active_user)}}}},global_share:{icon:"rainbow_16",text:function(){if(cu.inside_team_folder){return a5.append_ellipsis(eG("Team folder options",{comment:"BUTTON. please keep this as short as possible"}))}else{if(cu.inside_shared_folder){return a5.append_ellipsis(eG("Shared folder options",{comment:"BUTTON. please keep this as short as possible."}))}else{if(cu.containing_fq_path()===""){return a5.append_ellipsis(eG("Share a folder",{comment:"BUTTON. this initiates a wizard that lets the user select a folder to share."}))}else{return a5.append_ellipsis(eG("Share this folder",{comment:"BUTTON. this button lets the user share the current folder that they're viewing."}))}}}},click_handler:function(T){var j,i;T.preventDefault();if(cu.containing_fq_path()===""){return s.start_wizard_for_user(cu.active_user)}else{if(cu.simple_sharing_enabled){if(ea.get_for_user(cu.active_user).verified_or_show()){j=cu.inside_shared_folder&&!cu.containing_ns_path();i=j?cu.containing_ns_id():void 0;return eL.createAndShowInbandModal(cu.active_user,cu.containing_fq_path(),true,i,j,!cu.inside_shared_folder,cu.containing_sf_perm_role())}}else{if(cu.inside_shared_folder){return s.show_shared_folder_options_modal(cu.containing_mount_point(),cu.active_user)}else{return s.show_share_existing_modal(cu.containing_fq_path(),cu.active_user)}}}}},sharing_options:{icon:"rainbow_16",text:a5.append_ellipsis(eG("Shared folder options",{comment:"BUTTON"})),click_handler:function(T,i){var j;j=this.get_files().first();ba.ShmodelUILogger.log_with_target_file("sf_options",i,j);return s.show_shared_folder_options_modal(j.fq_path,cu.active_user)}},share:{icon:"rainbow_16",text:a5.append_ellipsis(eG("Invite to folder",{comment:"BUTTON"})),click_handler:function(T,i){var j;j=this.get_files().first();ba.ShmodelUILogger.log_with_target_file("sf_invite",i,j);return s.show_share_existing_modal(j.fq_path,cu.active_user)}},share_folder_and_token:{icon:"rainbow_16",text:a5.append_ellipsis(eG("Share",{comment:"BUTTON"})),click_handler:function(T,i){var j;j=this.get_files().first();return this._show_appropriate_sharing_modals(j,i)}},revisions:{icon:"previous_versions",click_handler:function(){return window.location.href=dK.build_revisions_uri(this.get_files().first().fq_path,cu.active_user)},text:eG("Previous versions",{comment:"BUTTON"})},token_share:{icon:"s_link",text:a5.append_ellipsis(eG("Share link",{comment:"BUTTON"})),click_handler:function(fr,i){var j,T;j=this.get_files().first();ba.ShmodelUILogger.log_with_target_file("token_share",i,j);T=j.fq_path;cP(T,"token_share: expected non-root fq_path");return dE.shmodel(T,i+"_token_share")}},global_token_share:{icon:"s_link",text:a5.append_ellipsis(eG("Share link",{comment:"BUTTON"})),click_handler:function(j,i){ba.ShmodelUILogger.log("via-global-toolbar");return dE.shmodel(cu.containing_fq_path(),i+"_global_token_share")}},copy_url:{icon:"world_link",text:a5.append_ellipsis(eG("Copy public link",{comment:"BUTTON"})),click_handler:function(T){var j,i;j=this.get_files().first();if(cu.public_app_token){i="/spa/"+cu.public_app_token+j.ns_path}else{i="/u/"+cu.active_user.id+j.fq_path.substring(a.PUBLIC_FOLDER_PATH_LENGTH)}return a.showCopyPublicUrlModal(String(new H({scheme:"https",authority:Constants.PUBSERVER,path:i})))}},download:{icon:"download",text:function(){return eG("Download",{comment:"BUTTON"})},click_handler:function(){var fv,j,fs,fu,ft,i,fr,T;fs=this.get_files();if(fs.length===1&&!fs[0].dir){j=fs.first();fr=[Constants.BLOCK_CLUSTER,j.fq_path,j.hash],fv=fr[0],ft=fr[1],fu=fr[2];i={w:fu,dl:1};T=H({scheme:"https",authority:fv,path:"/get"+ft,query:i});return window.location=String(T.updateQuery(a9.UID_PARAM_NAME,cu.active_user))}else{return dK.do_bulk_download(fs)}}},view:{href:function(){var fs,i,fr,T,j;i=this.get_files().first();j=[Constants.BLOCK_CLUSTER,ec.urlquote(i.fq_path),i.hash],fs=j[0],T=j[1],fr=j[2];return"https://"+fs+"/get"+T+"?w="+fr},icon:"page_white_magnify",text:eG("View file",{comment:"BUTTON"})},ignore:{click_handler:function(){return s.show_ignore_modal(this.get_files().first().fq_path)},icon:"folder_user_delete",text:eG("Permanently remove",{comment:"BUTTON"})},show_del:{click_handler:function(i){return cu.toggle_deleted()},icon:"trash-can",text:eG("Show deleted files",{comment:"BUTTON"})},hide_del:{click_handler:function(i){return cu.toggle_deleted()},icon:"trash-can-open",text:eG("Hide deleted files",{comment:"BUTTON"})},copy:{icon:"copy",text:a5.append_ellipsis(eG("Copy",{comment:"BUTTON"})),click_handler:function(T){var i,j;j=this.get_files();if(j.length===1){i=j.first();return dK.show_copy(i.fq_path,i.dir)}else{if(j.length>1){return dK.show_copy_bulk(j)}}}},move:{icon:"move_16",text:a5.append_ellipsis(eG("Move",{comment:"BUTTON"})),click_handler:function(T){var i,j;j=this.get_files();if(j.length===1){i=j.first();return dK.show_move(i.fq_path,i.dir)}else{if(j.length>1){return dK.show_move_bulk(j)}}}},rename:{icon:"rename",text:eG("Rename",{comment:"BUTTON"}),click_handler:function(){return this.get_files().first().edit()}},"delete":{icon:"delete_16",text:a5.append_ellipsis(eG("Delete",{comment:"BUTTON"})),click_handler:function(fx){var fu,ft,T,fw,fv,fs,fy,fr;T=this.get_files();fy=T.length;if(fy>=1){fs=T[0].mount_point;if(fs){for(fw=fv=1,fr=fy;1<=fr?fv<fr:fv>fr;fw=1<=fr?++fv:--fv){if(T[fw].mount_point!==fs){fs="";break}}}if(fs){fu=aA.filename(fs)}else{fu=null}if(fy>1){return dK.show_bulk_delete(cu.active_user,T,fu)}else{if(fy===1){ft=T[0];return dK.show_delete(cu.active_user,ft.fq_path,ft.dir,void 0,fu,ft.is_shared_folder())}}}}},global_purge:{icon:"cancel",text:a5.append_ellipsis(eG("Permanently delete folder")),click_handler:function(){return dK.show_purge(cu.containing_fq_path(),true)}},purge:{icon:"cancel",text:a5.append_ellipsis(eG("Permanently delete",{comment:"BUTTON"})),click_handler:function(T){var i,j;j=this.get_files();if(j.length===1){i=j.first();return dK.show_purge(i.fq_path,i.dir)}else{return dK.show_bulk_purge(j)}}},upload:{icon:"upload_16",text:a5.append_ellipsis(eG("Upload")),click_handler:function(i){return dK.show_upload()}},app_info:{icon:"application_double",text:a5.append_ellipsis(eG("Application info")),click_handler:function(i){return window.location.href="/account/security"}},more_actions:{is_dropdown:true,text:eG("More",{comment:"Show more options"}),click_handler:Prototype.emptyFunction},more_global_actions:{text:eG("More actions"),click_handler:function(){bN.show_secondary();return document.body.observe("click",bN.hide_secondary)}},view_in_photos:{icon:"s_photo",text:function(){return eG("View in Photos")},click_handler:function(){var i;i=this.get_files();return dK.do_bulk_photo_view(i,cu.photos_experience)}},compress:{icon:"s_photo",text:function(){return eG("Compress (experimental)")},click_handler:function(){var i;i=this.get_files();return dK.show_compress_bulk(cu.active_user,i)}},view_in_carousel:{icon:"s_carousel",text:function(){return eG("View in Timeline")},click_handler:function(){var i;i=this.get_files();return dK.do_bulk_photo_view(i,"carousel")}},album_from_folder:{icon:"create-album",text:function(){return eG("Create album")},click_handler:function(){var j,i;j=this.get_files();i=j.first();return dK.create_album_from_folder(i.fq_path,i.filename)}},open:{icon:"open",text:function(){return eG("Open")},click_handler:function(){var i;i=this.get_files().first();return __CONDITIONAL_JS__.UnityFeatures.open_file(i.ns_id,i.ns_path,i.user_id,__CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler,function(j){return __CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler(false)})}},comment:{icon:"s_file_comment",text:function(){return eG("Comment",{comment:"BUTTON"})},click_handler:function(i){var j;j=this.get_files().first();return cu.open_preview(j,i,false,true)}},single_entry_share_dropdown_variant_token_share_only:{icon:"s_rainbow",text:a5.append_ellipsis(eG("Share")),click_handler:function(T,i){var j;j=this.get_files().first();ba.ShmodelUILogger.log_with_target_file("single_entry_share_click",i,j);return dE.shmodel(j.fq_path,i)}},single_entry_share_dropdown_variant_menu:{icon:"s_rainbow",text:a5.append_ellipsis(eG("Share")),is_dropdown:true,subactions:["single_entry_share_dropdown_variant_menu_invite_option","single_entry_share_dropdown_variant_menu_token_share_option"],click_handler:function(){},hover_handler:function(T,i){var j;j=this.get_files().first();return ba.ShmodelUILogger.log_with_target_file("single_entry_share_hover",i,j)}},single_entry_share_dropdown_variant_menu_invite_option:{icon:"user_add",text:a5.append_ellipsis(eG("Invite people to collaborate")),click_handler:function(ft,i){var T,fr,fs,j;T=this.get_files().first();if(T.is_shared_folder()){if(ea.get_for_user(cu.active_user).verified_or_show()){ba.ShmodelUILogger.log_with_target_file("sf_options",i,T);fr=new dl(cu.active_user,T.fq_path);return fr.show()}}else{j=cu.verify_email_after_share_experiment_variant;fs=j&&j==="VERIFY_LAST";if(fs){ba.UserActivityLogger.log("web","email_verify_last_experiment_shown")}else{if(j){ba.UserActivityLogger.log("web","email_verify_last_experiment_not_shown")}}if(fs||ea.get_for_user(cu.active_user).verified_or_show()){ba.ShmodelUILogger.log_with_target_file("sf_invite",i,T);fr=new cq(cu.active_user,{folder_name:T.fq_path,element_id:"invite-to-new-sf-wizard-modal-"+cu.active_user.id,must_check_verified:fs});return fr.show()}}}},single_entry_share_dropdown_variant_menu_token_share_option:{icon:"s_link",text:a5.append_ellipsis(eG("Send link")),click_handler:function(T,i){var j;j=this.get_files().first();ba.ShmodelUILogger.log_with_target_file("token_share",i,j);return dE.shmodel(j.fq_path,i)}}}});aj=F.BrowseActionsContext=Class.create(a,{initialize:function($super,i){$super(i);return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");bF("#context-menu-container").off("mouseenter");$("context-menu-container").on("click",".action button",this._click.bind(this));$("context-menu-container").on("contextmenu",".action button",this._click.bind(this));bF("#context-menu-container").on("mouseover","li.primary",this._over.bind(this));bF("#context-menu-container").on("mouseout","li.primary",this._out.bind(this));return bF("#context-menu-container").on("mouseenter",".action button",this._enter.bind(this))},_click:function(fr,j){var T,i;T=j.readAttribute("data-value");if(cX.call(this.get_disabled_action_names(),T)>=0){this.show_disabled_action_warning(T);return false}ba.TimeToFirstActionLogger.log(cu.active_user.id,T);this.firefly_logging_helper(T);i=a.option_dict[T];ba.BrowseActionsContextMenuLogger.log(this.get_files(),T);if(!i.is_dropdown||j.hasAttribute("submenu-index")){bn.hide()}fr.preventDefault();i.click_handler.call(this,Constants.OREF_CONSTANTS.BROWSE_COMMENT_CONTEXTMENU,fr,"browse_actions_context");if(T==="sharing_options"){ba.SharedFolderActivityLogger.log("web","browse_view_options",cu.active_user,this._log_extra,true)}if(T==="share"){return ba.SharedFolderActivityLogger.log("web","browse_view_share_existing",cu.active_user,this._log_extras,true)}},_reset_all_submenus:function(){return bF("#context-menu-container .hover").removeClass("hover")},_reset_submenu:function(i){return bF(i).removeClass("hover")},_enter:function(fr){var T,i,j;T=bF(fr.currentTarget).data("value");cP(T);i=a.option_dict[T];cP(i,"Action info is missing for "+T);return(j=i.hover_handler)!=null?j.call(this,fr,"browse_actions_context"):void 0},_over:function(i){if(bF(i.currentTarget).children(".secondary").length){clearTimeout(this.timeoutID);this._reset_all_submenus();return bF(i.currentTarget).addClass("hover")}},_out:function(i){if(bF(i.currentTarget).children(".secondary").length){return this.timeoutID=setTimeout((function(j){return function(){return j._reset_submenu(i.currentTarget)}})(this),300)}}});eN=F.BrowseActionsBasic=Class.create(a,{initialize:function($super){var i;i=e2.get_selected_files();$super(i);this._render();return this._listen()},_listen:function(){var i;this.bound_update=this._update.bind(this);this.bound_disable=this._disable.bind(this);this.bound_enable=this._enable.bind(this);this.bound_click=this._click.bind(this);document.observe(e2.UPDATED_EVT,this.bound_update);document.observe(bn.SHOW_EVT,this.bound_disable);document.observe(bn.HIDE_EVT,this.bound_enable);i=$("browse-root-actions");i.stopObserving("click");return i.on("click",".action button",this.bound_click)},unlisten:function(){document.stopObserving(e2.UPDATED_EVT,this.bound_update);document.stopObserving(bn.SHOW_EVT,this.bound_disable);document.stopObserving(bn.HIDE_EVT,this.bound_enable);return $("browse-root-actions").stopObserving("click",this.bound_click)},_update:function(){this._set_files(e2.get_selected_files());return this._render()},_disable:function(){$("browse-root-actions").stopObserving("click");if($("browse-root-actions").down(".secondary")){$("browse-root-actions").down(".secondary").addClassName("disabled")}return $$("#browse-root-actions .action *").invoke("setStyle",{cursor:"default"})},_disable_action:function(T){var j,i;i="#browse-root-actions #"+T+"_action_button";j=bF(i);j.addClass("disabled");return j.click((function(fr){return function(fs){fr.show_disabled_action_warning(T);return false}})(this))},_enable:function(){$("browse-root-actions").stopObserving("click");$("browse-root-actions").on("click",".action button",this._click.bind(this));if($("browse-root-actions").down(".secondary")){$("browse-root-actions").down(".secondary").removeClassName("disabled")}return $$("#browse-root-actions .action *").invoke("setStyle",{cursor:"pointer"})},_render:function(){var fR,fJ,fM,fz,fQ,fS,fT,fI,fL,fC,i,ft,fu,fx,fv,fN,fK,fG,fO,fy,fw,fP,fs,fU,fF,T,fD,fB,fA,fE,fH,fr;ft=this.get_files();fM=this.get_action_names();if(!cu.simple_sharing_enabled){fA=["single_entry_share_dropdown_variant_token_share_only","single_entry_share_dropdown_variant_menu"];for(fN=0,fO=fA.length;fN<fO;fN++){fJ=fA[fN];fv=fM.indexOf(fJ);if(fv>-1){fM.splice(fv,1);break}}}fR=13.5;fL="";fu="";if(ft.length===1){fL=bU.em_snippet(ft[0].filename,fR);if(!ft[0].dir&&ft[0].bytes>=0){fu=ft[0].size}}else{if(1<ft.length){T=a5.profile_files(ft);fP=[];if(T.files){fs=bd("%d file","%d files",T.files).format(T.files);fP.push(fs)}if(T.folders){fs=bd("%d folder","%d folders",T.folders).format(T.folders);fP.push(fs)}fL=ec.nice_list(fP)}}fS=$("browse-root-actions");fQ=fS.getLayout().get("width");fx=fS.getStyle("font-size");cP(fx.endsWith("px"),"Invalid font size "+fx);fx=parseInt(fx,10);fC=new bU(fL).length*fx;fE=new bU(fu).length*fx;fQ-=fC+fE;fH=[];fB=[];fQ-=30;for(fK=0,fy=fM.length;fK<fy;fK++){fU=fM[fK];fJ=this.get_action_by_name(fU);fr=new bU(fJ.text).length*fx;fT=fr+16+8+10+9;if(fQ>fT){fH.push(fU)}else{if(fB.length===0){fF=fH.pop();fB.push(fF)}fB.push(fU)}fQ-=fT}if(fB.length){fH.push("more_actions")}fz=(function(){var j,fV,fW;fW=[];for(j=0,fV=fH.length;j<fV;j++){fU=fH[j];fW.push(this.get_action_by_name(fU))}return fW}).call(this);if(fB.length){fz[fz.length-1].subactions=(function(){var j,fV,fW;fW=[];for(j=0,fV=fB.length;j<fV;j++){fU=fB[j];fW.push(this.get_action_by_name(fU))}return fW}).call(this)}fI=fm.tmpl("actions_bar_tmpl",{context:this,description:fL,filesize:fu,has_actions:!!fM.length,actions:fz,_:eG,Sprite:cy});$("browse-root-actions").__date(fI);i=this.get_disabled_action_names();fD=[];for(fG=0,fw=i.length;fG<fw;fG++){fJ=i[fG];fD.push(this._disable_action(fJ))}return fD},_click:function(fr,j){var T,i;T=j.readAttribute("data-value");cP(T);this.firefly_logging_helper(T);i=a.option_dict[T];cP(i,"Action info is missing for "+T);fr.preventDefault();ba.TimeToFirstActionLogger.log(cu.active_user.id,T);i.click_handler.call(this,Constants.OREF_CONSTANTS.BROWSE_COMMENT_BUTTON,fr,"browse_actions_basic");if(T==="sharing_options"){ba.SharedFolderActivityLogger.log("web","browse_view_select_folder_options",cu.active_user,this._log_extras,true)}if(T==="share"){return ba.SharedFolderActivityLogger.log("web","browse_view_select_share_existing",cu.active_user,this._log_extras,true)}}});Object.extend(eN,{STANDARD_ACTIONS:["share","sharing_options","app_info","token_share","copy_url","download","delete","rename","restore","purge","view_in_photos","view_in_carousel","compress"]});fe=F.GlobalActions=Class.create(a,{initialize:function($super){return $super()},get_action_names:function(){var i;if(!cu.inside_dir){return[]}i=[];if(!cu.inside_deleted_dir){i=i.concat(["upload","new_folder"]);if(this._should_show_shared_folder_options()){i.push("global_share")}if(this._should_show_share_link()){i.push("global_token_share")}if(!Constants.can_see_trash){i.push((cu.deleted_shown?"hide_del":"show_del"))}}else{i=i.concat(["global_restore"])}return i},_should_show_shared_folder_options:function(){return !cu.is_in_subfolder_of_shared_folder()&&!cu.inside_sandbox},_should_show_share_link:function(){return cu.is_shmodelable_path(cu.containing_fq_path())}});bN=F.GlobalActionsBasic=Class.create(fe,{initialize:function($super){$super();this._listen();return this._render()},_listen:function(){$("global-actions").stopObserving("click");$("global-actions").on("click","a",this._click.bind(this));document.observe(bn.SHOW_EVT,this._disable.bind(this));return document.observe(bn.HIDE_EVT,this._enable.bind(this))},_render:function(){var fr,fs,fw,fA,fB,ft,fx,i,T,fv,fu,fz,fy;fs=this.get_action_names();fy=fs.intersect(bN.STANDARD_ACTIONS);fu=fs.without.apply(fs,bN.STANDARD_ACTIONS);if(fu.length===1){fy=fs;fu=[]}if(fu.length){fy.push("more_global_actions")}fz=(function(){var fD,fC,fE;fE=[];for(fD=0,fC=fy.length;fD<fC;fD++){i=fy[fD];fE.push(this.get_action_by_name(i))}return fE}).call(this);fw=(function(){var fD,fC,fE;fE=[];for(fD=0,fC=fz.length;fD<fC;fD++){fr=fz[fD];if(fr.kind==="button"){fE.push(fr)}}return fE})();T=(function(){var fD,fC,fE;fE=[];for(fD=0,fC=fz.length;fD<fC;fD++){fr=fz[fD];if(fr.kind!=="button"){fE.push(fr)}}return fE})();fA=fm.tmpl("global_actions_tmpl",{context:this,standard_actions:fw.concat(T),secondary_actions:(function(){var fD,fC,fE;fE=[];for(fD=0,fC=fu.length;fD<fC;fD++){i=fu[fD];fE.push(this.get_action_by_name(i))}return fE}).call(this),Sprite:cy});$("global-actions").__date(fA);bF(document).trigger(dU.GA_RENDERED);fB=this.get_disabled_action_names();fv=[];for(ft=0,fx=fB.length;ft<fx;ft++){fr=fB[ft];fv.push(this._disable_action(fr))}return fv},_disable:function(){$("global-actions").stopObserving("click");$$("#global-actions .action a").invoke("removeClassName","title_bubble");return $$("#global-actions .action a").invoke("addClassName","disabled")},_disable_action:function(T){var j,i;i="#global-actions #"+T+"_button";j=bF(i);j.addClass("disabled");return j.click((function(fr){return function(fs){fr.show_disabled_action_warning(T);return false}})(this))},_enable:function(){var fs,ft,T,i,fr;$("global-actions").stopObserving("click");$("global-actions").on("click","a",this._click.bind(this));$$("#global-actions .action a").invoke("removeClassName","disabled");$$("#global-actions .action a").invoke("addClassName","title_bubble");ft=this.get_disabled_action_names();fr=[];for(T=0,i=ft.length;T<i;T++){fs=ft[T];fr.push(this._disable_action(fs))}return fr},_click:function(fr,j){var T,i;T=j.readAttribute("data-value");cP(T);i=a.option_dict[T];cP(i,"Action info is missing for "+T);bN.hide_secondary();e2.deselect_all();fr.preventDefault();i.click_handler.call(this,fr,"global_actions_basic");if(T==="global_share"){if(this._log_extras.path===""){return ba.SharedFolderActivityLogger.log("web","browse_view_share_button",cu.active_user,this._log_extras,true)}else{return ba.SharedFolderActivityLogger.log("web","folder_view_share_button",cu.active_user,this._log_extras,true)}}}});Object.extend(bN,{STANDARD_ACTIONS:["upload","new_folder","global_share","global_token_share","global_restore","global_purge"],show_secondary:function(){var i,j;j=$("secondary-actions");i=$("more_global_actions_button");j.show();return i.addClassName("down")},hide_secondary:function(){var i,j;j=$("secondary-actions");if(!j){return}i=$("more_global_actions_button");j.hide();return i.removeClassName("down")}});dN=F.GlobalActionsContext=Class.create(fe,{initialize:function($super,i){$super(i);return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(fr,j){var T,i;T=j.readAttribute("data-value");if(cX.call(this.get_disabled_action_names(),T)>=0){this.show_disabled_action_warning(T);return false}this.firefly_logging_helper(T);i=a.option_dict[T];e2.deselect_all();if(!i.is_dropdown){bn.hide()}fr.preventDefault();i.click_handler.call(this,fr,"global_actions_context");if(T==="global_share"){if(this._log_extras.path===""){return ba.SharedFolderActivityLogger.log("web","browse_view_right_click_share",cu.active_user,this._log_extras,true)}else{if(cu.inside_shared_folder){return ba.SharedFolderActivityLogger.log("web","folder_view_right_click_options",cu.active_user,this._log_extras,true)}else{return ba.SharedFolderActivityLogger.log("web","folder_view_right_click_share",cu.active_user,this._log_extras,true)}}}}});var z;z=F.BrowseClipboard=(function(){var fw,ft,T,fu,fs,fy,fA,fv,j,i,fx,fr,fz;fw=0;ft=1;fs=[];T=null;fz=function(){var fE,fF,fD,fC,fB,fG;if(D.focus_in_input()){return}fD=e2.get_selected_files();if(fD&&fD.length){for(fC=0,fB=fD.length;fC<fB;fC++){fF=fD[fC];if(fF.bytes<0){ah.error(eG("Deleted files cannot be added to the clipboard"));return false}else{if(fF.target_ns){fG=eG("'%(filename)s' cannot be added to the clipboard");fG=fG.format({filename:fF.filename});ah.error(fG);return false}}}fs=fD;fE=fD.length;fG=bd("Added %d item to clipboard","Added %d items to clipboard",fE).format(fE);ah.success(fG);return true}};fy=function(){if(fz()){T=fw;return false}};fA=function(){if(fz()){T=ft;return false}};fv=function(fB){var fC;cP(typeof fB!=="undefined","BrowseClipboard _paste got an undefined path");if(fs.length){fC=T===fw?dK.do_bulk_copy:dK.do_bulk_move;fC(fs,fB);return true}};fr=function(fB){var fC;if(D.focus_in_input()||cu.in_search_mode()||cu.inside_deleted_dir){return}fC=fv(cu.containing_fq_path());if(fC){return false}};fu=function(){return fs=[]};i=function(fI){var fH,fF,fG,fE,fD,fB,fC;fG=fI.memo.files;for(fE=0,fB=fG.length;fE<fB;fE++){fF=fG[fE];for(fD=0,fC=fs.length;fD<fC;fD++){fH=fs[fD];if(fH.fq_path===fF.fq_path||fH.fq_path.startsWith(fF.fq_path+"/")){fu();return}}}};j=function(fB){cP((fB.memo.file!=null)&&(fB.memo.files==null));fB.memo.files=[fB.memo.file];return i(fB)};fx=function(){var fF,fD,fC,fB,fE;bF(document).on(aH.RENAME,(function(fG){return function(fH,fI){fH.memo=fI;return j(fH)}})(this));fE=[aH.DELETE,aH.MOVE];for(fD=0,fC=fE.length;fD<fC;fD++){fF=fE[fD];document.observe(fF,i)}fB=key.main_modifier();key(fB+"+c",cu.KEY_SCOPE,fy);key(fB+"+x",cu.KEY_SCOPE,fA);return key(fB+"+v",cu.KEY_SCOPE,fr)};return{init:function(){return fx()}}})();var e2,aE;e2=F.BrowseSelection=(function(){var fP,fV,fS,fO,fu,ft,fL,fQ,fC,fs,fU,fN,fH,fG,fD,fw,fJ,j,i,fB,fI,fW,fA,fy,fE,fx,fr,fv,fM,fK,T,fT,fR,fz,fF;fv=[];fO=null;fs=null;fQ=null;ft=[];fR=function(){$$("#browse-files li.browse-file.file-select").invoke("removeClassName","file-select").invoke("removeClassName","file-select-one");e2.get_selected_files().invoke("get_div").findAll(function(fX){return fX}).invoke("addClassName","file-select");if(e2.get_selected_files().length===1){return e2.get_selected_files().invoke("get_div").findAll(function(fX){return fX}).invoke("addClassName","file-select-one")}};fz=function(){if(fQ){return}$$("#browse-files li.browse-file[draggable]").invoke("writeAttribute","draggable",false);if(cu.in_search_mode()){return}return e2.get_selected_files().filter(function(fX){return !fX.editing}).invoke("get_div").findAll(function(fX){return fX}).invoke("writeAttribute","draggable","true")};fF=function(fX){fX.apply(null,$A(arguments).slice(1));return document.fire(e2.UPDATED_EVT)};fM=function(fZ,fY){var f0,fX;fX=fv.length;fv=(fZ instanceof cW?[fZ]:$A(fZ));if(fv.length!==fX){eO("Selected",fv.length,"files")}f0=fY||fv.last();cP(!f0||f0 instanceof cW,"Invalid anchor type"+f0);return fO=f0};fM=fM.wrap(fF);fP=function(fY,fX){if(fY){fv.push(fY)}return fO=fX||fY};fP=fP.wrap(fF);fy=function(fX){var fY;fY=fv.indexOf(fX);if(fY===-1){return}return fv.splice(fY,1)};fy=fy.wrap(fF);fE=function(){return fv=[]};fE=fE.wrap(fF);fK=function(fX){ft=fX;$$("#browse-files li.browse-file.context-select").invoke("removeClassName","context-select");return fX.invoke("get_div").findAll(function(fY){return fY}).invoke("addClassName","context-select")};j=function(f6){var f3,f1,f0,f2,f9,fZ,f8,ga,fX,f5,f7,f4,fY;f4=$(f6.target);ga=f4.match("li.browse-file")?f4:f4.up("li.browse-file");f3=f4.match("a")?f4:f4.up("a");f0=cW.from_elem(ga);if(f6.isRightClick()||!ga||f3||ga.hasClassName("unselectable")){return}cu.keyboard_nav=false;if(ft.length){return}fZ=ec.is_mac();if((fZ&&f6.metaKey)||(!fZ&&f6.ctrlKey)){if(fv.indexOf(f0)===-1){return fP(f0)}else{return fy(f0)}}else{if(f6.shiftKey){f1=cu.files.indexOf(fO);fY=cu.files.indexOf(f0);f8=cu.files.indexOf(fv.last());f5=fv.slice(0);f9=f8<f1?-1:1;f2=f1;while(f2!==f8){f2+=f9;f7=f5.indexOf(cu.files[f2]);if(f7!==-1){f5.splice(f7,1)}}f9=fY<f1?-1:1;f2=f1;while(f2!==fY){f2+=f9;fX=f5.indexOf(cu.files[f2]);if(fX!==-1){f5.splice(fX,1)}f5.push(cu.files[f2])}return fM(f5,fO)}else{return fM(f0)}}};i=function(f3){var f6,fZ,f0,f2,f5,f4,fY,fX,f1;if(f3.isRightClick()||ft.length||ec.in_scrollbar(f3.pointerX())){return}f4=$(f3.target);if(Element.match(f4,"object")){f4=f4.parentNode}f1=["browse-box","context-menu-container","modal","modal-overlay"];fY=false;for(f0=0,f2=f1.length;f0<f2;f0++){fX=f1[f0];if(f4.descendantOf(fX)||f4.match("#"+fX)){fY=true;break}}if(!fY){fM();return}f5=f4.match("li.browse-file")?f4:f4.up("li.browse-file");fZ=cW.from_elem(f5);f6=f4.match("[draggable]")||f4.up("[draggable]");if(fZ&&!f6){fs=fO;if(!f3.shiftKey){if(fZ){fs=fZ}else{if(f4.match("#browse-files")){fs=cu.files.last()}}}fQ=[];if(f3.metaKey||f3.ctrlKey){return fQ=e2.get_selected_files()}}};T=function(fZ){var fY,fX;fY=cW.from_elem(fJ(fZ));fZ.preventDefault();if(!fY){return}fX="browse_file_row";ba.ShmodelUILogger.log_with_target_file("token_share",fX,fY);return dE.shmodel(fY.fq_path,fX)};fJ=function(fY){var fX;fX=$(fY.target);if(fX.match("li.browse-file")){return fX}else{return fX.up("li.browse-file")}};fD=function(fZ){var fY,fX;fX=fJ(fZ);fY=cW.from_elem(fX);fZ.preventDefault();if(!fY){return}return eL.createAndShowMemberListModalFromBrowseFile(cu.active_user,fY)};fw=(function(fX){return function(f3){var f6,fY,fZ,f5,f4,f2,f7,f0,f1;f5=fJ(f3);fY=cW.from_elem(f5);f3.preventDefault();if(!fY){return}f4="browse_file_row";f1=ba.ShmodelUILogger.get_target_item(fY);ba.ShmodelUILogger.log("single_entry_share",f4,f1);fZ=cu.simple_sharing_enabled;f2=bF(f5).find(".inline-share-button")[0];if(!cu.in_search_mode()){f2=bF(f5).find(".sharing .inline-share-button")[0]}f0=fY.dir&&(fY.is_shared_folder()||fY.could_be_shared_folder());f6=ea.get_for_user(cu.active_user).verified_or_show();if(cu.simple_sharing_react_member_list_enabled&&f6){return eL.createAndShowInbandModalFromBrowseFile(cu.active_user,fY)}else{if(cu.simple_sharing_individual_files_enabled&&!fY.dir&&f6){return eL.createAndShowInbandModalFromBrowseFile(cu.active_user,fY)}else{if(f0){if(fZ){if(f6){return eL.createAndShowInbandModalFromBrowseFile(cu.active_user,fY)}}else{return aE.open(fY.fq_path,fY.is_shared_folder(),f2,cu.active_user,f1)}}else{f7=function(){return dE.shmodel(fY.fq_path,f4)};e2.firefly_logging_helper(fY,"single_entry_share_button_file_link");return cz.show_modal(f3,cu.active_user.id,f7)}}}}})(this);fu=function(f0){var fY,fX,fZ;fZ=$(f0.target);fX=fZ.match("li.browse-file")?fZ:fZ.up("li.browse-file");fY=cW.from_elem(fX);if(fY){return j(f0)}};fG=null;fU=function(){var fX;clearInterval(fG);fX=function(){cu.keyboard_nav=false;return $("browse-files").addClassName("mouse-active")};return fG=setTimeout(fX,100)};fL=function(){if(!cu.keyboard_nav){cu.keyboard_nav=true;return $("browse-files").removeClassName("mouse-active")}};fB=function(f4){var f0,fZ,fY,f2,f5,f1,f3,fX;fU();if(!e2.is_selecting()){return}f0=cu.files.indexOf(fs);fX=cu.files.indexOf(cW.from_elem(f4.target));cP(f0<cu.files.length&&f0>=0,"anchor_index: "+f0+" "+fs);cP(fX<cu.files.length&&fX>=0,"target_index: "+fX);fZ=cu.files.slice(Math.min(f0,fX),Math.max(f0,fX)+1);fY=fQ.slice(0);for(f1=0,f3=fZ.length;f1<f3;f1++){f5=fZ[f1];f2=fY.indexOf(f5);if(f2===-1){fY.push(f5)}else{fY.splice(f2,1)}}return fM(fY)};fC=function(fX){fs=null;return fQ=null};fA=function(fZ){var fX,fY;if(typeof Q!=="undefined"&&Q!==null){Q.reset()}fL();if(fZ){Event.extend(fZ).preventDefault()}fY=fv.length?fv.last()===cu.files.first()?cu.files.first():(fX=cu.files.indexOf(fv.last())-1,cu.files[fX]):cu.files.last();fM(fY);if(fY){return cu.scrollTo(fY.get_div())}};fI=function(fZ){var fX,fY;if(typeof Q!=="undefined"&&Q!==null){Q.reset()}fL();if(fZ){Event.extend(fZ).preventDefault()}fY=fv.length?fv.last()===cu.files.last()?cu.files.last():(fX=cu.files.indexOf(fv.last())+1,cu.files[fX]):cu.files.first();fM(fY);if(fY){return cu.scrollTo(fY.get_div())}};fS=function(f5){var fY,fZ,f3,f1,f4,f0,fX,f2;if(typeof Q!=="undefined"&&Q!==null){Q.reset()}fL();if(f5){Event.extend(f5).preventDefault()}if(fv.length>0){f4=cu.files.indexOf(fv.last());fY=cu.files.indexOf(fO);if(fO===fv.last()||fY>f4){if(f4>0){f2=[];for(f3=f1=fX=f4-1;fX<=0?f1<=0:f1>=0;f3=fX<=0?++f1:--f1){fZ=cu.files[f3];f0=fv.indexOf(fZ);fP(fZ,fO);if(f0!==-1){f2.push(fv.splice(f0,1))}else{cu.scrollTo(fZ.get_div());break}}return f2}}else{fy(fv.last());return cu.scrollTo(fv.last().get_div())}}else{return fA()}};fV=function(f6){var fY,fZ,f3,f1,f4,f0,fX,f5,f2;if(typeof Q!=="undefined"&&Q!==null){Q.reset()}fL();if(f6){Event.extend(f6).preventDefault()}if(fv.length>0){f4=cu.files.indexOf(fv.last());fY=cu.files.indexOf(fO);if(fO===fv.last()||fY<f4){f2=[];for(f3=f1=fX=f4+1,f5=cu.files.length;fX<=f5?f1<f5:f1>f5;f3=fX<=f5?++f1:--f1){fZ=cu.files[f3];f0=fv.indexOf(fZ);fP(fZ,fO);if(f0!==-1){f2.push(fv.splice(f0,1))}else{cu.scrollTo(fZ.get_div());break}}return f2}else{fy(fv.last());return cu.scrollTo(fv.last().get_div())}}else{return fI()}};fx=function(){if(typeof Q!=="undefined"&&Q!==null){Q.reset()}fM(cu.files);return false};fr=function(){if(typeof Q!=="undefined"&&Q!==null){Q.reset()}return fM(null,null,null)};fH=function(){$$(".file-select").invoke("removeClassName","file-select").invoke("removeClassName","file-select-one");return setTimeout(fR,100)};fW=function(fX){return fX.memo.files.each(function(fY){var fZ;fZ=fv.indexOf(fY[0]);if(fZ!==-1){fv.splice(fZ,1);return fP(fY[1])}})};fN=function(fX,fY){var fZ;if(cu.in_search_mode()&&fX&&fY){fZ={file_nsid:fX.ns_id,file_sjid:fX.file_sjid,firefly:cb.firefly_enabled,match_type:fX.match_type,position:fX.sort_rank,request_id:fX.request_id,viewport:"full-view",action_type:fY};return ba.SearchClientActivityLogger.log("result_action",cu.active_user.id,fZ)}};fT=function(fY,fX,fZ,f1,f5){var f4,f3,f2,f0;f3="file_row_sharing_menu";if(fX){if(ea.get_for_user(fY).verified_or_show()){ba.ShmodelUILogger.log("sf_options",f3,fZ);fN("single_entry_share_button_folder_options");f4=new dl(fY,f1);if(typeof f5==="function"){f5()}return f4.show()}}else{f0=cu.verify_email_after_share_experiment_variant;f2=f0&&f0==="VERIFY_LAST";if(f2){ba.UserActivityLogger.log("web","email_verify_last_experiment_shown")}else{if(f0){ba.UserActivityLogger.log("web","email_verify_last_experiment_not_shown")}}if(f2||ea.get_for_user(fY).verified_or_show()){ba.ShmodelUILogger.log("sf_invite",f3,fZ);fN("single_entry_share_button_folder_invite");f4=new cq(fY,{folder_name:f1,element_id:"invite-to-new-sf-wizard-modal-"+fY.id,must_check_verified:f2});if(typeof f5==="function"){f5()}return f4.show()}}};document.observe(bE.REMOVE,function(fX){return fX.memo.files.each(fy)});document.observe(bE.MOVE,fW);return{UPDATED_EVT:"db:select:updated",init:function(){var fX;document.observe("click",fu);document.observe("mousedown",i);document.observe("mouseup",fC);document.observe("dragend",fC);document.observe("mouseup",fz);$("browse-files").on("mouseover","li.browse-file",fB);$("browse-files").on("click",".shmodel-file",T);$("browse-files").on("click",".inline-share-button",fw);$("browse-files").on("click",".inline-member-list-button",fD);document.observe(e2.UPDATED_EVT,fR);document.observe(e2.UPDATED_EVT,fz);document.observe(dU.RENDER,fR);document.observe(dU.RENDER,fz);document.observe(dU.UPDATE,fM.bind(null,null,null));fX=key.main_modifier();key("up",cu.KEY_SCOPE,fA);key("down",cu.KEY_SCOPE,fI);key(fX+"+a",cu.KEY_SCOPE,fx);key("escape",cu.KEY_SCOPE,fr);key("shift+up",cu.KEY_SCOPE,fS);return key("shift+down",cu.KEY_SCOPE,fV)},set_selected_files:function(fX){return fM(fX)},get_selected_files:function(){return fv.slice(0)},get_selected_fq_paths:function(){return fv.map(function(fX){return fX.fq_path})},has_selected_files:function(){return fv.length},is_selected:function(fX){return fv.indexOf(fX)!==-1},is_selecting:function(){return !!fs},deselect_all:fE,set_context_selected:function(fX){return fK(fX)},flicker_selected:fH,firefly_logging_helper:function(fX,fY){return fN(fX,fY)},show_share_modal_if_email_verified:fT}})();aE=F.SharingGrowthExperimentsDropdown={open:function(fs,j,T,ft,fr){var i;this.fq_path=fs;this.existing_sf=j;this.button=T;this.user=ft;this.target_item=fr;this.$menu=bF("#sharing-growth-experiments-dropdown-menu");i=this.$button&&this.$button.length;if(i){if(this.$button[0]===this.button){this._hide();return}else{this._hide()}}return this._show()},_show:function(){var i;this.$menu.show();this.$button=bF(this.button);this.$button.addClass("pressed");i={offsetLeft:-1*Math.abs(this.$button.outerWidth()-this.$menu.outerWidth())+6,offsetTop:46,setWidth:false,setHeight:false};D.clone_position(this.$menu,this.$button,i);bF("#browse-box").addClass("dropdown-menu-open");return this._listen()},_listen:function(){this.$menu.on("click dblclick",function(i){return i.stopPropagation()});bF(document).on("mousedown",bF.proxy(this._click_outside_menu_callback,this));this.$menu.find(".option-to-share-folder").on("click",bF.proxy(this._sf_click,this));return this.$menu.find(".option-to-share-link").on("click",bF.proxy(this._share_link_click,this))},_unlisten:function(){this.$menu.hide().off("click dblclick");bF(document).off("mousedown",this._click_outside_menu_callback);this.$menu.find(".option-to-share-folder").off("click",bF.proxy(this._sf_click,this));return this.$menu.find(".option-to-share-link").off("click",bF.proxy(this._share_link_click,this))},_sf_click:function(j){var i;i=(function(T){return function(){return e2.show_share_modal_if_email_verified(T.user,T.existing_sf,T.target_item,T.fq_path)}})(this);this._hide();return cz.show_modal(j,this.user.id,i)},_share_link_click:function(j){var i;i=(function(T){return function(){var fr;fr="file_row_sharing_menu";ba.ShmodelUILogger.log("token_share",fr,T.target_item);T._firefly_logging_helper("single_entry_share_button_folder_link");return dE.shmodel(T.fq_path,fr)}})(this);this._hide();return cz.show_modal(j,cu.active_user.id,i)},_firefly_logging_helper:function(i){return e2.firefly_logging_helper(cu.find_file(this.fq_path),i)},_clicked:function(i,j){return i.is(j.target)||i.has(j.target).length},_click_outside_menu_callback:function(i){if(!(this._clicked(this.$menu,i)||this._clicked(this.$button,i))){return this._hide()}},_hide:function(i){this._unlisten();bF("#browse-box").removeClass("dropdown-menu-open");this.$button.removeClass("pressed");return this.$button=null}};var B;B=F.DragScroll={_timer:null,_mouse_y:0,_initial_mouse_y:null,_scroll_amount:40,_scroll_window:50,_min_drag_distance:20,_exclude_move_event:null,init:function(i,j){this._exclude_move_event=i;if(j!=null){return this._scroll_window=j}},start:function(){this._initial_mouse_y=null;this._listen();return this._timer=setInterval(this._check_for_scroll.bind(this),100)},end:function(){this._unlisten();return clearInterval(this._timer)},_mousemove:function(j){var i;if(typeof this._exclude_move_event==="function"?this._exclude_move_event(j):void 0){return this._mouse_y=0}else{i=j.pointerY();return this._mouse_y=i-D.scroll_offsets().top}},_listen:function(){document.observe("mousemove",this._mousemove.bind(this));return document.observe("dragover",this._mousemove.bind(this))},_unlisten:function(){document.stopObserving("mousemove",this._mousemove.bind(this));return document.stopObserving("dragover",this._mousemove.bind(this))},_check_for_scroll:function(){var i;if(this._initial_mouse_y===null){this._initial_mouse_y=this._mouse_y}if(Math.abs(this._mouse_y-this._initial_mouse_y)<this._min_drag_distance){return}i=0;if(this._mouse_y<this._scroll_window){i=-1*this._scroll_amount}else{if(this._mouse_y>D.viewport_dimensions().height-this._scroll_window){i=this._scroll_amount}}if(i){return D.scroll_to(D.scroll_offsets().left,D.scroll_offsets().top+i)}}};var bR;bR=F.BrowseDrag={_BODY_DRAG_CLASS:"external_drag",_STATUS_CLASS:"dragging",_STATUS_OFFSET:10,_SELECTION_CONST:"SELECTION",_current_item_key:null,_drag_from_window:false,init:function(){var i;if(!Modernizr.draganddrop){return}this.listen();i=function(T){var j;j=bF(T.target);return j.closest("#browse-location").length||j.attr("id")==="browse-location"};return B.init(i,bF("#browse-header").height())},listen:function(){var i;i=$(document.body);document.observe(dU.UPDATE,this._update_body_data.bind(this));i.on("dragleave","[dropzone]",this._dropzone_dragleave.bind(this));i.on("dragend",this._body_dragend.bind(this));i.on("dragover","[dropzone]",this._dropzone_dragover.bind(this));if(Prototype.Browser.IE){i.on("dragenter","[dropzone]",this._dropzone_dragover.bind(this));i.on("mousedown",this._ie_start_drags.bind(this));i.on("mouseover","a.filename-link",this._ie_mouseover.bind(this))}i.observe("dragover",this._body_dragover.bind(this));i.observe("dragleave",this._body_dragleave.bind(this));i.observe("dragstart",this._body_dragstart.bind(this));i.observe("mousemove",this._body_mousemove.bind(this));i.on("dragstart","li.browse-file",this._file_dragstart.bind(this));document.observe(e2.UPDATED_EVT,this._build_selected_drag_icon.bind(this));document.observe(dU.RENDER,this._build_selected_drag_icon.bind(this));i.on("mousedown","li.browse-file",this._build_file_drag_icon.bind(this));return i.on("drop","[dropzone]",this._drop.bind(this))},_file_mousemove:function(j){var i;if(!window.event||window.event.button!==1){return}i=j.findElement("[draggable]");if(i&&i!==document&&i.dragDrop){i.dragDrop();return bR._ie_end_drags()}},_ie_start_drags:function(i,j){if(j.tagName!=="OBJECT"&&$(j).match("[draggable]")){return $("browse-files").observe("mousemove",this._file_mousemove)}},_ie_end_drags:function(){return $("browse-files").stopObserving("mousemove")},_update_body_data:function(){var j,i;j=cu.inside_dir?"copy move":false;i=cu.inside_dir?cu.containing_fq_path():false;$(document.documentElement).writeAttribute("dropzone",j);return $(document.documentElement).writeAttribute("data-fq_path",i)},_body_dragover:function(j){var i;i=this._get_event_browse_files();if(i.length){return this._update_status_position(j,i)}else{if(!this._drag_from_window&&this._can_drop_transfer(j.dataTransfer)){return bp.show_drop_indicators(j)}}},_body_dragleave:function(T){var j,i,fr;i=T.x||T.clientX;fr=T.y||T.clientY;j=D.viewport_dimensions();if(!((0<i&&i<j.width)&&(0<fr&&fr<j.height))){return bp.hide_drop_indicators()}},_body_dragstart:function(){return this._drag_from_window=true},_body_dragend:function(){if($("breadcrumb-dropdown")){$("breadcrumbs-box").removeClassName("down");$("breadcrumb-dropdown").hide()}this._clear_event_browse_files();this._remove_drop_indicators();bp.hide_drop_indicators();B.end();return this._drag_from_window=false},_body_mousemove:function(){return bp.hide_drop_indicators()},_ie_mouseover:function(j,i){if(!D.focus_in_input()){return i.focus()}},_dropzone_dragover:function(ft,i){var j,T,fr,fs;if(!cR.isFileDragEnabled()){return true}ft.preventDefault();fr=this._get_event_browse_files();fs=this._target_fq_path(i);if(!fr.pluck("fq_path").indexOf(fs===-1)){return}if(!this._can_drop(ft,i)){i.addClassName("drag_nodrop");return}try{T=ft.dataTransfer.effectAllowed}catch(fu){}if(T==="move"||T==="copyMove"||T==="linkMove"||T==="all"){ft.dataTransfer.dropEffect="move"}else{ft.dataTransfer.dropEffect="copy"}ft.preventDefault();j=$$(".dragover");j.removeItem(i);j.invoke("removeClassName","dragover");if(!dZ.disabled){i.addClassName("dragover")}return bp.folder_dragover(fs)},_dropzone_dragleave:function(j,i){return this._clear_hover_state(i)},_file_dragstart:function(fv,fy){var fz,i,fA,fx,j,fu,fs,fr,fw,T;ec.clear_selected();if(e2.is_selecting()){return fv.preventDefault()}fv.dataTransfer.effectAllowed="copyMove";fv.dataTransfer.setData("URL","about:blank");fu=cW.from_elem(fy);this._set_event_browse_files(fu);fs=this._get_event_browse_files();if(fs.length<=1&&!fu.dir){T=fu.href;fr=(fu.filename||eG("file")).replace(/:/g,"-");fw="application/octet-stream";try{fv.dataTransfer.setData("DownloadURL",[fw,fr,T].join(":"))}catch(ft){}}fA=new Element("img",{src:"/static/images/icons/icon_spacer-vflN3BYt2.gif",width:1,height:1});fz=true;try{fv.dataTransfer.setDragImage(fA,150,150)}catch(fx){j=fx;fz=ec.ie8}this._add_drop_indicators(fv);B.start();if(fz){this._update_status_position(fv,fs);i=$("drag-status");i.removeClassName("rotatein").removeClassName("fadein").removeClassName("selection");if(fs.length>1){i.addClassName("rotatein")}if(this._is_dragging_selection()){i.addClassName("selection")}return i.addClassName("fadein")}},_add_drop_indicators:function(ft){var fu,T,i,fs,fr;$(document.body).addClassName(this._STATUS_CLASS);if(!dZ.disabled){fs=$$('[dropzone="copy move"]');fr=[];for(T=0,i=fs.length;T<i;T++){fu=fs[T];if(this._can_drop(ft,fu)){fr.push(fu.addClassName("can_drop"))}else{fr.push(void 0)}}return fr}},_remove_drop_indicators:function(){this._clear_hover_state();$(document.body).removeClassName(this._STATUS_CLASS);return $$(".can_drop").invoke("removeClassName","can_drop")},_build_selected_drag_icon:function(){var T,fu,fz,ft,fw,fA,fv,fy,fx,fs,fr;fr=e2.get_selected_files();fz=new Element("div",{id:"drag-selection-status"});fs=fr.slice(0,4);for(fw=fv=0,fy=fs.length;fv<fy;fw=++fv){fu=fs[fw];T=fu.get_div();if(!T){continue}fx=T.down(".icon");fx.stopObserving("load");fx.observe.bind(fx).defer("load",bR._build_selected_drag_icon);fA=fx.cloneNode(false);Element.addClassName(fA,"icon icon"+fw);fz.__sert(fA)}ft=new Element("span",{className:"badge"});ft.__date(fr.length);fz.appendChild(ft);return $("drag-selection-status").replace(fz)},_build_file_drag_icon:function(fs,i){var j,ft,fr,T;j=cW.from_elem(i);T=j.get_div().down(".icon").cloneNode(false);Element.addClassName(T,"icon icon0");fr=new Element("span",{className:"badge"});fr.__date("1");ft=new Element("div",{id:"drag-file-status"});ft.__date(T).__sert(fr);return $("drag-file-status").replace(ft)},_drop:function(fy,fB){var fz,ft,fE,fC,fF,fw,fD,fv,fs,fu,fx,T,fA,i,fr;ft=this._get_event_browse_files();if(this._linkfile_drop_enabled()){fw=cR.getDraggedLink(fy.dataTransfer)}if(fw!=null){i=cR.buildUrlLinkfileContents(fw);fA=new Blob([i],{type:"text/plain"});T=H.parse(fw).getAuthority();fA.name=cu.unused_filename(T+".url");fA.overwrite=false;fD=[fA];ba.LinkfileActivityLogger.log("droplink","url",T,true,"browse",{})}else{fD=fy.dataTransfer.files;fv=fy.dataTransfer.items}fy.preventDefault();if(fB.readAttribute("quicksend")){if(fD&&fD.length){fE=function(){return bp.upload(aa.DEST_FOLDER,fD,fv)};aa.get_folder_name(fE)}else{if(ft.length){for(fu=0,fx=ft.length;fu<fx;fu++){fs=ft[fu];fs.id=q.guid();aa.add_dropbox_file(fs)}}}return}if(this._is_read_only(fB)){fr=eG("You don't have permission to add to this folder.");ah.error(fr);return}if(cu.inside_read_only_shared_folder){fr=eG("You don\u2019t have permission to move these files.");ah.error(fr);return}fC=null;fF=cW.from_elem(fB);fz=fB.readAttribute("data-fq_path");if(fF){fC=fF.fq_path}else{if(fz||fz===""){fC=fz}}if(fD&&fD.length){if(!bp.supported()){ah.error(eG("Drag and drop not supported. Please try the simple uploader."))}else{if(!bp.browse_indicators_enabled()&&!bp.modal_indicators_enabled()){ah.error(eG("You can't drag and drop upload right now."))}else{bp.upload(fC,fD,fv)}}}else{if(ft.length){if((fy.dataTransfer.dropEffect==="copy")||(fy.dataTransfer.effectAllowed==="copy")){dK.do_bulk_copy(ft,fC)}else{if(!cu.inside_dir||cu.containing_fq_path()!==fC){dK.do_bulk_move(ft,fC)}}}}this._remove_drop_indicators();return bp.hide_drop_indicators()},_set_event_browse_files:function(i){var j;j=e2.is_selected(i);return this._current_item_key=j?this._SELECTION_CONST:i.to_key()},_clear_event_browse_files:function(){return this._current_item_key=null},_get_event_browse_files:function(){var i,fr,T,j;try{j=this._current_item_key;if(this._is_dragging_selection()){return e2.get_selected_files()}else{if(j){T=cW.from_key(j);return(T?[T]:[])}}}catch(i){fr=i;console.log(fr)}return[]},_is_dragging_selection:function(){return this._current_item_key&&this._current_item_key===this._SELECTION_CONST},_is_read_only:function(i){if(i.readAttribute("read_only")){return true}if(i.readAttribute("is_read_only_mount")){return true}return false},_linkfile_drop_enabled:function(){return az.getGandalfRule("docpreview-linkfile-drop")&&(typeof Blob!=="undefined"&&Blob!==null)},_can_drop_transfer:function(j){var i;i=["Files"];if(this._linkfile_drop_enabled()){i.push.apply(i,["text/x-moz-url","text/uri-list","Url"])}return bx.intersection(j!=null?j.types:void 0,i).length>0},_can_drop:function(fr,j){var i,T;if(j.readAttribute("quicksend")){return true}if(this._is_read_only(j)){return false}i=this._target_fq_path(j);T=this._get_event_browse_files();if(T.length){return !dK.bulk_move_error(T,i)}else{if(this._can_drop_transfer(fr.dataTransfer)){bp.supported();return true}else{return false}}},_target_fq_path:function(i){var j;j=cW.from_elem(i);if(j){return j.fq_path}else{return i.readAttribute("data-fq_path")}},_clear_hover_state:function(fs){var ft,T,i,fr;fr=$$("#browse .dragover");for(T=0,i=fr.length;T<i;T++){ft=fr[T];if(ft!==fs){ft.removeClassName("dragover")}}return $$("#browse .drag_nodrop").invoke("removeClassName","drag_nodrop")},_update_status_position:function(i){i=Event.extend(i);return ec.scry("drag-status").setStyle({left:(i.pointerX()-D.scroll_offsets().left+this._STATUS_OFFSET)+"px",top:(i.pointerY()-D.scroll_offsets().top+this._STATUS_OFFSET)+"px"})}};var Q;Q=F.BrowseJump={_active:"",_listening:false,_RESET_WAIT:1000,_RESET_TIMER_ID:null,_CODEPOINTS:null,_BLACKLIST:["/","\\",":","?","*","<",">","|"].map(function(i){return i.charCodeAt(0)}),update:function(){var fs,fu,fr,T,i,ft;if(!Q._listening){Q.listen();Q._listening=true}fs=[];ft=cu.files;for(T=0,i=ft.length;T<i;T++){fr=ft[T];fu=Q.to_codepoint_list(fr.filename);fs.push([fu,fr])}fs.sort(function(fv,j){return Q.cmp_codepoints(fv[0],j[0])});return Q._CODEPOINTS=fs},reset:function(){return Q._active=""},is_active:function(){return Q._active},jump:function(i){if(i){e2.set_selected_files([i]);return cu.scrollTo(i.get_div())}},listen:function(){var ft,T,i,fs,fr;document.observe("keypress",function(fu){var j;if(key.getScope()!==cu.KEY_SCOPE){return}if(D.focus_in_input()||fu.metaKey||fu.altKey||fu.altGraphKey||fu.ctrlKey){return}j=fu.charCode||fu.keyCode;if(j<32){return}if((33<=j&&j<=40)){return}if(j===32){if(Q._active){fu.preventDefault()}else{return}}if(Q._BLACKLIST.indexOf(j)!==-1){return}clearTimeout(Q._RESET_TIMER_ID);Q._active+=String.fromCharCode(j).toLowerCase();Q.jump(Q.nearest_file(Q._active));return Q._RESET_TIMER_ID=setTimeout(Q.reset,Q._RESET_WAIT)});fs=[aH.DELETE,aH.COPY,aH.MOVE,aH.RENAME,aH.PURGE,aH.RESTORE,aH.UPLOAD,aH.SF_NEW,aH.SF_LEAVE,aH.SF_UNSHARE,aH.SF_REJOIN,aH.SF_IGNORE,aH.LINKS_REMOVE,bE.ADD,bE.REMOVE,bE.MOVE];fr=[];for(T=0,i=fs.length;T<i;T++){ft=fs[T];document.observe(ft,function(j){return Q.update()});fr.push(bF(document).on(ft,function(j){return Q.update()}))}return fr},nearest_file:function(fx){var ft,fr,i,fs,fv,T,fw,fu;if((T=Q._CODEPOINTS)!=null?T.length:void 0){ft=Q.to_codepoint_list(fx);fw=Q._CODEPOINTS;for(fs=0,fv=fw.length;fs<fv;fs++){fu=fw[fs],i=fu[0],fr=fu[1];if(Q.cmp_codepoints(ft,i)<1){return fr}}Q._CODEPOINTS.last()[1]}return null},cmp_codepoints:function(fu,ft){var fr,T,fs;cP(fu.length>0&&ft.length>0,"bad input to cmp_codepoints");for(fr=T=0,fs=fu.length;0<=fs?T<fs:T>fs;fr=0<=fs?++T:--T){if(ft[fr]==null){return 1}if(fu[fr]!==ft[fr]){return(fu[fr]<ft[fr]?-1:1)}}if(ft.length>fu.length){return -1}else{return 0}},to_codepoint_list:function(fr){var ft,fs,fu,T;fr=fr.toLowerCase();T=[];for(ft=fs=0,fu=fr.length;0<=fu?fs<fu:fs>fu;ft=0<=fu?++fs:--fs){T.push(fr.charCodeAt(ft))}return T}};var bn;bn=F.ContextMenu={KEY_SCOPE:"context",SHOW_EVT:"db:contextmenu:show",HIDE_EVT:"db:contextmenu:hide",_prev_key_scope:null,listen:function(){bF(document).click(this.hide_on_click);bF(document).on(dU.UPDATE,this.hide_on_click);return key("esc",this.KEY_SCOPE,(function(i){return function(j){return bn.hide()}})(this))},unlisten:function(){bF(document).off("click",this.hide_on_click);return bF(document).off(dU.UPDATE,this.hide_on_click)},hide_on_click:function(i){if(!(i.which===3||bF(i.target).parents("#context-menu").length)){return bn.hide()}},show_for_file:function(i,fr,T){var fs,j;cu.keyboard_nav=false;this.hide();fs=cW.from_elem(T);j=e2.is_selected(fs)?e2.get_selected_files():(e2.deselect_all(),[fs]);e2.set_context_selected(j);return this._show(fr,new i(j))},show_global:function(i,j){this.hide();return this._show(j,new i())},show_shmodel:function(fu){var ft,j,i,T,fr,fs;ft=["get_original"];fr=fu.findElement("img");if((fr.readAttribute("enable-download"))==="true"){T=fr.readAttribute("data-original-href");j=[]}else{T="";j=["get_original"]}this.hide();fs={get_original:{icon:"download",text:eG("Download original"),href:T}};i=Class.create({get_action_names:function(){return ft},get_disabled_action_names:function(){return j},get_action_by_name:function(fv){var fw;fw=fs[fv];fw.name=fv;return fw}});return this._show(fu,new i())},show_for_lightbox:function(fv){var fu,j,i,fs,T,ft,fr;fu=["download","view_original"];this.hide();T=fv.findElement("img");if((T.readAttribute("enable-download"))==="false"){j=["download","view_original"];fs="";fr=""}else{j=[];fs=H.parse(T.readAttribute("data-original-href")).updateQuery({dl:1}).toString();fr=T.readAttribute("data-original-href")}ft={download:{icon:"download",text:eG("Download"),href:fs},view_original:{icon:"view_original",text:a5.append_ellipsis(eG("View original")),href:fr,target:"_blank"}};i=Class.create({initialize:function(){return this._listen()},_listen:function(){var fw;fw=$("context-menu-container");fw.stopObserving("click");fw.stopObserving("contextmenu");fw.on("click",".action button",this._click.bind(this));return fw.on("contextmenu",".action button",this._click.bind(this))},_click:function(fA,fx){var fz,fw,fy;fz=fx.readAttribute("data-value");fw=ft[fz];bn.hide();fA.preventDefault();return(fy=fw.click_handler)!=null?fy.call(this,fA):void 0},get_action_names:function(){return fu},get_disabled_action_names:function(){return j},get_action_by_name:function(fw){var fx;fx=ft[fw];fx.name=fw;return fx}});return this._show(fv,new i())},show_photos:function(fw,fA){var fz,j,ft,fs,fy,fx,i,T,fr,fv,fu;this.hide();fs={divider:{type:"divider"},choose_album:{icon:"album_16",text:a5.append_ellipsis(eG("Add %(num_photos)s to album").format({num_photos:fA.length})),click_handler:function(fB){cN.show_add_to_album_modal(fB,fA);return g.log_interaction(er.ADD_TO_OTHER_ALBUM,dh.PCM,{num_photos:fA.length})}},remove:{icon:"album_delete_16",text:eG("Remove %(num_photos)s from album").format({num_photos:fA.length}),click_handler:function(){cN.show_remove_photos_modal(bQ.get_current_collection(),fA);return g.log_interaction(er.REMOVE,dh.PCM,{num_photos:fA.length})}},set_cover:{icon:"album_16",text:eG("Set as cover"),click_handler:function(){bQ.get_current_collection().set_cover(fA[0]);return g.log_interaction(er.SET_AS_COVER,dh.PCM,{num_photos:1})}},edit_timestamp:{text:"Edit timestamp",click_handler:function(){return bQ.show_timestamps_modal(fA)}}};if(bQ.in_single_collection_view()){fz=["share","choose_album","remove"];if(fA.length===1){fz.unshift("divider");fz.unshift("set_cover")}}else{fz=["share","choose_album"];fz.push("divider");fz.push("delete");if(bQ.timestamp_edit_enabled){fy=(function(){var fD,fB,fC;fC=[];for(fD=0,fB=fA.length;fD<fB;fD++){T=fA[fD];if(T.time_taken==null){fC.push(T)}}return fC})();if(fy.length===0){fz.push("edit_timestamp")}else{if(fy.length===fA.length){fs.edit_timestamp.text="Set timestamp";fz.push("edit_timestamp")}}}}if(fA.length===1){fr=de.categorize_files(fA),fx=fr[0],i=fr[1];if(fx){fu=a5.append_ellipsis(eG("Share photo"))}else{fu=a5.append_ellipsis(eG("Share video"))}Object.extend(fs,{share:{icon:"s_link",text:fu,click_handler:function(fB){eF.show(fA,false);return g.log_interaction(er.SHARE,dh.PCM,{num_photos:1})}},"delete":{text:a5.append_ellipsis(eG("Delete")),click_handler:function(){bQ.show_delete_photos_modal(fA);return g.log_interaction(er.DELETE,dh.PCM,{num_photos:1})}},show_in_folder:{text:a5.append_ellipsis(eG("Show in folder")),click_handler:function(){bQ.show_in_folder(fA[0]);return g.log_interaction(er.SHOW_IN_FOLDER,dh.PCM,{num_photos:1})}}});if(bQ.in_single_collection_view()){fz.push("divider")}fz.push("show_in_folder")}else{fv=de.categorize_files(fA),fx=fv[0],i=fv[1];if(fx&&i){fu=bd("Share %(file_count)s item","Share %(file_count)s items",fA.length);ft=bd("Delete %(file_count)s item","Delete %(file_count)s items",fA.length)}else{if(fx){fu=bd("Share %(file_count)s photo","Share %(file_count)s photos",fA.length);ft=bd("Delete %(file_count)s photo","Delete %(file_count)s photos",fA.length)}else{fu=bd("Share %(file_count)s video","Share %(file_count)s videos",fA.length);ft=bd("Delete %(file_count)s video","Delete %(file_count)s videos",fA.length)}}fu=fu.format({file_count:fA.length});ft=ft.format({file_count:fA.length});Object.extend(fs,{share:{icon:"s_link",text:fu,click_handler:function(fB){bQ._share_selected();return g.log_interaction(er.SHARE,dh.PCM,{num_photos:fA.length})}},"delete":{text:ft,click_handler:function(fB){bQ.show_delete_photos_modal(fA);return g.log_interaction(er.DELETE,dh.PCM,{num_photos:fA.length})}}})}j=Class.create({initialize:function(){return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(fF,fD){var fE,fC,fB;fE=fD.readAttribute("data-value");fC=fs[fE];if(fF.clientX===0&&fF.clientY===0){return}bn.hide();return(fB=fC.click_handler)!=null?fB.call(this,fF):void 0},get_action_names:function(){return fz},get_disabled_action_names:function(){return[]},get_action_by_name:function(fB){var fC;fC=fs[fB];fC.name=fB;return fC}});return this._show(fw,new j())},show_photo_collection:function(fr,fs,ft){var T,i,j;this.hide();if(fs.is_anonymous){T=["go_to_link","unshare"]}else{if(fs.is_creator){T=["share","rename"];if(fs.share_tkey!=null){T.push("unshare")}T.push("delete")}else{T=["share"]}}j={share:{icon:"s_link",text:a5.append_ellipsis(eG("Share album")),click_handler:function(fu){if(fs.num_items===0){ah.error(eG("This album is empty. Add some photos before you share it!"));return}eF.show(fs,true);return g.log_interaction(er.SHARE_ALBUM,dh.CCM,{num_photos:fs.num_photos})}},unshare:{icon:"lock",text:a5.append_ellipsis(fs.is_anonymous?eG("Unshare"):eG("Unshare album")),click_handler:function(fu){cN.show_unshare_modal(fs);return g.log_interaction(er.UNSHARE_ALBUM,dh.CCM,{num_photos:fs.num_photos})}},rename:{icon:"pencil",text:eG("Rename album"),click_handler:function(fu){fs.rename(ft.down(".collection-name"));return g.log_interaction(er.RENAME_ALBUM,dh.CCM,{num_photos:fs.num_photos})}},"delete":{icon:"album_delete_16",text:a5.append_ellipsis(eG("Delete album")),click_handler:function(fu){cN.show_delete_modal(fs);return g.log_interaction(er.DELETE_ALBUM,dh.CCM,{num_photos:fs.num_photos})}},go_to_link:{icon:"s_link",text:eG("Go to link"),click_handler:function(fu){cN.go_to_link(fs);return g.log_interaction(er.GO_TO_ALBUM_LINK,dh.CCM,{num_photos:fs.num_photos})}}};i=Class.create({initialize:function(){return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(fy,fv){var fx,fu,fw;fx=fv.readAttribute("data-value");fu=j[fx];bn.hide();return(fw=fu.click_handler)!=null?fw.call(this):void 0},get_action_names:function(){return T},get_disabled_action_names:function(){return[]},get_action_by_name:function(fu){var fv;fv=j[fu];fv.name=fu;return fv}});return this._show(fr,new i())},_show:function(fF,fu,fD){var fA,fC,fr,fG,T,fz,fB,fE,ft,fy,fs,fw,fv,fH,fx;if(fD==null){fD=false}fx=((fF!=null?(fs=fF.target)!=null?fs.tagName.toUpperCase():void 0:void 0)==="INPUT")&&((fF!=null?(fw=fF.target)!=null?fw.type.toUpperCase():void 0:void 0)==="TEXT")||((fF!=null?(fv=fF.target)!=null?fv.tagName.toUpperCase():void 0:void 0)==="TEXTAREA");fz=["#page-footer","#account-header","#browse-global-actions-bar","#modal","#modal-overlay","#file-preview-modal","#file-viewer","#react-file-viewer","#notify-wrapper",".db-modal-wrapper","#sharing-growth-experiments-dropdown-menu",".inline-share-button",".inline-member-list-button","#wizard-overlay","#react-bubble-dropdown-root",".preview-sf-members-box",".db-modal",".db-modal-overlay",".waiting_for_items"];fH=$(fF.target);if(bF(fH).parents("#context-menu").length){return}fA=bF("#file-preview-modal");if(!(fA.find(fH).length&&bF(fH).is("img"))){for(fC=0,fE=fz.length;fC<fE;fC++){T=fz[fC];fG=$$(T);if(fG){for(fB=0,ft=fG.length;fB<ft;fB++){fr=fG[fB];if(fH.descendantOf(fr)||fH.match(T)){return}}}}}if((fF!=null?fF.shiftKey:void 0)||fx){return}else{Event.stop(fF)}if(this._context_menu_tmpl==null){this._context_menu_tmpl=fm.tmpl("context_menu_tmpl")}if(!fu.get_action_names().length){return}eZ.hide_all();$("context-menu-container").__date(this._context_menu_tmpl({context:fu,actions:(function(){var fI,j,i,fJ;i=fu.get_action_names();fJ=[];for(fI=0,j=i.length;fI<j;fI++){fy=i[fI];fJ.push(fu.get_action_by_name(fy))}return fJ})(),disabled_actions:fu.get_disabled_action_names(),big:fD,Sprite:cy}));this.position_at(fF.clientX,fF.clientY);$("context-menu-container").show();this.listen();this._prev_key_scope=key.getScope();key.setScope(this.KEY_SCOPE);return document.fire(this.SHOW_EVT)},position_at:function(T,ft){var j,i,fr,fs;fs=D.viewport_dimensions();i=parseInt($("context-menu").getStyle("width"),10);j=parseInt($("context-menu").getStyle("height"),10);fr=15;if(T+i>fs.width-fr){$("context-menu").setStyle({left:(fs.width-i-fr)+"px"})}else{$("context-menu").setStyle({left:T+"px"})}if(ft+j>fs.height-fr){return $("context-menu").setStyle({top:(fs.height-j-fr)+"px"})}else{return $("context-menu").setStyle({top:ft+"px"})}},hide:function(){if(!$("context-menu-container").empty()){this.unlisten();e2.set_context_selected([]);$("context-menu-container").__date();if(key.getScope()===this.KEY_SCOPE){key.setScope(this._prev_key_scope)}return document.fire(this.HIDE_EVT)}}};var dv,cu,l,aL,ay,cZ,cn,cX=[].indexOf||function(fr){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fr){return T}}return -1};dv=F.BROWSE_SNIPPET_LEN=25;cn=F.SEARCH_SNIPPET_LEN=20;aL=F.COMMENT_COUNT_SNIPPET_LEN=3;cZ=F.LAST_MODIFIED_FNAME_SNIPPET=4;ay=[bq.FILES_BY_NAME,true,"FILES_BY_NAME"];cu=INLINE_JS.Browse=F.Browse={KEY_SCOPE:"browse",SCROLL_DURATION:0.5,msg:false,files:[],reloading:false,creating_folder:false,first_load:true,last_sort:ay,folder_loading_notification:null,folder_loading_timeout:null,keyboard_nav:false,paginating:false,is_initialized:false,init:function(j,fu,fr,ft,i,fs,T){this.browse_actions_ctor=fu;this.global_actions_ctor=fr;this.browse_actions_context_ctor=ft;this.global_actions_context_ctor=i;this.ns_id_to_mount_point=fs;cP(typeof T==="number","a user_id was not passed into Browse.init",true,[],false);this.active_user=cQ.get_viewer().get_user_by_id(T);__CIRCULAR_DEPENDENCY__.active_user_loaded=true;cP(this.active_user,"No active_user was found in Browse.init",true,[],false);this.unselectable();this.listen();D.viewport_dimensions();if(b1.chrome){this.browser_supports_previews=j&&ec.pdf_plugins().length}else{this.browser_supports_previews=j}this.compiled_search_tmpl=fm.tmpl("search_list_item_tmpl");cG.AuthenticatedRequest({url:H({path:"/flash_detect_log"}),data:{installed:FlashDetect.installed,major:FlashDetect.major,minor:FlashDetect.minor,revision:FlashDetect.revision,revisionStr:FlashDetect.revisionStr,raw:FlashDetect.raw}});return this.is_initialized=true},setup:function(i,T){var j;if(T==null){T=null}if(i==null){this._setup_actions();return}this.ns_id_to_mount_point=i.ns_id_to_mount_point;this.old_path_to_ns_id=i.old_path_to_ns_id;this.compiled_tmpl=fm.tmpl("list_item_tmpl");this.render_timeout=null;this.inside_root_folder=i.containing_fq_path==="";this.inside_dir=i.inside_dir;this.inside_deleted_dir=i.inside_deleted_dir;this.inside_shared_folder=i.inside_shared_folder;this.can_nest_in_containing_ns=i.can_nest_in_containing_ns;this.inside_read_only_shared_folder=i.inside_read_only_shared_folder;this.inside_sandbox=i.inside_sandbox;this.public_app_token=i.public_app_token;this.public_folder_enabled=i.public_folder_enabled;this.inside_deleted_sandbox=i.inside_deleted_sandbox;this.inside_deleted_shared_folder=i.inside_deleted_shared_folder;this.inside_team_folder=i.inside_team_folder;this.is_read_only=i.is_read_only;this.permanent_delete_is_disabled_by_ns_id=i.permanent_delete_is_disabled_by_ns_id;this.contents_cache_key=i.contents_cache_key;j="inside_deleted_dir";if(this.inside_deleted_dir){$("browse").addClassName(j)}else{$("browse").removeClassName(j)}this.block_hash=i.block_hash;this.block_hash_param=i.block_hash_param;if(this.inside_dir){this._containing_ns_id=i.containing_ns_id;this._containing_ns_path=i.containing_ns_path;this._containing_fq_path=i.containing_fq_path;this._containing_mount_point=i.containing_mount_point;this._containing_sf_perm_role=i.containing_sf_perm_role;this.breadcrumb();this._setup_actions();if(!(i.file_info||i.paginated)){this.show_message(eG('<h3>This folder is empty</h3> Add files using the <a href="/install">desktop application</a> or the upload button above.'))}}if(i.paginated){return this._start_pagination(i.first_page)}else{return this._push_files(i.file_info,T)}},_setup_actions:function(){var fs,T,i,fr;fr=[this.browse_actions,this.global_actions];for(T=0,i=fr.length;T<i;T++){fs=fr[T];if(fs!=null){fs.unlisten()}}this.browse_actions=new this.browse_actions_ctor();return this.global_actions=new this.global_actions_ctor()},entered_search:function(){return this._stop_pagination()},_start_pagination:function(j){var i;if(j.unsupported_sort!=null){this.reset_sort()}this.paginating=true;i=cu.active_user.id;this.pagination_manager=new fq();this.pagination_manager.initialize(j,"sjid","/browse_get_next",i,(function(T){return function(fr,fs){return T._new_data_available(fr,fs)}})(this));this.pagination_manager.startAutoFetching();bF("#more-loading").show();return this.disable_sorting()},_stop_pagination:function(){if(!this.paginating){return}this.paginating=false;this.pagination_manager.stopAutoFetching();this.pagination_manager=null;bF("#more-loading").hide();this.enable_sorting();return this._stop_waiting_for_items()},_new_data_available:function(fr,j){var T,i;if(!this.paginating){return}i=this._push_files(j);if(az.getGandalfRule("file-viewer-react")){e6.updateFiles(this.files)}if(!this.in_search_mode()){this.smartfill();a5.load_visible_thumbs();this.fire_visible_change_callbacks()}T=fr.loadedPageCount()===1;if(!T){if(this._is_item_selection_needed()){if(this._are_all_selected_items_fetched()||fr.areAllItemsReady()){this._stop_waiting_for_items();this.set_selection_from_fq_paths_or_index(cu)}}document.fire(dU.NEW_PAGE,{page_files:i});bF(document).trigger(dU.NEW_PAGE,{page_files:i})}if(fr.areAllItemsReady()){return this._stop_pagination()}},_is_item_selection_needed:function(){return(this.select_fq_paths&&this.select_fq_paths.length>0)||(this.select_index>-1)},_are_all_selected_items_fetched:function(i){var fx,fy,fv,ft,fs,fw,fu,fr,T;if(i==null){i=this.files}if(this.select_fq_paths&&this.select_fq_paths.length>0){T=this.select_fq_paths;for(ft=0,fw=T.length;ft<fw;ft++){fx=T[ft];fv=false;fr=fx.toLowerCase();for(fs=0,fu=i.length;fs<fu;fs++){fy=i[fs];if(fy.fq_path.toLowerCase()===fr){fv=true;break}}if(!fv){return false}}return true}else{if(this.select_index>-1){return this.select_index<i.length}}return cP(0,"Expected something to select (@select_index or @select_fq_paths)")},_wait_for_items:function(){bF("#waiting-for-items").show();bF("#global-actions").addClass("disabled");return bF("body").addClass("waiting_for_items")},_stop_waiting_for_items:function(){bF("body").removeClass("waiting_for_items");bF("#global-actions").removeClass("disabled");return bF("#waiting-for-items").hide()},_push_files:function(fs,fv){var fu,T,ft,fr,i;if(fv==null){fv=null}T=[];for(fr=0,i=fs.length;fr<i;fr++){ft=fs[fr];fu=a5.make_browsefile(ft,fv);fu.track_in_browse();T.push(fu)}Q.update();return T},_get_helper:function(i){cP(this.inside_dir,"accessed "+i+", but not inside a directory");return cu[i]},containing_ns_id:function(){return this._get_helper("_containing_ns_id")},containing_ns_path:function(){return this._get_helper("_containing_ns_path")},containing_mount_point:function(){return this._get_helper("_containing_mount_point")},containing_fq_path:function(){if(!this.inside_dir){return""}return this._get_helper("_containing_fq_path")},containing_sf_perm_role:function(){return this._get_helper("_containing_sf_perm_role")},listen:function(){var fE,fC,T,ft,fx,fw,fA,fy,fv,fs,fr,fB,fz,fu,fD,i;bF("#fulltext-search-all-link").click(this.unscoped_search);bF("#noresults-search-all-link").click(this.unscoped_search);$("browse-files").on("click","li.browse-file",this.click.bind(this));$("browse-files").on("dblclick","li.browse-file",this.dblclick.bind(this));$("browse-files").on("contextmenu","li.browse-file",bn.show_for_file.bind(bn,this.browse_actions_context_ctor));this.enable_sorting();fu="#browse-sort a.sortable-column-header";ec.add_sort_arrow_mouseover($("name-sorter"),true,fu,false);Event.observe(window,"scroll",this.window_scroll.bind(this));Event.observe(window,"resize",this.updateOffset.bind(this));$(document.body).on("click","a.crumb",this.crumb_click.bind(this));$("browse-files").on("click","a.parent-dir",this.parent_click.bind(this));document.observe("contextmenu",bn.show_global.bind(bn,this.global_actions_context_ctor));document.observe(e2.UPDATED_EVT,this.selection_handler.bind(this));document.observe(aH.COPY,(function(j){return function(fF){if(j.inside_dir&&fF.memo.to_fq_path===j.containing_fq_path()){return j.force_reload()}}})(this));fr=[aH.MOVE,aH.RESTORE,aH.UPLOAD,aH.SF_NEW,aH.SF_REJOIN,aH.SF_IGNORE,aH.LINKS_REMOVE,aH.LINKS_ADD];for(fx=0,fA=fr.length;fx<fA;fx++){T=fr[fx];ft=(function(j){return function(fF){if(j.inside_dir&&!cu.in_search_mode()){return j.force_reload()}}})(this);document.observe(T,ft);bF(document).on(T,ft)}fB=[aH.SF_LEAVE,aH.SF_UNSHARE];for(fw=0,fy=fB.length;fw<fy;fw++){T=fB[fw];document.observe(T,(function(j){return function(fF){if(j.inside_dir){if(fF.memo.target_ns_id===j.containing_ns_id()){if(fF.memo.folder_deleted){return j.reload_fqpath("")}else{return j.reload_fqpath(j.containing_fq_path())}}else{return j.force_reload()}}}})(this))}fz=[aH.DELETE,aH.PURGE];for(fs=0,fv=fz.length;fs<fv;fs++){T=fz[fs];document.observe(T,(function(j){return function(fN){var fI,fK,fJ,fH,fF,fG,fM,fL;if(j.inside_dir){if(fN.eventName===aH.PURGE||(fN.eventName===aH.DELETE&&!a4.get_del())){for(fK=fH=fM=j.files.length-1;fM<=0?fH<=0:fH>=0;fK=fM<=0?++fH:--fH){if(fN.memo.files.indexOf(j.files[fK])===-1){fF=j.files[fK]}else{break}}e2.deselect_all();fL=fN.memo.files;for(fG=0,fJ=fL.length;fG<fJ;fG++){fI=fL[fG];fI.get_div().remove();j.files.removeItem(fI)}if(j.files.length){if(fF!=null){return e2.set_selected_files(fF)}else{return e2.set_selected_files(j.files.last())}}else{return j.show_empty()}}else{if(j.keyboard_nav){j.select_fq_paths=[j.containing_fq_path()+"/"+fN.memo.files.last().filename]}return j.force_reload()}}}})(this))}document.observe(bn.SHOW_EVT,this.disable_sorting.bind(this));document.observe(bn.HIDE_EVT,this.enable_sorting.bind(this));fE=function(){var fF,j;fF=$("browse-header");j=fF.cumulativeOffset().top+fF.getHeight();return D.viewport_dimensions().height-j};key("pagedown",this.KEY_SCOPE,function(j){Event.extend(j).preventDefault();return window.scrollBy(0,fE())});key("pageup",this.KEY_SCOPE,function(j){Event.extend(j).preventDefault();return window.scrollBy(0,-1*fE())});fD=function(){var j;j=cu.in_search_mode()?cb:cu;if(cu.files.length===0){return j.show_empty()}else{return j.hide_empty()}};document.observe(bE.ADD,(function(j){return function(fI){var fH,fG,fJ,fF;fF=fI.memo.files;for(fJ=0,fG=fF.length;fJ<fG;fJ++){fH=fF[fJ];j.insert_file(fH,true)}return fD()}})(this));document.observe(bE.REMOVE,(function(j){return function(fI){var fH,fG,fJ,fF;fF=fI.memo.files;for(fJ=0,fG=fF.length;fJ<fG;fJ++){fH=fF[fJ];j.remove_file(fH)}return fD()}})(this));document.observe(bE.MOVE,(function(j){return function(fL){var fO,fF,fI,fG,fM,fK,fJ,fH,fN;fF=j.in_search_mode();fK=fL.memo.files;fH=[];for(fG=0,fI=fK.length;fG<fI;fG++){fJ=fK[fG],fO=fJ[0],fN=fJ[1];if(fF){if(fO!=null){fM=j.get_file_pos(fO)}else{continue}}j.remove_file(fO);j.insert_file(fN);if(fF&&fM>=0){fH.push(j.update_file_pos(fN,fM))}else{fH.push(void 0)}}return fH}})(this));bF(document).on(aH.COMPRESS,(function(j){return function(fH,fG){var fF;j.force_reload();if(fG.compressed_files.length===1&&fG.original_files.length===1){fF=a5.make_browsefile(fG.compressed_files.first());return j.preview_compressed(fF,fG.original_files.first())}}})(this));fC=this.fire_visible_change_callbacks.bind(this);bF(window).on("resize",fC);this._last_visible_change_timeout_id=null;i=(function(j){return function(fF){clearTimeout(j._last_visible_change_timeout_id);return j._last_visible_change_timeout_id=setTimeout(fC,250)}})(this);return bF(window).on("scroll",i)},disable_sorting:function(){$("browse-sort").stopObserving("click");return $$("#browse-sort *").invoke("setStyle",{cursor:"default"})},enable_sorting:function(){$("browse-sort").stopObserving("click");$("browse-sort").on("click","#browse-sort a.sortable-column-header",this.sort_handler.bind(this));return $$("#browse-sort *").invoke("setStyle",{cursor:"pointer"})},click:function(T,fs){var i,j,fr;i=bF(T.target);if(i.is("img.icon")||i.closest("a.filename-link").length>0||i.closest(".filename-col__comment-count-bubble").length>0){this._click(T,fs)}if(i.is("a.parent-dir")){j=cW.from_elem(fs);if(j){fr={file_nsid:j.ns_id,file_sjid:j.sjid,firefly:cb.firefly_enabled,match_type:j.match_type,position:j.sort_rank,request_id:j.request_id,viewport:"full-view",action_type:"click_path_link"};return ba.SearchClientActivityLogger.log("result_action",cu.active_user.id,fr)}}},dblclick:function(i,j){if($(i.target).match("a")){return}return this._click(i,j)},open_file:function(fr,i,T,j){var fs;if(T==null){T=false}if(j==null){j=Constants.OREF_CONSTANTS.BROWSE_UNKNOWN}fs={file_nsid:fr.ns_id,file_sjid:fr.sjid,firefly:cb.firefly_enabled,match_type:fr.match_type,position:fr.sort_rank,request_id:fr.request_id,viewport:T?"dropdown-view":"full-view"};if(fr.dir){if(this.in_search_mode()||T){fs.action_type="folder_open";ba.SearchClientActivityLogger.log("result_action",cu.active_user.id,fs)}if(i){this.open_folder_in_new_window(fr)}else{this.open_folder(fr)}return ba.TimeToFirstActionLogger.log(cu.active_user.id,"folder_open")}else{if(!i&&this.can_show_preview(fr)){if(this.in_search_mode()||T){fs.action_type="file_view";ba.SearchClientActivityLogger.log("result_action",cu.active_user.id,fs)}ba.TimeToFirstActionLogger.log(cu.active_user.id,"file_view");return this.open_preview(fr,j,T)}else{if(this.in_search_mode()||T){fs.action_type="file_view";ba.SearchClientActivityLogger.log("result_action",cu.active_user.id,fs)}ba.TimeToFirstActionLogger.log(cu.active_user.id,"file_view");return window.open(fr.href,"_blank")}}},close_preview_callback:function(){bF(document).off("db:filepreview:close",this.close_preview_callback);af.close_shared_link_view();return cu.set_title()},preview_compressed:function(j,i){return n.show(j,cu.active_user,{files:[j,i],file_view_mode:aX.FileViewModeType.BROWSE,hide_comments:true})},open_preview:function(T,i,fr,j){if(i==null){i=Constants.OREF_CONSTANTS.BROWSE_UNKNOWN}if(fr==null){fr=false}if(j==null){j=false}if(this.can_show_preview(T)){a5.filepreview_from_selected(T,fr,j,i);return bF(document).on("db:filepreview:close",this.close_preview_callback)}},_click:function(T,fr){var j,i;this.keyboard_nav=false;j=cW.from_elem(fr);if(j.editing){return}i=(T.which===2)||(ec.is_mac()&&T.metaKey);cu.open_file(j,i,false,Constants.OREF_CONSTANTS.BROWSE_FILE_OPEN);T.preventDefault()},crumb_click:function(fr,i){var T,j;this.keyboard_nav=false;fr.preventDefault();j=i.readAttribute("data-fq_path");T=this.details_from_fq_path(j);return a4.set_path_url(T.ns_id,T.ns_path)},parent_click:function(fs,fr){var T,ft,i,j;this.keyboard_nav=false;fs.preventDefault();j=fr.readAttribute("data-parent_ns_path");i=parseInt(fr.readAttribute("data-parent_ns_id"),10);a4.set_path_url(i,j);T=cW.from_elem(fr);if(T){ft={file_nsid:T.ns_id,file_sjid:T.sjid,firefly:cb.firefly_enabled,match_type:T.match_type,position:T.sort_rank,request_id:T.request_id,viewport:"full-view",action_type:"click_path_link"};return ba.SearchClientActivityLogger.log("result_action",cu.active_user.id,ft)}},selection_handler:function(){if(e2.get_selected_files().length){return $("browse-box").addClassName("selected")}else{return $("browse-box").removeClassName("selected")}},POST_SCROLL_WAIT:100,_last_scroll_timeout:null,window_scroll:function(){var i,T,j,fr;if(this.in_search_mode()&&!cb.end_of_results){j=a5.get_files_in_view(),fr=j[0],T=j[1];i=this.files.length-(fr+T);if(i<=50&&!$("browse").hasClassName("pending-search")){cb.load_more_results()}}clearTimeout(this._last_scroll_timeout);return this._last_scroll_timeout=setTimeout(a5.load_visible_thumbs.bind(a5),this.POST_SCROLL_WAIT)},unscoped_search:function(){return cb.search(false)},updateOffset:function(){if(!this.div_parent){return}this._cumulativeOffset=this.div_parent.cumulativeOffset();return this.viewportOffset()},reset_sort:function(){var j,i;this.last_sort=ay;i="#browse-sort a.sortable-column-header";j=$$(i)[0];ec.add_sort_arrow_mouseover(j,true,i,false);$("kind-sorter-label").__date(dy.DISPLAY.FILES_BY_KIND);return cy.src(j.down("img"),"web","arrow-up-gray")},sort_handler:function(fu,T,ft){var fs,fr,i,j;T=$(T);T.blur();j=T.readAttribute("data-sort");if(ft!=null){}else{if(this.last_sort[0]===bq[j]){ft=T.readAttribute("data-ascending")==="false"}else{ft=j!=="FILES_BY_MODIFIED"}}if(dy.has_label(j)){fr=dy.next(j);$("sharing-sorter-label").__date(fr.display);j=fr.label;T.writeAttribute("data-sort",j);ft=dy.IS_ASC[j]}else{T.writeAttribute("data-ascending",(ft?"true":"false"))}i="#browse-sort a.sortable-column-header";ec.add_sort_arrow_mouseover(T,ft,i,true);fs=bq[j];this.sort(fs,ft,j);if(fu){return fu.stop()}},toggle_deleted:function(){var i;i=!a4.get_del();return a4.set_del_url(i)},unused_filename:function(fA,fF){var T,fG,fr,fy,fz,ft,fC,fs,fB,fD,fw,fu,fv,fx,fH,fE;if(fF==null){fF=false}fE=aA.filename_without_extension(fA);fH=aA.file_extension(fA,T=true);fy=[];fv=cu.files;for(fB=0,fD=fv.length;fB<fD;fB++){fG=fv[fB];fu=aA.filename_without_extension(fG.filename);fw=aA.file_extension(fG.filename,T=true);ft=fu.toLowerCase().indexOf(fE.toLowerCase())===0;fz=fH.toLowerCase()===fw.toLowerCase();fs=!fF||fG.dir;if(ft&&fz&&fs){fy.push(fG.filename.toLowerCase())}}if(fH){fH="."+fH}else{fH=""}fr=fE+fH;fC=1;while(true){if(fx=fr.toLowerCase(),cX.call(fy,fx)<0){break}fr=fE+" ("+fC+")"+fH;fC++}return fr},new_folder:function(){var fz,fr,T,fs,fw,i,j,fu,fx,fy,ft,fv;if(this.reloading||this.creating_folder){return}if(cu.sharing_create_and_share_new_folder_enabled&&!this.inside_shared_folder){fw=new a2(cu.active_user,{element_id:"create-and-share-new-folder-modal-"+cu.active_user.id,destination_dir:this.containing_fq_path()});fw.show();return}this.hide_empty();this.selectable();T=this.unused_filename(eG("New folder"),fx=true);fv=fm.tmpl("new_folder_tmpl",{name:T,Sprite:cy,_:eG});fs=-1;if(this.files.length){ft=D.scroll_offsets();if(ft.top>0){fy=this.files[0].get_div().getLayout().get("margin-box-height");fs=Math.floor(ft.top/fy)}}if(fs>0){this.files[fs].get_div().__sert({after:fv})}else{$("browse-files").__sert({top:fv})}i=$$("#browse-files .browse-new-folder .name").first();cP(i!=null,"expected new_folder_name to be defined");fz=this.containing_fq_path();fu=(function(fA){return function(fD){var fC,fB,fE;fE=fD.responseText.evalJSON(true);cP(fE.new_browse_files.length===1,"No new file data returned.");fC=aA.filename(fE.new_browse_files.first().fq_path);fB=eG("Created folder '%(folder_name)s'");fB=fB.format({folder_name:bU.em_snippet(fC,25)});ah.success(fB);fA.select_fq_paths=[fE.new_browse_files.first().fq_path];return fA.force_reload()}})(this);j=(function(fA){return function(fC){var fB;fB=$$("#browse-files li.browse-new-folder").first();if(fB){fB.remove()}return fA.creating_folder=false}})(this);fr=new Ajax.InPlaceEditor(i,"/cmd/new"+(ec.urlquote(fz)),{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:25,ajaxClass:Ajax.DBRequest,submitOnBlur:true,onFailure:function(){},onComplete:j,savingText:eG("Creating folder..."),onLeaveEditMode:this.unselectable,ajaxOptions:{method:"POST",onSuccess:fu,subject_user:cu.active_user},callback:(function(fA){return function(fB,fC){fA.creating_folder=true;return{to_path:fC||"",folder:"yes"}}})(this)});return fr.enterEditMode()},open_folder:function(j){var fr,i,T;cP(j.dir,"Only open directories, not files");if(cu.inside_dir&&cu.containing_ns_path()===j.ns_path&&!this.in_search_mode()){return}if(!(e2.get_selected_files().length===1&&e2.get_selected_files().indexOf(j)===0)){e2.deselect_all();fr=typeof j.get_div==="function"?j.get_div():void 0;if(fr){fr.addClassName("file-select")}}clearTimeout(this.folder_loading_timeout);this.folder_loading_timeout=setTimeout((function(fs){return function(){var ft;if(!fs.reloading){return}ft=eG("Loading %(filename)s...");ft=ft.format({filename:bU.em_snippet(j.filename,50)});return fs.folder_loading_notification=ah.success(ft,60,true)}})(this),1000);if(j.target_ns){i=j.target_ns;T=""}else{i=j.ns_id;T=j.ns_path}if(j.is_deleted){return a4.set_path_url(i,T,true)}else{return a4.set_path_url(i,T)}},open_folder_in_new_window:function(i){return window.open(a4._make_url(i.ns_id,i.ns_path),"_blank")},show_message:function(T){var j,i;if((typeof T)!==(typeof"string")){i=$("browse-files").down(".browse-message");if(i){i.show()}return}this.msg=T;j=new Element("div",{"class":"browse-message"});j.__date(T);return $("browse-files").__sert(j)},sort:function(j,fs,i,fr){var T;if(!fr&&j===this.last_sort[0]&&fs===this.last_sort[1]){return}this.last_sort=[j,fs,i];T=j(fs);this.files.sort(T);this.smartfill();a5.load_visible_thumbs();return this.fire_visible_change_callbacks()},resort:function(){var fr,i,T,j;i=this.last_sort;T=i[0];fr=i[1];j=i[2];return this.sort(T,fr,j,true)},in_search_mode:function(){return bF("#browse").hasClass("search")},flex_column:function(){return $("sharing-sorter").readAttribute("data-sort")},smartfill:function(){var T,fu,fs,fv,fr,i,fw,ft;T=$("browse-files");ft=[];fv=this.in_search_mode();fw=this.files;for(fr=0,i=fw.length;fr<i;fr++){fu=fw[fr];fs=this.flex_column();ft.push(this.compiled_tmpl({file:fu,in_search_mode:fv,flex_column:fs,Browse:cu,Sprite:cy,Constants:Constants,FilePath:aA,Emstring:bU,GandalfUtil:az,_:eG}))}T.__date(ft);document.fire(dU.RENDER);return bF(document).trigger(dU.RENDER)},search_smartfill:function(fx,fr){var i,fw,fu,T,fs,fv,ft;if(fr==null){fr=null}ft=[];for(fs=0,fv=fx.length;fs<fv;fs++){fw=fx[fs];T=a5.make_browsefile(fw,fr);T.track_in_browse();fu=this.compiled_search_tmpl({file:T,BrowseInterface:fo,Browse:cu,Sprite:cy,Constants:Constants,_:eG,searchHelpers:ap,HTML:fm,FilePath:aA,Emstring:bU,Util:ec});i=bF(fu.toHTML());ft.push(i)}bF("#browse-files").append(ft);document.fire(dU.RENDER);bF(document).trigger(dU.RENDER);a5.load_visible_thumbs();return this.fire_visible_change_callbacks()},add_file:function(i){this.files.push(i);if(i.target_ns){cu.ns_id_to_mount_point[i.target_ns]=i.fq_path}if(i.bytes<0){return this.deleted_shown=true}},insert_file:function(T,j){var i;if(!T){return}j=j||0;i=this.find_file(T.fq_path);if(i&&i!==T){this.remove_file(i)}cW._file_index[T.to_key()]=T;this.update_file_pos(T);if(j){T.get_div().setStyle({display:"none"})}document.fire(dU.RENDER);return bF(document).trigger(dU.RENDER)},add_files:function(i){return cu._push_files(i.file_info)},get_file_pos:function(i){var j;j=this.files.indexOf(i);cP(j!==-1,"file not present in @files");cP(i.to_key() in cW._file_index,"file not present in BrowseFile._file_index");return j},remove_file:function(i){var T,j;if(!i){return}T=this.files.indexOf(i);if(T!==-1){this.files.splice(T,1);delete cW._file_index[i.to_key()];return(j=i.get_div())!=null?j.remove():void 0}},update_file_pos:function(ft,fv){var i,fx,fr,fs,fu,T,j,fw;if(fv==null){fv=-1}fw=this.files.indexOf(ft);if(fw!==-1){this.files.splice(fw,1)}delete ft.sort_rank;T=this.last_sort[0];fu=this.last_sort[1];if(fv>=0){fw=fv}fs=this.in_search_mode()?fw:ec.bsearch(this.files,ft,T(fu),true);this.files.splice(fs,0,ft);fr=ft.get_div();i=$("browse-files");if(fr){fr.remove()}if(this.in_search_mode()){j=this.compiled_search_tmpl({file:ft,Browse:cu,BrowseInterface:fo,Constants:Constants,Emstring:bU,FilePath:aA,HTML:fm,searchHelpers:ap,Sprite:cy,Util:ec,_:eG})}else{j=this.compiled_tmpl({file:ft,in_search_mode:this.in_search_mode(),flex_column:this.flex_column(),Browse:cu,Constants:Constants,Emstring:bU,FilePath:aA,Sprite:cy,GandalfUtil:az,_:eG})}fx=i.childElements();if(fs<fx.length){return i.childElements()[fs].__sert({before:j})}else{return i.__sert(j)}},find_file:function(i){return this.files.find(function(j){return j.fq_path.toLowerCase()===i.toLowerCase()})},reset_state:function(){this.msg=false;this.dragging=false;this.files=[];this.selected_files=[];this.selection=[];cW._file_index={};return bR._body_dragend()},clear:function(){$("browse-files").__date();this.hide_empty();return cb.hide_empty()},show_empty:function(){var i;this.hide_empty();if(bF("#browse-empty-team-folder").length&&this.inside_team_folder&&!this.is_in_subfolder_of_team_folder()){i="#browse-empty-team-folder"}else{i="#browse-empty"}bF(i+" .drag-prompt").toggle(!this.is_read_only);if(!cu.in_search_mode()){return bF(i).show()}},hide_empty:function(){return bF("#browse-empty, #browse-empty-team-folder").hide()},update:function(i,j){if(j==null){j=null}$("browse-box").show();if(this.in_search_mode()){this.search_smartfill(i.file_info,j);return this.setup(null)}else{this.clear();if(typeof i==="string"){i=JSON.parse(i)}this.setup(i,j);this.resort();document.fire(dU.UPDATE);return bF(document).trigger(dU.UPDATE,[i])}},reload_fqpath:function(j,i){return this.reload(null,ec.urlquote(j),i)},force_reload:function(){return this.reload(this.containing_ns_id(),ec.urlquote(this.containing_ns_path()),true)},set_title:function(){var i;if(cu.in_search_mode()){cb.set_title();return}if(!cu.inside_dir){return}i=this.containing_fq_path();return document.title=i?aA.filename(i)+" - Dropbox":cQ.get_viewer().is_paired&&cu.active_user.role===Constants.ROLE_WORK?cQ.get_viewer().team_name+" - Dropbox":cQ.get_viewer().is_paired&&cu.active_user.role===Constants.ROLE_PERSONAL?eG("Personal")+" - Dropbox":eG("Home")+" - Dropbox"},set_selection_from_fq_paths_or_index:function(fx){var fr,T,fw,fu,fv,ft,i,fs;i=fx.select_fq_paths;fs=fx.select_index;if(i||fs>-1){T=[];if(i){for(fu=0,fv=i.length;fu<fv;fu++){fw=i[fu];ft=this.find_file(fw);if(ft){T.push(ft)}}}if(!T.length&&fs>-1){fr=this.files[fs];if(fr){T.push(fr)}}if(T.length){e2.set_selected_files(T);this.scrollToWithPadding(T.first().get_div(),100)}fx.select_fq_paths=false;return fx.select_index=-1}},set_selection_from_item_counters:function(){var fr,fw,ft,fu,fs,fx,fv,T,fy,fz;if(this.select_item_counters!=null){ft={};T=this.select_item_counters;for(fu=0,fx=T.length;fu<fx;fu++){fw=T[fu];ft[fw]=true}fz=[];fy=this.files;for(fs=0,fv=fy.length;fs<fv;fs++){fr=fy[fs];if(fr.root_coll_item_counter in ft){fz.push(fr)}}e2.set_selected_files(fz);return this.select_item_counters=null}},reload:function(fr,fw,j){var fy,fs,fx,T,fu,ft,fv,i;T="Browse.reload ns_path contains an invalid character: # ; ? : @ & = + $ (ns_path = "+fw+")";cP(fw.search(eJ.URL_ESCAPE_REGEX)===-1,T);if(fr==null){fr=cu.active_user.root_ns}fw=aA.normalize(fw);if(a5.get_mode()!==a5.BROWSE_MODE){this.clear();a5.set_browse_mode()}if(cb._clear_on_reload){cb.clear_searchbox()}if(!aq.uploading){c6.hide()}this._stop_pagination();if(this.reloading){return}if(this.inside_dir&&fw===this.containing_ns_path()&&fr===this.containing_ns_id()&&!j){return}fv=this.first_load?Constants.referrer:"";fx=this.deleted_shown?"?show_deleted=yes":"";ft={ns_id:fr,referrer:fv,delays_parent_request_rendering:this.first_load,sort_label:this.last_sort[2],sort_is_ascending:this.last_sort[1],sort_folders_first:bq.FOLDERS_FIRST};ft=Object.extend(ft,this.extra_reload_args);eO("Browse.reload:",fw);this.reloading=true;i="/browse"+fw+fx;fy=2;fs=["browse",fr,fw,fx,cu.active_user.id,fy];fu=(function(fz){return function(fA){fz.reset_state();fz.update(fA);(fz.files.length?fz.hide_empty.bind(fz):fz.show_empty.bind(fz))();clearTimeout(fz.folder_loading_timeout);if(ah.isShown()&&ah.current()===fz.folder_loading_notification){ah.clear()}D.scroll_clear_cache();if(fz._is_item_selection_needed()){if(fz.paginating&&!fz._are_all_selected_items_fetched()){fz._wait_for_items()}else{fz.set_selection_from_fq_paths_or_index(cu)}}if(!n.shown()){return fz.set_title()}}})(this);bF(document).trigger(dU.BEFORE_UPDATE,{ns_id:fr,ns_path:H.decode(fw)});new Ajax.DBRequest(i,{allow_retries:true,subject_user:cu.active_user,parameters:ft,log_timing:true,on304:function(fz){},onSuccess:(function(fz){return function(fG){var fD,fA,fC,fI,fE,fB,fF,fH;if(fz.in_search_mode()){return}fI=JSON.parse(fG.responseText);fH=null;fF=null;fu(fI);if(fH){fB=[];for(fC=0,fE=fH.length;fC<fE;fC++){fD=fH[fC];fB.push(cu.find_file(fD.fq_path))}e2.set_selected_files(fB);window.scrollTo(fF[0],fF[1])}else{cu.set_selection_from_item_counters()}if(cu.sharing_autoselect_first_file_enabled&&!e2.has_selected_files()){fA=fz.files[0];e2.set_selected_files([fA])}if(fz.first_load){return en.mark_time_to_interactive()}}})(this),onFailure:(function(fz){return function(){if(fz.first_load){fz.reload.bind(fz).defer(Constants.root_ns,"")}return clearTimeout(fz.folder_loading_timeout)}})(this),cleanUp:(function(fz){return function(){fz.first_load=false;return fz.reloading=false}})(this),no_feed_reload:true,evalJSON:false});return true},is_in_subfolder_of_shared_folder:function(){return cu.inside_shared_folder&&cu.containing_ns_path()},is_in_subfolder_of_team_folder:function(){return cu.inside_team_folder&&cu.containing_ns_path()},is_shmodelable_path:function(i){var j;if(cu.public_app_token){return false}if(i===""){return false}if(cu.public_folder_enabled){j=i.toLowerCase();if(j.startsWith("/public/")){return false}}return true},can_show_preview:function(i){var j;return this.browser_supports_previews||((j=i.preview_type)==="photo"||j==="video")},can_get_details_from_fq_path:function(T){var j,i;j=this.containing_fq_path();i=this.containing_mount_point();return(i&&T.startsWith(i))||j.startsWith(T)},details_from_fq_path:function(fr){var fs,j,i,T;cP(this.can_get_details_from_fq_path(fr));j=this.containing_mount_point();if(j&&fr.startsWith(j)){i=this.containing_ns_id();T=fr.slice(j.length);fs=aA.filename(fr,this._get_root_name())}else{i=Constants.root_ns;T=fr;fs=aA.filename(fr,this._get_root_name())}return{ns_id:i,ns_path:T,fq_path:fr,folder_name:fs||this._get_root_name(),url:String(fo.browse_uri_for_fq_path(cu.active_user,fr)),icon:(fr.length?"folder_32":this._get_root_icon())}},update_header_status:function(i){return bF("#browse-header-status").text(i)},update_header_height:function(){var j,fr,T,i;fr=bF("#browse-header");j=bF("#browse-files");i=0;if(fr.css("position")==="fixed"){i=bF(window).scrollTop()}if(!D.is_page_scrollable()){i=Math.abs(parseFloat(bF("html").css("top"))||0)}T=fr.offset().top+fr.height()-j.offset().top-i;return j.css("padding-top",T)},_make_breadcrumbs_data:function(){var fv,fw,fs,fr,fu,T,ft;fw=this.containing_fq_path();fv=[];T=fw.split("/");for(fs=fr=0,ft=T.length;0<=ft?fr<ft:fr>ft;fs=0<=ft?++fr:--fr){fu=aA.normalize(T.slice(0,fs+1).join("/"));fv.push(this.details_from_fq_path(fu))}return fv},_get_root_icon:function(){if(!cQ.get_viewer().is_paired){return"glyph"}if(cu.active_user.role===Constants.ROLE_WORK){return"work_icon"}else{if(cu.active_user.role===Constants.ROLE_PERSONAL){return"personal_icon"}}},_get_root_name:function(){return cQ.get_root_name(cu.active_user)},_get_max_breadcrumb_width:function(fr){var j,T,i;T=fr?this._DROPDOWN_WIDTH:new bU(this._get_root_name()).length;if(this.use_shorter_breadcrumbs){j=bF("#browse-rightmenu").width();i=bF("#browse-global-actions-bar").width();return((i-j)*this._FUDGE_FACTOR/this._PX_TO_EM)-T}else{return this._MAX_BREADCRUMB_WIDTH-T}},_PX_TO_EM:16,_FUDGE_FACTOR:0.75,_DROPDOWN_WIDTH:2.625,_MAX_BREADCRUMB_WIDTH:20,_CONNECT_WIDTH:1.64,breadcrumb:function(){var fz,fr,fu,fB,fw,fv,fy,T,fA,fs,fx,ft;fr=this._make_breadcrumbs_data();ft=fr.collect(function(i){return new bU(i.fq_path?i.folder_name:"").length});fx=0;fu=0;cP(fr.length>0,"expected at least one breadcrumb");fA=this._get_max_breadcrumb_width();for(fw=fv=fs=fr.length-1;fs<=0?fv<=0:fv>=0;fw=fs<=0?++fv:--fv){fx+=ft[fw];if(fx>fA){break}fu+=1;fx+=this._CONNECT_WIDTH}fB=fr.slice(0,fr.length-Math.max(1,fu));fr=fr.slice(fB.length,fr.length);if(!fB.length&&fr.length>1){fr.shift()}fy=fr.pop();fz=fm.tmpl("breadcrumb_tmpl",{breadcrumbs:fr,dropdown:fB,containing_fq_path:this.containing_fq_path(),url_root:fo.get_browse_root(cu.active_user),root_name:this._get_root_name(),Sprite:cy});T=fy.folder_name;if(fy.fq_path!==""){T=bU.em_snippet(T,this._get_max_breadcrumb_width(fB.length>1))}$("browse-location").__date(fz);$("browse-location").__sert(" "+T);if(fB.length>1){return this._render_breadcrumbs_dropdown(fB)}},_render_breadcrumbs_dropdown:function(fs){var fr,i,T,j;i=$("breadcrumbs-box");fs.reverse();j=fm.tmpl("breadcrumb_li_tmpl",{breadcrumbs:fs,Sprite:cy,Emstring:bU});$("browse-location").__sert(j);T=$("breadcrumb-dropdown");fr=function(fu){var ft;fu.stopPropagation();T.show();ft=bF(i);return bF(T).clonePosition(ft,{setWidth:0,setHeight:0,offsetTop:ft[0].offsetHeight,offsetLeft:parseInt(ft.css("padding-left"),10)})};i.observe("click",fr);i.observe("dragover",fr);return document.observe("click",function(){i.removeClassName("down");return T.hide()})},viewportOffset:function(){var i,T,j;if(!this.files.length){return}if(!this.div_parent){T=this.files[0].get_div().offsetParent;if(!T){return}this._viewportOffset={};this.div_parent=$(T);this._cumulativeOffset=this.div_parent.cumulativeOffset()}i=ec.scrollLeft(this.div_parent);j=ec.scrollTop(this.div_parent);if(!this.scrollTop||!this.scrollLeft||this.scrollTop!==j||this.scrollLeft!==i){this._viewportOffset.top=this._cumulativeOffset.top-j;this._viewportOffset.left=this._cumulativeOffset.left-i;this.scrollLeft=i;this.scrollTop=j}return this._viewportOffset},selectable:function(){return ec.enableSelection($("browse-files"))},unselectable:function(){return ec.disableSelection($("browse-files"))},_header_offset:(function(){var i;i=$("browse-header");return i.getHeight()+i.cumulativeOffset().top}).cached(1000),scrollTo:function(i){return this.scrollToWithPadding(i,3)},scrollToWithPadding:function(fr,ft){var T,fu,j,fs,i;if(!fr){return}fs=D.viewport_dimensions();i=D.scroll_offsets();fu=fr.cumulativeOffset().top-i.top;T=fr.getHeight();j=this._header_offset();if(fu<j){D.scroll_to(0,i.top+fu-j-ft)}else{if(fu+T>fs.height){D.scroll_to(0,i.top+fu+T-fs.height+ft)}}if($("modal-overlay").visible()&&$("modal").getStyle("position")==="absolute"){return fh.fix_position()}},_visible_change_callbacks:{},_next_visible_change_callback_id:0,add_visible_change_callback:function(i){this._visible_change_callbacks[this._next_visible_change_callback_id]=i;return this._next_visible_change_callback_id++},remove_visible_change_callback:function(i){return delete this._visible_change_callbacks[i]},fire_visible_change_callbacks:function(){var T,fu,fr,fs,i,j,ft;if(!bF.isEmptyObject(this._visible_change_callbacks)){fs=a5.get_files_in_view(),ft=fs[0],T=fs[1];i=this._visible_change_callbacks;j=[];for(fr in i){fu=i[fr];j.push(fu(this.files,this.active_user.id,ft,T))}return j}}};l=F.BrowseUpdate=(function(){var i,fv,fu,fr,ft,fs,T,j;T=function(fx){var fy,fz,fw;if(!cu.inside_dir){return}fz=fx.parent_changes;if(fz.change_to_fq_path!=null){if(fz.change_type==="moved"){if(fz.is_changing_view){fy=eG("The folder '%s' has been moved. <a href=\"/home%s\">View</a>");fy=fy.format(fz.old_fq_path.escapeHTML(),ec.urlquote(fz.new_fq_path))}else{fy=eG("This folder has been moved")}}else{if(fz.change_type==="renamed"){if(fz.is_changing_view){fy=eG("The folder '%s' has been renamed. <a href=\"/home%s\">View</a>");fy=fy.format(fz.old_fq_path.escapeHTML(),ec.urlquote(fz.new_fq_path))}else{fy=eG("This folder has been renamed to '%s'.");fw=fz.change_to_fq_path.split("/");fy=fy.format(fw[fw.length-1].escapeHTML())}}else{fy=eG("The folder '%s' has been deleted.");fy=fy.format(fz.old_fq_path.escapeHTML())}}if(fz.is_changing_view){ah.error(new fm(fy))}else{if(fz.old_fq_path===cu.containing_fq_path()){ah.success(new fm(fy))}}cu.reload_fqpath(fz.change_to_fq_path);return}return fs(fx)};j=function(fA){var fy,fz,fC,fF,fE,fx,fG,fw,fD,fB;fF=[];fB=[];if(!cu.in_search_mode()){return}cb.clear_cache();for(fx in cu.ns_id_to_mount_point){if(!(fx in fA.mount_points)){fA.mount_points[fx]=null}}fw=fA.mount_points;for(fx in fw){fE=fw[fx];fx=parseInt(fx,10);fG=cu.ns_id_to_mount_point[fx];if(fE===fG){continue}if(fE){cu.ns_id_to_mount_point[fx]=fE}else{delete cu.ns_id_to_mount_point[fx]}fD=cu.files;for(fz=0,fC=fD.length;fz<fC;fz++){fy=fD[fz];if(fy.fq_path.indexOf(fG)===0&&fy.target_ns!==fx){if(fE){fy.fq_path=fE+fy.fq_path.slice(fG.length);fy.href=fo.get_browse_root(cu.active_user)+fE+fy.href.slice(5+fG.length);fF.push([fy,fy])}else{fB.push(fy)}}}}return fs(fA,[],fB,fF)};fs=function(fT,fA,fQ,fz){var fH,fw,fR,fI,fM,fx,fO,fN,fP,fC,fB,fL,fy,fG,fF,fE,fK,fJ,fS,fD;if(fA==null){fA=[]}if(fQ==null){fQ=[]}if(fz==null){fz=[]}fy=fT.added;for(fO=0,fP=fy.length;fO<fP;fO++){fR=fy[fO];fw=aA.normalize(aA.parent_dir(fR.ns_path));if(cu.in_search_mode()||(fR.ns_id===cu.containing_ns_id()&&fw===cu.containing_ns_path())){fH=a5.make_browsefile(fR);fH.track_in_browse();fA.push(fH)}}fG=fT.removed;for(fN=0,fC=fG.length;fN<fC;fN++){fI=fG[fN];fQ.push(cu.find_file(fI))}fF=fT.moved;for(fL=0,fB=fF.length;fL<fB;fL++){fE=fF[fL],fM=fE[0],fD=fE[1];fS=aA.normalize(aA.parent_dir(fD.ns_path));fJ=null;fK=cu.in_search_mode()||(fD.ns_id===cu.containing_ns_id()&&fS===cu.containing_ns_path());fx=cu.in_search_mode();if(fK&&!(fx&&cu.find_file(fD.ns_path))){fJ=a5.make_browsefile(fD);fJ.track_in_browse()}fz.push([cu.find_file(fM),fJ])}document.fire(bE.ADD,{files:fA});bF(document).trigger(bE.ADD,{files:fA});document.fire(bE.MOVE,{files:fz});a5.load_visible_thumbs();cu.fire_visible_change_callbacks();return ft(fA,fQ,fz)};i=function(fz,fx,fy,fw){fz.css("background","");bF(document).trigger(dU.UPDATE_RENDERED);return document.fire(bE.REMOVE,{files:fy})};ft=function(fH,fF,fI){var fz,fK,fE,fB,fG,fD,fA,fy,fw,fx,fC,fJ;fC=(fH.length+fF.length)<=10;for(fE=0,fG=fH.length;fE<fG;fE++){fz=fH[fE];if(!(fz&&fz.get_div())){continue}fv(fz,fC,fH,fF,fI)}for(fB=0,fD=fF.length;fB<fD;fB++){fz=fF[fB];if(!(fz&&fz.get_div())){continue}fr(fz,fC,fH,fF,fI)}fx=[];for(fy=0,fA=fI.length;fy<fA;fy++){fw=fI[fy],fK=fw[0],fJ=fw[1];if(fK){fr(fK,fC,fH,fF,fI)}if(fJ){fx.push(fv(fJ,fC,fH,fF,fI))}else{fx.push(void 0)}}return fx};fu=function(fw){var fx;fx=e2.is_selected(fw)?"#83B8DC":"#CCEAFF";return bF(fw.get_div()).css("background-color",fx)};fr=function(fw,fz,fy,fA,fx){var fB;fu(fw);fB=bF(fw.get_div());if(fz){return fB.show().slideUp("normal",function(){return i(fB,fy,fA,fx)})}else{fB.hide();return i(fB,fy,fA,fx)}};fv=function(fw,fz,fy,fA,fx){var fB;fu(fw);fB=bF(fw.get_div());if(fz){return fB.hide().slideDown("normal",function(){return i(fB,fy,fA,fx)})}else{fB.show();return i(fB,fy,fA,fx)}};return{init:function(){var fx,fw;fw=ee[cu.active_user.id];return fx=fw.subscribe_sfj({name:"BrowseUpdater",handler:function(){var fE,fB,fD,fA,fy,fC,fz;fA=cu.in_search_mode();fE=fA?j:T;fz=fA?"/update/list_search":"/update/list_dir";if(!(cu.inside_dir||fA)){fw.handler_failure(fx);return}if(fA){fC=cb.get_state();fD={all_terms:fC.query}}else{fD={fq_dir:cu.containing_fq_path(),show_deleted:cu.deleted_shown}}fD.ns_map=((function(){var fG,fF;fG=fw.get_ns_map();fF=[];for(fB in fG){fy=fG[fB];fF.push(fB+"_"+fy)}return fF})()).join(",");cP(cu.active_user,"No active_user was set before calling "+fz+". Active user loaded? "+(__CIRCULAR_DEPENDENCY__.active_user_loaded||false)+". Error before loading? "+(__CIRCULAR_DEPENDENCY__.an_error_happened_before_loading||false)+". Error after loading? "+(__CIRCULAR_DEPENDENCY__.an_error_happened_after_loading||false)+".",true,[],false);return new bF.ajax(fz,{data:fD,dataType:"json",type:"POST",subject_user:cu.active_user,success:function(fF){fE(fF);return fw.handler_success(fx,{ns_map:fF.ns_map})},error:function(){return fw.handler_failure(fx)}})}})}}})();var ej;ej=F.ProgressWatcher={job_info:{},INIT_POLL_INT:1000,FAILS_MEAN_FAIL:3,MODAL_WAIT_MS:1000,watch:function(j,fs){var fr,T,i;if(j.async_task_id){if(!j.async_task_id.match(/^[A-Za-z0-9_\-=]*$/)){return}T=j.async_task_id}else{T=j.job_id}ej.job_info[T]={};fr=ej.job_info[T];fr.subject_user=j.subject_user||((i=j.parameters)!=null?i[a9.UID_PARAM_NAME]:void 0);fr.req=j;fr.is_async_task=!!j.async_task_id;fr.poll_int=ej.INIT_POLL_INT;fr.poll_count=0;fr.int_id=setInterval(ej.update_for(T),fr.poll_int);fr.failures=0;fr.start_time=b6.time();return fr.dont_hide=fs},update_for:function(i){return function(){return ej.update(i)}},backoff:function(j){var i;i=ej.job_info[j];clearInterval(i.int_id);i.poll_int=Math.min(Math.floor(i.poll_int*1.5),30000);return i.int_id=setInterval(ej.update_for(j),i.poll_int)},update:function(T){var i,j;j=ej.job_info[T];if(dr.peek(T)){return ej.done(T)}j.poll_count++;if(j.poll_count%10===0){ej.backoff(T)}if(!j.modaled&&b6.time()-j.start_time>ej.MODAL_WAIT_MS){i=j.req.options;eH.show(i.progress_text);i.onProgress=eH.update;if(i.on_modal_shown!=null){i.on_modal_shown()}j.modaled=true}if(j.is_async_task){return ej.get_async_task_status(T)}else{return ej.get_job_status(T)}},get_job_status:function(i){return new Ajax.DBRequest("/job_status/"+i,{method:"post",subject_user:ej.job_info[i].subject_user,onSuccess:function(T){var fr,j;fr=ej.job_info[i];j=T.responseText;if(j.indexOf("err")===0){ej.done(i);if(fr.req.options.onFailure&&!dr.handled(i)){fr.req.options.onFailure(T)}return}if(j.indexOf("done")===0){fr.req.options.job=false;if(!dr.peek(i)){new Ajax.Request("/job_results/"+i,{method:"post",parameters:{t:bw.read(aK.JS_CSRF_COOKIE)},onSuccess:function(ft){if(dr.handled(i)){return}ar.clearWorkingMessage();if(fr.req.options.onSuccess){return fr.req.options.onSuccess(ft)}},onFailure:function(ft){if(dr.handled(i)){return}ar.clearWorkingMessage();if(fr.req.options.onFailure){return fr.req.options.onFailure(ft)}}})}return ej.done(i)}else{try{if(fr.req.options.onProgress){return fr.req.options.onProgress(T.responseText)}}catch(fs){}}},onFailure:function(j){var T;T=ej.job_info[i];T.failures++;if(T.failures>=ej.FAILS_MEAN_FAIL){if(T.req.options.onFailure){T.req.options.onFailure(j,true)}ar.remove(T.req);return ej.done(i)}}})},get_async_task_status:function(i){return new Ajax.DBRequest("/async_task_status/"+i,{method:"post",subject_user:ej.job_info[i].subject_user,onSuccess:function(T){var fr,j;fr=ej.job_info[i];j=T.responseText;if(j.indexOf("done:")===0||j.indexOf("err:")===0){dr.handled(i);ar.clearWorkingMessage();if(j.indexOf("done:")===0){T.responseText=j.substr(5)}if(fr.req.options.onSuccess){fr.req.options.onSuccess(T)}if(fr.req.options.onComplete){fr.req.options.onComplete(T)}return ej.done(i)}else{if(j.indexOf("async_task_err:")===0){ah.error(new fm(j.substr(15)));dr.handled(i);ar.clearWorkingMessage();ej.done(i);return cu.force_reload()}else{try{if(fr.req.options.onProgress){return fr.req.options.onProgress(T.responseText)}}catch(fs){}}}},onFailure:function(j){var T;T=ej.job_info[i];T.failures++;if(T.failures>=ej.FAILS_MEAN_FAIL){try{if(T.req.options.onFailure){T.req.options.onFailure(j,true)}}catch(fr){}ar.remove(T.req);return ej.done(i)}}})},done:function(j){var i;i=ej.job_info[j];clearInterval(i.int_id);if(!i.dont_hide){delete ej.job_info[j];if(!(i.req.async_task_id&&i.req.async_task_id!==j)){return eH.hide(j)}}else{return eH.update("1/1")}}};var dA,bY,bC,cX=[].indexOf||function(fr){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fr){return T}}return -1};bC=F.NamespaceEvents=(function(){function i(j){this.ns_id=j;this.earliest=Number.MAX_VALUE;this.events=[];this.seen={};this.done=false}return i})();dA=F.EventDatePicker=(function(){function i(T){var j,fr,fs;this.on_change=T;bF(document.body).on("click",(function(ft){return function(fu){return ft.hide_calendar(fu)}})(this));fs=new Element("div",{id:"cal_container"});bF(fs).bind("click",function(ft){return ft.preventDefault()});bF(document.body).append(fs);this.calendar=new J("cal_container",{onDateChange:(function(ft){return function(fu){return ft.on_change(fu)}})(this),disable_future:true});bF(fs).css("position","fixed");fr=bF("#cal_date");j=bF("#cal_container");j.clonePosition(fr,{setWidth:false,setHeight:false,offsetTop:fr.height(),offsetLeft:fr.width()-j.children().first()[0].offsetWidth});this.hide_calendar()}i.prototype.show_calendar=function(j){if(this.shown){bF("#cal_container").hide();this.shown=false;return}bF("#cal_container").show();return this.shown=true};i.prototype.hide_calendar=function(j){if(j&&bF(j.target).closest("#cal_date").length>0){return}bF("#cal_container").hide();this.shown=false;return true};return i})();bY=INLINE_JS.Events=F.Events={ns:null,role:"all",now:Number(new Date()),timestamp:ec.start_of_day(new Date(Number(new Date())+60*60*24*1000)),request_in_flight:false,one_day:60*60*24*1000,user_navigated_away:false,init:function(i,ft,fv,T,fu){var fr,fs,j;if(fu==null){fu=false}this.awaitingFirstRender=true;j=eJ.deconstruct_url();this.first_event_map=i;this.roles=ft;this.rss_data=fv;this.role_has_events=T;this.deletions_only=fu;this.role_picker=D.controller(bF("#role-selector"));if(this.roles.length===1){this.role=this.roles[0].role}else{if(j.qargs.role){this.role=j.qargs.role;this.role_picker.set_state(this.role)}else{if(this.deletions_only){this.role=this.roles[this.roles.length-1].role}}}this.date_picker=new dA((function(fw){return function(fx){fw.change_date(fx);fw.set_url();return ba.WebMiscActivityLogger.log("filter_events_date")}})(this));this._init_state();this.role_picker.on_state_change=(function(fw){return function(){fw.role=fw.role_picker.get_state();if(fw.ns&&!bx(fw.valid_roles()).any(function(fx){return fx.ns_ids.contains(fw.ns.ns_id)})){fw.ns=null;aS.set_selected_by_value(bF("#namespace-list")[0],"false")}fw.set_url();return fw.get_more(true)}})(this);bO.set_during_login_callback((function(fw){return function(fy,fx){return window.location.reload()}})(this));bF(window).bind("beforeunload",(function(fw){return function(){fw.user_navigated_away=true;return void 0}})(this));if(bF("#namespace-list-container")[0]){bF("#namespace-list-container")[0].observe("db:change",(function(fw){return function(fx){fw.ns=fw.namespaces[JSON.parse(fx.memo)];fw.set_url();fw.get_more(true);return ba.WebMiscActivityLogger.log("filter_events_shared_folder")}})(this))}bF(window).on("scroll",(function(fw){return function(){document.body.scrollTop=Math.min(document.body.scrollTop,document.body.scrollHeight-D.viewport_dimensions().height-10);return fw.get_more()}})(this));if(j.qargs.ns){aS.set_selected_by_value(bF("#namespace-list")[0],j.qargs.ns);this.ns=this.namespaces[j.qargs.ns]}if(j.qargs.date){fs=j.qargs.date.split("-").map(Number);fr=new Date(fs[2],fs[1]-1,fs[0]);this.date_picker.calendar.selected_date=fr;this.change_date(fr)}this.update_calendar_first_day();return this.get_more()},_init_state:function(){var fw,fv,fr,fu,T,fx,ft,fs;this.namespaces={};fx=bx(this.roles).values();for(fw=0,fr=fx.length;fw<fr;fw++){fs=fx[fw];ft=fs.ns_ids;for(fv=0,fu=ft.length;fv<fu;fv++){T=ft[fv];this.namespaces[T]=new bC(T)}}if(this.ns){return this.ns=this.namespaces[this.ns.ns_id]}},change_date:function(i){this.timestamp=Number(i)+this.one_day;if(this.timestamp<this.earliest()||this.timestamp>this.latest){this.latest=this.timestamp;this._init_state()}bF("#cur_date_text").text(O.localize(i));return this.get_more(true)},is_scrolled_down:function(){var i,T,j;j=D.scroll_offsets().top;T=D.viewport_dimensions().height;i=bF("#events").height();return j+T+50>=i},get_more:function(fr){var i,j,T;if(this.request_in_flight){return}if(bx(this.valid_nss()).all(function(fs){return fs.done})){this.render();return}if(!(fr||this.is_scrolled_down())){this.render();return}this.request_in_flight=true;this.render();j=(function(fs){return function(){return bx(fs.valid_nss()).map(function(ft){return ft.ns_id}).join(",")}})(this);i=Math.min(this.earliest(),this.timestamp/1000,Math.floor(this.now/1000));T={page_size:25,ns_ids:j(),timestamp:i};if(this.deletions_only){T.deletions_only=true}return new Ajax.DBRequest("/events/ajax",{method:"POST",parameters:T,onSuccess:(function(fs){return function(fH){var fA,ft,fB,fy,fx,fD,fz,fw,fG,fv,fF,fu,fE,fC;fA=JSON.parse(fH.responseText);fs.request_in_flight=false;fu=fA.events;for(fB=0,fD=fu.length;fB<fD;fB++){ft=fu[fB];ft.html=bF(ft.html)[0];fF=ft.pkey+" "+(ft.html.textContent||ft.html.innerText);fG=fs.namespaces[ft.ns_id];if(!fG.seen[fF]){fG.events.push(ft);fG.seen[fF]=true;fG.earliest=ft.timestamp}}if(fA.events.length>0){fE=fA.ns_ids;for(fy=0,fz=fE.length;fy<fz;fy++){fv=fE[fy];fs.namespaces[fv].earliest=bx(fA.events).map(function(fI){return fI.timestamp}).min()}}fs.render();if(fA.events.last()){fs.get_more()}else{if(bx(fA.ns_ids).join(",")!==j()){fs.get_more()}else{fC=fA.ns_ids;for(fx=0,fw=fC.length;fx<fw;fx++){fv=fC[fx];fs.namespaces[fv].done=true}}}return at.configureAllLinks("#event-table",".inline-restore","events")}})(this),onError:(function(fs){return function(){fs.request_in_flight=false;if(!fs.user_navigated_away){return ah.error(eG("We had problems loading your events feed; please try again later."))}}})(this)})},valid_roles:function(){if(this.role!=="all"){return bx(this.roles).filter((function(i){return function(j){return j.role===i.role}})(this))}else{return this.roles}},valid_nss:function(){if(this.ns){return[this.ns]}else{return bx(this.valid_roles()).map((function(i){return function(j){return j.ns_ids}})(this)).flatten().map((function(i){return function(j){return i.namespaces[j]}})(this)).uniq()}},earliest:function(){return bx(this.valid_nss()).map((function(i){return function(j){return j.earliest}})(this)).max()},latest:Number.MAX_VALUE,update_calendar_first_day:function(){this.date_picker.calendar.options.first_day=ec.start_of_day(new Date(bx(this.valid_nss()).map((function(i){return function(j){return i.first_event_map[j.ns_id]}})(this)).min()));if(this.date_picker.calendar.selected_date<this.date_picker.calendar.options.first_day){this.date_picker.calendar.selected_date=ec.start_of_day(new Date(Number(this.date_picker.calendar.options.first_day)+this.one_day));this.change_date(this.date_picker.calendar.selected_date)}return this.date_picker.calendar.render()},set_url:function(){var T,fr,j,i;j=new Date(this.timestamp-this.one_day);fr=this.now-this.timestamp>0;T={};if(this.ns){T.ns=this.ns.ns_id}if(this.role!=="all"){T.role=this.role}if(fr){T.date=(j.getDate())+"-"+(j.getMonth()+1)+"-"+(j.getFullYear())}i=this.deletions_only?"/deleted_files":"/events";return eJ.push_state(i,T)},on_preview_open:function(j){var i;i=cQ.get_viewer().get_user_by_id(j.user_id);bF(document).on("db:filepreview:close",this.on_preview_close);n.show(j,i);return false},on_preview_close:function(){bF(document).off("db:filepreview:close",this.on_preview_close);return document.title=eG("Recent events - Dropbox")},render:function(){var fr,fG,fK,fJ,fy,fH,fL,fF,fI,fz,fx,fv,fB,fM,fD,fs,fw,fA,fu,fC,fE,T,ft;if(this.role_has_events[this.role]){this.update_calendar_first_day()}fr=bx(this.valid_nss()).map((function(i){return function(j){return j.events}})(this)).flatten();fG=this.earliest();T=bx(fr).sortBy(function(i){return -i.timestamp});fy=bx(T).filter((function(i){return function(j){return j.timestamp>=fG&&j.timestamp<i.timestamp/1000&&(i.ns!==null||!j.is_dup)}})(this));if(this.role_has_events[this.role]){bF("#event-table").empty();for(fH=0,fI=fy.length;fH<fI;fH++){fw=fy[fH];fK=bF(fw.html);fA=bx(this.valid_roles()).filter((function(i){return function(j){return j.ns_ids.contains(fw.ns_id)}})(this)).map((function(i){return function(j){return j.name}})(this)).join(" & ");if(this.deletions_only){fK.find("span.role-path").text(fA)}else{fK.find("span.role-label > span").text(fA)}bF("#event-table").append(fK);if(fw.preview_jsinfo!=null){fJ=fw.preview_jsinfo;fx=fK.find("#prev_link");fx.on("click",this.on_preview_open.bind(this,fJ));fE=fK.find(".inline-button");fE.on("click",this._inline_share_button.bind(this,fJ))}}bF("#events-container").show();bF("#events-sub-header").show();bF("#events-sub-header").css("visibility","visible");bF("#events-empty-state").hide();bF(".empty-explanation").hide()}else{if(!this.request_in_flight){bF("#events-container").hide();bF("#events-sub-header").hide();bF("#events-empty-state").show();bF(".empty-explanation").show()}}if(!this.request_in_flight){if(this.awaitingFirstRender){this.awaitingFirstRender=false;ba.WebMiscActivityLogger.log("events-first-load",{time:Number(new Date())-this.now})}bF("#more-loading").hide()}else{bF("#more-loading").show()}bF("#more-loading").css("marginTop",this.earliest()===Number.MAX_VALUE?"140px":"20px");fv=bF("#namespace-list > li");for(fF=0,fz=fv.length;fF<fz;fF++){fL=fv[fF];fs=bx(this.valid_roles()).map((function(i){return function(j){return j.ns_ids}})(this)).flatten().any((function(i){return function(j){return j===bF(fL).data("value")}})(this));fD=bF(fL).data("value")===false;ft=fD||fs;bF(fL).css("display",ft?"":"none")}fC=cX.call((function(){var fN,j,i,fO;i=this.valid_roles();fO=[];for(fN=0,j=i.length;fN<j;fN++){fM=i[fN];fO.push(fM.ns_ids.length>1)}return fO}).call(this),true)>=0;if(!this.request_in_flight){if(fC){bF("#namespace-list-container").css("visibility","visible");bF("#namespace-list-container").show()}else{bF("#namespace-list-container").hide()}fu=this.rss_data[(fB=this.ns)!=null?fB.ns_id:void 0]||this.rss_data[this.role];if(fu&&this.role_has_events[this.role]){bF("#rss-feed a").attr("data-title",fu.title);bF("#rss_url").val(fu.url);bF("#reset-rss-link").on("click",(function(i){return function(j){new Ajax.DBRequest("/reset_rss",{parameters:{ns_id:fu.ns_id},onSuccess:function(){ah.success(eG("RSS feed url successfully reset."));return b1.redirect("/events")}});return false}})(this));bF("#rss_url").focus();bF("#rss-feed").show();return bF("#rss-feed").css("visibility","visible")}else{return bF("#rss-feed").hide()}}},show_rss_modal:function(){var i,j;fh.show(eG("Subscribe to this RSS feed"),bF("#rss-modal")[0]);j=bF("#rss_url").val();i=t.clipboard_overlay(j,bF("#real_copy"),function(){ah.success(eG("Link copied to clipboard!"));return fh.hide()},bF(".modal-buttons"));return i.css({zIndex:1001})},_inline_share_button:function(j,fr){var i,T;fr.preventDefault();i="events_table_row";T=ba.ShmodelUILogger.get_target_item(j);ba.ShmodelUILogger.log("single_entry_share",i,T);return new dm(j.user_id,j.fq_path,i).show()}};var O;O=F.DateUtil={fromSecondsSinceEpochUTC:function(i){var j;j=new Date(1970,0,1);j.setSeconds(i);return j},applyTimezoneOffset:function(j,fr){var i,T;i=parseInt(fr,10);T=60*(fr-i);j.setHours(j.getHours()+i);return j.setMinutes(j.getMinutes()+T)},contextualFormat:function(j){var fr,ft,i,T,fs;i=new Date(Date.now());T=(i.getTime()-j.getTime())/1000;fr=0;if(T<8*3600){return b6.ago(j)}this.applyTimezoneOffset(i,Constants.TIMEZONE_OFFSET);this.applyTimezoneOffset(j,Constants.TIMEZONE_OFFSET);fs=new Date(Date.now());this.applyTimezoneOffset(fs,Constants.TIMEZONE_OFFSET);fs.setDate(fs.getDate()-1);if(j.getYear()===i.getYear()&&j.getMonth()===i.getMonth()&&j.getDate()===i.getDate()){ft=eG("Today %(time)s");return ft.format({time:O.format(j,Constants.time_format)})}else{if(j.getYear()===fs.getYear()&&j.getMonth()===fs.getMonth()&&j.getDate()===fs.getDate()){ft=eG("Yesterday %(time)s");return ft.format({time:O.format(j,Constants.time_format)})}else{return O.format(j,Constants.datetime_format)}}},toUTCDate:function(i){return new Date(i.getUTCFullYear(),i.getUTCMonth(),i.getUTCDate(),i.getUTCHours(),i.getUTCMinutes(),i.getUTCSeconds(),i.getUTCMilliseconds())},differenceStr:function(fr,fu){var fw,fv,j,T,fs,i,ft;fs=(fr.getTime()-fu.getTime())/1000;if(fs<60){return bd("%d sec","%d secs",fs).format(fs)}else{if(fs<3600){j=parseInt(fs/60,10);return bd("%d min","%d mins",j).format(j)}else{if(fs<86400){fv=parseInt(fs/3600,10);return bd("%d hour","%d hours",fv).format(fv)}else{if(fs<2592000){fw=parseInt(fs/(60*60*24),10);return bd("%d day","%d days",fw).format(fw)}else{if(fs<4838400){i=parseInt(fs/(60*60*24*7),10);return bd("%d week","%d weeks",i).format(i)}else{if(fs<31536000){T=parseInt(fs/(60*60*24*30),10);return bd("%d month","%d months",T).format(T)}else{ft=parseInt(fs/(60*60*24*365),10);return bd("%d year","%d years",ft).format(ft)}}}}}}},localize:function(i){cP(Constants.date_format!=null,"Date format missing.");return O.format(i,Constants.date_format)},format:function(i,j){var T;cP(typeof j==="string","Date format requires a format string");T={yy:(function(fr){return function(){return i.getFullYear().toString().substring(2)}})(this),yyyy:(function(fr){return function(){return i.getFullYear().toString()}})(this),M:(function(fr){return function(){return(i.getMonth()+1).toString()}})(this),MM:(function(fr){return function(){return(i.getMonth()+1).toString().lpad(2)}})(this),d:(function(fr){return function(){return i.getDate().toString()}})(this),dd:(function(fr){return function(){return i.getDate().toString().lpad(2)}})(this),h:(function(fr){return function(){return(i.getHours()%12||12).toString()}})(this),H:(function(fr){return function(){return i.getHours().toString()}})(this),HH:(function(fr){return function(){return i.getHours().toString().lpad(2)}})(this),m:(function(fr){return function(){return i.getMinutes().toString()}})(this),mm:(function(fr){return function(){return i.getMinutes().toString().lpad(2)}})(this),a:(function(fr){return function(){if(i.getHours()>11){return eG("PM",{comment:"PM as in evening"})}else{return eG("AM",{comment:"AM as in morning"})}}})(this)};return j.replace(/([a-zA-Z]+)/g,function(fr){if(T[fr]!=null){return T[fr]()}else{return fr}})}};var eW;eW=INLINE_JS.Timezone=F.Timezone={check_timezone:function(){var i;if(!cQ.get_viewer().is_signed_in){return}i=eW.get_current_timezone();if((Constants.auto_timezone_offset==null)||Constants.auto_timezone_offset!==i){return eW.update(i)}},get_current_timezone:function(){var fr,T,i,j;T=new Date();T.setSeconds(0);T.setMilliseconds(0);j=T.toGMTString();fr=new Date(j.substring(0,j.lastIndexOf(" ")));i=(T-fr)/(1000*60*60);return i},update:function(i){cP(typeof i==="number","Timezone offset was not a number: "+i);return new Ajax.DBRequest("/set_timezone",{parameters:{offset:i},noAutonotify:true})},update_timezones_dropdown:function(j,fr){var T,i;if(fr==null){fr=null}i=eW.timezones_by_country[j];bF("#timezone_id").empty();return bF("#timezone_id").append((function(){var fu,fs,ft;ft=[];for(fu=0,fs=i.length;fu<fs;fu++){T=i[fu];ft.push(bF('<option value="'+T.id+'">'+T.name+"</option>").prop("selected",T.id===fr))}return ft})())},auto:function(){var i;i=$F("timezone_auto");if(i){return bF("#tz").hide()}else{if(eW.default_country){bF("#timezone_country").val(eW.default_country);eW.update_timezones_dropdown(eW.default_country)}return bF("#tz").show()}},load_data:function(j,i){eW.timezones_by_country=j;return eW.default_country=i}};var bi,bK;bK=F.CreateApp={init:function(fr,j){var T,fs,i;this.accepted_tos_by_uid=fr;this.form=T=bF("#create-app-form");this.email_verification=null;if(!cQ.get_viewer().is_paired){i=cQ.get_viewer().get_users()[0];this.select_user(i.id)}fs=(function(ft){return function(fu){var fv;fv=fu.target.name;return T.find("input[name="+fv+"]").each(function(){bF(this).parents("label").removeClass("active");return T.removeClass(bF(this).data("next"))})}})(this);T.find("input[type=radio]").change(function(ft){fs(ft);bF(ft.target).parents("label").addClass("active");return T.addClass(bF(this).data("next"))});T.find("input[type=checkbox]").change(function(ft){var fu;if(bF(this).filter("#accept-tos").length){return}bF(ft.target).parents("label").toggleClass("active");fu=T.find("input[name="+(bF(this).attr("name"))+"]:checked");T.toggleClass(bF(this).data("next"),fu.length!==0)});T.find(".role-choice input").change((function(ft){return function(fv){var fu,fw;fu=T.find(".role-choice input:checked");fw=fu.val();if(!cQ.get_viewer().is_uid_signed_in(fw)){fu.prop("checked",false);fs(fv);bO.show_modal({user_id:fw,on_success:function(){return fu.prop("checked",true).trigger("change")}});return false}else{return ft.select_user(fw)}}})(this));T.find("input:checked").trigger("change");T.find("input[name=tos_accept]").change((function(ft){return function(fu){return ft.update_submit_enabled()}})(this));T.find("#send-verify-email, #resend-verify-email").click((function(ft){return function(fu){ft.email_verification.send_email(j,function(){T.addClass("verify-email-sent");ft.email_verification.flash_email_sent_notification();return ft.email_verification.ensure_polling(function(){if(!ft.email_verification.user.is_email_verified){return}T.addClass("email-verified");T.removeClass("verifiy-email-sent");T.removeClass("email-unverified");return ft.update_submit_enabled()})});return false}})(this));return T.submit(function(ft){T=bF(ft.target);bT.ajax_submit(T[0],false,(function(fu){return window.location.href=fu.responseText}));return false})},select_user:function(i){this.email_verification=ea.get_for_user(cQ.get_viewer().get_user_by_id(i));this.form.find("#accept-tos-wrapper").toggle(!this.accepted_tos_by_uid[i]);this.form.find("input[name=tos_accept]").prop("checked",false);this.form.removeClass("verify-email-sent");this.form.find("#verify-email-wrapper").toggle(!this.email_verification.user.is_email_verified);this.form.toggleClass("email-verified",this.email_verification.user.is_email_verified);return this.update_submit_enabled()},update_submit_enabled:function(){var j,i;i=this.email_verification.user;j=this.accepted_tos_by_uid[i.id]||this.form.find("input[name=tos_accept]").prop("checked");return this.form.find("#create-button").prop("disabled",!j)}};bi=INLINE_JS.Apps=F.Apps={init_apps:function(){return bF("#show-disabled-apps").click(function(){bF(this).parent().hide();bF("#disabled-apps").show();return false})},init_app_info:function(j,T,i){this.user_email=i;bF("#app-info .icon-container").each(function(fs,ft){var fr;fr=bF(ft);return fr.append(Dropbox.createChooseButton({success:function(fu){fr.find(".icon").attr("src",fu[0].thumbnailLink);return fr.find("input[type=hidden]").val(fu[0].link)},linkType:"direct",extensions:["images"]}))});this._hoverable_tmpl=fm.tmpl("hoverable_tmpl");this._webhook_info_row_tmpl=fm.tmpl("webhook_info_row_tmpl");bF("#domain-list").on("click",".img-container",function(fr){bi.remove_domain(fr.currentTarget.parentNode,j)});bF("#oauth-uri-list").on("click",".img-container",function(fr){bi.remove_oauth_uri(fr.currentTarget.parentNode,j)});bF("#webhook-list").on("click",".img-container",function(fr){bi.remove_webhook(fr.currentTarget.parentNode,j)});bF("#webhook-list").on("click",".webhook-actions.enabled .webhook_disable",function(fr){bi.update_webhook_url(fr.currentTarget,j,false)});bF("#webhook-list").on("click",".webhook-actions.disabled .webhook_enable",function(fr){bi.update_webhook_url(fr.currentTarget,j,true)});bF("#delete-app-button").on("click",function(fr){bi.confirm_disable(T,j,0)});bF("#webhook_url").on("click change paste focus",function(fr){bF("#webhook-form").removeClass("error")});bF(".modal-buttons .freshbutton-blue.modal-okay").on("click",function(fr){return INLINE_JS.Modal.hide()});this.init_app_info_add_redirect_uri();return bF("#oauth2-allow-implicit-grant").on("change",function(fr){return bi.set_oauth2_allow_implicit_grant(fr.currentTarget,j)})},init_app_info_add_redirect_uri:function(){var i,j,T,fr;j=/^\#?add_redirect_uri=(.*)$/.exec(window.location.hash||"");if(!j){return}fr=window.decodeURIComponent(j[1]);i=bF("#oauth-add-uri-form");bF("input[name=oauth_uri]",i).val(fr);T=bF("#add-redirect-uri-modal")[0];bF("#add-redirect-uri-modal-uri").text(fr);fh.show(eG("Add OAuth redirect URI"),T,{doit:function(){var fs;if(window.history&&window.history.replaceState){fs=window.location.href;fs=fs.substring(0,fs.indexOf("#"));window.history.replaceState({},document.title,fs)}else{window.location.hash=""}fh.hide();return bi.submit_new_oauth_uri(bF("#oauth-add-uri-form")[0])}})},init_app_datastores_browse:function(i){this.ds_info=i;if(cQ.get_viewer().is_paired){this.role_picker=D.controller(bF("#role-selector"));this.role_picker.on_state_change=this.app_datastores_browse_render.bind(this);return bO.set_during_login_callback((function(j){return function(fr,T){return j.app_datastores_browse_reload_info(function(){return T()},function(){T("Error displaying datastores");return window.location.reload()})}})(this))}},app_datastores_browse_reload_info:function(j,i){bF.ajax({url:"/developers/apps/datastores/info",success:(function(T){return function(fr){T.ds_info=fr;T.app_datastores_browse_render();return typeof j==="function"?j():void 0}})(this),error:(function(T){return function(fr){return typeof i==="function"?i(fr):void 0}})(this)});return false},app_datastores_browse_render:function(){this.app_datastores_browse_render_id("#apps_developed_container");this.app_datastores_browse_render_id("#apps_used_container");return this.app_datastores_browse_render_empty()},app_datastores_browse_render_empty:function(){var fr,T,j,i;T=bF("#no_apps_container").empty();if(bF("#apps_developed_container").children().length!==0||bF("#apps_used_container").children().length!==0){return}fr=bF("<div class='empty-state'></div>").appendTo(T);switch((j=this.role_picker)!=null?j.get_state():void 0){case d8.PERSONAL:case d8.WORK:i=cQ.get_viewer().get_user_by_role(this.role_picker.get_state());return fr.append("You don't have any datastores in your "+cQ.get_role_title(i)+" Dropbox.");default:return fr.append("You don't have any datastores in your Dropbox.")}},app_datastores_browse_render_id:function(fw){var fr,fv,fs,fu,T,i,ft;fu=this.app_datastores_browse_get_id_info(fw);fv=bF(fw);fv.empty();fr="";for(T=0,i=fu.length;T<i;T++){fs=fu[T];if(this.app_datastores_should_render(fs.uid)){fr+=fs.html}}if(fr){fv.append(this.app_datastores_browse_get_id_header(fw));ft=bF("<div class='app-list clearfix'/>").appendTo(fv);return ft.html(fr)}},app_datastores_should_render:function(j){var i;if(this.role_picker!=null){i=cQ.get_viewer().get_user_by_id(j);return this.role_picker.is_role_visible(i.role)}else{return true}},app_datastores_browse_get_id_info:function(i){switch(i){case"#apps_developed_container":return this.ds_info.apps_developed;case"#apps_used_container":return this.ds_info.apps_used;default:return cP(false,"invalid ds group id")}},app_datastores_browse_get_id_header:function(i){switch(i){case"#apps_developed_container":return bF("<h2>Apps you develop</h2>");case"#apps_used_container":return bF("<h2>Apps you use</h2>");default:return cP(false,"invalid ds group id")}},confirm_disable:function(fr,T,j){var fs,i;fs=(j?eG("Are you sure you want to disable '%(app_name)s'?"):eG("Are you sure you want to delete '%(app_name)s'?"));dB.fillVal(fs.format({app_name:fr.escapeHTML()}),"app-disable-text");fh.show((j?eG("Confirm disable"):eG("Confirm delete")),$("app-disable-modal"));i="/developers/disable_app/"+T;$("app-disable-modal").down("form").action=i;return $("disable-app-button").setValue((j?eG("Disable"):eG("Delete")))},enable_app:function(j){var i;i="/developers/enable_app/"+j;return window.location.href=i},show_uninstall:function(ft,fs,T,j,fr,i){var fu;if(ft){Event.stop(ft)}fh.vars={app_id:T,user_id:i};fu=bF("#delete-"+j+"-app-confirm");if(j==="sandbox"){if(!fr){bi.do_uninstall();return}bF(".app_folder",fu).text(fr)}bF(".app_name",fu).text(fs);fh.show(eG("Remove %(app_name)s?").format({app_name:bU.em_snippet(fs,22)}),fu[0],fh.vars);return null},do_uninstall:function(){var i;i=fh.vars.user_id;new Ajax.DBRequest("/api/uninstall_app",{parameters:{app_id:fh.vars.app_id,keep_sandbox_files:$F("keep_sandbox_files")},onSuccess:function(j){var T;ah.success(j.responseText);T=bF(".apps-"+i);bF("#inst-app-"+fh.vars.app_id+"-row",T).hide().removeClass("active_app");if(bF(".active_app",T).length===0){T.hide()}if(bF(".active_app").length===0){bF("#empty-explanation").text(eG("You have no apps linked to your Dropbox."));return bF("#applications-explanation",T).remove()}},subject_user:i});return fh.hide()},enable_users_in_dev:function(i,j){new Ajax.DBRequest("/developers/enable_users_in_dev/"+i,{onSuccess:function(T){fh.show(eG("Limit raised to %d users").format(j),$("increased-dev-user-limit-modal"));bF("#users-in-dev-none, #users-in-dev-some").hide();return bF("#users-in-dev-max").show()}});return false},unlink_all_users_in_dev:function(i){fh.show(eG("Unlink all users"),$("confirm-unlink-all-users"),{doit:function(){return new Ajax.DBRequest("/developers/unlink_all_users/"+i,{onSuccess:function(j){bF("#current-app-users-1, #current-app-users-2").text("0");return fh.hide()}})}});return false},unlink_all_teams_in_dev:function(i){fh.show(eG("Unlink all teams"),$("confirm-unlink-all-teams"),{doit:function(){return bF.ajax({url:"/developers/unlink_all_teams/"+i,type:"POST",success:function(j){bF("#current-app-teams").text("0");return fh.hide()}})}});return false},restore_sandbox:function(j,fr,i){var ft,T,fs;ft=bF("#restore-sandbox")[0];fh.show(eG("Restore app folder '%(filename)s'").format({filename:bU.em_snippet(aA.filename(fr),17)}),ft);fs=bF("#restore-sandbox-form")[0];T={ns_id:i};T[a9.UID_PARAM_NAME]=j.id;return bT.add_vars(fs,T)},submit_restore_sandbox:function(j){var i;i=$("restore-sandbox-form");bT.ajax_submit(i,false,(function(T){fh.hide();ah.success(eG("Restored app folder"));if(T.responseText.length){return cu.reload_fqpath(T.responseText)}else{return cu.reload("","",true)}}),false,j.target);return false},submit_app_info:function(i){var j;j=bF(i).find("input[name=name]").val();bT.clear_errors(i);return bT.ajax_submit(i,false,(function(){ah.success("App info updated.");if(j){return bF("#app-info h1").text(j)}}))},submit_folder_name:function(i){var j;j=bF(i).find("input[name=folder]").val();bT.clear_errors(i);return bT.ajax_submit(i,false,(function(){ah.success("App folder name updated.");bF("#folder-name .text").text(j);return bi.hide_folder_input()}))},submit_new_webhook:function(j){var T,fA,fy,ft,fv,fu,fz,fx,fs,fw,fr,i;fA=bF(j);fv=bF("#webhook-list");ft=bF("<img>").attr("src","/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif").css("vertical-align","middle");fy=fA.find("input[name=webhook_url]");fr=function(fC,fB){if(fB){fB.remove()}if(fv.find(".hoverable-url").length===0){fv.addClass("hide-status")}bF("#webhook-form-error").text(fC);return bF("#webhook-form").addClass("error")};fz=fy.val();if(fz===""){fr("Empty URI");return}fx=H.parse(fz);if((fs=fx.scheme)!=="http"&&fs!=="https"){fr("URI scheme must be http or https");return}if(!fx.authority){fr("Improperly formatted URI (typo maybe?)");return}if(((fw=fx.authority)==="localhost"||fw==="127.0.0.1")||fx.authority.indexOf("[::1]")===0){fr("Webhooks doesn't support localhost as Dropbox can't contact your local server. Please use an internet accessible URI.");return}if(fv.find("tbody").length>=Constants.MAX_WEBHOOKS_PER_APP){fr("You can register a maximum of %d webhook URIs per app.".format(Constants.MAX_WEBHOOKS_PER_APP));return}T=bF(this._webhook_info_row_tmpl({url:fz,status:"Verifying"}).toHTML());T.find(".status").append(ft);T.find(".webhook-actions").removeClass("disabled").addClass("enabled");fv.append(T);fv.removeClass("hide-status");bF("#webhook-form").removeClass("error");fu=bT.collect_form_vars(j);fy.val("");i=new Date().getTime();return bF.ajax({url:"/developers/apps/update/add_webhook",type:"POST",dataType:"json",data:fu,success:function(fD){var fB,fC;if(fD.status==="invalid"){fr(fD.failure_text,T);return fy.val(fz)}else{fC=new Date().getTime()-i;fB=Math.max(0,1000-fC);return setTimeout((function(){if(fD.status==="ok"){return T.find(".status").text("Enabled")}else{if(fD.status==="error"){T.find("textarea").text(fD.failure_text);T.find(".status").text(fD.status_text).addClass("error");T.find(".timestamp").text("Just now");return T.find(".webhook-failure-info").css("display","")}}}),fB)}},error:function(){ah.error("Unable to complete your request.");T.remove();return fy.val(fz)}})},remove_webhook:function(T,j){var fr,i;bF("#webhook-form").removeClass("error");i=bF(T).find(".value").text();fr=bF("<img>").attr("src","/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif").css("vertical-align","middle");bF(T).find(".status").text("Removing").removeClass("error").append(fr);return bF.ajax({url:"/developers/apps/update/remove_webhook",type:"POST",data:{app_id:j,webhook_url:i},dataType:"json",success:function(fu){var fs,ft;fs=T.parentNode;ft=fs.parentNode;ft.removeChild(fs);if(ft.getElementsByClassName("hoverable-url").length===0){bF(ft).addClass("hide-status")}if(!bF("#webhook_url").val()){return bF("#webhook_url").val(i)}},error:function(){return ah.error("Unable to complete your request.")}})},update_webhook_url:function(ft,fr,T){var fu,i,fs,fv,j;j=bF(ft.parentNode.parentNode).find(".value").text();bF("#webhook-form").removeClass("error");fs=ft.parentNode.parentNode.parentNode;fu=bF("<img>").attr("src","/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif").css("vertical-align","middle");i=bF(fs).find(".status").text();T=i==="Disabled";fv=T?"Enabling":"Disabling";bF(fs).find(".status").text(fv).removeClass("error").append(fu);return bF.ajax({url:"/developers/apps/update/update_webhook_url",type:"POST",data:{app_id:fr,webhook_url:j,enable:T},dataType:"json",success:function(fx){var fw;i=bF(fs).find(".status").text();fw=i==="Disabling"?"Disabled":"Enabled";bF(fs).find(".status").text(fw).removeClass("error").removeClass("img");if(i==="Disabling"){return bF(fs).find(".webhook-actions").removeClass("enabled").addClass("disabled")}else{return bF(fs).find(".webhook-actions").removeClass("disabled").addClass("enabled")}},error:function(fw){return ah.error("Unable to complete your request.")}})},set_oauth2_allow_implicit_grant:function(j,i){return bF.ajax({url:"/developers/apps/update/oauth2_allow_implicit_grant",type:"POST",data:{app_id:i,allow:bF(j).val()},dataType:"json",success:function(T){return ah.success("OAuth 2 allow implicit grant updated.")},error:function(){return ah.error("Error updating OAuth 2 allow implicit grant.")}})},submit_new_oauth_uri:function(j){var i;i=bF(j).find("input[name=oauth_uri]").val();bT.clear_errors(j);return bT.ajax_submit(j,false,(function(){ah.success("OAuth URI added.");bi.add_oauth_uri(i);return bF(j).find("input[name=oauth_uri]").val("")}))},add_oauth_uri:function(j){var i;i=bF("#oauth-uri-list");i.append(this._hoverable_tmpl({value:j}).toHTML());return i.show()},remove_oauth_uri:function(j,i){var T,fr;fr=bF(j).find(".value").text();T=function(ft){var fs;ah.success("OAuth URI removed.");fs=j.parentNode;fs.removeChild(j);if(fs.getElementsByTagName("div").length===0){return fs.hide()}};return bF.ajax({url:"/developers/apps/update/remove_oauth_uri",type:"POST",data:{app_id:i,oauth_uri:fr},dataType:"json",success:T,error:function(){return ah.error("Unable to complete your request.")}})},submit_new_domain:function(i){var j;j=bF(i).find("input[name=domain_name]").val();bT.clear_errors(i);return bT.ajax_submit(i,false,(function(){ah.success("Domain added.");bi.add_domain(j);return bF(i).find("input[name=domain_name]").val("")}))},add_domain:function(j){var i;i=bF("#domain-list");i.append(this._hoverable_tmpl({value:j}).toHTML());return i.show()},remove_domain:function(j,i){var T,fr;fr=bF(j).find(".value").text();T=function(ft){var fs;ah.success("Domain removed.");fs=j.parentNode;fs.removeChild(j);if(fs.getElementsByTagName("div").length===0){return fs.hide()}};return bF.ajax({url:"/developers/apps/update/remove_domain",type:"POST",data:{app_id:i,domain_name:fr},dataType:"json",success:T,error:function(){return ah.error("Unable to complete your request.")}})},show_need_users_modal:function(i){fh.show(eG("Please test this app",{comment:"Error message"}),$("app-need-users-modal"));return false},show_need_teams_modal:function(i){return fh.show(eG("Please test this app",{comment:"Error message"}),$("app-need-teams-modal"))},show_name_branding_modal:function(i){fh.show(eG("Please rename this app",{comment:"Error message"}),$("app-name-branding-modal"));return false},show_need_icon_modal:function(i){fh.show(eG("Please add an icon for this app",{comment:"Error message"}),$("app-need-icon-modal"));return false},check_for_nongenerated_oauth_tokens:function(j){var i;i="/developers/prod_request/"+j;new Ajax.DBRequest("/developers/has_nongenerated_oauth_tokens/"+j,{onSuccess:function(T){if(T.responseText==="true"){return b1.redirect(i)}else{return fh.show(eG("Please auth at least one user with the OAuth flow",{comment:"Error message"}),$("app-need-nongenerated-token"))}},onFailure:function(T){return b1.redirect(i)}});return false},hide_folder_input:function(){bF("#folder-name").show();return bF("#folder-input").hide()},show_folder_input:function(){bF("#folder-name").hide();bF("#folder-input").show();return bF("#folder-input input[name=folder]").focus()}};var cI,dM;dM=INLINE_JS.twitter_auth_complete=function(i){cP(i!=null,"user_id must be provided");if(cI.onLoginSuccessCallback){cI.onLoginSuccessCallback(i)}else{window.location.reload()}return false};cI=F.Twitter={is_authed:function(i){i=parseInt(i);if(cI._authed_users==null){cI._authed_users={}}return cI._authed_users[i]},set_is_authed:function(i,j){i=parseInt(i);if(cI._authed_users==null){cI._authed_users={}}return cI._authed_users[i]=j},get_progress_container:function(){var i;cP(cI.progress_container,"Twitter is missing progress_container");i=$(cI.progress_container);cP(i,"Missing progress_container elm");return i},follow_dropbox:function(j,i){var T;cP(i!=null,"user_id must be provided");if(j.showWorking){j.showWorking()}T=function(){if(j.onFailure){return j.onFailure()}else{return window.location.reload()}};return new Ajax.DBRequest("/twitter/follow_us",{onSuccess:function(fr){if(!fr.responseText.startsWith("ok")){return T()}else{if(j.onSuccess){return j.onSuccess()}}},onFailure:function(){return T()},subject_user:i})},do_auth:function(fr,i){var T,j;cP(i!=null,"user_id must be provided");j=H({path:"/twitter/request_token"}).updateQuery(a9.UID_PARAM_NAME,i).toString();window.open(j,"twitter_auth","width=800,height=400");T=function(fs){cI.set_is_authed(fs,true);return typeof fr==="function"?fr(fs):void 0};return cI.onLoginSuccessCallback=T},show_auth:function(i){if(i){cI.onLoginSuccessCallback=i}return dB.updateFromElm(cI.get_progress_container(),"inline-twitter-auth")},show_posting:function(){if(cI.should_hide_modal()){fh.hide()}return cI.get_progress_container().update(dB.fromElm("sharing-progress"))},show_complete:function(j){var i;i=cI.get_progress_container();i.update(dB.fromElm("sharing-posted"));return cI.show_complete_into(j,i)},show_complete_into:function(fu,i){var fr,fs,T,ft,j;fr="twitter";ft=eG("View tweet");j=void 0;if(fu.startsWith("ok")){j="http://www.twitter.com/"}else{j=fu}fs=i.down("#view-post");fs.href=j;fs.update(ft);T=cy.make("web",fr);return fs.__sert({top:T})},post:function(fr,ft,T,i){var fs,j;cP(i!=null,"user_id must be provided");cP(fr,"Twitter message is empty");fs={message:fr,from_referrals:cI.from_referrals,from_getspace:cI.from_getspace};new Ajax.DBRequest("/twitter_post",{parameters:fs,onSuccess:function(fu){var fv,fw;if(fu.responseText==="login"){cI.onLoginSuccessCallback=function(){return cI.post(fr,null,null,i)};fv=cI.custom_show_auth||cI.show_auth;return fv()}else{if(cI.should_hide_modal()){fh.hide()}fw=cI.onPostSuccessCallback||cI.show_complete;return fw(fu.responseText)}},subject_user:i});j=cI.custom_show_posting||cI.show_posting;return j()},custom_post:function(j,T,i){cP(i!=null,"user_id must be provided");if(T){cI.onPostSuccessCallback=T}if(!j){return}cP(j,"Twitter message doesn't exist");if(!cQ.get_viewer().is_signed_in){return window.open("http://www.twitter.com/home?status="+encodeURI(j))}else{return cI.post(j,null,null,i)}},get_user_info:function(j,i){cP(i!=null,"user_id must be provided");return new Ajax.DBRequest("/twitter/user_info",{noAutonotify:1,parameters:{},onSuccess:function(T){return j(JSON.parse(T.responseText))},subject_user:i})},should_hide_modal:function(){if(typeof cI.hide_modal==="undefined"){return true}else{return cI.hide_modal}}};var dz,e8,dL,Z,eY,au,bH,ao,e7,bD,fi=function(fr,j){for(var i in j){if(dq.call(j,i)){fr[i]=j[i]}}function T(){this.constructor=fr}T.prototype=j.prototype;fr.prototype=new T();fr.__super__=j.prototype;return fr},dq={}.hasOwnProperty,b3=function(i,j){return function(){return i.apply(j,arguments)}};dL=F.LightboxPreviewBase=(function(){function i(j){this.link_hash=j.link_hash;this.filename=j.filename;this.fq_path=j.fq_path;this.thumbnail_url_tmpl=j.thumbnail_url_tmpl;this.dl_url=j.dl_url;this.ns_id=j.ns_id;this.ns_path=j.ns_path;this.display_time=j.display_time||null;this.more_actions_item_tmpl=fm.tmpl("lightbox_more_actions_item_tmpl")}i.prototype.shutdown=function(){};i.prototype.preload=function(){};i.prototype.render=function(){};i.prototype.image_size=function(){var j;j=document.viewport.getDimensions();return aG(j.width,j.height)};i.prototype.get_more_actions_above_divider=function(T){var fr,j;j=[];fr=this.more_actions_item_tmpl({_id:"lightbox_download_link",_href:this.dl_url,_ns_id:this.ns_id,_ns_path:this.ns_path,sprite_name:"lightbox_download",item_text:eG("Download"),more_classes:"more-actions-item",Sprite:cy});j.push(fr);return j};i.prototype.get_more_actions_below_divider=function(j){return[]};i.prototype.is_a_timeline_preview=function(){return this instanceof eY||this instanceof dz||this instanceof au||this instanceof e8};i.prototype.is_an_album_preview=function(){return this instanceof eY||this instanceof au};i.prototype.is_a_photo_preview=function(){return this instanceof Z};i.prototype.is_a_video_preview=function(){return this instanceof bH};i.prototype.get_actions=function(fr){var ft,fv,fw,T,fs,j,fu;j=[];if(!this.is_a_timeline_preview()&&fr.enable_sublinks){if(fr.share_button_experiment_variant==="WHITE_BUTTON"){fw=bF("#lightbox-share-action-base").clone().attr("id","lightbox-share-button");if(this.shmodel_link){fs=(function(fx){return function(fy){ba.ShmodelUILogger.log("via-shmodel-lightbox");return window.open(H.parse(fx.shmodel_link).updateQuery("m","1"))}})(this)}else{fs=(function(fx){return function(fy){fy.preventDefault();ba.ShmodelUILogger.log("via-browse-lightbox");return dE.shmodel(fx.fq_path,"browse_lightbox")}})(this)}}else{fw=bF("<a />",{id:"lightbox_share_link","class":"title_bubble black"});fw.html(cy.make("web","link_white"));if(this.is_a_photo_preview()){fw.attr("title",eG("Share link to photo"))}else{if(this.is_a_video_preview()){fw.attr("title",eG("Share link to video"))}else{cP(false,"preview needs to be a photo or video")}}if(this.shmodel_link){fw.attr("href",H.parse(this.shmodel_link).updateQuery("m","1"));fw.attr("target","_blank");fs=(function(fx){return function(fy){return ba.ShmodelUILogger.log("via-shmodel-lightbox")}})(this)}else{fw.attr("href","#");fs=(function(fx){return function(fy){fy.preventDefault();ba.ShmodelUILogger.log("via-browse-lightbox");return dE.shmodel(fx.fq_path,"browse_lightbox")}})(this)}}fw.on("click",fs);j.push(fw[0])}if(fr.include_delete){fu=bQ.in_single_collection_view()?eG("Remove"):eG("Delete");if(fr.share_button_experiment_variant==="WHITE_BUTTON"){ft=bF("#lightbox-delete-action-base").clone().attr("id","lightbox-delete-link");ft.find(".sprite-text-inner").text(fu);ft.on("click",(function(fx){fx.preventDefault();return aM.delete_current()}))}else{ft=bF("<a />",{id:"lightbox-delete-button",href:"#","class":"title_bubble black",title:fu});ft.html(cy.make("web","lightbox_delete_16"));ft.on("click",(function(fx){fx.preventDefault();return aM.toggle_delete()}))}j.push(ft[0])}if(fr.share_button_experiment_variant==="WHITE_BUTTON"){T=(function(fx){return function(fy){fy.preventDefault();return aM.toggle_more_actions_menu()}})(this);fv=bF("#lightbox-more-actions-base").clone().attr("id","lightbox-more-actions-button").on("click",T);j.push(fv[0])}else{cP(aM.more_actions_button!=null,"Lightbox should have a more_actions_button added on init");j.push(aM.more_actions_button)}return j};i.prototype.delete_pressed=function(){var j;j=eG("Deleting...");if(this.is_a_timeline_preview()){if(bQ.in_single_collection_view()){j=eG("Removing...");bQ.get_current_collection().remove_photos([this.photo])}else{bQ._delete_photos([this.photo])}}else{document.fire(aM.PHOTO_DELETE_EVT,this)}return ah.success(j)};i.prototype.set_more_actions_event_handlers=function(j){};i.prototype.replace_dl_action_with_open_action_if_file_available=function(){var T,fs,fr,j;if(__CONDITIONAL_JS__.UnityFeatures==null){return}j=cu.active_user.id;fr=(function(ft){return function(fu,fx,fv){var fy,fw;fy=bF("#lightbox_download_link");if(!(fy.data("ns-id")===fu&&fy.data("ns-path")===fx)){return}fw=bF(ft.more_actions_item_tmpl({_id:"unity_open_action",_href:"#",_ns_id:fu,_ns_path:fx,sprite_name:"lightbox_open",item_text:eG("Open"),more_classes:"more-actions-item",Sprite:cy}).toHTML());fy.replaceWith(fw);return fw.on("click",function(fz){return __CONDITIONAL_JS__.UnityFeatures.open_file(fu,fx,fv,__CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler,function(fA){return __CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler(false)})})}})(this);if((fs=__CONDITIONAL_JS__.UnityCheckFileCache)!=null?fs.is_cached_and_locally_available(this.ns_id,this.ns_path):void 0){return fr(this.ns_id,this.ns_path,j)}else{T=(function(ft){return function(fu){if(fu.is_locally_available){return fr(ft.ns_id,ft.ns_path,j)}}})(this);return __CONDITIONAL_JS__.UnityFeatures.check_file(this.ns_id,this.ns_path,j,T)}};return i})();Z=INLINE_JS.PhotoPreview=F.PhotoPreview=(function(j){fi(i,j);function i(T){i.__super__.constructor.call(this,T);this.original_url=String(H.parse(T.original_url).updateQuery(a9.UID_PARAM_NAME,cu.active_user));this.shmodel_link=T.shmodel_link;this.fail_image_src="/static/images/preview_fail-vflc3IDxf.png";if(this.is_gif()){this.thumbnail_url_tmpl=this.original_url}this.loaded=false;this.enable_download=T.enable_download}i.prototype.show_fail=function(fr){var T;return T=bF(fr).find(".lightbox_fail_text").text(eG("Unable to preview this item."))};i.prototype.fallback=function(fr){var T,fs;T=$(fr.target);T.writeAttribute({src:this.fail_image_src,width:128,height:128});fs=T.up("div.content-item");if(fs){return this.show_fail(fs)}};i.prototype.is_gif=function(){return"gif"===aA.file_extension(this.filename).toLowerCase()};i.prototype.preload=function(fs){var fr,ft,T;T=H.parse(this.thumbnail_url_tmpl).updateQuery({size:this.image_size()}).toString();if(this.is_gif()){T=this.thumbnail_url_tmpl}ft=(function(fu){return function(){if(typeof fs==="function"){fs()}return fu.loaded=true}})(this);ec.preload_image(T,this.fallback.bind(this),ft);fr=$(ec.preloaded_images[T]);fr.writeAttribute("data-original-href",this.original_url);fr.setAttribute("enable-download",this.enable_download);fr.writeAttribute("class","thumbnail");return fr};i.prototype.render=function(fv,fs){var ft,fr,fu,T,fw;if(this.loaded){fs()}fr=this.preload(fs);fw=bF("<div />",{"class":"content-item"}).append(fr);ft=bF("<div />",{"class":"lightbox_fail_text"});fw.append(ft);fu=fr.getAttribute("src").length;T=fr.getAttribute("src").substring(fu-this.fail_image_src.length,fu);if(T===this.fail_image_src){this.show_fail(fw)}fv.appendChild(fw[0]);return fw[0]};i.prototype.advance_on_click=true;i.prototype.get_more_actions_above_divider=function(fs){var fr,T;T=i.__super__.get_more_actions_above_divider.call(this,fs);fr=this.more_actions_item_tmpl({_id:"view_original",_href:this.original_url,_target:"_blank",sprite_name:"lightbox_view_original",item_text:eG("View original"),more_classes:"more-actions-item",Sprite:cy});T.push(fr);return T};return i})(dL);bH=F.VideoPreview=(function(i){fi(j,i);function j(T){this._player_error=b3(this._player_error,this);this._player_ready=b3(this._player_ready,this);j.__super__.constructor.call(this,T);this.preview_url=T.preview_url;this.shmodel_link=T.shmodel_link;this.thumbnail_div=null;this.metadata_link=T.metadata_link!=null?T.metadata_link:void 0;this.metadata=null;this.player=null}j.prototype.render_error=function(ft){var fv,fr,T,fs,fu;fr=bF("<div/>");T=bF("<img/>",{src:"/static/images/preview_fail-vflc3IDxf.png","class":"video-preview-fail"});fs=bF("<div/>",{"class":"video-preview-fail"});if(ft==="needflash"){fs.html(eG('Install <a href="http://get.adobe.com/flashplayer/">Adobe Flash Player</a> to view this video.'))}else{fs.text(eG("Unable to preview this item.",fu="web",fv="preview means showing the item in the same browser window without downloading a copy."))}fr.append(T,fs);return fr[0]};j.prototype._player_ready=function(){var T;T=function(){bF(".vjs-poster").show();bF(".vjs-big-play-button").show();return bF(".vjs-big-play-button").focus()};return T.defer()};j.prototype._onPlay=function(){bF(".vjs-poster").hide();return bF(".vjs-big-play-button").hide()};j.prototype._onEnded=function(){bF(".vjs-poster").show();bF(".vjs-big-play-button").show();return bF(".vjs-loading-spinner").hide()};j.prototype._player_error=function(T){this.shutdown();this.div=this.render_error(T);return bF("#file-preview-modal .content-item").html(this.div)};j.prototype.preload=function(){};j.prototype.render=function(fr,T){this.div=this.render_video(fr);return this.div};j.prototype.render_video=function(fw){var T,fu,fs,fr,fv,ft;ft=new Element("div",{"class":"video-player content-item"});fv=this.image_size().split("x")[0]*0.8;fr=parseInt(fv*0.55,10);fu=false;fs=H.parse(this.thumbnail_url_tmpl).updateQuery({size:this.image_size()}).toString();T=(function(fx){return function(fy){return fx.metadata=fy}})(this);this.player=bt.embed(ft,{src:this.preview_url,type:Constants.transcoder_hls4web?"application/vnd.apple.mpegurl":"video/flv",width:fv,height:fr,controls:true,preload:"auto",poster:fs,onError:this._player_error,onReady:this._player_ready,metadata:this.metadata,metadata_link:this.metadata_link,metadata_cb:T});fw.appendChild(ft);bF(".vjs-poster").hide();bF(".vjs-big-play-button").hide();this.player.on("play",this._onPlay);this.player.on("ended",this._onEnded);return ft};j.prototype.shutdown=function(){var fr,fs,T;bF(".vjs-big-play-button").blur();if(this.player){try{this.player.trigger("shutdown");if(this.player.techName==="Hls"){if((T=this.player.tech.sourceBuffer)!=null){T.abort()}}this.player.dispose()}catch(fs){fr=fs}return this.player=null}};return j})(dL);ao=function(T){var i,j;i=(function(fs){fi(fr,fs);function fr(ft){ft.ns_id=ft.photo.ns_id;ft.ns_path=ft.photo.ns_path;fr.__super__.constructor.call(this,ft);this.photo=ft.photo;bo.set_vertical_space(3);if(bQ.in_single_collection_view()){bF("#lightbox-delete-photo").val(eG("Remove"))}else{bF("#lightbox-delete-photo").val(eG("Delete"))}}fr.prototype.get_more_actions_above_divider=function(fv){var fu,ft;ft=fr.__super__.get_more_actions_above_divider.call(this,fv);fu=this.more_actions_item_tmpl({_id:"lightbox_add_to_album",sprite_name:"lightbox_add_to_album",item_text:eG("Add to album"),more_classes:"more-actions-item",Sprite:cy});ft.push(fu);return ft};fr.prototype.toggle_select_button_off=function(ft){if(this.is_a_photo_preview()){ft.attr("title",eG("Select photo"))}else{if(this.is_a_video_preview()){ft.attr("title",eG("Select video"))}}ft.html(cy.make("web","lightbox_unselected"));ft.removeClass("selected");ft.addClass("elbboggiw");return setTimeout((function(){return ft.removeClass("elbboggiw")}),540)};fr.prototype.toggle_select_button_on=function(ft){if(this.is_a_photo_preview()){ft.attr("title",eG("Un-select photo"))}else{if(this.is_a_video_preview()){ft.attr("title",eG("Un-select video"))}}ft.html(cy.make("web","lightbox_selected"));ft.addClass("selected");ft.addClass("wiggobble");return setTimeout((function(){return ft.removeClass("wiggobble")}),540)};fr.prototype.toggle_select=function(fu){var ft;fu.preventDefault();ft=bF("#lightbox-select-button");bo.hide_all();if(e0.contains(this.photo)){e0._remove(this.photo);return this.toggle_select_button_off(ft)}else{e0._add(this.photo);return this.toggle_select_button_on(ft)}};fr.prototype.get_actions=function(fv){var fu,ft,fw;fu=[];fw=bF("<a />",{id:"lightbox_share",href:"#","class":"lightbox-button lightbox-not-important"});aM.update_share_button_text(null,bF(fw));fw.on("click",((function(fx){return function(fz){var fy;fz.preventDefault();fy=e0.get();if(fy.length===0){return eF.show([fx.photo],false)}else{return eF.show(e0.get(),false)}}})(this)));ft=bF("<a />",{id:"lightbox-select-button",href:"#","class":"title_bubble black",title:eG("Select this photo")});if(e0.contains(this.photo)){ft.html(cy.make("web","lightbox_selected"))}else{ft.html(cy.make("web","lightbox_unselected"))}ft.on("click",this.toggle_select.bind(this));fu.push(fw[0]);fu.push(ft[0]);return fu.concat(fr.__super__.get_actions.call(this,fv))};fr.prototype.set_more_actions_event_handlers=function(ft){$("lightbox_add_to_album").observe("click",((function(fu){return function(fv){fv.preventDefault();return cN.show_add_to_album_modal(fv,[fu.photo])}})(this)));$("lightbox_show_in_folder").observe("click",((function(fu){return function(fv){fv.preventDefault();return bQ.show_in_folder(fu.photo)}})(this)));return fr.__super__.set_more_actions_event_handlers.call(this,ft)};fr.prototype.get_more_actions_below_divider=function(fv){var fu,ft;fu=[];ft=this.more_actions_item_tmpl({_id:"lightbox_show_in_folder",sprite_name:"lightbox_show_in_folder",item_text:eG("Show in folder"),more_classes:"more-actions-item",Sprite:cy});fu.push(ft);fu=fu.concat(fr.__super__.get_more_actions_below_divider.call(this,fv));return fu};return fr})(T);j=(function(fs){fi(fr,fs);function fr(){return fr.__super__.constructor.apply(this,arguments)}fr.prototype.get_more_actions_below_divider=function(fv){var ft,fu;fu=[];ft=this.more_actions_item_tmpl({_id:"lightbox_remove_from_album",sprite_name:"lightbox_remove_from_album",item_text:eG("Remove from album"),more_classes:"more-actions-item",Sprite:cy});fu.push(ft);fu=fu.concat(fr.__super__.get_more_actions_below_divider.call(this,fv));return fu};fr.prototype.set_more_actions_event_handlers=function(ft){$("lightbox_remove_from_album").observe("click",((function(fu){return function(fv){fv.preventDefault();return cN.show_remove_photos_modal(bQ.get_current_collection(),[fu.photo])}})(this)));return fr.__super__.set_more_actions_event_handlers.call(this,ft)};return fr})(i);return[i,j]};e7=ao(Z),dz=e7[0],eY=e7[1];bD=ao(bH),e8=bD[0],au=bD[1];var aM;aM=INLINE_JS.Lightbox=F.Lightbox=(function(){var i,fO,fX,gj,fr,gd,fw,fW,f8,fE,f7,fT,f2,gi,fD,fU,fB,f6,ga,fv,f9,fu,fM,gc,fG,fV,fy,fP,f3,fQ,fZ,fs,fI,j,fY,gb,gh,f5,fF,fL,ft,fK,f1,T,fz,f4,fR,fS,fC,fN,fA,gg,fJ,fH,gf,ge,f0,fx;ge=[];fJ=0;f0=false;gf=true;fR=void 0;i=/^\d+\-\d+\-\d+\s+\d+\.\d+\.\d+/;fx=false;gc=void 0;f8=void 0;f1=-1;T=null;f2=null;fU=false;j=false;fv=false;fB=null;fD=function(gk){return gk.complete!==false};ft=function(){var gk;if($$("#file-preview-modal .loading-image").length){return}gk=new Element("img",{"class":"loading-image",src:"/static/images/icons/ajax-loader-black-vflweQQeE.gif"});return $$("#file-preview-modal .preview-content").first().__sert(gk)};fT=function(){return $$("#file-preview-modal .loading-image").invoke("remove")};fQ=function(){var gq,gp,gm,gk,go,gn,gl;gp=$$("#file-preview-modal .content-item").first().down("img.thumbnail");if(!gp||!fD(gp)){return}gk=$$("#file-preview-modal .preview").first().getDimensions();gq=void 0;if(!gp.naturalHeight){gq=gp.getDimensions();gp.naturalHeight=gq.height;gp.naturalWidth=gq.width}else{gq={width:gp.naturalWidth,height:gp.naturalHeight}}gm=gq.width/gk.width;gl=gq.height/gk.height;gn=Math.max(gm,gl);gp.style.visibility="";if(gn<1){gp.style.width="";gp.style.height=""}else{gp.style.width=Math.floor(gq.width/gn)+"px";gp.style.height=Math.floor(gq.height/gn)+"px"}go=bF("#file-preview-modal .paging-block").position().left-16;return bF("#file-preview-modal .filename").css("max-width",go)};fW=void 0;f9=function(){var gr,gm,gq,gl,gk,gp,go,gn;gm=$("file-preview-modal");gp=gm.down(".menu");gq=gm.down(".header");go=$$(".lightbox-not-important");gn=[];for(gl=0,gk=go.length;gl<gk;gl++){gr=go[gl];gn.push(gr.addClassName("opacity-zero"))}return gn};fK=function(){var go,gl,gk,gn,gm;if(fW){clearTimeout(fW)}gn=$$(".lightbox-not-important");gm=[];for(gl=0,gk=gn.length;gl<gk;gl++){go=gn[gl];gm.push(go.removeClassName("opacity-zero"))}return gm};fZ=function(gl){var gk;fK();gk=gl&&$(gl.target).descendantOf("file-preview-menu");if(fW!=null){clearTimeout(fW)}if(gf){if(!fx&&!gk){return fW=setTimeout(f9,3112)}}};f4=function(){if(fW!=null){clearTimeout(fW)}return gf=false};fz=function(){gf=true;return fZ()};gi=function(gl){var gk;gk=ge.length;return(gk+(fJ+gl)%gk)%gk};fV=function(gl){var gm,gk;if(gc.no_preload){return}gk=fF.bind(null,gl);return typeof(gm=ge[gl]).preload==="function"?gm.preload(gk):void 0};fy=function(){var gm,gl,gk,go,gn;go=[1,2,3,4,5,6,-1,-2];gn=[];for(gm=0,gl=go.length;gm<gl;gm++){gk=go[gm];if(Math.abs(gk)<ge.length){gn.push(fV(gi(gk)))}else{gn.push(void 0)}}return gn};fI=function(gk){if(!gc.filename_in_url){return}if(gk!=null){a3.replace_hash("lh",gk)}else{a3.replace_hash("")}return fB=gk};f3=function(){var gk,gl;gk=bF("#file-preview-modal");gl=(gc!=null?gc.num_previews:void 0)||ge.length;if(fU&&j&&fv){gk.find(".lightbox-index-text-container").text(eG("Could not load folder",{comment:"Error shown when a folder fails to load"}))}else{if(fU){if(j){gk.find(".lightbox-index-text-container").text(eG("Loading...",{comment:"Shown while waiting for photos/videos to load"}))}else{gk.find(".lightbox-index-text-container").text("")}}else{gk.find(".lightbox-index-text-container").text(eG("%(cur_file_num)s of %(num_total_files)s",{comment:"Indicating which we're viewing, like '3 of 10'"}).format({cur_file_num:fJ+1,num_total_files:gl}))}}if(ge.length===1){gk.find(".prev").addClass("opacity-zero");return gk.find(".next").addClass("opacity-zero")}else{if(fJ===0&&gc.no_wrap){gk.find(".prev").addClass("opacity-zero");return gk.find(".next").removeClass("opacity-zero")}else{if(fJ===ge.length-1&&gc.no_wrap){gk.find(".prev").removeClass("opacity-zero");return gk.find(".next").addClass("opacity-zero")}else{gk.find(".prev").removeClass("opacity-zero");return gk.find(".next").removeClass("opacity-zero")}}}};fr=function(gn,gk,gm,gl){var go;go={user_id:null,target:gk,platform:aX.FileViewPlatformType.WEB,ns_id:gn.ns_id,sjid:null,ns_path:gn.ns_path,shared_link_url:gm,origin:aX.FileViewOriginType.PHOTOS,action:aX.FileViewActionType.CLICK,extra:{file_ext:gl}};return go};fY=function(gl,gI){var gv,gw,gy,gD,gs,gm,go,gn,gz,gk,gE,gu,gp,gH,gG,gC,gt,gB,gr,gA,gF,gq,gx;f1=b6.time();cP(fJ<ge.length,"Invalid index "+fJ);gA=ge[fJ];if(typeof gA!=="object"){if(T){clearTimeout(T)}T=setTimeout((function(){if((aM.shown!=null)&&aM.shown){return fY(gl,gI)}}),100);return}bF("#file-preview-modal").trigger(aM.LIGHTBOX_SHOW_EVT,{preview:gA});gm=aA.file_extension_for_logging(gA.filename);gn=aX.FileViewTargetType.PRIVATE;go=null;gp="lightbox";if(gA.fq_path!=null){gn=aX.FileViewTargetType.PRIVATE;gp="browse_lightbox"}else{if(gA.shmodel_link!=null){gn=aX.FileViewTargetType.SHARED_LINK;go=gA.shmodel_link;gp="shmodel_lightbox"}}gz=fr(gA,gn,go,gm);ba.FileViewLogger.log(gz);ba.WebLightboxLogger.log(ba.WebLightboxLogger.VIEW,{context:gp,file_ext:gm});gG=bF("#file-preview-modal");gF=gG.find(".preview-content");gr=gl?f5:fF;gF.empty();gs=gA.render(gF[0],gr);gG=gG[0];if(!f2){f2=gG.on("contextmenu","img.thumbnail",bn.show_for_lightbox.bind(bn))}fI(gA.link_hash);f3();if(gA.display_time){if(gA.filename.match(i)){gG.down(".filename").__date(gA.display_time)}else{gG.down(".filename").__date(gA.display_time+" - "+gA.filename)}}else{gG.down(".filename").__date(gA.filename)}gG.down(".filename").writeAttribute("title",gA.filename);if(bQ.in_single_collection_view()&&((gq=bQ.get_current_collection().member_fnames)!=null?gq.length:void 0)>1&&(((gx=gA.photo)!=null?gx.item_owner_fname:void 0)!=null)){gD="&nbsp;&nbsp;&middot;&nbsp;&nbsp;";gD+=eG("Added by %(fname)s").format({fname:bU.em_snippet(gA.photo.item_owner_fname,7)});gG.down(".added-by").__date(new fm(gD));gG.down(".added-by").show()}else{gG.down(".added-by").hide()}gt=fm.tmpl("lightbox_more_actions_item_tmpl");gC=gA.get_more_actions_above_divider(gc);gy=gA.get_more_actions_below_divider(gc);if(gy.length){gC.push(gt({divider:true,Sprite:cy}));gC=gC.concat(gy)}$("lightbox-more-actions-list").__date(gC);gA.set_more_actions_event_handlers(gc);if(bF(gG).data("is-unity-allowed")==="True"&&(__CONDITIONAL_JS__.UnityFeatures!=null)){gA.replace_dl_action_with_open_action_if_file_available()}gw=gA.get_actions(gc);gk=document.createDocumentFragment();for(gE=0,gu=gw.length;gE<gu;gE++){gv=gw[gE];gk.appendChild(gv)}gG.down(".actions").__date();gG.down(".actions").appendChild(gk);if(gc.share_button_experiment_variant==="WHITE_BUTTON"){gB=bF("#lightbox-more-actions-button .sprite-div").width();bF("#lightbox-more-actions-menu").css("right",gB/2)}document.fire(aM.ACTIONS_ADDED);if(bQ.in_single_collection_view()){gG.down(".album-name").show().__date(bU.em_snippet(bQ.get_current_collection().name,15,1));gG.down(".filename").addClassName("faded")}else{gG.down(".album-name").hide();gG.down(".filename").removeClassName("faded")}gs=gs.down("img.thumbnail");if(gs){if(!fD(gs)){gs.hide();ft();gs.observe("load",function(){fT();gs.style.visibility="hidden";gs.show();return fQ()})}else{gs.show();fQ()}}gH={preview_obj:gA,index:fJ,direction:gI};return document.fire(aM.PHOTO_CHANGE_EVT,gH)};gh=function(gp){var gl,gm,gk,gn,go;if(f1===-1){return}go=b6.time()-f1;if(typeof g!=="undefined"&&g!==null){gl=g.get_current_view()}else{if(typeof am!=="undefined"&&am!==null?am.is_album:void 0){gl="album_shmodel"}else{gl="not_photos"}}gm={current_view:gl};gk=bF("#file-preview-modal .content-item img.thumbnail")[0];if((gk!=null)&&(gk.src!=null)){gn=H.parse(gk.src).getQuery();if("size" in gn){gm.size=gn.size}}en.log_ajax_transition(go,gp,gm);f1=-1;return fy()};f5=function(){return gh("file-preview-lightbox-load-initial")};fF=function(gk){var gl;if(typeof gk==="number"){if((gl=ge[gk])!=null){gl.loaded=true}if(gk===fJ){return gh("file-preview-lightbox-load")}}else{return gh("file-preview-lightbox-load")}};gb=function(gk){var gl;gl=bF("#lightbox-click-catcher");if(!gl.length){gl=bF("<div />",{id:"lightbox-click-catcher",style:"position: absolute; width: 100%; height: 100%; top: 0px; left: 0px; z-index: 2;"});gl.appendTo("#file-preview-modal .modal-preview-content");if(b1.msie_version_at_most(10)){gl.css("background","black");gl.fadeTo(0,0)}}gl.off("click");gl.on("click",(function(gm){gm.preventDefault();return gk()}));return gl.show()};fE=function(){return bF("#lightbox-click-catcher").hide()};gj=function(){var gk;gk=bF("#lightbox-more-actions-button");if(gk.hasClass("toggled")){fE();gk.removeClass("toggled");$("lightbox-more-actions-menu").hide();bF(document).trigger("dropdownClosed",[1]);fz();return true}return false};fM=function(){var gk;gk=bF("#lightbox-more-actions-button");if(!gk.hasClass("toggled")){f7();gk.addClass("toggled");bo.hide_all();bF("#lightbox-more-actions-menu").show();bF(document).trigger("dropdownOpened",[1]);f4();return gb(aM.close_more_actions_menu)}};fC=function(){if(bF("#lightbox-more-actions-button").hasClass("toggled")){return gj()}else{return fM()}};fu=function(gl){var gk;if(fU){j=true;f3()}gj();if(gl){gl.preventDefault()}if(fJ===ge.length-1&&gc.no_wrap){return}if((gk=ge[fJ])!=null){gk.shutdown()}fJ=gi(1);if(fJ===0){fZ()}return fY(null,aM.NEXT)};fP=function(gl){var gk;if(fU){j=true;f3()}gj();if(gl){gl.preventDefault()}if(fJ===0&&gc.no_wrap){return}if((gk=ge[fJ])!=null){gk.shutdown()}fJ=gi(-1);return fY(null,aM.PREV)};fX=function(gk){if(gk){gk.preventDefault()}if(ge[fJ].advance_on_click){if(gk.clientX<bF(window).width()/10){return fP()}else{return fu()}}};gd=function(gq){var gn,gk,gp,gr,gm,gl,go;gn=ge.dict_by("fq_path");gr=void 0;if(gq.memo.files){gr=gq.memo.files.collect(function(gs){return gs.fq_path})}else{gr=gq.memo.fq_paths}go=[];for(gm=0,gl=gr.length;gm<gl;gm++){gp=gr[gm];if(gn[gp]){gk=ge.indexOf(gn[gp]);ge.splice(gk,1);if(gc.num_previews){gc.num_previews--}if(!gc.num_previews&&!ge.length){go.push(f8())}else{if(gk===ge.length){go.push(fP())}else{go.push(fY())}}}else{go.push(void 0)}}return go};fs=function(gk){if(ge[fJ].is_a_timeline_preview()){return ge[fJ].toggle_select(gk)}};fN=function(){Event.stopObserving(document,"mousemove",fZ);Event.stopObserving(document,"click",fZ);document.stopObserving(aM.PHOTO_DELETE_EVT,fG);document.stopObserving(aH.DELETE,gd);document.stopObserving(e0.CHANGE_EVT,fA);return clearInterval(fR)};f8=function(go){var gn,gm,gl,gk;if(go){go.preventDefault()}if(!aM.shown){return}if((gm=ge[fJ])!=null){gm.shutdown()}gn=$("file-preview-modal");gn.hide();gn.down(".preview-content").__date();D.scroll_unlock_document();fN();fI();aM.shown=0;gn.stopObserving("click",aM.back);if((gl=$$(".preview-content"))!=null){if((gk=gl.first())!=null){gk.stopObserving("click")}}return bF("#file-preview-modal").trigger(aM.LIGHTBOX_HIDE_EVT)};fH="db:filepreview:exitselect";fO=function(gl){var gk;if(gc.keep_url){f8()}else{if((gk=ge[fJ])!=null){gk.shutdown()}window.history.go(-1)}if(gl!=null){if(gl.originalEvent){gl=gl.originalEvent}Event.extend(gl).stop()}return document.fire(fH,ge[fJ])};fG=function(gk){return dK.do_delete(cu.active_user,gk.memo.fq_path)};ga=function(){var gk;if(!f0){gk=bF("#file-preview-modal");gk.on("click",".close",fO);key("esc",aM.KEY_SCOPE,(function(gl){if(bF("#lightbox-more-actions-button").hasClass("toggled")){return gj()}else{if(fx){return f7()}else{return fO(gl)}}}));gk.on("click",".next",fu);gk.on("click",".prev",fP);gk.on("click",".preview-container",fX);key("left, k",aM.KEY_SCOPE,function(gl){return fP()});key("right, j",aM.KEY_SCOPE,function(gl){fu();return false});key("up, down",aM.KEY_SCOPE,function(gl){return false});key("x, s, space",aM.KEY_SCOPE,function(gl){fs(gl);return false});if(gc.include_delete&&gc.share_button_experiment_variant!=="WHITE_BUTTON"){key("delete, command+backspace, backspace",aM.KEY_SCOPE,function(gl){Event.extend(gl).preventDefault();return aM.toggle_delete()});bF("#lightbox-delete-photo").on("click",(function(gl){fS();return ge[fJ].delete_pressed()}));bF("#lightbox-delete-cancel").on("click",f7)}eJ.add_exit_callback("/lightbox",function(){return f8()});ec.disableSelection(gk.find(".preview-container")[0]);ec.disableSelection(gk.find(".header")[0]);f0=true}Event.observe(document,"mousemove",fZ);Event.observe(document,"click",fZ);document.observe(aH.DELETE,gd);document.observe(aM.PHOTO_DELETE_EVT,fG);document.observe(e0.CHANGE_EVT,fA);key.setScope(aM.KEY_SCOPE);return fR=setInterval(fQ,500)};f6=function(){var gn,gl,gk,go,gm;if(!fB){return}gm=[];for(gn=gl=0,gk=ge.length;gl<gk;gn=++gl){go=ge[gn];if(go.link_hash&&go.link_hash.toLowerCase()===fB.toLowerCase()){fJ=gn;if(!aM.shown){gm.push(aM.show())}else{gm.push(fY())}}else{gm.push(void 0)}}return gm};gg=function(){return on_script_loaded(function(){a3.watch("lh",function(gk){fB=gk;return f6()});return a3.watch("f",function(gk){var go,gm,gl,gp,gn;gn=[];for(go=gm=0,gl=ge.length;gm<gl;go=++gm){gp=ge[go];if(gp.filename.toLowerCase()===gk.toLowerCase()){fJ=go;if(!aM.shown){gn.push(aM.show())}else{gn.push(fY())}}else{gn.push(void 0)}}return gn})})};fA=function(go,gq){var gm,gp,gn,gk,gl;if(gq==null){gq=bF("#lightbox_share")}gl=e0.get();gn=de.categorize_files(gl),gm=gn[0],gp=gn[1];if(gl.length===0){gq.text(eG("Share"));return(gk=ge[fJ])!=null?gk.toggle_select_button_off(bF("#lightbox-select-button")):void 0}else{if(gl.length===1){if(gm){return gq.text(eG("Share 1 photo"))}else{return gq.text(eG("Share 1 video"))}}else{if(gm&&gp){return gq.text(eG("Share %(num_files)s items",{comment:"num_files is a number greater than 1"}).format({num_files:gl.length}))}else{if(gm){return gq.text(eG("Share %(num_photos)s photos",{comment:"num_photos is a number greater than 1"}).format({num_photos:gl.length}))}else{return gq.text(eG("Share %(num_videos)s videos",{comment:"num_videos is a number greater than 1"}).format({num_videos:gl.length}))}}}}};fL=function(){bo.hide_all();bF("#file-preview-modal .delete-file-prompt").show();bF(document).trigger("dropdownOpened",[1]);fK();fx=true;gb(aM.toggle_delete);return bF("#lightbox-delete-photo").focus()};f7=function(){var gl,gk;if(fx){gl=bF("#file-preview-modal .delete-file-prompt");gl.hide();bF(document).trigger("dropdownClosed",[1]);if((gk=gl.find(":focus")[0])!=null){gk.blur()}fZ();fx=false;return fE()}};fS=function(){gj();if(fx){return f7()}else{return fL()}};fw=function(){return ge[fJ].delete_pressed()};return{init_from_preview_objs:function(go,gr,gl){var gq,gn,gm,gp,gk;if(gl==null){gl=true}gk=[];for(gn=0,gm=go.length;gn<gm;gn++){gq=go[gn];if(gq.is_video){gp=new bH({filename:gq.filename,fq_path:gq.path,thumbnail_url_tmpl:gq.thumbnail_url,preview_url:gq.preview_url,dl_url:gq.dl_url,shmodel_link:gq.shmodel_link,ns_id:gq.ns_id,ns_path:gq.path,link_hash:gq.item_id+"-"+gq.filename,metadata_link:gq.metadata_link})}else{gp=new Z({filename:gq.filename,fq_path:gq.path,thumbnail_url_tmpl:gq.thumbnail_url,dl_url:gq.dl_url,original_url:gq.orig_url,shmodel_link:gq.shmodel_link,ns_id:gq.ns_id,ns_path:gq.ns_path,link_hash:gq.item_id+"-"+gq.filename,enable_download:gq.enable_download})}gk.push(gp)}aM.init(gk,{include_delete:false,keep_url:true,filename_in_url:true,enable_sublinks:gl});return document.on(aM.EXIT_SELECT_EVT,function(gt){var gs;key.setScope("all");gs=bF(gr)[gk.indexOf(gt.memo)];ec.scroll_to_thumb(gs);bF(gs).addClass("wiggobble");return setTimeout((function(){return bF(gs).removeClass("wiggobble")}),1000)})},init:function(gk,gl){if(aM.shown){return}aM.more_actions_button=new Element("a",{id:"lightbox-more-actions-button",href:"#","class":"lightbox-more-actions-button title_bubble black extra-margin",title:eG("More actions")});aM.more_actions_button.observe("click",(function(gm){gm.preventDefault();return aM.toggle_more_actions_menu()}));aM.more_actions_button.__date(cy.make("web","lightbox_more"));gl=gl||{};gc={include_delete:gl.include_delete||false,keep_url:gl.keep_url||false,num_previews:gl.num_previews||null,filename_in_url:gl.filename_in_url||false,no_wrap:(gl.no_wrap||false)||true,no_preload:gl.no_preload||false,enable_sublinks:gl.enable_sublinks!=null?gl.enable_sublinks:true,share_button_experiment_variant:gl.share_button_experiment_variant||false};fU=gl.is_loading||false;cP(!gc.filename_in_url||gc.keep_url,"filename_in_url cannot be used with keep_url off");ge=gk;if(gl.start_index!=null){aM.show(gl.start_index)}if(gc.filename_in_url){gg()}return $(document.body).on("click",".more-actions-item",function(gm,gn){if(gn.down("a").getAttribute("href").length<2){gm.preventDefault()}return aM.close_more_actions_menu()})},update_previews:function(gk){return ge=gk},show:function(gk){var gl,gm;if(aM.shown){return}cP(ge&&ge.length,"Lightbox.show() requires file preview objects to show");ga();if(gk!=null){fJ=gk}bF("#file-preview-modal").trigger("lightbox-init-show",{preview:ge[fJ]});if((gm=ge[fJ])!=null?gm.enable_download:void 0){aM.more_actions_button.show()}else{aM.more_actions_button.hide()}cP(!aM.shown,"Trying to reshow file preview modal");$("file-preview-modal").show();D.scroll_lock_document();fY(true);aM.shown=1;if(!gc.keep_url){gl=eJ.deconstruct_url(eJ.get_url());if(gl.path.indexOf("/lightbox/")!==0){eJ.push_state("/lightbox"+gl.path,gl.qargs)}}return fZ()},jump_to:function(gk){cP(aM.shown,"Lightbox should be showing");fJ=gk;fY();return fZ()},set_no_wrap:function(gk){return gc.no_wrap=gk},update_with_error:function(){fv=true;return f3()},num_previews:function(){return gc.num_previews||ge.length},get_previews:function(){return ge},current_index:function(){return fJ},close_more_actions_menu:gj,toggle_more_actions_menu:fC,update_share_button_text:fA,toggle_delete:fS,delete_current:fw,back:fO,PHOTO_CHANGE_EVT:"db:lightbox:photo_change",PHOTO_DELETE_EVT:"db:lightbox:photo_delete",PHOTO_REMOVE_FROM_ALBUM_EVT:"db:lightbox:photo_remove_from_album",ACTIONS_ADDED:"db:lightbox:actions_added",EXIT_SELECT_EVT:fH,NEXT:1,PREV:-1,vid_thumbnail_hidden:null,KEY_SCOPE:"lightbox",LIGHTBOX_HIDE_EVT:"lightbox-hide",LIGHTBOX_SHOW_EVT:"lightbox-preview"}})();var bG;bG=F.Tour=(function(){var fr,T,ft,fu,fy,fw,fx,fv,fs,fz,j,i;T=6;fr=0;j=function(fA){var fL,fJ,fI,fH,fF,fC,fB,fD,fK,fE,fG;$$(".page-end").each(Element.remove);fB=fA;fG=T-fA-1;fL=document.createDocumentFragment();for(fJ=fH=0,fD=fB;0<=fD?fH<fD:fH>fD;fJ=0<=fD?++fH:--fH){fC=new Element("img",{src:"/static/images/page-left-vflvWgvOr.png","class":"page-end-left page-end"});fC.style.left=(28-fJ*5)+"px";fC.style.zIndex=T-fJ;fL.appendChild(fC)}for(fI=fF=0,fK=fG;0<=fK?fF<fK:fF>fK;fI=0<=fK?++fF:--fF){fE=new Element("img",{src:"/static/images/page-right-vflnAeb-6.png","class":"page-end-right page-end"});fE.style.right=(31-fI*5)+"px";fE.style.zIndex=T-fI;fL.appendChild(fE)}return $("book").appendChild(fL)};i=function(fA){(fA>0?Element.show:Element.hide)("tour-page-back");return(fA+1<T?Element.show:Element.hide)("tour-page-forward")};fs=function(fA){$$(".pages").invoke("hide");return $("page-"+fA).show()};ft=function(fA){i(fA);j(fA);fs(fA);return fr=fA};fv=function(fB){var fA;Event.extend(fB).preventDefault();fA=fr-1;if(fA<0){return}ft(fA);return eJ.push_state("/tour/"+fA)};fw=function(fB){var fA;Event.extend(fB).preventDefault();fA=fr+1;if(fA>=T){return}ft(fA);return eJ.push_state("/tour/"+fA)};fz=function(fB,fC){var fA;fB.preventDefault();fA=parseInt(fC.href.split("/").last(),10);ft(fA);return eJ.push_state("/tour/"+fA)};fy=function(){$("tour-page-back").observe("click",fv);$("tour-page-forward").observe("click",fw);key("right",fw);key("left",fv);return $("toc").on("click","a",fz)};fu=function(fB,fC){var fA;fA=parseInt(fB,10)||0;if(fA<0||fA>=T){fA=0}return ft(fA)};fx=function(){var fE,fB,fA,fD,fC;fD=$$(".page-right img");fC=[];for(fB=0,fA=fD.length;fB<fA;fB++){fE=fD[fB];fC.push(ec.preload_image(fE.src))}return fC};return{setup:function(){return bF(function(){eJ.add_callback("/tour",fu);fy();return fx()})}}})();var bQ,cX=[].indexOf||function(fr){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fr){return T}}return -1};bQ=INLINE_JS.Photos=F.Photos={THUMB_SIZE:198,MONTH_HEADER_HEIGHT:46,COLLECTION_HEADER_HEIGHT:4,LIGHTBOX_OFFSET:25,DUPLICATES_SNIPPET_LENGTH:30,KEY_SCOPE:"photos",NUM_PHOTOS_LONG_RUNNING_DELETES:100,NUM_PHOTOS_LONG_RUNNING_EDIT_TIMESTAMP:200,_all_photos_timeline:null,_single_collection_timeline:null,_last_lightbox_photo:null,_current_collection_gid:null,_in_all_collections_view:false,_tmpl:null,_cu_duplicate_tmpl:null,_creating_filetags:false,_creating_filetags_cb:null,event_metadata_cache:{},scroll_count:0,initialized:false,_init_finished:false,init:function(fv,T,fs,fz,fw,fr,j,fx,fB,i){var fu,fy,fA,ft;this.event_metadata_cache=j;this._root_collection_gid=i;this.initialized=true;this.disable_selection();ec.disable_ie_image_dragging();this._tmpl=fm.tmpl("cu_list_item_tmpl");this._cu_duplicate_tmpl=fm.tmpl("cu_duplicate_list_item_tmpl");this._current_collection_gid=fw!=null?fw.gid:void 0;key.setScope(this.KEY_SCOPE);this.include_shared_folders=fx.include_shared_folders;this.show_hidden=fx.show_hidden;this.timestamp_edit_enabled=fB.timestamp_edit_enabled;this.undo_enabled=fB.undo_enabled;this.local_storage_enabled=fB.local_storage_enabled;fy=eJ.deconstruct_url();ft="share" in fy.qargs;for(fA in fz){if(fz.hasOwnProperty(fA)){e0.inc_num_loading_events_before_select(ft)}}this._init_timeline(fv,T,fs,fz);this._init_lightbox();fu=[];if(fw!=null){fu.push(new ad(fw,false))}cN.init(fu,fr);e0.drag_select_enabled=fB.drag_select_enabled;if(fx.show_photos_tour){aO.next()}delete fy.qargs.selr;delete fy.qargs.user_email;delete fy.qargs.uid;delete fy.qargs.share;delete fy.qargs.m;if("uuid" in fy.qargs){delete fy.qargs.uuid;delete fy.qargs.id}if(dS){eJ.replace_state(fy.path,fy.qargs)}else{if(!H.parse(window.location.href).fragment){eJ.push_state("/photos",fy.qargs)}}this._listen();return this._init_finished=true},_listen:function(){$(document.body).on("click",".cu-thumb",this._thumb_click.bind(this));$(document.body).on("dblclick",".cu-thumb",this._thumb_double_click.bind(this));$(document.body).on("contextmenu",".cu-thumb",this._thumb_context_menu.bind(this));document.observe(aM.PHOTO_CHANGE_EVT,this._lightbox_photo_change.bind(this));document.observe(aM.PHOTO_DELETE_EVT,this._lightbox_delete.bind(this));document.observe(aM.PHOTO_REMOVE_FROM_ALBUM_EVT,this._lightbox_remove.bind(this));document.observe(aM.EXIT_SELECT_EVT,this._lightbox_exit.bind(this));document.observe(bn.HIDE_EVT,this._context_menu_hide.bind(this));Event.observe(window,"resize",this._window_resize.bind(this));eJ.add_callback("/photos",this._history_change_handler.bind(this));document.observe(di.EVENT_MISCOUNT_EVT,this._photos_changed.bind(this));document.observe(di.PHOTOS_LOADED_EVT,this._photos_loaded.bind(this));document.observe(cl.PHOTOS_ADDED_EVT,this._photos_changed.bind(this));document.observe(cl.PHOTOS_REMOVED_EVT,this._photos_changed.bind(this));bF("#photos-nav-item").on("click",this.show_all_photos.bind(this));bF("#back-to-photos").on("click",this._back_to_photos.bind(this));bF("#back-to-albums").on("click",this._back_to_albums.bind(this));bF("#share-selected").on("click",this._share_selected.bind(this));bF("#clear-selected").on("click",this._clear_selected.bind(this));bF("#share-collection").on("click",this._share_collection.bind(this));if(this.include_shared_folders){bF("#do-include-shared-folders").prop("checked",true)}else{bF("#dont-include-shared-folders").prop("checked",true)}cN.listen();e0.listen();$(document.body).on("click",".event-select",this._select_event.bind(this));$(document.body).on("click",".event-share",this._share_event.bind(this));$(document.body).on("click",".event-add-to-album",this._add_event_to_album.bind(this));return bF(".show-all-photos").on("click",this.show_all_photos.bind(this))},_select_event:function(fw){var fu,fv,fr,i,T,ft,fs;fv=$(fw.target).up(".cu-month-header").identify().slice(2);fu=this.get_timeline().events.valueFromKey(fv);ft=fu.photos;fs=[];for(fr=0,i=ft.length;fr<i;fr++){T=ft[fr];fs.push(e0._add(T))}return fs},_share_event:function(fv){var ft,fu,fr,i,T,fs;fu=$(fv.target).up(".cu-month-header").identify().slice(2);ft=this.get_timeline().events.valueFromKey(fu);fs=ft.photos;for(fr=0,i=fs.length;fr<i;fr++){T=fs[fr];e0._add(T)}return this._share_selected()},_add_event_to_album:function(fv){var ft,fu,fr,i,T,fs;fu=$(fv.target).up(".cu-month-header").identify().slice(2);ft=this.get_timeline().events.valueFromKey(fu);fs=ft.photos;for(fr=0,i=fs.length;fr<i;fr++){T=fs[fr];e0._add(T)}return cN.show_add_to_album_modal(fv,e0.get())},_init_timeline:function(fu,T,fs,fx){var j,fy,fv,i,fr,fw,fz,ft;if(!fu.length){this.show_empty_state();return}j=this.in_single_collection_view()?$("single-collection-list"):$("photos-list");ft=$("cu-view").cumulativeOffset().top+j.getLayout().get("margin-top")+j.getLayout().get("padding-top");if(bF("#carousel-promo-banner").outerHeight()){ft+=bF("#carousel-promo-banner").outerHeight()-$("cu-view").cumulativeOffset().top}fv=$("cu-view").cumulativeOffset().left+j.getLayout().get("margin-left")+j.getLayout().get("padding-left");fy={top_offset:ft,left_offset:fv,thumb_size:this.THUMB_SIZE,header_height:this.in_single_collection_view()?this.COLLECTION_HEADER_HEIGHT:this.MONTH_HEADER_HEIGHT};i={uses_lightbox:true,uses_timeline_nav:true,log_thumb_loading:true};fz=new cl(j,null,fu,T,fs,fx,this._tmpl,fy,i);if(this.in_single_collection_view()){if((fr=this._single_collection_timeline)!=null){fr.unlisten()}this._single_collection_timeline=fz}else{if((fw=this._all_photos_timeline)!=null){fw.unlisten()}this._all_photos_timeline=fz}return this.get_timeline().render()},_init_lightbox:function(){var j,i;if(this.get_timeline()==null){return}if(aM.shown){i=this.get_timeline().get_preview_objs();if(i.length){aM.update_previews(i);j=Math.min(aM.current_index(),i.length-1);return aM.jump_to(j)}else{return aM.back()}}else{return aM.init(this.get_timeline().get_preview_objs(),{include_delete:true,no_wrap:true})}},_photos_loaded:function(){return this._init_lightbox()},_photos_changed:function(){this._init_lightbox();return this.set_empty_state()},_refresh_view:function(j){var i;if((i=this.get_timeline())!=null){i.unlisten()}e0.clear();$("cu-empty").hide();$("single-album-empty").hide();if(this.in_single_collection_view()){$("single-collection-list").__date()}this._refresh_photo_events(j);return window.scrollTo(0,0)},_refresh_photo_events:function(i){this.event_metadata_cache=null;return new Ajax.DBRequest("/photos_events",{parameters:{collection_gid:this._current_collection_gid,show_hidden:this.show_hidden},onSuccess:(function(j){return function(T){var fr;fr=JSON.parse(T.responseText);if(fr==="deleted_collection"){j._current_collection_gid=null;cN.reload();j.show_all_collections();ah.error(eG("This album has been deleted!"));return}j._init_timeline(fr.header_ids,fr.header_id_to_name,fr.header_id_to_num_photos,{});j._init_lightbox();return typeof i==="function"?i():void 0}})(this)})},set_empty_state:function(){if(this.get_timeline().events.length()){return this.hide_empty_state()}else{return this.show_empty_state()}},show_empty_state:function(){if(this.in_single_collection_view()){return $("single-album-empty").show()}else{return $("cu-empty").show()}},hide_empty_state:function(){if(this.in_single_collection_view()){return $("single-album-empty").hide()}else{return $("cu-empty").hide()}},get_timeline:function(){if(this.in_single_collection_view()){return this._single_collection_timeline}else{return this._all_photos_timeline}},show_in_folder:function(i){if(i.duplicates_info!=null){return this._show_duplicates_modal(i,false)}else{return window.open(this._get_browse_link(i),"_blank")}},_get_browse_link:function(j){var i;i=fo.get_browse_root(cQ.get_viewer().photos_user);return String(H({path:""+i+(aA.normalize(aA.parent_dir(j.fq_path))),query:{select:j.filename}}))},in_single_collection_view:function(){return this._current_collection_gid!=null},in_all_collections_view:function(){return this._in_all_collections_view},get_current_collection:function(){if(this._current_collection_gid!=null){return cN.get(this._current_collection_gid)}else{return null}},get_current_collection_gid:function(){return this._current_collection_gid||this._root_collection_gid},enable_selection:function(){return ec.enableSelection($(document.body))},disable_selection:function(){return ec.disableSelection($(document.body))},show_collection:function(T){var j,i;g.log_transition_to(co.SINGLE_COLLECTION_VIEW);i=eJ.deconstruct_url();j="/lightbox";if(i.path.indexOf(j)===0){i.path=i.path.slice(j.length);key.setScope(this.KEY_SCOPE);this._last_lightbox_photo=null}if(cX.call(i.path,"/album/")<0){if(i.path==="/photos/all_albums"){$("back-to-photos").hide();$("back-to-albums").show()}else{$("back-to-albums").hide();$("back-to-photos").show()}}if(T!=null){i.path=cN.get(T).url}return eJ.push_state(i.path,i.qargs)},show_all_collections:function(){g.log_transition_to(co.ALBUMS_VIEW);return eJ.push_state("/photos/all_albums")},show_all_photos:function(j){var i;j.preventDefault();g.log_transition_to(co.PHOTOS_VIEW);i=eJ.deconstruct_url();if(i.path==="/photos"){return this._refresh_view()}else{e0.clear();return eJ.push_state("/photos")}},_back_to_photos:function(i){e0.clear();return this.show_all_photos(i)},_back_to_albums:function(i){e0.clear();return this.show_all_collections()},get_thumb_click_event_data:function(T,i){var j;j=T.event;return{timeline_photo_index:i,event_photo_index:j.photos.indexOf(T),num_photos_in_event:j.photos.length,event_index:this.get_timeline().events.list.indexOf(j.unique_id),num_events:this.get_timeline().events.list.length}},_thumb_click:function(j){var i;i=this.get_timeline().get_photo_for_thumb_elm($(j.target));if(e0._drag_drop.ignore_next_click){return e0._drag_drop.ignore_next_click=false}else{return e0.photo_click(j,i)}},_thumb_double_click:function(fr){var T,j,i;j=this.get_timeline().get_photo_for_thumb_elm($(fr.target));i=this.get_timeline().index_of_photo(j);this._preview(i);T=this.get_thumb_click_event_data(j,i);return g.log_interaction(er.OPEN_LIGHTBOX,dh.DBL_CLICK,T)},_thumb_context_menu:function(fu){var fr,i,T,fv,ft,fs;T=this.get_timeline().get_photo_for_thumb_elm($(fu.target));if(fu.shiftKey){e0.photo_click(fu,T);return}if(e0.contains(T)){fv=e0.get()}else{fv=[T]}bn.show_photos(fu,fv);fs=[];for(fr=0,i=fv.length;fr<i;fr++){T=fv[fr];fs.push((ft=this.get_timeline().get_thumb_elm_for_photo(T))!=null?ft.addClassName("context-selected"):void 0)}return fs},_context_menu_hide:function(i){$$(".cu-thumb.context-selected").invoke("removeClassName","context-selected");return $$(".photo-collection.context-selected").invoke("removeClassName","context-selected")},_share_selected:function(j){var i;i=e0.get();if(!i.length){return}eF.show(i,false);return g.log_interaction(er.SHARE,dh.SAH,{num_photos:i.length})},_clear_selected:function(j){var i;i=e0.get().length;e0.clear();return g.log_interaction(er.CLEAR_SELECTED,dh.SAH,{num_photos:i})},_share_collection:function(j){var i;cP(this.in_single_collection_view(),"_share_collection can only happen in single collection view");i=this.get_current_collection();if(i.num_items===0){ah.error(eG("This album is empty. Add some photos before you share it!"));return}eF.show(this.get_current_collection(),true);return g.log_interaction(er.SHARE_ALBUM,dh.SCA)},toggle_mem_lane_settings:function(i){var T,j;if(i){Event.extend(i).preventDefault()}if(!bF("#memory-lane-settings-menu").visible()){j=bF("#memory-lane-settings-menu");eZ.show($("memory-lane-settings-menu"),$("memory-lane-settings-button"));T=function(fr){return fr.stopPropagation()};j.off("mousedown");j.off("click");j.on("mousedown",T);return j.on("click",T)}},show_delete_photos_modal:function(fx){var fy,fv,ft,fu,fs,fw,i,T,fr;if(fx.length===1){T=fx[0];if(T.duplicates_info!=null){this._show_duplicates_modal(T,true);return}}else{fy=[];for(ft=0,fu=fx.length;ft<fu;ft++){T=fx[ft];if(T.duplicates_info!=null){fv=T.duplicates_info.slice(0);fv.push(T);fv.sort(function(fz,j){return j.mtime-fz.mtime});fy=fy.concat(fv)}}if(fy.length){this._show_delete_multiple_duplicates_modal(fx,fy);return}}fr=de.categorize_files(fx),fw=fr[0],i=fr[1];if(fw&&i){fs=bd("Delete %(file_count)s item?","Delete %(file_count)s items?",fx.length)}else{if(fw){fs=bd("Delete %(file_count)s photo?","Delete %(file_count)s photos?",fx.length)}else{fs=bd("Delete %(file_count)s video?","Delete %(file_count)s videos?",fx.length)}}return dT.show({title_text:fs.format({file_count:fx.length}),body_html:eG("Are you sure you want to delete <strong>%(items)s</strong> from your Dropbox?").format({items:de.file_desc(fx)}),confirm_text:eG("Delete"),cancel_text:eG("Cancel"),confirm_callback:(function(j){return function(){return j._delete_photos(fx)}})(this)})},_delete_photos:function(fE){var fw,fy,fA,fx,fr,fv,ft,fz,fu,fC,i,T,fD,fs,fB;fE=fE.slice(0);fD=[];for(fv=0,fz=fE.length;fv<fz;fv++){T=fE[fv];fD.push(T.fq_path);if(T.duplicates_info!=null){fs=T.duplicates_info;for(ft=0,fu=fs.length;ft<fu;ft++){fr=fs[ft];fD.push(fr.fq_path)}}}fB=de.categorize_files(fE),fC=fB[0],i=fB[1];if(fC&&i){fx=bd("Deleting file","Deleting files",fD.length);fA=bd("Deleted file.","Deleted files.",fD.length)}else{if(fC){fx=bd("Deleting photo","Deleting photos",fD.length);fA=bd("Deleted photo.","Deleted photos.",fD.length)}else{fx=bd("Deleting video","Deleting videos",fD.length);fA=bd("Deleted video.","Deleted videos.",fD.length)}}fy=function(j){return new Ajax.DBRequest("/cmd/rollback",{parameters:{ns_to_cs:JSON.stringify(j)},html_in_error_msg:true,progress_text:eG("Undoing..."),onSuccess:function(fF){var fG;fG=eG("Undo complete");ah.success(fG);return bQ._all_photos_timeline.restore_removed_photos()},subject_user:cQ.get_viewer().photos_user})};fw=(function(j){return function(fF){return new Ajax.DBRequest("/cmd/delete",{parameters:{files:fD},job:fD.length>bQ.NUM_PHOTOS_LONG_RUNNING_DELETES,job_user:cQ.get_viewer().photos_user,progress_text:fx,onSuccess:function(fI){var fG,fJ,fH;fJ=fI.responseText.evalJSON();fH=bQ.undo_enabled&&(bQ._all_photos_timeline!=null);fG=fH?fJ.changesets:null;Y.notifyWithUndo(fx,fG,fy);bQ.get_timeline().remove_photos(fE);if(fF.length>0){return cN.refresh_album_views(fF)}},subject_user:cQ.get_viewer().photos_user})}})(this);return new Ajax.DBRequest("/collections_from_paths",{parameters:{fq_paths:JSON.stringify(fD)},onSuccess:(function(j){return function(fH){var fG,fF,fI,fJ;fF=JSON.parse(fH.responseText);fI=[];for(fJ in fF){fG=fF[fJ];fI=fI.concat(fG)}return fw(fI)}})(this)})},_preview:function(i){return aM.show(i)},_lightbox_delete:function(i){var j;j=i.memo.photo;g.log_interaction(er.DELETE,dh.LIGHTBOX);return this.show_delete_photos_modal([j])},_lightbox_remove:function(j){var i;i=j.memo.photo;this.get_current_collection().remove_photos([i]);return g.log_interaction(er.REMOVE,dh.LIGHTBOX)},_show_duplicates_modal:function(T,fF){var fy,fE,fv,fA,fz,ft,fC,fu,fx,fs,fw,fB,i,fr,fD;fz=T.duplicates_info.slice(0);fz.push(T);fz.sort(function(fG,j){return j.mtime-fG.mtime});fA=$("cu-duplicate-files");ft=[];for(fu=0,fx=fz.length;fu<fx;fu++){fv=fz[fu];fE="Dropbox"+aA.normalize(aA.parent_dir(fv.fq_path));ft.push(this._cu_duplicate_tmpl({thumbnail_url:fv.thumbnail_url,filename_snippet:bU.em_snippet(fv.filename,this.DUPLICATES_SNIPPET_LENGTH),path_snippet:bU.em_snippet(fE,this.DUPLICATES_SNIPPET_LENGTH,0),path_href:this._get_browse_link(fv)}))}fA.__date(ft);if(fz.length>=5){fA.addClassName("scroll")}else{fA.removeClassName("scroll")}fr=de.categorize_files([T]),fB=fr[0],i=fr[1];if(fB){fs=eG("There are multiple copies of this photo.");fw=eG("Delete all copies of this photo?")}else{fs=eG("There are multiple copies of this video.");fw=eG("Delete all copies of this video?")}if(fF){fC="delete_32";fD=fw;fy=fs+" "+eG("Would you like to delete them all?");$("cu-delete-all-duplicates").show()}else{fC="folder_32";fD=eG("Show in folder");fy=fs+" "+eG("Which folder would you like to view?");$("cu-delete-all-duplicates").hide()}dB.fillVal(fy,"cu-duplicates-desc");return fh.show(fD,$("cu-duplicates-modal"),{action:this._delete_photos.curry([T])})},_show_delete_multiple_duplicates_modal:function(fC,fy){var fB,fv,fz,fs,ft,fx,fr,fw,fu,fA,i,T;fz=$("cu-multiple-duplicate-files");fs=[];for(ft=0,fx=fy.length;ft<fx;ft++){fv=fy[ft];fB="Dropbox"+aA.normalize(aA.parent_dir(fv.fq_path));fs.push(this._cu_duplicate_tmpl({thumbnail_url:fv.thumbnail_url,filename_snippet:bU.em_snippet(fv.filename,this.DUPLICATES_SNIPPET_LENGTH),path_snippet:bU.em_snippet(fB,this.DUPLICATES_SNIPPET_LENGTH,0),path_href:this._get_browse_link(fv)}))}fz.__date(fs);if(fy.length>=5){fz.addClassName("scroll")}else{fz.removeClassName("scroll")}T=de.categorize_files(fC),fA=T[0],i=T[1];if(fA&&i){fr=eG("Delete %(num_files)s files and all copies?").format({num_files:fC.length});fw=eG("There are multiple copies of these files in your Dropbox.");fu=eG("Show files with multiple copies")}else{if(fA){fr=eG("Delete %(num_photos)s photos and all copies?").format({num_photos:fC.length});fw=eG("There are multiple copies of these photos in your Dropbox.");fu=eG("Show photos with multiple copies")}else{fr=eG("Delete %(num_videos)s videos and all copies?").format({num_videos:fC.length});fw=eG("There are multiple copies of these videos in your Dropbox.");fu=eG("Show videos with multiple copies")}}dB.fillVal(fw,"cu-multiple-duplicates-desc");dB.fillVal(fu,"cu-multiple-duplicates-show");$("cu-multiple-duplicates-modal").removeClassName("show-duplicates");return fh.show(fr,$("cu-multiple-duplicates-modal"),{action:this._delete_photos.curry(fC)})},show_timestamps_modal:function(ft){var j,T,fr,i,fs;ft.sort_by_key((function(fu){return fu.time_taken}),true);i=(function(){var fv,fu,fw;fw=[];for(fv=0,fu=ft.length;fv<fu;fv++){fr=ft[fv];fw.push(fr.time_taken)}return fw})();j=(function(){var fv,fu,fw;fw=[];for(fv=0,fu=ft.length;fv<fu;fv++){fr=ft[fv];fw.push(fr.item_counter)}return fw})();T=(function(){var fv,fu,fw;fw=[];for(fv=0,fu=i.length;fv<fu;fv++){fs=i[fv];if(fs==null){fw.push(fs)}}return fw})();if(T.length===i.length){return this._show_add_timestamps_modal(ft,i,j)}else{if(T.length===0){return this._show_edit_timestamps_modal(ft,i,j)}else{return cP(false,"Timestamp modal should only open when all selected photos either have or don't have timestamp information.")}}},_scroll_to_photo_after_timestamp_edit:function(i,j){return this._refresh_photo_events((function(T){return function(){var fr,fs;fs=("m_"+(j.getFullYear()))+(""+(j.getMonth()+1)).lpad(2);fr=T.get_timeline().events.valueFromKey(fs);cP(fr!=null,"Event is missing after a timestamp edit!");eH.update("2/3");fr.on_load_all_metadata=function(){T.get_timeline().scroll_to_photo_with_key(i.uniqueness_key);eH.hide();return ah.success("New timestamps have been saved!")};if(fr.has_loaded_metadata()){fr.on_load_all_metadata();return fr.on_load_all_metadata=null}else{return fr.load_metadata()}}})(this))},_show_add_timestamps_modal:function(fs,j,i){var fr,T;T=bF("#add-timestamp-modal");fr=new J("date_picker",{disable_future:true});return fh.show("Set Timestamps",T[0],{action:(function(ft){return function(){var fx,fy,fB,fw,fu,fz,fA,fv;fz=ec.to_iso8601_date(fr.selected_date,false,true);fA=(function(){var fC,fE,fD;fD=[];for(fx=fC=0,fE=fs.length;0<=fE?fC<fE:fC>fE;fx=0<=fE?++fC:--fC){fD.push(fz)}return fD})();fv={};for(fy=fw=0,fu=i.length;fw<fu;fy=++fw){fB=i[fy];fv[fB]=fA[fy]}eH.show("Making the changes");return new Ajax.DBRequest("/modify_photo_timestamp",{parameters:{timestamp_by_item_counter:JSON.stringify(fv)},onSuccess:function(fC){eH.update("1/3");return ft._scroll_to_photo_after_timestamp_edit(fs[0],fr.selected_date)}})}})(this)})},_show_edit_timestamps_modal:function(fw,fv,fr){var ft,j,i,fu,T,fs;fu=bF("#edit-timestamp-modal");i=(function(){var fy,fx,fz;fz=[];for(fy=0,fx=fv.length;fy<fx;fy++){fs=fv[fy];fz.push(O.toUTCDate(new Date(fs)))}return fz})();T={year:0,month:0,day:0,hour:0};ft=function(fx){return eG("%(date)s at %(time)s").format({date:O.localize(fx),time:O.format(fx,Constants.time_format)})};j=function(fx,fB,fC,fA){var fz,fy;if(fx==null){fx=0}if(fB==null){fB=0}if(fC==null){fC=0}if(fA==null){fA=0}T.year+=fx;T.month+=fB;T.day+=fC;T.hour+=fA;fy=b6.increment_date(new Date(i[0]),T.year,T.month,T.day,T.hour,0);fz=b6.increment_date(new Date(i[i.length-1]),T.year,T.month,T.day,T.hour,0);if(fw.length===1){return fu.find("#timestamp-new").text(ft(fy))}else{fu.find("#timestamp-new-start").text(ft(fy));return fu.find("#timestamp-new-end").text(ft(fz))}};if(fw.length===1){fu.find("#edit-timestamp-single").show();fu.find("#edit-timestamp-multi").hide();fu.find("#timestamp-current").text(ft(i[0]))}else{fu.find("#edit-timestamp-single").hide();fu.find("#edit-timestamp-multi").show();fu.find("#timestamp-current-start").text(ft(i[0]));fu.find("#timestamp-current-end").text(ft(i[i.length-1]))}j();bF("#timestamp-year-plus").on("click",j.curry(1,0,0,0));bF("#timestamp-year-minus").on("click",j.curry(-1,0,0,0));bF("#timestamp-month-plus").on("click",j.curry(0,1,0,0));bF("#timestamp-month-minus").on("click",j.curry(0,-1,0,0));bF("#timestamp-day-plus").on("click",j.curry(0,0,1,0));bF("#timestamp-day-minus").on("click",j.curry(0,0,-1,0));bF("#timestamp-hour-plus").on("click",j.curry(0,0,0,1));bF("#timestamp-hour-minus").on("click",j.curry(0,0,0,-1));fh.onHide=function(){var fy,fz,fx,fA;fA=["year","month","day","hour"];for(fz=0,fx=fA.length;fz<fx;fz++){fy=fA[fz];bF("#timestamp-"+fy+"-plus").off("click");bF("#timestamp-"+fy+"-minus").off("click")}fh.onHide=null;return fh.hide()};return fh.show("Edit Timestamps",fu[0],{action:(function(fx){return function(){var fI,fC,fy,fB,fG,fz,fD,fA,fH,fF,fJ,fE;if((((T.year===(fF=T.month)&&fF===(fH=T.day))&&fH===(fA=T.hour))&&fA===0)){return}g.log_interaction(er.EDIT_TIMESTAMP,dh.PCM,{num_photos:fw.length});fz=(function(){var fL,fK,fM;fM=[];for(fL=0,fK=i.length;fL<fK;fL++){fI=i[fL];fM.push(b6.increment_date(fI,T.year,T.month,T.day,T.hour,0))}return fM})();fD=(function(){var fL,fK,fM;fM=[];for(fL=0,fK=fz.length;fL<fK;fL++){fJ=fz[fL];fM.push(ec.to_iso8601_date(fJ,false,true))}return fM})();fE={};for(fC=fB=0,fG=fr.length;fB<fG;fC=++fB){fy=fr[fC];fE[fy]=fD[fC]}eH.show("Making the changes");return new Ajax.DBRequest("/modify_photo_timestamp",{parameters:{timestamp_by_item_counter:JSON.stringify(fE)},job:fw.length>fx.NUM_PHOTOS_LONG_RUNNING_EDIT_TIMESTAMP,job_user:cQ.get_viewer().photos_user,onSuccess:function(fK){eH.update("1/3");return fx._scroll_to_photo_after_timestamp_edit(fw[0],fz[0])}})}})(this)})},_preload_file_previews:function(fs){var fA,fx,fu,ft,fr,fz,fv,T,fE,fD,fB,fy,fw,fC;fC=this.get_timeline().get_photos();if(fs[0]<=fs[fs.length-1]){fy=null;for(fu=0,fz=fs.length;fu<fz;fu++){fx=fs[fu];T=fC[fx];if(T.status!==L.PLACEHOLDER){continue}fE=T.event;if(fy==null){fy=fE;fB=T}if(fE===fy){continue}if(fy.is_missing_timestamp_bucket()&&!this.get_timeline().is_missing_timestamp_bucket_shown()){this.get_timeline()._show_missing_timestamp_bucket(false,true)}fy.load_metadata();fy=fE;fB=T}if((fy!=null)&&!fy.has_loaded_metadata()){fA=fy.photos.indexOf(fB);fr=fy.photos.indexOf(T);if(fy.is_missing_timestamp_bucket()&&!this.get_timeline().is_missing_timestamp_bucket_shown()){this.get_timeline()._show_missing_timestamp_bucket(false,true)}return fy.load_metadata_range(fA,fr)}}else{fw=[];for(ft=0,fv=fs.length;ft<fv;ft++){fx=fs[ft];T=fC[fx];if(T.status!==L.PLACEHOLDER){continue}fE=T.event;fD=fE.photos.indexOf(T);fw.push(fE.load_metadata(fD))}return fw}},_lightbox_photo_change:function(fx){var fu,ft,fr,fz,fs,fy,i,fw,fv,T;this._last_lightbox_photo=fx.memo.preview_obj.photo;fr=fx.memo.index;fs=aM.num_previews();if(fr===0||fr===fs-1){return}if(fx.memo.direction===aM.NEXT||(fx.memo.direction==null)){fz=Math.min(fr+this.LIGHTBOX_OFFSET*this.get_timeline().THUMBS_PER_ROW,fs-1);return this._preload_file_previews((function(){fv=[];for(var fA=i=fr+1;i<=fz?fA<=fz:fA>=fz;i<=fz?fA++:fA--){fv.push(fA)}return fv}).apply(this))}else{if(fx.memo.direction===aM.PREV){fy=Math.max(fr-this.LIGHTBOX_OFFSET*this.get_timeline().THUMBS_PER_ROW,0);return this._preload_file_previews((function(){T=[];for(var j=fw=fr-1;fw<=fy?j<=fy:j>=fy;fw<=fy?j++:j--){T.push(j)}return T}).apply(this))}}},_lightbox_exit:function(i){return key.setScope(this.KEY_SCOPE)},_window_resize:function(){var j,fr,T,i;i=$("cu-view").cumulativeOffset().top+$("photos-list").getLayout().get("margin-top")+$("photos-list").getLayout().get("padding-top");if(bF("#carousel-promo-banner").outerHeight()){i+=bF("#carousel-promo-banner").outerHeight()-$("cu-view").cumulativeOffset().top}j=$("cu-view").cumulativeOffset().left+$("photos-list").getLayout().get("margin-left")+$("photos-list").getLayout().get("padding-left");if((fr=this._all_photos_timeline)!=null){fr.update_offsets(i,j)}return(T=this._single_collection_timeline)!=null?T.update_offsets(i,j):void 0},_history_change_handler:function(fC,fB){var fv,fx,fA,fs,fy,fr,i,fz,fw,fu,ft,T;if(this._init_finished){if(fh.shown()){fh.hide()}}$("photos-nav-item").removeClassName("selected");$$(".sidebar-album.selected").invoke("removeClassName","selected");if((i=this.get_timeline())!=null){i.unlisten()}if(fC==="all_albums"){cN.load_collections(null);this._in_all_collections_view=true;$("cu-view").removeClassName("single-collection");$("cu-view").addClassName("all-collections");if((fz=$("all-albums-sidebar"))!=null){fz.addClassName("selected")}e0.clear();document.title=eG("Albums")+" - Dropbox";cN.restore_all_albums_scroll_position();this._current_collection_gid=null;return}else{this._in_all_collections_view=false;$("cu-view").removeClassName("all-collections")}if(fC.startsWith("album/")){fv=cN.get_from_url("/photos/"+fC);fw=$$(".sidebar-album");for(fs=0,fy=fw.length;fs<fy;fs++){fA=fw[fs];if(fA.readAttribute("data-gid")===fv.gid){fA.addClassName("selected");break}}$("single-collection-title").__date(bU.em_snippet(fv.name,cN.HEADER_COLLECTION_SNIPPET_LENGTH,1));if(fv.shmodel_url!=null){$("single-collection-share-status").writeAttribute("href",fv.shmodel_url);if(((fu=fv.member_fnames)!=null?fu.length:void 0)>1){fx=eG("%(photo_video_desc)s from %(album_members)s",{comment:'for example: "3 photos and 1 video from Peter, Boris, and Ryan"'}).format({photo_video_desc:de.album_desc(fv),album_members:ec.nice_list(fv.member_fnames)});$("single-collection-share-status").__date(fx)}else{$("single-collection-share-status").__date(eG("Shared"))}}else{$("single-collection-share-status").__date()}$("cu-view").addClassName("single-collection");if(!fv.is_creator){$("cu-view").addClassName("not-collection-creator")}document.title=fv.name+" - Dropbox";cB.log_event("show_collection",fv.gid,fv.num_photos,fv.is_anonymous)}else{fv=null;$("cu-view").removeClassName("single-collection");$("photos-nav-item").addClassName("selected");document.title=eG("Photos")+" - Dropbox"}fr=false;if(fv!=null){if(fv.gid!==this._current_collection_gid){fr=true}}else{if(this._all_photos_timeline==null){fr=true}}this._current_collection_gid=fv!=null?fv.gid:null;if(fr){this._refresh_view()}else{this._init_lightbox();this.get_timeline().init_timeline_nav();this.get_timeline().restore_scroll_position();this.get_timeline().listen()}if((this._last_lightbox_photo!=null)&&this.get_timeline().num_photos()){T=this._last_lightbox_photo.uniqueness_key;this.get_timeline().scroll_to_photo_with_key(T);if((ft=$(T))!=null){ft.addClassName("wiggobble")}setTimeout((function(){return $(T).removeClassName("wiggobble")}),1000);return this._last_lightbox_photo=null}}};var aO;aO=INLINE_JS.PhotosTour=F.PhotosTour={_frame:0,next:function(){var i;fh.show("",bF("#photos-tour-"+(this._frame+1))[0],null,null,700,null,null,false);i=this._frame;g.log_interaction(a8.SHOW_MODAL,"",{frame:i});bF("#modal-x").off("click");bF("#modal-x").on("click",((function(j){return function(){return g.log_interaction(a8.EXIT_MODAL,"",{frame:i})}})(this)));return this._frame=(this._frame+1)%4},hide:function(i){g.log_interaction(i,"");return fh.hide()}};var de;de=F.PhotosUtil={categorize_files:function(j){var T,i;T=j.filter(function(fr){return fr.preview_type==="photo"});i=j.filter(function(fr){return fr.preview_type==="video"});return[T.length,i.length]},file_desc:function(ft,fr,i){var j,fs,T;if(fr==null){fr=false}if(i==null){i=false}T=this.categorize_files(ft),j=T[0],fs=T[1];return this._photo_video_desc(j,fs,fr,i)},album_desc:function(T,j,i){if(j==null){j=false}if(i==null){i=false}return this._photo_video_desc(T.num_photos,T.num_videos,j,i)},_photo_video_desc:function(j,fu,T,i){var fr,ft,fs;ft=bd("%d photo","%d photos",j,{comment:"This will be used in a phrase such as 'x photos and y videos'"}).format(j);fs=bd("%d video","%d videos",fu,{comment:"This will be used in a phrase such as 'x photos and y videos'"}).format(fu);if(j&&fu){if(T){fr=j+fu;return bd("%d item","%d items",fr).format(fr)}else{if(i){return new fm(ft+"<br/>"+fs)}else{return eG("%(num_photos)s and %(num_videos)s",{comment:"num_photos and num_videos may be like either '1 photo' or '%d photos'"}).format({num_photos:ft,num_videos:fs})}}}else{if(j){return ft}else{if(fu){return fs}else{return""}}}}};var e0,cX=[].indexOf||function(fr){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fr){return T}}return -1};e0=INLINE_JS.PhotosSelection=F.PhotosSelection={CHANGE_EVT:"db:photos_selection:change",SHIFT_KEY_CODE:16,DRAG_STATUS_OFFSET:16,DRAG_START_THRESHOLD:10,SCROLL_BAR_WIDTH:10,_selected:[],_context_selected:null,_highlighted:[],_dehighlighted:[],_last_selected:null,_last_mouseover:null,_drag_select:{},_marquee:{},_drag_drop:{},_events_highlighting:[],_last_highlight_from_photo:null,_last_highlight_to_photo:null,_select_highlighted_waiting:0,_show_share_after_loading_selected:false,_num_pending_events_with_selections:0,_max_num_pending_events_with_selections:0,listen:function(){$(document.body).on("keydown",(function(i){return function(j){if(j.keyCode===i.SHIFT_KEY_CODE&&i._last_mouseover&&!D.focus_in_input()){return i._highlight_range(i._last_selected,i._last_mouseover)}}})(this));$(document.body).on("keyup",(function(i){return function(j){if(j.keyCode===i.SHIFT_KEY_CODE&&!i._marquee.active){return i.clear_highlighted()}}})(this));key("delete, command+backspace, backspace",bQ.KEY_SCOPE,(function(i){return function(j){j.preventDefault();if(bQ.in_single_collection_view()){if(i._selected.length){return cN.show_remove_photos_modal(bQ.get_current_collection(),i._selected)}}else{if(i._selected.length){return bQ.show_delete_photos_modal(i._selected)}}}})(this));key("esc",bQ.KEY_SCOPE,(function(i){return function(T){var j;if(typeof T.preventDefault==="function"){T.preventDefault()}if(i._drag_drop.active){i._drag_drop.active=false;if((j=$("albums-sidebar-list"))!=null){j.removeClassName("drag-drop")}return $("photos-drag-status").removeClassName("active")}else{i.clear();return g.log_interaction(er.CLEAR_SELECTED,dh.ESC)}}})(this));$(document.body).on("mouseover",".cu-thumb",this._photo_mouseover.bind(this));$(document.body).on("mouseout",".cu-thumb",this._photo_mouseout.bind(this));$(document.body).on("mousedown",this._body_mousedown.bind(this));$(document.body).on("mousemove",this._body_mousemove.bind(this));$(document).on("mouseup",this._body_mouseup.bind(this));$(document.body).on("dblclick",this._body_double_click.bind(this));return B.init(null,bF("#cu-header").height())},is_selection_active:function(){return this._highlighted.length||this._selected.length||this._marquee.active||this._drag_drop.active||this._drag_select.active},get:function(){return this._selected},contains:function(j){var T,i,fr;fr=(function(){var ft,fs,fv,fu;fv=this._selected;fu=[];for(ft=0,fs=fv.length;ft<fs;ft++){i=fv[ft];fu.push(i.uniqueness_key)}return fu}).call(this);return T=j.uniqueness_key,cX.call(fr,T)>=0},clear:function(){this._selected=[];this._last_selected=null;$$(".cu-thumb.selected").invoke("removeClassName","selected");$("cu-view").removeClassName("photos-selected");$("page-sidebar").removeClassName("photos-selected");eZ.hide_all();return document.fire(e0.CHANGE_EVT)},clear_highlighted:function(){this._highlighted=[];this._dehighlighted=[];if(!this._select_highlighted_waiting){$$(".cu-thumb.highlighted").invoke("removeClassName","highlighted");$$(".cu-thumb.dehighlighted").invoke("removeClassName","dehighlighted");this._last_highlight_from_photo=null;return this._last_highlight_to_photo=null}},photo_click:function(j,i){if(j.isRightClick()&&!j.shiftKey){return}if(j.shiftKey){return this._select_highlighted()}else{if(this.contains(i)){return this._remove(i)}else{return this._add(i)}}},num_selected:function(){return this._selected.length},refresh:function(T){var fu,fs,fr,fv,ft,i,fw;fw=(function(){var fy,fx,fA,fz;fA=this._selected;fz=[];for(fy=0,fx=fA.length;fy<fx;fy++){i=fA[fy];fz.push(i.uniqueness_key)}return fz}).call(this);ft=[];for(fs=0,fr=T.length;fs<fr;fs++){fv=T[fs];fu=fw.indexOf(fv.uniqueness_key);if(fu>=0){ft.push(this._selected[fu]=fv)}else{ft.push(void 0)}}return ft},inc_num_loading_events_before_select:function(i){if(!this._show_share_after_loading_selected){eH.show(eG("Loading photos..."))}this._show_share_after_loading_selected=i;this._num_pending_events_with_selections++;if(this._num_pending_events_with_selections>this._max_num_pending_events_with_selections){return this._max_num_pending_events_with_selections=this._num_pending_events_with_selections}},dec_num_loading_events_before_select:function(){this._num_pending_events_with_selections--;eH.update((this._max_num_pending_events_with_selections-this._num_pending_events_with_selections)+"/"+this._max_num_pending_events_with_selections);if(this._num_pending_events_with_selections===0){eH.hide();if(this._show_share_after_loading_selected){this._show_share_after_loading_selected=false;if(this.num_selected()>0){return bQ._share_selected()}}}},_photo_mouseover:function(i){this._last_mouseover=bQ.get_timeline().get_photo_for_thumb_elm($(i.target));if(i.shiftKey){return this._highlight_range(this._last_selected,this._last_mouseover)}else{if(this._drag_select.active){return this._highlight_range(this._drag_select.anchor,this._last_mouseover,true)}}},_photo_mouseout:function(i){if(!this._marquee.active){this.clear_highlighted();return this._last_mouseover=null}},_body_mousedown:function(fr){var i,T,j;if(bQ.in_all_collections_view()||fr.isRightClick()||this._invalid_mouse_target($(fr.target))){return}bn.hide();eZ.hide_all();i=(T=bQ.get_timeline())!=null?T.get_photo_for_thumb_elm($(fr.target)):void 0;if(i!=null){if(this.contains(i)||!e0.drag_select_enabled){j=D.scroll_offsets();this._drag_drop.active=true;this._drag_drop.start_x=fr.clientX+j.left;this._drag_drop.start_y=fr.clientY+j.top;this._drag_drop.anchor=$(fr.target);this._drag_drop.single_photo=this.contains(i)?null:i;this._build_drag_status(i);this._update_drag_status_position(fr)}else{this._drag_select.active=true;this._drag_select.anchor=i}}else{j=D.scroll_offsets();if((fr.clientX+j.left)>=($(document.body).getWidth()-this.SCROLL_BAR_WIDTH)){return}this._marquee.active=true;this._marquee.start_x=fr.clientX+j.left;this._marquee.start_y=fr.clientY+j.top;this._marquee.x_max_boundary=-1;this._marquee.y_max_boundary=-1}return B.start()},_body_mousemove:function(fr){var T,j,i,fs;j=D.scroll_offsets();i=fr.clientX+j.left;fs=fr.clientY+j.top;if(this._marquee.active){if(!$("marquee").visible()){if(Math.abs(i-this._marquee.start_x)<this.DRAG_START_THRESHOLD&&Math.abs(fs-this._marquee.start_y)<this.DRAG_START_THRESHOLD){return}}this._marquee.end_x=i;this._marquee.end_y=fs;return this._draw_marquee()}else{if(this._drag_drop.active){if(!$("photos-drag-status").hasClassName("active")){if(Math.abs(i-this._drag_drop.start_x)<this.DRAG_START_THRESHOLD&&Math.abs(fs-this._drag_drop.start_y)<this.DRAG_START_THRESHOLD){return}}this._update_drag_status_position(fr);$$(".sidebar-album").invoke("removeClassName","album-flash");if((T=$("albums-sidebar-list"))!=null){T.addClassName("drag-drop")}return $("photos-drag-status").addClassName("active")}}},_body_mouseup:function(T){var j,i;if(this._drag_select.active){this._drag_select.active=false;this._select_highlighted()}if(this._marquee.active){this._marquee.active=false;$("marquee").hide();j=this._highlighted.length;this._select_highlighted();if(j){g.log_interaction(er.MARQUEE_SELECT,dh.DRAG,{num_selected:j})}}if(this._drag_drop.active){if($(T.target)===this._drag_drop.anchor&&$("photos-drag-status").hasClassName("active")){this._drag_drop.ignore_next_click=true}this._drag_drop.active=false;this._drag_drop.anchor=null;this._drag_drop.single_photo=null;if((i=$("albums-sidebar-list"))!=null){i.removeClassName("drag-drop")}$("photos-drag-status").removeClassName("active")}return B.end()},_body_double_click:function(i){if(bQ.get_timeline().get_photo_for_thumb_elm($(i.target))||this._invalid_mouse_target($(i.target))){return}this.clear();return g.log_interaction(er.CLEAR_SELECTED,dh.DBL_CLICK)},_draw_marquee:function(){var i,fs,fr,T,j;j=Math.abs(this._marquee.start_x-this._marquee.end_x);i=Math.abs(this._marquee.start_y-this._marquee.end_y);fr=Math.min(this._marquee.start_y,this._marquee.end_y);fs=Math.min(this._marquee.start_x,this._marquee.end_x);$("marquee").setStyle({width:j+"px",height:i+"px",top:fr+"px",left:fs+"px"});$("marquee").show();T=false;if(bQ.get_timeline()!=null){if(this._marquee.end_x>=this._marquee.x_max_boundary||this._marquee.end_x<=this._marquee.x_min_boundary){this._update_marquee_x_bounds(this._marquee.end_x);T=true}if(this._marquee.end_y>=this._marquee.y_max_boundary||this._marquee.end_y<=this._marquee.y_min_boundary){this._update_marquee_y_bounds(this._marquee.end_y);T=true}if(T){return this._update_marquee_highlight(fr,fs,j,i)}}},_update_marquee_highlight:function(fC,ft,T,fD){var fz,fx,fu,fA,fw,fv,fr,fB,fy,fs;this.clear_highlighted();fs=[];fA=bQ.get_timeline().grid.photo_col_offsets.length;fr=bQ.get_timeline().grid.photo_col_offsets.slice(0,fA-1);for(fz=fx=0,fw=fr.length;fx<fw;fz=++fx){fv=fr[fz];if(fv<=ft+T&&bQ.get_timeline().grid.photo_col_offsets[fz+1]>=ft){fs.push(fz)}}fy=[];for(fz=fu=0,fB=bQ.get_timeline().events.length();0<=fB?fu<fB:fu>fB;fz=0<=fB?++fu:--fu){fy.push(bQ.get_timeline().events.valueAtIndex(fz).marquee_highlight(fC,fC+fD,fs))}return fy},_update_marquee_x_bounds:function(T){var fu,fs,fr,fw,fx,fv,ft;fw=$(document.body).getWidth();if(T<bQ.get_timeline().grid.photo_col_offsets.first()){this._marquee.x_min_boundary=-1;return this._marquee.x_max_boundary=bQ.get_timeline().grid.photo_col_offsets.first()}else{if(T>bQ.get_timeline().grid.photo_col_offsets.last()){this._marquee.x_min_boundary=bQ.get_timeline().grid.photo_col_offsets.last();return this._marquee.x_max_boundary=fw}else{fv=bQ.get_timeline().grid.photo_col_offsets;ft=[];for(fu=fs=0,fr=fv.length;fs<fr;fu=++fs){fx=fv[fu];if(fx>T){this._marquee.x_min_boundary=bQ.get_timeline().grid.photo_col_offsets[fu-1];this._marquee.x_max_boundary=fx;break}else{ft.push(void 0)}}return ft}}},_update_marquee_y_bounds:function(fx){var T,fv,fs,fr,fu,fw,ft;fu=$(document.body).getHeight();if(fx<bQ.get_timeline().grid.photo_row_offsets.first()){this._marquee.y_min_boundary=-1;return this._marquee.y_max_boundary=bQ.get_timeline().grid.photo_row_offsets.first()}else{if(fx>bQ.get_timeline().grid.photo_row_offsets.last()){this._marquee.y_min_boundary=bQ.get_timeline().grid.photo_row_offsets.last();return this._marquee.y_max_boundary=fu}else{fw=bQ.get_timeline().grid.photo_row_offsets;ft=[];for(fv=fs=0,fr=fw.length;fs<fr;fv=++fs){T=fw[fv];if(T>fx){this._marquee.y_min_boundary=bQ.get_timeline().grid.photo_row_offsets[fv-1];this._marquee.y_max_boundary=T;break}else{ft.push(void 0)}}return ft}}},_build_drag_status:function(fr){var T,i,j;i=bQ.get_timeline().get_thumb_elm_for_photo(fr);j=i.down("img.thumb-content").cloneNode(false);$("photos-drag-status").down(".thumb").__date(j);T=this._drag_drop.single_photo?[this._drag_drop.single_photo]:this._selected;return $("photos-drag-status").down(".count").__date(de.file_desc(T,false,true))},_update_drag_status_position:function(i){return $("photos-drag-status").setStyle({left:(i.pointerX()-D.scroll_offsets().left+this.DRAG_STATUS_OFFSET)+"px",top:(i.pointerY()-D.scroll_offsets().top+this.DRAG_STATUS_OFFSET)+"px"})},_highlight_range:function(fE,fD,fs){var fC,T,fu,fx,fv,fA,fy,ft,fB,fz,fw,fr;if(fs==null){fs=false}this.clear_highlighted();this._events_highlighting=[];this._last_highlight_from_photo=fE;this._last_highlight_to_photo=fD;fu=bQ.get_timeline().index_of_photo(fE);fr=bQ.get_timeline().index_of_photo(fD);fC=!fs&&this.contains(fD)&&!this.contains(fE);fw=[];for(fx=fv=ft=fu,fB=fr;ft<=fB?fv<=fB:fv>=fB;fx=ft<=fB?++fv:--fv){fy=bQ.get_timeline().photo_at_index(fx);if(fy.status===L.PLACEHOLDER){if(fy.event!==fA){T=fy.event;if(!T.has_loaded_metadata()){T.on_load_all_metadata=this._highlight_range_incremental.bind(this);T.load_metadata();if(fz=T.unique_id,cX.call(this._events_highlighting,fz)<0){this._events_highlighting.push(T.unique_id)}fw.push(fA=T)}else{fw.push(void 0)}}else{fw.push(void 0)}}else{if(this.contains(fy)){if(fC){fw.push(this._dehighlight(fy))}else{fw.push(void 0)}}else{if(!fC){fw.push(this._highlight(fy))}else{fw.push(void 0)}}}}return fw},_highlight_range_incremental:function(T){var fz,fs,fA,fv,fu,fw,ft,fx,fr,fy;fA=this._last_highlight_from_photo;fy=this._last_highlight_to_photo;if(!((fA!=null)&&(fy!=null))){return}fs=bQ.get_timeline().index_of_photo(fA);fr=bQ.get_timeline().index_of_photo(fy);for(fv=fu=ft=fs,fx=fr;ft<=fx?fu<=fx:fu>=fx;fv=ft<=fx?++fu:--fu){fw=bQ.get_timeline().photo_at_index(fv);if(fw.status!==L.PLACEHOLDER&&!this.contains(fw)&&this._highlighted.indexOf(fw)===-1){this._highlight(fw)}}fz=this._events_highlighting.indexOf(T.unique_id);if(fz>=0){this._events_highlighting.splice(fz,1)}if(this._select_highlighted_waiting){eH.update((this._select_highlighted_waiting-this._events_highlighting.length)+"/"+this._select_highlighted_waiting);if(this._events_highlighting.length===0){return this._select_highlighted()}}},_highlight_list:function(fs){var fr,T,i,ft;this.clear_highlighted();ft=[];for(fr=0,T=fs.length;fr<T;fr++){i=fs[fr];if(!this.contains(i)){ft.push(this._highlight(i))}else{ft.push(void 0)}}return ft},_select_highlighted:function(){var fu,fr,ft,T,fs,fv,i;if(this._events_highlighting.length>0){eH.show(eG("Selecting photos..."));this._select_highlighted_waiting=this._events_highlighting.length;return}fv=this._highlighted;for(fu=0,ft=fv.length;fu<ft;fu++){fs=fv[fu];this._add(fs)}i=this._dehighlighted;for(fr=0,T=i.length;fr<T;fr++){fs=i[fr];this._remove(fs)}if(this._select_highlighted_waiting){eH.hide();this._select_highlighted_waiting=0}return this.clear_highlighted()},_highlight:function(j){var i;this._highlighted.push(j);i=bQ.get_timeline().get_thumb_elm_for_photo(j);return i!=null?i.addClassName("highlighted"):void 0},_dehighlight:function(j){var i;this._dehighlighted.push(j);i=bQ.get_timeline().get_thumb_elm_for_photo(j);return i!=null?i.addClassName("dehighlighted"):void 0},_add:function(j){var i;cP(j.status!==L.PLACEHOLDER,"placeholder photos can't be added to the selection",true,["photo_selection_placeholder"]);i=bQ.get_timeline().get_thumb_elm_for_photo(j);if(i!=null){i.addClassName("selected")}this._selected.push(j);this._last_selected=j;dB.fillVal(de.file_desc(this._selected,true),"selected-desc");dB.fillVal(this._selected.length,"num-selected");$("cu-view").addClassName("photos-selected");this._check_for_single_selection();$("page-sidebar").addClassName("photos-selected");return document.fire(e0.CHANGE_EVT)},_remove:function(T){var j,i;i=bQ.get_timeline().get_thumb_elm_for_photo(T);if(i!=null){i.removeClassName("selected")}j=this._selected.indexOf(T);if(j!==-1){this._selected.splice(j,1);this._last_selected=T;if(this._selected.length){dB.fillVal(de.file_desc(this._selected,true),"selected-desc");dB.fillVal(this._selected.length,"num-selected")}else{$("cu-view").removeClassName("photos-selected");$("page-sidebar").removeClassName("photos-selected")}}this._check_for_single_selection();return document.fire(e0.CHANGE_EVT)},_invalid_mouse_target:function(fr){var T,i,j;j=fr.classNames().toArray().concat(fr.up().classNames().toArray());return(cX.call(j,"freshbutton")>=0)||(cX.call(j,"freshbutton-blue")>=0)||(cX.call(j,"freshbutton-lightblue")>=0)||(cX.call(j,"freshbutton-blue-on-gray")>=0)||(cX.call(j,"timeline-elm")>=0)||(fr.up(".no-marquee")!=null)||(fr.up("#context-menu")!=null)||(fr.up(".freshdropdown-menu")!=null)||fr.nodeName==="A"||((T=fr.tagName.toUpperCase())==="INPUT"||T==="TEXTAREA"||T==="SELECT")||fh.shown()||((i=$("modal-progress-content"))!=null?i.visible():void 0)||aM.shown},_check_for_single_selection:function(){if(this._selected.length===1){return $("cu-view").addClassName("single-selection")}else{return $("cu-view").removeClassName("single-selection")}}};var cN,cX=[].indexOf||function(fr){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fr){return T}}return -1};cN=INLINE_JS.PhotosCollections=F.PhotosCollections={SIDEBAR_COLLECTION_SNIPPET_LENGTH:10,HEADER_COLLECTION_SNIPPET_LENGTH:25,CONTEXT_MENU_COLLECTION_SNIPPET_LENGTH:11,NUM_PHOTOS_LONG_RUNNING_ADDS:100,NUM_PHOTOS_LONG_RUNNING_REMOVES:250,NUM_PHOTOS_LONG_RUNNING_COLLECTION_DELETES:50,LOADING_SPINNER:new fm('<br/><div class="cu-loading"><img src="/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif" /></div>'),_collections:[],_gid_to_collection:{},_url_to_collection:{},_collection_list_item_tmpl:null,_albums_sidebar_tmpl:null,_all_collections_loaded:false,_removed_pre_load:[],_all_albums_scroll_position:0,_num_loading_collections:0,init:function(j,i){this._collections=j;this._gid_to_collection=j.dict_by("gid");this._url_to_collection=j.dict_by("url");this._collection_list_item_tmpl=fm.tmpl("collection_list_item_tmpl");this._albums_sidebar_tmpl=fm.tmpl("albums_sidebar_tmpl");this._all_collections_loaded=false;this._sidebar_collections_loaded=false;this._num_loading_collections=0;this.refresh_album_views();return this._init_collections()},_init_collections:function(){var i;i=eJ.deconstruct_url();if(i.path!=="/photos/all_albums"){return this.load_collections(5)}},load_collections:function(i){if(this._num_loading_collections!==null&&(this._num_loading_collections<i||i===null)){this._num_loading_collections=i;return cG.WebRequest({url:"/collections",data:{limit:i},subject_user:cQ.get_viewer().photos_user,success:(function(j){return function(fw){var fv,fu,fs,T,ft,fr;fr=JSON.parse(fw);for(fs=0,T=fr.length;fs<T;fs++){fu=fr[fs];if(!(fu.gid in j._gid_to_collection)&&!(ft=fu.gid,cX.call(j._removed_pre_load,ft)>=0)){fv=new ad(fu,false);j._collections.push(fv);j._gid_to_collection[fv.gid]=fv;j._url_to_collection[fv.url]=fv}}if(i===null||fr.length<i){j._all_collections_loaded=true;j._sidebar_collections_loaded=true}if(i>=5){j._sidebar_collections_loaded=true}return j.refresh_album_views()}})(this)})}},reload:function(){this._collections=[];this._gid_to_collection={};this._url_to_collection={};this._all_collections_loaded=false;this.refresh_album_views();return this._init_collections()},listen:function(){$("single-collection-title").observe("click",(function(i){return function(j){if(!bQ.get_current_collection().is_creator){return}i.header_rename();return g.log_interaction(er.RENAME_ALBUM,dh.CLICK_TITLE)}})(this));$(document.body).on("contextmenu",".albums-list-item",this._albums_list_item_contextmenu.bind(this));$(document.body).on("click",".show-collection-target",this._show_collection_click.bind(this));$(document.body).on("click",".collection-shmodel-target",this._collection_shmodel_click.bind(this));$(document.body).on("click",".add-to-album-target",this._add_to_album_click.bind(this));$(document.body).on("mouseover",".add-to-album-drop-target",this._drop_target_mouseover.bind(this));$(document.body).on("mouseup",".add-to-album-drop-target",this._drop_target_mouseup.bind(this));$(document.body).on("mouseout",".add-to-album-drop-target",this._drop_target_mouseout.bind(this));$(document.body).on("click",".create-album-target",this._create_album_click.bind(this));document.observe(bn.HIDE_EVT,(function(){return $$(".albums-list-item.context-selected").invoke("removeClassName","context-selected")}));Event.observe(window,"scroll",this._window_scroll.bind(this));document.observe(ad.CREATE_EVT,this._collection_created.bind(this));document.observe(ad.ADD_EVT,this._collection_photos_added.bind(this));document.observe(ad.REMOVE_EVT,this._collection_photos_removed.bind(this));document.observe(ad.UNDO_REMOVE_EVT,this._collection_undid_remove.bind(this));document.observe(ad.RENAME_EVT,this._collection_renamed.bind(this));document.observe(ad.DELETE_EVT,this._collection_deleted.bind(this));document.observe(ad.SHARE_EVT,this._collection_shared.bind(this));document.observe(ad.UNSHARE_EVT,this._collection_unshared.bind(this));return document.observe(ad.COVER_CHANGE_EVT,this._collection_cover_changed.bind(this))},render_all_albums_view:function(){var ft,fr,T,i,fs;if(this._collections.length||!this._all_collections_loaded){$("albums-empty").hide()}else{$("albums-empty").show()}fr=[];fs=this._collections;for(T=0,i=fs.length;T<i;T++){ft=fs[T];fr.push(this._collection_list_item_tmpl({collection:ft,additional_class:"albums-list-item show-collection-target",Sprite:cy,Emstring:bU}))}$("albums-list").__date(fr);$("albums-list").__sert(new Element("div",{"class":"clearfix"}));if(!this._all_collections_loaded){return $("albums-list").__sert(this.LOADING_SPINNER)}},render_add_to_album_modal:function(){var fu,fr,ft,T,i,fs;fr=[];ft={name:eG("Create new album"),thumbnail_url_256:"/static/images/new_album_big-vflQJ5xd7.png"};fr.push(this._collection_list_item_tmpl({collection:ft,additional_class:"create-album-target",hide_icons:true,Sprite:cy,Emstring:bU}));fs=this._collections;for(T=0,i=fs.length;T<i;T++){fu=fs[T];fr.push(this._collection_list_item_tmpl({collection:fu,additional_class:"add-to-album-target",Sprite:cy,Emstring:bU}))}$("add-to-album-modal-list").__date(fr);if(!this._all_collections_loaded&&this._collections.length>0){return $("add-to-album-modal-list").__sert(this.LOADING_SPINNER)}},render_albums_sidebar:function(){var fw,T,fu,fx,i,fv,ft,fs,fr;if(!this._sidebar_collections_loaded){return}if(!this._collections.length){$("albums-sidebar").hide();$("main-nav-bottom").show();return}$("main-nav-bottom").hide();$("albums-sidebar").show();fx=this._albums_sidebar_tmpl({collections:this._collections.slice(0,5),_:eG,Sprite:cy,PhotosCollections:cN});if((i=$("albums-sidebar"))!=null){i.__date(fx)}if((fv=$("all-albums-sidebar"))!=null){fv.observe("click",bQ.show_all_collections)}if((ft=$("all-albums-sidebar"))!=null){ft.observe("mouseup",(function(j){return function(fy){var fz;if(!e0._drag_drop.active){return}if(e0._drag_drop.single_photo!=null){fz=[e0._drag_drop.single_photo]}else{fz=e0.get()}j.show_add_to_album_modal(fy,fz);return g.log_interaction(er.ADD_TO_OTHER_ALBUM,dh.DROP_TARGET,{num_photos:e0.get().length})}})(this))}if(bQ.in_all_collections_view()){return $("all-albums-sidebar").addClassName("selected")}else{if(bQ.in_single_collection_view()){fs=$$(".sidebar-album");fr=[];for(T=0,fu=fs.length;T<fu;T++){fw=fs[T];if(fw.readAttribute("data-gid")===bQ.get_current_collection().gid){fw.addClassName("selected");break}else{fr.push(void 0)}}return fr}}},refresh_album_views:function(j){var i;if(j==null){j=null}i=(function(T){return function(){T.render_all_albums_view();T.render_albums_sidebar();return T.render_add_to_album_modal()}})(this);if(j!=null?j.length:void 0){return cG.WebRequest({url:"/collections",data:{collection_gids:JSON.stringify(j.unique())},subject_user:cQ.get_viewer().photos_user,success:(function(T){return function(ft){var fB,fy,fs,fx,fw,fu,fz,fv,fr,fA;fr=JSON.parse(ft);for(fw=0,fz=fr.length;fw<fz;fw++){fs=fr[fw];fy=new ad(fs,false);T._gid_to_collection[fy.gid]=fy;T._url_to_collection[fy.url]=fy;fA=T._collections;for(fx=fu=0,fv=fA.length;fu<fv;fx=++fu){fB=fA[fx];if(fB.gid===fy.gid){T._collections[fx]=fy;break}}}return i()}})(this)})}else{return i()}},show_add_to_album_modal:function(i,j){if(j!==e0.get()&&(e0._drag_drop.single_photo==null)){e0._context_selected=j}fh.onHide=function(){e0._context_selected=null;delete fh.onHide;return fh.hide()};fh.show(eG("Choose an album"),$("add-to-album-modal"),false,false,893);return this.load_collections(null)},add_photos:function(T,fs,j){var i,fr;if(j==null){j=true}fr=bQ.get_current_collection_gid();i=fs.length>this.NUM_PHOTOS_LONG_RUNNING_ADDS;ah.success(eG("Adding to album..."));return T.add_photos(fs,fr,i,j)},show_remove_photos_modal:function(fr,ft){var T,i,fs,j;j=de.categorize_files(ft),i=j[0],fs=j[1];if(i&&fs){T=bd("Remove %(file_count)s item?","Remove %(file_count)s items?",ft.length)}else{if(i){T=bd("Remove %(file_count)s photo?","Remove %(file_count)s photos?",ft.length)}else{T=bd("Remove %(file_count)s video?","Remove %(file_count)s videos?",ft.length)}}T=T.format({file_count:ft.length});dB.fillVal(de.file_desc(ft),"collection-remove-files");dB.fillVal(fr.name.escapeHTML(),"collection-remove-name");return fh.show(T,dB.fromElm("collection-remove-modal"),{action:(function(fu){return function(){var fv;ft=ft.slice(0);fv=ft.length>fu.NUM_PHOTOS_LONG_RUNNING_REMOVES;return fr.remove_photos(ft,fv)}})(this)})},header_rename:function(){if(bF("#single-collection-title-container").hasClass("editing")){return}bF("#single-collection-title-container").addClass("editing");return bQ.get_current_collection().rename($("single-collection-title"))},show_delete_modal:function(j){var i;dB.fillVal(j.name.escapeHTML(),"collection-delete-name");i=eG("Delete album?");return fh.show(i,dB.fromElm("collection-delete-modal"),{action:function(){if(j.num_items>this.NUM_PHOTOS_LONG_RUNNING_COLLECTION_DELETES){ah.success(eG("Deleting '%(collection_name)s'...").format({collection_name:j.name}),100)}return j["delete"]()}})},show_unshare_modal:function(j){var i;dB.fillVal(j.name.escapeHTML(),"collection-unshare-name");i=eG("Unshare album?");return fh.show(i,dB.fromElm("collection-unshare-modal"),{action:function(){return j.unshare()}})},create:function(fw,fv,fA,j){var fr,fs,T,ft,fy,fz,fx,i,fu;if(j==null){j=false}if(fw){Event.extend(fw).preventDefault();fu=$(fw.target);if(fu.hasClassName("inplaceeditor-form")||(fu.up(".inplaceeditor-form")!=null)){return}if(fu.up("#context-menu")){fr=true}else{if(fu.up(".freshdropdown-menu")){T=true}}}bQ.enable_selection();if(!fA){fA=e0.get()}ft=(function(){var fC,fB,fD;fD=[];for(fC=0,fB=fA.length;fC<fB;fC++){i=fA[fC];fD.push(i.item_counter)}return fD})();fA.sort_by_key(function(fB){return fB.time_taken});fy=fA.length>this.NUM_PHOTOS_LONG_RUNNING_ADDS;fx=(function(fB){return function(fD){var fG,fE,fC,fF;fE=JSON.parse(fD.responseText);fG=new ad(fE);e0.clear();eZ.hide_all();bn.hide();fh.hide();bQ.disable_selection();fF=eG("Created '%(collection_name)s'");fC=fG.name.escapeHTML();fF=fF.format({collection_name:"<a data-gid='"+fG.gid+"' class='show-collection-target'>"+fC+"</a>"});ah.success(new fm(fF));return fB.flash_sidebar_album(fG.gid)}})(this);fz=function(){if(!T){eZ.hide_all()}if(!fr){bn.hide()}cN.render_albums_sidebar();return bQ.disable_selection()};fs=new Ajax.InPlaceEditor(fv,"/collection_create",{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:11,ajaxClass:Ajax.DBRequest,submitOnBlur:j,initialText:"",cancelIfSame:true,clickToEdit:false,onCancel:fz,onFailure:function(){},savingText:eG("Creating..."),onLeaveEditMode:bQ.disable_selection(),onLeaveHover:function(){},ajaxOptions:{method:"POST",onSuccess:fx,job:fy,job_user:cQ.get_viewer().photos_user,progress_text:eG("Creating album...")},callback:function(fB,fD){var fC;ah.success(eG("Creating album..."));fC={collection_name:fD,item_counters:JSON.stringify(ft),source_collection_gid:bQ.get_current_collection_gid()};return fC}});fs.enterEditMode();if(!j){return fs._controls.editor.observe("blur",fz)}},toggle_more_selected_actions:function(i){if(i){Event.extend(i).preventDefault()}if(!$("more-selected-actions-menu").visible()){return eZ.show($("more-selected-actions-menu"),$("more-selected-actions-button"))}},toggle_more_actions:function(i){var j;if(i){Event.extend(i).preventDefault()}if(!$("more-collection-actions-menu").visible()){if(bQ.get_current_collection().share_tkey!=null){$("unshare-album").show()}else{$("unshare-album").hide()}if(b1.msie_version_at_most(10)){j=bF("#more-collection-actions-menu");if(!j.parent().is("body")){bF(document.body).append(j.remove())}}return eZ.show($("more-collection-actions-menu"),$("more-collection-actions-button"))}},_collection_created:function(i){var j;j=i.memo.collection;if(!j.is_anonymous){this._collections.unshift(j)}this._gid_to_collection[j.gid]=j;this._url_to_collection[j.url]=j;return this.refresh_album_views()},_collection_changed:function(i){this._collections.removeItem(i);this._collections.unshift(i);return this.refresh_album_views()},_collection_photos_added:function(fv){var fu,ft,fs,fw,fx,T,i,j,fy,fr;fu=fv.memo.collection;fy=fv.memo.photos;fw=fv.memo.num_items_added;T=fv.memo.num_photos_added;j=fv.memo.num_videos_added;if(fv.memo.promote_collection&&fw>0){this._collection_changed(fu)}else{this.refresh_album_views()}if(fy===e0.get()){e0.clear()}if(fw<1){fr=de.categorize_files(fy),fx=fr[0],i=fr[1];if(fx&&i){fs=bd("That item is already in '%(collection_name)s'","Those items are already in '%(collection_name)s'",fy.length)}else{if(fx){fs=bd("That photo is already in '%(collection_name)s'","Those photos are already in '%(collection_name)s'",fy.length)}else{fs=bd("That video is already in '%(collection_name)s'","Those videos are already in '%(collection_name)s'",fy.length)}}}else{if(T&&j){fs=bd("Added item to '%(collection_name)s'","Added items to '%(collection_name)s'",fy.length)}else{if(T){fs=bd("Added photo to '%(collection_name)s'","Added photos to '%(collection_name)s'",fy.length)}else{fs=bd("Added video to '%(collection_name)s'","Added videos to '%(collection_name)s'",fy.length)}}}ft=fu.name.escapeHTML();fs=fs.format({collection_name:"<a data-gid='"+fu.gid+"' class='show-collection-target'>"+ft+"</a>"});return ah.success(new fm(fs))},_collection_photos_removed:function(j){var T,fr,i;T=j.memo.collection;fr=j.memo.photos;i=bQ.undo_enabled?j.memo.undo_changeset:null;bQ.get_timeline().remove_photos(fr);this._collection_changed(T);return ah.success(eG("Removed %(files_desc)s from '%(collection_name)s'").format({files_desc:de.file_desc(fr),collection_name:T.name}),null,null,i,(function(){return T.undo_remove(i)}))},_collection_undid_remove:function(i){var j;j=i.memo.collection;bQ.get_timeline().restore_removed_photos();cN.refresh_album_views([j.gid]);return ah.success(eG("Undo complete"))},_collection_renamed:function(j){var T,i;T=j.memo.collection;if(((i=bQ.get_current_collection())!=null?i.gid:void 0)===T.gid){bF("#single-collection-title").text(bU.em_snippet(T.name,this.HEADER_COLLECTION_SNIPPET_LENGTH,1));document.title=T.name+" - Dropbox"}this._collection_changed(T);return ah.success(eG("Renamed '%(collection_name)s'").format({collection_name:T.name}))},_collection_deleted:function(j){var T,i;T=j.memo.collection;this._collections.removeItem(T);if(!this._all_collections_loaded){this._removed_pre_load.push(T.gid)}this.refresh_album_views();if(((i=bQ.get_current_collection())!=null?i.gid:void 0)===T.gid){bQ.show_all_collections()}delete this._gid_to_collection[T.gid];delete this._url_to_collection[T.url];return ah.success(eG("Deleted '%(collection_name)s'").format({collection_name:T.name}))},_collection_shared:function(j){var T,i;T=j.memo.collection;this._collection_changed(T);if(((i=bQ.get_current_collection())!=null?i.gid:void 0)===T.gid){bF("#single-collection-share-status").text(eG("Shared"));return bF("#single-collection-share-status").attr("href",T.shmodel_url)}},_collection_unshared:function(j){var T,i;T=j.memo.collection;if(((i=bQ.get_current_collection())!=null?i.gid:void 0)===T.gid){bF("#single-collection-share-status").text("")}return ah.success(eG("Unshared '%(collection_name)s'").format({collection_name:T.name}))},_collection_cover_changed:function(i){var T,j;T=i.memo.collection;this._collection_changed(T);j=eG("Changed cover photo for '%(collection_name)s'");j=j.format({collection_name:T.name.escapeHTML()});return ah.success(j)},_albums_list_item_contextmenu:function(j,i){bn.show_photo_collection(j,this.get(i.readAttribute("data-gid")),i);i.removeClassName("album-flash");return i.addClassName("context-selected")},_show_collection_click:function(T,i){var j;j=$(T.target);if(j.hasClassName("inplaceeditor-form")||(j.up(".inplaceeditor-form")!=null)){return}return bQ.show_collection(i.readAttribute("data-gid"))},_collection_shmodel_click:function(j,i){return this.go_to_link(this.get(i.readAttribute("data-gid")))},_add_to_album_click:function(j,i){if(e0._context_selected){this.add_photos(this.get(i.readAttribute("data-gid")),e0._context_selected);e0._context_selected=null}else{this.add_photos(this.get(i.readAttribute("data-gid")),e0.get())}delete fh.onHide;fh.hide();return g.log_interaction(er.ADD_TO_RECENT_ALBUM,dh.SAH,{num_photos:e0.get().length})},_drop_target_mouseover:function(j,i){if(e0._drag_drop.active){i.addClassName("hovered");return $("photos-drag-status").addClassName("hovering")}},_drop_target_mouseout:function(j,i){if(e0._drag_drop.active){i.removeClassName("hovered");return $("photos-drag-status").removeClassName("hovering")}},_drop_target_mouseup:function(j,i){var T;if(i.hasClassName("hovered")){i.removeClassName("hovered");$("photos-drag-status").removeClassName("hovering");if(e0._drag_drop.single_photo!=null){T=[e0._drag_drop.single_photo]}else{T=e0.get()}if(i.readAttribute("data-gid")!=null){this.add_photos(this.get(i.readAttribute("data-gid")),T,false)}if(i.identify()==="add-to-album-sidebar-new"){return g.log_interaction(er.ADD_TO_NEW_ALBUM,dh.DROP_TARGET,{num_photos:e0.get().length})}else{if(i.identify()==="all-albums-sidebar"){return g.log_interaction(er.ADD_TO_OTHER_ALBUM,dh.DROP_TARGET,{num_photos:e0.get().length})}else{return g.log_interaction(er.ADD_TO_RECENT_ALBUM,dh.DROP_TARGET,{num_photos:e0.get().length})}}}},_create_album_click:function(i,j){if(e0._context_selected){this.create(i,j.down(".collection-name"),e0._context_selected,true);return e0._context_selected=null}else{return this.create(i,j.down(".collection-name"),e0.get(),true)}},_window_scroll:function(){if(bQ.in_all_collections_view()){return this._all_albums_scroll_position=D.scroll_offsets().top}},get_all:function(){return this._collections},get_from_url:function(i){return this._url_to_collection[i]},get:function(i){return this._gid_to_collection[i]},go_to_link:function(i){return window.open(i.shmodel_url,"_blank")},restore_all_albums_scroll_position:function(){if(this._all_albums_scroll_position!=null){return window.scrollTo(0,this._all_albums_scroll_position)}else{return window.scrollTo(0,0)}},two_line_snippet:function(T,j){var i,fs,fr;i=bU.em_snippet(T,j,1);fs=i.lastIndexOf(" ");if(fs===-1){return i}else{i=i.slice(0,+fs+1||9000000000);fr=bU.em_snippet(T.slice(fs+1),j,1);return i+fr}},get_default_album_name:function(){var i;i=eG("Untitled album");return this.increment_collection_name_until_valid(i)},collection_name_in_use:function(fr){var ft,T,i,fs;fs=this.get_all();for(T=0,i=fs.length;T<i;T++){ft=fs[T];if(ft.name===fr.trim()){return true}}return false},increment_collection_name_until_valid:function(j){var T,i;T=this.collection_name_in_use(j);i=0;while(T){i++;T=this.collection_name_in_use(j+(" ("+i+")"))}return(i===0?j:j+(" ("+i+")"))},flash_sidebar_album:function(ft){var fu,T,i,fs,fr;fs=$$(".sidebar-album");fr=[];for(T=0,i=fs.length;T<i;T++){fu=fs[T];if(fu.readAttribute("data-gid")===ft){fu.removeClassName("album-flash");fu.addClassName("album-flash");break}else{fr.push(void 0)}}return fr}};var cl;cl=F.PhotoTimeline=(function(){i.PHOTOS_ADDED_EVT="db:phototimeline:photos_added";i.PHOTOS_REMOVED_EVT="db:phototimeline:photos_removed";i.prototype.THUMB_SIZE=null;i.prototype.HEADER_HEIGHT=null;i.prototype.THUMBS_PER_ROW=4;i.prototype.RENDER_SCROLL_WAIT=100;i.prototype.RENDER_SCROLL_MAX_WAIT=750;i.prototype.HIDE_TIMELINE_NAV_DELAY=1500;i.prototype.THUMBS_BATCH_SIZE=12;i.prototype.VIEWPORT_SCALE_SCROLL_DIRECTION=4;i.prototype.VIEWPORT_SCALE_OTHER_DIRECTION=1;i.prototype.TIMELINE_NAV_MOUSE_THRESHOLD=100;i.prototype.TIMELINE_NAV_ELM_HEIGHT=20;i.prototype.TIMELINE_DOT_HTML=cy.html("web","timeline_dot");i.container;i.scroll_container;i.events;i.current_event;i.key_to_photo;i.preview_objs;i.tmpl;i.last_render_scroll_timeout;i.start_render_scroll_time;i.last_scroll_position;i.hide_timeline_nav_timeout;i.grid;i._skip_scroll_update;i.header_id_to_sel_items;i.event_remove_info;i.opts;function i(T,fr,fu,fs,ft,fv,fw,fx,j){this.container=T;this.scroll_container=fr;this.tmpl=fw;this.opts=j;this.THUMB_SIZE=fx.thumb_size;this.HEADER_HEIGHT=fx.header_height;this.key_to_photo={};this.preview_objs=[];this.start_render_scroll_time=-1;this.grid={};this._skip_scroll_update=false;this.header_id_to_sel_items=fv;this.event_remove_info=[];this._init_events(fu,fs,ft);this.update_offsets(fx.top_offset,fx.left_offset);this.listen();dH.start_capture(this.scroll_container)}i.prototype._init_events=function(fy,fs,fu){var fr,fw,fB,ft,fv,fx,fz,fA,T;if(fy.length<1){this.events=new a0([],{});return}fw=[];fv={};fB=false;for(fx=0,fz=fy.length;fx<fz;fx++){ft=fy[fx];ft=String(ft);T=ft in this.header_id_to_sel_items?this.header_id_to_sel_items[ft]:[];fA=false;if(T.length&&!fB){fB=true;fA=true}fr=new di(this,ft,fs[ft],fu[ft],T,fA);fw.push(ft);fv[ft]=fr}return this.events=new a0(fw,fv)};i.prototype.listen=function(){this._bound_window_scroll=this._window_scroll.bind(this);this._bound_window_resize=this._window_resize.bind(this);this._body_mousemove_handler=$(document.body).on("mousemove",this._body_mousemove.bind(this));this._timeline_elm_click_handler=$(document.body).on("click",".timeline-elm",this._timeline_elm_click.bind(this));this._show_missing_timestamp_bucket_handler=$(document.body).on("click","#show-missing-timestamps-button",this._show_missing_timestamp_bucket.curry(true,false).bind(this));if(this.scroll_container!=null){this.scroll_container.observe("scroll",this._bound_window_scroll)}else{Event.observe(window,"scroll",this._bound_window_scroll)}Event.observe(window,"resize",this._bound_window_resize);return $(document).observe(di.EVENT_MISCOUNT_EVT,this._event_miscount.bind(this))};i.prototype.unlisten=function(){var fr,T,j;if((fr=this._body_mousemove_handler)!=null){fr.stop()}if((T=this._timeline_elm_click_handler)!=null){T.stop()}if((j=this._show_missing_timestamp_bucket_handler)!=null){j.stop()}if(this.scroll_container!=null){this.scroll_container.stopObserving("scroll",this._bound_window_scroll)}else{Event.stopObserving(window,"scroll",this._bound_window_scroll)}Event.stopObserving(window,"resize",this._bound_window_resize);return $(document).stopObserving(di.EVENT_MISCOUNT_EVT)};i.prototype.render=function(){this._render_empty_grid();this.init_timeline_nav();this._load_metadata_for_sel_events();return this._render_viewport()};i.prototype.update_offsets=function(fr,T){var fu,fs,fv,ft;cP(this.THUMBS_PER_ROW>0,"Invalid THUMBS_PER_ROW: "+this.THUMBS_PER_ROW);this.top_offset=fr;this.refresh_row_offsets();this.left_offset=T;this.grid.photo_col_offsets=[];ft=[];for(fu=fs=0,fv=this.THUMBS_PER_ROW;0<=fv?fs<=fv:fs>=fv;fu=0<=fv?++fs:--fs){ft.push(this.grid.photo_col_offsets.push(this.left_offset+this.THUMB_SIZE*fu))}return ft};i.prototype.refresh_row_offsets=function(){var fx,fw,fu,ft,fs,T,fv,fr;this.grid.photo_row_offsets=[];fx=this.top_offset;fv=this.events.getValues();for(ft=0,T=fv.length;ft<T;ft++){fw=fv[ft];fw.top_offset=fx;fx+=this.HEADER_HEIGHT;this.grid.photo_row_offsets.push(fx);for(fu=fs=0,fr=fw.get_num_rows();0<=fr?fs<fr:fs>fr;fu=0<=fr?++fs:--fs){fx+=this.THUMB_SIZE;this.grid.photo_row_offsets.push(fx)}}};i.prototype._render_empty_grid=function(){var ft,fr,T,fu,fs;this.container.__date();fs=this.events.getValues();for(fr=0,T=fs.length;fr<T;fr++){ft=fs[fr];if(!(ft.is_missing_timestamp_bucket()&&this.events.length()>1)){ft.add_html_elements_to(this.container)}}if(this.has_missing_timestamp_bucket()&&this.events.length()>1){fu=bF('<div id="show-missing-timestamps-button"/>').addClass("freshbutton-silver").text(eG("Show photos with missing dates"));return bF(this.container).append(fu)}};i.prototype._render_viewport=function(fr){var T,fD,ft,fy,fw,fu,fz,fB,fx,fv,fs,fC,fA,fE;if(fr==null){fr=false}this.start_render_scroll_time=-1;fE=this.get_viewport_info();fD=[];fs=this.events.getValues();for(fy=0,fB=fs.length;fy<fB;fy++){T=fs[fy];if(!(T.has_loaded_metadata()||T.loading_metadata||(T.is_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown()))){if(T.in_current_viewport(fE,false)){fD.unshift(T)}else{if(T.in_current_viewport(fE,true)){fD.push(T)}}}}for(fw=0,fx=fD.length;fw<fx;fw++){T=fD[fw];fC=T.get_photo_range_to_render(fE,true),ft=fC[0],fz=fC[1];T.load_metadata_range(ft,fz)}if(fr){fE=this.get_viewport_info();fA=this.events.getValues();for(fu=0,fv=fA.length;fu<fv;fu++){T=fA[fu];if(T.in_current_viewport(fE,false)){T.timing_stopped_scrolling_on_event=b6.time()-this.RENDER_SCROLL_WAIT}}}return this._load_visible_photos()};i.prototype._load_metadata_for_sel_events=function(){var fs,ft,fr,T,j;if("a_missing_timestamps" in this.header_id_to_sel_items){this._show_missing_timestamp_bucket(false,false)}fr=this.header_id_to_sel_items;T=[];for(ft in fr){j=fr[ft];fs=this.events.valueFromKey(ft);if(fs!=null){fs.load_metadata()}T.push(cP(fs!=null,"Missing "+ft+" in list of events with selected photos"))}return T};i.prototype._load_visible_photos=function(){var fu,fr,T,ft,fs;ft=this.events.getValues();fs=[];for(fr=0,T=ft.length;fr<T;fr++){fu=ft[fr];if(!(fu.is_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown())){fs.push(fu.update_photo_divs())}else{fs.push(void 0)}}return fs};i.prototype._body_mousemove=function(j){if(!this.opts.uses_timeline_nav){return}if((j.clientX+D.scroll_offsets().left)>=($(document.body).getWidth()-this.TIMELINE_NAV_MOUSE_THRESHOLD)){return $("timeline-nav").addClassName("mouse-active")}else{return $("timeline-nav").removeClassName("mouse-active")}};i.prototype._timeline_elm_click=function(fs,fr){var j,T;T=fr.readAttribute("data-event-id");if(T){j=this.events.valueFromKey(T)}this._update_timeline_position(j);if(j.is_missing_timestamp_bucket()){g.log_interaction(co.MISSING_TIMESTAMPS_VIEW);if(!this.is_missing_timestamp_bucket_shown()){this._show_missing_timestamp_bucket(false)}}return this._scroll_to_event(j)};i.prototype._scroll_to_event=function(fr,j){var T;if(j==null){j=false}T=fr.top_offset-this.top_offset;if(fr&&(D.scroll_offsets().top!==T)){if(j){return bF("html, body").animate({scrollTop:T},200)}else{this._skip_scroll_update=true;return window.scrollTo(D.scroll_offsets().left,T)}}};i.prototype._window_scroll=function(){var fv,fs,T,fr,fu,ft,fw;fr=b6.time();bs.clear_all_pending_batches();if(this.start_render_scroll_time===-1||fr-this.start_render_scroll_time<this.RENDER_SCROLL_MAX_WAIT){clearTimeout(this.last_render_scroll_timeout)}if(this.start_render_scroll_time===-1){this.start_render_scroll_time=fr}fw=this.visible_thumbs_loaded()?0:this.RENDER_SCROLL_WAIT;this.last_render_scroll_timeout=setTimeout(this._render_viewport.curry(true).bind(this),fw);if(this.opts.uses_timeline_nav){this._update_timeline_position();$("timeline-nav").addClassName("scroll-active");clearTimeout(this.hide_timeline_nav_timeout);this.hide_timeline_nav_timeout=setTimeout(((function(j){return function(){return $("timeline-nav").removeClassName("scroll-active")}})(this)),this.HIDE_TIMELINE_NAV_DELAY)}this.last_scroll_position=D.scroll_offsets().top;bQ.scroll_count++;fu=this.events.getValues();ft=[];for(fs=0,T=fu.length;fs<T;fs++){fv=fu[fs];ft.push(fv.logged_thumbs_arrived=false)}return ft};i.prototype._window_resize=function(){this._resize_timeline_nav();return this._show_hide_timeline_elms()};i.prototype.init_timeline_nav=function(){var ft,fr,T,fs;if(!this.opts.uses_timeline_nav){return}this.grid.side_nav={};this.current_event=null;this._resize_timeline_nav();fs=this.events.getValues().reverse();for(fr=0,T=fs.length;fr<T;fr++){ft=fs[fr];ft.add_to_timeline_nav(ft===this.events.getValues()[0])}this._update_timeline_position();return this._show_hide_timeline_elms()};i.prototype._resize_timeline_nav=function(){var j;if(!this.opts.uses_timeline_nav){return}j=this.get_viewport_info().height-this.TIMELINE_NAV_ELM_HEIGHT;return $("timeline-nav").setStyle({height:j+"px"})};i.prototype._update_timeline_position=function(fv){var fA,fy,T,ft,fs,fw,fu,fr,fx,fz;if(!this.opts.uses_timeline_nav){return}if(this._skip_scroll_update){this._skip_scroll_update=false;return}if(fv==null){fz=this.get_viewport_info();if(this.scroll_container==null){fz.top=document.viewport.getScrollOffsets().top}fA=fz.top+fz.height/2;fr=this.events.getValues();for(ft=0,fw=fr.length;ft<fw;ft++){T=fr[ft];if(T.top_offset>fA){break}fv=T}}if((fv==null)||fv===this.current_event){return}$$(".timeline-elm.current").invoke("removeClassName","current");fx=$$(".timeline-elm");for(fs=0,fu=fx.length;fs<fu;fs++){fy=fx[fs];if(fy.readAttribute("data-event-id")===fv.unique_id){fy.addClassName("current");break}}return this.current_event=fv};i.prototype._show_hide_timeline_elms=function(){var fx,fw,fs,fr,T,fv,fu,ft;if(!this.opts.uses_timeline_nav){return}fs=$("cu-header").cumulativeOffset().left+$("cu-header").getWidth();fw=$("cu-header").cumulativeOffset().top+$("cu-header").getHeight();fu=$$(".timeline-elm");ft=[];for(fr=0,T=fu.length;fr<T;fr++){fx=fu[fr];fx.show();fv=fx.cumulativeOffset();if(fv.top<fw&&fv.left<fs){ft.push(fx.hide())}else{ft.push(void 0)}}return ft};i.prototype._event_miscount=function(j){this.refresh_row_offsets();return this._load_visible_photos()};i.prototype.remove_photos=function(fx){var fu,fv,fw,ft,T,fs,fr;fx=fx.slice(0);this.event_remove_info=[];fw={};for(ft=0,T=fx.length;ft<T;ft++){fs=fx[ft];fv=fs.event.unique_id;if(fv in fw){fw[fv].push(fs)}else{fw[fv]=[fs]}}for(fv in fw){fx=fw[fv];fu=this.events.valueFromKey(fv);fr=fu.remove_photos(fx);this.event_remove_info.push({event:fu,remove_info:fr})}this.init_timeline_nav();this.refresh_row_offsets();this._load_visible_photos();return $(document).fire(i.PHOTOS_REMOVED_EVT,this)};i.prototype.restore_removed_photos=function(){var T,fF,fC,fw,fv,ft,fz,fx,fu,fE,fs,fA,fy,fD,fr,fB;e0.clear();fs=this.event_remove_info.reverse();for(fw=0,fz=fs.length;fw<fz;fw++){fF=fs[fw];T=fF.event;fD=fF.remove_info;if(fD.removed_event_index!=null){this.events.insertAtIndex(fD.removed_event_index,T.unique_id,T);T.restore()}T.add_photos(fD.removed_photos_and_indexes.reverse());fA=fD.removed_photos_and_indexes;for(fv=0,fx=fA.length;fv<fx;fv++){fE=fA[fv];e0._add(fE.photo)}}fr=null;fB=null;fy=this.event_remove_info;for(ft=0,fu=fy.length;ft<fu;ft++){fF=fy[ft];T=fF.event;fD=fF.remove_info;fC=this.events.indexOfKey(T.unique_id);if((fr==null)||fr>fC){fr=fC;fB=fD.removed_photos_and_indexes[0].photo}}this.event_remove_info=[];this.init_timeline_nav();if(fB!=null){this.scroll_to_photo_with_key(fB.uniqueness_key)}this.refresh_row_offsets();this._load_visible_photos();return $(document).fire(i.PHOTOS_ADDED_EVT,this)};i.prototype.get_photos=function(){var ft,fr,T,fu,fs;fu=[];fs=this.events.getValues();for(fr=0,T=fs.length;fr<T;fr++){ft=fs[fr];fu=fu.concat(ft.photos)}return fu};i.prototype.num_photos=function(){var fu,fr,T,fs,ft;fs=0;ft=this.events.getValues();for(fr=0,T=ft.length;fr<T;fr++){fu=ft[fr];fs+=fu.photos.length}return fs};i.prototype.get_preview_objs=function(){var T,fu,ft,fw,fv,fr,fx,fs,fy;fx=[];fs=this.events.getValues();for(fu=0,fw=fs.length;fu<fw;fu++){T=fs[fu];fy=T.photos;for(ft=0,fv=fy.length;ft<fv;ft++){fr=fy[ft];fx.push(fr.preview_obj)}}return fx};i.prototype.index_of_photo=function(ft){var fv,fs,fr,T,fu;fs=0;fu=this.events.getValues();for(fr=0,T=fu.length;fr<T;fr++){fv=fu[fr];if(fv===ft.event){fs+=fv.photos.indexOf(ft);break}else{fs+=fv.photos.length}}return fs};i.prototype.photo_at_index=function(ft){var fr,fv,fs,T,fu;fr=0;fu=this.events.getValues();for(fs=0,T=fu.length;fs<T;fs++){fv=fu[fs];if(fr+fv.photos.length>ft){return fv.photos[ft-fr]}else{fr+=fv.photos.length}}return null};i.prototype.get_thumb_elm_for_photo=function(j){return $(j.uniqueness_key)};i.prototype.get_photo_for_thumb_elm=function(j){if(!j.hasClassName("cu-thumb")){j=j.up(".cu-thumb")}if(j){return this.key_to_photo[j.identify()]}else{return null}};i.prototype.get_viewport_info=function(){var j,T;if(this.scroll_container!=null){T=this.scroll_container.scrollTop;j=this.scroll_container.getHeight()}else{T=D.scroll_offsets().top;j=D.viewport_dimensions().height}return{top:T,height:j,bottom:T+j}};i.prototype.scroll_to_photo_with_key=function(T){var fu,fr,j,ft,fs;D.scroll_unlock_document();fu=$(T);if(fu!=null?fu.visible():void 0){ec.scroll_to_thumb(fu)}else{j=this.key_to_photo[T];fr=j.event;if(j.event!=null){ft=Math.floor(fr.photos.indexOf(j)/this.THUMBS_PER_ROW);fs=this.get_viewport_info().height;D.scroll_to(0,fr.top_offset+this.HEADER_HEIGHT+ft*this.THUMB_SIZE-fs/2)}}return this._load_visible_photos()};i.prototype.restore_scroll_position=function(){D.scroll_unlock_document();if(this.last_scroll_position!=null){window.scrollTo(0,this.last_scroll_position)}else{window.scrollTo(0,0)}if(Prototype.Browser.IE&&Prototype.Browser.IEV<9){return this._load_visible_photos()}};i.prototype.visible_thumbs_loaded=function(){var ft,fr,T,fs;fs=this.events.getValues();for(fr=0,T=fs.length;fr<T;fr++){ft=fs[fr];if(!ft.visible_thumbs_loaded()){return false}}return true};i.prototype.has_missing_timestamp_bucket=function(){var j;j=this.events.getValues();return j[j.length-1].is_missing_timestamp_bucket()};i.prototype.is_missing_timestamp_bucket_shown=function(){var j,T;if(!this.has_missing_timestamp_bucket()){return false}j=this.events.getValues();T=j[j.length-1].unique_id;return bF("#p-"+T).length>0};i.prototype._show_missing_timestamp_bucket=function(j,fs){var fr,T;if(j==null){j=true}if(fs==null){fs=false}if(!(this.has_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown())){return}T=this.events.getValues();fr=T[T.length-1];bF("#show-missing-timestamps-button").hide();fr.add_html_elements_to(this.container);if(!fs){if(this.opts.uses_timeline_nav){$("timeline-nav").addClassName("mouse-active")}this._scroll_to_event(fr,j);this._render_viewport()}return this.init_timeline_nav()};return i})();var di;di=F.PhotoEvent=(function(){i.EVENT_MISCOUNT_EVT="db:photoevent:miscount";i.PHOTOS_LOADED_EVT="db:photoevent:photos_loaded";i.prototype.MONTH_PREFIX="m_";i.prototype.COLLECTION_PREFIX="c_";i.prototype.EVENT_PREFIX="e_";i.prototype.MISSING_TIMESTAMP_PREFIX="a_";i.prototype.NUM_LIGHTBOX_PHOTOS_TO_PRELOAD=5;i.prototype.MAX_PHOTOS_PER_METADATA_REQUEST=500;i.timeline;i.unique_id;i.name;i.init_num_photos;i.photos;i.header_html;i.placeholder_html;i.top_offset;i.loading_metadata;i.cursor;i.num_photos_loaded;i.prototype.LOADING_ORDER_NOT_DECIDED=-1;i.prototype.LOADING_ORDER_TOP_DOWN=0;i.prototype.LOADING_ORDER_BOTTOM_UP=1;i.loading_order;i.num_photos_to_load;i.on_load_all_metadata;i.init_sel_items;i.scroll_to_first_sel;i.num_to_select;i.logged_thumbs_arrived;i.timing_metadata_received;i.timing_stopped_scrolling_on_event;i.scroll_count;function i(fy,fw,fr,fx,T,fv){var ft,fz,fs,fu;this.timeline=fy;this.unique_id=fw;this.name=fr;this.init_num_photos=fx;this.photos=(function(){var fA,fC,fB;fB=[];for(ft=fA=0,fC=fx;0<=fC?fA<fC:fA>fC;ft=0<=fC?++fA:--fA){fB.push(new L(this))}return fB}).call(this);this.init_sel_items={};for(fs=0,fu=T.length;fs<fu;fs++){fz=T[fs];this.init_sel_items[fz]=true}this.num_to_select=T.length;this.scroll_to_first_sel=fv;this._generate_container_html();this.timing_metadata_received=-1;this.timing_stopped_scrolling_on_event=-1;this.num_photos_loaded=0;this.loading_order=this.LOADING_ORDER_NOT_DECIDED;this.num_photos_to_load=0;this.loading_metadata=false;if(fx===0){$("single-album-empty").show()}}i.prototype.is_month=function(){return this.unique_id.slice(0,2)===this.MONTH_PREFIX};i.prototype.is_missing_timestamp_bucket=function(){return this.unique_id.slice(0,2)===this.MISSING_TIMESTAMP_PREFIX};i.prototype.get_month=function(){var j;cP(this.is_month(),"this must be a month event");j=parseInt(this.unique_id.slice(6,8),10);cP(!isNaN(j),"Month was not parsed out of the event id "+this.unique_id+" correctly.",true,["photo_event_nan_date"]);return j};i.prototype.get_year=function(){var j;cP(this.is_month(),"this must be a month event");j=parseInt(this.unique_id.slice(2,6),10);cP(!isNaN(j),"Year was not parsed out of the event id "+this.unique_id+" correctly.",true,["photo_event_nan_date"]);return j};i.prototype.is_collection=function(){return this.unique_id.slice(0,2)===this.COLLECTION_PREFIX};i.prototype.get_collection_gid=function(){cP(this.is_collection(),"this must be a collection event");return this.unique_id.slice(2)};i.prototype.is_event=function(){return this.unique_id.slice(0,2)===this.EVENT_PREFIX};i.prototype._generate_container_html=function(){var fs,T,ft,fv,fr,j,fu;fv=this.name;if(this.is_event()){this.header_html=new Element("h1",{id:"h-"+this.unique_id,"class":"cu-month-header"});this.header_html.__sert(fv);fs=new Element("div",{"class":"event-button event-add-to-album title_bubble","data-title":"Add to album"});fs.__date(cy.html("web","event_add_to_album"));this.header_html.__sert(fs);fu=new Element("div",{"class":"event-button event-share title_bubble","data-title":"Share"});fu.__date(cy.html("web","event_share"));this.header_html.__sert(fu);j=new Element("div",{"class":"event-button event-select title_bubble","data-title":"Select all"});j.__date(cy.html("web","event_select"));this.header_html.__sert(j)}else{this.header_html=new fm("<h1 class='cu-month-header' id='h-"+this.unique_id+"'><span>"+fv+"</span></h1>")}T=this.get_content_height();fr=this.photos.length%this.timeline.THUMBS_PER_ROW;ft=fr===0?0:(this.timeline.THUMBS_PER_ROW-fr)*this.timeline.THUMB_SIZE;return this.placeholder_html=new fm('<div style="height: '+T+'px;" id="p-'+this.unique_id+'" class="content-placeholder-container">\n  <div style="height: '+T+'px;" id="p-top-'+this.unique_id+'" class="content-placeholder"></div>\n  <div style="height: 0px;" id="p-bottom-'+this.unique_id+'" class="content-placeholder"></div>\n  <div style="width: '+ft+'px" id="p-cover-'+this.unique_id+'" class="thumb-cover"></div>\n</div>')};i.prototype.add_html_elements_to=function(T){var j;if(this.is_event()){j=new Element("div",{"class":"photo-event"});j.__sert(this.header_html);j.__sert(this.placeholder_html);return T.__sert(j)}else{T.__sert(this.header_html);return T.__sert(this.placeholder_html)}};i.prototype.remove=function(){$("h-"+this.unique_id).hide();$("p-"+this.unique_id).hide();return this.timeline.events.remove(this.unique_id)};i.prototype.restore=function(){$("h-"+this.unique_id).show();return $("p-"+this.unique_id).show()};i.prototype.add_to_timeline_nav=function(fw){var j,fu,fx,T,fy,ft,fs,fv,fr;if(fw==null){fw=false}if(!(this.is_month()||this.is_event()||this.is_missing_timestamp_bucket())){return}fr=this.timeline.get_viewport_info().height;fy=this.timeline.TIMELINE_NAV_ELM_HEIGHT;ft=$(document.body).getHeight();fs=this.top_offset/ft*100;if(this.is_event()){T=this.name}else{if(this.is_missing_timestamp_bucket()){T=eG("Missing dates")}else{T=b6.month_abbr_with_year(this.get_month()-1,this.get_year())}}fx=false;for(fv in this.timeline.grid.side_nav){j=Math.abs(this.timeline.events.valueFromKey(fv).top_offset-this.top_offset);if(j/ft*fr<fy){fx=true;if(fw){bF("#timeline-nav-"+fv).remove()}}}fu=bF("#timeline-nav-"+this.unique_id);if(!fx||fw){if(fu.length){fu.css("top",fs+"%")}else{fu=bF("<div/>");fu.addClass("timeline-elm");fu.attr({"data-event-id":this.unique_id.toString(),id:"timeline-nav-"+this.unique_id});fu.css("top",fs+"%");fu.text(T);bF("#timeline-nav").append(fu)}return this.timeline.grid.side_nav[this.unique_id]=fs}else{if(fu.length){return fu.remove()}}};i.prototype.marquee_highlight=function(fr,fy,fv){var fs,fz,fx,fw,fA,T,fu,fC,fB,fD,ft;if(this.top_offset>fy||this.top_offset+this.get_height()<fr){return}if(fr<this.top_offset){fy-=this.top_offset;if(fy<this.timeline.HEADER_HEIGHT){return}ft=0;fD=Math.floor((fy-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}else{if(fy>this.top_offset+this.get_height()){fr-=this.top_offset;fD=Math.ceil(this.photos.length/this.timeline.THUMBS_PER_ROW);if(fr<this.timeline.HEADER_HEIGHT){ft=0}else{ft=Math.floor((fr-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}}else{fr-=this.top_offset;fy-=this.top_offset;if(fr<this.timeline.HEADER_HEIGHT&&fy<this.timeline.HEADER_HEIGHT){return}else{if(fr<this.timeline.HEADER_HEIGHT){ft=0;fD=Math.floor((fy-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}else{ft=Math.floor((fr-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);fD=Math.floor((fy-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}}}}for(fB=fx=fu=ft,fC=fD;fu<=fC?fx<=fC:fx>=fC;fB=fu<=fC?++fx:--fx){for(fw=0,fA=fv.length;fw<fA;fw++){fs=fv[fw];fz=this.timeline.THUMBS_PER_ROW*fB+fs;if(fz<this.photos.length){T=this.photos[fz];if(T.status!==L.PLACEHOLDER&&!e0.contains(T)){e0._highlight(T)}}}}};i.prototype.add_photos=function(fu){var ft,fs,T,fr,fv;for(fs=0,T=fu.length;fs<T;fs++){fv=fu[fs];fr=fv.photo;ft=fv.index;cP(ft<=this.photos.length,"cannot insert past end of photos array");this.photos.splice(ft,0,fr);if(fr.status>=L.LOADED){fr.status=L.LOADED;this.num_photos_loaded++;this.num_photos_to_load=Math.max(this.num_photos_to_load,this.num_photos_loaded)}}return this._num_photos_changed()};i.prototype.remove_photos=function(fy){var fw,ft,fv,fr,fu,fs,fx,T;fw=this.timeline.events.indexOfKey(this.unique_id);T=[];for(ft=0,fv=fy.length;ft<fv;ft++){fr=fy[ft];fu=this.photos.indexOf(fr);cP(fu>-1,"Photo not found in the photos array!");this.photos.splice(fu,1);if(fr.status>=L.LOADED){this.num_photos_loaded--;if((fs=$(fr.uniqueness_key))!=null){fs.remove()}fr.status=L.LOADED}e0._remove(fr);T.push({photo:fr,index:fu})}this._num_photos_changed();fx={removed_photos_and_indexes:T};if(this.photos.length===0){fx.removed_event_index=fw}return fx};i.prototype._num_photos_changed=function(){if(this.photos.length===0){return this.remove()}else{return this._update_placeholder_container()}};i.prototype.update_placeholders=function(){if($("p-"+this.unique_id)!=null){this._update_placeholder_container();$("p-top-"+this.unique_id).setStyle({height:(this.get_content_height())+"px"});return $("p-bottom-"+this.unique_id).setStyle({height:"0px"})}else{return this._generate_container_html()}};i.prototype._update_placeholder_container=function(){var T,j;$("p-"+this.unique_id).setStyle({height:(this.get_content_height())+"px"});j=this.photos.length%this.timeline.THUMBS_PER_ROW;T=j!==0?(this.timeline.THUMBS_PER_ROW-j)*this.timeline.THUMB_SIZE:0;return $("p-cover-"+this.unique_id).setStyle({width:T+"px"})};i.prototype.load_metadata=function(fw){var fr,T,fv,j,ft,fu,fs;j=0;if((!this._is_valid_photo_index(fw))||(this.num_to_select>0)){if(this.loading_order===this.LOADING_ORDER_NOT_DECIDED){this.loading_order=this.LOADING_ORDER_TOP_DOWN}j=this.photos.length}else{if(this.loading_order===this.LOADING_ORDER_NOT_DECIDED){this.loading_order=fw*2<=this.photos.length?this.LOADING_ORDER_TOP_DOWN:this.LOADING_ORDER_BOTTOM_UP}j=this._is_loading_from_bottom()?this.photos.length-fw:fw+1}this.num_photos_to_load=Math.max(this.num_photos_to_load,j);if(this.has_loaded_metadata()||(this.num_photos_loaded>=this.num_photos_to_load)){return}if(this.loading_metadata){return}if(this.load_cached_metadata()){return}this.loading_metadata=true;ft={show_hidden:bQ.show_hidden};if(this.cursor!=null){ft.cursor=this.cursor}if(this._is_loading_from_bottom()){ft.chron_order=true}ft.limit=Math.max(this.num_photos_to_load-this.num_photos_loaded,0);if(ft.limit>this.MAX_PHOTOS_PER_METADATA_REQUEST){ft.limit=this.MAX_PHOTOS_PER_METADATA_REQUEST}if(this.is_event()){fu=this.unique_id.split("_");fr=fu[2];T=fu[1];ft.filters=JSON.stringify({date_begin:fr,date_end:T},{event_id:this.unique_id})}else{if(this.is_missing_timestamp_bucket()){ft.filters=JSON.stringify({other:true})}else{if(this.is_month()){fs=this.get_year();fv=this.get_month();fr=ec.to_iso8601_date(new Date(fs,fv-1,1,0,0,0,0),false,true);T=ec.to_iso8601_date(new Date(fs,fv,1,0,0,0),false,true);ft.filters=JSON.stringify({date_begin:fr,date_end:T},{year:fs,month:fv})}else{if(this.is_collection()){ft.filters=JSON.stringify({collection_gid:this.get_collection_gid()})}else{cP(false,"invalid photo event id: "+this.unique_id)}}}}return new cG.WebRequest({url:"/photos_event_metadata",data:ft,dataType:"json",success:(function(fx){return function(fy){fx.timing_metadata_received=b6.time();fx.cursor=fy.cursor;return fx._load_metadata_callback(fy.photos,fy.key_to_duplicates,(fy.more!=null)&&fy.more)}})(this)})};i.prototype.load_metadata_range=function(T,j){if(!(this._is_valid_photo_index(T)&&this._is_valid_photo_index(j))){this.load_metadata();return}if(this.loading_order===this.LOADING_ORDER_NOT_DECIDED){this.loading_order=T*2<=this.photos.length?this.LOADING_ORDER_TOP_DOWN:this.LOADING_ORDER_BOTTOM_UP}if(this._is_loading_from_bottom()){return this.load_metadata(T)}else{return this.load_metadata(j)}};i.prototype.load_cached_metadata=function(){var j,T;if(this.loading_metadata||this._is_loading_from_bottom()||this.num_photos_loaded>0||(((T=bQ.event_metadata_cache)!=null?T[this.unique_id]:void 0)==null)){return false}j=bQ.event_metadata_cache[this.unique_id];this.cursor=j.cursor;this._load_metadata_callback(j.photos,j.key_to_duplicates,j.more);return true};i.prototype._load_metadata_callback=function(fD,ft,fu){var fC,fv,fB,fA,fH,fE,fx,fw,fI,T,fy,fG,fs,fF,fr,fz;fw=[];fs=[];fz=false;for(fC=fB=0,fE=fD.length;fB<fE;fC=++fB){fy=fD[fC];if(this.has_loaded_metadata()){T=new L(this);if(this._is_loading_from_bottom()){this.photos.unshift(T)}else{this.photos.push(T)}fz=true}else{if(this.num_photos_loaded<this.photos.length){fv=this._is_loading_from_bottom()?this.photos.length-1-this.num_photos_loaded:this.num_photos_loaded;T=this.photos[fv]}else{cP(false,"num_photos_loaded should never be greater than photos.length")}}T.init_metadata(fy);if(T.uniqueness_key in ft){T.set_duplicates(ft[T.uniqueness_key])}if(fC<this.NUM_LIGHTBOX_PHOTOS_TO_PRELOAD){fs.push(T.preview_obj)}fw.push(T)}if(this.timeline.opts.uses_lightbox){window.setTimeout((function(){var j,fJ,fL,fK;fK=[];for(j=0,fJ=fs.length;j<fJ;j++){fL=fs[j];fK.push(fL.preload())}return fK}),500)}e0.refresh(fw);for(fA=0,fx=fw.length;fA<fx;fA++){T=fw[fA];if(T.item_counter in this.init_sel_items){e0._add(T);this.num_to_select--;if(this.num_to_select===0){e0.dec_num_loading_events_before_select()}delete this.init_sel_items[T.item_counter];if(this.scroll_to_first_sel){this.scroll_to_first_sel=false;fr=this.timeline;fH=T.uniqueness_key;bF(document).ready(function(){return fr.scroll_to_photo_with_key(fH)})}}}if(!fu){if(this.num_photos_loaded<this.photos.length){fI=this.photos.length-this.num_photos_loaded;fF=this._is_loading_from_bottom()?0:this.num_photos_loaded;this.photos.splice(fF,fI);this.num_photos_to_load=Math.min(this.num_photos_to_load,this.num_photos_loaded)}if(fz||fI){this._fix_photo_miscount()}if(typeof this.on_load_all_metadata==="function"){this.on_load_all_metadata(this)}this.on_load_all_metadata=null}this.loading_metadata=false;this.update_photo_divs();$(document).fire(i.PHOTOS_LOADED_EVT,this);if(!this.has_loaded_metadata()&&this.num_photos_to_load>this.num_photos_loaded){fG=this._is_loading_from_bottom()?this.photos.length-this.num_photos_to_load:this.num_photos_to_load-1;return this.load_metadata(fG)}};i.prototype._fix_photo_miscount=function(){var fr,T,j;fr=Math.ceil(this.init_num_photos/this.timeline.THUMBS_PER_ROW);T=this.get_num_rows()-fr;if(typeof g!=="undefined"&&g!==null){g.log("event_miscount",null,null,null,{event_id:this.unique_id,false_count:this.init_num_photos,true_count:this.photos.length,count_delta:this.photos.length-this.init_num_photos})}j=D.scroll_offsets().top;if(this.top_offset+this.get_height()<j){D.scroll_to(0,j+T*this.timeline.THUMB_SIZE)}this._num_photos_changed();return $(document).fire(i.EVENT_MISCOUNT_EVT,this)};i.prototype.get_num_rows=function(){return Math.ceil(this.photos.length/this.timeline.THUMBS_PER_ROW)};i.prototype.get_content_height=function(){return this.get_num_rows()*this.timeline.THUMB_SIZE};i.prototype.get_height=function(){return this.timeline.HEADER_HEIGHT+this.get_content_height()};i.prototype.has_loaded_metadata=function(){return this.num_photos_loaded===this.photos.length};i.prototype.visible_thumbs_loaded=function(fy){var fs,ft,fv,T,fu,fr,fx,fw;if(fy==null){fy=this.timeline.get_viewport_info()}fr=this.get_photo_range_to_render(fy,false),fs=fr[0],fv=fr[1];if(fs===null&&fv===null){return true}for(fu=ft=fx=fs,fw=fv;fx<=fw?ft<=fw:ft>=fw;fu=fx<=fw?++ft:--ft){T=this.photos[fu];if((T==null)||!(T.status>=L.RENDERED)){return false}}return true};i.prototype._is_loaded=function(j){var T,fr;if(this._is_loading_from_bottom()){fr=this.photos.length-this.num_photos_loaded;T=this.photos.length-1}else{fr=0;T=this.num_photos_loaded-1}return(fr<=j&&j<=T)};i.prototype._is_loading_from_bottom=function(){return this.loading_order===this.LOADING_ORDER_BOTTOM_UP};i.prototype._is_valid_photo_index=function(j){return(j!=null)&&(j>=0)&&(j<=this.photos.length-1)};i.prototype.update_photo_divs=function(){var fr,T,fy,fP,fO,fN,fx,fQ,fC,fL,fK,fB,fM,fz,fv,ft,fA,fI,fH,fG,fF,fE,fJ,fu,fs,fR,fw,fD;if(!this.num_photos_loaded){return}fD=this.timeline.get_viewport_info();if(this.hide_photos_if_not_in_current_viewport(fD)){return}fA=this.get_photo_range_to_render(fD),fy=fA[0],fx=fA[1];cP((fy!=null)&&(fx!=null),"This line is after @hide_photos_if_not_in_ current_viewport, so first_photo_to_render and last_photo_to_render shouldn't be null.");if(!this.has_loaded_metadata()&&((!this._is_loaded(fy))||(!this._is_loaded(fx)))){this.load_metadata_range(fy,fx);if(this._is_loading_from_bottom()){fy=Math.max(fy,this.photos.length-this.num_photos_loaded)}else{fx=Math.min(fx,this.num_photos_loaded-1)}if(fy>fx){return}}fM=Math.floor(fy/this.timeline.THUMBS_PER_ROW);fw=fM*this.timeline.THUMB_SIZE;$("p-top-"+this.unique_id).setStyle({height:fw+"px"});fB=Math.floor((this.photos.length-1)/this.timeline.THUMBS_PER_ROW)-Math.floor(fx/this.timeline.THUMBS_PER_ROW);T=fB*this.timeline.THUMB_SIZE;$("p-bottom-"+this.unique_id).setStyle({height:T+"px"});this._hide_photos((function(){fJ=[];for(var fS=0;0<=fy?fS<fy:fS>fy;0<=fy?fS++:fS--){fJ.push(fS)}return fJ}).apply(this));this._hide_photos((function(){fu=[];for(var fS=fI=fx+1,j=this.photos.length;fI<=j?fS<j:fS>j;fI<=j?fS++:fS--){fu.push(fS)}return fu}).apply(this));this._show_photos((function(){fs=[];for(var j=fy;fy<=fx?j<=fx:j>=fx;fy<=fx?j++:j--){fs.push(j)}return fs}).apply(this));fG=e0.get();for(fL=0,fQ=fG.length;fL<fQ;fL++){fv=fG[fL];if((fF=$(fv.uniqueness_key))!=null){fF.addClassName("selected")}}this.scroll_count=bQ.scroll_count;fr=[];fE=this.get_thumb_indexes_to_load(fD);for(fK=0,fC=fE.length;fK<fC;fK++){ft=fE[fK];fv=this.photos[ft];if((fv!=null)&&fv.status>=L.RENDERED){fR=$(fv.uniqueness_key);if((fR!=null?fR.down("img"):void 0)!=null){fr.push(fR.down("img"))}}}fz=function(j){return j.up(".cu-thumb").addClassName("thumb-loaded")};return bs.batch_load_thumbs(fr,this.timeline.THUMBS_BATCH_SIZE,fz,this.log_thumb_load.bind(this))};i.prototype._hide_photos=function(fu){var ft,fr,T,fs;fs=[];for(fr=0,T=fu.length;fr<T;fr++){ft=fu[fr];fs.push(this._hide_photo(ft))}return fs};i.prototype._hide_photo=function(j){var T;T=this.photos[j];if((T==null)||!(T.status===L.DISPLAYED)){return}$(T.uniqueness_key).hide();return T.status=L.RENDERED};i.prototype._show_photos=function(fG){var fC,fB,fF,fr,fE,fz,fx,fu,fD,fy,fw,ft,fs,fA,fv,T;fr=[];for(fz=0,fD=fG.length;fz<fD;fz++){fB=fG[fz];fE=this._get_photo_insert_info(fB);if(!fE){continue}fF=fE[0],T=fE[1];fv=false;for(fx=0,fy=fr.length;fx<fy;fx++){fC=fr[fx];if(fC.after===fF){fC.photos.push(T);fv=true;break}}if(!fv){fr.push({after:fF,photos:[T]})}}for(fu=0,fw=fr.length;fu<fw;fu++){fC=fr[fu];fC.after.__sert({after:fC.photos})}fA=[];for(fs=0,ft=fG.length;fs<ft;fs++){fB=fG[fs];fA.push(this.photos[fB].status=L.DISPLAYED)}return fA};i.prototype._get_photo_insert_info=function(T){var fu,fr,ft,fs,fx,fw,fv;fs=this.photos[T];if((fs==null)||fs.status===L.DISPLAYED){return}if(fs.status===L.RENDERED){$(fs.uniqueness_key).show()}else{fr=$("p-top-"+this.unique_id);if(T!==0){for(fu=ft=fv=T-1;fv<=0?ft<=0:ft>=0;fu=fv<=0?++ft:--ft){fx=this.photos[fu];if((fx!=null)&&fx.status>=L.RENDERED){fw=$(fx.uniqueness_key);cP(fw!=null,"photo "+fu+" was marked as rendered, but its thumb elm doesn't exist");fr=fw;break}}}return[fr,fs.thumb_html]}};i.prototype.in_y_range=function(T,j){return !(this.top_offset+this.timeline.HEADER_HEIGHT>j||this.top_offset+this.get_height()<T)};i.prototype.in_current_viewport=function(fs,ft){var fr,j,T;if(fs==null){fs=this.timeline.get_viewport_info()}if(ft==null){ft=true}T=fs.top;j=fs.top+fs.height;if(ft){fr=this._blur_range(T,j,fs),T=fr[0],j=fr[1]}return this.in_y_range(T,j)};i.prototype.hide_photos_if_not_in_current_viewport=function(fw){var fu,ft,fs,fv,fr,T;if(!this.in_current_viewport(fw)){if(this._is_loading_from_bottom()){for(fu=ft=fv=this.photos.length-this.num_photos_loaded,fr=this.photos.length;fv<=fr?ft<fr:ft>fr;fu=fv<=fr?++ft:--ft){this._hide_photo(fu)}}else{for(fu=fs=0,T=this.num_photos_loaded;0<=T?fs<T:fs>T;fu=0<=T?++fs:--fs){this._hide_photo(fu)}}$("p-top-"+this.unique_id).setStyle({height:this.get_content_height()+"px"});$("p-bottom-"+this.unique_id).setStyle({height:"0px"});return true}return false};i.prototype._blur_range=function(fs,j,fu){var fr,T,ft;if(fu==null){fu=this.timeline.get_viewport_info()}ft=dH.get();if(ft>=0){T=this.timeline.VIEWPORT_SCALE_OTHER_DIRECTION;fr=this.timeline.VIEWPORT_SCALE_SCROLL_DIRECTION}else{if(ft<0){T=this.timeline.VIEWPORT_SCALE_SCROLL_DIRECTION;fr=this.timeline.VIEWPORT_SCALE_OTHER_DIRECTION}}fs-=T*fu.height;j+=fr*fu.height;return[fs,j]};i.prototype.get_photo_range_to_render=function(fx,fs){var fv,fr,fu,T,fw,ft,j;if(fs==null){fs=true}j=fx.top;ft=fx.bottom;if(fs){T=this._blur_range(j,ft,fx),j=T[0],ft=T[1]}if(!this.in_y_range(j,ft)){return[null,null]}fw=Math.floor((j-this.top_offset-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);fv=Math.floor((ft-this.top_offset-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);fr=Math.min(this.photos.length-1,fw*this.timeline.THUMBS_PER_ROW);fu=Math.min(this.photos.length-1,(fv+1)*this.timeline.THUMBS_PER_ROW-1);cP(!isNaN(fu),"Last photo to render should not be NaN.  "+("viewport_data.bottom="+fx.bottom+" ")+("viewport_data.height="+fx.height+" ")+("photos.length="+this.photos.length+" ")+("top_offset="+this.top_offset+" ")+("bottom_row_to_render="+fv+" "),true,["photo_event_nan_limit"]);return[Math.max(0,fr),fu]};i.prototype.get_photo_range_to_render_with_blur=function(ft){var j,fv,fr,fu,fs,T;fs=this.get_photo_range_to_render(ft,true),fv=fs[0],fu=fs[1];T=this.get_photo_range_to_render(ft,false),j=T[0],fr=T[1];return[fv,j,fr,fu]};i.prototype.get_thumb_indexes_to_load=function(fy){var fK,fv,fI,fH,fG,fu,ft,fF,fC,fJ,fz,fD,fw,fB,fA,fE,fs,fr,T,fx;fw=this.get_photo_range_to_render_with_blur(fy),fv=fw[0],fK=fw[1],fu=fw[2],ft=fw[3];if(fK==null){fC=(function(){fE=[];for(var fL=fv;fv<=ft?fL<=ft:fL>=ft;fv<=ft?fL++:fL--){fE.push(fL)}return fE}).apply(this);if(this.top_offset>fy.bottom){return fC}else{return fC.reverse()}}fD=(function(){fs=[];for(var j=fK;fK<=fu?j<=fu:j>=fu;fK<=fu?j++:j--){fs.push(j)}return fs}).apply(this);fJ=[];fz=[];if(fv<fK){fJ=(function(){fr=[];for(var j=fB=fK-1;fB<=fv?j<=fv:j>=fv;fB<=fv?j++:j--){fr.push(j)}return fr}).apply(this)}if(ft>fu){fz=(function(){T=[];for(var j=fA=fu+1;fA<=ft?j<=ft:j>=ft;fA<=ft?j++:j--){T.push(j)}return T}).apply(this)}fx=dH.get();if(fx>=0){return fD.concat(fz).concat(fJ)}else{return fD.concat(fJ).concat(fz)}};i.prototype.log_thumb_load=function(T,fs){var ft,fr,j;if(!this.timeline.opts.log_thumb_loading){return}if(this.scroll_count===bQ.scroll_count&&!this.logged_thumbs_arrived){if((T+1)%this.timeline.THUMBS_PER_ROW===0||T+1===fs){if(this.visible_thumbs_loaded()){j=this.timeline.get_viewport_info();ft=this.timeline.events.indexOfKey(this.unique_id)===(this.timeline.events.length()-1);if((this.top_offset<j.bottom&&j.bottom<this.top_offset+this.get_height())||ft){if(bQ.scroll_count<2&&((fr=g.get_current_view())===co.PHOTOS_VIEW||fr===co.CAMERA_VIEW)){this.log_timing_event(K.viewport_initial_load);bQ.scroll_count+=2}else{this.log_timing_event(K.viewport_loaded)}}return this.logged_thumbs_arrived=true}}}};i.prototype.log_timing_event=function(fs){var j,T,fr,ft;T=b6.time();j={};if(fs===K.viewport_initial_load){if((typeof performance!=="undefined"&&performance!==null?(fr=performance.timing)!=null?fr.navigationStart:void 0:void 0)!=null){ft=b6.time()-performance.timing.navigationStart;j={current_view:g.get_current_view()};en.log_ajax_transition(ft,fs,j,fs)}return}if(this.timing_stopped_scrolling_on_event===-1){return}if(fs===K.viewport_loaded){ft=T-this.timing_stopped_scrolling_on_event}return en.log_ajax_transition(ft,fs,j,fs)};return i})();var L;L=F.Photo=(function(){i.PLACEHOLDER=0;i.LOADED=1;i.RENDERED=2;i.DISPLAYED=3;i.uniqueness_key;i.item_counter;i.filename;i.ns_id;i.ns_path;i.fq_path;i.href;i.thumbnail_url;i.large_thumbnail_url;i.time_taken;i.display_time_taken;i.preview_type;i.mtime;i.video_streaming_url;i.is_visible;i.user_id;i.event;i.status;i.thumb_html;i.preview_obj;i.duplicates_info;function i(j){this.event=j;this.status=i.PLACEHOLDER;this.preview_obj=j.unique_id}i.prototype.init_metadata=function(j){this.uniqueness_key=j.uniqueness_key;this.item_counter=j.item_counter;this.filename=j.filename;this.ns_id=j.ns_id;this.ns_path=j.ns_path;this.fq_path=j.path;this.href=j.href;this.thumbnail_url=j.thumbnail_url;this.large_thumbnail_url=j.large_thumbnail_url;this.time_taken=j.time_taken;this.display_time_taken=j.display_time_taken;this.preview_type=j.preview_type;this.mtime=j.mtime;this.video_streaming_url=j.video_streaming_url;this.is_visible=j.is_visible;this.user_id=j.user_id;this.thumb_html=this.event.timeline.tmpl({photo:this,display_date:this._get_display_date(),shareable:true,Sprite:cy});this.preview_obj=this._get_preview_obj();this.status=i.LOADED;this.event.num_photos_loaded+=1;return this.event.timeline.key_to_photo[this.uniqueness_key]=this};i.prototype.set_duplicates=function(fs){var fr,T,j;for(T=0,j=fs.length;T<j;T++){fr=fs[T];fr.fq_path=fr.path}return this.duplicates_info=fs};i.prototype._get_preview_obj=function(){if(!this.event.timeline.opts.uses_lightbox){return}if(this.preview_type==="photo"&&this.large_thumbnail_url){if(bQ.in_single_collection_view()){return new eY({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,dl_url:H.parse(this.href).updateQuery({dl:1}).toString(),original_url:this.href,display_time:this.display_time_taken,photo:this})}else{return new dz({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,dl_url:H.parse(this.href).updateQuery({dl:1}).toString(),original_url:this.href,display_time:this.display_time_taken,photo:this})}}else{if(this.preview_type==="video"&&this.large_thumbnail_url){if(bQ.in_single_collection_view()){return new au({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,preview_url:this.video_streaming_url,dl_url:H.parse(this.href).updateQuery({dl:1}).toString(),display_time:this.display_time_taken,photo:this})}else{return new e8({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,preview_url:this.video_streaming_url,dl_url:H.parse(this.href).updateQuery({dl:1}).toString(),display_time:this.display_time_taken,photo:this})}}}return null};i.prototype._get_display_date=function(){var j;if(this.time_taken!=null){j=new Date(this.time_taken);return b6.nice_date_with_month_name(j,j.getUTCFullYear()<new Date().getFullYear(),true)}else{return""}};return i})();var ad;ad=F.PhotoCollection=(function(){i.CREATE_EVT="db:photocollection:create";i.ADD_EVT="db:photocollection:add";i.REMOVE_EVT="db:photocollection:remove";i.UNDO_REMOVE_EVT="db:photocollection:undo_remove";i.RENAME_EVT="db:photocollection:rename";i.DELETE_EVT="db:photocollection:delete";i.SHARE_EVT="db:photocollection:share";i.UNSHARE_EVT="db:photocollection:unshare";i.COVER_CHANGE_EVT="db:photocollection:cover_change";i.gid;i.name;i.num_items;i.num_photos;i.num_videos;i.thumbnail_url_32;i.thumbnail_url_256;i.is_anonymous;i.share_tkey;i.shmodel_url;i.short_url;i.is_creator;i.member_fnames;function i(T,j){if(j==null){j=true}cP((T.gid!=null)&&(T.url!=null)&&(T.name!=null)&&(T.num_items!=null)&&(T.num_photos!=null)&&(T.num_videos!=null),"missing required PhotoCollection params");this.gid=T.gid;this.url=T.url;this.name=T.name;this.num_items=T.num_items;this.num_photos=T.num_photos;this.num_videos=T.num_videos;this.thumbnail_url_32=T.thumbnail_url_32||null;this.thumbnail_url_256=T.thumbnail_url_256||null;this.is_anonymous=T.is_anonymous!=null?T.is_anonymous:false;this.share_tkey=T.share_tkey||null;this.shmodel_url=T.shmodel_url||null;this.short_url=T.short_url||null;this.is_creator=T.is_creator!=null?T.is_creator:true;this.member_fnames=T.member_fnames||[eG("You")];if(j){document.fire(i.CREATE_EVT,{collection:this})}}i.prototype.add_photos=function(fv,fu,fr,ft){var j,fs,T;if(fr==null){fr=false}if(ft==null){ft=true}j=(function(){var fy,fw,fx;fx=[];for(fy=0,fw=fv.length;fy<fw;fy++){T=fv[fy];fx.push(T.item_counter)}return fx})();cP(j.length,"Have to add at least one photo");fs={collection_gid:this.gid,item_counters:JSON.stringify(j),source_collection_gid:fu};return new Ajax.DBRequest("/collection_add",{parameters:fs,job:fr,job_user:cQ.get_viewer().photos_user,progress_text:eG("Adding to album..."),onSuccess:(function(fw){return function(fz){var fx,fA,fy,fB;fB=JSON.parse(fz.responseText);fw.thumbnail_url_32=fB.thumbnail_url_32;fw.thumbnail_url_256=fB.thumbnail_url_256;fA=fB.new_num_photos-fw.num_photos;fy=fB.new_num_videos-fw.num_videos;fx=fB.new_num_items-fw.num_items;fw.num_photos=fB.new_num_photos;fw.num_videos=fB.new_num_videos;fw.num_items=fB.new_num_items;return document.fire(i.ADD_EVT,{collection:fw,photos:fv,num_items_added:fx,num_photos_added:fA,num_videos_added:fy,promote_collection:ft})}})(this)})};i.prototype.remove_photos=function(fs,fr){var j,T;if(fr==null){fr=false}j=(function(){var fv,ft,fu;fu=[];for(fv=0,ft=fs.length;fv<ft;fv++){T=fs[fv];fu.push(T.item_counter)}return fu})();return new Ajax.DBRequest("/collection_remove",{parameters:{collection_gid:this.gid,item_counters:JSON.stringify(j),is_shared:this.share_tkey!=null,num_items:this.num_items},job:fr,job_user:cQ.get_viewer().photos_user,progress_text:eG("Removing from album..."),onSuccess:(function(ft){return function(fu){var fv;fv=JSON.parse(fu.responseText);ft.thumbnail_url_32=fv.thumbnail_url_32;ft.thumbnail_url_256=fv.thumbnail_url_256;ft.num_photos=fv.new_num_photos;ft.num_videos=fv.new_num_videos;ft.num_items=fv.new_num_items;return document.fire(i.REMOVE_EVT,{collection:ft,photos:fs,undo_changeset:fv.undo_changeset})}})(this)})};i.prototype.undo_remove=function(j){return new Ajax.DBRequest("/photos_undo_remove",{parameters:{collection_gid:this.gid,changeset:j},html_in_error_msg:true,progress_text:eG("Undoing..."),onSuccess:(function(T){return function(){return document.fire(i.UNDO_REMOVE_EVT,{collection:T})}})(this)})};i.prototype.rename=function(T){var j;bQ.enable_selection();j=new Ajax.InPlaceEditor(T,"/collection_rename",{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:11,ajaxClass:Ajax.DBRequest,submitOnBlur:true,initialText:this.name,cancelIfSame:true,clickToEdit:false,onComplete:function(){return bF("#single-collection-title-container").removeClass("editing")},onFailure:function(){},savingText:eG("Saving..."),onLeaveEditMode:bQ.disable_selection,onLeaveHover:function(){},ajaxOptions:{method:"POST",onSuccess:(function(fr){return function(fs){fr.name=fs.responseText;return document.fire(i.RENAME_EVT,{collection:fr})}})(this)},callback:(function(fr){return function(fs,ft){return{collection_gid:fr.gid,new_collection_name:ft,is_shared:fr.share_tkey!=null}}})(this)});return j.enterEditMode()};i.prototype["delete"]=function(){if(this.share_tkey!=null){new Ajax.DBRequest("/sm/disable/"+this.share_tkey,{subject_user:cQ.get_viewer().photos_user})}return new Ajax.DBRequest("/collection_delete",{parameters:{collection_gid:this.gid,is_shared:this.share_tkey!=null,num_items:this.num_items},subject_user:cQ.get_viewer().photos_user,onSuccess:(function(j){return function(){return document.fire(i.DELETE_EVT,{collection:j})}})(this)})};i.prototype.attach_to_token=function(fr,ft,T,fs,j){return new Ajax.DBRequest("/collection_attach_to_dummy_token",{parameters:{tkey:fr,collection_gid:this.gid,num_items:this.num_items},onSuccess:(function(fu){return function(){fu.share_tkey=fr;fu.shmodel_url=ft;fu.short_url=T;if(typeof fs==="function"){fs()}return document.fire(i.SHARE_EVT,{collection:fu})}})(this),onFailure:function(){return typeof j==="function"?j():void 0}})};i.prototype.send_link=function(T,fs,fw,fr,fv,j){var fu,ft;fu=(function(fx){return function(){fx.share_tkey=fs;fx.shmodel_url=fw;fx.short_url=fr;if(typeof fv==="function"){fv()}return document.fire(i.SHARE_EVT,{collection:fx})}})(this);ft={collection_gid:this.gid,share_tkey:fs,num_items:this.num_items};return bT.ajax_submit(T,"/collection_share",fu,j,T.down(".tokenizer-submit-button"),ft)};i.prototype.unshare=function(){cP(this.share_tkey!=null,"Can't unshare collection "+this.gid+" without a tkey");return new Ajax.DBRequest("/sm/disable/"+this.share_tkey,{onSuccess:(function(j){return function(){j.share_tkey=null;j.shmodel_url=null;j.short_url=null;return document.fire(i.UNSHARE_EVT,{collection:j})}})(this),subject_user:cQ.get_viewer().photos_user})};i.prototype.set_cover=function(j){return new Ajax.DBRequest("/collection_set_cover",{parameters:{collection_gid:this.gid,item_counter:j.item_counter},onSuccess:(function(T){return function(fr){var fs;fs=JSON.parse(fr.responseText);T.thumbnail_url_32=fs.thumbnail_url_32;T.thumbnail_url_256=fs.thumbnail_url_256;return document.fire(i.COVER_CHANGE_EVT,{collection:T})}})(this)})};return i})();var b7;b7=__PARENT_SCOPE__.FilePreview=INLINE_JS.FilePreview=F.FilePreview={PARTIAL_TEXT_LENGTH_THRESHOLD:64*1024,pdfLink:null,_pdfLoader:new ax(),_has_marked_time_to_interactive:false,init_pdf:function(fu,ft,fr,i,fv,j){var T,fs;if(j==null){j={}}this.pdfLink=i;this.iframe_src=ft;this.presentationMode=fv;this._log_pdf_render_time(fu);window.addEventListener("message",this._preview_listener,false);bF((function(fw){return function(){var fA,fz,fy,fx;fx=H.parse(ft);fA=bF("#pdf-embed-container");j=bx.defaults(j,{annotationMarkerEnabled:fA.attr("data-docpreview-annotation-marker-enabled")==="True",annotationHighlightEnabled:fA.attr("data-docpreview-annotation-highlight-enabled")==="True",annotationRegionEnabled:fA.attr("data-docpreview-annotation-region-enabled")==="True"});if(j.annotationMarkerEnabled){fx=fx.updateQuery("annotation_marker","1")}else{fx=fx.removeQuery("annotation_marker")}if(j.annotationHighlightEnabled){fx=fx.updateQuery("annotation_highlight","1")}else{fx=fx.removeQuery("annotation_highlight")}if(j.annotationRegionEnabled){fx=fx.updateQuery("annotation_region","1")}else{fx=fx.removeQuery("annotation_region")}fy=fx.getQuery();fw._pdfLoader.startListening();fw._pdfLoader.openFile(fy.file,{presentationMode:fw.presentationMode});delete fy.file;fx.setQuery(fy);fz=bF("#pdf-embed-iframe");fz.attr("src",String(fx));fz.attr("type","application/pdf");fz.attr("allowfullscreen","");fz.addClass("pdfjs");bF("html, body").addClass("full_height");return fw._fire_pdf_render_event()}})(this));this.preview_status=fr;if(b1.chrome){fs=function(){var fw;fw=bF('link[rel="shortcut icon"]').remove();return bF("head").append(fw)};setTimeout(fs,1000)}T=$$("#pdf-embed-container iframe");return window.setTimeout(((function(fw){return function(){return T.invoke("setStyle",{visibility:"visible"})}})(this)),200)},init_excel:function(i){window.addEventListener("message",this._preview_listener,false);return bF("#pdf-embed-iframe").attr("src",i)},excel_preview_unsupported:function(){return this.preview_failed()},init_font:function(){return bF((function(i){return function(){if(!$(document.documentElement).hasClassName("fontface")||$(document.body).hasClassName("gecko")){return $(document.body).removeClassName("file-preview-body")}}})(this))},init_htmlified:function(){if(window.htmlified_height){this.htmlified_loaded();return}if(!window.postMessage){this.preview_failed();return}return setTimeout(((function(i){return function(){if(!window.htmlified_height){return i.preview_failed()}}})(this)),10000)},htmlified_loaded:function(){var i;if((i=$("htmlified-loading"))!=null){i.remove()}if(bF("#htmlified-wrapper[data-docpreview-ui-rams-enabled='True'] iframe, code-wrapper[data-docpreview-ui-rams-enabled='True'] iframe").length===0){$("htmlified").style.height=window.htmlified_height+"px"}$("htmlified").style.visibility="";return en.mark_time_to_interactive()},init_video:function(fs,fu,j,fr,i,T,ft){return bF((function(fv){return function(){var fy,fw,fx;fx=ft.width()*0.9;fw=fx*0.55;fy=fv._video_preview_failed;if(fr==="hls"){fv.player=bt.embed("#video",{src:j,type:"application/vnd.apple.mpegurl",width:fx,height:fw,controls:true,poster:i,onError:fy,onReady:fv._player_ready,metadata_link:T})}else{bF("#video").empty();if(fs){if(fu){fv.player=bt.embed("#video",{src:j,type:"video/mp4",width:fx,height:fw,controls:true,poster:i,onError:fy,onReady:fv._player_ready,metadata_link:T})}else{fy()}}else{fv.player=bt.embed("#video",{src:j,type:"video/flv",width:fx,height:fw,controls:true,poster:i,onError:fy,onReady:fv._player_ready,metadata_link:T})}}bF(".vjs-poster").hide();bF(".vjs-big-play-button").hide();fv.player.on("play",fv._onPlay);return fv.player.on("ended",fv._onEnded)}})(this))},photo_loaded:function(T){var j,i;if((j=window.performance)!=null?(i=j.timing)!=null?i.navigationStart:void 0:void 0){T=T-window.performance.timing.navigationStart;return en.log_ajax_transition(T,"file-preview-photo")}},switch_preview:function(fA,fs,fy,fx,T){var fz,fr,i,fw,fv,ft,fu,j;if(this.iframe_src){i=INLINE_JS.URI.parse(this.iframe_src);j=INLINE_JS.URI.parse(i.getQuery().file);fu=j.updateQuery({revision_id:fA}).toString();fr=H.parse(this.iframe_src).updateQuery({file:fu});ft={annotationMarkerEnabled:fs,annotationHighlightEnabled:fs,annotationRegionEnabled:fs};fz=bF("#pdf-embed-iframe");fz.on("load",fy);return this.init_pdf("pdf-js",fr.toString(),Constants.DOC_PREVIEW_AVAILABLE,fu,this.presentationMode,ft)}else{fv={thumbnailUrl:fx,commentActivity:T};fw={action:"switch-preview",parameters:fv};return window.postMessage(JSON.stringify(fw),"*")}},_player_ready:function(){var i;i=function(){bF(".vjs-poster").show();bF(".vjs-big-play-button").show();return bF(".vjs-big-play-button").focus()};return i.defer()},_onPlay:function(){bF(".vjs-poster").hide();return bF(".vjs-big-play-button").hide()},_onEnded:function(){bF(".vjs-poster").show();bF(".vjs-big-play-button").show();return bF(".vjs-loading-spinner").hide()},_video_preview_failed:function(i){if(i==="needflash"){bF("#video-preview-flash-message").show()}return b7.preview_failed()},preview_failed:function(){var i;i=bF(document.body);if(i.hasClass("shmodel-body")){i.removeClass("file-preview-body")}ah.error(eG("Preview failed."));return bF(document).trigger("preview_failed")},_fire_pdf_render_event:function(){var i;if(document.createEvent&&window.dispatchEvent){i=document.createEvent("UIEvents");i.initUIEvent("pagerender",false,false,window,0);return window.dispatchEvent(i)}},_log_pdf_render_time:function(j){var i;i=function(ft){var fs,T,fr;if((fs=window.performance)!=null?(T=fs.timing)!=null?T.navigationStart:void 0:void 0){fr=b6.time()-window.performance.timing.navigationStart;return en.log_ajax_transition(fr,ft)}};Event.observe(window,"pagerender",function(){Event.stopObserving(window,"pagerender");return i(j)});return Event.observe(window,"parsecomplete",function(){Event.stopObserving(window,"parsecomplete");return i(j+"-parse")})},_preview_listener:function(fs){var fr,j,T,i,ft;j={"https://dl.dropbox.com":true};j["https://"+fp.DL_DOC_DOMAIN]=true;j["https://"+Constants.DL_DOC_USER_CONTENT_DOMAIN]=true;j["https://"+Constants.PUBSERVER]=true;j["https://"+Constants.WEB_STATIC_DROPBOX_HOST]=true;if(j[fs.origin]){T={};try{T=JSON.parse(fs.data);fr=T.action}catch(ft){i=ft;fr=fs.data}switch(fr){case"pagerendered":if(!this._has_marked_time_to_interactive){this._has_marked_time_to_interactive=true;return en.mark_time_to_interactive()}break;case"failed":if(!this._has_marked_time_to_interactive){this._has_marked_time_to_interactive=true;en.mark_time_to_interactive()}return b7.preview_failed()}}}};var cB,er,g,K,a8,dh,co;cB=F.AlbumsLogger={log_share:function(j,fs,fr,T,i){return cB.log(j,fs,true,fr,T,i)},log_event:function(i,fr,T,j){return cB.log(i,fr,false,T,j)},log:function(j,fu,fr,ft,fs,i){var T;T={evt:j,collection_gid:fu,is_anonymous:fs};if(fr!=null){T.share_event=fr}if(ft!=null){T.num_items=ft}if(i!=null){T.on_create=i}return new Ajax.DBRequest("/collection_log",{method:"post",noAutonotify:true,parameters:T})}};er=INLINE_JS.PhotosEvents=F.PhotosEvents={CLEAR_SELECTED:"clear_selected",SHARE:"share",SHARE_ALBUM:"share_album",GO_TO_ALBUM_LINK:"go_to_album_link",UNSHARE_ALBUM:"unshare_album",ADD_TO_NEW_ALBUM:"add_to_new_album",ADD_TO_RECENT_ALBUM:"add_to_recent_album",ADD_TO_OTHER_ALBUM:"add_to_other_album",SHOW_IN_FOLDER:"show_in_folder",DELETE:"delete",DELETE_ALBUM:"delete_album",REMOVE:"remove",SET_AS_COVER:"set_as_cover",RENAME_ALBUM:"rename_album",OPEN_LIGHTBOX:"open_lightbox",MARQUEE_SELECT:"marquee_select",SEND:"send",GET_LINK:"get_link",FB_SHARE:"fb_share",TWITTER_SHARE:"twitter_share"};a8=INLINE_JS.PhotosTourEvents=F.PhotosTourEvents={SKIP:"skip",AWESOME:"awesome",EXIT_MODAL:"exit_modal",SHOW_MODAL:"show_modal"};dh=INLINE_JS.PhotosTriggers=F.PhotosTriggers={SAH:"selected_actions_header",PCM:"photos_context_menu",CCM:"collections_context_menu",SCA:"single_collection_action",CLICK:"click",DBL_CLICK:"double_click",DRAG:"drag",ESC:"escape",CLICK_TITLE:"click_title",LIGHTBOX:"lightbox",DROP_TARGET:"drop_target",FOSHMODAL:"foshmodal"};co=F.PhotosViews={PHOTOS_VIEW:"photos_view",CAMERA_VIEW:"camera_view",ALBUMS_VIEW:"albums_view",SINGLE_COLLECTION_VIEW:"single_collection_view",NOT_PHOTOS:"not_photos",MISSING_TIMESTAMPS_VIEW:"missing_timestamps_view"};g=INLINE_JS.PhotosLogger=F.PhotosLogger={last_logged_error_msg:null,last_error_msg_url:null,get_current_view:function(){var i,j,T;i=((j=$("modal"))!=null?j.visible():void 0)&&$("shmodal").visible();T=i?"-foshmodal":"";if(bQ.in_single_collection_view()){return co.SINGLE_COLLECTION_VIEW+T}else{if(bQ.in_all_collections_view()){return co.ALBUMS_VIEW+T}else{if(bQ.initialized){return co.PHOTOS_VIEW+T}else{return co.NOT_PHOTOS}}}},log_interaction:function(i,j,T){return g.log(i,j,null,g.get_current_view(),T)},log_transition_to:function(i){return g.log(i,null,null,g.get_current_view(),null,true)},log:function(j,T,i,fu,fs,ft){var fr;fr={evt:j,trigger:T,view:i};if(fs!=null){fr.data=JSON.stringify(fs)}if(fu!=null){fr.start_view=fu}if(ft!=null){fr.transition=true}return new Ajax.DBRequest("/photos_log",{method:"post",noAutonotify:true,parameters:fr})}};K=F.PhotosTimingEvents={viewport_loaded:"viewport_loaded",viewport_initial_load:"viewport_initial_load"};var dR,aQ;aQ=F.ShmodelLogger={CLICK_SIGN_IN:"click_sign_in",CLICK_ADD_TO_MY_DROPBOX:"click_add_to_my_dropbox",REMOVE_LINK:"remove_link",CLICK_FILENAME:"click_filename",CLICK_DOWNLOAD:"click_download",LOGIN_THRU_DEFAULT_DROPDOWN:"login_thru_default_dropdown",CLICK_SIGNUP_THRU_DEFAULT_DROPDOWN:"click_signup_thru_default_dropdown",CLICK_SHARE:"click_share",log:function(i){return new Ajax.DBRequest("/shmlog",{method:"post",noAutonotify:true,parameters:{evt:i,url:window.location.href}})},attachLogListener:function(i,j){if(j==null){return}return j.observe("click",function(T){aQ.log(i);if(j.href&&j.href!=="#"&&j.target!=="_blank"){Event.stop(T);return(function(){return window.location.href=j.href}).defer()}})}};dR=F.RegistrationLogger={log:function(i){var j;j=window.location.href;return new Ajax.DBRequest("/share/reglog",{method:"post",noAutonotify:true,parameters:{evt:i,url:j}})},attachLogListener:function(i,j){if(j==null){return}return j.observe("click",function(T){dR.log(i);if(j.href&&j.href!=="#"&&j.target!=="_blank"){Event.stop(T);return(function(){return window.location.href=j.href}).defer()}})}};var f;f=F.ModalFlow=(function(){function i(ft,fx,fz,fs,T,fw,fy){var fu,fv,fr,j;this.title=ft;this.icon=fx;this.states=fz;this.next_state_table=fs;this.previous_state_table=T;this.initial=fw;this.onStart=fy;this._state_map={};fr=this.states;for(fu=0,fv=fr.length;fu<fv;fu++){j=fr[fu];this._state_map[j.name]=j}this.state=null;this._exit_listeners=[];this._cleanup_queue=[]}i.prototype.start=function(){var T,j,fr,fs;this.vars={};fr=this.states;for(T=0,j=fr.length;T<j;T++){fs=fr[T];fs.next=this._next.bind(this,fs);fs.back=this._back.bind(this,fs);if(fs.onSubmit){fs.onSubmitFn=(function(ft,fu){ft.onSubmit(this,ft,fu);return false}).bind(this,fs)}else{fs.onSubmitFn=((function(ft){return function(fu,fv){fu.next();return false}})(this)).bind(this,fs)}fs.contents.on("submit",fs.onSubmitFn);fs.contents.find(".backbutton").on("click",fs.back)}fh.onHide=this._onExit.bind(this);if(this.onStart){this.onStart()}this.to_state(this.initial);return false};i.prototype.to_state=function(T){var j;this.state=this._state_map[T];j=this.title;if(this.state.title!=null){j=this.state.title}fh.show(j,this.state.contents[0]);return this.state.enter(this)};i.prototype._next=function(j){var T;if(j===this.state){T=this.next_state_table[this.state.name](this);if(T==="__exit__"){return this.exit()}else{return this.to_state(T)}}};i.prototype._back=function(j){var T;if(j===this.state){T=this.previous_state_table[this.state.name](this);if(T==="__cancel__"){return this.exit()}else{if(T){return this.to_state(T)}}}};i.prototype.exit=function(){return this._onExit()};i.prototype._onExit=function(fy){var fv,ft,fw,fu,fr,fs,fx,T;fs=this.states;for(fv=0,fw=fs.length;fv<fw;fv++){T=fs[fv];T.contents.off("submit",T.onSubmitFn)}this._cleanUpExitListeners();fx=this._exit_listeners;for(ft=0,fu=fx.length;ft<fu;ft++){fr=fx[ft];fr(fy)}fh.onHide=null;return fh.hide()};i.prototype.addExitListener=function(j){return this._exit_listeners.push(j)};i.prototype.removeExitListener=function(j){return this._cleanup_queue.push(j)};i.prototype._cleanUpExitListeners=function(){var ft,fs,T,j,fu,fr;fu=this._cleanup_queue;fr=[];for(fs=0,j=fu.length;fs<j;fs++){ft=fu[fs];T=this._exit_listeners.indexOf(ft);fr.push(this._exit_listeners.splice(T,1))}return fr};return i})();var cJ;cJ=F.TwoFactorAuth={_checkpoint_token:null,_email:null,_container_selector:null,_error_selector:null,_is_offline_setup:null,_invalid_code_count:null,_current_flow:null,set_user:function(i){this._user=cQ.get_viewer().get_user_by_id(i);cP(this._user,i+" is invalid");return bF("#twofactor-enter-password .email-placeholder").text(this._user.email)},login_init:function(){this._container_selector="#twofactor-confirm";this._error_selector="#twofactor-confirm .error-message";return this.login_listen()},login_listen:function(){bF("#resend-link").on("click",this.resend_phone_code.bind(this));return bF("#code").focus()},init:function(j,i){this._container_selector=".twofactor-account-form";this._error_selector=".twofactor-account-form .error-message";this.account_listen();ec.async_load_script(j);return ec.async_load_script(i)},account_listen:function(){var fD,T,fB,fy,fz,fx,fu,fC,i,j,fr,ft,fs,fA,fw,fv;fB={name:"delivery_choice",enter:(function(fE){return function(fF){var fG;fE.hide_error();fG=0;bF(".delivery-choice").each(function(){var fH;fH=bF(this).height();return fG=Math.max(fH,fG)});bF(".delivery-choice").height(fG);return bF(".delivery-choice.selected > input").prop("checked",true)}})(this),contents:bF("#twofactor-delivery-choice"),onSubmit:(function(fE){return function(fF,fG,fH){fF.vars.sms=!!(bF("#use-sms")[0].getValue()==="on");if(!fF.vars.sms){return fE.fetch_offline_key(fF,fG)}else{return fG.next()}}})(this)};fy={name:"enter_phone_number",enter:(function(fE){return function(fG){var fH,fF;fE.hide_error();fE._is_offline_setup=false;fE._phone_number=null;fH=$("twofactor-enter-phone");fF=fE.fill_phone_number_for_edit(fH,bF("#twofactor-row-"+fE._user.role+" #twofactor-sms-number").text());return fF.focus()}})(this),contents:bF("#twofactor-enter-phone"),onSubmit:this.submit_phone_number.bind(this)};fz={name:"offline_setup",enter:(function(fE){return function(fF){fE.hide_error();fE._is_offline_setup=true;return fE._phone_number=null}})(this),contents:bF("#twofactor-offline-setup")};T={name:"confirm_phone",enter:(function(fE){return function(fF){var fG;fE._invalid_code_count=0;if(fE._is_offline_setup){$("twofactor-enable-confirm").addClassName("offline")}else{fG=fF.vars.phone_number;cP(fG,"expected a display_phone argument");$("phone-number-placeholder").__date(fG);$("twofactor-enable-confirm").removeClassName("offline")}fE.hide_error();$("phone-code").clear().focus();return fE.fill_delivery_choice(fG)}})(this),onSubmit:this.submit_phone_code.bind(this),contents:bF("#twofactor-enable-confirm")};fD={name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"back_next"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_none"),contents:bF("#twofactor-enter-backup-phone")};ft=new f(this.DEFAULT_ENABLE_TITLE,this.LOCK_ICON,[{name:"enable_start",enter:this.hide_error.bind(this),contents:bF("#twofactor-start")},{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.ENABLE_CONFIRM_HREF,(function(fE){return function(fF,fG){fE.successfully_enabled=false;fF.vars.mode="ENABLE";fF.vars.passed_password=true;return fG.next()}})(this)),contents:bF("#twofactor-enter-password")},fB,fy,fz,T,fD,{name:"recovery_code",enter:(function(fE){return function(){fE.fill_backup_phone(fE._backup_phone);return fE.hide_error.bind(fE)}})(this),onSubmit:this.submit_finish.bind(this,false),contents:bF("#twofactor-recovery")},{name:"congrats_done",enter:this.after_enabled.bind(this),title:eG("Congrats! You've enabled two-step verification!"),contents:bF("#twofactor-done")}],{enable_start:function(){return"password"},password:function(){return"delivery_choice"},delivery_choice:(function(fE){if(fE.vars.sms){return"enter_phone_number"}else{return"offline_setup"}}),enter_phone_number:function(){return"confirm_phone"},confirm_phone:function(){return"backup_phone"},backup_phone:function(){return"recovery_code"},recovery_code:function(){return"congrats_done"},congrats_done:function(){return"__exit__"},offline_setup:function(){return"confirm_phone"}},{enable_start:function(){return null},password:function(){return null},delivery_choice:function(){return null},enter_phone_number:function(){return"delivery_choice"},offline_setup:function(){return"delivery_choice"},confirm_phone:function(fE){if(fE.vars.sms){return"enter_phone_number"}else{return"offline_setup"}},backup_phone:function(){return"delivery_choice"},recovery_code:function(){return"backup_phone"},congrats_done:function(){return null}},"enable_start",function(){return this.vars.passed_password=false});ft.addExitListener((function(fE){return function(fF){if(ft.vars.passed_password&&fF&&!fE.successfully_enabled){return ah.error(eG("Two-step verification isn\u2019t enabled"))}}})(this));fr=new f(this.DEFAULT_EDIT_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,(function(fE){return function(fG,fH){var fF;fE.successfully_enabled=false;bF(".delivery-choice").removeClass("selected");fF=!bF("#twofactor-row").hasClass("with-sms");bF(fF?"#app-choice":"#sms-choice").addClass("selected");bF("#twofactor-recovery").addClass("edit-mode");fG.vars.passed_password=true;return fH.next()}})(this)),contents:bF("#twofactor-enter-password")},fB,fy,fz,T,{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"back_next"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_everything"),contents:bF("#twofactor-enter-backup-phone")}],{password:function(){return"delivery_choice"},delivery_choice:(function(fE){if(fE.vars.sms){return"enter_phone_number"}else{return"offline_setup"}}),enter_phone_number:function(){return"confirm_phone"},confirm_phone:function(){return"backup_phone"},backup_phone:function(){return"__exit__"},offline_setup:function(){return"confirm_phone"}},{password:function(){return null},delivery_choice:function(){return null},enter_phone_number:function(){return"delivery_choice"},offline_setup:function(){return"delivery_choice"},confirm_phone:function(fE){if(fE.vars.sms){return"enter_phone_number"}else{return"offline_setup"}},backup_phone:function(){return"delivery_choice"}},"password",function(){return this.vars.passed_password=false});fr.addExitListener((function(fE){return function(fF){if(fr.vars.passed_password&&fF&&!fE.successfully_enabled){return ah.error(eG("Two-step verification has not been changed"))}}})(this));i=new f(this.DEFAULT_DISABLE_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.DISABLE_CONFIRM_HREF,(function(fE){return function(fF,fG){fE.successfully_disabled=false;fF.vars.passed_password=true;return fG.next()}})(this)),contents:bF("#twofactor-enter-password")},{name:"disable",enter:this.hide_error.bind(this),contents:bF("#twofactor-disable"),onSubmit:this.disable_submit.bind(this)}],{password:function(){return"disable"},disable:function(){return"__exit__"}},{password:function(){return null},disable:function(){return"__cancel__"}},"password",function(){return this.vars.passed_password=false});i.addExitListener((function(fE){return function(fF){if(i.vars.passed_password&&fF&&!fE.successfully_disabled){return ah.error(eG("Two-step verification is still enabled"))}}})(this));fx=new f(this.ADD_BACKUP_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,function(fE,fF){return fF.next()}),contents:bF("#twofactor-enter-password")},{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"cancel_save"),onSubmit:this.submit_backup_phone_number.bind(this,true,"save_backup_phone"),contents:bF("#twofactor-enter-backup-phone")}],{password:function(){return"backup_phone"},backup_phone:function(){return"__exit__"}},{password:function(){return null},backup_phone:function(){return"__cancel__"}},"password");j=new f(this.EDIT_BACKUP_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,function(fE,fF){return fF.next()}),contents:bF("#twofactor-enter-password")},{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"cancel_save"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_backup_phone"),contents:bF("#twofactor-enter-backup-phone")}],{password:function(){return"backup_phone"},backup_phone:function(){return"__exit__"}},{password:function(){return null},backup_phone:function(){return"__cancel__"}},"password");fA=new f(this.EDIT_RECOVERY_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,(function(fE){return function(fF,fG){return new Ajax.DBRequest(fE.RECOVERY_CODE_HREF,{parameters:{checkpoint_token:fE._checkpoint_token,use_json:true},onSuccess:function(fI){var fH,fJ;fJ=JSON.parse(fI.responseText.strip());if(fJ.result==="OK"){fH=fJ.codes;fE.fill_backup_codes(fH,"backup-code-list-edit-container");return fG.next()}else{switch(fJ.result){case"EXPIRED":return fE.show_error_expired();case"ALREADY_DISABLED":bF("#twofactor-row").removeClass("twofactor-enabled");ah.success(eG("Two-step verification is already disabled. Did you maybe disable it in another window?"));return fh.hide()}}},onFailure:fE.show_error500.bind(fE),cleanUp:fE.hide_loading.bind(fE),subject_user:fE._user})}})(this)),contents:bF("#twofactor-enter-password")},{name:"recovery_code",enter:this.hide_error.bind(this),contents:bF("#twofactor-recovery-edit"),onSubmit:(function(fE){return function(fF,fG){fE._checkpoint_token=null;return fG.next()}})(this)}],{password:function(){return"recovery_code"},recovery_code:function(){return"__exit__"}},{password:function(){return null},recovery_code:function(){return null}},"password");fv=(function(fE){return function(fF){return new Ajax.DBRequest(fE.ADD_SECURITY_KEY_FINISH_HREF,{parameters:{checkpoint_token:fE._checkpoint_token,device_response:JSON.stringify(fF)},noAutonotify:true,onSuccess:function(fG){var fH;fH=fG.responseText.strip();fu.to_state("register_success");return bF(document).trigger("security-key-manager:UPDATE_KEYS",fE._user.id)},onFailure:function(fI){var fG,fH;fG=JSON.parse(fI.responseText.substr(4));fH=fG.security_key_register!=null?fG.security_key_register["message_text"]:ah.DEFAULT_ERROR;bF("#twofactor-security-key-register-error #error-msg").text(fH);return fu.to_state("register_error")},cleanUp:fE.hide_loading.bind(fE),subject_user:fE._user})}})(this);fs=(function(fE){return function(fF,fG){return new Ajax.DBRequest(fE.ADD_SECURITY_KEY_START_HREF,{parameters:{checkpoint_token:fE._checkpoint_token},onSuccess:function(fH){var fI;fI=JSON.parse(fH.responseText);u2f.register(fI.registerRequests,fI.authenticateRequests,fv);return fG.next()},onFailure:fE.show_error500.bind(fE),cleanUp:fE.hide_loading.bind(fE),subject_user:fE._user})}})(this);fw=new f(this.ADD_SECURITY_KEY_TITLE,this.LOCK_ICON,[{name:"unsupported_browser",enter:this.hide_error.bind(this),contents:bF("#twofactor-security-key-unsupported-browser")}],{unsupported_browser:function(){return"__exit__"}},{},"unsupported_browser");fC=new f("Confirm password",this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,(function(fE){return function(fF,fG){bF(document).trigger("security-key-modal:PASSWORD_CONFIRMED",[fE._user.id,fE._checkpoint_token]);return fh.hide()}})(this)),contents:bF("#twofactor-enter-password")}],{password:function(){return"__exit__"}},{},"password");fu=new f(this.ADD_SECURITY_KEY_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,function(fE,fF){return fF.next()}),contents:bF("#twofactor-enter-password")},{name:"intro",enter:this.hide_error.bind(this),contents:bF("#twofactor-security-key-intro")},{name:"prepare_register",enter:this.hide_error.bind(this),contents:bF("#twofactor-security-key-prepare-register"),onSubmit:fs},{name:"register",enter:this.hide_error.bind(this),contents:bF("#twofactor-security-key-register")},{name:"register_error",enter:this.hide_error.bind(this),contents:bF("#twofactor-security-key-register-error"),onSubmit:fs},{name:"register_success",enter:(function(fE){return function(){fE.hide_error.bind(fE);return fE._checkpoint_token=null}})(this),onSubmit:function(fE,fF){ah.success(eG("Successfully added security key."));return fF.next()},contents:bF("#twofactor-security-key-register-success")}],{password:function(){return"intro"},intro:function(){return"prepare_register"},prepare_register:function(){return"register"},register:function(){return"register_success"},register_error:function(){return"register"},register_success:function(){return"__exit__"}},{},"password");this._bind_phone_input_to_save_button();this._register_skip_link_click_to_submit_finish();bF(".enable-twofactor").on("click",(function(fE){return function(fF){return fE.start_flow(fF,ft)}})(this));bF(".disable-twofactor").on("click",(function(fE){return function(fF){return fE.start_flow(fF,i)}})(this));bF(".add-twofactor-backup-link").on("click",(function(fE){return function(fF){return fE.start_flow(fF,fx)}})(this));bF(".edit-twofactor-backup").on("click",(function(fE){return function(fF){return fE.start_flow(fF,j)}})(this));bF(".edit-twofactor-recovery").on("click",(function(fE){return function(fF){return fE.start_flow(fF,fA)}})(this));bF(".edit-twofactor-sms, .edit-twofactor-offline").on("click",(function(fE){return function(fF){return fE.start_flow(fF,fr)}})(this));bF(document).on("twofactor:ADD_SECURITY_KEY",(function(fE){return function(fG,fF){if(bF("#twofactor-security-key-unsupported-browser").length){return fE.start_flow(fG,fw,fF)}else{return fE.start_flow(fG,fu,fF)}}})(this));bF(document).on("twofactor:ASK_PASSWORD_CONFIRM",(function(fE){return function(fG,fF){return fE.start_flow(fG,fC,fF)}})(this));bF("#generate-new-recovery-code").on("click",(function(fE){return function(fF){fE.show_loading();return new Ajax.DBRequest(fE.NEW_RECOVERY_CODE_HREF,{parameters:{checkpoint_token:fE._checkpoint_token,use_json:true},onSuccess:function(fH){var fI,fG;fI=fH.responseText.strip();fG=JSON.parse(fI);if(fG.result==="OK"){return fE.fill_backup_codes(fG.codes,"backup-code-list-edit-container")}else{switch(fI){case"EXPIRED":fA.to_state("password");return fE.show_error_expired();case"ALREADY_DISABLED":$("twofactor-row").removeClassName("twofactor-enabled");ah.success(eG("Two-step verification is disabled. Did you maybe disable it in another window?"));return fh.hide()}}},onFailure:fE.show_error500.bind(fE),cleanUp:fE.hide_loading.bind(fE),subject_user:fE._user})}})(this));bF("#twofactor-enter-backup-phone #country-code").on("change",this.reset_phone_field.bind(this));bF("#resend-link").on("click",this.enable_resend_phone_code.bind(this));bF("#twofactor-delivery-choice input").change(function(){bF(".delivery-choice").removeClass("selected");return bF(this).parents(".delivery-choice").addClass("selected")});bF("#show-qr").on("click",function(fE){bF("#twofactor-offline-setup").addClass("showing-qr");return false});bF("#hide-qr").on("click",function(fE){bF("#twofactor-offline-setup").removeClass("showing-qr");return false});if(window.location.hash==="#backup2fa"&&bF("#twofactor-row").hasClass("allow-autopop")){return this.start_flow(fx)}},_bind_phone_input_to_save_button:function(){this.$save_button=bF("#twofactor-enter-backup-phone").find(".back-next").find(".savebutton");this.$phone_input=bF("#twofactor-enter-backup-phone").find(".twofactor-backup-phone-number").find(".phone-text");this.$phone_input.on("keyup",(function(i){return function(j){return i._toggle_save_phone_button(i.$phone_input,i.$save_button)}})(this));this.$phone_input.on("input",(function(i){return function(j){return i._toggle_save_phone_button(i.$phone_input,i.$save_button)}})(this));return this._toggle_save_phone_button(this.$phone_input,this.$save_button)},_register_skip_link_click_to_submit_finish:function(){return bF("#twofactor-enter-backup-phone").find(".back-next").find("#skipstep").on("click",(function(i){return function(){return i.submit_finish(true,i._current_flow,i._current_flow.state,null)}})(this))},_toggle_save_phone_button:function(i,j){var T;T=bF.trim(i.val())==="";return j.prop("disabled",T)},start_flow:function(T,j,i){if(i==null){i=null}T.preventDefault();delete this._phone_number;if(i==null){i=bF(T.target).data("uid")}cJ.set_user(cQ.get_viewer().get_user_by_id(i));this._current_flow=j;j.start();return false},connect_login_init:function(){this._container_selector="#twofactor-form";this._error_selector="#twofactor-form .error";return bF("#resend-link").on("click",this.connect_resend_phone_code.bind(this))},resend_phone_code:function(j){var i;if(this.is_resending()){return}this.show_resending();i="/twofactor_resend";if(bF("#twofactor-confirm").hasClass("backup")){i=H.parse(i).updateQuery({backup:true}).toString()}new Ajax.DBRequest(i,{onSuccess:(function(T){return function(fr){switch(fr.responseText.strip()){case"OK":T.hide_error();return T.notify_resent();case"UNREACHABLE":return T.show_error_unreachable(true);case"BADCARRIER":return T.show_error_bad_carrier();case"INVALIDNUMBER":return T.show_error_invalid_number();case"NOTAMOBILE":return T.show_error_not_a_mobile();case"RATELIMIT":return ah.error(eG("You've asked for too many SMS messages. Please try again in a few minutes."));case"EXPIRED":return $("twofactor-confirm").submit()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},connect_resend_phone_code:function(i){if(this.is_resending()){return}this.show_resending();new Ajax.DBRequest("/twofactor_resend",{onSuccess:(function(j){return function(T){switch(T.responseText.strip()){case"OK":j.hide_error();return j.notify_resent();case"UNREACHABLE":return ah.error(j.error_unreachable(true));case"BADCARRIER":return ah.error(j.error_bad_carrier());case"INVALIDNUMBER":return j.show_error_invalid_number();case"NOTAMOBILE":return ah.error(j.error_not_a_mobile());case"RATELIMIT":return ah.error(eG("You've asked for too many SMS messages. Please try again in a few minutes."));case"EXPIRED":return $("twofactor-form").submit()}}})(this),onFailure:(function(j){return function(T){return ah.error(j.error500())}})(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},enable_resend_phone_code:function(i){if(this.is_resending()){return}this.show_resending();new Ajax.DBRequest("/twofactor_resend",{onSuccess:(function(j){return function(T){switch(T.responseText.strip()){case"OK":j.hide_error();return j.notify_resent();case"UNREACHABLE":return j.show_error_unreachable();case"BADCARRIER":return j.show_error_bad_carrier();case"INVALIDNUMBER":return j.show_error_invalid_number();case"NOTAMOBILE":return j.show_error_not_a_mobile();case"RATELIMIT":return ah.error("You've asked for too many SMS messages. Please try again in a few minutes.");case"EXPIRED":j._current_flow.to_state("password");return j.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},DEFAULT_ENABLE_TITLE:eG("Enable two-step verification"),DEFAULT_EDIT_TITLE:eG("Edit two-step verification"),DEFAULT_DISABLE_TITLE:eG("Disable two-step verification"),ADD_BACKUP_TITLE:eG("Add a backup phone number"),EDIT_BACKUP_TITLE:eG("Edit backup phone number"),EDIT_RECOVERY_TITLE:eG("View backup codes"),ADD_SECURITY_KEY_TITLE:eG("Add security key"),LOCK_ICON:"lock32",ENABLE_CONFIRM_HREF:"/account/twofactor/confirm_password",DISABLE_CONFIRM_HREF:"/account/twofactor/disable_confirm_password",EDIT_CONFIRM_HREF:"/account/twofactor/edit_confirm_password",ADD_SECURITY_KEY_START_HREF:"/account/twofactor/u2f_start_registration",ADD_SECURITY_KEY_FINISH_HREF:"/account/twofactor/u2f_finish_registration",RECOVERY_CODE_HREF:"/account/twofactor/get_rescue_code",NEW_RECOVERY_CODE_HREF:"/account/twofactor/new_rescue_code",enter_password_shown:function(){var i;this.hide_error();bF("#twofactor-recovery").removeClass("edit-mode");i=$("twofactor-enter-password");bF("#password",i).val("").focus();return false},submit_password:function(T,ft,i,fr,fs){var j;j=$("password").getValue();if(!j){this.show_error(eG("Please enter your password"));return}this.show_loading();return new Ajax.DBRequest(T,{parameters:{password:j},onSuccess:(function(fu){return function(fv){var fw;fw=fv.responseText.strip();if(fw.startsWith("OK:")){fu._checkpoint_token=fw.substr(3);return ft(i,fr)}else{switch(fw){case"EXPIRED_PASSWORD":return fu.show_error_expired_password();case"INVALID":return fu.show_error(eG("Invalid password"));case"RATELIMIT":return fu.show_error(eG("Too many incorrect passwords. Please try again in a few minutes."));case"ALREADY_ENABLED":$("twofactor-row").addClassName("twofactor-enabled");ah.success(eG("Two-step verification is already enabled. Did you maybe enable it in another window?"));return fh.hide();case"ALREADY_DISABLED":$("twofactor-row").removeClassName("twofactor-enabled");ah.success(eG("Two-step verification is already disabled. Did you maybe disable it in another window?"));return fh.hide()}}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},fetch_offline_key:function(i,j){this.show_loading();return new Ajax.DBRequest("/account/twofactor/add_phone",{parameters:{checkpoint_token:this._checkpoint_token,offline:true},onSuccess:(function(T){return function(fr){var fs;fs=fr.responseText.strip();if(fs.startsWith("OK:")){T.fill_key(fs.substr(3));return j.next()}else{switch(fs){case"EXPIRED":i.to_state("password");return T.show_error_expired()}}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},fill_key:function(j){var i,fr,T;j=j.replace(new RegExp("=+$"),"");i=j.toLowerCase().replace(/(.{4})/g,"$1 ");$("secret-div").__date(i);$("qr-div").__date();T=Constants.IS_PROD?"Dropbox":"DropboxDev";fr={text:"otpauth://totp/"+T+":"+this._user.email+"?secret="+j+"&issuer="+T,width:200,height:200};if(!Modernizr.canvas){fr.render="table"}bF("#qr-div").qrcode(fr);if(!Modernizr.canvas){return bF("#qr-div > table").css("margin","0 auto")}},submit_phone_number:function(j,fr,fs){var i,T;i=bF("#twofactor-enter-phone .twofactor-phone-number");if(!D.controller(i).validate_on_submit()){return}T=i.val();this.show_loading();return new Ajax.DBRequest("/account/twofactor/add_phone",{parameters:{checkpoint_token:this._checkpoint_token,phone_number:T},onSuccess:(function(ft){return function(fu){switch(fu.responseText.strip()){case"OK":ft._phone_number=T;j.vars.phone_number=T;return fr.next();case"EXPIRED":j.to_state("password");return ft.show_error_expired();case"UNREACHABLE":return ft.show_error_unreachable(i);case"BADCARRIER":return ft.show_error_bad_carrier(i);case"INVALIDNUMBER":return ft.show_error_invalid_number(i);case"NOTAMOBILE":return ft.show_error_not_a_mobile(i);case"RATELIMIT":return ft.show_error(eG("You've added too many phone numbers. Please try again in a few minutes."))}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},submit_phone_code:function(i,j,fr){var T;T=$("phone-code").getValue().strip();if(!T){this.show_error(eG("Please enter the security code"));return}if(T.search(/^\d{6}$/)===-1){this.show_error(eG("Invalid security code"));return}this.show_loading();return new Ajax.DBRequest("/account/twofactor/confirm_phone",{parameters:{checkpoint_token:this._checkpoint_token,twofactor_code:T,use_json:true},onSuccess:(function(fs){return function(ft){var fv,fu;fu=JSON.parse(ft.responseText.strip());if(fu.result==="OK"){fs.fill_backup_codes(fu.codes,"backup-code-list-container");return j.next()}else{switch(fu.result){case"INVALID":fs._invalid_code_count+=1;fv=fs._invalid_code_count<=2?eG("Invalid code"):fs._is_offline_setup?eG("Invalid code. Check the clock on your phone: it must be accurate to the minute."):eG("Invalid code");return fs.show_error(fv);case"EXPIRED":i.to_state("password");return fs.show_error_expired();case"RATELIMIT":return fs.show_error(eG("Too many invalid codes. Try again in a few minutes."))}}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},enter_backup_phone_number_shown:function(fr,j){var T,i;this.hide_error();T=$("twofactor-enter-backup-phone");i=this.fill_phone_number_for_edit(T,bF("#twofactor-row-"+this._user.role+" #twofactor-backup-number").text());i.focus();if(fr==="back_next"){bF("#twofactor-backup-back-next").show();bF("#twofactor-backup-cancel-save").hide();return bF("#twofactor-backup-back-save").hide()}else{if(fr==="cancel_save"){bF("#twofactor-backup-back-next").hide();bF("#twofactor-backup-cancel-save").show();return bF("#twofactor-backup-back-save").hide()}else{if(fr==="back_save"){bF("#twofactor-backup-back-next").hide();bF("#twofactor-backup-cancel-save").hide();return bF("#twofactor-backup-back-save").show()}}}},submit_backup_phone_number:function(fs,fr,j,ft,fu){var i,T;i=bF("#twofactor-enter-backup-phone .twofactor-backup-phone-number");if(!D.controller(i).validate_on_blur()){return}T=i.val();if(T){if(this.is_primary_number(T)){D.controller(i).show_error(eG("You can't use your primary phone as your backup",i));return}}else{if(fs){D.controller(i).show_error(eG("Please enter phone number",i));return}}this._backup_phone=T;if(fr==="save_backup_phone"){this.save_added_backup_phone(j,fs,T)}else{if(fr==="save_everything"){this.submit_finish(false,j,ft,fu)}else{if(fr==="save_none"){return ft.next()}}}},is_same_phone_number:function(j,i){if(!j||!i){return false}return j.replace(/\D+/g,"")===i.replace(/\D+/g,"")},is_primary_number:function(i){var j;j=bF("#twofactor-row-"+this._user.role);if(this._is_offline_setup){return false}if(this._phone_number){return this.is_same_phone_number(i,this._phone_number)}else{if(this.is_same_phone_number(i,j.data("primary_phone"))){return true}if(this.is_same_phone_number(i,bF("#twofactor-sms-number",j).text())){return true}}return false},save_added_backup_phone:function(i,T,j){this.show_loading();return new Ajax.DBRequest("/account/twofactor/set_backup_phone",{parameters:{checkpoint_token:this._checkpoint_token,backup_phone_number:j},onSuccess:(function(fr){return function(fs){var ft;switch(fs.responseText.strip()){case"OK":fr.hide_error();ft="#twofactor-row-"+fr._user.role;bF(ft+" #twofactor-backup-number").text(j);bF(ft).toggleClass("with-backup",!!j);if(!j){ah.success(eG("Backup phone number removed"))}else{if(!T){ah.success(eG("Backup phone number updated"))}else{ah.success(eG("Backup phone number added"))}}return fh.hide();case"EXPIRED":i.to_state("password");return fr.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},fill_phone_number_for_edit:function(T,fr){var i,j;j=bF("input.text-input-input",T);if(!fr){return j.val("")}i=D.controller(bF(".phone-number-input",T));i.set(fr);j.val(i.get_local_number());if(j.length){j[0].select()}bF("#twofactor-backup-back-save").find("#skipstep").hide();bF(".text-input-wrapper").find("label").hide();return j},fill_delivery_choice:function(i){bF("#twofactor-delivery-phone-label,#confirm-phone-primary").toggle(!!i);bF("#twofactor-delivery-offline-label").toggle(!i);bF("#confirm-phone-primary-number").text(i);return bF("#twofactor-row-"+this._user.role).data("primary_phone",i)},fill_backup_phone:function(i){bF("#confirm-phone-backup").toggle(!!i);return bF("#confirm-phone-backup-number").text(i)},insert_spaces_into_code:function(i){return i.toLowerCase().replace(/(.{4})/g,"$1 ")},fill_backup_codes:function(j,fw){var fu,fx,fr,T,ft,fv,fs;fx=bF("#"+fw);fx.empty();fu=bF("<ol/>",{"class":"twofactor-backup-list"});if(j.length===0){fx.siblings().css("display","none");return bF(".codesbox__error").css("display","block")}else{T=j[0].length;if(T===16){fu.css("column-count","1")}for(ft=0,fv=j.length;ft<fv;ft++){fr=j[ft];fs=bF("<li/>",{"class":"twofactor-backup-list__item"});fu.append(fs.append(bF("<span/>",{"class":"twofactor-backup-list__code",text:this.insert_spaces_into_code(fr)})))}fx.append(fu);fx.siblings().css("display","block");return bF(".codesbox__error").css("display","none")}},submit_finish:function(j,i,T,fr){var fs;this.show_loading();fs={checkpoint_token:this._checkpoint_token};if(this._backup_phone&&!j){fs.backup_phone_number=this._backup_phone}return new Ajax.DBRequest("/account/twofactor/enable_finish",{parameters:fs,onSuccess:(function(ft){return function(fu){switch(fu.responseText.strip()){case"OK":ft.successfully_enabled=true;if(i.vars.mode!=="ENABLE"){return ft.after_enabled(i,T)}else{return T.next()}break;case"EXPIRED":i.to_state("password");return ft.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},after_enabled:function(j,fr){var i,T;this._checkpoint_token=null;this.hide_error();i=bF("#twofactor-row-"+this._user.role);i.toggleClass("with-sms",!!this._phone_number);bF("#twofactor-sms-number",i).text(this._phone_number||"");i.toggleClass("with-backup",!!this._backup_phone);bF("#twofactor-backup-number",i).text(this._backup_phone||"");i.addClass("twofactor-enabled");bF("tr[id^='session_row_']").slice(1).hide();if(j.vars.mode!=="ENABLE"){T="/account/#security";ah.success(new fm(eG('Two-step verification updated. Any <a href="%(path)s">existing sessions, devices and apps</a> can still access your Dropbox.').format({path:T})));return fr!=null?fr.next():void 0}},disable_submit:function(i,j){this.show_loading();return new Ajax.DBRequest("/account/twofactor/disable",{parameters:{checkpoint_token:this._checkpoint_token},onSuccess:(function(T){return function(fs){var fr;switch(fs.responseText.strip()){case"OK":T.successfully_disabled=true;T._checkpoint_token=null;fr=bF("#twofactor-row-"+T._user.role);fr.removeClass("twofactor-enabled with-sms with-backup");bF(document).trigger("security-key-manager:UPDATE_KEYS",T._user.id);bF("#twofactor-sms-number, #twofactor-backup-number",fr).text("");bF("tr[id^='session_row_']").slice(1).hide();ah.success(eG("Two-step verification is now disabled."));return j.next();case"EXPIRED":i.to_state("password");return T.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},show_error:function(T,i){var j;if(i){D.controller(i).show_error(T);return}j=$$(this._error_selector);if(T===this.error_expired_password()||T===this.error_unreachable(true)){j.invoke("update",T)}else{j.invoke("__date",T)}return j.invoke("show")},show_error500:function(){return this.show_error(this.error_500())},show_error_bad_carrier:function(i){return this.show_error(this.error_bad_carrier(),i)},show_error_invalid_number:function(i){return this.show_error(this.error_invalid_number(),i)},show_error_not_a_mobile:function(i){return this.show_error(this.error_not_a_mobile(),i)},show_error_unreachable:function(i,j){if(j==null){j=false}return this.show_error(this.error_unreachable(j),i)},show_error_expired:function(i){return this.show_error(this.error_expired(),i)},show_error_expired_password:function(i){return this.show_error(this.error_expired_password(),i)},error_500:function(){return eG("Sorry, an error occurred. Please try again later.")},error_bad_carrier:function(){return eG("Unfortunately, your carrier isn\u2019t supported at this time.")},error_invalid_number:function(){return eG("That isn\u2019t a valid phone number.")},error_not_a_mobile:function(){return eG("That phone number doesn\u2019t appear to be a valid mobile number.")},error_unreachable:function(i){if(i==null){i=false}if(i){return eG('We couldn\'t reach your phone number. If this has happened before <a href="https://www.dropbox.com/help/364/">click here</a>.')}else{return eG("We couldn't reach your phone number. Are you sure it's correct?")}},error_expired:function(){return eG("Since it's been a while, please enter your password again.")},error_expired_password:function(){return eG('Your password has expired. Please create a new password <a target="_blank" href="/password_expired">here</a>.')},hide_error:function(){return $$(this._error_selector).invoke("__date")},show_loading:function(){this.hide_error();return $$(this._container_selector).invoke("addClassName","loading")},hide_loading:function(){return $$(this._container_selector).invoke("removeClassName","loading")},is_resending:function(){return $$(this._container_selector)[0].hasClassName("resending")},show_resending:function(){return $$(this._container_selector).invoke("addClassName","resending")},hide_resending:function(){return $$(this._container_selector).invoke("removeClassName","resending")},hide_resending_with_delay:function(){return setTimeout(this.hide_resending.bind(this),3000)},notify_resent:function(){return ah.success(eG("We sent you another code. It may take a few minutes to arrive."))},reset_phone_field:function(j){var i,T;i=j.element();T=bF(".sick-input",i.form);bF("input",T).val("").focus();return this.fill_example_phone_number(i,T)},fill_example_phone_number:function(i,fr){var T,j;if(typeof phone_helpers!=="undefined"&&phone_helpers!==null){T=bF(i).val().substr(1);j=phone_helpers.get_example_mobile_number(T);return bF("label",fr).text(eG("Example: ")+j)}},reset_phone_field_and_backup_country:function(j){var i;this.reset_phone_field(j);if(bF("#backup-phone-number").val()===""){i=bF("#twofactor-enter-backup-phone #country-code");i.val(j.element().getValue());return this.fill_example_phone_number(i,bF(".sick-input",i[0].form))}}};var n,cX=[].indexOf||function(fr){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fr){return T}}return -1};n=__PARENT_SCOPE__.FileViewer=INLINE_JS.FileViewer=F.FileViewer={KEY_SCOPE:"fileviewer",_MODAL_FILEINFO:0,_MODAL_PREVIEW:1,MAX_CHECK_LOCK_TRIES:8,_FADE_MSEC:300,file:null,has_preview:false,preview_locked:false,preview_lock_listener:null,modal_type:this._MODAL_FILEINFO,is_loaded:false,has_key_listener:false,preview_status_timeout_obj:null,preview_status_request:null,hiding:false,check_lock_request:null,check_lock_timeout:null,file_locked:false,file_view_mode:aX.FileViewModeType.UNKNOWN,file_view_origin:aX.FileViewOriginType.UNKNOWN,file_view_action:null,_frameMessenger:null,_cached_browser_window_title:null,annotation_enabled_for_this_revision:true,_preview_flippable_component:null,active_user:null,_pdfLoader:new ax(),_is_browse_drag_enabled:null,_file_view_attempts:0,_trigger_preview_state_update:function(i){return bF(document).trigger("db:filepreview:previewupdate",[i])},_trigger_openwith_state_update:function(i){return bF(document).trigger("db:filepreview:openwithupdate",[i])},_get_extension:function(j){var i;i=j.lastIndexOf(".");return(i===-1?"":j.substr(i+1))},_get_preview_type_from_extension:function(T){var j,i;j=T.substring(0,3);if(j==="rtf"||j==="odt"){i="doc"}else{if(j==="pps"){i="ppt"}else{i=j}}return i},_file_view_mode_is_browse:function(){var i;return i=this.file_view_mode,cX.call(aX.FileViewModeCategories.BROWSE_FILE_VIEW_MODE_TYPES,i)>=0},_file_view_mode_is_shared_or_member_link:function(){var j,T,i;j=aX.FileViewModeCategories;return(T=this.file_view_mode,cX.call(j.SHARED_LINK_FILE_VIEW_MODE_TYPES,T)>=0)||(i=this.file_view_mode,cX.call(j.MEMBER_LINK_FILE_VIEW_MODE_TYPES,i)>=0)},_file_view_target:function(){if(this._file_view_mode_is_shared_or_member_link()){return aX.FileViewTargetType.SHARED_LINK}return aX.FileViewTargetType.PRIVATE},_shared_link_url:function(){if(this._file_view_mode_is_shared_or_member_link()){return this.file.href}return null},show:function(fr,i,T,j){this._file_view_attempts=0;this._cached_browser_window_title=document.title;return this._setup_and_load.apply(this,arguments)},_setup_and_load:function(fs,fw,fy,ft){var fr,j,i,fu,fx,T,fv;if(fy==null){fy={}}if(ft in aX.OriginReferrerTypeToFileViewOriginAndAction){T=aX.OriginReferrerTypeToFileViewOriginAndAction[ft],fx=T[0],fu=T[1]}else{fv=[null,null],fx=fv[0],fu=fv[1]}fy=bx.defaults(fy,{files:[],force_file_unlocked:true,should_focus_comment_input:false,hide_comments:false,hide_restore:false,file_view_mode:aX.FileViewModeType.UNKNOWN,file_view_origin:fx,file_view_action:fu});if(this._is_browse_drag_enabled==null){this._is_browse_drag_enabled=bF.proxy((function(){return !this.shown()}),this)}i=bF("#file-viewer");if(this.hiding){i.finish()}else{if(this.shown()){this.prev_scope=key.getScope();key.setScope(this.KEY_SCOPE);return}else{i.hide()}}fr=i.find(".file-viewer-comment-container");if(fy.hide_comments){fr.hide()}else{fr.show()}j=i.find(".restore-button");if(j.length){if(fy.hide_restore){j.hide()}else{j.show()}}this.file=fs;this.active_user=fw;this.flippable_files=this._filterFlippableFiles(fy.files);this.file_view_mode=fy.file_view_mode;this.file_view_origin=fy.file_view_origin;this.file_view_action=fy.file_view_action;this.should_focus_comment_input=fy.should_focus_comment_input;this.total_files=fy.files.length;this._start_time=Date.now();if(this.file.preview_type==="download"){window.location.href=this.file.href}else{D.scroll_lock_document();i.css("pointer-events","").fadeIn(this._FADE_MSEC);return this.load(this.file,fy.force_file_unlocked,ft)}},_getFilesToPreloadActivities:function(){var fr,fv,ft,fw,fs,T,fu;fv=[];fr=this.currentFlippableFileIndex();fu=[1,2,3,4,5,6,-1,-2];for(fs=0,T=fu.length;fs<T;fs++){ft=fu[fs];fw=fr+ft;if((0<=fw&&fw<this.flippable_files.length)){fv.push(this.flippable_files[fw])}}return fv},load:function(T,ft,j){var i,fs,fr;if(ft==null){ft=false}this._initLogger(T);this.file=T;document.title=this.file.filename;i=bF("#file-viewer");if(i.data("is-openwith-allowed")==="True"){if(__CONDITIONAL_JS__.OpenWith.file_supported(this.file)){if(ft){this.file_locked=false}else{this.file_locked=true;this.check_lock()}}}bF(document.activeElement).blur();this._render_viewer();fr=this.modal_type===this._MODAL_FILEINFO;fs=this._getFilesToPreloadActivities();return bF("#file-viewer").trigger("db:filepreview:open",[this.file,this.file_view_mode,this.active_user.id,this.should_focus_comment_input,fr,j,fs])},_filterFlippableFiles:function(j){var i;return(function(){var fr,T,fs;fs=[];for(fr=0,T=j.length;fr<T;fr++){i=j[fr];if(eb.isFlippable(i.preview_type)){fs.push(i)}}return fs})()},currentFlippableFileIndex:function(){var ft,fs,fr,T,fu;fu=this.flippable_files;for(fs=fr=0,T=fu.length;fr<T;fs=++fr){ft=fu[fs];if(this.file.sjid===ft.sjid){return fs}}return -1},cancel_check_lock:function(){this.file_locked=false;if(this.check_lock_request!=null){this.check_lock_request.abort();this.check_lock_request=null}if(this.check_lock_timeout!=null){clearTimeout(this.check_lock_timeout);return this.check_lock_timeout=null}},check_lock:function(){var fv,fs,fr,fu,T,j,ft,i;if(this.check_lock_request!=null){return}this.check_lock_timeout=null;T=0;i=this.active_user.id;ft=this.file.fq_path;j=1000;fu=(function(fw){return function(){T++;if(T<fw.MAX_CHECK_LOCK_TRIES){if(T===2){INLINE_JS.Notify.warning(eG("Office Online is saving your file."))}else{if(T===5){INLINE_JS.Notify.warning(eG("Office Online is taking longer than expected to save. ",+"Your changes are safe and will eventually be saved to Dropbox."))}}fw.check_lock_timeout=setTimeout(fv,j);return j=j*2}else{clearTimeout(fw.check_lock_timeout);fw.check_lock_request=null;fw.file_locked=false;return fw._render_preview(true,true)}}})(this);fr=(function(fw){return function(fx){fx=JSON.parse(fx);if(fx!=null?fx.has_lock:void 0){return fu()}else{fw.check_lock_request=null;fw.file_locked=false;return fw._render_preview(true,true)}}})(this);fs=function(fy,fw,fx){return fu()};fv=(function(fw){return function(){return fw.check_lock_request=cG.WebRequest({url:"/ow/msft/check_lock",data:{user_id:i,fq_path:ft},success:fr,error:fs})}})(this);return fv()},shown:function(){return bF("#file-viewer").css("display")!=="none"},clear_preview_url_timer:function(){if(this.previewUrlTimer!=null){return clearTimeout(this.previewUrlTimer)}},set_preview_url_w_timeout:function(){this.clear_preview_url_timer();return this.previewUrlTimer=setTimeout((function(i){return function(){return i.set_preview_url()}})(this),250)},set_preview_url:function(){var T,j,i;T=H.parse(eJ.get_url());j=T.getPath();i=T.removeQuery("select").updateQuery({preview:this.file.filename}).getQuery();return eJ.push_state(H.encode_parts(j),i,{immediatelyRestoreState:false})},unset_preview_url:function(){var T,j,i;this.clear_preview_url_timer();T=H.parse(eJ.get_url());if(!this._file_view_mode_is_shared_or_member_link()&&(T.getPath().match(/^\/s[h]?\/.+/)||!this._file_view_mode_is_browse())){return}if(!("preview" in T.getQuery())){return}j=T.getPath();i=T.removeQuery("select").removeQuery("preview").getQuery();return eJ.push_state(H.encode_parts(j),i)},render_file_failed:function(){var i,j;j=this.file;i=this.active_user;this._teardown_and_hide();j.doc_preview_status=Constants.DOC_PREVIEW_UNAVAILABLE_BAD_FILE;this._setup_and_load(j,i,{files:this.flippable_files,force_file_unlocked:!this.file_locked,file_view_mode:this.file_view_mode,file_view_origin:this.file_view_origin,file_view_action:this.file_view_action,should_focus_comment_input:this.should_focus_comment_input});bF("#file-viewer").show();return bF("#file-viewer").trigger("preview_failed")},_log_view:function(i,j){var T;this._file_view_attempts++;T={user_id:this.active_user.id,target:this._file_view_target(),platform:aX.FileViewPlatformType.WEB,ns_id:this.file.ns_id,sjid:this.file.sjid,ns_path:this.file.ns_path,origin:this.file_view_origin,action:this.file_view_action,shared_link_url:this._shared_link_url(),extra:{file_ext:aA.file_extension_for_logging(this.file.filename),file_bytes:this.file.bytes,file_mtime:this.file.ts,preview_type:this.file.preview_type,preview_status:this.file.doc_preview_status,time_taken:i,in_progress:j,is_team:this.active_user.is_team===1,paid:this.active_user.paid===1,file_view_attempts:this._file_view_attempts}};return ba.FileViewLogger.log(T)},preload_office_static:function(j){var fr,T,i;if(__CONDITIONAL_JS__.OpenWith.PRELOAD_URLS==null){return}T=this._get_extension(j);if(T in __CONDITIONAL_JS__.OpenWith.PRELOAD_URLS){fr=bF("#file-viewer .open-with-static-content-container");i=bF("<iframe/>",{src:__CONDITIONAL_JS__.OpenWith.PRELOAD_URLS[T]});return fr.html(i)}},unload_office_static:function(){var i;i=bF("#file-viewer .open-with-static-content-container");return i.empty()},_render_viewer:function(){var fv,j,fy,fz,fr,fB,i,fA,fx,fC,fs,T,ft,fw,fu;j=bF("#file-viewer");fv=j.find(".download-button");fz=H.parse(this.file.href).updateQuery({dl:1}).toString();this.preload_office_static(this.file.filename);fw=(function(fD){return function(fK){var fG,fI,fF,fE,fH,fJ;if(fK==null){fK=true}fE=bU.em_snippet(fD.file.filename,35);fG=j.find(".title-bar .filename");fJ={"class":"icon",alt:fD.file.caption};fH=cy.html("web",fD.file.icon,fJ).toHTML();fI=bF("<span />",{"class":"filename-text"}).text(fE);fG.html(fH).append(fI);j.addClass("has-preview");if(cQ.get_viewer().is_team_assume_user_session){j.addClass("room-for-team-assume-user-top-bar")}if(fD.file.htmlified_link){j.addClass("htmlified-preview")}else{if(fD.file.preview_type==="excel"){j.addClass("html-preview");j.find(".loading").css("z-index","-1")}else{j.addClass(fD.file.preview_type+"-preview")}}if(fK){j.find(".loading").show()}fv.on("click",function(fL){fL.preventDefault();return window.location.href=fz});if(fD.file.tkey===void 0&&n.active_user.is_email_verified){fF=function(fL){this.file.tkey=fL.tkey;return this._update_title_bar_buttons()};cG.WebRequest({url:"/sm/get_token",type:"POST",data:{path:fD.file.fq_path},dataType:"json",subject_user:fD.active_user.id,success:fF.bind(fD)})}else{fD._update_title_bar_buttons()}fD.modal_type=fD._MODAL_PREVIEW;fD._first_render_completed=false;return fD._listen()}})(this);fB=(function(fD){return function(){j.removeClass();j.find(".loading").hide();return fD._unlisten()}})(this);ft=(function(fD){return function(fE,fJ,fH,fG,fF){var fI;if(fE==null){fE=false}if(fJ==null){fJ=true}if(fH==null){fH=false}if(fG==null){fG=false}if(fF==null){fF=true}fD._log_view(Date.now()-fD._start_time,fG);fI=fD._get_extension(fD.file.filename);if(fI==="doc"||fI==="docx"||fI==="odt"||fI==="ppt"||fI==="pptx"||fI==="xls"||fI==="xlsx"||fI==="pdf"||fI==="eps"||fI==="ai"||fI==="psd"||fI==="svg"||fI==="txt"||fI==="rtf"||fI==="pspimage"||fI==="tif"||fI==="tiff"||fI==="yuv"||fI==="url"||fI==="webloc"||fI==="website"||fI==="wopitest"){fD._trigger_preview_state_update({preview_state:"open",file_obj:fD.file})}if(!fE){fw(fJ);fD._update_title_bar_buttons()}fD._render_preview(fH,fF);return fD._initial_resize()}})(this);T=(function(fD){return function(fF){var fE,fH,fI,fG;if(fF==null){fF=false}fE=fD.file.filename.indexOf(".");fH=fD.file.filename.substring(fE+1);if(fH==="key"&&fD.file.preview_type===null){fG="/static/images/icons128/"+(aA.file_icon("_other"))+".png"}else{fG="/static/images/icons128/"+(aA.file_icon(fD.file.filename))+".png"}fD._trigger_preview_state_update({preview_state:"closed",file_obj:null});fI=bU.em_snippet(fD.file.filename,20);j.find(".title-bar .filename").text(fI);j.addClass("no-preview");j.find(".file-thumbnail img").attr({src:fG});j.find(".file-type").text(fI);j.find(".file-size").text(fD.file.size);j.find(".file-modified").text(fD.file.ago||"");fv.on("click",function(){return b1.unsafeRedirect(fz)});fD.modal_type=fD._MODAL_FILEINFO;fD._listen();fD._log_view(Date.now()-fD._start_time,fF);fD._update_title_bar_buttons();return fD._initial_resize()}})(this);fr=this._get_extension(this.file.filename);fC=((fs=this.file.preview_type)==="doc"||fs==="excel"||fs==="keynote"||fs==="adobecs"||fs==="linkfile")&&(this.file.bytes<Constants.MAX_PDF_FILE_SIZE_B||aA.file_extension(this.file.filename).toLowerCase()!=="pdf")&&!b1.msie_version_at_most(9);this.has_preview=eb.isFlippable(this.file.preview_type)||(this.file.preview_type==="text"&&this.file.bytes<Constants.MAX_TEXT_FILE_SIZE_B)||(this.file.preview_type==="html"&&"sandbox" in document.createElement("iframe"))||(this.file.preview_type==="linkfile")||((fC&&this.file.doc_preview_status===Constants.DOC_PREVIEW_AVAILABLE)&&(!this.file_locked));i=fC&&this._preview_progressive_try(fr)&&this.file.doc_preview_status!==Constants.DOC_PREVIEW_UNAVAILABLE_BAD_FILE&&!this.file_locked;if(this.has_preview||i){return ft(false,!(this.file.preview_type==="doc"),false,false,this.has_preview)}fA=this.file_locked||(fC&&this.file.doc_preview_status===Constants.DOC_PREVIEW_IN_PROGRESS);if(!fA){return T()}fw();fx=H({path:"/doc_preview_status"+this.file.fq_path}).toString();fu=Date.now();return(fy=(function(fD){return function(){var fE;fE=Date.now();if(fE-fu>=5000){setTimeout(bF.proxy(fD.render_file_failed,fD),0);return}return fD.preview_status_request=bF.ajax(fx,{success:function(fF){if(fD.file){return fD.file.doc_preview_status=parseInt(fF,10)}},complete:function(fF,fG){if(fG==="abort"){return}if(fD.file_locked){return}if(fD.file.doc_preview_status===Constants.DOC_PREVIEW_AVAILABLE){fD.has_preview=true;return ft(true,false,true,true)}else{if(fD.file.doc_preview_status===Constants.DOC_PREVIEW_IN_PROGRESS){return fD.preview_status_timeout_obj=setTimeout(fy,1000)}else{fD.render_file_failed()}}},timeout:5000-(fE-fu),subject_user:fD.active_user})}})(this))()},switch_preview:function(fr,T,fu,fv){var ft,i,fs,j;if((fr!=null)||(T!=null)){if(this.file!=null){this.annotation_enabled_for_this_revision=fu;if(fr!=null){this.file.href=fr}if(T!=null){this.file.direct_blockserver_link=T}ft=bF("#file-viewer .preview-content-container");if(this.file.preview_type==="photo"){if((fs=this._preview_flippable_component)!=null?fs.isMounted():void 0){if(this._preview_flippable_component.props["thumbnail-url-tmpl"]===fr){i=true}return this._preview_flippable_component.setProps({"thumbnail-url-tmpl":fr,onLoad:fv},(function(fw){return function(){if(i){return fw._preview_flippable_component.onImageLoad()}}})(this))}}else{j="";ft.html(j);return this._render_preview(false,true,fv)}}}},_remove_loading:function(i){var j;if(i==null){i=true}j=bF("#file-viewer .loading");j.hide();j.css("z-index","");return this.is_loaded=i},_render_blank:function(){var j,i;j=bF("#file-viewer .preview-content-container");i=dJ.createElement(I,{icon:this.file.icon,filename:this.file.filename,created:new Date(this.file.ts*1000),size:this.file.size});return dJ.render(i,j.get(0))},_render_linkfile:function(){var j,i;j=bF("#file-viewer .preview-content-container");i=dJ.createElement(U,{filename:this.file.filename,source:"browse","authenticated-data-link":true});return dJ.render(i,j.get(0))},_update_title_bar_buttons:function(){var T,j,fx,fH,fC,fw,fA,fD,fL,fy,fz,ft,fr,i,fF,fu,fs,fJ,fK,fv,fE,fB,fG,fI,fM;fw=bF("#file-viewer");fC=fw.find(".share-button");if(this._file_view_mode_is_shared_or_member_link()){fC.remove()}T=fw.find(".download-button");j=fw.find(".split-button.openwith");fH=j!=null?j.find(".main-button"):void 0;fx=j!=null?j.find(".more-button"):void 0;fL=eG("Open",{comment:"Open a file natively on the user's computer"});fD=function(){return fw.data("is-unity-allowed")==="True"&&(__CONDITIONAL_JS__.UnityFeatures!=null)};fA=(function(fN){return function(fP){var fQ,fO;return fw.data("is-openwith-allowed")==="True"&&((fQ=__CONDITIONAL_JS__.OpenWith)!=null?fQ.get_open_handler_for(fP,fN.active_user):void 0)&&fP.bytes<((fO=__CONDITIONAL_JS__.OpenWith)!=null?fO.MAX_SUPPORTED_FILE_SIZE_B:void 0)&&fP.doc_preview_status!==Constants.DOC_PREVIEW_UNAVAILABLE_PROTECTED_DOC}})(this);fJ=(function(fN){return function(fO){return __CONDITIONAL_JS__.UnityFeatures.open_file(fN.file.ns_id,fN.file.ns_path,fN.file.user_id,__CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler,function(fP){return __CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler(false)},fO)}})(this);fu=function(){return fJ(false)};fs=function(){return fJ(true)};fK=(function(fN){return function(){var fP,fO,fQ;fP=__CONDITIONAL_JS__.OpenWith.get_open_handler_for(fN.file,fN.active_user);if(fP){if((fQ=__CONDITIONAL_JS__.OpenWithMicrosoftLogger)!=null){fQ.log_open_button_pressed(fN.active_user.id,aA.file_extension(fN.file.filename).toLowerCase(),fN.file.ns_id,fN.file.ns_path)}fO=fP.uri+"?hpt_click_ts="+Date.now();return b1.redirect(fO)}}})(this);fM=(function(fN){return function(fV,fW,fO){var fS,fR,fX,fQ,fP,fZ,fT,fU,fY;fY=[];fT=fW!=null;if(fT&&(fW.can_open_directly||(fW.can_open_directly==null))){fS=fW.open_application_name||eG("Open");fU=eG("Desktop");if(__CONDITIONAL_JS__.UnityFeatures.client_supports_open_in_file_browser()){fU=eG("Open in %(app_name)s").format({app_name:fS})}fY.push({id:"ow_desktop",label:fU,icon:"ow_desktop",callback:fu})}if(fV){fZ=__CONDITIONAL_JS__.OpenWith.get_open_handler_for(fN.file,fN.active_user);fY.push({id:"ow_web",label:fZ.name,icon:fZ.icon,callback:fK})}if(fT&&__CONDITIONAL_JS__.UnityFeatures.client_supports_open_in_file_browser()){fP=fW.file_browser_display_name||eG("File Browser");fU=eG("Show in %(file_browser)s").format({file_browser:fP});if(fT&&!fW.can_open_directly&&!fV){fL=fU}fY.push({id:"ow_folder",label:fU,icon:"ow_folder",callback:fs})}fB(fL,fY);if(!fV&&!fT){fX=false}else{if(fT){fX=false}else{fX=true}}if(!fX&&!fO){fN._hide_more_button()}else{fN._show_more_button(fO,fX)}fR=function(f0,f2,f3,f1){if(fN._open_button_update_state_timeout){clearTimeout(fN._open_button_update_state_timeout)}return fN._open_button_update_state_timeout=setTimeout((function(){fN._trigger_openwith_state_update({user_id:f0,button_display_state:f2,file_extension:f3,target_button:f1});return fN._open_button_update_state_timeout=null}),200)};if(fV){fQ=aA.file_extension(fN.file.filename).toLowerCase();if(fT){return fR(fN.active_user.id,"visible",fQ,fx)}else{return fR(fN.active_user.id,"visible",fQ,fH)}}else{return fR(null,"hidden",null,null)}}})(this);fG=function(fN){if(j!=null){j.toggleClass("shown",fN)}return T.toggle(!fN)};fB=function(fO,fN){if(!(fN instanceof Array)){fN=[fN]}if(fN.length===0){return fG(false)}else{if(fN.length===1){return ft(fO,fN[0].callback)}else{return fr(fO,fN)}}};ft=function(fN,fO){if((j==null)&&(fH==null)){return}fG(true);j.removeClass("split");fH.text(fN);return fH.off("click").on("click",fO)};fr=function(fT,fO){var fS,fR,fP,fN,fQ;if((j==null)&&(fH==null)&&(fx==null)){return}fG(true);j.addClass("split");fH.text(fT);fS=fw.find(".openwith-dropdown");fH.off("click").on("click",function(fU){return fO[0].callback(fU)});fx.off("click").on("click",function(fV){var fU;fU=bF(this).parent().siblings(".openwith-dropdown");if(fU.is(":visible")){return}fU.removeAttr("style");eZ.show(fU,this,null,true);return fV.stopPropagation()});fS.find("li").hide();fR=function(fU){var fV;fV=fS.find("."+fU.id);fV.find("a .sprite-text-inner").text(fU.label);cy.src(fV.find("a .sprite")[0],"web",fU.icon);fV.find("a").off("click").on("click",function(fW){fW.preventDefault();return fU.callback(fW)});return fV.show()};for(fP=0,fN=fO.length;fP<fN;fP++){fQ=fO[fP];fR(fQ)}return bF("#file-viewer-container").off("click",eZ.hide_all).on("click",eZ.hide_all)};fI=!!fD();fy=!!fA(this.file);fz=!!this.file.tkey;fM(fy,null,fz);if(fI){i=function(fN){var fO,fP;fP=function(fQ){fN.file_browser_display_name=fQ;return fM(fy,fN,fz)};fO=function(){return fM(fy,null,fz)};return __CONDITIONAL_JS__.UnityFeatures.file_browser_display_name(fP,fO)};if((fv=__CONDITIONAL_JS__.UnityCheckFileCache)!=null?fv.is_cached_and_locally_available(this.file.ns_id,this.file.ns_path):void 0){return i((fE=__CONDITIONAL_JS__.UnityCheckFileCache)!=null?fE.get(this.file.ns_id,this.file.ns_path):void 0)}else{fF=function(fN){if(fN.is_locally_available){return i(fN)}};return __CONDITIONAL_JS__.UnityFeatures.check_file(this.file.ns_id,this.file.ns_path,this.file.user_id,fF)}}},_show_more_button:function(fu,j){var fs,ft,T,fr,i;i=bF("#file-viewer");fs=i.find(".more-options-button");fs.show();T=i.find(".more-options-dropdown");fs.on("click",function(fv){if(T.is(":visible")){return}eZ.show(T,fs,null,true);return fv.stopPropagation()});bF("#file-viewer-container").on("click",eZ.hide_all);fr=T.find(".remove-link");fr.off("click");if(fu){fr.show();fr.on("click",(function(fv){return function(fw){eZ.hide_all();return am.confirm_remove(fv.file.filename,fv.file.tkey,0,0,0,fv.file.user_id)}})(this))}else{fr.hide()}ft=T.find(".download-button");return ft.toggle(j)},_hide_more_button:function(){var j,i;i=bF("#file-viewer");j=i.find(".more-options-button");j.off("click").hide();bF("#file-viewer-container").off("click",eZ.hide_all);return i.find(".remove-link").off("click")},_initial_resize:function(){var i;if(this.is_loaded){return}i=function(){return bF("window").trigger("resize")};return setTimeout(i,0)},_is_pptx_slim_enabled:function(){return az.getGandalfRule("docpreview-pptx-slim")},_get_progressive_url:function(fs,fr){var ft,i,T,j;j=this.active_user;fs=this._get_preview_type_from_extension(fs);T=H.parse(fr);i=false;if(fs==="doc"||fs==="key"||fs==="keynote"||fs==="adobecs"){if(!(Constants.PDF_PREVIEW_MODE==="pdf-js")){T=T.updateQuery({post_message_on_failure:1})}}else{if(fs==="ppt"&&!this._is_pptx_slim_enabled()){ft="private_progressive_viewer";i=true}else{if(fs==="xls"){if(c5.is_xls_edit_enabled()){ft="xls/edit"}else{ft="xls/preview"}}}}if(ft){if(i){T.setAuthority(Constants.WEBSERVER)}else{T.setAuthority(T.getAuthority().replace("dl-web","dl-doc"))}T.setPath(T.getPath().replace("/pri/get/","/get/"));T.setPath(T.getPath().replace("/get/","/"+ft+"/"))}T=T.updateQuery({get_preview:1,rams_ui:this._is_rams_ui()?1:0,saveas:this._is_saveas_experiment_enabled()?1:0});return T},_get_pdf_js_url:function(i){if(Constants.PDF_PREVIEW_MODE==="pdf-js"){i=H.parse(cD.static_url_pdfjs_viewer)}return i},_preview_is_progressive:function(i){i=this._get_preview_type_from_extension(i);return i==="doc"||i==="ppt"||i==="xls"||i==="key"||i==="keynote"||i==="eps"||i==="ai"},_preview_progressive_try:function(j){var T,i;if(!this._preview_is_progressive(j)){return false}if(this.file.doc_preview_status===Constants.DOC_PREVIEW_IN_PROGRESS){return true}j=this._get_preview_type_from_extension(j);T=this.file.doc_preview_status===Constants.DOC_PREVIEW_UNAVAILABLE_FAILED;i=j==="key"||j==="keynote";return T||i},_set_previews_sandbox_params:function(j,i){j=this._get_preview_type_from_extension(j);if(j!=="xls"){return""}else{return null}},_prepare_annotation_url:function(i){if(this._is_annotation_marker_enabled()){i=i.updateQuery("annotation_marker","1")}if(this._is_annotation_highlight_enabled()){i=i.updateQuery("annotation_highlight","1")}if(this._is_annotation_region_enabled()){i=i.updateQuery("annotation_region","1")}return i},_render_preview:function(fJ,fG,fu){var fr,fv,fz,fH,fs,fO,fK,fA,fF,fy,fM,fI,fL,fN,fx,fE,T,fC,fw,fD,fB,ft;if(fJ==null){fJ=false}if(fG==null){fG=true}if(fu==null){fu=null}fx=(function(i){return function(){i._remove_loading();return typeof fu==="function"?fu():void 0}})(this);if(fJ){this._remove_loading(false)}fE=bF("#file-viewer .preview-content-container");if(fE.find("iframe").length>0){return}if(this.file.htmlified_link){fA=bF("<iframe/>",{src:this.file.htmlified_link,sandbox:"allow-scripts allow-forms"});fE.append(fA);return fA.on("load",fx)}else{if(this.file.preview_type==="doc"){fz=this._get_extension(this.file.filename);fv=this._get_preview_type_from_extension(fz);if(fv==="ppt"&&!this._is_pptx_slim_enabled()){ft=this._get_progressive_url(fz,this.file.href);fA=bF("<iframe/>",{src:ft.toString(),allowfullscreen:"",type:"application/pdf"});fE.append(fA)}else{ft=this._get_progressive_url(fz,this.file.direct_blockserver_link);if(!fG){ft=ft.updateQuery({generate_preview:1});ft.setAuthority(ft.getAuthority().replace("dl-web","dl-doc"))}fM=fv==="ppt"&&this._is_pptx_slim_enabled();ft.updateQuery("sjid",this.file.sjid);this._pdfLoader.openFile(ft,{presentationMode:fM});ft=this._get_pdf_js_url();ft=ft.updateQuery(a9.UID_PARAM_NAME,this.active_user);ft=this._prepare_annotation_url(ft);fA=bF("<iframe/>",{src:String(ft),type:"application/pdf"});fA.addClass("pdfjs");fE.append(fA)}return fA.on("load",fx)}else{if(this.file.preview_type==="html"){fA=bF("<iframe/>",{src:this.file.href,sandbox:""});fE.append(fA);return fA.on("load",fx)}else{if(this.file.preview_type==="excel"){ft=this._get_progressive_url("xls",this.file.direct_blockserver_link);fA=bF("<iframe/>",{src:ft,sandbox:"allow-scripts allow-forms"});this._set_previews_sandbox_params("xls",fA);fE.append(fA);return fA.on("load",fx)}else{if(this.file.preview_type==="keynote"){ft=this._get_progressive_url("html",this.file.href);ft=ft.updateQuery({generate_preview:1});ft=ft.updateQuery({post_message_on_failure:1});fA=bF("<iframe/>",{src:ft,type:"text/html"});fE.append(fA);return fA.on("load",fx)}else{if(this.file.preview_type==="adobecs"){ft=this._get_progressive_url("adobecs",this.file.direct_blockserver_link);ft=ft.updateQuery({generate_preview:1});this._pdfLoader.openFile(ft);ft=this._get_pdf_js_url();ft=ft.updateQuery(a9.UID_PARAM_NAME,this.active_user);ft=this._prepare_annotation_url(ft);fA=bF("<iframe/>",{src:String(ft),type:"application/pdf"});fA.addClass("pdfjs");fE.append(fA);return fA.on("load",fx)}else{if(this.file.preview_type==="linkfile"){this._remove_loading();return this._render_linkfile()}else{fr=this.currentFlippableFileIndex();fH=this._get_extension(this.file.filename);if(eb.isFlippable(this.file.preview_type)){bF("#file-viewer .loading").css("z-index","1");if(this.file.preview_type==="video"){fC=this.file.video_transcode_url;fB=this.file.thumbnail_url_tmpl}else{if(this.file.preview_type==="photo"){if(fH==="gif"&&this.file.bytes<=Constants.MAX_GIF_FILE_SIZE_B){fO=H.parse(this.file.href).updateQuery({raw:1}).toString()}fB=this.file.thumbnail_url_tmpl;fF=[];fw=[1,2,3,4,5,6,-1,-2];for(fI=0,fL=fw.length;fI<fL;fI++){fK=fw[fI];fy=fr+fK;if(0<=fy&&fy<this.flippable_files.length){fF.push(this.flippable_files[fy].thumbnail_url_tmpl)}}}}fs={"preview-type":this.file.preview_type,"preview-url":fC,"thumbnail-url-tmpl":fB,gifUrl:fO,"file-extension":fH,"file-meta":{filename:this.file.filename,mtime:this.file.ts,formattedSize:this.file.size},imagesToPreload:fF,index:fr,count:this.flippable_files.length,totalFiles:this.total_files,onPrevious:(function(i){return function(){return i.loadPreviousFlippable()}})(this),onNext:(function(i){return function(){return i.loadNextFlippable()}})(this),onLoad:fx,onError:(function(i){return function(){i._remove_loading()}})(this)};if((fD=this._preview_flippable_component)!=null?fD.isMounted():void 0){fN=this._preview_flippable_component.props;return this._preview_flippable_component.setProps(fs)}else{T=dJ.createElement(eb,fs);return this._preview_flippable_component=dJ.render(T,fE.get(0))}}else{return this._render_blank()}}}}}}}}},post_preview_message:function(fx){var fw,fr,fu,fs,fv,fy,T,ft,i;fu=bF("#file-viewer .preview-content-container iframe");ft=[];for(fs=0,fv=fu.length;fs<fv;fs++){fr=fu[fs];i=fr.src;T="://";fy=i.indexOf(T);if(fy===-1){fw=i.indexOf("/")}else{fw=i.indexOf("/",fy+T.length)}if(fw!==-1){i=i.substring(0,fw)}ft.push(fr.contentWindow.postMessage(fx,i))}return ft},_initLogger:function(i){if(!az.getGandalfRule("file-preview-logger")){return}if(!this._logger){this._logger=new dt()}this._logger.setFile(i);return this._logger.log(dt.PREVIEW_ATTEMPTED)},_deinitLogger:function(){return delete this._logger},_watchFile:function(){if(!az.getGandalfRule("tap-to-refresh")){return}return this.watcher=new y(this.file,this.active_user,this._rerenderPreview.bind(this))},_rerenderPreview:function(){var i;i=bF("#file-viewer .preview-content-container iframe");return i.attr("src",i.attr("src"))},_unwatchFile:function(){var i;if((i=this.watcher)!=null){i.stop()}return delete this.watcher},loadPreviousFlippable:function(){var i;if(eb.isFlippable(this.file.preview_type)&&this.currentFlippableFileIndex()>0){this.load(this.flippable_files[this.currentFlippableFileIndex()-1]);this.set_preview_url();i=this._getFilesToPreloadActivities();return bF("#file-viewer").trigger("db:filepreview:prev",[this.file,this.file_view_mode,this.active_user.id,i])}},loadNextFlippable:function(){var i;if(eb.isFlippable(this.file.preview_type)&&this.currentFlippableFileIndex()<this.flippable_files.length-1){this.load(this.flippable_files[this.currentFlippableFileIndex()+1]);this.set_preview_url();i=this._getFilesToPreloadActivities();return bF("#file-viewer").trigger("db:filepreview:next",[this.file,this.file_view_mode,this.active_user.id,i])}},_listen:function(){var j,i,T;j=bF("#file-viewer");this._pdfLoader.startListening();cR.addFileDragEnabledCheck(this._is_browse_drag_enabled);j.find(".js-close-button").on("click",bF.proxy(this._on_close,this));this._watchFile();if(!this.has_key_listener){key("esc",this.KEY_SCOPE,(function(fr){return function(fs){if(e1.isFullscreen()||D.focus_in_input()||D.is_input(fs.target)||bF(".annotation-bubble").length>0){return}return fr._teardown_and_hide()}})(this));key("left",this.KEY_SCOPE,(function(fr){return function(fs){return fr.loadPreviousFlippable()}})(this));key("right",this.KEY_SCOPE,(function(fr){return function(fs){return fr.loadNextFlippable()}})(this));this.has_key_listener=true}this.prev_scope=key.getScope();key.setScope(this.KEY_SCOPE);if(this.modal_type===this._MODAL_PREVIEW){j.find(".share-button").on("click",bF.proxy(this._share,this));T=(function(fr){return function(fs){if(fr.file.fq_path.toLowerCase()===fs.memo.fq_path.toLowerCase()){fr.file.tkey=fs.memo.tkey;return fr._update_title_bar_buttons()}}})(this);i=(function(fr){return function(fs){if(fr.file.tkey===fs.memo.token){fr.file.tkey=null;return fr._update_title_bar_buttons()}}})(this);this.share_link_callback=T.bind(this);this.remove_link_callback=i.bind(this);document.observe(aH.LINKS_ADD,this.share_link_callback);document.observe(aH.LINKS_REMOVE,this.remove_link_callback)}else{if(this.modal_type===this._MODAL_FILEINFO){j.find(".share-button").on("click",bF.proxy(this._share,this))}}bF(window).on("resize",bF.proxy(this._resize,this));this.handleMessageFromChild=function(fr){switch(fr.action){case"failed":return n.render_file_failed();case"lock_preview":return n.preview_locked=true;case"unlock_preview":return n.preview_locked=false;case"toggle_preview_lock":return n.preview_locked=!n.preview_locked;case"hide_iframe":return n._teardown_and_hide();case"loaded":return n.post_preview_message('{"action":"listening_sfj"}');case"pagerendered":return n._handle_page_rendered(fr.parameters)}};this._frameMessenger=new ez();this._frameMessenger.configureChildMessaging(".preview-content-container > iframe",bF.proxy(this.handleMessageFromChild,this),["failed","lock_preview","unlock_preview","toggle_preview_lock","hide_iframe","loaded","pagerendered"]);this._frameMessenger.startListening();return window.onbeforeunload=function(fr){if(n.preview_locked){return""}else{return void 0}}},_unlisten:function(){var i;i=bF("#file-viewer");this._pdfLoader.stopListening();i.off("click",bF.proxy(this._teardown_and_hide,this));cR.removeFileDragEnabledCheck(this._is_browse_drag_enabled);i.find("#file-viewer-container").off("click",function(j){return j.stopPropagation()});i.find(".js-close-button").off("click",bF.proxy(this._on_close,this));if(this.modal_type===this._MODAL_PREVIEW){i.find(".share-button").off("click",bF.proxy(this._share,this));i.find(".download-button").off("click");bF(document).off("click",eZ.hide_all);document.stopObserving(aH.LINKS_ADD,this.share_link_callback);document.stopObserving(aH.LINKS_REMOVE,this.remove_link_callback)}else{if(this.modal_type===this._MODAL_FILEINFO){i.find(".share-button").off("click",bF.proxy(this._share,this))}}bF(window).off("resize",bF.proxy(this._resize,this));key.setScope(this.prev_scope);this._unwatchFile();return this._deinitLogger()},_resize:function(T){var j,i;if(!this._is_rams_ui()){j=bF("#file-viewer");i=j.find("#file-viewer-container").height()-(j.find(".title-bar").height()+1);j.find(".preview").height(i);return j.trigger("height-resize",{height:i})}},_share:function(i){ba.ShmodelUILogger.log("via-browse-file-viewer");i.preventDefault();if(az.getGandalfRule("simple-sharing")){return eL.createAndShowInbandModalFromFile(this.active_user,this.file)}else{return new dm(this.active_user.id,this.file.fq_path,"file_viewer").show()}},_on_close:function(i){i.preventDefault();return this._teardown_and_hide()},_teardown_and_hide:function(){var i;if(this.hiding){return}this.hiding=true;this.clear_preview_url_timer();this.unload_office_static();this._trigger_preview_state_update({preview_state:"closed",file_obj:null});if(this.preview_locked){if(!confirm("You have unsaved changes. Are you sure you want to leave this page?")){return}}if(this.preview_status_timeout_obj){clearTimeout(this.preview_status_timeout_obj);this.preview_status_timeout_obj=null}if(this.preview_status_request){this.preview_status_request.abort();this.preview_status_request=null}if(this._file_view_mode_is_browse()){e2.set_selected_files(this.file)}if(this._file_view_mode_is_browse()||this._file_view_mode_is_shared_or_member_link()){n.unset_preview_url()}D.scroll_unlock_document();i=bF("#file-viewer");return i.css("pointer-events","none").fadeOut({duration:this._FADE_MSEC,always:(function(j){return function(){var fs,fr,T;if(e1.isFullscreen()){e1.exitFullscreen()}if(__CONDITIONAL_JS__.UnityFeatures!=null){T=eG("Download");fs=i.find(".download-button");fs.text(T);fs.off("click")}j._hide_more_button();i.removeClass("has-preview").removeClass("no-preview");fr=i.find(".preview-content-container");dJ.unmountComponentAtNode(fr.get(0));j._preview_flippable_component=null;fr.empty();i.find(".file-thumbnail img").attr({src:""});i.find(".title-bar .filename").text("");i.attr({"class":""});j._unlisten();j._remove_loading();document.title=j._cached_browser_window_title;j._cached_browser_window_title=null;j.last_file=j.file;j.file=null;j.preview_locked=false;window.removeEventListener("message",j.preview_lock_listener);j.is_loaded=false;j.hiding=false;j.cancel_check_lock();i.trigger("db:filepreview:close")}})(this)})},_handle_page_rendered:function(i){var fr,fs,fx,fv,fy,fw,T,ft,fu;if(!this._first_render_completed){fr=aA.file_extension_for_logging(this.file.filename);fu=i.stats;fw=((T=this.file)!=null?T.bytes:void 0)!=null?this.file.bytes:0;fv=bF.extend(i.attributes,{total_time:Date.now()-this._start_time,file_ext:fr,source:"file-viewer",originalSize:fw,docPreviewStatus:this.file.doc_preview_status});for(fs=0,fx=fu.length;fs<fx;fs++){ft=fu[fs];fy=(function(){switch(ft.name){case"Page Request":return"viewer_page_request_time";case"Rendering":return"viewer_rendering_time";case"Overall":return"viewer_overall_time"}})();fv[fy]=ft.end-ft.start}ba.UserActivityLogger.log("web","file_view_first_page_rendered",fv);ba.PreviewActivityLogger.log("file_view_first_page_rendered",{file_ext:fr,extra:JSON.stringify(fv)});return this._first_render_completed=true}},resize:function(){return this._resize(null)},hide:function(){return this._teardown_and_hide()},_is_annotation_marker_enabled:function(){return bF("#file-viewer").attr("data-docpreview-annotation-marker-enabled")==="True"&&this.annotation_enabled_for_this_revision},_is_annotation_highlight_enabled:function(){return bF("#file-viewer").attr("data-docpreview-annotation-highlight-enabled")==="True"&&this.annotation_enabled_for_this_revision},_is_annotation_region_enabled:function(){return bF("#file-viewer").attr("data-docpreview-annotation-region-enabled")==="True"&&this.annotation_enabled_for_this_revision},_is_saveas_experiment_enabled:function(){return bF("#file-viewer").attr("data-docpreview-saveas-experiment")==="True"},_is_rams_ui:function(){return bF("#file-viewer").attr("data-docpreview-ui-rams-enabled")==="True"}};var d5;d5=F.Index2={init:function(fw,fr){var fu,fx,fv,j,T,fs,fy,ft,i;if(fr){bF("#sign-in").on("click",function(fE){var fz,fC,fB,fA,fD;fE.preventDefault();fB=bF("#sign-in-form");fh.show(eG("Sign in"),fB[0],false,false,416,false,"sign-in-modal");fC=fB.find("#login_email");fC.focus();return new b8(fz=fC,fD=function(){fB.find("#password-field").hide();fB.find("#remember-me").hide();fB.find("#login_submit").val(eG("Continue"));fB.find("#forgot_password_link").hide();return fB.find("#sso_description_footer").show()},fA=function(){fB.find("#password-field").show();fB.find("#remember-me").show();fB.find("#login_submit").val(eG("Sign in"));fB.find("#forgot_password_link").show();return fB.find("#sso_description_footer").hide()})})}fu=function(){if(!bF("#signup-container").hasClass("form_shown")){return bF.when(bF("#signup-container").animate({marginTop:-245},{easing:"easeInOutCubic",duration:500}).promise()).done(function(){bF("#signup-container").addClass("form_shown");return bF("#signup-container .text-input input:visible").first().focus()})}};if(!fw){bF(".register").find(".login-button").on("click",function(fz){if(!bF("#signup-container").hasClass("form_shown")){fz.preventDefault();return fu()}});d5.animate()}else{bF(".photo").show()}fx=function(){if(!bF("#signup-container").hasClass("form_shown")){return bF(".register").find(".login-button").trigger("click")}};bF(".buttons .freshbutton-blue").on("click",function(fz){fz.preventDefault();bF("html, body").animate({scrollTop:0},{queue:false,duration:500,complete:fx});return false});bF("#learn-more").on("click",function(fz){fz.preventDefault();bF("html, body").animate({scrollTop:bF("#divider").offset().top},{queue:false,duration:500});return false});if(bw.are_enabled()){ba.WebMiscActivityLogger.log("index_page",{event_name:"cookies_enabled"})}else{ah.error(eG("Please enable browser-cookies to use the Dropbox website."))}i=["#devices-background",".register-button","#learn-more",".buttons .freshbutton-blue",".buttons .freshbutton-silver","#sign-in a","#page-header .downloading-link"];fv=function(fz){return bF(fz).on("click",function(){return ba.WebMiscActivityLogger.log("index_page",{event_name:"click",id:fz})})};for(T=0,fs=i.length;T<fs;T++){j=i[T];fv(j)}ft=[".bullet-0 .subline",".bullet-0 .description",".bullet-1 .subline",".bullet-1 .description",".bullet-2 .subline",".bullet-2 .description",".bullet-3 .subline",".bullet-3 .description",".bottom .buttons"];fy={};return bF(window).scroll(function(){var fF,fG,fE,fC,fA,fz,fB,fD;fD=[];for(fz=0,fB=ft.length;fz<fB;fz++){fE=ft[fz];if(bF(fE).length&&!fy[fE]){fG=bF(window).scrollTop();fF=fG+bF(window).outerHeight();fA=bF(fE).offset().top;fC=fA+bF(fE).outerHeight();if(fC<=fF){ba.WebMiscActivityLogger.log("index_page",{event_name:"scroll",id:fE});fD.push(fy[fE]=true)}else{fD.push(void 0)}}else{fD.push(void 0)}}return fD})},_animate_points:function(fw,fx,fy,fr,fA,fv,T){var ft,fs,fu,fz;if(T==null){T=0}T=Math.min(Math.max(T,0),1);fu=fv(T);fz=[(function(){var i,fB,j;j=[];for(ft=i=0,fB=fx.length;0<=fB?i<fB:i>fB;ft=0<=fB?++i:--i){j.push([(function(){var fC,fD;fD=[];for(fs=fC=0;fC<2;fs=++fC){fD.push(fx[ft][fs]+(fy[ft][fs]-fx[ft][fs])*fu)}return fD})()])}return j})()];fw.attr("points",d5.points_array_to_str(fz));if(T>=1){return fA.resolve()}else{return setTimeout(function(){return d5._animate_points(fw,fx,fy,fr,fA,fv,T+(10/fr))},10)}},animate_points:function(j,fu,ft,T,fs,fr){var i;if(fr==null){fr=jQuery.easing.linear}i=bF.Deferred();d5._animate_points(j,fu,ft,T,i,fr);return i.done(function(){return typeof fs==="function"?fs():void 0}).promise()},animate_hide_rects:function(fr,fv,fw){var T,ft,fs,j,fu;T=bF.Deferred().resolve().promise();ft=function(fx){var fC,fz,fB,fy,fA;fy=bF(fr[fx]);fC=d5.points_str_to_array(fy.attr("points"));fA=[fC[1],fC[1],fC[2],fC[2]];fz=d5.inverse(jQuery.easing.linear);fB=fv*(fz((fx+1)/fr.length)-fz(fx/fr.length));return T=T.then(function(){return d5.animate_points(fy,fC,fA,fB)})};for(fs=j=0,fu=fr.length;0<=fu?j<fu:j>fu;fs=0<=fu?++j:--j){ft(fs)}return T.done(function(){return typeof fw==="function"?fw():void 0}).promise()},animate_delay:function(j){var i;i=bF.Deferred();setTimeout(i.resolve,j);return i.promise()},animate:function(){return bF.Deferred().resolve().promise().then(function(){return d5.animate_docs()}).then(function(){return d5.animate_graphs()}).then(function(){return d5.animate_photos()})},inverse:function(j,i){if(i==null){i=0.000001}return function(ft){var fr,fs,T;fs=0;fr=1;while(fr-fs>i){T=(fs+fr)/2;if(j(T)<ft){fs=T}else{fr=T}}return fs}},points_str_to_array:function(fv){var fs,T,j,fu,ft,fr;ft=fv.split(" ");fr=[];for(T=0,j=ft.length;T<j;T++){fu=ft[T];fr.push((function(){var i,fy,fw,fx;fw=fu.split(",");fx=[];for(i=0,fy=fw.length;i<fy;i++){fs=fw[i];fx.push(parseFloat(fs))}return fx})())}return fr},points_array_to_str:function(j){var i;return((function(){var fr,T,fs;fs=[];for(fr=0,T=j.length;fr<T;fr++){i=j[fr];fs.push(i.join(","))}return fs})()).join(" ")},animate_docs:function(){var fu,fr,i,fs,T,ft,j;j=[[5,6],[177,1],[184,157],[13,180]];i="";for(ft=fr=0.475;fr<=0.625;ft=fr+=0.05){fu=ft+0.05;fs=[[j[0][0]+(j[3][0]-j[0][0])*ft,j[0][1]+(j[3][1]-j[0][1])*ft],[j[1][0]+(j[2][0]-j[1][0])*ft,j[1][1]+(j[2][1]-j[1][1])*ft],[j[1][0]+(j[2][0]-j[1][0])*fu,j[1][1]+(j[2][1]-j[1][1])*fu],[j[0][0]+(j[3][0]-j[0][0])*fu,j[0][1]+(j[3][1]-j[0][1])*fu]];fs=d5.points_array_to_str(fs);i+="<polygon points='"+fs+"' style='fill:#f5f9fc;stroke:none;' />"}T=bF('<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="190" width="188">\n   '+i+"\n</svg>");return bF.Deferred().resolve().promise().then(function(){bF(".doc, .graph, .photo").hide();bF(".comp.doc").append(T);return bF(".comp.doc").show("slide",{direction:"down"},850).promise()}).then(function(){return d5.animate_hide_rects(T.find("polygon"),2500,function(){return T.remove()})}).then(function(){return d5.animate_delay(500)}).then(function(){return bF(".tablet.doc, .phone.doc").show("fade",{easing:"easeInOutCubic"},400).promise()}).then(function(){return d5.animate_delay(1500)}).then(function(){return bF(".tablet.doc, .phone.doc, .comp.doc").hide("fade",{easing:"easeInOutCubic",duration:700}).promise()})},animate_graphs:function(){var j,i;j=[[83,98],[158,37],[241,77],[171,145]];i=bF('<svg xmlns="http://www.w3.org/2000/svg" version="1.1">\n    <polygon style="fill:#f5f9fc;stroke:none;"/>\n</svg>');i.find("polygon").attr("points",d5.points_array_to_str(j));return bF.Deferred().resolve().promise().then(function(){bF(".doc, .graph, .photo").hide();bF(".tablet.graph .graph-grid").hide();bF(".tablet.graph").append(i);return bF(".tablet.graph").show("fade",{},500).promise()}).then(function(){var T;T=[j[0],j[1],j[1],j[0]];return d5.animate_points(i.find("polygon"),j,T,600,function(){return i.remove()})}).then(function(){if(!b1.msie_version_at_most(8)){return bF(".tablet.graph .graph-grid").show("fade",{},400).promise()}}).then(function(){return d5.animate_delay(500)}).then(function(){return bF(".comp.graph, .phone.graph").show("fade",{easing:"easeInOutCubic"},500).promise()}).then(function(){return d5.animate_delay(2000)}).then(function(){return bF(".graph").hide("fade",{easing:"easeInOutCubic"},700).promise()})},animate_photos:function(){return bF.Deferred().resolve().promise().then(function(){bF(".doc, .graph, .photo").hide();bF(".phone.photo img").not(".photo-flash").css({left:-18*1.15,top:-66*1.15,position:"absolute"});bF(".phone.photo").show();return bF.when((function(){if(!b1.msie_version_at_most(8)){return bF(".phone.photo .photo-flash").show().hide("fade",{},2000).promise()}})(),(function(){return bF.Deferred().resolve().promise().then(function(){return bF(".phone.photo img").not(".photo-flash").animate({left:0,top:0},{duration:800,easing:"easeInOutCubic"}).promise()}).then(function(){return d5.animate_delay(750)}).then(function(){return bF(".tablet.photo, .comp.photo").show("fade",{easing:"easeInOutCubic"},500).promise()})})())})}};var bB,cp,eU;eU=F.UnsupportedBrowser={init:function(){return bF("#unsupported-browser-dismiss").on("click",function(i){i.preventDefault();fd.hide();return bF.ajax({url:"/dismiss_browser_msg",type:"POST"})})}};cp=F.ExpiredCCNotificationBar={init:function(i){return bF(".expired-dismiss").on("click",function(j){j.preventDefault();fd.hide();return bF.ajax({url:"/dismiss_expired_cc_notification",type:"POST",data:{source:i}})})}};bB=F.BetaLocaleNotificationBar={init:function(i){return bF(".beta-locale-dismiss").on("click",function(j){j.preventDefault();fd.hide();return bF.ajax({url:"/dismiss_beta_locale_notification",type:"POST",data:{source:i}})})}};var e;e=INLINE_JS.viewer=cQ.get_viewer();var M,eE,eD,b4,P,ce,e7,bD;if(!Constants.is_test){bF(eW.check_timezone)}if(window._document_observe_listeners){e7=window._document_observe_listeners;for(eE=0,b4=e7.length;eE<b4;eE++){ce=e7[eE];if(document.loaded){ce.func()}else{document.observe(ce.event,ce.func)}}}if(window._jquery_ready_handlers){bD=window._jquery_ready_handlers;for(eD=0,P=bD.length;eD<P;eD++){M=bD[eD];bF(M)}}bF(function(){return Event.fire(document,"script:loaded")});return F});